---
created: 2026-02-13T12:00
title: Migrate vault IPNS key to deterministic derivation from user privateKey
area: crypto
files:
  - packages/crypto/src/key-derivation.ts
  - apps/api/src/modules/ipns/ipns.service.ts
  - apps/web/src/services/vault.service.ts
---

## Problem

Currently, vault IPNS keypairs are generated by the backend and stored (encrypted with user's publicKey) in the database. Discovery requires the backend to return the IPNS name.

This creates a backend dependency for vault discovery. If the backend DB is lost, the user cannot find their vault even if they have their privateKey (via recovery phrase).

## Proposed Solution

Derive the vault IPNS key pair deterministically from the user's privateKey using HKDF with a fixed context string (e.g., `"cipherbox-vault-ipns-v1"`). This way:

1. Any session with the user's privateKey can reconstruct the vault IPNS name
2. Recovery phrase → privateKey → vault IPNS key → resolve IPNS → decrypt vault metadata → full recovery
3. No backend dependency for vault discovery

## Context

This idea emerged during Phase 12.2 (Encrypted Device Registry) discussion. The device registry IPNS will use deterministic derivation as a greenfield implementation, establishing the pattern. This todo captures the follow-up work to migrate the existing vault IPNS to the same pattern.

### Self-sovereign recovery vision

With deterministic derivation for ALL IPNS keys:

- User backs up recovery phrase (Phase 12.4 MFA)
- Lose everything (backend DB wiped, devices lost)
- Recovery phrase → privateKey → derive vault IPNS key + registry IPNS key → resolve → full recovery
- No backend needed for discovery — only IPFS/IPNS infrastructure

### Migration considerations

- Must migrate existing users' vault IPNS names (one-time migration)
- TEE republishing must be updated to use derived IPNS keys
- Backend can still cache the IPNS name for performance, but it's no longer the source of truth
- Need to handle the transition period where some users have old (random) IPNS keys and some have derived ones
- IPNS records have TTL — old IPNS name must be republished with a redirect or the user must re-pin under the new name

## Scope

This is a significant architectural change affecting:

- IPNS key generation flow
- TEE republishing
- Vault initialization
- User migration
- Recovery flow

Should be its own phase or part of a broader "self-sovereign recovery" initiative.
