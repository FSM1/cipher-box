---
phase: 09.1-env-devops-staging
plan: 01
subsystem: infra
tags: [nestjs, vite, web3auth, typeorm, logging, ipfs, hash-routing, environment-config]

# Dependency graph
requires:
  - phase: 09-desktop-client
    provides: Fully functional API, web app, and TEE worker codebase
provides:
  - Configurable API port via PORT env var
  - Environment-aware NestJS log levels (dev vs staging/production)
  - TEE simulator guard using CIPHERBOX_ENVIRONMENT instead of NODE_ENV
  - Hash-based routing for IPFS gateway compatibility
  - Environment-aware Web3Auth network selection (devnet/mainnet)
  - Cleaned up TypeORM logging (no SQL query spam)
  - Removed dead VITE_PINATA_GATEWAY_URL env var
affects: [09.1-02, 09.1-03, 09.1-04, 09.1-05, 09.1-06]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'CIPHERBOX_ENVIRONMENT for deployment-tier checks (not NODE_ENV)'
    - 'NestJS Logger for structured log output'
    - 'HashRouter for IPFS-hosted SPA routing'
    - 'VITE_ENVIRONMENT for frontend environment detection'

key-files:
  created: []
  modified:
    - apps/api/src/main.ts
    - apps/api/src/app.module.ts
    - tee-worker/src/services/tee-keys.ts
    - apps/web/src/routes/index.tsx
    - apps/web/src/lib/web3auth/config.ts
    - apps/web/.env.example
    - .github/workflows/e2e.yml

key-decisions:
  - 'NestJS Logger instead of nestjs-pino for structured logging — simpler, no new dependency'
  - 'TypeORM logging uses array format: errors+warnings+migrations in dev, errors+migrations in staging/production'
  - 'CIPHERBOX_ENVIRONMENT separates deployment tier from NODE_ENV for TEE simulator guard'
  - 'HashRouter for IPFS gateway — all routes become /#/path, always serves index.html'
  - 'VITE_ENVIRONMENT with NETWORK_CONFIG map for Web3Auth network selection'
  - 'Dead VITE_PINATA_GATEWAY_URL removed from .env.example and e2e workflow'

patterns-established:
  - 'CIPHERBOX_ENVIRONMENT env var: local | ci | staging | production for deployment tier'
  - 'VITE_ENVIRONMENT env var: local | ci | staging | production for frontend environment'
  - 'process.env.PORT for container-flexible API binding'

# Metrics
duration: 3min
completed: 2026-02-09
---

# Phase 9.1 Plan 01: Environment-Aware Config Summary

Configurable API port, NestJS Logger, CIPHERBOX_ENVIRONMENT TEE guard, HashRouter for IPFS, env-aware Web3Auth network, TypeORM logging cleanup.

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-09T01:12:55Z
- **Completed:** 2026-02-09T01:15:31Z
- **Tasks:** 1
- **Files modified:** 7

## Accomplishments

- API port now reads from PORT env var (default 3000) for container flexibility
- Replaced console.log with NestJS Logger and set appropriate log levels per environment
- TEE simulator guard checks CIPHERBOX_ENVIRONMENT instead of NODE_ENV, allowing staging to run NODE_ENV=production with TEE_MODE=simulator
- Web app switched from BrowserRouter to HashRouter for IPFS gateway compatibility (no more 404s on refresh)
- Web3Auth network selection is now environment-aware via VITE_ENVIRONMENT (devnet for local/ci/staging, mainnet for production)
- TypeORM logging reduced from boolean true (all SQL queries) to targeted arrays (errors, warnings, migrations)
- Removed dead VITE_PINATA_GATEWAY_URL from .env.example and e2e workflow

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix API port, TEE guard, hash routing, and logging** - `7cf7fed` (feat)

## Files Created/Modified

- `apps/api/src/main.ts` - Configurable port via PORT env var, NestJS Logger, environment-aware log levels
- `apps/api/src/app.module.ts` - TypeORM logging changed from boolean to array format
- `tee-worker/src/services/tee-keys.ts` - TEE simulator guard uses CIPHERBOX_ENVIRONMENT instead of NODE_ENV
- `apps/web/src/routes/index.tsx` - BrowserRouter replaced with HashRouter
- `apps/web/src/lib/web3auth/config.ts` - NETWORK_CONFIG map with VITE_ENVIRONMENT selection
- `apps/web/.env.example` - Removed dead VITE_PINATA_GATEWAY_URL
- `.github/workflows/e2e.yml` - Removed dead VITE_PINATA_GATEWAY_URL from e2e env setup

## Decisions Made

| Decision                                   | Rationale                                                                                           |
| ------------------------------------------ | --------------------------------------------------------------------------------------------------- |
| NestJS Logger instead of nestjs-pino       | Simpler approach, no new dependency; Grafana Alloy can ingest plain text logs                       |
| TypeORM logging as array, not boolean      | Targeted logging: errors+warnings+migrations in dev, errors+migrations in staging                   |
| CIPHERBOX_ENVIRONMENT for TEE guard        | Decouples deployment tier from NODE_ENV, allowing staging to use NODE_ENV=production with simulator |
| HashRouter for IPFS hosting                | IPFS gateways serve files literally by path; hash routing keeps all routes under index.html         |
| VITE_ENVIRONMENT with fallback to 'local'  | Safe default for development; explicit override for CI, staging, production                         |
| Dead env var cleanup includes e2e workflow | VITE_PINATA_GATEWAY_URL was set in e2e.yml but never consumed by source code                        |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Removed dead VITE_PINATA_GATEWAY_URL from e2e workflow and .env.example**

- **Found during:** Task 1 (dead env var removal)
- **Issue:** Plan only mentioned removing from `apps/web/.env`, but the dead var also existed in `.env.example` and `.github/workflows/e2e.yml`
- **Fix:** Removed from all three locations for consistency
- **Files modified:** `apps/web/.env.example`, `.github/workflows/e2e.yml`
- **Verification:** grep confirms no references remain in source code
- **Committed in:** 7cf7fed (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 missing critical cleanup)
**Impact on plan:** Extended cleanup scope to cover all locations of dead env var. No scope creep.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- All environment-aware configuration is in place for staging deployment
- Ready for Plan 02 (Dockerfiles and docker-compose.staging.yml)
- CIPHERBOX_ENVIRONMENT and VITE_ENVIRONMENT patterns established for downstream plans

---

_Phase: 09.1-env-devops-staging_
_Completed: 2026-02-09_
