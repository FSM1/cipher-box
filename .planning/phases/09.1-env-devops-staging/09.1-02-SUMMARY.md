---
phase: 09.1-env-devops-staging
plan: 02
subsystem: infra
tags: [docker, docker-compose, caddy, reverse-proxy, staging, multi-stage-build, ghcr]

# Dependency graph
requires:
  - phase: 01-foundation
    provides: pnpm monorepo structure, API scaffold, tsconfig.base.json
  - phase: 08-tee-integration
    provides: TEE worker container, Redis for BullMQ
provides:
  - Multi-stage API Dockerfile building from monorepo root
  - Staging Docker Compose with 6 services (API, Postgres, Redis, Kubo, TEE worker, Caddy)
  - Caddy reverse proxy with Cloudflare Origin CA TLS termination
  - .dockerignore excluding non-API files from build context
affects: [09.1-03, 09.1-04, 09.1-05, 09.1-06]

# Tech tracking
tech-stack:
  added: [caddy:2-alpine]
  patterns:
    [multi-stage-docker-build, ghcr-image-references, localhost-bound-ports, cloudflare-origin-ca]

key-files:
  created:
    - apps/api/Dockerfile
    - .dockerignore
    - docker/docker-compose.staging.yml
    - docker/Caddyfile
  modified: []

key-decisions:
  - 'Multi-stage Dockerfile with deps/build/production stages for minimal image size'
  - 'Build from monorepo root (context=.) for pnpm workspace lockfile resolution'
  - 'GHCR image placeholders with GITHUB_REPOSITORY_OWNER variable substitution'
  - 'All non-public ports bound to 127.0.0.1 for VPS security'
  - 'Caddy with auto_https off and Cloudflare Origin CA certs for Full (Strict) SSL'
  - 'Non-root user (appuser:1001) in production Docker image'

patterns-established:
  - 'Multi-stage build: Copy both root and workspace node_modules for pnpm hoisting'
  - 'Staging compose references GHCR images with TAG variable, not local builds'
  - 'Health checks with depends_on conditions for service startup ordering'

# Metrics
duration: 2min
completed: 2026-02-09
---

# Phase 9.1 Plan 02: Docker Infrastructure Summary

Multi-stage API Dockerfile, 6-service staging Docker Compose with Caddy reverse proxy and Cloudflare Origin CA TLS.

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-09T01:13:00Z
- **Completed:** 2026-02-09T01:15:13Z
- **Tasks:** 2/2
- **Files created:** 4

## Accomplishments

- Multi-stage API Dockerfile (deps, build, production) building from monorepo root with pnpm workspace support
- Staging Docker Compose orchestrating API, Postgres, Redis, Kubo IPFS, TEE worker, and Caddy reverse proxy
- Caddy reverse proxy configuration using Cloudflare Origin CA certificates for Full (Strict) SSL mode
- .dockerignore excluding web app, desktop app, tests, documentation, and build outputs from Docker context

## Task Commits

Each task was committed atomically:

1. **Task 1: Create API Dockerfile and .dockerignore** - `91fbec3` (feat)
2. **Task 2: Create staging Docker Compose and Caddyfile** - `278a2b2` (feat)

## Files Created

- `apps/api/Dockerfile` - Multi-stage Docker build for API (deps -> build -> production), node:22-alpine, non-root user
- `.dockerignore` - Excludes node_modules, .git, apps/web, apps/desktop, tee-worker, tests, docs from build context
- `docker/docker-compose.staging.yml` - 6-service staging stack with health checks, resource limits, localhost-bound ports
- `docker/Caddyfile` - Caddy reverse proxy: HTTPS with Origin CA certs, HTTP redirect, Docker service name upstream

## Decisions Made

- **Build context is monorepo root:** pnpm needs workspace root for lockfile resolution. The Dockerfile is at `apps/api/Dockerfile` but build runs from `.` with `-f` flag.
- **Copy both root and workspace node_modules:** pnpm may hoist dependencies to root `node_modules/`. Both are copied to production stage to ensure all modules resolve.
- **GHCR image placeholder with variable:** Using `${GITHUB_REPOSITORY_OWNER:-OWNER}` allows the deploy workflow to substitute the actual GitHub owner at runtime.
- **Caddy auto_https off:** Cloudflare handles browser-facing TLS. Caddy only needs to serve the Origin CA cert for the CF-to-origin connection.
- **Kubo resource limits:** 2G memory and 1.0 CPU to prevent IPFS from consuming all VPS resources.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- Docker daemon not running on build machine, so Docker build verification could not be executed. Dockerfile syntax and structure verified manually. Build should be tested when Docker is available.

## User Setup Required

None - no external service configuration required for these files. Cloudflare Origin CA certs and GitHub Secrets configuration will be handled in later plans.

## Next Phase Readiness

- Dockerfile ready for CI/CD pipeline (Plan 09.1-04 deployment workflow)
- Docker Compose ready for VPS deployment
- Caddyfile ready for reverse proxy setup
- Docker build should be verified when Docker daemon is available

---

_Phase: 09.1-env-devops-staging_
_Completed: 2026-02-09_
