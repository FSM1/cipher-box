---
phase: 09.1-env-devops-staging
plan: 03
subsystem: database
tags: [typeorm, postgres, migrations, schema, staging]

# Dependency graph
requires:
  - phase: 01-foundation
    provides: TypeORM configuration and data-source.ts
  - phase: 02-authentication
    provides: User, RefreshToken, AuthMethod entities
  - phase: 03-core-encryption
    provides: Vault entity with encrypted key columns
  - phase: 04-file-storage
    provides: PinnedCid entity for quota tracking
  - phase: 05-folder-system
    provides: FolderIpns entity for IPNS tracking
  - phase: 08-tee-integration
    provides: TeeKeyState, TeeKeyRotationLog, IpnsRepublishSchedule entities
provides:
  - Full schema baseline migration for fresh database initialization
  - Staging/production database can be initialized without synchronize:true
affects:
  - 09.1-env-devops-staging (other plans in this phase depend on migration for staging deploy)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'Baseline migration with early timestamp (1700000000000) to precede incremental migrations'
    - 'Full schema migration includes final column states so incremental patches become no-ops'

key-files:
  created:
    - apps/api/src/migrations/1700000000000-FullSchema.ts
  modified: []

key-decisions:
  - 'Timestamp 1700000000000 precedes existing incrementals (1737520000000, 1738972800000)'
  - 'Full schema includes tokenPrefix and nullable TEE fields in final state'
  - 'uuid-ossp extension created for uuid_generate_v4() default values'

patterns-established:
  - 'Baseline migration pattern: full schema at early timestamp, incremental patches on top'

# Metrics
duration: 1min
completed: 2026-02-09
---

# Phase 9.1 Plan 03: Full Schema Migration Summary

Baseline TypeORM migration creating all 9 CipherBox tables with columns, constraints, indexes, and foreign keys for fresh staging database initialization.

## Performance

- **Duration:** 1 min
- **Started:** 2026-02-09T01:13:04Z
- **Completed:** 2026-02-09T01:14:27Z
- **Tasks:** 1/1
- **Files created:** 1

## Accomplishments

- Created full schema baseline migration covering all 9 database tables
- Migration includes all columns, types, constraints, unique indexes, and foreign keys
- Fresh staging/production databases can now be initialized with `migration:run`
- Timestamp ordering ensures baseline runs before incremental patches

## Task Commits

Each task was committed atomically:

1. **Task 1: Generate full schema migration** - `2d13f65` (feat)

**Plan metadata:** (pending)

## Files Created/Modified

- `apps/api/src/migrations/1700000000000-FullSchema.ts` - Baseline migration creating all 9 tables: users, refresh_tokens, auth_methods, vaults, pinned_cids, folder_ipns, tee_key_state, tee_key_rotation_log, ipns_republish_schedule

## Decisions Made

- **Timestamp 1700000000000:** Chosen to precede existing incremental migrations (1737520000000, 1738972800000) so baseline runs first on fresh databases
- **Final column states included:** tokenPrefix on refresh_tokens and nullable TEE fields on folder_ipns are already in their final form, making the 2 incremental migrations no-ops on fresh databases
- **uuid-ossp extension:** Explicitly created via `CREATE EXTENSION IF NOT EXISTS` for UUID default values

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - data-source.ts already had the correct migrations glob pattern (`src/migrations/*.ts`), so no modification was needed.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Schema migration ready for staging deployment
- Fresh PostgreSQL databases can be fully initialized via `pnpm typeorm migration:run -d src/data-source.ts`
- Existing local dev databases (using synchronize:true) are unaffected

---

_Phase: 09.1-env-devops-staging_
_Completed: 2026-02-09_
