---
phase: 09.1-env-devops-staging
plan: 06
type: execute
wave: 2
depends_on: ['09.1-02']
files_modified:
  - docker/docker-compose.staging.yml
  - docker/alloy-config.river
autonomous: true

must_haves:
  truths:
    - 'Grafana Alloy agent runs as a Docker Compose service and ships container logs to Grafana Cloud Loki'
    - 'All container logs are centralized in Grafana Cloud with labels per service'
    - 'Alloy config scrapes Docker container logs via the Docker socket'
  artifacts:
    - path: 'docker/alloy-config.river'
      provides: 'Grafana Alloy configuration for log collection'
      contains: 'loki.write'
    - path: 'docker/docker-compose.staging.yml'
      provides: 'Alloy service added to staging compose'
      contains: 'alloy'
  key_links:
    - from: 'docker/docker-compose.staging.yml'
      to: 'docker/alloy-config.river'
      via: 'volume mount'
      pattern: 'alloy-config.river'
    - from: 'docker/alloy-config.river'
      to: 'Grafana Cloud Loki endpoint'
      via: 'loki.write endpoint URL'
      pattern: 'logs-prod'
---

<objective>
Set up centralized log aggregation for the staging environment by adding Grafana Alloy to the Docker Compose stack.

Purpose: When staging inevitably has issues, you need to be able to see logs from all containers in one place. Without this, debugging requires SSH + `docker compose logs` for each service -- slow and error-prone. Grafana Cloud Free (50GB logs/month) provides centralized logs with search/filter.

Output: Alloy config file for log shipping, updated Docker Compose with Alloy service, and monitoring setup documentation.

Note: After this plan completes, a re-deployment (push a new staging tag) is needed to apply the Alloy service and log rotation changes to the running staging environment.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.1-env-devops-staging/09.1-CONTEXT.md
@.planning/phases/09.1-env-devops-staging/09.1-RESEARCH.md
@.planning/phases/09.1-env-devops-staging/09.1-02-SUMMARY.md
@docker/docker-compose.staging.yml
</context>

<tasks>

<task type="auto">
<name>Task 1: Create Grafana Alloy config and add to Docker Compose</name>
<files>
docker/alloy-config.river
docker/docker-compose.staging.yml
</files>
<action>

**1. Create `docker/alloy-config.river` (Grafana Alloy configuration):**

Grafana Alloy (formerly Grafana Agent) uses River configuration format. The config should:

- Discover Docker containers via the Docker socket
- Collect logs from all running containers
- Add labels for service name, container name, and compose project
- Ship logs to Grafana Cloud Loki endpoint

```river
// Docker log discovery
discovery.docker "containers" {
  host = "unix:///var/run/docker.sock"
}

// Relabel to extract useful metadata
discovery.relabel "containers" {
  targets = discovery.docker.containers.targets

  rule {
    source_labels = ["__meta_docker_container_name"]
    target_label  = "container"
  }

  rule {
    source_labels = ["__meta_docker_container_label_com_docker_compose_service"]
    target_label  = "service"
  }

  rule {
    source_labels = ["__meta_docker_container_label_com_docker_compose_project"]
    target_label  = "project"
  }
}

// Collect logs from discovered containers
loki.source.docker "containers" {
  host    = "unix:///var/run/docker.sock"
  targets = discovery.relabel.containers.output

  forward_to = [loki.write.grafana_cloud.receiver]
}

// Ship to Grafana Cloud
loki.write "grafana_cloud" {
  endpoint {
    url = env("GRAFANA_LOKI_URL")

    basic_auth {
      username = env("GRAFANA_LOKI_USERNAME")
      password = env("GRAFANA_LOKI_API_KEY")
    }
  }
}
```

The Grafana Cloud Loki URL, username, and API key are read from environment variables (injected via .env.staging on the VPS).

**2. Add Alloy service to `docker/docker-compose.staging.yml`:**

Read the existing docker-compose.staging.yml (created by Plan 02) and add this service:

```yaml
alloy:
  image: grafana/alloy:latest
  restart: unless-stopped
  volumes:
    - ./alloy-config.river:/etc/alloy/config.river
    - /var/run/docker.sock:/var/run/docker.sock:ro
  environment:
    GRAFANA_LOKI_URL: ${GRAFANA_LOKI_URL}
    GRAFANA_LOKI_USERNAME: ${GRAFANA_LOKI_USERNAME}
    GRAFANA_LOKI_API_KEY: ${GRAFANA_LOKI_API_KEY}
  command:
    - run
    - /etc/alloy/config.river
  depends_on:
    - api
```

Note: The Docker socket is mounted read-only (`:ro`) -- Alloy only needs to read container metadata and logs, not manage containers.

Also add to the `docker/docker-compose.staging.yml` file a `logging` driver config for all services to ensure Docker retains logs for Alloy to scrape:

```yaml
x-logging: &default-logging
  driver: json-file
  options:
    max-size: '10m'
    max-file: '3'
```

Apply `logging: *default-logging` to each service to prevent unbounded log growth on disk.

</action>
<verify>

1. `docker/alloy-config.river` exists and contains `loki.write` and `discovery.docker`
2. `grep 'alloy' docker/docker-compose.staging.yml` shows the Alloy service
3. `grep 'docker.sock' docker/docker-compose.staging.yml` shows Docker socket mount
4. `grep 'max-size' docker/docker-compose.staging.yml` shows log rotation config
5. `docker compose -f docker/docker-compose.staging.yml config` validates (with --no-interpolate if env vars not set)

</verify>
<done>
Grafana Alloy agent configured to ship all container logs to Grafana Cloud Loki. Docker Compose updated with Alloy service and log rotation for all containers.
</done>
</task>

<task type="auto">
<name>Task 2: Document monitoring setup instructions</name>
<files>
docker/MONITORING.md
</files>
<action>

Create `docker/MONITORING.md` with setup instructions for both monitoring services. This is a one-time manual setup the user does alongside Plan 05's infrastructure provisioning.

**Contents:**

1. **Grafana Cloud Free setup:**
   - Sign up at grafana.com/products/cloud (free tier: 50GB logs/month, 14-day retention)
   - Create a Grafana Cloud stack
   - Go to Connections > Loki > Generate API key (with MetricsPublisher + LogsPublisher roles)
   - Note the Loki push URL (e.g., `https://logs-prod-XXX.grafana.net/loki/api/v1/push`)
   - Note the username (numeric instance ID) and API key
   - Add to GitHub Secrets: `GRAFANA_LOKI_URL`, `GRAFANA_LOKI_USERNAME`, `GRAFANA_LOKI_API_KEY`

2. **Better Stack Uptime setup:**
   - Sign up at betterstack.com/uptime (free tier: 10 monitors, 3-min checks)
   - Create a monitor: URL = `https://api.staging.cipherbox.cc/health`, check interval = 3 min
   - Optionally create a status page at e.g., `status.staging.cipherbox.cc`
   - Configure email alerts for downtime notifications

3. **Useful Grafana Cloud queries:**
   - All API logs: `{service="api"}`
   - API errors only: `{service="api"} |= "error" or {service="api"} |= "ERROR"`
   - TEE worker logs: `{service="tee-worker"}`
   - Kubo IPFS logs: `{service="ipfs"}`
   - All errors across services: `{project="cipherbox"} |= "error"`

4. **Dashboard suggestions:**
   - Create a "CipherBox Staging" dashboard in Grafana Cloud
   - Panel: Log volume by service (bar chart)
   - Panel: Error rate over time (time series)
   - Panel: Recent errors (log panel with `|= "error"` filter)

</action>
<verify>

1. `docker/MONITORING.md` exists with Grafana Cloud and Better Stack instructions
2. File includes GitHub Secrets names for Grafana credentials
3. File includes example LogQL queries

</verify>
<done>
Monitoring setup documentation complete with step-by-step instructions for Grafana Cloud Free and Better Stack Uptime, including useful log queries and dashboard suggestions.
</done>
</task>

</tasks>

<verification>

- Alloy config file exists with Docker log discovery and Loki write endpoint
- Docker Compose includes Alloy service with Docker socket mount
- Log rotation configured for all services (prevent disk exhaustion)
- Monitoring setup documentation includes both Grafana Cloud and Better Stack instructions
- GitHub Secrets list updated to include Grafana credentials

</verification>

<success_criteria>
Grafana Alloy agent is configured to ship all container logs to Grafana Cloud Loki. Docker Compose updated with log rotation and Alloy service. Better Stack uptime monitoring documented. All monitoring credentials managed via GitHub Secrets and .env.staging. A re-deployment after Plan 05 applies these changes to the live staging environment.
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-env-devops-staging/09.1-06-SUMMARY.md`
</output>
