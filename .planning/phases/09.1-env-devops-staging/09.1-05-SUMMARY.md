---
phase: 09.1-env-devops-staging
plan: 05
subsystem: infra
tags: [vps, cloudflare, dns, ssl, github-environments, staging, deployment, caddy]

# Dependency graph
requires:
  - phase: 09.1-env-devops-staging
    provides: Deployment workflow (plan 04), Docker Compose (plan 02), Caddyfile (plan 02), env config (plan 01)
provides:
  - Live staging environment at api-staging.cipherbox.cc and app-staging.cipherbox.cc
  - 7 Docker containers running on Hostinger VPS
  - CI/CD pipeline verified end-to-end
affects: []

# Tech tracking
tech-stack:
  added: [cloudflare-origin-ca, caddy-static-files, github-environments]
  patterns:
    [
      flat-subdomain-naming,
      pnpm-deploy-legacy,
      vps-static-file-serving,
      github-env-secrets-vars-split,
    ]

key-files:
  modified:
    - .github/workflows/deploy-staging.yml
    - docker/docker-compose.staging.yml
    - docker/Caddyfile
    - apps/api/Dockerfile
    - apps/api/package.json
    - pnpm-lock.yaml

key-decisions:
  - 'Flat subdomains (api-staging, app-staging) instead of nested (api.staging) for Cloudflare Universal SSL compatibility'
  - 'Serve web app from Caddy on VPS instead of IPFS/Pinata gateway (deprecated/paid)'
  - 'GitHub Environments for secret management with vars/secrets split'
  - 'pnpm deploy --prod --legacy for flat node_modules in Docker'
  - '@nestjs/throttler moved from devDependencies to dependencies'
  - 'GHCR requires lowercase image names — bash ${VAR,,} operator'

patterns-established:
  - 'Deploy tag triggers full CI/CD: push v*-staging* -> build -> deploy -> verify'
  - 'Docker Compose .env must be named .env for variable substitution'
  - 'Caddy hostname-based routing for multi-site reverse proxy + static files'

# Metrics
duration: ~90min (interactive with user)
completed: 2026-02-09
---

# Phase 9.1 Plan 05: Infrastructure Provisioning & First Deployment Summary

Interactive infrastructure provisioning and deployment verification. Walked through VPS setup, DNS, SSL, secrets, and triggered first deployment with iterative fixes until staging was fully operational.

## Performance

- **Duration:** ~90 min (interactive, human-in-the-loop)
- **Completed:** 2026-02-09
- **Deployment attempts:** 8 (1 success, 7 fix iterations)
- **Files modified:** 6

## Accomplishments

- Provisioned Hostinger VPS with Docker, SSH key access, and directory structure
- Configured Cloudflare Origin CA wildcard certificate for `*.cipherbox.cc`
- Set up GitHub Environment (`staging`) with vars/secrets split for clean secret management
- Configured Grafana Cloud Loki for log aggregation and Better Stack for uptime monitoring
- Deployed all 7 services: API, PostgreSQL, Redis, IPFS (Kubo), TEE worker, Caddy, Alloy
- API healthy at <https://api-staging.cipherbox.cc/health>
- Web app served at <https://app-staging.cipherbox.cc>

## Deployment Issues Fixed (7 iterations)

1. **GHCR uppercase rejection** — `FSM1` rejected; fixed with `${GITHUB_REPOSITORY_OWNER,,}` bash lowercase
2. **Pinata multipart corruption** — Shell echo/cat corrupts binary; switched to curl `-F` flags
3. **Pinata directory upload** — Needs common folder prefix; added `site/` prefix to filenames
4. **pnpm workspace symlinks** — Docker COPY breaks symlinks; switched to `pnpm deploy --prod --legacy`
5. **Missing @nestjs/throttler** — Was in devDependencies but imported at runtime; moved to dependencies
6. **Cloudflare SSL two-level subdomain** — Universal SSL only covers `*.cipherbox.cc`; flattened to `api-staging`/`app-staging`
7. **Cloudflare IPFS gateway deprecated** — Switched to serving web app from Caddy on VPS

## Commits

- `80d0bf3` feat(09.1-05): use GitHub environment for staging secrets and variables
- `702e3d8` fix(09.1-05): lowercase GHCR image names and fix Pinata multipart upload
- `b7ce05d` fix(09.1-05): add directory prefix for Pinata folder upload
- `d606f36` fix(09.1-05): use pnpm deploy for API Dockerfile, fix .env and certs
- `0875e1b` fix(09.1-05): add --legacy flag for pnpm v10 deploy
- `b8fb948` fix(09.1-05): move @nestjs/throttler to production dependencies
- `bbeeca1` fix(09.1-05): flatten staging subdomains for Cloudflare Universal SSL
- `3ffff52` feat(09.1-05): serve web app from Caddy instead of IPFS gateway

## Infrastructure Provisioned

| Component  | Details                                                                 |
| ---------- | ----------------------------------------------------------------------- |
| VPS        | Hostinger, 76.13.151.200, Docker + Compose                              |
| DNS        | api-staging.cipherbox.cc, app-staging.cipherbox.cc (Cloudflare proxied) |
| SSL        | Cloudflare Origin CA wildcard, Full (Strict) mode                       |
| Secrets    | GitHub Environment `staging` with 8 secrets + 5 vars                    |
| Monitoring | Grafana Cloud Loki (logs), Better Stack (uptime)                        |
| Containers | 7 running: api, postgres, redis, ipfs, tee-worker, caddy, alloy         |

## Verification

- API health: `{"status":"ok","info":{"database":{"status":"up"}}}`
- Web app: HTTP 200
- All 7 Docker containers: Running
- CI/CD pipeline: Last run succeeded
- Better Stack: Monitoring active

---

_Phase: 09.1-env-devops-staging_
_Completed: 2026-02-09_
