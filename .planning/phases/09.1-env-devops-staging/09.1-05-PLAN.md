---
phase: 09.1-env-devops-staging
plan: 05
type: execute
wave: 3
depends_on: ['09.1-04']
files_modified: []
autonomous: false
user_setup:
  - service: hostinger-vps
    why: 'Staging server for all backend services'
    env_vars: []
    dashboard_config:
      - task: 'Provision VPS with 4GB RAM / 2 vCPU minimum'
        location: 'Hostinger Dashboard'
      - task: 'Install Docker and Docker Compose v2 on VPS'
        location: 'SSH into VPS'
      - task: 'Create /opt/cipherbox directory on VPS'
        location: 'SSH into VPS'
      - task: 'Generate SSH keypair for CI access and add public key to VPS authorized_keys'
        location: 'SSH into VPS'
  - service: cloudflare
    why: 'DNS, SSL, and IPFS gateway for web app'
    env_vars:
      - name: CLOUDFLARE_API_TOKEN
        source: 'Cloudflare Dashboard -> My Profile -> API Tokens -> Create Token (Zone:DNS:Edit)'
      - name: CLOUDFLARE_ZONE_ID
        source: 'Cloudflare Dashboard -> domain -> Overview -> Zone ID (right sidebar)'
      - name: CLOUDFLARE_DNSLINK_RECORD_ID
        source: 'After creating _dnslink.app TXT record, get record ID via Cloudflare API'
    dashboard_config:
      - task: 'Create A record: api -> VPS IP (proxied)'
        location: 'Cloudflare Dashboard -> DNS -> Records'
      - task: 'Create CNAME record: app -> cloudflare-ipfs.com (proxied)'
        location: 'Cloudflare Dashboard -> DNS -> Records'
      - task: 'Create TXT record: _dnslink.app -> dnslink=/ipfs/placeholder (DNS only)'
        location: 'Cloudflare Dashboard -> DNS -> Records'
      - task: 'Set SSL/TLS mode to Full (Strict)'
        location: 'Cloudflare Dashboard -> SSL/TLS -> Overview'
      - task: 'Generate Origin CA certificate (15-year) and upload to VPS'
        location: 'Cloudflare Dashboard -> SSL/TLS -> Origin Server'
  - service: github
    why: 'Store deployment secrets for CI/CD'
    env_vars:
      - name: STAGING_HOST
        source: 'VPS IP address from Hostinger'
      - name: STAGING_USER
        source: 'SSH username on VPS'
      - name: STAGING_SSH_KEY
        source: 'SSH private key generated for CI access'
      - name: STAGING_DB_USERNAME
        source: 'Generate a database username'
      - name: STAGING_DB_PASSWORD
        source: 'Generate a strong random password (openssl rand -hex 32)'
      - name: STAGING_JWT_SECRET
        source: 'Generate a strong random secret (openssl rand -hex 32)'
      - name: STAGING_TEE_WORKER_SECRET
        source: 'Generate a strong random secret (openssl rand -hex 32)'
      - name: STAGING_API_URL
        source: 'https://api.yourdomain.com'
      - name: STAGING_WEB_APP_URL
        source: 'https://app.yourdomain.com'
      - name: STAGING_PINATA_GATEWAY_URL
        source: 'https://gateway.pinata.cloud/ipfs'
      - name: PINATA_JWT
        source: 'Pinata Dashboard -> API Keys -> Generate JWT'
    dashboard_config:
      - task: 'Add all secrets listed above to repository secrets'
        location: 'GitHub -> Repository -> Settings -> Secrets and variables -> Actions'

must_haves:
  truths:
    - 'VPS is provisioned with Docker installed'
    - 'Cloudflare DNS records point to VPS and IPFS gateway'
    - 'All GitHub Secrets are configured'
    - 'Origin CA certificate is installed on VPS'
    - 'First deployment tag triggers successful pipeline run'
  artifacts: []
  key_links: []
---

<objective>
Verify staging infrastructure setup and trigger the first deployment.

Purpose: Plans 01-04 created all the code and configuration. This plan is where the user provisions the actual infrastructure (VPS, DNS, secrets) and verifies the deployment pipeline works end-to-end.

Output: A working staging environment accessible via the configured domain.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.1-env-devops-staging/09.1-CONTEXT.md
@.planning/phases/09.1-env-devops-staging/09.1-04-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
<action>Provision staging infrastructure and configure secrets</action>
<instructions>

The deployment pipeline is ready but needs real infrastructure. Complete these setup steps:

VPS Setup (Hostinger): Provision a VPS with minimum 4GB RAM / 2 vCPU. Install Docker and Docker Compose v2:

```bash
curl -fsSL https://get.docker.com | sh
```

Create the deployment directory:

```bash
mkdir -p /opt/cipherbox/certs
```

Generate an SSH keypair for CI access:

```bash
ssh-keygen -t ed25519 -f ci-deploy-key -N ""
# Add ci-deploy-key.pub to /root/.ssh/authorized_keys on VPS
# Save ci-deploy-key (private) for GitHub Secrets
```

Cloudflare DNS Setup: Add DNS records (replace VPS_IP with your VPS IP). A record: api -> VPS_IP (Proxied, orange cloud). CNAME record: app -> cloudflare-ipfs.com (Proxied). TXT record: \_dnslink.app -> dnslink=/ipfs/placeholder (DNS only, gray cloud).

Set SSL/TLS to Full (Strict). Generate Origin CA certificate (SSL/TLS -> Origin Server -> Create Certificate, RSA 2048, 15-year). Save origin.pem and origin-key.pem, then upload to VPS:

```bash
scp origin.pem origin-key.pem root@VPS_IP:/opt/cipherbox/certs/
```

Note your Zone ID and the DNSLink TXT record ID.

Pinata Setup: Ensure your Pinata account has API access. Generate a JWT token (Dashboard -> API Keys -> New Key with pinFileToIPFS + pinList permissions). Save the JWT for GitHub Secrets.

GitHub Secrets: Go to repository Settings -> Secrets and variables -> Actions. Add these repository secrets: STAGING_HOST (VPS IP), STAGING_USER (SSH username), STAGING_SSH_KEY (CI SSH private key), STAGING_DB_USERNAME, STAGING_DB_PASSWORD (openssl rand -hex 32), STAGING_JWT_SECRET (openssl rand -hex 32), STAGING_TEE_WORKER_SECRET (openssl rand -hex 32), STAGING_API_URL (e.g., <https://api.yourdomain.com>), STAGING_WEB_APP_URL (e.g., <https://app.yourdomain.com>), STAGING_PINATA_GATEWAY_URL (<https://gateway.pinata.cloud/ipfs>), PINATA_JWT, CLOUDFLARE_API_TOKEN (DNS edit permission), CLOUDFLARE_ZONE_ID, CLOUDFLARE_DNSLINK_RECORD_ID, VITE_WEB3AUTH_CLIENT_ID (may already exist).

Copy Docker Compose to VPS:

```bash
scp docker/docker-compose.staging.yml root@VPS_IP:/opt/cipherbox/docker-compose.staging.yml
scp docker/Caddyfile root@VPS_IP:/opt/cipherbox/Caddyfile
```

</instructions>
<resume-signal>Type "infrastructure ready" when all setup is complete</resume-signal>
</task>

<task type="auto">
<name>Task 2: Trigger first deployment and verify</name>
<files></files>
<action>

After the user confirms infrastructure is ready:

1. Create and push the first staging tag:

```bash
git tag v0.1.0-staging.1
git push origin v0.1.0-staging.1
```

2. Monitor the GitHub Actions workflow:

```bash
gh run list --workflow=deploy-staging.yml --limit=1
gh run watch
```

3. If the workflow fails, read the logs, diagnose the issue, and fix:

```bash
gh run view --log-failed
```

Common issues: Docker build failures (fix Dockerfile or .dockerignore), SSH connection refused (verify SSH key and VPS IP in secrets), Pinata upload failure (verify PINATA_JWT), Cloudflare API error (verify API token permissions and zone ID), migration failure (database may need initial connection).

4. If the workflow succeeds, verify the staging environment by checking API health endpoint, web app loading, and Swagger docs.

</action>
<verify>

1. GitHub Actions workflow completes successfully
2. API health endpoint returns 200 on staging domain
3. Web app is accessible at staging domain

</verify>
<done>
First deployment tag triggers successful pipeline run. API responds on staging domain. Web app loads from IPFS via Cloudflare.
</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
<what-built>Complete staging deployment: API on VPS behind Caddy/Cloudflare, web app on IPFS via Pinata/Cloudflare, TEE worker running alongside API</what-built>
<how-to-verify>

1. Open the staging web app URL in a browser -- the CipherBox login page should load
2. Open the staging API URL /health -- should return health status JSON
3. Open the staging API URL /api-docs -- Swagger UI should load
4. Try logging in via Web3Auth on the staging web app
5. Check Docker containers on VPS via SSH -- should show 6 containers running

</how-to-verify>
<resume-signal>Type "approved" if staging works, or describe issues</resume-signal>
</task>

</tasks>

<verification>

- GitHub Actions deploy-staging workflow completed successfully
- API responds at staging domain /health endpoint
- Web app loads at staging domain
- Docker containers running on VPS

</verification>

<success_criteria>
Staging environment is live: web app accessible via IPFS/Cloudflare, API accessible via VPS/Caddy/Cloudflare, all services running in Docker. The deployment pipeline works end-to-end from tag push to live environment.
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-env-devops-staging/09.1-05-SUMMARY.md`
</output>
