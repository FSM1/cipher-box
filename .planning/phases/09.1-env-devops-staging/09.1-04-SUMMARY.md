---
phase: 09.1-env-devops-staging
plan: 04
subsystem: infra
tags: [github-actions, ci-cd, deployment, docker, ghcr, pinata, cloudflare, dnslink, staging]

# Dependency graph
requires:
  - phase: 09.1-env-devops-staging
    provides: API Dockerfile (plan 02), Docker Compose staging (plan 02), environment-aware config (plan 01), full schema migration (plan 03)
provides:
  - Tag-triggered GitHub Actions deployment workflow (4 jobs)
  - Multi-stage TEE worker Dockerfile for CI builds
  - Programmatic migration runner for Docker containers
affects: [09.1-05, 09.1-06]

# Tech tracking
tech-stack:
  added:
    [
      docker/login-action@v3,
      docker/build-push-action@v5,
      appleboy/ssh-action@v1,
      appleboy/scp-action@v0.1.7,
    ]
  patterns:
    [
      tag-triggered-deployment,
      ghcr-image-push,
      pinata-directory-upload,
      cloudflare-dnslink-update,
      programmatic-typeorm-migrations,
    ]

key-files:
  created:
    - .github/workflows/deploy-staging.yml
    - apps/api/src/run-migrations.ts
  modified:
    - tee-worker/Dockerfile

key-decisions:
  - 'Programmatic migration runner (run-migrations.ts) instead of TypeORM CLI for Docker containers'
  - 'curl-based Pinata directory upload with multipart form encoding'
  - 'Cloudflare DNSLink TXT record update via REST API'
  - 'Multi-stage TEE worker Dockerfile builds from source (no pre-built dist needed)'

patterns-established:
  - 'Tag-triggered deploy: push v*-staging* tag to trigger full staging deployment'
  - 'Migration before service start: run-migrations.js executes before docker compose up'
  - 'Secret injection: GitHub Secrets -> .env file -> SCP to VPS -> Docker Compose env_file'

# Metrics
duration: 3min
completed: 2026-02-09
---

# Phase 9.1 Plan 04: Deployment Workflow Summary

Tag-triggered GitHub Actions workflow deploying API, TEE worker, and web app to staging via GHCR, Pinata IPFS, and Cloudflare DNSLink.

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-09T01:18:59Z
- **Completed:** 2026-02-09T01:22:14Z
- **Tasks:** 2/2
- **Files created:** 2
- **Files modified:** 1

## Accomplishments

- Multi-stage TEE worker Dockerfile that builds from source without pre-built dist
- 4-job deployment workflow: build-api, build-tee, deploy-web, deploy-vps
- Pinata directory upload with CID capture and Cloudflare DNSLink update
- Programmatic TypeORM migration runner for production Docker containers

## Task Commits

Each task was committed atomically:

1. **Task 1: Update TEE worker Dockerfile to multi-stage** - `d6af465` (feat)
2. **Task 2: Create tag-triggered deployment workflow** - `f809825` (feat)

## Files Created/Modified

- `tee-worker/Dockerfile` - Multi-stage build: stage 1 installs deps + compiles TS, stage 2 copies dist + runs as node user
- `.github/workflows/deploy-staging.yml` - 240-line deployment workflow with 4 jobs triggered by v*-staging* tags
- `apps/api/src/run-migrations.ts` - Programmatic migration runner using compiled JS entity/migration globs for Docker

## Decisions Made

- **Programmatic migration runner instead of TypeORM CLI:** The production Docker image lacks ts-node and npx. The data-source.ts uses TypeScript glob paths (src/**/\*.entity.ts) that don't resolve in compiled output. A standalone run-migrations.ts with JS-compatible paths (dist/**/\*.entity.js) solves both issues cleanly.
- **curl for Pinata upload:** Direct API call with multipart form encoding. The Pinata CLI or SDK could also work but curl is more portable in CI environments and avoids additional dependencies.
- **SCP then SSH pattern for VPS deploy:** Files are copied first (docker-compose, .env, Caddyfile), then SSH executes docker commands. This separates file transfer from service orchestration.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Added programmatic migration runner**

- **Found during:** Task 2 (deployment workflow creation)
- **Issue:** The plan mentioned using `node dist/data-source.js migration:run` but data-source.ts uses TypeScript glob paths that won't resolve in compiled JS. The production container also lacks ts-node/npx for the CLI approach.
- **Fix:** Created `apps/api/src/run-migrations.ts` with JS-compatible entity/migration paths and programmatic `dataSource.runMigrations()` call.
- **Files created:** `apps/api/src/run-migrations.ts`
- **Verification:** Script compiles alongside the rest of the API; migration invocation in workflow references `node dist/run-migrations.js`
- **Committed in:** f809825 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 missing critical)
**Impact on plan:** Essential for migrations to work in Docker containers. Plan explicitly allowed choosing between CLI and programmatic approach.

## Issues Encountered

- Docker daemon not available on build machine, so Docker build for TEE worker Dockerfile could not be tested locally. Structure verified by inspecting FROM count (2 stages) and syntax review.

## User Setup Required

The following GitHub Secrets must be configured before the workflow will succeed:

| Secret                       | Purpose               |
| ---------------------------- | --------------------- |
| STAGING_HOST                 | VPS IP or hostname    |
| STAGING_USER                 | SSH username          |
| STAGING_SSH_KEY              | SSH private key       |
| STAGING_DB_USERNAME          | PostgreSQL username   |
| STAGING_DB_PASSWORD          | PostgreSQL password   |
| STAGING_JWT_SECRET           | JWT signing secret    |
| STAGING_TEE_WORKER_SECRET    | API-TEE shared secret |
| VITE_WEB3AUTH_CLIENT_ID      | Web3Auth client ID    |
| PINATA_JWT                   | Pinata API JWT        |
| CLOUDFLARE_API_TOKEN         | Cloudflare API token  |
| CLOUDFLARE_ZONE_ID           | Cloudflare zone ID    |
| CLOUDFLARE_DNSLINK_RECORD_ID | DNSLink TXT record ID |

## Next Phase Readiness

- Deployment workflow ready to execute on first v*-staging* tag push
- TEE worker Dockerfile ready for CI builds
- Migration runner ready for fresh database initialization
- Requires GitHub Secrets configuration before first deployment
- Docker build verification pending (Docker daemon needed)

---

_Phase: 09.1-env-devops-staging_
_Completed: 2026-02-09_
