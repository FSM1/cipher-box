---
phase: 09.1-env-devops-staging
plan: 06
subsystem: infra
tags: [grafana-alloy, loki, log-aggregation, docker-compose, monitoring, betterstack]

# Dependency graph
requires:
  - phase: 09.1-env-devops-staging
    provides: Staging Docker Compose with 6 services (Plan 02)
provides:
  - Grafana Alloy log shipping agent configuration for Docker container logs
  - Centralized log aggregation to Grafana Cloud Loki
  - Log rotation (json-file, 10m x 3) on all staging services
  - Monitoring setup documentation with LogQL query examples
affects: []

# Tech tracking
tech-stack:
  added: [grafana/alloy:latest]
  patterns: [docker-socket-log-discovery, loki-log-shipping, json-file-log-rotation]

key-files:
  created:
    - docker/alloy-config.river
    - docker/MONITORING.md
  modified:
    - docker/docker-compose.staging.yml

key-decisions:
  - 'Alloy reads credentials from environment variables (not hardcoded) for GitHub Secrets compatibility'
  - 'Docker socket mounted read-only -- Alloy only reads container metadata and logs'
  - 'x-logging YAML anchor for DRY log rotation config across all 7 services'
  - 'json-file driver with 10m max-size and 3 files prevents unbounded disk growth'

patterns-established:
  - 'YAML anchors (x-logging) for shared Docker Compose configuration across services'
  - 'Environment variable injection for Grafana Cloud credentials via .env.staging'

# Metrics
duration: 2min
completed: 2026-02-09
---

# Phase 9.1 Plan 06: Log Aggregation Summary

Grafana Alloy agent shipping all Docker container logs to Grafana Cloud Loki with per-service labels and json-file log rotation.

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-09T01:18:51Z
- **Completed:** 2026-02-09T01:21:11Z
- **Tasks:** 2/2
- **Files created:** 2
- **Files modified:** 1

## Accomplishments

- Grafana Alloy configuration discovering Docker containers via socket and shipping logs to Grafana Cloud Loki with service/container/project labels
- Log rotation (json-file driver, 10m max-size, 3 files) applied to all 7 staging Docker Compose services via YAML anchor
- Monitoring documentation with Grafana Cloud Free setup, Better Stack Uptime, LogQL query examples, dashboard suggestions, and troubleshooting guide

## Task Commits

Each task was committed atomically:

1. **Task 1: Create Grafana Alloy config and add to Docker Compose** - `2b3e1da` (feat)
2. **Task 2: Document monitoring setup instructions** - `e5a5998` (docs)

## Files Created/Modified

- `docker/alloy-config.river` - Grafana Alloy River config: Docker container discovery, relabeling for service/container/project labels, Loki write endpoint with basic auth
- `docker/MONITORING.md` - Setup guide for Grafana Cloud Free and Better Stack Uptime, LogQL query reference, dashboard suggestions, troubleshooting steps
- `docker/docker-compose.staging.yml` - Added x-logging anchor with json-file rotation, logging applied to all 7 services, new Alloy service with Docker socket mount and Grafana Cloud credentials

## Decisions Made

- **Alloy credentials via environment variables:** `GRAFANA_LOKI_URL`, `GRAFANA_LOKI_USERNAME`, `GRAFANA_LOKI_API_KEY` injected from `.env.staging`, matching the GitHub Secrets pattern used by the deploy workflow
- **Docker socket read-only mount:** `:ro` flag since Alloy only reads container metadata and logs, never manages containers
- **YAML anchor for log rotation:** `x-logging: &default-logging` with `logging: *default-logging` on each service avoids repetition and ensures consistency
- **json-file driver with 10m/3 rotation:** Prevents unbounded disk growth while retaining enough history for Alloy to scrape

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- Markdown linter required `text` language specifier on the architecture diagram fenced code block in MONITORING.md -- fixed inline before commit.

## User Setup Required

Before deploying, the following GitHub Secrets must be configured:

| Secret                  | Purpose                           |
| ----------------------- | --------------------------------- |
| `GRAFANA_LOKI_URL`      | Loki push endpoint URL            |
| `GRAFANA_LOKI_USERNAME` | Grafana Cloud numeric instance ID |
| `GRAFANA_LOKI_API_KEY`  | API key with LogsPublisher role   |

See `docker/MONITORING.md` for step-by-step Grafana Cloud setup instructions.

## Next Phase Readiness

- All 6 plans in Phase 9.1 are now complete
- Alloy service will be deployed on next staging tag push
- Better Stack Uptime monitor can be configured after staging VPS is live
- Phase 9.1 can be closed and merged to main

---

_Phase: 09.1-env-devops-staging_
_Completed: 2026-02-09_
