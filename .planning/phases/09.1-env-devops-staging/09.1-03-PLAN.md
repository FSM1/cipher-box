---
phase: 09.1-env-devops-staging
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/migrations/InitialSchema.ts
  - apps/api/src/data-source.ts
autonomous: true

must_haves:
  truths:
    - 'A full schema migration exists that creates all tables from scratch'
    - 'Running migrations on a fresh database creates all entities'
    - 'data-source.ts includes the migrations directory for TypeORM CLI'
  artifacts:
    - path: 'apps/api/src/migrations/'
      provides: 'Full schema migration file'
      contains: 'CREATE TABLE'
    - path: 'apps/api/src/data-source.ts'
      provides: 'DataSource config with migrations path'
      contains: 'migrations'
  key_links:
    - from: 'apps/api/src/data-source.ts'
      to: 'apps/api/src/migrations/'
      via: 'migrations array or glob'
      pattern: 'migrations'
---

<objective>
Generate a full schema migration so a fresh staging database can be initialized without synchronize: true.

Purpose: In staging/production, TypeORM synchronize is disabled (NODE_ENV=production). Without a migration that creates the full schema, the API will crash on first request because no tables exist. The existing 2 migration files are incremental patches, not a full schema baseline.

Output: A migration file that creates all CipherBox database tables from scratch.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.1-env-devops-staging/09.1-RESEARCH.md
@apps/api/src/app.module.ts
@apps/api/src/data-source.ts
@apps/api/src/auth/entities/user.entity.ts
@apps/api/src/auth/entities/refresh-token.entity.ts
@apps/api/src/auth/entities/auth-method.entity.ts
@apps/api/src/vault/entities/vault.entity.ts
@apps/api/src/vault/entities/pinned-cid.entity.ts
@apps/api/src/ipns/entities/folder-ipns.entity.ts
@apps/api/src/tee/tee-key-state.entity.ts
@apps/api/src/tee/tee-key-rotation-log.entity.ts
@apps/api/src/republish/republish-schedule.entity.ts
</context>

<tasks>

<task type="auto">
<name>Task 1: Generate full schema migration</name>
<files>
apps/api/src/migrations/InitialSchema.ts
apps/api/src/data-source.ts
</files>
<action>

The approach is to generate a migration that captures the current complete schema state. This way a fresh staging database gets all tables created in one migration run.

**Step 1:** Read `apps/api/src/data-source.ts` to understand current migration config.

**Step 2:** Ensure `data-source.ts` includes a migrations glob or array that covers `src/migrations/*.ts`. If it only references specific files, update it to use a glob pattern like `[__dirname + '/migrations/*{.ts,.js}']`.

**Step 3:** Attempt to generate the migration using TypeORM CLI:

```bash
cd apps/api
pnpm typeorm migration:generate src/migrations/FullSchema -d src/data-source.ts
```

If this fails (e.g., database not available), write the migration manually based on all entity definitions.

**Step 4 (manual migration if generate fails):** Create a migration file at `apps/api/src/migrations/<timestamp>-FullSchema.ts` that creates all tables: `user`, `refresh_token`, `auth_method`, `vault`, `pinned_cid`, `folder_ipns`, `tee_key_state`, `tee_key_rotation_log`, `ipns_republish_schedule`. Include all columns, types, constraints, indexes, and foreign keys. Read each entity file carefully to derive the exact column definitions. Include a `down()` method that drops all tables in reverse dependency order.

**Step 5 (handle existing incremental migrations):** The 2 existing migrations (MakeFolderIpnsTeeFieldsNullable, AddTokenPrefix) are incremental patches. For a FRESH database (staging), only the full schema migration is needed because it already includes the final column states. For an EXISTING database (local dev), the incremental migrations have already been applied. Use a timestamp like `1700000000000` (earlier than existing `1737520000000`) so it runs first. Then the incremental ones become no-ops (columns already match).

**Step 6:** Verify the migration can be compiled by running `pnpm --filter @cipherbox/api build`.

</action>
<verify>

1. Migration file exists in `apps/api/src/migrations/` with full schema
2. `pnpm --filter @cipherbox/api build` succeeds (migration compiles)
3. `data-source.ts` includes migrations directory
4. Migration covers all 9 entity tables (user, refresh_token, auth_method, vault, pinned_cid, folder_ipns, tee_key_state, tee_key_rotation_log, ipns_republish_schedule)

</verify>
<done>
Full schema migration exists and compiles. A fresh staging database can be initialized by running migration:run. data-source.ts is configured to discover migration files.
</done>
</task>

</tasks>

<verification>

- Migration file exists with CREATE TABLE statements for all 9 entity tables
- `pnpm --filter @cipherbox/api build` passes
- data-source.ts migrations config includes the migrations directory

</verification>

<success_criteria>
A single migration file creates the complete CipherBox schema from scratch. Running migration:run on a fresh Postgres database produces all required tables with correct columns, types, and constraints.
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-env-devops-staging/09.1-03-SUMMARY.md`
</output>
