# Phase 9.1: Environment Changes, DevOps & Staging Deployment - Context

**Gathered:** 2026-02-09
**Status:** Ready for planning

## Phase Boundary

Production-ready environment configuration, CI/CD pipeline updates, and deployment to staging. This phase makes CipherBox deployable beyond localhost — environment isolation, automated builds, and a working staging environment on a real server. Desktop app CI/deployment is out of scope.

## Implementation Decisions

### Hosting & deployment target

- Single VPS at Hostinger for staging
- All services on VPS in Docker Compose: API, Postgres, Redis, Kubo (online mode)
- TEE worker runs as a regular Docker container on VPS (not Phala Cloud testnet — switch to real TEE later before production)
- Web app hosted on IPFS as static build, pinned to Pinata
- Cloudflare handles SSL for both web app and API
- User has a domain registered with Cloudflare — will point subdomains to VPS/IPFS
- API traffic routes through Cloudflare to Docker on the VPS
- Staging data is disposable — no backups needed

### CI/CD pipeline scope

- Tag-based releases trigger deployment (e.g., `v1.0.0-staging.1`)
- CI builds and deploys: web app, API, and TEE worker
- Desktop app builds are NOT in scope for this phase
- Web app: CI builds static site, pins to Pinata (free tier first, fall back to VPS Kubo gateway if costs become an issue)
- API: CI builds Docker image, pushes to GHCR, SSHs into VPS to pull and restart via Docker Compose
- TEE worker: Built and deployed as Docker container alongside API on VPS

### Environment isolation approach

- Environment-specific HKDF salt for IPNS key derivation (per ENVIRONMENTS.md design)
- Same Web3Auth identity across environments, different IPNS namespaces per env
- `CIPHERBOX_ENVIRONMENT` env var: local | ci | staging | production
- Staging uses Kubo (online mode) for IPFS — publishes to real DHT
- Staging uses real delegated-ipfs.dev for IPNS routing
- Defer production Web3Auth (Sapphire Mainnet) setup to later — staging stays on Sapphire Devnet

### Secret management & config

- All secrets stored in GitHub Secrets (single source of truth)
- CI generates .env file from GitHub Secrets and SCPs it to VPS during deployment
- Container images stored in GHCR (GitHub Container Registry)
- Environment-specific Docker Compose files (docker-compose.staging.yml, etc.) — not a single file with variable substitution
- Consistent with existing approach where Docker Compose is used in multiple contexts (E2E tests, local dev, staging)

### Claude's Discretion

- Exact Cloudflare configuration (DNS records, proxy settings, SSL mode)
- Docker Compose service ordering and health checks
- GHCR image tagging strategy (git sha, tag, latest)
- GitHub Actions workflow structure and job organization
- VPS provisioning scripts and Docker installation
- Caddy/Nginx choice for reverse proxy on VPS (if needed alongside Cloudflare)
- Pinata web hosting CID update automation (DNSLink or gateway URL)

## Specific Ideas

- Web app IPFS hosting with Cloudflare SSL — user wants IPFS-native hosting for the frontend, not a traditional web server
- Pinata free tier first for web hosting, evaluate costs before committing — fall back to VPS Kubo gateway if needed
- TEE worker on VPS as regular container is a temporary staging measure — will test Phala Cloud testnet switch before production release
- Reference ENVIRONMENTS.md extensively — it has detailed env var matrices, Docker Compose templates, and the HKDF environment salt design already specified

## Deferred Ideas

- Production Web3Auth project on Sapphire Mainnet — set up when ready to go live
- Desktop app CI/CD (Tauri builds) — separate phase or added later
- Production monitoring stack (Prometheus, Grafana, alerting) — production readiness phase
- Staging cleanup job for orphaned IPNS records — nice to have, not blocking

---

_Phase: 09.1-env-devops-staging_
_Context gathered: 2026-02-09_
