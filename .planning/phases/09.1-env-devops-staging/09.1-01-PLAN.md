---
phase: 09.1-env-devops-staging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/main.ts
  - apps/web/src/routes/index.tsx
  - apps/web/src/lib/web3auth/config.ts
  - tee-worker/src/services/tee-keys.ts
autonomous: true

must_haves:
  truths:
    - 'API listens on PORT env var (default 3000) for container flexibility'
    - 'TEE worker allows simulator mode in staging (CIPHERBOX_ENVIRONMENT != production)'
    - 'Web app uses hash-based routing so IPFS gateway serves all routes correctly'
    - 'Web3Auth network switches between devnet and mainnet based on VITE_ENVIRONMENT'
  artifacts:
    - path: 'apps/api/src/main.ts'
      provides: 'Configurable port via process.env.PORT'
      contains: 'process.env.PORT'
    - path: 'tee-worker/src/services/tee-keys.ts'
      provides: 'Relaxed simulator guard checking CIPHERBOX_ENVIRONMENT'
      contains: 'CIPHERBOX_ENVIRONMENT'
    - path: 'apps/web/src/routes/index.tsx'
      provides: 'Hash-based routing for IPFS compatibility'
      contains: 'HashRouter'
    - path: 'apps/web/src/lib/web3auth/config.ts'
      provides: 'Environment-aware Web3Auth network selection'
      contains: 'VITE_ENVIRONMENT'
  key_links:
    - from: 'tee-worker/src/services/tee-keys.ts'
      to: 'CIPHERBOX_ENVIRONMENT env var'
      via: 'process.env check'
      pattern: 'CIPHERBOX_ENVIRONMENT.*production'
    - from: 'apps/web/src/lib/web3auth/config.ts'
      to: 'VITE_ENVIRONMENT env var'
      via: 'import.meta.env'
      pattern: 'VITE_ENVIRONMENT'
---

<objective>
Prepare the codebase for staging/production deployment by fixing hardcoded values and adding environment-aware configuration.

Purpose: Without these changes, the API cannot run in a container (hardcoded port), the TEE worker crashes in staging (blocks simulator when NODE_ENV=production), the web app 404s on refresh when hosted on IPFS (browser history routing), and Web3Auth is locked to devnet.

Output: Four source files modified to support environment-aware deployment.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.1-env-devops-staging/09.1-CONTEXT.md
@.planning/phases/09.1-env-devops-staging/09.1-RESEARCH.md
@apps/api/src/main.ts
@tee-worker/src/services/tee-keys.ts
@apps/web/src/routes/index.tsx
@apps/web/src/lib/web3auth/config.ts
</context>

<tasks>

<task type="auto">
<name>Task 1: Fix API port, TEE guard, and hash routing</name>
<files>
apps/api/src/main.ts
tee-worker/src/services/tee-keys.ts
apps/web/src/routes/index.tsx
apps/web/src/lib/web3auth/config.ts
</files>
<action>

**1. Make API port configurable (`apps/api/src/main.ts`):**
Change line 39 from `await app.listen(3000)` to `const port = process.env.PORT || 3000; await app.listen(port);`
Update the console.log to use the `port` variable.

**2. Relax TEE simulator guard (`tee-worker/src/services/tee-keys.ts`):**
Change the guard at lines 30-33 from checking `process.env.NODE_ENV === 'production'` to checking `process.env.CIPHERBOX_ENVIRONMENT === 'production'`. This allows `NODE_ENV=production` (needed for TypeORM synchronize=false) alongside `TEE_MODE=simulator` (needed because staging has no CVM). Update the error message to reference CIPHERBOX_ENVIRONMENT instead.

**3. Switch to hash-based routing (`apps/web/src/routes/index.tsx`):**
Replace `BrowserRouter` with `HashRouter` from `react-router-dom`. This is needed because IPFS gateways serve files literally by path -- navigating to `app.cipherbox.io/files/abc` would 404 since there is no server-side routing. With HashRouter, all routes become `app.cipherbox.io/#/files/abc` which always loads index.html. Change the import and the JSX element.

**4. Add environment-aware Web3Auth network (`apps/web/src/lib/web3auth/config.ts`):**
Add a NETWORK_CONFIG map that selects SAPPHIRE_DEVNET for local/ci/staging and SAPPHIRE_MAINNET for production. Use `import.meta.env.VITE_ENVIRONMENT` to select the network. Default to 'local' if VITE_ENVIRONMENT is not set. Replace the hardcoded `WEB3AUTH_NETWORK.SAPPHIRE_DEVNET` with the lookup.

```typescript
const NETWORK_CONFIG: Record<string, (typeof WEB3AUTH_NETWORK)[keyof typeof WEB3AUTH_NETWORK]> = {
  local: WEB3AUTH_NETWORK.SAPPHIRE_DEVNET,
  ci: WEB3AUTH_NETWORK.SAPPHIRE_DEVNET,
  staging: WEB3AUTH_NETWORK.SAPPHIRE_DEVNET,
  production: WEB3AUTH_NETWORK.SAPPHIRE_MAINNET,
};
```

</action>
<verify>

1. `grep -n 'process.env.PORT' apps/api/src/main.ts` shows configurable port
2. `grep -n 'CIPHERBOX_ENVIRONMENT' tee-worker/src/services/tee-keys.ts` shows updated guard
3. `grep -n 'HashRouter' apps/web/src/routes/index.tsx` shows hash routing
4. `grep -n 'VITE_ENVIRONMENT' apps/web/src/lib/web3auth/config.ts` shows env-aware network
5. `pnpm --filter @cipherbox/api build` succeeds
6. `pnpm --filter @cipherbox/web build` succeeds (with default env vars)

</verify>
<done>
API reads PORT from env. TEE worker allows simulator in staging. Web app uses HashRouter. Web3Auth selects network from VITE_ENVIRONMENT. All packages build successfully.
</done>
</task>

</tasks>

<verification>

- `grep 'process.env.PORT' apps/api/src/main.ts` returns match
- `grep 'CIPHERBOX_ENVIRONMENT' tee-worker/src/services/tee-keys.ts` returns match
- `grep 'HashRouter' apps/web/src/routes/index.tsx` returns match
- `grep 'VITE_ENVIRONMENT' apps/web/src/lib/web3auth/config.ts` returns match
- All 3 packages build without errors

</verification>

<success_criteria>
All four code changes are in place. API port is configurable. TEE simulator guard checks CIPHERBOX_ENVIRONMENT (not NODE_ENV). Web app uses hash routing for IPFS compatibility. Web3Auth network selection is environment-aware.
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-env-devops-staging/09.1-01-SUMMARY.md`
</output>
