---
phase: 09.1-env-devops-staging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/main.ts
  - apps/api/src/app.module.ts
  - apps/web/src/routes/index.tsx
  - apps/web/src/lib/web3auth/config.ts
  - tee-worker/src/services/tee-keys.ts
autonomous: true

must_haves:
  truths:
    - 'API listens on PORT env var (default 3000) for container flexibility'
    - 'TEE worker allows simulator mode in staging (CIPHERBOX_ENVIRONMENT != production)'
    - 'Web app uses hash-based routing so IPFS gateway serves all routes correctly'
    - 'Web3Auth network switches between devnet and mainnet based on VITE_ENVIRONMENT'
    - 'TypeORM logging reduced to errors+warnings in dev, errors-only in staging/production'
    - 'API uses NestJS Logger (not console.log) with JSON format in staging/production'
  artifacts:
    - path: 'apps/api/src/main.ts'
      provides: 'Configurable port via process.env.PORT'
      contains: 'process.env.PORT'
    - path: 'tee-worker/src/services/tee-keys.ts'
      provides: 'Relaxed simulator guard checking CIPHERBOX_ENVIRONMENT'
      contains: 'CIPHERBOX_ENVIRONMENT'
    - path: 'apps/web/src/routes/index.tsx'
      provides: 'Hash-based routing for IPFS compatibility'
      contains: 'HashRouter'
    - path: 'apps/web/src/lib/web3auth/config.ts'
      provides: 'Environment-aware Web3Auth network selection'
      contains: 'VITE_ENVIRONMENT'
  key_links:
    - from: 'tee-worker/src/services/tee-keys.ts'
      to: 'CIPHERBOX_ENVIRONMENT env var'
      via: 'process.env check'
      pattern: 'CIPHERBOX_ENVIRONMENT.*production'
    - from: 'apps/web/src/lib/web3auth/config.ts'
      to: 'VITE_ENVIRONMENT env var'
      via: 'import.meta.env'
      pattern: 'VITE_ENVIRONMENT'
---

<objective>
Prepare the codebase for staging/production deployment by fixing hardcoded values and adding environment-aware configuration.

Purpose: Without these changes, the API cannot run in a container (hardcoded port), the TEE worker crashes in staging (blocks simulator when NODE_ENV=production), the web app 404s on refresh when hosted on IPFS (browser history routing), Web3Auth is locked to devnet, and API logs are too noisy (constant SQL query logging in dev, no structured logging for staging).

Also remove the dead `VITE_PINATA_GATEWAY_URL` env var from `apps/web/.env` — it is never referenced in the codebase.

Output: Five source files modified to support environment-aware deployment, logging cleanup, and dead env var removal.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.1-env-devops-staging/09.1-CONTEXT.md
@.planning/phases/09.1-env-devops-staging/09.1-RESEARCH.md
@apps/api/src/main.ts
@apps/api/src/app.module.ts
@tee-worker/src/services/tee-keys.ts
@apps/web/src/routes/index.tsx
@apps/web/src/lib/web3auth/config.ts
</context>

<tasks>

<task type="auto">
<name>Task 1: Fix API port, TEE guard, hash routing, and logging</name>
<files>
apps/api/src/main.ts
apps/api/src/app.module.ts
tee-worker/src/services/tee-keys.ts
apps/web/src/routes/index.tsx
apps/web/src/lib/web3auth/config.ts
</files>
<action>

**1. Make API port configurable and fix logging (`apps/api/src/main.ts`):**
Change line 39 from `await app.listen(3000)` to `const port = process.env.PORT || 3000; await app.listen(port);`

Replace `console.log` statements with NestJS `Logger`. Import `Logger` from `@nestjs/common`, create `const logger = new Logger('Bootstrap')`, and use `logger.log()` instead of `console.log()`.

For staging/production, use structured JSON logging. In `NestFactory.create()`, pass a `logger` option:

- If `NODE_ENV !== 'development'`: use `NestFactory.create(AppModule, { logger: ['error', 'warn', 'log'] })` — omit `debug` and `verbose` to keep logs concise.
- For JSON format in staging/production, install `nestjs-pino` and `pino-pretty` (dev dependency). Configure `LoggerModule.forRoot()` in AppModule with JSON transport in production, pretty-print in dev. This gives structured JSON logs that Grafana Loki can parse natively.

If adding a dependency feels too heavy for this plan, a simpler alternative: just set the NestJS log levels appropriately and skip JSON for now — the Grafana Alloy agent can still ingest plain text logs.

**2. Relax TEE simulator guard (`tee-worker/src/services/tee-keys.ts`):**
Change the guard at lines 30-33 from checking `process.env.NODE_ENV === 'production'` to checking `process.env.CIPHERBOX_ENVIRONMENT === 'production'`. This allows `NODE_ENV=production` (needed for TypeORM synchronize=false) alongside `TEE_MODE=simulator` (needed because staging has no CVM). Update the error message to reference CIPHERBOX_ENVIRONMENT instead.

**3. Switch to hash-based routing (`apps/web/src/routes/index.tsx`):**
Replace `BrowserRouter` with `HashRouter` from `react-router-dom`. This is needed because IPFS gateways serve files literally by path -- navigating to `app.staging.cipherbox.cc/files/abc` would 404 since there is no server-side routing. With HashRouter, all routes become `app.staging.cipherbox.cc/#/files/abc` which always loads index.html. Change the import and the JSX element.

**4. Add environment-aware Web3Auth network (`apps/web/src/lib/web3auth/config.ts`):**
Add a NETWORK_CONFIG map that selects SAPPHIRE_DEVNET for local/ci/staging and SAPPHIRE_MAINNET for production. Use `import.meta.env.VITE_ENVIRONMENT` to select the network. Default to 'local' if VITE_ENVIRONMENT is not set. Replace the hardcoded `WEB3AUTH_NETWORK.SAPPHIRE_DEVNET` with the lookup.

```typescript
const NETWORK_CONFIG: Record<string, (typeof WEB3AUTH_NETWORK)[keyof typeof WEB3AUTH_NETWORK]> = {
  local: WEB3AUTH_NETWORK.SAPPHIRE_DEVNET,
  ci: WEB3AUTH_NETWORK.SAPPHIRE_DEVNET,
  staging: WEB3AUTH_NETWORK.SAPPHIRE_DEVNET,
  production: WEB3AUTH_NETWORK.SAPPHIRE_MAINNET,
};
```

**5. Remove dead `VITE_PINATA_GATEWAY_URL` env var (`apps/web/.env`):**
Delete the `VITE_PINATA_GATEWAY_URL` line — it is never referenced anywhere in the codebase (the browser fetches files through the API backend, not directly from an IPFS gateway).

**6. Fix TypeORM logging (`apps/api/src/app.module.ts`):**
Change line 74 from `logging: configService.get<string>('NODE_ENV') === 'development'` to environment-appropriate logging:

```typescript
logging: configService.get<string>('NODE_ENV') === 'development'
  ? ['error', 'warn', 'migration']  // Dev: errors, warnings, migrations only (no SQL query spam)
  : ['error', 'migration'],          // Staging/production: errors and migrations only
```

This stops the constant SQL query logging that makes dev logs unreadable, while still capturing errors and migration activity everywhere.

</action>
<verify>

1. `grep -n 'process.env.PORT' apps/api/src/main.ts` shows configurable port
2. `grep -n 'CIPHERBOX_ENVIRONMENT' tee-worker/src/services/tee-keys.ts` shows updated guard
3. `grep -n 'HashRouter' apps/web/src/routes/index.tsx` shows hash routing
4. `grep -n 'VITE_ENVIRONMENT' apps/web/src/lib/web3auth/config.ts` shows env-aware network
5. `grep -n "Logger" apps/api/src/main.ts` shows NestJS Logger (not console.log)
6. `grep -n "error.*warn.*migration" apps/api/src/app.module.ts` shows TypeORM logging config
7. `pnpm --filter @cipherbox/api build` succeeds
8. `pnpm --filter @cipherbox/web build` succeeds (with default env vars)

</verify>
<done>
API reads PORT from env. TEE worker allows simulator in staging. Web app uses HashRouter. Web3Auth selects network from VITE_ENVIRONMENT. TypeORM logging reduced (no SQL spam). API uses NestJS Logger with structured output. All packages build successfully.
</done>
</task>

</tasks>

<verification>

- `grep 'process.env.PORT' apps/api/src/main.ts` returns match
- `grep 'CIPHERBOX_ENVIRONMENT' tee-worker/src/services/tee-keys.ts` returns match
- `grep 'HashRouter' apps/web/src/routes/index.tsx` returns match
- `grep 'VITE_ENVIRONMENT' apps/web/src/lib/web3auth/config.ts` returns match
- `grep 'Logger' apps/api/src/main.ts` returns match (NestJS Logger, not console.log)
- TypeORM logging in app.module.ts uses array format (not boolean `true`)
- All 3 packages build without errors

</verification>

<success_criteria>
All six code changes are in place. API port is configurable. TEE simulator guard checks CIPHERBOX_ENVIRONMENT (not NODE_ENV). Web app uses hash routing for IPFS compatibility. Web3Auth network selection is environment-aware. TypeORM logging is reduced (no SQL query spam). API uses NestJS Logger with appropriate log levels.
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-env-devops-staging/09.1-01-SUMMARY.md`
</output>
