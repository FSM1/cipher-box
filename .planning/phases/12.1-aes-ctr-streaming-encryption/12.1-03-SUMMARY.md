---
phase: 12.1-aes-ctr-streaming-encryption
plan: 03
subsystem: crypto
tags: [service-worker, aes-ctr, streaming, media-playback, decrypt-proxy, vite]

# Dependency graph
requires:
  - phase: 12.1-aes-ctr-streaming-encryption
    provides: AES-CTR crypto primitives (plan 01)
provides:
  - Service Worker that intercepts /decrypt-stream/* and decrypts AES-CTR content
  - SW registration and lifecycle helpers (registerDecryptSW, sendToSW, etc.)
  - SW build pipeline (Vite lib-mode post-build step)
  - Auth token sync between main thread and SW
affects: [12.1-04-media-playback, 12.1-05-integration]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'Service Worker transparent decrypt proxy for media elements'
    - 'perEnvironmentPlugin not needed -- Vite 7 Rollup hooks unreliable, post-build script pattern instead'
    - 'Separate tsconfig.sw.json for WebWorker lib types (SW excluded from main tsconfig)'
    - 'TS 5.9 Uint8Array<ArrayBufferLike> requires explicit casts for BufferSource and Response body'

key-files:
  created:
    - apps/web/src/workers/decrypt-sw.ts
    - apps/web/src/lib/sw-registration.ts
    - apps/web/scripts/build-sw.mjs
    - apps/web/tsconfig.sw.json
  modified:
    - apps/web/tsconfig.json
    - apps/web/src/main.tsx
    - apps/web/package.json

key-decisions:
  - 'Post-build script for SW compilation instead of Vite plugin (Vite 7 Rollup hook regression)'
  - 'Vite dev serves TS directly at /src/workers/decrypt-sw.ts, production uses compiled /decrypt-sw.js'
  - 'Separate tsconfig.sw.json with WebWorker lib for ServiceWorkerGlobalScope types'

patterns-established:
  - 'SW build: Vite lib-mode IIFE via scripts/build-sw.mjs as package.json postbuild step'
  - 'SW type-checking: tsconfig.sw.json + exclude from main tsconfig.json'
  - 'SW communication: postMessage for register-stream, update-token, set-api-base, unregister-stream'
  - 'Auth token sync: Zustand subscribe in main.tsx forwards token changes to SW'

# Metrics
duration: 12min
completed: 2026-02-17
---

# Phase 12.1 Plan 03: Service Worker Decrypt Proxy Summary

**Service Worker transparent decrypt proxy intercepting /decrypt-stream/\* URLs with AES-CTR range decryption, Vite lib-mode build pipeline, and main thread auth/API sync**

## Performance

- **Duration:** 12 min
- **Started:** 2026-02-17T13:26:37Z
- **Completed:** 2026-02-17T13:38:36Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments

- Service Worker that intercepts /decrypt-stream/\* fetch requests, fetches encrypted content from API, decrypts arbitrary byte ranges with AES-CTR counter math, and returns proper 200/206 responses with Content-Range headers
- SW registration helpers with lifecycle management (registerDecryptSW, waitForSW, isSwActive) and communication functions (registerStream, unregisterStream, updateSwToken, setSwApiBase)
- Post-build pipeline compiling the SW TypeScript to a minified 2.8KB IIFE at dist/decrypt-sw.js using Vite lib-mode
- Auth token sync from Zustand auth store to SW via subscribe + postMessage

## Task Commits

Each task was committed atomically:

1. **Task 1: Service Worker for decrypt proxy** - `41a282d72` (feat)
2. **Task 2: SW registration, build pipeline, and app bootstrap** - `d143e4b48` (feat)

## Files Created/Modified

- `apps/web/src/workers/decrypt-sw.ts` - Service Worker: fetch interception, encrypted content caching, AES-CTR range decryption, 200/206 response construction
- `apps/web/src/lib/sw-registration.ts` - SW lifecycle: register, wait, check active, send messages, token sync, stream register/unregister
- `apps/web/scripts/build-sw.mjs` - Post-build script: Vite lib-mode IIFE compilation of SW TypeScript
- `apps/web/tsconfig.sw.json` - Separate TypeScript config for SW with WebWorker lib
- `apps/web/tsconfig.json` - Excluded decrypt-sw.ts from main config (different global scope)
- `apps/web/src/main.tsx` - Added SW registration on startup, API base URL config, auth token sync via Zustand subscribe
- `apps/web/package.json` - Added build-sw.mjs to build script chain

## Decisions Made

- **Post-build script instead of Vite plugin:** Vite 7's Environment API changed how Rollup output hooks (generateBundle, writeBundle, closeBundle) fire -- they no longer execute in top-level or perEnvironmentPlugin contexts for the default build. A dedicated post-build script using Vite's build() API in lib mode is simpler and more reliable.
- **Dev mode serves TS directly:** In development, the SW is registered at `/src/workers/decrypt-sw.ts` which Vite's dev server transforms on-the-fly. In production, `/decrypt-sw.js` is the compiled IIFE output.
- **Separate tsconfig.sw.json:** The SW runs in ServiceWorkerGlobalScope (not Window). WebWorker lib provides the correct types. The file is excluded from the main tsconfig to avoid type conflicts.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Vite 7 Environment API breaks Rollup plugin hooks**

- **Found during:** Task 2 (Vite config update)
- **Issue:** Plan specified adding SW as a Rollup input or using a Vite plugin for SW compilation. In Vite 7, Rollup output hooks (generateBundle, writeBundle, closeBundle) no longer fire in standard plugin context due to the Environment API refactor. Multiple approaches attempted: rollupOptions.input, custom plugin with generateBundle/writeBundle/closeBundle, perEnvironmentPlugin wrapper.
- **Fix:** Created a standalone post-build script (scripts/build-sw.mjs) that uses Vite's build() API in lib mode to compile the SW separately. Added to package.json build script chain.
- **Files modified:** apps/web/scripts/build-sw.mjs (new), apps/web/package.json, apps/web/vite.config.ts (kept clean)
- **Verification:** `vite build && node scripts/build-sw.mjs` produces dist/decrypt-sw.js (2.8KB minified)
- **Committed in:** d143e4b48 (Task 2 commit)

**2. [Rule 3 - Blocking] TS 5.9 Uint8Array<ArrayBufferLike> type strictness**

- **Found during:** Task 1 (SW type-checking)
- **Issue:** TypeScript 5.9 made Uint8Array generic over ArrayBufferLike, breaking compatibility with BufferSource parameters in crypto.subtle and Response body. Direct Uint8Array instances no longer satisfy BufferSource or BodyInit types.
- **Fix:** Added explicit `as BufferSource` casts for crypto.subtle parameters and `(buffer as ArrayBuffer).slice()` for Response body construction.
- **Files modified:** apps/web/src/workers/decrypt-sw.ts
- **Verification:** `tsc --project tsconfig.sw.json --noEmit` passes cleanly
- **Committed in:** 41a282d72 (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (2 blocking)
**Impact on plan:** Both fixes necessary for the SW to compile and build. No scope creep -- same deliverables, different build mechanism.

## Issues Encountered

None beyond the deviations documented above.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Service Worker is ready to intercept decrypt-stream URLs for media playback
- Plan 04 (media playback hooks) can use registerStream/unregisterStream to set video/audio src to /decrypt-stream/{ipnsName}
- SW falls back gracefully: returns 404 for unregistered streams, 502 for network errors, 401 triggers token refresh
- Dev mode works without pre-compilation (Vite serves TS directly)

---

_Phase: 12.1-aes-ctr-streaming-encryption_
_Completed: 2026-02-17_
