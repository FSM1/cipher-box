# Phase 12.1: AES-CTR Streaming Encryption - Context

**Gathered:** 2026-02-17
**Status:** Ready for planning

## Phase Boundary

Media files (video/audio) are encrypted with AES-256-CTR instead of GCM, enabling byte-range decryption for in-browser streaming playback. All other files continue using AES-256-GCM. Upload pipeline streams CTR encryption without loading entire files into memory. Desktop FUSE CTR support is deferred to a separate gap-closing phase.

## Implementation Decisions

### Playback Experience

- Service Worker intercepts fetch requests from `<video>`/`<audio>` elements, decrypts on-the-fly — transparent to the media element
- Custom player UI with decrypt progress bar, buffering state, and CipherBox branding (not native browser controls)
- Common formats only: MP4, WebM, MP3, AAC, OGG — skip exotic formats browsers can't play natively
- Claude's discretion: seeking behavior (instant byte-range vs progressive) — depends on IPFS byte-range capability research

### CTR Mode Detection and Chunking

- MIME type + file size combo determines CTR vs GCM: media files above a minimum size threshold get CTR, small audio clips/thumbnails stay GCM
- No migration needed — deploying with full database wipe (clean slate)
- Claude's discretion: optimal chunk size for byte-range decryption (balancing seek granularity vs overhead)
- Claude's discretion: nonce management strategy (per-file nonce + counter offset vs per-chunk nonces) — based on security analysis and random-access compatibility

### Upload Pipeline

- True streaming encryption: encrypt chunks as the file is read, upload each as it's ready — bounded memory usage
- Combined progress bar: single progress indicator reflecting overall completion (no encrypt/upload split)
- Unified pipeline for batch uploads: CTR vs GCM selected per-file internally, user sees no difference (preserves Phase 7.1 atomicity)
- Current hard limit of 100MB per file applies; make this obvious to user in upload UI. Longer term with BYO-IPFS, no size limit

### Claude's Discretion

- Seeking strategy (byte-range vs progressive) — depends on IPFS gateway capabilities
- CTR chunk size selection
- CTR nonce/counter management approach
- Service Worker registration and lifecycle strategy
- Custom player component design (specific controls, layout)
- Size threshold for CTR vs GCM classification

## Specific Ideas

- Service Worker approach chosen specifically for transparency — media elements don't need to know about encryption
- Custom player UI should match CipherBox's terminal/hacker aesthetic
- 100MB file limit is current constraint; UI should communicate this clearly but architecture should not hardcode it

## Deferred Ideas

- **Desktop FUSE CTR support** — deferred to a future gap-closing phase addressing all Phase 12.x macOS app gaps in one go
- **BYO-IPFS configuration for larger file uploads** — separate phase (already captured as pending todo)
- **Re-encryption of existing files** — not needed due to clean-break database wipe

---

_Phase: 12.1-aes-ctr-streaming-encryption_
_Context gathered: 2026-02-17_
