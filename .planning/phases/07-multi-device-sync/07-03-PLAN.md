---
phase: 07-multi-device-sync
plan: 03
type: execute
wave: 2
depends_on: ['07-01', '07-02']
files_modified:
  - apps/web/src/api/ipns/ipns.ts
  - apps/web/src/services/ipns.service.ts
  - apps/web/src/components/file-browser/SyncIndicator.tsx
  - apps/web/src/components/file-browser/OfflineBanner.tsx
  - apps/web/src/components/file-browser/FileBrowser.tsx
  - apps/web/src/App.css
autonomous: true

must_haves:
  truths:
    - 'Frontend can resolve IPNS names via backend API'
    - 'Sync indicator shows spinning during sync, checkmark when done, warning on error'
    - 'Offline banner appears when network is disconnected'
    - 'File browser auto-syncs every 30 seconds'
  artifacts:
    - path: 'apps/web/src/services/ipns.service.ts'
      provides: 'IPNS resolution implementation'
      exports: ['resolveIpnsRecord']
    - path: 'apps/web/src/components/file-browser/SyncIndicator.tsx'
      provides: 'Sync status icon in header'
      exports: ['SyncIndicator']
    - path: 'apps/web/src/components/file-browser/OfflineBanner.tsx'
      provides: 'Offline status banner'
      exports: ['OfflineBanner']
  key_links:
    - from: 'apps/web/src/services/ipns.service.ts'
      to: 'apps/web/src/api/ipns/ipns.ts'
      via: 'generated API client call'
      pattern: 'ipnsControllerResolveRecord'
    - from: 'apps/web/src/components/file-browser/FileBrowser.tsx'
      to: 'apps/web/src/hooks/useSyncPolling.ts'
      via: 'useSyncPolling hook'
      pattern: "useSyncPolling\\("
    - from: 'apps/web/src/components/file-browser/SyncIndicator.tsx'
      to: 'apps/web/src/stores/sync.store.ts'
      via: 'useSyncStore hook'
      pattern: "useSyncStore\\("
---

<objective>
Integrate IPNS resolution, sync UI components, and wire sync polling into the file browser.

Purpose: Complete the multi-device sync feature by implementing the actual IPNS resolution, creating visual feedback components (sync indicator, offline banner), and wiring the sync polling into the file browser.

Output: Working IPNS resolution, SyncIndicator component, OfflineBanner component, file browser with auto-sync
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-multi-device-sync/07-CONTEXT.md
@.planning/phases/07-multi-device-sync/07-RESEARCH.md
@.planning/phases/07-multi-device-sync/07-01-SUMMARY.md (backend endpoint, sync store)
@.planning/phases/07-multi-device-sync/07-02-SUMMARY.md (polling hooks)

Key existing files:
@apps/web/src/services/ipns.service.ts (update resolveIpnsRecord)
@apps/web/src/components/file-browser/FileBrowser.tsx (wire sync polling)
@apps/web/src/hooks/useFolderNavigation.ts (folder refresh logic)
@apps/web/src/stores/folder.store.ts (folder state)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Regenerate API client and implement IPNS resolution</name>
  <files>
    apps/web/src/api/ipns/ipns.ts
    apps/web/src/services/ipns.service.ts
  </files>
  <action>
Regenerate API client to include new resolve endpoint, then implement real IPNS resolution.

1. Regenerate API client (from monorepo root):

   ```bash
   pnpm api:generate
   ```

   This will pick up the new GET /ipns/resolve endpoint added in Plan 01.

2. Update `apps/web/src/services/ipns.service.ts`:

Replace the stub `resolveIpnsRecord` function with real implementation:

```typescript
import { ipnsControllerResolveRecord } from '../api/ipns/ipns';

/**
 * Resolve an IPNS name to its current CID and sequence number.
 *
 * Calls backend API which relays to delegated-ipfs.dev for resolution.
 *
 * @param ipnsName - IPNS name to resolve (k51.../bafzaa... format)
 * @returns Current CID and sequence number, or null if not found
 */
export async function resolveIpnsRecord(
  ipnsName: string
): Promise<{ cid: string; sequenceNumber: bigint } | null> {
  try {
    const response = await ipnsControllerResolveRecord({ ipnsName });

    if (!response.success) {
      return null;
    }

    return {
      cid: response.cid,
      sequenceNumber: BigInt(response.sequenceNumber),
    };
  } catch (error) {
    // 404 means IPNS name not found - return null
    // Other errors should propagate
    if (error instanceof Error && error.message.includes('404')) {
      return null;
    }
    throw error;
  }
}
```

Note: The generated API client function name may vary based on orval generation. Check `apps/web/src/api/ipns/ipns.ts` after regeneration for the exact function name.
</action>
<verify> - `pnpm api:generate` succeeds - `pnpm --filter @cipherbox/web build` succeeds - resolveIpnsRecord can be called and returns CID for known IPNS names
</verify>
<done>
resolveIpnsRecord implemented using generated API client, returns CID/sequence or null
</done>
</task>

<task type="auto">
  <name>Task 2: Create SyncIndicator and OfflineBanner components</name>
  <files>
    apps/web/src/components/file-browser/SyncIndicator.tsx
    apps/web/src/components/file-browser/OfflineBanner.tsx
    apps/web/src/App.css
  </files>
  <action>
Create UI components for sync feedback per CONTEXT.md decisions.

1. Create `apps/web/src/components/file-browser/SyncIndicator.tsx`:

```typescript
import { useSyncStore } from '../../stores/sync.store';

/**
 * Sync status indicator for header.
 *
 * Per CONTEXT.md:
 * - Spinning icon during sync
 * - Checkmark when done
 * - Warning icon on sync failure (subtle, cached data remains visible)
 * - No timestamp display
 */
export function SyncIndicator() {
  const { status } = useSyncStore();

  // Icon and title based on status
  const getIcon = () => {
    switch (status) {
      case 'syncing':
        return (
          <svg
            className="sync-indicator-icon sync-indicator-icon--spinning"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            aria-hidden="true"
          >
            <path d="M21 12a9 9 0 1 1-6.219-8.56" />
          </svg>
        );
      case 'success':
        return (
          <svg
            className="sync-indicator-icon sync-indicator-icon--success"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            aria-hidden="true"
          >
            <polyline points="20 6 9 17 4 12" />
          </svg>
        );
      case 'error':
        return (
          <svg
            className="sync-indicator-icon sync-indicator-icon--error"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            aria-hidden="true"
          >
            <circle cx="12" cy="12" r="10" />
            <line x1="12" y1="8" x2="12" y2="12" />
            <line x1="12" y1="16" x2="12.01" y2="16" />
          </svg>
        );
      default: // idle
        return (
          <svg
            className="sync-indicator-icon"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            aria-hidden="true"
          >
            <path d="M21 12a9 9 0 1 1-6.219-8.56" />
          </svg>
        );
    }
  };

  const getTitle = () => {
    switch (status) {
      case 'syncing':
        return 'Syncing...';
      case 'success':
        return 'Synced';
      case 'error':
        return 'Sync failed';
      default:
        return 'Sync';
    }
  };

  return (
    <div className="sync-indicator" title={getTitle()} role="status" aria-live="polite">
      {getIcon()}
      <span className="sr-only">{getTitle()}</span>
    </div>
  );
}
```

2. Create `apps/web/src/components/file-browser/OfflineBanner.tsx`:

```typescript
import { useSyncStore } from '../../stores/sync.store';

/**
 * Offline status banner.
 *
 * Per CONTEXT.md + RESEARCH.md recommendation:
 * - Persistent subtle banner at top when offline
 * - Non-intrusive but always visible
 * - Indicates uploads/downloads are blocked
 */
export function OfflineBanner() {
  const { isOnline } = useSyncStore();

  if (isOnline) return null;

  return (
    <div className="offline-banner" role="alert">
      <svg
        className="offline-banner-icon"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        aria-hidden="true"
      >
        <line x1="1" y1="1" x2="23" y2="23" />
        <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55" />
        <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39" />
        <path d="M10.71 5.05A16 16 0 0 1 22.58 9" />
        <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88" />
        <path d="M8.53 16.11a6 6 0 0 1 6.95 0" />
        <line x1="12" y1="20" x2="12.01" y2="20" />
      </svg>
      <span>You are offline. Uploads and downloads are unavailable.</span>
    </div>
  );
}
```

3. Add styles to `apps/web/src/App.css`:

```css
/* Sync Indicator */
.sync-indicator {
  display: flex;
  align-items: center;
  padding: 4px 8px;
}

.sync-indicator-icon {
  width: 20px;
  height: 20px;
  color: var(--color-text-secondary, #6b7280);
}

.sync-indicator-icon--spinning {
  animation: spin 1s linear infinite;
  color: var(--color-primary, #3b82f6);
}

.sync-indicator-icon--success {
  color: var(--color-success, #10b981);
}

.sync-indicator-icon--error {
  color: var(--color-warning, #f59e0b);
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

/* Offline Banner */
.offline-banner {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background-color: var(--color-warning-bg, #fef3c7);
  color: var(--color-warning-text, #92400e);
  font-size: 14px;
}

.offline-banner-icon {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

/* Screen reader only */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}
```

  </action>
  <verify>
    - `pnpm --filter @cipherbox/web build` succeeds
    - `pnpm --filter @cipherbox/web lint` passes
    - Components can be imported and render without errors
  </verify>
  <done>
    SyncIndicator shows spinning/checkmark/warning based on sync state; OfflineBanner appears when offline
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire sync polling into FileBrowser</name>
  <files>
    apps/web/src/components/file-browser/FileBrowser.tsx
    apps/web/src/services/folder.service.ts
  </files>
  <action>
Integrate sync polling into the file browser with folder refresh logic.

1. Update `apps/web/src/components/file-browser/FileBrowser.tsx`:

Add imports:

```typescript
import { useCallback } from 'react';
import { useSyncPolling } from '../../hooks/useSyncPolling';
import { resolveIpnsRecord } from '../../services/ipns.service';
import { useVaultStore } from '../../stores/vault.store';
import { useFolderStore } from '../../stores/folder.store';
import { SyncIndicator } from './SyncIndicator';
import { OfflineBanner } from './OfflineBanner';
```

Add sync logic inside FileBrowser component:

```typescript
// Vault and folder stores for sync
const { rootIpnsName } = useVaultStore();
const { folders, setFolder } = useFolderStore();

// Sync callback - compare remote CID with local, refresh if different
const handleSync = useCallback(async () => {
  if (!rootIpnsName) return;

  // Resolve root folder IPNS
  const resolved = await resolveIpnsRecord(rootIpnsName);
  if (!resolved) return;

  // Get current root folder from store
  const rootFolder = folders['root'];
  if (!rootFolder) return;

  // Compare CIDs - if different, remote has changes
  // Per CONTEXT.md: last write wins, instant refresh (no toast/prompt)
  // TODO: Implement full metadata refresh when CID differs
  // For now, just detect changes - full refresh requires decrypting new metadata

  // Note: Full implementation will call folder.service to fetch and decrypt
  // the new metadata, then update the folder store. This requires the folder
  // keys which are in the FolderNode.
}, [rootIpnsName, folders]);

// Start sync polling
useSyncPolling(handleSync);
```

Add SyncIndicator to toolbar and OfflineBanner above content:

```tsx
{
  /* In the toolbar area, after UploadZone */
}
<SyncIndicator />;

{
  /* Above file-browser-main content */
}
<OfflineBanner />;
```

2. Create or update `apps/web/src/services/folder.service.ts` (if needed):

Add a function to refresh folder metadata from IPFS:

```typescript
/**
 * Refresh folder metadata from IPFS.
 * Fetches encrypted metadata blob, decrypts, and updates folder store.
 *
 * @param folderId - Folder ID in store
 * @param newCid - CID of new metadata blob
 */
export async function refreshFolderFromCid(folderId: string, newCid: string): Promise<void> {
  // Get folder from store to access keys
  const folder = useFolderStore.getState().folders[folderId];
  if (!folder) return;

  // Fetch encrypted metadata from IPFS gateway
  // Decrypt with folder key
  // Parse FolderMetadata
  // Update folder store with new children

  // Implementation note: This follows same pattern as initial folder load
  // in useFolderNavigation, but triggered by sync instead of navigation
}
```

Note: The full metadata refresh implementation may require extracting common logic from useFolderNavigation. For this plan, wire up the sync detection. Full refresh can be completed if time permits or deferred to a follow-up.
</action>
<verify> - `pnpm --filter @cipherbox/web build` succeeds - `pnpm --filter @cipherbox/web lint` passes - Start app, see SyncIndicator in toolbar - SyncIndicator spins every 30s when tab is focused - Go offline (Network tab in DevTools), see OfflineBanner appear
</verify>
<done>
FileBrowser has SyncIndicator in toolbar, OfflineBanner when offline, and polls for changes every 30s
</done>
</task>

</tasks>

<verification>
- `pnpm api:generate` regenerates client with resolve endpoint
- Frontend builds and lints pass
- SyncIndicator visible in file browser toolbar
- SyncIndicator spins during sync, shows checkmark after
- OfflineBanner appears when offline
- Polling pauses when tab backgrounded, resumes on focus
</verification>

<success_criteria>

1. resolveIpnsRecord returns CID from backend API
2. SyncIndicator shows correct state (spinning/checkmark/warning)
3. OfflineBanner appears when offline with message
4. File browser polls every 30s when visible and online
5. Polling pauses when tab backgrounded
6. Immediate sync on focus regain and reconnect
   </success_criteria>

<output>
After completion, create `.planning/phases/07-multi-device-sync/07-03-SUMMARY.md`
</output>
