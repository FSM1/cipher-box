---
phase: 07-multi-device-sync
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/services/folder.service.ts
  - apps/web/src/components/file-browser/FileBrowser.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - 'Changes made on one device appear on another within ~30 seconds'
    - 'Sync compares local CID with remote CID before refreshing'
    - 'New metadata is decrypted using folder key from FolderNode'
  artifacts:
    - path: 'apps/web/src/services/folder.service.ts'
      provides: 'fetchAndDecryptMetadata function'
      exports: ['fetchAndDecryptMetadata']
    - path: 'apps/web/src/components/file-browser/FileBrowser.tsx'
      provides: 'Complete handleSync implementation'
      contains: 'if (resolved.cid !== localCid)'
  key_links:
    - from: 'FileBrowser.tsx handleSync'
      to: 'folder.service.ts fetchAndDecryptMetadata'
      via: 'function call'
      pattern: 'fetchAndDecryptMetadata'
    - from: 'fetchAndDecryptMetadata'
      to: 'fetchFromIpfs'
      via: 'IPFS fetch'
      pattern: 'fetchFromIpfs'
    - from: 'fetchAndDecryptMetadata'
      to: 'decryptFolderMetadata'
      via: 'crypto decryption'
      pattern: 'decryptFolderMetadata'
---

<objective>
Close verification gap: Implement full metadata refresh when IPNS resolves to different CID.

Purpose: Complete the sync loop so changes made on other devices actually appear in the UI. Currently IPNS resolution works but the result is not used to refresh folder contents.

Output: Working multi-device sync where remote changes appear within ~30 seconds.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-multi-device-sync/07-VERIFICATION.md

Key files:
@apps/web/src/components/file-browser/FileBrowser.tsx (lines 86-107 - handleSync with TODO)
@apps/web/src/services/folder.service.ts (metadata operations)
@apps/web/src/services/ipns.service.ts (resolveIpnsRecord)
@apps/web/src/lib/api/ipfs.ts (fetchFromIpfs)
@packages/crypto/src/folder/metadata.ts (decryptFolderMetadata)
@apps/web/src/stores/folder.store.ts (updateFolderChildren, FolderNode type)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fetchAndDecryptMetadata to folder.service.ts</name>
  <files>apps/web/src/services/folder.service.ts</files>
  <action>
Add a new exported function `fetchAndDecryptMetadata` that:

1. Takes parameters:
   - `cid: string` - IPFS CID of the encrypted metadata blob
   - `folderKey: Uint8Array` - decrypted AES-256 folder key

2. Implementation:
   - Import `fetchFromIpfs` from `../lib/api/ipfs`
   - Import `decryptFolderMetadata` from `@cipherbox/crypto`
   - Import `EncryptedFolderMetadata` type from `@cipherbox/crypto`
   - Fetch encrypted metadata blob from IPFS using `fetchFromIpfs(cid)`
   - Parse the blob as JSON to get `EncryptedFolderMetadata` (contains `iv` and `data` fields)
   - Decrypt using `decryptFolderMetadata(encrypted, folderKey)`
   - Return the decrypted `FolderMetadata` (contains `version` and `children`)

3. Return type: `Promise<FolderMetadata>`

4. Error handling: Let errors propagate (caller handles)

This extracts the decrypt logic so it can be reused by both folder loading and sync refresh.
</action>
<verify>
TypeScript compiles without errors:

```bash
cd apps/web && pnpm tsc --noEmit
```

  </verify>
  <done>
`fetchAndDecryptMetadata` function exists in folder.service.ts, is exported, and compiles correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement full metadata refresh in handleSync</name>
  <files>apps/web/src/components/file-browser/FileBrowser.tsx</files>
  <action>
Update the `handleSync` callback (lines 86-107) to complete the sync loop:

1. Add import for `fetchAndDecryptMetadata` from `../../services/folder.service`

2. Replace the TODO comment block with actual implementation:

```typescript
const handleSync = useCallback(async () => {
  if (!rootIpnsName) return;

  // Resolve root folder IPNS to get remote CID
  const resolved = await resolveIpnsRecord(rootIpnsName);
  if (!resolved) return;

  // Get current root folder from store
  const rootFolder = folders['root'];
  if (!rootFolder) return;

  // Get local CID by resolving current IPNS (or use cached if available)
  // For now, we compare sequence numbers as a proxy for "has changed"
  // If remote seq > local seq, we need to refresh
  if (resolved.sequenceNumber <= rootFolder.sequenceNumber) {
    // No changes, already up to date
    return;
  }

  // Remote has newer version - fetch and decrypt new metadata
  try {
    const metadata = await fetchAndDecryptMetadata(resolved.cid, rootFolder.folderKey);

    // Update folder store with new children
    // Per CONTEXT.md: last write wins, instant refresh (no toast/prompt)
    useFolderStore.getState().updateFolderChildren('root', metadata.children);
    useFolderStore.getState().updateFolderSequence('root', resolved.sequenceNumber);
  } catch (err) {
    // Log but don't crash - sync will retry on next interval
    console.error('Sync refresh failed:', err);
  }
}, [rootIpnsName, folders]);
```

3. Key points:
   - Use sequence number comparison (more reliable than CID comparison since we don't cache local CID)
   - Only refresh if remote seq > local seq
   - Use useFolderStore.getState() to avoid stale closure issues
   - Update both children and sequence number after successful refresh
   - Catch errors silently (sync retries every 30s anyway)
     </action>
     <verify>
1. TypeScript compiles:

```bash
cd apps/web && pnpm tsc --noEmit
```

2. Lint passes:

```bash
cd apps/web && pnpm lint
```

3. Manual test: Open two browser windows, upload a file in one, wait 30s, see it appear in the other.
   </verify>
   <done>
   handleSync callback:

- Compares remote sequenceNumber with local sequenceNumber
- Fetches and decrypts metadata when remote is newer
- Updates folder store with new children
- Handles errors gracefully without crashing
  </done>
  </task>

</tasks>

<verification>
1. TypeScript compilation passes for web app
2. ESLint passes with no errors
3. Existing E2E tests still pass (auth, file operations)
4. Manual multi-device test: Upload file in one window, appears in another within 30s
</verification>

<success_criteria>

- fetchAndDecryptMetadata function exists and is exported from folder.service.ts
- handleSync compares sequence numbers and refreshes when remote is newer
- No TODO comments remain in handleSync
- Sync actually updates UI when remote changes detected
  </success_criteria>

<output>
After completion, create `.planning/phases/07-multi-device-sync/07-04-SUMMARY.md`
</output>
