---
phase: 11.1-macos-desktop-catch-up
plan: 02
subsystem: desktop
tags: [rust, tauri, security, zeroize, clap, urlencoding, debug-redaction]

# Dependency graph
requires:
  - phase: 09-desktop-client
    provides: Desktop Rust codebase with auth DTOs, IPNS, Ed25519, sync daemon
provides:
  - Security-hardened auth DTOs with redacted Debug output
  - URL-encoded IPNS query parameters
  - Zeroized Ed25519 stack key copies
  - Sanitized sync daemon error messages in tray
  - --dev-key CLI argument for headless auth in debug builds
affects: [11.1-macos-desktop-catch-up, desktop-testing, ci-desktop]

# Tech tracking
tech-stack:
  added: [urlencoding, clap]
  patterns: [manual-debug-impl-redaction, cfg-debug-assertions-gating, error-sanitization]

key-files:
  created: []
  modified:
    - apps/desktop/src-tauri/src/api/types.rs
    - apps/desktop/src-tauri/src/api/ipns.rs
    - apps/desktop/src-tauri/src/crypto/ed25519.rs
    - apps/desktop/src-tauri/src/sync/mod.rs
    - apps/desktop/src/auth.ts
    - apps/desktop/src-tauri/src/main.rs
    - apps/desktop/src-tauri/src/state.rs
    - apps/desktop/src-tauri/src/commands.rs
    - apps/desktop/src-tauri/Cargo.toml

key-decisions:
  - 'sanitize_error uses char-walking approach instead of regex crate to avoid adding a dependency'
  - 'dev_key field always present in AppState (not cfg-gated) to simplify struct; only CLI parsing is cfg-gated'
  - 'dev_key zeroized on clear_keys() since it contains sensitive private key hex'

patterns-established:
  - 'Manual Debug impl pattern: redact sensitive fields with [REDACTED] for auth DTOs'
  - 'Error sanitization pattern: truncate at 80 chars, replace paths with [path], replace long hex with [token]'
  - 'cfg(debug_assertions) gating: compile out debug-only features in release builds'

# Metrics
duration: 7min
completed: 2026-02-17
---

# Phase 11.1 Plan 02: Security Fixes & Dev-Key CLI Summary

**5 security fixes (M-11/L-2/L-4/L-5/L-7) applied with redacted Debug impls, URL-encoded IPNS, zeroized Ed25519 keys, sanitized tray errors, plus --dev-key CLI for headless debug auth**

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-17T16:41:03Z
- **Completed:** 2026-02-17T16:48:50Z
- **Tasks:** 2
- **Files modified:** 9

## Accomplishments

- M-11: Manual Debug impls for LoginRequest, LoginResponse, RefreshRequest, RefreshResponse redact all token/key fields with [REDACTED]
- L-2: IPNS resolve query parameter URL-encoded via urlencoding crate
- L-4: Removed console.log that leaked private key length in desktop auth.ts
- L-5: Ed25519 key_bytes stack copy zeroized immediately after SigningKey creation
- L-7: Sync daemon error messages sanitized (truncated, paths stripped, tokens replaced) before tray display
- --dev-key CLI argument enables headless auth in debug builds, compiled out in release

## Task Commits

Each task was committed atomically:

1. **Task 1: Security fixes M-11, L-2, L-4, L-5, L-7** - `e66f07ce0` (fix)
2. **Task 2: --dev-key CLI argument for headless auth** - `43707e856` (feat)

## Files Created/Modified

- `apps/desktop/src-tauri/src/api/types.rs` - Manual Debug impls for auth DTOs with [REDACTED] fields
- `apps/desktop/src-tauri/src/api/ipns.rs` - URL-encoded IPNS name in resolve query
- `apps/desktop/src-tauri/src/crypto/ed25519.rs` - Zeroize key_bytes after SigningKey::from_bytes
- `apps/desktop/src-tauri/src/sync/mod.rs` - sanitize_error() + helper functions for tray error messages
- `apps/desktop/src/auth.ts` - Removed console.log private key length leak
- `apps/desktop/src-tauri/src/main.rs` - CLI arg parsing with clap, cfg(debug_assertions) gating
- `apps/desktop/src-tauri/src/state.rs` - dev_key field in AppState, zeroized on clear_keys()
- `apps/desktop/src-tauri/src/commands.rs` - get_dev_key Tauri IPC command
- `apps/desktop/src-tauri/Cargo.toml` - Added urlencoding and clap dependencies

## Decisions Made

- Used char-walking approach for path/token replacement in sanitize_error() instead of adding regex crate dependency -- keeps binary size small for a simple task
- dev_key field is always present in AppState struct (not behind cfg) to avoid conditional compilation complexity in state.rs; only the CLI parsing module is cfg-gated
- dev_key is treated as sensitive (zeroized on logout) because it contains a raw private key hex string

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Security fixes complete, ready for plan 03 (Core Kit auth migration)
- --dev-key enables headless testing without Web3Auth modal
- All 113 existing tests pass after changes

---

_Phase: 11.1-macos-desktop-catch-up_
_Completed: 2026-02-17_
