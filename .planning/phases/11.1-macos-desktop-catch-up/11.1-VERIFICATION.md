---
phase: 11.1-macos-desktop-catch-up
verified: 2026-02-17T19:30:00Z
status: passed
score: 10/10 must-haves verified
---

# Phase 11.1: macOS Desktop Catch-Up Verification Report

**Phase Goal:** Close all functional, auth, and crypto gaps accumulated in the macOS Tauri/FUSE desktop client during Phases 12-12.6, so the desktop app works with current vaults and auth infrastructure before cross-platform expansion
**Verified:** 2026-02-17T19:30:00Z
**Status:** PASSED
**Re-verification:** No -- initial verification

## Goal Achievement

### Observable Truths

| #   | Truth                                                                                                                                                                                             | Status   | Evidence                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| --- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Desktop reads v2 folder metadata (folder_v2 schema) with FilePointer entries and resolves per-file IPNS records to fetch file CID, IV, and wrapped key                                            | VERIFIED | `fuse/inode.rs` has `populate_folder_v2` (line 434) with FilePointer support, `file_meta_ipns_name` field (line 75), `file_meta_resolved` tracking (line 77). `fuse/operations.rs` has `resolve_file_pointers_blocking` (line 196) and `decrypt_file_metadata_from_ipfs` (line 251). `crypto/folder.rs` defines `FolderMetadataV2`, `FilePointer`, `AnyFolderMetadata`, `decrypt_any_folder_metadata` (line 245). `fuse/inode.rs:658` has `populate_folder_any` dispatching v1/v2. |
| 2   | Desktop decrypts AES-256-CTR encrypted files (media uploaded via web) in addition to existing AES-256-GCM -- dispatch based on encryptionMode field                                               | VERIFIED | `crypto/aes_ctr.rs` implements `encrypt_aes_ctr`, `decrypt_aes_ctr`, `decrypt_aes_ctr_range` using `Ctr64BE` (line 25). `fuse/operations.rs` dispatches on `encryption_mode` field: `if mode == "CTR"` at lines 310, 901, 1150 calling `crate::crypto::aes_ctr::decrypt_aes_ctr`. GCM continues to work for non-CTR files.                                                                                                                                                         |
| 3   | Desktop initialize_vault derives IPNS keypair deterministically via HKDF ("cipherbox-vault-ipns-v1") instead of random generation                                                                 | VERIFIED | `commands.rs` line 443: `crypto::hkdf::derive_vault_ipns_keypair(&private_key_arr)` in initialize_vault. `crypto/hkdf.rs` has `VAULT_HKDF_INFO = b"cipherbox-vault-ipns-v1"` (line 26), salt `b"CipherBox-v1"` (line 23). Backward-compat verification at line 584 checks HKDF derivation matches stored key.                                                                                                                                                                      |
| 4   | Desktop auth migrated from PnP Modal SDK to Core Kit with CipherBox identity provider -- uses loginWithJWT flow with same cipherbox-identity verifier as web                                      | VERIFIED | `auth.ts` uses `@web3auth/mpc-core-kit` with `loginWithJWT` (line 292) using verifier `'cipherbox-identity'`. `package.json` has `@web3auth/mpc-core-kit: ^3.5.0`, no `@web3auth/modal` references found. `commands.rs` line 55: `login_type: "corekit".to_string()`. Google OAuth via GIS (line 129-144), Email OTP (line 173-192), both flow through CipherBox backend identity endpoints.                                                                                       |
| 5   | Desktop supports MFA: can participate as existing device for cross-device approval, and can recover via recovery phrase when device share is missing                                              | VERIFIED | `auth.ts` exports `inputRecoveryPhrase` (line 449) using `mnemonicToKey` + `coreKit.inputFactorKey`. `requestDeviceApproval` (line 502) creates ephemeral secp256k1 keypair and polls bulletin board. `pollApprovalStatus` (line 539) ECIES-decrypts factor key. `approveDevice` (line 633) fully implemented (API-complete, no UI trigger per plan). `main.ts:299` renders full `renderRequiredShareUI` with recovery phrase textarea and approval waiting state.                 |
| 6   | Desktop registers itself in the encrypted device registry on IPFS -- appears in web app's Authorized Devices view                                                                                 | VERIFIED | `registry/mod.rs` has full `register_device` function (line 33): HKDF registry IPNS derivation, ECIES encrypt with user public key, IPFS upload, IPNS publish. `registry/types.rs` has `DeviceEntry`, `DeviceRegistry`, `DevicePlatform::Macos` (line 57). `commands.rs` line 118: `tokio::spawn` for non-blocking registry call after auth. 7 unit tests pass.                                                                                                                    |
| 7   | Desktop supports SIWE wallet login (sign SIWE message in Tauri webview, verify via CipherBox API)                                                                                                 | VERIFIED | `auth.ts:210` exports `loginWithWallet()` with EIP-1193 provider detection, EIP-4361 SIWE message construction (lines 237-248), `personal_sign` (line 251), verification via `POST ${API_BASE}/auth/identity/wallet` (line 257), then `loginWithCoreKit` (line 269). `main.ts:124` has `wallet-btn` button with click handler (line 202).                                                                                                                                          |
| 8   | Rust auth structs use manual Debug impl that redacts tokens and keys (security fix M-11)                                                                                                          | VERIFIED | `api/types.rs` has `impl fmt::Debug for LoginRequest` (line 19) with `"[REDACTED]"` for `id_token` and `public_key`. Same for `LoginResponse` (line 38), `RefreshRequest` (line 55), `RefreshResponse` (line 71). All four auth DTOs redact sensitive fields.                                                                                                                                                                                                                      |
| 9   | --dev-key <hex> CLI argument (debug builds only) enables headless auth for automated testing and CI                                                                                               | VERIFIED | `main.rs:18`: `#[cfg(debug_assertions)] mod cli` with `clap::Parser` struct, `--dev-key` arg (line 27). `main.rs:36`: `#[cfg(debug_assertions)]` block parses args. `main.rs:46`: `#[cfg(not(debug_assertions))] let dev_key: Option<String> = None`. `state.rs:68`: `dev_key: RwLock<Option<String>>` in AppState, zeroized on `clear_keys()` (line 119). `main.ts:51`: `invoke('get_dev_key')` checks and routes to `handleDevKeyAuth` (line 57).                                |
| 10  | Low-severity security backlog items addressed: IPNS name URL encoding (L-2), console.log key length leak (L-4), Ed25519 stack key zeroization (L-5), sync daemon error message sanitization (L-7) | VERIFIED | L-2: `api/ipns.rs:29` uses `urlencoding::encode(ipns_name)`. L-4: No `console.log.*private.*key.*length` found in `auth.ts` (confirmed removed). L-5: `ed25519.rs:55` `key_bytes.zeroize()` after `SigningKey::from_bytes` in `sign_ed25519`. L-7: `sync/mod.rs:230` has `sanitize_error()` function truncating to 80 chars, replacing paths with `[path]`, replacing tokens with `[token]`. Used at line 160 for tray status error display.                                       |

**Score:** 10/10 truths verified

### Required Artifacts

| Artifact                                        | Expected                                                                 | Status   | Details                                                              |
| ----------------------------------------------- | ------------------------------------------------------------------------ | -------- | -------------------------------------------------------------------- |
| `apps/desktop/src-tauri/src/crypto/hkdf.rs`     | HKDF derivation for vault, file, registry                                | VERIFIED | 117 lines, 3 public functions, internal helper, proper error types   |
| `apps/desktop/src-tauri/src/crypto/aes_ctr.rs`  | AES-256-CTR encrypt/decrypt/range                                        | VERIFIED | 131 lines, Ctr64BE type, block-aligned range decrypt                 |
| `apps/desktop/src-tauri/src/crypto/folder.rs`   | v2 types: FilePointer, FolderMetadataV2, FileMetadata, AnyFolderMetadata | VERIFIED | 301 lines, all types with serde camelCase, version dispatch, to_v1() |
| `apps/desktop/src-tauri/src/crypto/mod.rs`      | Registers hkdf and aes_ctr modules                                       | VERIFIED | Both `pub mod hkdf` and `pub mod aes_ctr` present                    |
| `apps/desktop/src-tauri/src/crypto/tests.rs`    | Comprehensive tests for all new primitives                               | VERIFIED | 1207 lines, covers HKDF, AES-CTR, v2 types, cross-language vectors   |
| `apps/desktop/src-tauri/src/api/types.rs`       | Manual Debug impls with [REDACTED]                                       | VERIFIED | 4 auth DTOs with manual Debug, tokens/keys redacted                  |
| `apps/desktop/src-tauri/src/api/ipns.rs`        | URL-encoded IPNS query                                                   | VERIFIED | `urlencoding::encode(ipns_name)` on line 29                          |
| `apps/desktop/src-tauri/src/crypto/ed25519.rs`  | Zeroized key_bytes in sign_ed25519                                       | VERIFIED | `key_bytes.zeroize()` on line 55                                     |
| `apps/desktop/src-tauri/src/sync/mod.rs`        | sanitize_error() for tray display                                        | VERIFIED | Function at line 230, used at line 160                               |
| `apps/desktop/src-tauri/src/main.rs`            | --dev-key CLI arg, cfg(debug_assertions) gated                           | VERIFIED | cli module gated, AppState receives dev_key                          |
| `apps/desktop/src-tauri/src/state.rs`           | dev_key in AppState, zeroized on logout                                  | VERIFIED | Field at line 68, zeroized at line 119                               |
| `apps/desktop/src/auth.ts`                      | Core Kit loginWithJWT, Google/Email/Wallet/MFA                           | VERIFIED | 745 lines, fully implemented with ECIES device approval              |
| `apps/desktop/src/main.ts`                      | Login UI with Google/Wallet/Email/MFA                                    | VERIFIED | 621 lines, full UI with all auth paths and MFA recovery              |
| `apps/desktop/src-tauri/src/commands.rs`        | HKDF vault init, loginType 'corekit'                                     | VERIFIED | derive_vault_ipns_keypair at line 443, "corekit" at line 55          |
| `apps/desktop/src-tauri/src/fuse/inode.rs`      | FilePointer support, encryption_mode field                               | VERIFIED | populate_folder_v2, file_meta_ipns_name, resolve_file_pointer        |
| `apps/desktop/src-tauri/src/fuse/operations.rs` | v2 metadata parsing, CTR dispatch in read()                              | VERIFIED | AnyFolderMetadata at line 99, CTR dispatch at lines 310/901/1150     |
| `apps/desktop/src-tauri/src/registry/mod.rs`    | register_device with HKDF + ECIES                                        | VERIFIED | 333 lines, full CRUD with 7 tests                                    |
| `apps/desktop/src-tauri/src/registry/types.rs`  | DeviceEntry, DeviceRegistry types                                        | VERIFIED | 79 lines, typed enums, camelCase serde                               |

### Key Link Verification

| From               | To                              | Via                                          | Status | Details                                                                                          |
| ------------------ | ------------------------------- | -------------------------------------------- | ------ | ------------------------------------------------------------------------------------------------ |
| commands.rs        | crypto/hkdf.rs                  | HKDF vault derivation replaces random keygen | WIRED  | `crypto::hkdf::derive_vault_ipns_keypair` at line 443                                            |
| fuse/operations.rs | crypto/aes_ctr.rs               | CTR decryption in read()                     | WIRED  | `crate::crypto::aes_ctr::decrypt_aes_ctr` at lines 316, 907, 1156                                |
| fuse/inode.rs      | crypto/folder.rs                | FilePointer and v2 types                     | WIRED  | `populate_folder_v2` uses FilePointer, `populate_folder_any` dispatches                          |
| auth.ts            | CipherBox API /auth/identity/\* | Google/Email/Wallet endpoints                | WIRED  | fetch calls to /auth/identity/google, /email/send-otp, /email/verify-otp, /wallet/nonce, /wallet |
| auth.ts            | @web3auth/mpc-core-kit          | loginWithJWT with CipherBox JWT              | WIRED  | `coreKit.loginWithJWT` at line 292 with verifier 'cipherbox-identity'                            |
| auth.ts            | commands.rs via Tauri IPC       | handle_auth_complete                         | WIRED  | `invoke('handle_auth_complete', { idToken, privateKey })` at line 363                            |
| main.ts            | auth.ts                         | Login UI calls auth functions                | WIRED  | Imports loginWithGoogle, loginWithWallet, requestEmailOtp, loginWithEmailOtp, MFA functions      |
| registry/mod.rs    | crypto/hkdf.rs                  | Registry IPNS derivation                     | WIRED  | `crypto::hkdf::derive_registry_ipns_keypair` at line 41                                          |
| registry/mod.rs    | crypto/ecies.rs                 | ECIES encrypt registry                       | WIRED  | `crypto::ecies::wrap_key` at line 95                                                             |
| commands.rs        | registry/mod.rs                 | Non-blocking registration                    | WIRED  | `tokio::spawn` at line 118 calling `register_device` at line 126                                 |

### Build and Test Verification

| Check                 | Status | Details                                                               |
| --------------------- | ------ | --------------------------------------------------------------------- |
| `cargo check`         | PASS   | Compiles successfully (46 warnings from pre-existing code, 0 errors)  |
| `cargo test`          | PASS   | 120 tests pass, 0 failures                                            |
| PnP Modal SDK removed | PASS   | No `@web3auth/modal` or `WALLET_CONNECTORS` references in desktop app |
| MPC Core Kit present  | PASS   | `@web3auth/mpc-core-kit: ^3.5.0` in package.json                      |

### Anti-Patterns Found

| File       | Line  | Pattern                                  | Severity | Impact                                                                                                                                                             |
| ---------- | ----- | ---------------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| auth.ts    | 674   | TODO (Phase 11.2)                        | Info     | Approval listener deferred to next phase -- intentional                                                                                                            |
| main.ts    | 31    | TODO (Phase 11.2)                        | Info     | Same deferred item -- not a gap                                                                                                                                    |
| ed25519.rs | 90-93 | key_bytes not zeroized in get_public_key | Warning  | L-5 fix applied to sign_ed25519 (critical path); get_public_key has unzeroized stack copy -- lower risk since it's a read-only derivation and stack is short-lived |

### Human Verification Required

### 1. Core Kit Login End-to-End

**Test:** Open desktop app, click "sign in with Google", complete Google OAuth flow, verify vault mounts
**Expected:** Google credential flows through CipherBox backend -> CipherBox JWT -> Core Kit loginWithJWT -> TSS key export -> FUSE mount appears at ~/CipherBox
**Why human:** Requires running web3auth infrastructure, Google OAuth, and Tauri webview

### 2. v2 Folder with CTR-Encrypted Media File

**Test:** Upload a media file (video/audio) via web app, then access it through desktop FUSE mount
**Expected:** File appears in Finder with correct size, can be read/copied without errors (CTR decryption)
**Why human:** Requires live web app upload + FUSE mount read, can't simulate NFS behavior

### 3. Device Registry Appears in Web App

**Test:** Log in on desktop, then check web app's Authorized Devices view
**Expected:** Desktop device appears with platform "macos", correct app version, status "pending" or "authorized"
**Why human:** Requires both web and desktop running with same account

### 4. MFA Recovery Phrase Flow

**Test:** Enable MFA on web app, then log in on desktop (should show REQUIRED_SHARE UI), enter recovery phrase
**Expected:** 24-word recovery phrase input completes login, FUSE mount appears
**Why human:** Requires MFA-enabled account with known recovery phrase

### 5. SIWE Wallet Login

**Test:** Click "connect wallet" on desktop login screen with MetaMask or similar browser extension
**Expected:** Wallet prompts for SIWE message signature, login completes
**Why human:** Requires Tauri webview with wallet extension (may not work -- known limitation documented)

### Gaps Summary

No functional gaps found. All 10 success criteria are verified at the code level:

- **Crypto primitives** (Plan 01): HKDF, AES-CTR, v2 types all implemented with comprehensive tests
- **Security fixes** (Plan 02): All 5 security items (M-11, L-2, L-4, L-5, L-7) addressed
- **FUSE/vault integration** (Plan 03): HKDF vault init, v2 metadata parsing, CTR/GCM dispatch working
- **Core Kit auth** (Plan 04): Full migration from PnP Modal to Core Kit with CipherBox identity provider
- **MFA support** (Plan 05): Recovery phrase and device approval flows implemented with proper ECIES
- **Device registry** (Plan 06): Full ECIES-encrypted registry with non-blocking registration
- **SIWE wallet login** (Plan 07): EIP-4361 SIWE message + CipherBox API verification

One minor warning: `get_public_key()` in ed25519.rs does not zeroize its stack key copy (unlike `sign_ed25519`). This is lower risk but could be hardened in a future pass.

All items marked for human verification are runtime integration tests that require live infrastructure and cannot be verified by code inspection alone.

---

_Verified: 2026-02-17T19:30:00Z_
_Verifier: Claude (gsd-verifier)_
