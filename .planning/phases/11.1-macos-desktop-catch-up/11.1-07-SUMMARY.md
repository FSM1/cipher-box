---
phase: 11.1-macos-desktop-catch-up
plan: 07
subsystem: auth
tags: [siwe, wallet, ethereum, eip-4361, eip-1193, desktop, tauri]

# Dependency graph
requires:
  - phase: 12.3
    provides: SIWE wallet endpoints on CipherBox API (/auth/identity/wallet/*)
  - phase: 11.1-04
    provides: Core Kit loginWithJWT in desktop auth.ts
provides:
  - Desktop SIWE wallet login via injected EIP-1193 provider
  - loginWithWallet() function in desktop auth.ts
  - Wallet connect button on desktop login screen
affects: [11.1-uat]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - EIP-4361 SIWE message manual construction (no viem dependency)
    - EIP-1193 injected provider detection for Tauri webview

key-files:
  created: []
  modified:
    - apps/desktop/src/auth.ts
    - apps/desktop/src/main.ts

key-decisions:
  - 'Manual EIP-4361 SIWE message construction instead of adding viem dependency'
  - 'Injected provider only for MVP; WalletConnect deferred to Phase 11'
  - "SIWE statement matches web app exactly: 'Sign in to CipherBox encrypted storage'"

patterns-established:
  - 'Desktop wallet auth reuses same CipherBox API endpoints as web app'
  - 'EthereumProvider interface typed locally to avoid heavy wallet framework dependencies'

# Metrics
duration: 2min
completed: 2026-02-17
---

# Phase 11.1 Plan 07: SIWE Wallet Login Summary

**SIWE wallet login for desktop via injected EIP-1193 provider with EIP-4361 message matching web app format**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-17T17:54:47Z
- **Completed:** 2026-02-17T17:56:48Z
- **Tasks:** 1
- **Files modified:** 2

## Accomplishments

- Added `loginWithWallet()` to desktop auth.ts using raw EIP-1193 `window.ethereum` provider
- SIWE message built in EIP-4361 format matching web app's `createSiweMessage` output exactly
- Wallet "Connect Wallet" button added to login UI between Google and Email options
- REQUIRED_SHARE handling reuses existing MFA stub UI from Plan 04
- Clear error messaging when no wallet provider is detected in Tauri webview

## Task Commits

Each task was committed atomically:

1. **Task 1: SIWE wallet login implementation** - `74e0260` (feat)

## Files Created/Modified

- `apps/desktop/src/auth.ts` - Added `loginWithWallet()` with EIP-1193 provider detection, SIWE message creation, API verification, Core Kit handoff
- `apps/desktop/src/main.ts` - Added wallet-btn to login form, click handler with status/error handling, button in hover effects and disable logic

## Decisions Made

- **Manual SIWE message construction**: Built EIP-4361 message as string array join instead of adding `viem` dependency. Desktop only needs message creation (no React/wagmi), so raw string construction avoids ~200KB of unnecessary dependencies. Backend's `parseSiweMessage` from viem accepts the standard format.
- **Injected provider only for MVP**: `window.ethereum` detection with clear error if missing. WalletConnect QR code flow deferred to Phase 11 (cross-platform). Tauri webview may not support browser wallet extensions, which is documented as a known limitation.
- **GET for nonce endpoint**: Web app uses `GET /auth/identity/wallet/nonce` (no body), matching the API controller's `@Get` decorator. Plan template incorrectly showed POST -- fixed to match actual API.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Nonce endpoint is GET, not POST**

- **Found during:** Task 1 (reading identity.controller.ts)
- **Issue:** Plan template showed `POST` for nonce endpoint, but API controller uses `@Get('identity/wallet/nonce')`
- **Fix:** Used `fetch(url)` (GET) instead of `fetch(url, { method: 'POST', body: ... })`
- **Files modified:** apps/desktop/src/auth.ts
- **Verification:** Matches web app's `apiClient.get<>('/auth/identity/wallet/nonce')`
- **Committed in:** 74e0260 (Task 1 commit)

**2. [Rule 1 - Bug] Verify endpoint path is /auth/identity/wallet, not /auth/identity/wallet/verify**

- **Found during:** Task 1 (reading identity.controller.ts)
- **Issue:** Plan template showed `/auth/identity/wallet/verify`, but API controller uses `@Post('identity/wallet')`
- **Fix:** Used correct endpoint path `/auth/identity/wallet`
- **Files modified:** apps/desktop/src/auth.ts
- **Verification:** Matches web app's `apiClient.post<>('/auth/identity/wallet', data)`
- **Committed in:** 74e0260 (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (2 bugs -- incorrect API endpoint paths in plan template)
**Impact on plan:** Both fixes necessary for correct API communication. No scope creep.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required. Wallet login uses existing CipherBox API wallet endpoints.

## Next Phase Readiness

- All 7 plans in Phase 11.1 now have execution summaries
- Desktop has full auth parity with web app: Google, Email OTP, and Wallet SIWE
- Ready for Phase 11.1 UAT testing

---

_Phase: 11.1-macos-desktop-catch-up_
_Completed: 2026-02-17_
