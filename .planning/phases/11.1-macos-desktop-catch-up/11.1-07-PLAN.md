---
phase: 11.1-macos-desktop-catch-up
plan: 07
type: execute
wave: 3
depends_on: ['11.1-04']
files_modified:
  - apps/desktop/package.json
  - apps/desktop/src/auth.ts
  - apps/desktop/src/main.ts
autonomous: true

must_haves:
  truths:
    - "Desktop shows a 'Connect Wallet' button on the login screen alongside Google and Email options"
    - "Clicking 'Connect Wallet' opens wallet connection (injected provider or WalletConnect) and prompts SIWE message signing"
    - 'Signed SIWE message is verified via CipherBox API /auth/identity/wallet/* endpoints'
    - 'After SIWE verification, CipherBox JWT is used for Core Kit loginWithJWT (same as Google/Email flow)'
    - 'Wallet login produces the same vault access as other auth methods for the same user'
  artifacts:
    - path: 'apps/desktop/src/auth.ts'
      provides: 'loginWithWallet function using SIWE flow'
      contains: 'loginWithWallet'
    - path: 'apps/desktop/src/main.ts'
      provides: 'Wallet connect button in login UI'
      contains: 'wallet-btn'
  key_links:
    - from: 'apps/desktop/src/auth.ts'
      to: 'CipherBox API /auth/identity/wallet/*'
      via: 'SIWE nonce request and signature verification'
      pattern: '/auth/identity/wallet'
    - from: 'apps/desktop/src/auth.ts'
      to: '@web3auth/mpc-core-kit'
      via: 'Core Kit loginWithJWT after SIWE verification'
      pattern: 'loginWithCoreKit'
---

<objective>
Add SIWE (Sign-In with Ethereum) wallet login to the desktop app. Users can authenticate by signing a SIWE message with their Ethereum wallet (MetaMask or other injected provider).

Purpose: The web app supports wallet login via SIWE. Desktop parity requires the same capability so wallet-only users can access their vault from the desktop app.

Output: loginWithWallet function in auth.ts and wallet connect button in the login UI.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan outputs

@.planning/phases/11.1-macos-desktop-catch-up/11.1-04-SUMMARY.md

# Web app SIWE reference implementation

@apps/web/src/components/auth/WalletLoginButton.tsx
@apps/web/src/hooks/useAuth.ts

# CipherBox API wallet endpoints

@apps/api/src/auth/controllers/identity.controller.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: SIWE wallet login implementation</name>
  <files>
    apps/desktop/package.json
    apps/desktop/src/auth.ts
    apps/desktop/src/main.ts
  </files>
  <action>
    1. Add SIWE/wallet dependencies to package.json:
       - `viem` â€” for SIWE message creation and wallet interaction (lighter than wagmi for non-React context)
       - OR use raw `window.ethereum` EIP-1193 provider directly (simpler, no framework needed)
       - The Tauri webview can access `window.ethereum` if a browser extension injects it
       - For desktop wallets that don't inject into Tauri: use WalletConnect as fallback
       - For MVP: support only injected provider (window.ethereum). WalletConnect is a stretch goal.

    2. Add `loginWithWallet()` to auth.ts:
       ```typescript
       export async function loginWithWallet(): Promise<LoginResult> {
         if (!coreKit) throw new Error('Core Kit not initialized');

         // Check for injected wallet provider
         const ethereum = (window as any).ethereum;
         if (!ethereum) {
           throw new Error('No wallet detected. Please install MetaMask or another Ethereum wallet.');
         }

         // 1. Request accounts
         const accounts: string[] = await ethereum.request({ method: 'eth_requestAccounts' });
         if (!accounts || accounts.length === 0) {
           throw new Error('No accounts available');
         }
         const address = accounts[0];

         // 2. Get SIWE nonce from CipherBox API
         const nonceResp = await fetch(`${API_BASE}/auth/identity/wallet/nonce`, {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ address }),
         });
         if (!nonceResp.ok) throw new Error('Failed to get SIWE nonce');
         const { nonce } = await nonceResp.json();

         // 3. Create SIWE message (EIP-4361 format)
         const domain = new URL(API_BASE).hostname;
         const uri = API_BASE;
         const issuedAt = new Date().toISOString();
         const siweMessage = [
           `${domain} wants you to sign in with your Ethereum account:`,
           address,
           '',
           'Sign in to CipherBox',
           '',
           `URI: ${uri}`,
           `Version: 1`,
           `Chain ID: 1`,
           `Nonce: ${nonce}`,
           `Issued At: ${issuedAt}`,
         ].join('\n');

         // 4. Sign SIWE message with wallet
         const signature: string = await ethereum.request({
           method: 'personal_sign',
           params: [siweMessage, address],
         });

         // 5. Verify signature with CipherBox API
         const verifyResp = await fetch(`${API_BASE}/auth/identity/wallet/verify`, {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ message: siweMessage, signature, address }),
         });
         if (!verifyResp.ok) throw new Error('SIWE verification failed');
         const { token: cipherboxJwt } = await verifyResp.json();

         // 6. Core Kit loginWithJWT (same as Google/Email)
         return await loginWithCoreKit(cipherboxJwt);
       }
       ```

    3. Update `main.ts` login UI to include wallet button:
       - Add a "Connect Wallet" button between the Google button and email section
       - Wire click handler to call `loginWithWallet()`:
         ```typescript
         document.getElementById('wallet-btn')?.addEventListener('click', async () => {
           const statusEl = document.getElementById('auth-status')!;
           try {
             statusEl.textContent = 'Connecting wallet...';
             const result = await loginWithWallet();
             if (result.status === 'required_share') {
               renderRequiredShareUI(appDiv);
               return;
             }
             handleAuthSuccess();
           } catch (err) {
             statusEl.style.color = '#ef4444';
             statusEl.textContent = err instanceof Error ? err.message : 'Wallet login failed';
           }
         });
         ```

    4. SIWE message format must match web app exactly:
       - Check the web app's SIWE message construction in WalletLoginButton.tsx
       - Ensure domain, URI, chainId, version fields match
       - The CipherBox API endpoint expects the exact same fields for verification

    5. Handle edge case: if `window.ethereum` is undefined (no wallet extension installed in Tauri webview):
       - Show informative error: "No Ethereum wallet detected. Install a wallet browser extension to use wallet login."
       - Consider: Tauri webview may not have browser extension support like Chrome/Firefox
       - In that case, wallet login on desktop may be limited to users who have wallet extensions working in the webview environment
       - Document this limitation if it applies
       - Alternative: WalletConnect QR code flow (scan with mobile wallet) -- this is a valid fallback
       - For MVP: document the limitation, implement WalletConnect in Phase 11 (cross-platform)

    6. After SIWE verification succeeds, disconnect the wallet (same as web app):
       - No persistent wallet connection needed
       - Core Kit handles ongoing auth

  </action>
  <verify>
    TypeScript compiles: `cd /Users/michael/Code/cipher-box/apps/desktop && pnpm exec tsc --noEmit` passes.
    Grep for `loginWithWallet` in auth.ts returns a match.
    Grep for `wallet-btn` in main.ts returns a match.
    Grep for `/auth/identity/wallet` in auth.ts returns matches for both nonce and verify endpoints.
  </verify>
  <done>
    SIWE wallet login implemented: injected provider detection, SIWE message creation (EIP-4361), signature request, CipherBox API verification, Core Kit loginWithJWT. Login UI includes wallet button alongside Google and Email. REQUIRED_SHARE handling reuses the same MFA UI from Plan 05.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles cleanly
- loginWithWallet function creates SIWE message matching web app format
- SIWE verification uses CipherBox API /auth/identity/wallet/* endpoints
- After SIWE verification, Core Kit loginWithJWT produces same keypair as other auth methods
- Wallet button visible on login screen
- Missing wallet provider shows clear error message
</verification>

<success_criteria>

1. Desktop login screen shows "Connect Wallet" button
2. Wallet login creates SIWE message and requests signature from injected provider
3. CipherBox API verifies SIWE signature and issues JWT
4. Core Kit loginWithJWT succeeds with the CipherBox JWT
5. User accesses same vault regardless of auth method (Google, Email, or Wallet)
   </success_criteria>

<output>
After completion, create `.planning/phases/11.1-macos-desktop-catch-up/11.1-07-SUMMARY.md`
</output>
