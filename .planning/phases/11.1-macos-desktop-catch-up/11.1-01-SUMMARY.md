---
phase: 11.1-macos-desktop-catch-up
plan: 01
subsystem: crypto
tags: [hkdf, aes-ctr, ed25519, ipns, rust, serde]

requires:
  - phase: 12.6
    provides: Per-file IPNS metadata types (FilePointer, FileMetadata)
  - phase: 12.1
    provides: AES-256-CTR encryption/decryption (Web Crypto implementation)
  - phase: 09
    provides: Existing Rust crypto module (AES-GCM, Ed25519, IPNS, ECIES)
provides:
  - HKDF-SHA256 derivation functions for vault, file, and registry IPNS keypairs (Rust)
  - AES-256-CTR encrypt, decrypt, and range decrypt functions (Rust)
  - v2 FolderMetadata types with FilePointer and FileMetadata (Rust)
  - Version-dispatched folder metadata parsing (AnyFolderMetadata)
affects:
  - 11.1-02 (vault metadata + per-file IPNS resolution needs HKDF + v2 types)
  - 11.1-03 (FUSE file read needs AES-CTR range decrypt)
  - 11.1-04 (FUSE upload needs AES-CTR encrypt + v2 folder metadata)

tech-stack:
  added: [hkdf 0.12, sha2 0.10, aes 0.8, ctr 0.9]
  patterns:
    [
      HKDF domain separation via info string,
      Ctr64BE matching Web Crypto length:64,
      serde default for optional fields,
    ]

key-files:
  created:
    - apps/desktop/src-tauri/src/crypto/hkdf.rs
    - apps/desktop/src-tauri/src/crypto/aes_ctr.rs
  modified:
    - apps/desktop/src-tauri/Cargo.toml
    - apps/desktop/src-tauri/src/crypto/mod.rs
    - apps/desktop/src-tauri/src/crypto/folder.rs
    - apps/desktop/src-tauri/src/crypto/tests.rs

key-decisions:
  - 'Ctr64BE cipher type matches Web Crypto AES-CTR with length:64 for cross-platform compatibility'
  - 'HKDF helper factored into internal derive_ipns_keypair to avoid code duplication across three public functions'
  - 'FileMetadata encryptionMode defaults to GCM via serde default, matching TypeScript optional field behavior'

patterns-established:
  - 'HKDF domain separation: same salt, different info strings for vault/file/registry'
  - 'AES-CTR range decrypt: compute block-aligned range, adjust counter, slice result'
  - 'AnyFolderMetadata version dispatch: decrypt, check version field, deserialize to correct type'

duration: 7min
completed: 2026-02-17
---

# Phase 11.1 Plan 01: Crypto Primitives Summary

**HKDF-SHA256 deterministic IPNS derivation, AES-256-CTR encrypt/decrypt/range, and v2 folder metadata types in Rust**

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-17T16:41:05Z
- **Completed:** 2026-02-17T16:48:12Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments

- Three HKDF derivation functions (vault, file, registry) producing deterministic Ed25519 keypairs and IPNS names matching web app output
- AES-256-CTR encrypt, decrypt, and block-aligned range decrypt using Ctr64BE (matching Web Crypto length:64)
- v2 folder metadata types: FilePointer, FolderChildV2, FolderMetadataV2, AnyFolderMetadata, FileMetadata
- 20 new tests added, all 113 tests pass (cargo test)

## Task Commits

Each task was committed atomically:

1. **Task 1: HKDF derivation functions and AES-CTR primitives** - `af07c632e` (feat)
2. **Task 2: v2 folder schema types + FileMetadata type + tests** - `842f1082e` (feat)

## Files Created/Modified

- `apps/desktop/src-tauri/src/crypto/hkdf.rs` - HKDF-SHA256 derivation for vault, file, and registry IPNS keypairs
- `apps/desktop/src-tauri/src/crypto/aes_ctr.rs` - AES-256-CTR encrypt, decrypt, and range decrypt
- `apps/desktop/src-tauri/src/crypto/folder.rs` - Added FilePointer, FolderMetadataV2, FileMetadata, AnyFolderMetadata, encrypt/decrypt file metadata
- `apps/desktop/src-tauri/src/crypto/mod.rs` - Registered hkdf and aes_ctr modules
- `apps/desktop/src-tauri/src/crypto/tests.rs` - 20 new tests for HKDF, AES-CTR, and v2 types
- `apps/desktop/src-tauri/Cargo.toml` - Added hkdf, sha2, aes, ctr dependencies

## Decisions Made

- Used `Ctr64BE` cipher type to match Web Crypto API's `AES-CTR` with `length: 64` -- ensures cross-platform decryption compatibility
- Factored internal `derive_ipns_keypair` helper to avoid duplication across three public HKDF functions
- FileMetadata `encryptionMode` uses `#[serde(default = "default_encryption_mode")]` returning "GCM" -- matches TypeScript's optional field behavior for backward compatibility

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- HKDF derivation functions ready for vault metadata resolution in Plan 02
- AES-CTR range decrypt ready for FUSE streaming file reads in Plan 03
- v2 folder metadata types ready for parsing per-file IPNS metadata in Plans 02-04
- All new code is tested and compiles cleanly

---

_Phase: 11.1-macos-desktop-catch-up_
_Completed: 2026-02-17_
