---
phase: 11.1-macos-desktop-catch-up
plan: 06
subsystem: crypto
tags: [device-registry, ecies, hkdf, ipns, ipfs, keychain, rust]

# Dependency graph
requires:
  - phase: 11.1-01
    provides: HKDF derivation functions (derive_registry_ipns_keypair)
  - phase: 11.1-04
    provides: Core Kit auth flow (handle_auth_complete with private key)
  - phase: 12.2
    provides: Web app device registry types and service (DeviceEntry, DeviceRegistry)
provides:
  - Rust device registry module with types matching web app TypeScript definitions
  - ECIES-encrypted registry CRUD (register, fetch, decrypt)
  - Non-blocking device registration after auth via tokio::spawn
  - Persistent device ID via macOS Keychain
affects: [11.1-07]

# Tech tracking
tech-stack:
  added: [hostname 0.4]
  patterns:
    - Fire-and-forget tokio::spawn for non-blocking registry operations
    - Keychain-backed persistent device ID (keyring crate)
    - serde rename_all camelCase for cross-platform JSON compatibility

key-files:
  created:
    - apps/desktop/src-tauri/src/registry/mod.rs
    - apps/desktop/src-tauri/src/registry/types.rs
  modified:
    - apps/desktop/src-tauri/src/main.rs
    - apps/desktop/src-tauri/src/commands.rs
    - apps/desktop/src-tauri/Cargo.toml

key-decisions:
  - 'Typed enums (DeviceAuthStatus, DevicePlatform) instead of raw strings for serde type safety'
  - 'Fire-and-forget tokio::spawn pattern: registry failures logged but never block login'
  - 'Persistent device ID via macOS Keychain with UUID v4 generation fallback'

patterns-established:
  - 'Non-blocking post-auth side effects: clone Arc refs, spawn task, log outcome'
  - 'Cross-platform type matching: Rust serde enums with rename_all lowercase match TypeScript string unions'

# Metrics
duration: 4min
completed: 2026-02-17
---

# Phase 11.1 Plan 06: Device Registry Summary

**ECIES-encrypted device registry client in Rust with non-blocking registration after auth, persistent Keychain device ID, and HKDF-derived IPNS publishing**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-17T17:54:53Z
- **Completed:** 2026-02-17T17:59:14Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments

- Device registry types (DeviceEntry, DeviceRegistry) matching web app's TypeScript definitions with typed serde enums
- Full register/fetch/decrypt cycle: HKDF-derived IPNS name, ECIES encrypt/decrypt, IPFS upload, IPNS publish
- Non-blocking registration call in handle_auth_complete via tokio::spawn -- failures never block login
- 7 new unit tests for serialization, deserialization, status/platform variants, and helper functions (120 total tests pass)

## Task Commits

Each task was committed atomically:

1. **Task 1: Device registry types and service** - `b77a4ac93` (feat)
2. **Task 2: Non-blocking registry call in auth flow** - `ae69edeb6` (feat)

## Files Created/Modified

- `apps/desktop/src-tauri/src/registry/types.rs` - DeviceEntry, DeviceRegistry, DeviceAuthStatus, DevicePlatform types with camelCase serde
- `apps/desktop/src-tauri/src/registry/mod.rs` - register_device, fetch_and_decrypt_registry, get_or_create_device_id, helper functions, 7 tests
- `apps/desktop/src-tauri/src/main.rs` - Added `mod registry` declaration
- `apps/desktop/src-tauri/src/commands.rs` - Non-blocking tokio::spawn registry call after auth step 8
- `apps/desktop/src-tauri/Cargo.toml` - Added hostname 0.4 dependency

## Decisions Made

- **Typed enums over raw strings**: Used `DeviceAuthStatus` and `DevicePlatform` enums with `serde(rename_all = "lowercase")` instead of bare strings. Provides compile-time safety while serializing to the same JSON strings as the web app.
- **Fire-and-forget pattern**: The registry call is wrapped in `tokio::spawn` with cloned `Arc<ApiClient>` and key copies. The spawned task logs success/failure but never propagates errors back to the auth flow.
- **Keychain-backed device ID**: Uses `keyring` crate (already a dependency) with service "cipherbox-desktop" and key "device-id". Deletes before writing to avoid macOS "already exists" error (known gotcha from MEMORY.md).

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Desktop device registration complete: appears in web app's Authorized Devices view after login
- Registry IPNS name matches web app derivation (same HKDF salt + info)
- Ready for Plan 07 (if any) or phase completion
- All 120 tests pass, cargo check clean (warnings only from pre-existing code)

---

_Phase: 11.1-macos-desktop-catch-up_
_Completed: 2026-02-17_
