---
phase: 11.1-macos-desktop-catch-up
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop/src-tauri/src/api/types.rs
  - apps/desktop/src-tauri/src/api/ipns.rs
  - apps/desktop/src-tauri/src/crypto/ed25519.rs
  - apps/desktop/src-tauri/src/sync/mod.rs
  - apps/desktop/src/auth.ts
  - apps/desktop/src-tauri/src/main.rs
  - apps/desktop/src-tauri/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "Debug output for LoginRequest, LoginResponse, RefreshRequest, RefreshResponse redacts token and key fields with '[REDACTED]'"
    - 'IPNS resolve URL-encodes the ipnsName query parameter'
    - "console.log('Got private key, length:') line is removed from auth.ts"
    - 'Ed25519 key_bytes stack copy is zeroized after SigningKey creation'
    - 'Sync daemon error messages shown in tray status are sanitized (no raw API responses or internal paths)'
    - 'Desktop accepts --dev-key <hex> in debug builds to bypass Web3Auth login'
  artifacts:
    - path: 'apps/desktop/src-tauri/src/api/types.rs'
      provides: 'Manual Debug impls that redact sensitive fields'
      contains: 'impl fmt::Debug'
    - path: 'apps/desktop/src-tauri/src/api/ipns.rs'
      provides: 'URL-encoded IPNS name in resolve query'
      contains: 'urlencoding'
    - path: 'apps/desktop/src-tauri/src/crypto/ed25519.rs'
      provides: 'Zeroized key_bytes after SigningKey creation'
      contains: 'zeroize'
    - path: 'apps/desktop/src-tauri/src/sync/mod.rs'
      provides: 'Sanitized error messages in tray status updates'
      contains: 'sanitize_error'
    - path: 'apps/desktop/src-tauri/src/main.rs'
      provides: 'CLI arg parsing with --dev-key for debug builds'
      contains: 'dev_key'
  key_links:
    - from: 'apps/desktop/src-tauri/src/main.rs'
      to: 'apps/desktop/src-tauri/src/state.rs'
      via: 'dev_key stored in AppState for use by auth flow'
      pattern: 'dev_key'
---

<objective>
Fix all security backlog items (M-11, L-2, L-4, L-5, L-7) and add --dev-key CLI argument for headless auth in debug builds.

Purpose: Address security findings from the review. The --dev-key flag enables automated testing without Web3Auth login, unblocking CI for desktop builds.

Output: Updated Rust and TypeScript files with security fixes applied, plus CLI arg parsing for dev mode.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Files to modify

@apps/desktop/src-tauri/src/api/types.rs
@apps/desktop/src-tauri/src/api/ipns.rs
@apps/desktop/src-tauri/src/crypto/ed25519.rs
@apps/desktop/src-tauri/src/sync/mod.rs
@apps/desktop/src/auth.ts
@apps/desktop/src-tauri/src/main.rs
@apps/desktop/src-tauri/src/state.rs
@apps/desktop/src-tauri/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Security fixes M-11, L-2, L-4, L-5, L-7</name>
  <files>
    apps/desktop/src-tauri/src/api/types.rs
    apps/desktop/src-tauri/src/api/ipns.rs
    apps/desktop/src-tauri/src/crypto/ed25519.rs
    apps/desktop/src-tauri/src/sync/mod.rs
    apps/desktop/src/auth.ts
    apps/desktop/src-tauri/Cargo.toml
  </files>
  <action>
    **M-11: Manual Debug impls for auth DTOs** (`api/types.rs`):
    - Remove `#[derive(Debug)]` from LoginRequest, LoginResponse, RefreshRequest, RefreshResponse
    - Add `impl fmt::Debug` for each that redacts sensitive fields:
      - LoginRequest: show login_type, redact id_token and public_key
      - LoginResponse: show is_new_user, redact access_token and refresh_token
      - RefreshRequest: redact refresh_token
      - RefreshResponse: redact access_token and refresh_token
    - Format: `LoginRequest { id_token: "[REDACTED]", public_key: "[REDACTED]", login_type: "..." }`
    - Add `use std::fmt;` at top of file
    - Keep `#[derive(Debug)]` on TeeKeysResponse, InitVaultRequest, VaultResponse (no sensitive fields)

    **L-2: URL-encode IPNS name** (`api/ipns.rs`):
    - Add `urlencoding = "2"` to Cargo.toml dependencies
    - Change line 29 from `format!("/ipns/resolve?ipnsName={}", ipns_name)` to `format!("/ipns/resolve?ipnsName={}", urlencoding::encode(ipns_name))`

    **L-4: Remove console.log key length leak** (`auth.ts`):
    - Delete line 167: `console.log('Got private key, length:', privateKey.length);`
    - Replace with nothing, or a non-leaking log: `console.log('Private key extracted');`

    **L-5: Zeroize Ed25519 key_bytes stack copy** (`crypto/ed25519.rs`):
    - In `sign_ed25519()`, after `let signing_key = SigningKey::from_bytes(&key_bytes);`, add `key_bytes.zeroize();`
    - Add `use zeroize::Zeroize;` at top
    - The zeroize crate is already in Cargo.toml with the `derive` feature

    **L-7: Sanitize sync daemon error messages** (`sync/mod.rs`):
    - Add a `sanitize_error(error: &str) -> String` function that:
      - Strips API response bodies (truncate after first newline or at 80 chars)
      - Removes internal paths (replace patterns matching `/Users/...` or `/home/...` with `[path]`)
      - Removes token-like strings (replace hex strings >40 chars with `[token]`)
    - Replace line 161 `&crate::tray::TrayStatus::Error(e)` with `&crate::tray::TrayStatus::Error(sanitize_error(&e))`
    - Change the `e` binding at line 145 to pass through sanitize_error before tray display

  </action>
  <verify>
    `cd /Users/michael/Code/cipher-box/apps/desktop/src-tauri && cargo check` compiles without errors.
    Grep for `console.log.*private.*key.*length` in auth.ts returns 0 results.
    Grep for `#[derive(Debug)]` on LoginRequest/LoginResponse/RefreshRequest/RefreshResponse returns 0 results.
  </verify>
  <done>
    All 5 security fixes applied: M-11 (debug redaction), L-2 (URL encoding), L-4 (console.log removed), L-5 (ed25519 zeroize), L-7 (error sanitization). Code compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: --dev-key CLI argument for headless auth</name>
  <files>
    apps/desktop/src-tauri/Cargo.toml
    apps/desktop/src-tauri/src/main.rs
    apps/desktop/src-tauri/src/state.rs
    apps/desktop/src-tauri/src/commands.rs
  </files>
  <action>
    1. Add `clap = { version = "4", features = ["derive"] }` to Cargo.toml dependencies.

    2. In `main.rs`, add CLI arg parsing gated by `#[cfg(debug_assertions)]`:
       ```rust
       #[cfg(debug_assertions)]
       mod cli {
           use clap::Parser;
           #[derive(Parser, Debug)]
           #[command(name = "cipherbox-desktop")]
           pub struct Args {
               /// Hex-encoded secp256k1 private key for headless auth (debug only)
               #[arg(long)]
               pub dev_key: Option<String>,
           }
       }
       ```

    3. In `main()`, parse CLI args before Tauri builder (debug builds only):
       ```rust
       #[cfg(debug_assertions)]
       let dev_key: Option<String> = {
           use clap::Parser;
           let args = cli::Args::parse();
           args.dev_key
       };
       #[cfg(not(debug_assertions))]
       let dev_key: Option<String> = None;
       ```

    4. Add `dev_key: RwLock<Option<String>>` to `AppState` in `state.rs`.
       Update `AppState::new()` to accept an optional dev_key parameter.
       Update `clear_keys()` to clear dev_key.

    5. Pass dev_key to AppState in main.rs: `AppState::new(&api_base_url, dev_key)`.

    6. Add a new Tauri command `get_dev_key` in `commands.rs`:
       ```rust
       #[tauri::command]
       pub async fn get_dev_key(state: State<'_, AppState>) -> Result<Option<String>, String> {
           Ok(state.dev_key.read().await.clone())
       }
       ```
       Register it in the invoke_handler in main.rs.

    This allows the webview to check if a dev-key was provided and skip Web3Auth login,
    directly calling handle_auth_complete with a synthetic idToken (or using the test-login endpoint).

  </action>
  <verify>
    `cd /Users/michael/Code/cipher-box/apps/desktop/src-tauri && cargo check` compiles.
    `cd /Users/michael/Code/cipher-box/apps/desktop/src-tauri && cargo build 2>&1 | grep -i error` shows no errors.
  </verify>
  <done>
    --dev-key CLI arg parsed in debug builds only, stored in AppState, accessible via Tauri IPC command `get_dev_key`. Release builds ignore the argument entirely (compiled out via cfg).
  </done>
</task>

</tasks>

<verification>
- `cargo check` and `cargo build` succeed
- No sensitive data in Debug output for auth DTOs
- IPNS resolve properly URL-encodes query parameter
- No console.log key length leak in auth.ts
- Ed25519 stack key zeroized after use
- Sync daemon error messages sanitized before tray display
- `--dev-key` accepted in debug builds, rejected (ignored) in release builds
</verification>

<success_criteria>

1. All 5 security fixes pass code review (M-11, L-2, L-4, L-5, L-7)
2. --dev-key CLI arg works in debug builds, compiled out in release
3. `cargo check` and `cargo test` pass
   </success_criteria>

<output>
After completion, create `.planning/phases/11.1-macos-desktop-catch-up/11.1-02-SUMMARY.md`
</output>
