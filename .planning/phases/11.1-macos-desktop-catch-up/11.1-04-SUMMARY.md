---
phase: 11.1-macos-desktop-catch-up
plan: 04
subsystem: auth
tags: [web3auth, core-kit, tauri, google-oauth, email-otp, identity-provider]

# Dependency graph
requires:
  - phase: 12
    provides: Core Kit identity provider backend (JWKS, Google OAuth, Email OTP endpoints)
  - phase: 11.1-02
    provides: Dev-key CLI argument, security fixes
provides:
  - Desktop Core Kit auth via CipherBox identity provider
  - CipherBox-branded login UI (Google + Email OTP)
  - loginType 'corekit' for backend auth
  - REQUIRED_SHARE stub UI for MFA
affects: [11.1-05, 11.1-06]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Google Identity Services (GIS) loaded dynamically in Tauri webview
    - CipherBox JWT double-use pattern (Core Kit + backend auth)
    - AnyFolderMetadata to_v1() conversion for FUSE backward compat

key-files:
  created:
    - apps/desktop/src/vite-env.d.ts
  modified:
    - apps/desktop/package.json
    - apps/desktop/src/auth.ts
    - apps/desktop/src/main.ts
    - apps/desktop/src-tauri/src/commands.rs
    - apps/desktop/src-tauri/src/crypto/folder.rs
    - apps/desktop/src-tauri/src/fuse/inode.rs
    - apps/desktop/src-tauri/src/fuse/mod.rs
    - apps/desktop/src-tauri/src/fuse/operations.rs

key-decisions:
  - 'AnyFolderMetadata gets Clone/Debug derives and to_v1() helper for FUSE compat'
  - 'Dev-key auth flow uses test-login endpoint for CI/debug builds'

patterns-established:
  - 'CipherBox login UI: Google GIS button + Email OTP send/verify in vanilla TS'
  - 'REQUIRED_SHARE stub pattern: show MFA info with back-to-login button'

# Metrics
duration: 8min
completed: 2026-02-17
---

# Phase 11.1 Plan 04: Core Kit Auth Migration Summary

**Desktop auth migrated from PnP Modal SDK to Core Kit loginWithJWT via CipherBox identity provider with branded Google/Email login UI**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-17T17:42:38Z
- **Completed:** 2026-02-17T17:50:26Z
- **Tasks:** 2
- **Files modified:** 9

## Accomplishments

- Replaced PnP Modal SDK (@web3auth/modal) with MPC Core Kit (@web3auth/mpc-core-kit)
- Rewrote main.ts with CipherBox-branded login UI: Google OAuth button, Email OTP send/verify flow
- Changed backend loginType from 'social' to 'corekit' in Rust commands
- Added REQUIRED_SHARE stub UI for MFA-enabled accounts (full MFA in Plan 05)
- Fixed AnyFolderMetadata compilation by adding Clone/Debug derives

## Task Commits

Each task was committed atomically:

1. **Task 1: Core Kit SDK setup and auth.ts rewrite** - `052007e` (feat)
2. **Task 2: Login UI in main.ts + Rust loginType update** - `a1077fc` (feat)

## Files Created/Modified

- `apps/desktop/src/vite-env.d.ts` - Vite client type reference for import.meta.env
- `apps/desktop/package.json` - Replaced @web3auth/modal with @web3auth/mpc-core-kit + tss-dkls-lib
- `apps/desktop/src/auth.ts` - Core Kit loginWithJWT, Google GIS, Email OTP via CipherBox identity provider
- `apps/desktop/src/main.ts` - CipherBox-branded login form with Google + Email OTP + MFA stub
- `apps/desktop/src-tauri/src/commands.rs` - loginType changed from 'social' to 'corekit'
- `apps/desktop/src-tauri/src/crypto/folder.rs` - Clone/Debug + to_v1() for AnyFolderMetadata
- `apps/desktop/src-tauri/src/fuse/inode.rs` - v2 folder metadata inode population
- `apps/desktop/src-tauri/src/fuse/mod.rs` - AnyFolderMetadata handling in mount and refresh
- `apps/desktop/src-tauri/src/fuse/operations.rs` - v2 metadata decryption and FilePointer resolution

## Decisions Made

- **AnyFolderMetadata Clone/Debug derives**: Required for FUSE cache and refresh code. Added to_v1() helper that converts v2 FilePointers to placeholder FileEntries for backward compatibility.
- **Dev-key auth via test-login endpoint**: Debug builds use `POST /auth/test-login` to get a JWT, then invoke `handle_auth_complete` with the dev key directly, bypassing Core Kit entirely.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] AnyFolderMetadata missing Clone derive broke FUSE compilation**

- **Found during:** Task 2 (cargo check verification)
- **Issue:** Prior plan added `AnyFolderMetadata` enum without Clone/Debug derives; FUSE code (inode.rs, mod.rs, operations.rs) had uncommitted v2 metadata handling that required Clone on AnyFolderMetadata
- **Fix:** Added `#[derive(Debug, Clone)]` to AnyFolderMetadata, added `to_v1()` and `children_len()` helper methods, included uncommitted FUSE v2 handling code
- **Files modified:** crypto/folder.rs, fuse/inode.rs, fuse/mod.rs, fuse/operations.rs
- **Verification:** `cargo check` passes cleanly (warnings only)
- **Committed in:** a1077fc (Task 2 commit)

**2. [Rule 1 - Bug] Unused variable lint error in auth.ts catch block**

- **Found during:** Task 1 (pre-commit hook)
- **Issue:** `catch (err)` block didn't use `err` variable, ESLint `@typescript-eslint/no-unused-vars` error
- **Fix:** Changed to `catch { ... }` (no binding)
- **Files modified:** auth.ts
- **Verification:** ESLint passes
- **Committed in:** 052007e (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (1 blocking, 1 bug)
**Impact on plan:** Both auto-fixes necessary for compilation. No scope creep.

## Issues Encountered

None - the auth.ts had already been rewritten to Core Kit in a prior plan's working tree changes. Task 1 was primarily a verification and commit of that existing work.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Desktop auth flow complete: Core Kit loginWithJWT via CipherBox identity provider
- Ready for Plan 05 (MFA challenge UI) to replace the REQUIRED_SHARE stub
- Ready for Plan 06 (per-file IPNS) to use the v2 folder metadata handling now compiled

---

_Phase: 11.1-macos-desktop-catch-up_
_Completed: 2026-02-17_
