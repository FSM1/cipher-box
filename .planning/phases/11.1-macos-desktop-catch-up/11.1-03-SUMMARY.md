---
phase: 11.1-macos-desktop-catch-up
plan: 03
subsystem: fuse
tags: [hkdf, aes-ctr, aes-gcm, ipns, fuse, nfs, v2-metadata, file-pointer, rust]

requires:
  - phase: 11.1-01
    provides: HKDF derivation functions, AES-CTR primitives, v2 folder metadata types
  - phase: 12.6
    provides: Per-file IPNS metadata split design (FilePointer, FileMetadata)
  - phase: 12.1
    provides: AES-256-CTR encryption scheme (Web Crypto reference implementation)
provides:
  - HKDF-based deterministic vault IPNS derivation in initialize_vault (replaces random keygen)
  - v2 FolderMetadata parsing in FUSE layer (FilePointer IPNS resolution)
  - AES-CTR decryption dispatch in FUSE read() for streaming media files
  - Backward-compatible AES-GCM decryption for v1 files
  - Eager FilePointer resolution before NFS mount for READDIR stability
affects:
  - 11.1-04 (Core Kit migration uses loginType change already in commands.rs)
  - 11.1-05 (upload pipeline can build on v2-aware FUSE layer)

tech-stack:
  added: []
  patterns:
    [
      AnyFolderMetadata version dispatch in FUSE operations,
      Eager FilePointer IPNS resolution before mount for NFS stability,
      Synthetic v1 FolderMetadata cache entries for v2 folders,
      CTR vs GCM decryption dispatch based on encryption_mode field,
    ]

key-files:
  created: []
  modified:
    - apps/desktop/src-tauri/src/commands.rs
    - apps/desktop/src-tauri/src/fuse/inode.rs
    - apps/desktop/src-tauri/src/fuse/operations.rs
    - apps/desktop/src-tauri/src/fuse/mod.rs
    - apps/desktop/src-tauri/src/crypto/folder.rs

key-decisions:
  - "Keep v1 output format for write-back (build_folder_metadata) -- desktop doesn't create per-file IPNS records; web app handles both formats"
  - "Store synthetic v1 FolderMetadata in MetadataCache for v2 folders (version='v2', empty children) -- preserves cache staleness-check without changing cache API"
  - 'Eager FilePointer resolution in populate_folder and mount pre-population -- NFS requires first READDIR to be correct'

patterns-established:
  - 'populate_folder_any version dispatch: delegates to populate_folder (v1) or populate_folder_v2 (v2)'
  - 'Encryption mode dispatch in read/open: CTR uses 16-byte IV with Ctr64BE, GCM uses 12-byte IV'
  - 'resolve_file_pointers_blocking: iterate unresolved inodes, IPNS resolve -> fetch CID -> decrypt FileMetadata'

duration: 8min
completed: 2026-02-17
---

# Phase 11.1 Plan 03: HKDF Vault Init + v2 FUSE Metadata Summary

**Deterministic HKDF vault IPNS derivation in commands.rs, v2 folder metadata with FilePointer resolution in FUSE layer, and AES-CTR/GCM decryption dispatch in read()**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-17T16:49:00Z
- **Completed:** 2026-02-17T16:57:00Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments

- initialize_vault uses HKDF deterministic derivation instead of random Ed25519 keygen, with backward-compatible verification in fetch_and_decrypt_vault
- FUSE layer parses both v1 (inline FileEntry) and v2 (FilePointer) folder metadata via AnyFolderMetadata dispatch
- Per-file IPNS resolution: FilePointers resolved eagerly before NFS mount, updating inode with real CID/IV/key/size/encryptionMode
- AES-CTR decryption for streaming media files alongside existing AES-GCM for standard files, dispatched by encryption_mode field
- All 113 cargo tests pass, no FUSE/NFS stability regressions

## Task Commits

Each task was committed atomically:

1. **Task 1: HKDF vault initialization in commands.rs** - `bf7a8f5a7` (feat)
2. **Task 2: v2 folder metadata + CTR decryption in FUSE layer** - `a1077fca6` (feat, bundled with Plan 04 commit)

**Note:** Task 2 changes were committed together with Plan 04 work by a parallel executor that picked up the uncommitted FUSE files. The code is correct and complete.

## Files Created/Modified

- `apps/desktop/src-tauri/src/commands.rs` - HKDF vault IPNS derivation in initialize_vault, verification in fetch_and_decrypt_vault
- `apps/desktop/src-tauri/src/fuse/inode.rs` - InodeKind::File with encryption_mode/file_meta_ipns_name/file_meta_resolved fields, populate_folder_v2, populate_folder_any, resolve_file_pointer, get_unresolved_file_pointers
- `apps/desktop/src-tauri/src/fuse/operations.rs` - decrypt_metadata_from_ipfs returns AnyFolderMetadata, CTR/GCM dispatch in read()/open(), resolve_file_pointers_blocking, decrypt_file_metadata_from_ipfs
- `apps/desktop/src-tauri/src/fuse/mod.rs` - PendingRefresh uses AnyFolderMetadata, drain_refresh_completions handles v2, mount pre-population resolves FilePointers eagerly
- `apps/desktop/src-tauri/src/crypto/folder.rs` - Added Clone/Debug derives and to_v1() helper on AnyFolderMetadata

## Decisions Made

- **Keep v1 write-back format:** build_folder_metadata still produces v1 FolderMetadata for write operations. Desktop doesn't create per-file IPNS records; the web app handles both v1/v2 input. Avoids large architectural change to spawn_metadata_publish and the entire release/mkdir/rename flow.
- **Synthetic v1 cache entries for v2 folders:** MetadataCache stores FolderMetadata with version="v2" and empty children for v2 folders. Preserves cache staleness-check functionality without changing the cache API surface.
- **Eager FilePointer resolution:** All FilePointers resolved before first READDIR (in populate_folder and mount pre-population), per FUSE-T NFS requirements. NFS client caches READDIR aggressively and does LOOKUP for every entry -- unresolved files would cause stale handle errors.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Task 2 committed with Plan 04 changes**

- **Found during:** Task 2 wrap-up
- **Issue:** A parallel Plan 04 executor committed the uncommitted FUSE files (inode.rs, operations.rs, mod.rs) together with its own login UI changes in commit a1077fca6
- **Fix:** No fix needed -- the code is correct and present in the tree. Documented in summary for traceability.
- **Impact:** Task 2 does not have its own isolated commit, but all changes are in the repo

**2. [Rule 2 - Missing Critical] Added Clone/Debug derives on AnyFolderMetadata**

- **Found during:** Task 2 (FUSE layer integration)
- **Issue:** AnyFolderMetadata needed Clone for passing between FUSE callback contexts and Debug for logging
- **Fix:** Added derives in crypto/folder.rs along with to_v1() helper method
- **Files modified:** apps/desktop/src-tauri/src/crypto/folder.rs
- **Committed in:** a1077fca6

---

**Total deviations:** 2 (1 commit bundling, 1 missing critical derives)
**Impact on plan:** All code is correct and complete. Commit history is slightly less granular than planned due to parallel executor overlap.

## Issues Encountered

- **Edit tool race condition:** One edit to mod.rs failed with "File has been modified since read" -- likely a linter reformatted the file after a previous edit. Re-read the file and retried successfully.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- FUSE layer fully handles v2 metadata from web app uploads
- CTR-encrypted media files will decrypt correctly when read through the mount
- GCM files continue to work unchanged (backward compatible)
- Ready for Plan 04 (Core Kit auth migration) and Plan 05 (upload pipeline)

---

_Phase: 11.1-macos-desktop-catch-up_
_Completed: 2026-02-17_
