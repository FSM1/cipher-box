# Phase 6.3: UI Structure Refactor - Research

**Researched:** 2026-01-30
**Domain:** React component architecture, fixed layout systems, folder navigation patterns
**Confidence:** HIGH

## Summary

This phase involves a significant structural redesign of the CipherBox web application UI. The key changes are:

1. Moving from a flexible layout to a fixed app shell (header, sidebar, footer all fixed; only content scrolls)
2. Converting the sidebar from a folder tree to app-level navigation (major architectural change)
3. Implementing in-place folder navigation with browser history integration
4. Adding new components: Footer, UserMenu dropdown, Storage quota indicator, Refresh button

The current codebase uses React 18.3 with react-router-dom 7.12, Zustand 5.0 for state management, and a terminal/hacker aesthetic with JetBrains Mono font and green-on-black colors. The existing architecture is well-structured with clear separation between routes, components, hooks, and stores.

**Primary recommendation:** Implement changes incrementally - start with AppShell layout restructure, then navigation system changes, then individual component updates. Use CSS Grid for the fixed layout and leverage existing stores for state management.

## Standard Stack

The established libraries/tools for this phase:

### Core (Already in use - no changes)

| Library          | Version | Purpose              | Why Standard                        |
| ---------------- | ------- | -------------------- | ----------------------------------- |
| react            | ^18.3.1 | UI framework         | Project foundation                  |
| react-router-dom | ^7.12.0 | Routing & navigation | Browser history integration         |
| zustand          | ^5.0.10 | State management     | Already used for vault/folder state |

### Supporting (No new dependencies needed)

| Library            | Version  | Purpose                      | When to Use        |
| ------------------ | -------- | ---------------------------- | ------------------ |
| @floating-ui/react | ^0.27.16 | Tooltip/dropdown positioning | User menu dropdown |

### Alternatives Considered

| Instead of  | Could Use | Tradeoff                                           |
| ----------- | --------- | -------------------------------------------------- |
| CSS Grid    | Flexbox   | Grid better for fixed layout with named areas      |
| Floating UI | CSS hover | Floating UI already in project, handles edge cases |

**Installation:**

```bash
# No new packages required
```

## Architecture Patterns

### Current Component Hierarchy

```text
App.tsx
  AppRoutes (react-router)
    Login.tsx
    Dashboard.tsx
      FileBrowser.tsx
        FolderTree.tsx (REMOVE/REPLACE)
        Toolbar (inline)
        FileList.tsx
        EmptyState.tsx
        UploadModal.tsx
        Dialogs...
    Settings.tsx
```

### Target Component Hierarchy

```text
App.tsx
  AppRoutes (react-router)
    Login.tsx
    AppShell.tsx (NEW - wraps authenticated routes)
      Header.tsx (NEW)
        Logo
        UserMenu.tsx (NEW - dropdown)
      Sidebar.tsx (NEW - replaces FolderTree)
        NavItem (Files)
        NavItem (Settings)
        StorageQuota.tsx (NEW)
      Main (children slot)
        FileBrowserPage.tsx (replaces Dashboard content)
          Toolbar (breadcrumbs + actions)
          FileList.tsx (MODIFY)
          EmptyState.tsx (MODIFY)
        SettingsPage.tsx
      Footer.tsx (NEW)
        Copyright
        Links
        StatusIndicator
    // Login stays outside AppShell
```

### Pattern 1: Fixed App Shell with CSS Grid

**What:** Container with fixed header/sidebar/footer and scrollable content area
**When to use:** When navigation and status should always be visible
**Example:**

```css
/* AppShell layout */
.app-shell {
  display: grid;
  grid-template-rows: auto 1fr auto;
  grid-template-columns: auto 1fr;
  grid-template-areas:
    'header header'
    'sidebar main'
    'footer footer';
  height: 100vh;
  overflow: hidden;
}

.app-header {
  grid-area: header;
  position: sticky;
  top: 0;
}
.app-sidebar {
  grid-area: sidebar;
  position: sticky;
  top: 0;
  height: calc(100vh - header - footer);
  overflow-y: auto;
}
.app-main {
  grid-area: main;
  overflow-y: auto;
}
.app-footer {
  grid-area: footer;
  position: sticky;
  bottom: 0;
}
```

### Pattern 2: URL-based Folder Navigation

**What:** Encode current folder path in URL for browser history support
**When to use:** When users should be able to use back/forward buttons
**Example:**

```typescript
// Update useFolderNavigation to use React Router
function useFolderNavigation() {
  const navigate = useNavigate();
  const { folderId = 'root' } = useParams<{ folderId?: string }>();

  const navigateTo = useCallback(
    (id: string) => {
      navigate(id === 'root' ? '/files' : `/files/${id}`);
    },
    [navigate]
  );

  const navigateUp = useCallback(() => {
    const parentId = currentFolder?.parentId ?? 'root';
    navigateTo(parentId);
  }, [currentFolder, navigateTo]);

  return { currentFolderId: folderId, navigateTo, navigateUp };
}
```

### Pattern 3: Hover-triggered Dropdown

**What:** User menu that opens on hover (not click)
**When to use:** Per CONTEXT.md decision for header user menu
**Example:**

```typescript
function UserMenu({ email }: { email: string }) {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <div
      className="user-menu"
      onMouseEnter={() => setIsOpen(true)}
      onMouseLeave={() => setIsOpen(false)}
    >
      <span className="user-email">{email} â–¼</span>
      {isOpen && (
        <div className="user-menu-dropdown">
          <Link to="/settings">[settings]</Link>
          <button onClick={logout}>[logout]</button>
        </div>
      )}
    </div>
  );
}
```

### Anti-Patterns to Avoid

- **Nested scrolling containers:** Only one scrolling container (main content area) should exist
- **Storing navigation state only in React state:** Use URL as source of truth for folder location
- **Coupling sidebar to file browser:** Sidebar is app-level nav, not folder-specific

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem                  | Don't Build                 | Use Instead                            | Why                                          |
| ------------------------ | --------------------------- | -------------------------------------- | -------------------------------------------- |
| Dropdown positioning     | Custom position calculation | @floating-ui/react                     | Edge cases (viewport boundaries) are complex |
| Storage quota formatting | Manual byte formatting      | Existing formatBytes utility           | Already exists in codebase                   |
| Route-based folder state | Custom history integration  | react-router-dom useParams/useNavigate | Already using react-router                   |

**Key insight:** The codebase already has utilities and patterns for most needs - reuse them.

## Common Pitfalls

### Pitfall 1: Breaking File Operations When Restructuring

**What goes wrong:** Moving FileBrowser component breaks drag-drop, context menus, upload
**Why it happens:** These features rely on parent-child relationships and event bubbling
**How to avoid:** Keep FileBrowser's internal structure intact; only change its container
**Warning signs:** Drag-drop stops working, context menus appear in wrong position

### Pitfall 2: Mobile Sidebar Regression

**What goes wrong:** Fixed layout breaks mobile overlay behavior
**Why it happens:** CSS Grid layout conflicts with position: fixed for mobile overlay
**How to avoid:** Use media queries to switch between grid (desktop) and flex/fixed (mobile)
**Warning signs:** Sidebar doesn't slide in on mobile, backdrop doesn't appear

### Pitfall 3: Viewport Height Issues (100vh)

**What goes wrong:** Layout extends beyond viewport on mobile browsers
**Why it happens:** Mobile browsers have dynamic address bars; 100vh includes hidden area
**How to avoid:** Use `height: 100dvh` or `min-height: 100vh` with flex-grow
**Warning signs:** Page scrolls when it shouldn't, footer hidden behind browser UI

### Pitfall 4: Lost Folder State on Navigation

**What goes wrong:** User loses place in folder tree when navigating to settings and back
**Why it happens:** Folder state only exists in React component state
**How to avoid:** Keep folder ID in URL; restore state from URL on mount
**Warning signs:** Going to Settings and back returns user to root folder

### Pitfall 5: Breaking Existing Styles

**What goes wrong:** Terminal aesthetic inconsistencies after restructure
**Why it happens:** New components don't follow existing CSS variable patterns
**How to avoid:** Reference index.css variables for all colors, fonts, spacing
**Warning signs:** Mixed font sizes, wrong green shades, inconsistent borders

## Code Examples

Verified patterns from design file and existing codebase:

### AppShell Grid Layout

```css
/* Source: Phase 6.3 Pencil design */
.app-shell {
  display: grid;
  grid-template-rows: auto 1fr auto;
  grid-template-columns: 180px 1fr;
  grid-template-areas:
    'header header'
    'sidebar main'
    'footer footer';
  height: 100vh;
  background-color: var(--color-background);
}

@media (max-width: 768px) {
  .app-shell {
    grid-template-columns: 1fr;
    grid-template-areas:
      'header'
      'main'
      'footer';
  }
}
```

### Header Component Structure

```typescript
// Source: Phase 6.3 Pencil design (frame: appHeader, id: BwljC)
function AppHeader() {
  return (
    <header className="app-header">
      <div className="header-left">
        <span className="header-prompt">&gt;</span>
        <span className="header-logo">CIPHERBOX</span>
      </div>
      <div className="header-right">
        <UserMenu />
      </div>
    </header>
  );
}

/* CSS from design */
.app-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 24px;
  background-color: var(--color-background);
  border-bottom: 1px solid var(--color-border);
}
```

### Sidebar Navigation Component

```typescript
// Source: Phase 6.3 Pencil design (frame: sidebar, id: rckAN)
function AppSidebar() {
  const location = useLocation();

  return (
    <aside className="app-sidebar">
      <nav className="sidebar-nav">
        <NavItem
          to="/files"
          icon="folder"
          label="Files"
          active={location.pathname.startsWith('/files')}
        />
        <NavItem
          to="/settings"
          icon="settings"
          label="Settings"
          active={location.pathname === '/settings'}
        />
      </nav>
      <div className="sidebar-footer">
        <StorageQuota />
      </div>
    </aside>
  );
}

/* CSS from design */
.app-sidebar {
  width: 180px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  background-color: var(--color-background);
  border-right: 1px solid var(--color-green-darker); /* #003322 */
}
```

### Footer Component Structure

```typescript
// Source: Phase 6.3 Pencil design (frame: appFooter, id: 14qYa)
function AppFooter() {
  return (
    <footer className="app-footer">
      <div className="footer-left">
        <span className="footer-copyright">(c) 2026 CipherBox</span>
      </div>
      <div className="footer-center">
        <a href="#" className="footer-link">[help]</a>
        <a href="#" className="footer-link">[privacy]</a>
        <a href="#" className="footer-link">[terms]</a>
        <a href="https://github.com/..." className="footer-link">[github]</a>
      </div>
      <div className="footer-right">
        <StatusIndicator />
      </div>
    </footer>
  );
}

/* CSS from design */
.app-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 24px;
  background-color: var(--color-background);
  border-top: 1px solid var(--color-green-darker); /* #003322 */
}

.footer-copyright { color: #003322; font-size: 9px; }
.footer-link { color: #006644; font-size: 9px; margin: 0 8px; }
```

### Parent Directory Row Pattern

```typescript
// Source: Phase 6.3 Pencil design (frame: rowParent, id: RmYYZ)
function ParentDirRow({ onClick }: { onClick: () => void }) {
  return (
    <div className="file-list-item file-list-item--parent" onClick={onClick}>
      <div className="file-list-item-name">
        <span className="file-list-item-icon">[..]</span>
        <span>PARENT_DIR</span>
      </div>
      <div className="file-list-item-size">--</div>
      <div className="file-list-item-date">--</div>
    </div>
  );
}
```

### Breadcrumb Path Format

```typescript
// Source: Phase 6.3 Pencil design (frame: breadcrumb, id: uUOmU)
// Breadcrumb format: ~/root/documents/projects
function BreadcrumbPath({ path }: { path: string[] }) {
  const pathString = '~/' + path.join('/');
  return (
    <nav className="breadcrumb-path" aria-label="Current location">
      <span className="breadcrumb-text">{pathString}</span>
    </nav>
  );
}
```

## Design Specifications from Pencil

### Color Tokens (from design file)

| Element            | Color     | CSS Variable               |
| ------------------ | --------- | -------------------------- |
| Primary text       | #00D084   | var(--color-green-primary) |
| Secondary text     | #006644   | var(--color-green-dim)     |
| Borders (bright)   | #00D084   | var(--color-border)        |
| Borders (dim)      | #003322   | var(--color-border-dim)    |
| Background         | #000000   | var(--color-background)    |
| Active nav item bg | #001a11   | (new token needed)         |
| Glow effect        | #00D08466 | var(--color-green-glow)    |

### Typography (from design file)

| Element          | Size | Weight                       |
| ---------------- | ---- | ---------------------------- |
| Logo "CIPHERBOX" | 14px | 600                          |
| Logo ">"         | 20px | 700                          |
| User email       | 11px | 400                          |
| Nav items        | 12px | 600 (active), 400 (inactive) |
| File list items  | 11px | 400                          |
| Column headers   | 10px | 600                          |
| Footer text      | 9px  | 400/600                      |

### Spacing (from design file)

| Element             | Padding                        |
| ------------------- | ------------------------------ |
| Header              | 12px vertical, 24px horizontal |
| Sidebar nav         | 16px all sides                 |
| Nav item            | 8px vertical, 12px horizontal  |
| Toolbar             | 12px vertical, 20px horizontal |
| File list container | 0 top, 20px sides and bottom   |
| File list row       | 10px vertical                  |
| Footer              | 8px vertical, 24px horizontal  |

### Dimensions (from design file)

| Element     | Width/Height           |
| ----------- | ---------------------- |
| Sidebar     | 180px                  |
| Storage bar | 6px height, full width |
| Status dot  | 6px x 6px              |

## Component Inventory

### Components to Create

| Component       | Purpose                          | Location                                 |
| --------------- | -------------------------------- | ---------------------------------------- |
| AppShell        | Fixed layout wrapper             | components/layout/AppShell.tsx           |
| AppHeader       | Header with logo + user menu     | components/layout/AppHeader.tsx          |
| AppSidebar      | Navigation + storage quota       | components/layout/AppSidebar.tsx         |
| AppFooter       | Copyright, links, status         | components/layout/AppFooter.tsx          |
| UserMenu        | Hover dropdown for user actions  | components/layout/UserMenu.tsx           |
| NavItem         | Sidebar navigation item          | components/layout/NavItem.tsx            |
| StorageQuota    | Usage bar in sidebar             | components/layout/StorageQuota.tsx       |
| StatusIndicator | Connection status in footer      | components/layout/StatusIndicator.tsx    |
| ParentDirRow    | [..] PARENT_DIR row in file list | components/file-browser/ParentDirRow.tsx |

### Components to Modify

| Component        | Changes Needed                                                                          |
| ---------------- | --------------------------------------------------------------------------------------- |
| FileList.tsx     | Add ParentDirRow, update column headers to [NAME]/[SIZE]/[MODIFIED], remove TYPE column |
| FileListItem.tsx | Update styling, remove TYPE display                                                     |
| Breadcrumbs.tsx  | Change to path format (~/root/path), remove back button (use parent row instead)        |
| EmptyState.tsx   | Add terminal-style ASCII art                                                            |
| Dashboard.tsx    | Replace with route to FileBrowserPage inside AppShell                                   |
| Settings.tsx     | Move into AppShell wrapper                                                              |
| App.css          | Major restructure for new layout                                                        |

### Components to Remove/Replace

| Component              | Reason                                 |
| ---------------------- | -------------------------------------- |
| FolderTree.tsx         | Replaced by in-place folder navigation |
| FolderTreeNode.tsx     | No longer needed                       |
| ApiStatusIndicator.tsx | Replaced by StatusIndicator in footer  |

### Routes Changes

| Current    | New              | Notes                              |
| ---------- | ---------------- | ---------------------------------- |
| /dashboard | /files           | More descriptive                   |
| /dashboard | /files/:folderId | Support deep links to folders      |
| /settings  | /settings        | No change, but wrapped in AppShell |

## State Management Changes

### Folder Navigation State

**Current:** `useFolderNavigation` hook uses local React state for `currentFolderId`
**New:** Derive `currentFolderId` from URL params via react-router

```typescript
// Current approach (to change)
const [currentFolderId, setCurrentFolderId] = useState<string>('root');

// New approach
const { folderId = 'root' } = useParams<{ folderId?: string }>();
```

### Storage Quota State

**Current:** `useQuotaStore` exists with `usedBytes`, `limitBytes`, `remainingBytes`
**New:** No changes needed - just consume from `StorageQuota` component

### API Status State

**Current:** `ApiStatusIndicator` uses `useHealthControllerCheck` hook directly
**New:** Move same logic to `StatusIndicator` component in footer

## E2E Test Impact

### No E2E Tests Found

The codebase does not have dedicated E2E test files (no `*.spec.ts` or `*.e2e.ts` in apps/web).
Unit tests exist in `apps/web/src/stores/__tests__/logout-security.test.ts`.

### Selector Changes That May Affect Future Tests

| Old Selector           | New Selector      | Component |
| ---------------------- | ----------------- | --------- |
| .dashboard-header      | .app-header       | Header    |
| .file-browser-sidebar  | .app-sidebar      | Sidebar   |
| .folder-tree           | (removed)         | N/A       |
| .file-list-header-type | (removed)         | FileList  |
| .api-status            | .status-indicator | Footer    |

### Recommended Test IDs for New Components

```typescript
// Add data-testid attributes for testability
<header data-testid="app-header" />
<aside data-testid="app-sidebar" />
<footer data-testid="app-footer" />
<div data-testid="user-menu" />
<div data-testid="storage-quota" />
<div data-testid="status-indicator" />
```

## Open Questions

Things that couldn't be fully resolved:

1. **Mobile sidebar behavior with new layout**
   - What we know: Current mobile behavior uses position: fixed with transform for slide-in
   - What's unclear: How to integrate this with CSS Grid-based AppShell
   - Recommendation: Use media query to completely change layout approach on mobile (flex instead of grid)

2. **Settings page content inside AppShell**
   - What we know: Settings currently has its own header with back button
   - What's unclear: Should Settings have its own toolbar area? What content fills the main area?
   - Recommendation: Settings uses same AppShell layout, navigation via sidebar, no separate toolbar

3. **Collapsible sidebar to icons only**
   - What we know: CONTEXT.md mentions "Sidebar collapsible to icons only"
   - What's unclear: Is this a Phase 6.3 requirement or deferred?
   - Recommendation: Implement basic expand/collapse toggle in this phase; can enhance later

## Sources

### Primary (HIGH confidence)

- `designs/cipher-box-design.pen` - Frame "Phase 6.3 - Unified Structure Mockup" (ID: nRzxj)
- `.planning/phases/06.3-ui-structure-refactor/06.3-CONTEXT.md` - User decisions
- Existing codebase files examined:
  - `apps/web/src/components/file-browser/FileBrowser.tsx`
  - `apps/web/src/routes/Dashboard.tsx`
  - `apps/web/src/routes/index.tsx`
  - `apps/web/src/hooks/useFolderNavigation.ts`
  - `apps/web/src/stores/quota.store.ts`
  - `apps/web/src/index.css`, `apps/web/src/App.css`
  - `apps/web/src/styles/file-browser.css`
  - `apps/web/src/styles/responsive.css`

### Secondary (MEDIUM confidence)

- React Router v7 documentation patterns
- CSS Grid layout best practices

### Tertiary (LOW confidence)

- None

## Metadata

**Confidence breakdown:**

- Standard stack: HIGH - No new dependencies, using existing project tools
- Architecture: HIGH - Clear patterns from design file and codebase analysis
- Pitfalls: HIGH - Based on direct codebase observation and common React patterns
- Design specs: HIGH - Extracted directly from Pencil design file

**Research date:** 2026-01-30
**Valid until:** 2026-02-28 (stable patterns, design file is authoritative)
