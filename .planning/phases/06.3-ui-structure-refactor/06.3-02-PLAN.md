---
phase: 06.3-ui-structure-refactor
plan: 02
type: execute
wave: 2
depends_on: ['06.3-01']
files_modified:
  - apps/web/src/routes/index.tsx
  - apps/web/src/routes/FilesPage.tsx
  - apps/web/src/routes/SettingsPage.tsx
  - apps/web/src/hooks/useFolderNavigation.ts
  - apps/web/src/App.css
autonomous: true

must_haves:
  truths:
    - 'Route /files displays file browser inside AppShell'
    - 'Route /files/:folderId navigates to specific folder'
    - 'Browser back/forward buttons work for folder navigation'
    - 'Route /settings displays settings inside AppShell'
    - 'Redirect from /dashboard to /files'
  artifacts:
    - path: 'apps/web/src/routes/index.tsx'
      provides: 'Updated routes with /files/:folderId? pattern'
      exports: ['AppRoutes']
    - path: 'apps/web/src/routes/FilesPage.tsx'
      provides: 'Files page wrapped in AppShell'
      exports: ['FilesPage']
    - path: 'apps/web/src/routes/SettingsPage.tsx'
      provides: 'Settings page wrapped in AppShell'
      exports: ['SettingsPage']
    - path: 'apps/web/src/hooks/useFolderNavigation.ts'
      provides: 'URL-based folder navigation'
      exports: ['useFolderNavigation']
  key_links:
    - from: 'apps/web/src/routes/FilesPage.tsx'
      to: 'AppShell'
      via: 'component wrapper'
      pattern: 'import.*AppShell'
    - from: 'apps/web/src/hooks/useFolderNavigation.ts'
      to: 'react-router-dom'
      via: 'useParams, useNavigate'
      pattern: 'useParams|useNavigate'
---

<objective>
Update routing structure and implement URL-based folder navigation.

Purpose: Change routes from /dashboard to /files, add folder ID as URL parameter for browser history support, and wrap authenticated routes in the new AppShell layout.

Output: Updated routing with /files/:folderId? pattern, new page components wrapped in AppShell, and useFolderNavigation hook that derives state from URL.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06.3-ui-structure-refactor/06.3-CONTEXT.md
@.planning/phases/06.3-ui-structure-refactor/06.3-RESEARCH.md
@.planning/phases/06.3-ui-structure-refactor/06.3-01-SUMMARY.md
@apps/web/src/routes/index.tsx
@apps/web/src/routes/Dashboard.tsx
@apps/web/src/routes/Settings.tsx
@apps/web/src/hooks/useFolderNavigation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Routes and Create Page Components</name>
  <files>
    apps/web/src/routes/index.tsx
    apps/web/src/routes/FilesPage.tsx
    apps/web/src/routes/SettingsPage.tsx
  </files>
  <action>
Create new page components and update routing structure.

**FilesPage.tsx:**

- Wraps content in AppShell component
- Contains the FileBrowser component as main content
- Auth guard: redirect to / if not authenticated (reuse logic from Dashboard.tsx)
- Loading state while checking auth
- Import AppShell from components/layout
- Export named `FilesPage`

**SettingsPage.tsx:**

- Wraps content in AppShell component
- Contains the existing Settings component content (or imports existing Settings)
- Auth guard: redirect to / if not authenticated
- Loading state while checking auth
- Import AppShell from components/layout
- Export named `SettingsPage`

**index.tsx updates:**

- Change route `/dashboard` to `/files/:folderId?` (optional folderId param)
- Add redirect from `/dashboard` to `/files` for backwards compatibility
- Route `/files` -> FilesPage
- Route `/files/:folderId` -> FilesPage (same component, folderId in URL)
- Route `/settings` -> SettingsPage
- Route `/` stays as Login
- Use Navigate component for redirect: `<Route path="/dashboard" element={<Navigate to="/files" replace />} />`

Route structure:

```tsx
<Routes>
  <Route path="/" element={<Login />} />
  <Route path="/files/:folderId?" element={<FilesPage />} />
  <Route path="/settings" element={<SettingsPage />} />
  <Route path="/dashboard" element={<Navigate to="/files" replace />} />
</Routes>
```

  </action>
  <verify>
Run `pnpm --filter web build` - no TypeScript errors.
Verify FilesPage imports AppShell.
Verify routes include /files/:folderId? pattern.
  </verify>
  <done>
FilesPage and SettingsPage wrap content in AppShell. Routes updated with /files/:folderId? pattern and /dashboard redirect.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update useFolderNavigation for URL-based State</name>
  <files>
    apps/web/src/hooks/useFolderNavigation.ts
  </files>
  <action>
Refactor useFolderNavigation to derive folder state from URL instead of local state.

**Changes to useFolderNavigation.ts:**

1. Replace local `useState<string>('root')` with URL params:

```tsx
const { folderId } = useParams<{ folderId?: string }>();
const navigate = useNavigate();
const currentFolderId = folderId ?? 'root';
```

2. Update `navigateTo` to use react-router navigation:

```tsx
const navigateTo = useCallback(
  (id: string) => {
    if (id === 'root') {
      navigate('/files');
    } else {
      navigate(`/files/${id}`);
    }
  },
  [navigate]
);
```

3. Update `navigateUp` to use the new navigateTo:

```tsx
const navigateUp = useCallback(() => {
  if (currentFolder?.parentId) {
    navigateTo(currentFolder.parentId);
  } else if (currentFolderId !== 'root') {
    navigateTo('root');
  }
}, [currentFolder, currentFolderId, navigateTo]);
```

4. Keep existing breadcrumb building logic - it already works with currentFolderId.

5. Keep folder loading logic - it still needs to mark folders as loading/loaded.

6. Remove setCurrentFolderId useState entirely - state comes from URL now.

**Imports to add:**

- `useParams` from react-router-dom
- `useNavigate` from react-router-dom

**Behavior:**

- URL `/files` -> currentFolderId = 'root'
- URL `/files/abc123` -> currentFolderId = 'abc123'
- navigateTo('xyz') -> URL changes to `/files/xyz`
- Browser back button -> previous folder (URL-based history)
  </action>
  <verify>
  Run `pnpm --filter web build` - no TypeScript errors.
  Verify hook uses useParams and useNavigate.
  Verify no useState for currentFolderId.
  </verify>
  <done>
  useFolderNavigation derives currentFolderId from URL params. navigateTo uses react-router navigate. Browser history works.
  </done>
  </task>

<task type="auto">
  <name>Task 3: Update App.css and Remove Old Dashboard Styles</name>
  <files>
    apps/web/src/App.css
    apps/web/src/routes/Dashboard.tsx
  </files>
  <action>
Clean up old Dashboard-specific styles and update App.css imports.

**App.css changes:**

1. Add import for new layout.css:

```css
@import './styles/layout.css';
```

2. Keep login page styles (.login-container, etc.) - these are still used.

3. Remove or deprecate dashboard-specific styles that are now replaced:
   - `.dashboard-container` - replaced by AppShell
   - `.dashboard-header` - replaced by AppHeader
   - `.dashboard-main` - replaced by AppShell main area

4. Keep `.api-status` styles but mark as deprecated (StatusIndicator in footer replaces this).

5. Ensure logout-link and placeholder-text styles are preserved if still needed.

**Dashboard.tsx:**

- Mark as deprecated with a comment at top: `// @deprecated - Use FilesPage instead. Kept for reference during migration.`
- OR delete entirely if not needed for reference
- Recommend: Keep file but add deprecation comment - helps during testing/verification

**Note:** The old dashboard styles can be left in place temporarily since they won't conflict - different class names. Full cleanup can happen after verification.
</action>
<verify>
Run `pnpm --filter web build` - no TypeScript errors.
Verify App.css imports layout.css.
Verify application still runs without CSS errors.
</verify>
<done>
App.css imports new layout.css. Old dashboard styles marked deprecated. Build passes.
</done>
</task>

</tasks>

<verification>
1. Routes /files and /files/:folderId work correctly
2. Browser back/forward navigates folder history
3. /dashboard redirects to /files
4. FilesPage and SettingsPage wrapped in AppShell
5. useFolderNavigation uses URL params not local state
6. `pnpm --filter web build` passes
7. `pnpm --filter web dev` shows new layout structure
</verification>

<success_criteria>

- FilesPage.tsx and SettingsPage.tsx created with AppShell wrapper
- Routes updated with /files/:folderId? pattern
- useFolderNavigation derives state from URL
- Browser history navigation works
- App.css imports layout.css
- Build passes with no TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/06.3-ui-structure-refactor/06.3-02-SUMMARY.md`
</output>
