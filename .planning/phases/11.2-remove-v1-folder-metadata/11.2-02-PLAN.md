---
phase: 11.2-remove-v1-folder-metadata
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop/src-tauri/src/crypto/folder.rs
  - apps/desktop/src-tauri/src/crypto/tests.rs
  - apps/desktop/src-tauri/src/fuse/inode.rs
  - apps/desktop/src-tauri/src/fuse/mod.rs
  - apps/desktop/src-tauri/src/fuse/operations.rs
  - apps/desktop/src-tauri/src/fuse/cache.rs
  - apps/desktop/src-tauri/src/commands.rs
autonomous: true

must_haves:
  truths:
    - 'Rust crypto module has only v2 types: FolderMetadata with FolderChild (Folder | File(FilePointer))'
    - 'FileEntry struct is deleted -- no inline file data type exists in Rust'
    - 'AnyFolderMetadata enum is deleted -- no version dispatch needed'
    - 'build_folder_metadata emits FolderChild::File(FilePointer) instead of FileEntry'
    - 'MetadataCache stores FolderMetadata (the v2 struct) directly, not via synthetic v1'
    - 'populate_folder handles only v2 FolderChild (no v1 path)'
    - "Desktop writes version: 'v2' in ALL folder metadata -- including init_vault and mkdir"
    - 'cargo test --features fuse passes'
  artifacts:
    - path: 'apps/desktop/src-tauri/src/crypto/folder.rs'
      provides: 'Single FolderMetadata struct, FolderChild enum with Folder(FolderEntry)|File(FilePointer), encrypt/decrypt functions'
      contains: 'pub struct FolderMetadata'
    - path: 'apps/desktop/src-tauri/src/fuse/inode.rs'
      provides: 'Single populate_folder function accepting FolderMetadata (v2 schema)'
      contains: 'pub fn populate_folder'
    - path: 'apps/desktop/src-tauri/src/fuse/mod.rs'
      provides: 'build_folder_metadata returning FilePointer children, no v1/v2 branching'
      contains: 'FolderChild::File(FilePointer'
  key_links:
    - from: 'apps/desktop/src-tauri/src/crypto/folder.rs'
      to: 'apps/desktop/src-tauri/src/fuse/inode.rs'
      via: 'FolderMetadata, FolderChild types'
      pattern: "FolderChild::File\\(FilePointer"
    - from: 'apps/desktop/src-tauri/src/fuse/mod.rs'
      to: 'apps/desktop/src-tauri/src/fuse/inode.rs'
      via: 'populate_folder call'
      pattern: 'populate_folder'
    - from: 'apps/desktop/src-tauri/src/fuse/cache.rs'
      to: 'apps/desktop/src-tauri/src/crypto/folder.rs'
      via: 'MetadataCache stores FolderMetadata'
      pattern: 'FolderMetadata'
---

<objective>
Delete v1 folder metadata types from Rust desktop codebase, rename v2 types to canonical, rewrite build_folder_metadata to emit FilePointer, and eliminate all v1/v2 branching in the FUSE layer.

Purpose: The desktop app currently writes v1 folder metadata (inline FileEntry), which causes cross-device format oscillation when the web app saves it back as v2. By making the desktop emit v2-only (FilePointer), both clients produce identical metadata formats, eliminating the entire class of version mismatch bugs.

Output: Rust codebase with single FolderMetadata type (v2 schema), build_folder_metadata emitting FilePointer children, and no v1/v2 dispatch code.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11.2-remove-v1-folder-metadata/GOAL.md
@apps/desktop/src-tauri/src/crypto/folder.rs
@apps/desktop/src-tauri/src/fuse/inode.rs
@apps/desktop/src-tauri/src/fuse/mod.rs
@apps/desktop/src-tauri/src/fuse/operations.rs
@apps/desktop/src-tauri/src/fuse/cache.rs
@apps/desktop/src-tauri/src/commands.rs
@apps/desktop/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete v1 types, rename v2 to canonical in Rust crypto module</name>
  <files>
    apps/desktop/src-tauri/src/crypto/folder.rs
    apps/desktop/src-tauri/src/crypto/tests.rs
  </files>
  <action>
In `apps/desktop/src-tauri/src/crypto/folder.rs`:

**Delete these types/items:**

- `FolderMetadata` struct (the v1 struct at lines 27-33 with `children: Vec<FolderChild>`)
- `FolderChild` enum (the v1 enum at lines 36-43 with `Folder(FolderEntry) | File(FileEntry)`)
- `FileEntry` struct (lines 72-101, the inline file data with cid/fileKeyEncrypted/etc)
- `AnyFolderMetadata` enum (lines 175-178) and its `impl` block (to_v1, children_len)
- `decrypt_any_folder_metadata()` function (lines 258-308)
- `encrypt_folder_metadata()` that takes `&FolderMetadata` v1 (lines 107-115)
- `decrypt_folder_metadata()` that takes v1 (lines 120-128)
- `default_encryption_mode()` function (lines 222-225) -- only used by FileEntry's serde default; keep it ONLY if FileMetadata still needs it (check: FileMetadata has `#[serde(default = "default_encryption_mode")]` at line 248 -- YES, keep it for FileMetadata)

**Rename these types:**

- `FolderMetadataV2` (lines 165-170) -> `FolderMetadata`
- `FolderChildV2` (lines 152-160) -> `FolderChild`

**Add encrypt/decrypt for the renamed FolderMetadata:**

- `encrypt_folder_metadata(metadata: &FolderMetadata, folder_key: &[u8; 32]) -> Result<Vec<u8>, FolderError>` -- JSON serialize, seal_aes_gcm. Same logic as the old v1 version but for the new struct.
- `decrypt_folder_metadata(sealed: &[u8], folder_key: &[u8; 32]) -> Result<FolderMetadata, FolderError>` -- unseal, JSON deserialize to FolderMetadata directly. No version dispatch. If version is not "v2", return DeserializationFailed error.

**Keep unchanged:**

- `FolderEntry` struct (subfolders are the same in both versions)
- `FilePointer` struct (already canonical)
- `FolderError` enum
- `FileMetadata` struct (per-file IPNS, separate schema)
- `encrypt_file_metadata()` and `decrypt_file_metadata()` (per-file IPNS operations)
- `default_encryption_mode()` (used by FileMetadata serde)

**Update module doc comment** to remove "Supports both v1 and v2" language.

In `apps/desktop/src-tauri/src/crypto/tests.rs`:

- Remove imports: `AnyFolderMetadata`, `FileEntry`, `FolderMetadataV2`, `FolderChildV2`, `decrypt_any_folder_metadata`
- Add imports: `FolderMetadata` (the new canonical), `FolderChild`
- Delete v1 tests:
  - Tests using `FileEntry` struct (test_roundtrip with FileEntry fields, etc.)
  - Tests for `decrypt_any_folder_metadata` (lines ~1098-1135 testing v1/v2 dispatch)
  - Any tests constructing `FolderChild::File(FileEntry { ... })`
- Update v2 tests:
  - Change `FolderMetadataV2` type annotations to `FolderMetadata`
  - Change `FolderChildV2` to `FolderChild`
  - The v2 serde test (line ~1015) becomes the standard serde test
  - Keep `FolderChild::File(FilePointer { ... })` tests
- Add rejection test: construct data with `version: "v1"` and verify `decrypt_folder_metadata` returns error
  </action>
  <verify>
  Run `cargo check --manifest-path apps/desktop/src-tauri/Cargo.toml --features fuse` -- compiles with no errors.
  Grep: `grep -r "FileEntry\|FolderMetadataV2\|FolderChildV2\|AnyFolderMetadata\|decrypt_any_folder_metadata\|to_v1" apps/desktop/src-tauri/src/crypto/ --include="*.rs"` -- no results (except comments mentioning removal).
  </verify>
  <done>
  Rust crypto module has single FolderMetadata struct (v2 schema), single FolderChild enum (Folder|File(FilePointer)), no v1 types, no version dispatch. Tests compile and pass.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Rewrite FUSE layer and commands to v2-only with FilePointer in build_folder_metadata</name>
  <files>
    apps/desktop/src-tauri/src/fuse/inode.rs
    apps/desktop/src-tauri/src/fuse/mod.rs
    apps/desktop/src-tauri/src/fuse/operations.rs
    apps/desktop/src-tauri/src/fuse/cache.rs
    apps/desktop/src-tauri/src/commands.rs
  </files>
  <action>
**`apps/desktop/src-tauri/src/fuse/cache.rs`:**
- The `MetadataCache` already stores `FolderMetadata` (v1). After the rename, it stores the canonical `FolderMetadata` (which is now the v2 struct). Update the import to use the renamed type.
- Remove the synthetic empty-children workaround everywhere -- now ALL folder metadata is `FolderMetadata` (the v2 struct), so cache stores real data directly.
- **Update test fixtures:** Change `version: "v1".to_string()` to `version: "v2".to_string()` in the test at line 184 (`test_metadata_cache_set_and_get`) and line 204 (`test_metadata_cache_invalidate`). These tests construct `FolderMetadata { version: "v1"... }` which must become `version: "v2"` to match the canonical v2 schema.

**`apps/desktop/src-tauri/src/fuse/inode.rs`:**

- Delete `populate_folder()` (the v1-only function, lines ~236-488 that handles `FolderChild::Folder` and `FolderChild::File(FileEntry)`)
- Rename `populate_folder_v2()` -> `populate_folder()` (handles `FolderChild::Folder` and `FolderChild::File(FilePointer)`)
- Delete `populate_folder_any()` dispatch function (the v1/v2 match)
- Update imports: remove `FolderChild` (v1), `FolderMetadata` (v1), `AnyFolderMetadata`; use canonical `FolderMetadata`, `FolderChild`
- Update the test at bottom of file: `test_populate_folder_with_files` -- rewrite to use `FolderChild::File(FilePointer { ... })` instead of `FolderChild::File(FileEntry { ... })`. The inode created should be a placeholder file with `file_meta_ipns_name` set (matching how v2 populate works).

**`apps/desktop/src-tauri/src/fuse/operations.rs`:**

- `decrypt_metadata_from_ipfs()` (private method, lines ~102-136):
  - Change return type from `AnyFolderMetadata` to `FolderMetadata` (the canonical v2 struct)
  - Use `decrypt_folder_metadata()` (the new one that returns FolderMetadata directly, not decrypt_any_folder_metadata)
  - Remove the version dispatch entirely
- `decrypt_metadata_from_ipfs_public()` (public version, lines ~2198-2234):
  - Same changes as above -- return `FolderMetadata`, use `decrypt_folder_metadata()`
- `fetch_and_populate_folder()`:
  - `any_metadata` variable -> just `metadata` (type: `FolderMetadata`)
  - Remove the `match &any_metadata` for cache (no longer needed since metadata IS the correct type)
  - Call `fs.inodes.populate_folder(...)` directly instead of `populate_folder_any()`
  - The FilePointer resolution code stays the same (it already works with v2 metadata)
- **`mkdir()` function (line ~1647):** Change `version: "v1".to_string()` to `version: "v2".to_string()` when constructing the initial empty folder metadata for newly created subfolders. This is at line 1647 where `mkdir` creates `FolderMetadata { version: "v1".to_string(), children: vec![] }`.

**`apps/desktop/src-tauri/src/fuse/mod.rs`:**

`build_folder_metadata()` (lines ~345-501):

- Change return type from `FolderMetadata` (v1) to the canonical `FolderMetadata` (v2 struct)
- The `metadata_children` vector type: `Vec<FolderChild>` (the canonical enum: Folder(FolderEntry) | File(FilePointer))
- For `InodeKind::Folder` children: emit `FolderChild::Folder(FolderEntry { ... })` -- same as before
- For `InodeKind::File` children: emit `FolderChild::File(FilePointer { ... })` instead of `FolderChild::File(FileEntry { ... })`. FilePointer has: `id`, `name`, `file_meta_ipns_name`, `created_at`, `modified_at`. The `file_meta_ipns_name` comes from the inode's `InodeKind::File { file_meta_ipns_name, .. }` field -- use it directly. If `file_meta_ipns_name` is None (newly created file before IPNS publish), this is a problem -- the file MUST have an IPNS name. See below for create() changes.
- Change `version: "v1".to_string()` to `version: "v2".to_string()` at line 494

`spawn_metadata_publish()`:

- Parameter type already `FolderMetadata` -- after the rename this is the v2 struct. Check that `encrypt_metadata_to_json` works with the new type.

`drain_refresh_completions()` (lines ~629-684):

- Remove the `match &refresh.metadata` for `AnyFolderMetadata::V1 / V2` -- the metadata IS `FolderMetadata` (canonical). Store directly in cache.
- Remove synthetic v1 creation for v2 metadata
- Call `self.inodes.populate_folder(...)` directly instead of `populate_folder_any()`
- The `matches!(&refresh.metadata, AnyFolderMetadata::V2(_))` check for FilePointer resolution: change to always resolve FilePointers after populating (since all metadata is now v2 format).

Pre-populate root folder section (lines ~840-920):

- Remove all `AnyFolderMetadata::V1 / V2` match arms
- Store metadata directly in cache (it's already the right type)
- Call `inodes.populate_folder(...)` directly
- Keep FilePointer resolution logic (already correct for v2)

`FolderRefresh` struct (and anywhere `metadata` field type is `AnyFolderMetadata`):

- Change to `FolderMetadata` (canonical v2)

CRITICAL: Check the `encrypt_metadata_to_json` helper function. It currently takes `&FolderMetadata` (v1). After the rename, it takes the canonical `FolderMetadata` (v2). Verify it serializes correctly -- it should, since it just does `serde_json::to_vec(metadata)`.

Note on `InodeKind::File { file_meta_ipns_name }`: For files loaded from v2 metadata, this field is `Some(...)`. For NEWLY CREATED files (via FUSE create()), this field may be `None` if the file IPNS hasn't been derived yet. However, per the GOAL.md, "Desktop FUSE create() derives file IPNS keypair" -- this will be addressed in Plan 03. For now, if `file_meta_ipns_name` is `None`, use an empty string as placeholder in the FilePointer (it will be updated before publish). Log a warning if this occurs.

**`apps/desktop/src-tauri/src/commands.rs`:**

- **`init_vault()` function (line ~565):** Change `version: "v1".to_string()` to `version: "v2".to_string()` when constructing the initial empty root folder metadata. Currently reads: `let empty_metadata = crypto::folder::FolderMetadata { version: "v1".to_string(), children: vec![] };` -- change to `version: "v2".to_string()`.
- After the rename in Task 1, this code constructs the canonical `FolderMetadata` struct. The version field must be `"v2"` so the root folder is created in v2 format from the start.
- No other changes needed in commands.rs -- just the version string literal.
  </action>
  <verify>
  Run `cargo check --manifest-path apps/desktop/src-tauri/Cargo.toml --features fuse` -- compiles with no errors.
  Run `cargo test --manifest-path apps/desktop/src-tauri/Cargo.toml --features fuse` -- all tests pass.
  Grep: `grep -r "AnyFolderMetadata\|decrypt_any_folder_metadata\|populate_folder_v2\|populate_folder_any\|to_v1\|FileEntry" apps/desktop/src-tauri/src/fuse/ --include="*.rs"` -- no results.
  Grep: `grep -rn 'version.*"v1"' apps/desktop/src-tauri/src/commands.rs apps/desktop/src-tauri/src/fuse/operations.rs apps/desktop/src-tauri/src/fuse/mod.rs apps/desktop/src-tauri/src/fuse/cache.rs` -- no results (all changed to "v2").
  </verify>
  <done>
  FUSE layer uses canonical FolderMetadata (v2) everywhere. build_folder_metadata emits FilePointer children. No v1/v2 branching remains. MetadataCache stores real v2 metadata. Desktop writes version: "v2" in ALL folder metadata (init_vault, mkdir, build_folder_metadata). cache.rs test fixtures use "v2". cargo test passes.
  </done>
  </task>

</tasks>

<verification>
1. `cargo check --manifest-path apps/desktop/src-tauri/Cargo.toml --features fuse` compiles
2. `cargo test --manifest-path apps/desktop/src-tauri/Cargo.toml --features fuse` passes
3. No grep results for: `AnyFolderMetadata`, `decrypt_any_folder_metadata`, `FileEntry` (the v1 type), `FolderMetadataV2`, `FolderChildV2`, `to_v1`, `populate_folder_v2`, `populate_folder_any` in `apps/desktop/src-tauri/src/`
4. `build_folder_metadata` produces `version: "v2"` with `FolderChild::File(FilePointer)` children
5. `grep -rn 'version.*"v1"' apps/desktop/src-tauri/src/commands.rs apps/desktop/src-tauri/src/fuse/` returns zero results (excluding FileMetadata version which is per-file schema, not folder schema)
</verification>

<success_criteria>

- Rust crypto module has single FolderMetadata struct (v2 schema), single FolderChild enum
- FileEntry struct deleted from Rust code
- AnyFolderMetadata enum deleted
- decrypt_any_folder_metadata deleted
- build_folder_metadata emits FilePointer (not FileEntry)
- Desktop writes version: "v2" in all metadata including init_vault and mkdir
- populate_folder handles only v2 FolderChild
- MetadataCache stores FolderMetadata (canonical v2) directly
- cache.rs test fixtures use version: "v2"
- All Rust tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/11.2-remove-v1-folder-metadata/11.2-02-SUMMARY.md`
</output>
