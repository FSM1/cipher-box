---
phase: 11.2-remove-v1-folder-metadata
verified: 2026-02-19T02:54:35Z
status: passed
score: 8/8 must-haves verified
must_haves:
  truths:
    - 'Only v2 folder metadata (FilePointer children with fileMetaIpnsName) is written by all clients'
    - 'v1 folder metadata (inline FileEntry with cid/fileKeyEncrypted) is rejected by validators on all platforms'
    - 'All v1/v2 branching code removed: ~500 lines of dual-schema types, dispatch, and conversion'
    - 'Desktop FUSE create() derives file IPNS keypair and release() publishes per-file FileMetadata'
    - 'Desktop build_folder_metadata emits FilePointer (not FileEntry) -- cross-device format is consistent'
    - 'TypeScript crypto package exports canonical names (FolderMetadata, FolderChild) -- no V2 suffix'
    - 'Recovery tool (recovery.html) handles only v2 FilePointer path'
    - 'All tests pass: pnpm test + cargo test --features fuse'
  artifacts:
    - path: 'packages/crypto/src/folder/types.ts'
      provides: 'Canonical FolderMetadata and FolderChild types (v2 only)'
    - path: 'packages/crypto/src/folder/metadata.ts'
      provides: 'validateFolderMetadata rejects non-v2, encrypt/decrypt v2 only'
    - path: 'packages/crypto/src/index.ts'
      provides: 'Canonical exports (no V2 suffix, no FileEntry, no isV2Metadata)'
    - path: 'apps/desktop/src-tauri/src/crypto/folder.rs'
      provides: 'Rust FolderMetadata/FolderChild/FilePointer types, v2-only decrypt'
    - path: 'apps/desktop/src-tauri/src/fuse/operations.rs'
      provides: 'create() HKDF derivation, release() FileMetadata publish'
    - path: 'apps/desktop/src-tauri/src/fuse/mod.rs'
      provides: 'build_folder_metadata emits FilePointer, single populate_folder'
    - path: 'apps/desktop/src-tauri/src/fuse/inode.rs'
      provides: 'file_ipns_private_key field on InodeKind::File, single populate_folder'
    - path: 'apps/web/public/recovery.html'
      provides: 'v2-only recovery with FilePointer IPNS resolution'
  key_links:
    - from: 'create() in operations.rs'
      to: 'derive_file_ipns_keypair in crypto/hkdf'
      via: 'HKDF derivation call at line 969'
    - from: 'release() in operations.rs'
      to: 'publish_file_metadata() helper'
      via: 'Background thread spawn at line 1581'
    - from: 'build_folder_metadata in mod.rs'
      to: 'FolderChild::File(FilePointer)'
      via: 'FilePointer emission at line 494-502'
    - from: 'validateFolderMetadata in metadata.ts'
      to: 'CryptoError rejection'
      via: 'version !== v2 check at line 40-45, fileMetaIpnsName check at line 66-74'
    - from: 'recovery.html recoverFolder()'
      to: 'v2 version check'
      via: 'metadata.version !== v2 at line 843, fileMetaIpnsName check at line 871'
---

# Phase 11.2: Remove v1 Folder Metadata Verification Report

**Phase Goal:** Eliminate folder metadata v1/v2 dual-schema code -- make v2 (FilePointer) the only format, tighten validation to reject hybrid metadata, and implement per-file IPNS publishing in desktop FUSE
**Verified:** 2026-02-19T02:54:35Z
**Status:** PASSED
**Re-verification:** No -- initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Only v2 folder metadata (FilePointer children with fileMetaIpnsName) is written by all clients | VERIFIED | Web folder.service.ts writes `version: 'v2'` at lines 246,296. Desktop commands.rs writes `version: "v2"` at line 565. Desktop build_folder_metadata writes `version: "v2"` at mod.rs:509. All emit FilePointer children. |
| 2 | v1 folder metadata (inline FileEntry with cid/fileKeyEncrypted) is rejected by validators on all platforms | VERIFIED | TS validateFolderMetadata rejects non-v2 (metadata.ts:40-45) and missing fileMetaIpnsName (metadata.ts:66-74). Rust decrypt_folder_metadata rejects non-v2 (folder.rs:119-126). Recovery tool rejects non-v2 (recovery.html:843) and missing fileMetaIpnsName (recovery.html:871). Tests: folder-metadata.test.ts:205, tests.rs:572. |
| 3 | All v1/v2 branching code removed: ~500 lines of dual-schema types, dispatch, and conversion | VERIFIED | git diff shows 606 deletions / 122 insertions in core type/validation files alone (net -484 lines). No FileEntry, FolderMetadataV2, FolderChildV2, AnyFolderMetadata, isV2Metadata in any source file (grep confirms 0 matches across crypto, web, and desktop src). Single populate_folder function (no v1/v2 dispatch). |
| 4 | Desktop FUSE create() derives file IPNS keypair and release() publishes per-file FileMetadata | VERIFIED | create() calls derive_file_ipns_keypair at operations.rs:968-976, stores result on inode at line 991. release() builds FileMetadata (line 1544-1554), spawns background thread (line 1557), calls publish_file_metadata (line 1581-1588). publish_file_metadata encrypts, uploads to IPFS, creates IPNS record, publishes (lines 413-474). |
| 5 | Desktop build_folder_metadata emits FilePointer (not FileEntry) -- cross-device format is consistent | VERIFIED | build_folder_metadata at mod.rs:494-502 emits FolderChild::File(FilePointer { id, name, file_meta_ipns_name, ... }). Skips files without valid IPNS name (mod.rs:486-491). Sets version: "v2" (mod.rs:509). |
| 6 | TypeScript crypto package exports canonical names (FolderMetadata, FolderChild) -- no V2 suffix | VERIFIED | types.ts exports FolderMetadata, FolderChild, FolderEntry (no V2 suffix). index.ts re-exports canonical names. packages/crypto/src/index.ts exports FolderMetadata, FolderChild (lines 90-94). All 10 web app files import canonical names. Zero grep matches for FolderMetadataV2/FolderChildV2/FileEntry/isV2Metadata in source. |
| 7 | Recovery tool (recovery.html) handles only v2 FilePointer path | VERIFIED | recovery.html:843-847 rejects non-v2 metadata with error log. Lines 870-875 validate fileMetaIpnsName presence on file children. Lines 878-928 resolve per-file IPNS, fetch FileMetadata, decrypt with folderKey, download. No v1 inline branch exists. |
| 8 | All tests pass: pnpm test + cargo test --features fuse | VERIFIED | crypto: 225/225 passed. web: 22/22 passed. api: 495/495 passed (26 suites). rust: 118/118 passed (with --features fuse). E2E tests skipped (PINATA_JWT env missing -- infrastructure issue, not Phase 11.2 related). |

**Score:** 8/8 truths verified

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `packages/crypto/src/folder/types.ts` | Canonical FolderMetadata, FolderChild types | VERIFIED | 59 lines, v2 only, FolderChild = FolderEntry or FilePointer. No FileEntry type. |
| `packages/crypto/src/folder/metadata.ts` | Strict v2-only validator, encrypt/decrypt | VERIFIED | 133 lines, validateFolderMetadata rejects non-v2 with CryptoError, validates fileMetaIpnsName. |
| `packages/crypto/src/folder/index.ts` | Clean exports | VERIFIED | 13 lines, exports FolderMetadata, FolderChild, FolderEntry, EncryptedFolderMetadata. |
| `packages/crypto/src/index.ts` | No V2 suffix exports | VERIFIED | 155 lines, exports FolderMetadata, FolderChild, FolderEntry -- no FileEntry, no isV2Metadata. |
| `apps/desktop/src-tauri/src/crypto/folder.rs` | v2-only Rust types and decrypt | VERIFIED | 198 lines, FolderMetadata/FolderChild/FilePointer structs, version "v2" check in decrypt. |
| `apps/desktop/src-tauri/src/fuse/operations.rs` | create() HKDF + release() publish | VERIFIED | publish_file_metadata helper (lines 413-474), create() derivation (lines 958-991), release() publish (lines 1574-1596). |
| `apps/desktop/src-tauri/src/fuse/mod.rs` | build_folder_metadata emits FilePointer | VERIFIED | FilePointer emission at lines 494-502, version "v2" at line 509, skip files without IPNS name. |
| `apps/desktop/src-tauri/src/fuse/inode.rs` | file_ipns_private_key on InodeKind::File | VERIFIED | Option<Zeroizing<Vec<u8>>> at line 89, single populate_folder at line 235. |
| `apps/web/public/recovery.html` | v2-only recovery | VERIFIED | 1219 lines, v2 version check, FilePointer validation, per-file IPNS resolution, HKDF derivation. |
| `apps/web/src/services/folder.service.ts` | Writes v2 only | VERIFIED | version: 'v2' at lines 246, 296. Uses encryptFolderMetadata from canonical exports. |
| `apps/desktop/src-tauri/src/commands.rs` | init_vault writes v2 | VERIFIED | version: "v2" at line 565. |

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| create() in operations.rs | derive_file_ipns_keypair | HKDF call | WIRED | Line 969: calls crate::crypto::hkdf::derive_file_ipns_keypair. Stores private key on inode (line 991). |
| release() in operations.rs | publish_file_metadata() | Background thread | WIRED | Line 1557: std::thread::spawn. Line 1581: calls publish_file_metadata with api, file_meta, folder_key, ipns_key, ipns_name, coordinator. |
| publish_file_metadata() | IPFS upload + IPNS publish | API calls | WIRED | Line 438: upload_content. Line 441: resolve_sequence. Line 449: create_ipns_record. Line 468: publish_ipns. |
| build_folder_metadata | FilePointer emission | FolderChild::File | WIRED | Line 494-502: creates FilePointer with id, name, file_meta_ipns_name, timestamps. |
| validateFolderMetadata (TS) | CryptoError rejection | Version + field checks | WIRED | Line 40-45: rejects non-v2. Line 66-74: rejects files without fileMetaIpnsName. |
| decrypt_folder_metadata (Rust) | DeserializationFailed | Version check | WIRED | Line 119: checks version == "v2". Line 125: returns DeserializationFailed error. |
| recovery.html recoverFolder | v2 rejection + FilePointer resolve | Version + IPNS | WIRED | Line 843: rejects non-v2. Line 871: validates fileMetaIpnsName. Line 887: resolves per-file IPNS. |

### Requirements Coverage

| Requirement | Status | Notes |
|-------------|--------|-------|
| Data integrity (v2-only schema) | SATISFIED | All validators reject v1, all writers emit v2. |
| Cross-device interop (consistent format) | SATISFIED | Desktop and web both write FilePointer in v2 FolderMetadata. |

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| operations.rs | 1545 | `version: "v1".to_string()` in FileMetadata | Info | FileMetadata version "v1" is the correct version for the FileMetadata schema (distinct from FolderMetadata v2). Not a bug. |
| inode.rs | 224 | "placeholder" in doc comment | Info | Doc comment explaining inode creation flow, not a stub. |

### Human Verification Required

None required. All success criteria are verifiable programmatically and have been verified.

### Gaps Summary

No gaps found. All 8 success criteria from GOAL.md are satisfied:

1. v2-only writes confirmed across web (folder.service.ts), desktop (commands.rs, build_folder_metadata)
2. v1 rejection confirmed in TS validator, Rust decrypt, and recovery tool
3. ~484 net lines removed from core type/validation files (606 deletions, 122 additions); zero matches for v1 types in source
4. create() derives HKDF keypair, release() publishes FileMetadata via background thread
5. build_folder_metadata emits FilePointer with version "v2"
6. Canonical exports: FolderMetadata, FolderChild (no V2 suffix anywhere in source)
7. Recovery tool is v2-only with FilePointer IPNS resolution
8. All tests pass: 225 TS crypto + 22 web + 495 API + 118 Rust = 860 tests passing

---

_Verified: 2026-02-19T02:54:35Z_
_Verifier: Claude (gsd-verifier)_
