---
phase: 11.2-remove-v1-folder-metadata
plan: 02
subsystem: desktop
tags: [rust, fuse, folder-metadata, v2, filepointer, inode, aes-gcm]

# Dependency graph
requires:
  - phase: 11.2-remove-v1-folder-metadata
    provides: TypeScript v1 types deleted, v2 renamed to canonical (Plan 01)
  - phase: 12.6-per-file-ipns
    provides: FilePointer type, per-file IPNS derivation, file metadata encrypt/decrypt
provides:
  - Rust crypto module with single FolderMetadata/FolderChild (v2 schema only)
  - FUSE build_folder_metadata emitting FilePointer children
  - Desktop writes version "v2" in all folder metadata (init_vault, mkdir, build)
  - Single populate_folder function (no v1/v2 dispatch)
affects: [11.2-03, desktop-fuse, cross-device-interop]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'v2-only folder metadata in Rust (strict version validation)'
    - 'FilePointer emission from FUSE build_folder_metadata'

key-files:
  created: []
  modified:
    - apps/desktop/src-tauri/src/crypto/folder.rs
    - apps/desktop/src-tauri/src/crypto/tests.rs
    - apps/desktop/src-tauri/src/fuse/inode.rs
    - apps/desktop/src-tauri/src/fuse/mod.rs
    - apps/desktop/src-tauri/src/fuse/operations.rs
    - apps/desktop/src-tauri/src/fuse/cache.rs
    - apps/desktop/src-tauri/src/commands.rs

key-decisions:
  - 'decrypt_folder_metadata rejects non-v2 with version check (strict validation)'
  - 'FilePointer with None ipns_name uses empty string placeholder with warning log'

patterns-established:
  - 'Single FolderMetadata type in Rust (no version dispatch)'
  - 'populate_folder accepts FolderMetadata directly (no AnyFolderMetadata enum)'

# Metrics
duration: 14min
completed: 2026-02-19
---

# Phase 11.2 Plan 02: Rust Desktop v2-Only Folder Metadata Summary

**Deleted v1 types (FileEntry, AnyFolderMetadata) from Rust, renamed v2 to canonical, rewrote build_folder_metadata to emit FilePointer, eliminated all v1/v2 branching in FUSE layer**

## Performance

- **Duration:** 14 min
- **Started:** 2026-02-19T02:07:41Z
- **Completed:** 2026-02-19T02:21:30Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments

- Deleted ~770 lines of v1/v2 dual-schema code from Rust codebase
- Single FolderMetadata struct (v2 schema) with strict version validation
- build_folder_metadata now emits FilePointer children instead of FileEntry
- Desktop writes version: "v2" in all folder metadata (init_vault, mkdir, build)
- All 118 Rust tests pass including new v1 rejection test

## Task Commits

Each task was committed atomically:

1. **Task 1: Delete v1 types, rename v2 to canonical in Rust crypto module** - `90cd972` (refactor)
2. **Task 2: Rewrite FUSE layer and commands to v2-only with FilePointer** - `fe41913` (feat)

## Files Created/Modified

- `apps/desktop/src-tauri/src/crypto/folder.rs` - Single FolderMetadata/FolderChild types, strict v2 decrypt
- `apps/desktop/src-tauri/src/crypto/tests.rs` - Updated tests with canonical types, added v1 rejection test
- `apps/desktop/src-tauri/src/fuse/inode.rs` - Single populate_folder (was v1/v2/any), updated test to FilePointer
- `apps/desktop/src-tauri/src/fuse/mod.rs` - PendingRefresh uses FolderMetadata, build_folder_metadata emits FilePointer, drain/pre-populate simplified
- `apps/desktop/src-tauri/src/fuse/operations.rs` - decrypt functions return FolderMetadata directly, mkdir writes v2
- `apps/desktop/src-tauri/src/fuse/cache.rs` - Test fixtures use version: "v2"
- `apps/desktop/src-tauri/src/commands.rs` - init_vault writes version: "v2"

## Decisions Made

- decrypt_folder_metadata now does strict version validation: parses JSON, checks version field is "v2", rejects anything else with DeserializationFailed error
- Files with None file_meta_ipns_name (newly created before IPNS publish) use empty string placeholder in FilePointer with a warning log; Plan 03 will address deriving IPNS in create()

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Rust codebase is now v2-only, ready for Plan 03 (per-file IPNS publish in FUSE create/release)
- The empty-string placeholder for file_meta_ipns_name on newly created files needs Plan 03 to derive IPNS keypair in create()

---

_Phase: 11.2-remove-v1-folder-metadata_
_Completed: 2026-02-19_
