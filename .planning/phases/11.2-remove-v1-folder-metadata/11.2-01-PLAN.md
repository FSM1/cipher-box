---
phase: 11.2-remove-v1-folder-metadata
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/crypto/src/folder/types.ts
  - packages/crypto/src/folder/metadata.ts
  - packages/crypto/src/folder/index.ts
  - packages/crypto/src/index.ts
  - packages/crypto/src/__tests__/folder-metadata.test.ts
  - packages/crypto/src/__tests__/file-ipns.test.ts
  - apps/web/src/services/folder.service.ts
  - apps/web/src/stores/folder.store.ts
  - apps/web/src/components/file-browser/FileBrowser.tsx
  - apps/web/src/components/file-browser/DetailsDialog.tsx
  - apps/web/src/components/file-browser/FileList.tsx
  - apps/web/src/components/file-browser/FileListItem.tsx
  - apps/web/src/components/file-browser/ContextMenu.tsx
  - apps/web/src/components/file-browser/MoveDialog.tsx
  - apps/web/src/components/file-browser/SelectionActionBar.tsx
  - apps/web/src/hooks/useContextMenu.ts
  - apps/web/src/hooks/useFolder.ts
autonomous: true

must_haves:
  truths:
    - 'Only FolderMetadata (v2 schema with FilePointer children) exists -- no v1 types remain'
    - 'validateFolderMetadata rejects v1 data (children with cid instead of fileMetaIpnsName)'
    - 'isV2Metadata type guard is deleted -- no longer needed when only one schema exists'
    - 'All web app components use FolderChild (not FolderChildV2) as canonical type'
    - 'TypeScript builds clean with no type errors'
  artifacts:
    - path: 'packages/crypto/src/folder/types.ts'
      provides: 'Canonical FolderMetadata, FolderChild types (no V2 suffix, no FileEntry, no AnyFolderMetadata)'
      contains: 'FolderChild = FolderEntry | FilePointer'
    - path: 'packages/crypto/src/folder/metadata.ts'
      provides: 'Strict v2-only validator, encrypt/decrypt accepting FolderMetadata only'
      contains: 'validateFolderMetadata'
    - path: 'packages/crypto/src/index.ts'
      provides: 'Clean exports without V2 suffixes or v1 types'
  key_links:
    - from: 'packages/crypto/src/folder/types.ts'
      to: 'apps/web/src/services/folder.service.ts'
      via: 'import { FolderMetadata, FolderChild }'
      pattern: 'FolderChild'
    - from: 'packages/crypto/src/folder/types.ts'
      to: 'apps/web/src/stores/folder.store.ts'
      via: 'import { FolderChild }'
      pattern: 'FolderChild'
---

<objective>
Delete v1 folder metadata types from TypeScript crypto package and rename v2 types to canonical names. Update all web app consumers.

Purpose: Eliminate the dual-schema types (FolderMetadata v1 + FolderMetadataV2) from the TypeScript codebase, making FolderMetadata always mean v2 (with FilePointer children). This removes ~150 lines of dead types, type guards, and import aliases from the web app.

Output: Clean TypeScript crypto package with canonical names (FolderMetadata, FolderChild), strict validator that rejects v1, and all web app files updated to use canonical types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11.2-remove-v1-folder-metadata/GOAL.md
@packages/crypto/src/folder/types.ts
@packages/crypto/src/folder/metadata.ts
@packages/crypto/src/folder/index.ts
@packages/crypto/src/index.ts
@apps/web/src/services/folder.service.ts
@apps/web/src/stores/folder.store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete v1 types, rename v2 to canonical in crypto package</name>
  <files>
    packages/crypto/src/folder/types.ts
    packages/crypto/src/folder/metadata.ts
    packages/crypto/src/folder/index.ts
    packages/crypto/src/index.ts
  </files>
  <action>
In `packages/crypto/src/folder/types.ts`:
- Delete the v1 `FolderMetadata` type (version: 'v1', children: FolderChild[])
- Delete the v1 `FolderChild` type (FolderEntry | FileEntry)
- Delete the `FileEntry` type entirely (52-72, the inline file data type with cid/fileKeyEncrypted)
- Rename `FolderMetadataV2` -> `FolderMetadata` (keep `version: 'v2'` literal)
- Rename `FolderChildV2` -> `FolderChild` (FolderEntry | FilePointer)
- Delete `AnyFolderMetadata` union type
- Delete `EncryptedFolderMetadata` -- keep it, it's the wire format (iv + data)
- Update the `FolderChild` type alias to be: `FolderEntry | FilePointer`
- Keep `FolderEntry` unchanged (subfolders)
- Keep the `FilePointer` import from `'../file/types'`

In `packages/crypto/src/folder/metadata.ts`:

- Delete `isV2Metadata()` type guard function
- Update `validateFolderMetadata()`:
  - Accept ONLY `version: 'v2'` (throw CryptoError for any other version including 'v1')
  - For file children: require `fileMetaIpnsName` (string), reject if `cid` present without `fileMetaIpnsName`
  - Return type: `FolderMetadata` (not union)
- Update `encryptFolderMetadata()` parameter type: `FolderMetadata` only (not union)
- Update `decryptFolderMetadata()` return type: `Promise<FolderMetadata>` (not union)
- Update imports to use renamed types

In `packages/crypto/src/folder/index.ts`:

- Remove `FileEntry` from type exports
- Remove `FolderMetadataV2`, `FolderChildV2`, `AnyFolderMetadata` from type exports
- Remove `isV2Metadata` from function exports
- Keep: `FolderMetadata`, `FolderChild`, `FolderEntry`, `EncryptedFolderMetadata`
- Keep: `encryptFolderMetadata`, `decryptFolderMetadata`, `validateFolderMetadata`

In `packages/crypto/src/index.ts`:

- Remove `isV2Metadata` from exports
- Remove `type FileEntry` from exports
- Remove `type FolderMetadataV2`, `type FolderChildV2`, `type AnyFolderMetadata` from exports
- Keep `type FolderMetadata`, `type FolderChild`, `type FolderEntry`, `type EncryptedFolderMetadata`

IMPORTANT: Do NOT touch `FileMetadata` in `file/types.ts` -- that's the per-file IPNS record type, separate schema.
IMPORTANT: Do NOT touch `FILE_HKDF_SALT = 'CipherBox-v1'` -- that's a cryptographic domain separator, not a version.
</action>
<verify>
Run `pnpm --filter @cipherbox/crypto typecheck` to confirm no type errors in crypto package.
Grep to confirm: `grep -r "FileEntry\|FolderMetadataV2\|FolderChildV2\|AnyFolderMetadata\|isV2Metadata" packages/crypto/src/ --include="*.ts" | grep -v "__tests__" | grep -v "node_modules"` should return no results (tests updated in next step).
</verify>
<done>
Crypto package has only canonical types: FolderMetadata (v2 schema), FolderChild (FolderEntry | FilePointer). No v1 types, no V2 suffixes, no AnyFolderMetadata union. Validator rejects v1 data.
</done>
</task>

<task type="auto">
  <name>Task 2: Update all web app imports and remove v1 guards</name>
  <files>
    apps/web/src/services/folder.service.ts
    apps/web/src/stores/folder.store.ts
    apps/web/src/components/file-browser/FileBrowser.tsx
    apps/web/src/components/file-browser/DetailsDialog.tsx
    apps/web/src/components/file-browser/FileList.tsx
    apps/web/src/components/file-browser/FileListItem.tsx
    apps/web/src/components/file-browser/ContextMenu.tsx
    apps/web/src/components/file-browser/MoveDialog.tsx
    apps/web/src/components/file-browser/SelectionActionBar.tsx
    apps/web/src/hooks/useContextMenu.ts
    apps/web/src/hooks/useFolder.ts
  </files>
  <action>
Global find-and-replace across ALL web app files:
- `FolderChildV2` -> `FolderChild` (everywhere in imports and usage)
- `FolderMetadataV2` -> `FolderMetadata` (everywhere in imports and usage)
- Remove any `AnyFolderMetadata` imports/references
- Remove any `isV2Metadata` imports/references
- Remove any `FileEntry` imports from `@cipherbox/crypto` (the folder-level FileEntry, not the file module's FileMetadata)

Specific file changes:

`apps/web/src/services/folder.service.ts`:

- Change import from `FolderMetadataV2` to `FolderMetadata`, `FolderChildV2` to `FolderChild`
- All `FolderMetadataV2` type annotations -> `FolderMetadata`
- All `FolderChildV2[]` -> `FolderChild[]`
- The `fetchAndDecryptMetadata` return type: `Promise<FolderMetadata>` (no union)
- Remove the cast `as FolderChildV2[]` at line 133 -- should work without cast since types match now

`apps/web/src/stores/folder.store.ts`:

- `FolderChildV2` -> `FolderChild` in import and all usage

`apps/web/src/components/file-browser/FileBrowser.tsx`:

- `FolderChildV2` -> `FolderChild` in import and all usage
- Delete the `isFilePointer` guard function (lines ~46-49) that checked for v1 FileEntry -- all file children are now FilePointer. If `isFilePointer` is used elsewhere for type narrowing, replace with a simpler check or inline the type guard using `item.type === 'file'` which gives FilePointer.
- Remove comment about "v1 FileEntry objects that may pass through via metadata casting"
- Remove `as FolderChildV2[]` cast at line 293

`apps/web/src/components/file-browser/DetailsDialog.tsx`:

- `FolderChildV2` -> `FolderChild` in import and usage
- Remove comment "Guard against v1 FileEntry objects that lack fileMetaIpnsName" (line 331)

`apps/web/src/components/file-browser/FileList.tsx`:

- `FolderChildV2` -> `FolderChild`

`apps/web/src/components/file-browser/FileListItem.tsx`:

- `FolderChildV2` -> `FolderChild`

`apps/web/src/components/file-browser/ContextMenu.tsx`:

- `FolderChildV2` -> `FolderChild`

`apps/web/src/components/file-browser/MoveDialog.tsx`:

- `FolderChildV2` -> `FolderChild`

`apps/web/src/components/file-browser/SelectionActionBar.tsx`:

- `FolderChildV2` -> `FolderChild`

`apps/web/src/hooks/useContextMenu.ts`:

- `FolderChildV2` -> `FolderChild`

`apps/web/src/hooks/useFolder.ts`:

- `FolderChildV2` -> `FolderChild`

Also check for any other files importing these types:
`grep -r "FolderChildV2\|FolderMetadataV2\|AnyFolderMetadata\|isV2Metadata" apps/web/src/ --include="*.ts" --include="*.tsx" -l`
</action>
<verify>
Run `pnpm --filter web typecheck` -- zero type errors.
Run `pnpm --filter web build` -- builds successfully.
Grep: `grep -r "FolderChildV2\|FolderMetadataV2\|AnyFolderMetadata\|isV2Metadata\|FileEntry" apps/web/src/ --include="*.ts" --include="*.tsx"` returns no results.
</verify>
<done>
All web app files use canonical type names (FolderMetadata, FolderChild). No V2 suffixes. No v1 type guards. No FileEntry references. Web app builds clean.
</done>
</task>

<task type="auto">
  <name>Task 3: Update crypto package tests</name>
  <files>
    packages/crypto/src/__tests__/folder-metadata.test.ts
    packages/crypto/src/__tests__/file-ipns.test.ts
  </files>
  <action>
`packages/crypto/src/__tests__/folder-metadata.test.ts`:
- Remove all v1 FileEntry test fixtures and test cases that test v1-only behavior:
  - Delete the "round-trips preserves all file entry fields" test (lines 103-140) that uses FileEntry with cid/fileKeyEncrypted
  - Delete the "handles metadata with multiple children including files" test (lines ~160-250) that mixes FolderEntry and FileEntry
  - Remove `FileEntry` from imports
- Update remaining tests:
  - The "empty children array" test: change `version: 'v1'` to `version: 'v2'`
  - The "round-trips preserves all folder entry fields" test: change `version: 'v1'` to `version: 'v2'`
  - Any test with `version: 'v1'` metadata should be converted to test v2 metadata with FilePointer children
- Add a NEW test: "rejects v1 metadata" that creates v1-format data with `version: 'v1'` and asserts `validateFolderMetadata` throws CryptoError
- Add a NEW test: "rejects file children with cid instead of fileMetaIpnsName" that creates a file child with `cid` field and no `fileMetaIpnsName` and asserts validation throws

`packages/crypto/src/__tests__/file-ipns.test.ts`:

- Change `FolderMetadataV2` imports to `FolderMetadata`
- Update all `FolderMetadataV2` type annotations to `FolderMetadata`
- Remove `isV2Metadata` import and delete the "isV2Metadata" describe block (lines 356-374)
- In the v2 metadata encrypt/decrypt test (line 321), change type annotation from `FolderMetadataV2` to `FolderMetadata`
  </action>
  <verify>
  Run `pnpm --filter @cipherbox/crypto test` -- all tests pass.
  Grep: `grep -r "FileEntry\|FolderMetadataV2\|FolderChildV2\|AnyFolderMetadata\|isV2Metadata" packages/crypto/src/__tests__/ --include="*.ts"` returns no results.
  </verify>
  <done>
  Crypto package tests validate only v2 schema. v1 rejection tests exist. No v1 types in test code. All tests pass.
  </done>
  </task>

</tasks>

<verification>
1. `pnpm --filter @cipherbox/crypto typecheck` passes
2. `pnpm --filter @cipherbox/crypto test` passes
3. `pnpm --filter web typecheck` passes
4. `pnpm --filter web build` succeeds
5. No grep results for: `FolderMetadataV2`, `FolderChildV2`, `AnyFolderMetadata`, `isV2Metadata`, `FileEntry` in `packages/crypto/src/` or `apps/web/src/` (excluding node_modules)
</verification>

<success_criteria>

- TypeScript crypto package exports ONLY canonical names: FolderMetadata, FolderChild, FolderEntry, FilePointer
- No V2 suffix types exist anywhere in TypeScript
- No FileEntry type exists (the v1 inline file data type)
- No AnyFolderMetadata union type exists
- validateFolderMetadata rejects version: 'v1' with CryptoError
- All web app components compile with canonical type names
- All crypto tests pass with v2-only test fixtures
  </success_criteria>

<output>
After completion, create `.planning/phases/11.2-remove-v1-folder-metadata/11.2-01-SUMMARY.md`
</output>
