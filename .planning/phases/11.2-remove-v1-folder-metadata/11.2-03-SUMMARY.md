---
phase: 11.2-remove-v1-folder-metadata
plan: 03
subsystem: desktop
tags: [rust, fuse, ipns, hkdf, file-metadata, per-file-ipns, recovery-tool, v2-only]

# Dependency graph
requires:
  - phase: 11.2-remove-v1-folder-metadata
    provides: TS v1 types deleted, v2 renamed to canonical (Plan 01)
  - phase: 11.2-remove-v1-folder-metadata
    provides: Rust v1 types deleted, build_folder_metadata emits FilePointer (Plan 02)
  - phase: 12.6-per-file-ipns
    provides: derive_file_ipns_keypair, encrypt_file_metadata, FileMetadata type
provides:
  - Desktop FUSE create() derives per-file IPNS keypair via HKDF
  - Desktop FUSE release() publishes per-file FileMetadata to file's own IPNS record
  - build_folder_metadata produces FilePointer with valid file_meta_ipns_name for all files
  - Recovery tool handles only v2 FilePointer children (v1 path removed)
  - Phase 11.2 complete: all 8 GOAL.md success criteria satisfied
affects: [cross-device-interop, desktop-fuse, recovery-tool]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'Per-file IPNS publish from desktop FUSE release() via background thread'
    - 'HKDF file IPNS keypair derivation in FUSE create() (deterministic from privateKey + fileId)'
    - 'publish_file_metadata async helper for encrypt + upload + IPNS sign + publish'

key-files:
  created: []
  modified:
    - apps/desktop/src-tauri/src/fuse/operations.rs
    - apps/desktop/src-tauri/src/fuse/mod.rs
    - apps/desktop/src-tauri/src/fuse/inode.rs
    - apps/web/public/recovery.html

key-decisions:
  - 'file_ipns_private_key stored on InodeKind::File as Option<Zeroizing<Vec<u8>>>'
  - 'build_folder_metadata skips (continues) files without valid file_meta_ipns_name instead of empty placeholder'
  - 'publish_file_metadata uses PublishCoordinator for sequence number management (same as folder publishes)'
  - 'Recovery tool rejects non-v2 metadata with error message and continues to next folder'

patterns-established:
  - 'Per-file IPNS publishing from desktop matches web app pattern'
  - 'mime_from_extension() for MIME type detection from filename'
  - 'get_folder_key() helper for parent folder key access in release()'

# Metrics
duration: 9min
completed: 2026-02-19
---

# Phase 11.2 Plan 03: Per-File IPNS Publish in Desktop FUSE and v2-Only Recovery Tool Summary

**Desktop FUSE create() derives file IPNS keypairs via HKDF, release() publishes per-file FileMetadata IPNS records, recovery tool handles only v2 FilePointer children**

## Performance

- **Duration:** 9 min
- **Started:** 2026-02-19T02:26:42Z
- **Completed:** 2026-02-19T02:35:42Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments

- Desktop FUSE create() now derives per-file IPNS keypair via HKDF from privateKey + fileId, stored on inode
- Desktop FUSE release() encrypts FileMetadata with parent folder key and publishes to file's own IPNS record after upload
- build_folder_metadata now skips files without valid file_meta_ipns_name (error log, not empty placeholder)
- Recovery tool updated to v2-only: rejects non-v2 metadata, validates fileMetaIpnsName, v1 inline branch removed
- All 8 GOAL.md success criteria satisfied, completing Phase 11.2
- Full test suite passes: 225 TypeScript tests, 118 Rust tests, web app build clean

## Task Commits

Each task was committed atomically:

1. **Task 1: Add per-file IPNS derivation in create() and FileMetadata publish in release()** - `987f458` (feat)
2. **Task 2: Update recovery tool to v2-only and run full cross-platform verification** - `d46ffe3` (refactor)

## Files Created/Modified

- `apps/desktop/src-tauri/src/fuse/operations.rs` - create() HKDF derivation, release() FileMetadata publish, publish_file_metadata() async helper, mime_from_extension()
- `apps/desktop/src-tauri/src/fuse/mod.rs` - get_folder_key() helper, build_folder_metadata skips files without IPNS name
- `apps/desktop/src-tauri/src/fuse/inode.rs` - file_ipns_private_key field on InodeKind::File, updated all constructors
- `apps/web/public/recovery.html` - v2-only: removed isV2/v1 branching, added version validation, added fileMetaIpnsName validation

## Decisions Made

- Store file IPNS private key as `Option<Zeroizing<Vec<u8>>>` on InodeKind::File (matches folder IPNS key pattern)
- build_folder_metadata now skips (with error log) files missing file_meta_ipns_name instead of using empty placeholder -- create() always derives the name, so this should never happen
- Per-file IPNS publish reuses PublishCoordinator for monotonic sequence numbers, same pattern as folder publishes
- Recovery tool rejects non-v2 metadata and continues to next folder (non-blocking error)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Phase 11.2 is complete: all 8 success criteria from GOAL.md are satisfied
- Desktop and web apps now produce consistent v2 folder metadata with per-file IPNS
- Cross-device interop should work: desktop creates files with IPNS keypair, publishes FileMetadata, web resolves
- Manual UAT recommended: create file on desktop, verify readable from web app and vice versa

---

_Phase: 11.2-remove-v1-folder-metadata_
_Completed: 2026-02-19_
