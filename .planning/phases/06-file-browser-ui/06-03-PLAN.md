---
phase: 06-file-browser-ui
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - apps/web/package.json
  - apps/web/src/components/file-browser/ContextMenu.tsx
  - apps/web/src/components/file-browser/ConfirmDialog.tsx
  - apps/web/src/components/file-browser/RenameDialog.tsx
  - apps/web/src/components/file-browser/FileBrowser.tsx
  - apps/web/src/components/file-browser/FileListItem.tsx
  - apps/web/src/components/file-browser/FolderTreeNode.tsx
  - apps/web/src/hooks/useContextMenu.ts
  - apps/web/src/styles/context-menu.css
  - apps/web/src/styles/dialogs.css
  - apps/web/src/components/file-browser/index.ts
autonomous: true

must_haves:
  truths:
    - "User can right-click file/folder to see context menu"
    - "Context menu shows Download (files only), Rename, Delete options"
    - "User can rename file or folder via dialog"
    - "User can delete file or folder with confirmation"
    - "User can drag file/folder to sidebar to move it"
    - "Context menu closes when clicking outside"
  artifacts:
    - path: "apps/web/src/components/file-browser/ContextMenu.tsx"
      provides: "Right-click context menu with actions"
      exports: ["ContextMenu"]
    - path: "apps/web/src/components/file-browser/ConfirmDialog.tsx"
      provides: "Delete confirmation modal"
      exports: ["ConfirmDialog"]
    - path: "apps/web/src/components/file-browser/RenameDialog.tsx"
      provides: "Rename input dialog"
      exports: ["RenameDialog"]
    - path: "apps/web/src/hooks/useContextMenu.ts"
      provides: "Context menu state management"
      exports: ["useContextMenu"]
  key_links:
    - from: "apps/web/src/components/file-browser/ContextMenu.tsx"
      to: "@floating-ui/react"
      via: "positioning middleware"
      pattern: "useFloating"
    - from: "apps/web/src/components/file-browser/FileBrowser.tsx"
      to: "useFolder hook"
      via: "CRUD operations"
      pattern: "useFolder"
    - from: "apps/web/src/components/file-browser/FileListItem.tsx"
      to: "drag-drop handlers"
      via: "native HTML5 drag events"
      pattern: "onDragStart.*dataTransfer"
---

<objective>
Implement context menu for file/folder actions and drag-drop move functionality.

Purpose: Enables users to perform actions on files and folders (WEB-04). Per CONTEXT.md: File actions are Download, Rename, Delete; Folder actions are Rename, Delete (move is drag-drop only).

Output: Working context menu with actions, confirmation/rename dialogs, and drag-drop move to sidebar folders.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-browser-ui/06-CONTEXT.md
@.planning/phases/06-file-browser-ui/06-RESEARCH.md

# Prior plan summaries (if they exist)
# Note: Plan 01 and 02 may or may not have summaries yet at execution time

# Existing folder and file operations
@apps/web/src/hooks/useFolder.ts
@apps/web/src/hooks/useFileDownload.ts
@apps/web/src/hooks/useFileDelete.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install floating-ui and create context menu infrastructure</name>
  <files>
    apps/web/package.json
    apps/web/src/hooks/useContextMenu.ts
    apps/web/src/components/file-browser/ContextMenu.tsx
    apps/web/src/styles/context-menu.css
  </files>
  <action>
Install @floating-ui/react for menu positioning:
```bash
cd apps/web && pnpm add @floating-ui/react
```

Create useContextMenu hook:
- State: { visible: boolean, x: number, y: number, item: FolderChild | null }
- show(event: React.MouseEvent, item: FolderChild) - sets position and item, prevents default
- hide() - resets state
- Returns { visible, x, y, item, show, hide }

Create ContextMenu component:
- Props: x, y, item (FolderChild), onClose, onDownload, onRename, onDelete
- Uses @floating-ui/react's useFloating with:
  - Virtual reference element at (x, y) click position
  - offset(4), flip(), shift({ padding: 8 }) middleware for edge detection
- Renders in Portal
- Backdrop div with onClick={onClose} to close on outside click
- Menu items:
  - "Download" (only if item.type === 'file')
  - "Rename" - calls onRename, closes menu
  - "Delete" - calls onDelete, closes menu
- Each item is a button with hover state
- Close menu after any action

Add useEffect in parent to close menu on document click:
```typescript
useEffect(() => {
  if (!contextMenu.visible) return;
  const handleClick = () => contextMenu.hide();
  document.addEventListener('click', handleClick);
  return () => document.removeEventListener('click', handleClick);
}, [contextMenu.visible, contextMenu.hide]);
```

Create context-menu.css:
- .context-menu-backdrop - fixed, inset-0, transparent (for click capture)
- .context-menu - absolute, white/dark bg, rounded, shadow, min-width 150px
- .context-menu-item - full width button, padding, hover bg change
- .context-menu-divider - thin border line (if needed)
  </action>
  <verify>
@floating-ui/react in package.json
TypeScript compiles: `pnpm exec tsc --noEmit`
Lint passes: `pnpm lint`
  </verify>
  <done>
@floating-ui/react installed.
useContextMenu hook manages show/hide state.
ContextMenu renders at click position with proper positioning.
Menu closes on outside click or action selection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create confirmation and rename dialogs</name>
  <files>
    apps/web/src/components/file-browser/ConfirmDialog.tsx
    apps/web/src/components/file-browser/RenameDialog.tsx
    apps/web/src/styles/dialogs.css
  </files>
  <action>
Create ConfirmDialog component:
- Props: open, onClose, onConfirm, title, message, confirmLabel (default "Delete"), isDestructive (default true)
- Uses Modal component from ui/Modal.tsx
- Title at top (e.g., "Delete File?" or "Delete Folder?")
- Message in body (e.g., "Are you sure you want to delete 'filename'? This cannot be undone.")
- For folders: "This will also delete all files and subfolders inside."
- Two buttons: Cancel (secondary), Confirm (primary, red if isDestructive)
- Per CONTEXT.md: Delete always confirms with modal dialog

Create RenameDialog component:
- Props: open, onClose, onConfirm, currentName, itemType ('file' | 'folder')
- Uses Modal component
- Title: "Rename File" or "Rename Folder"
- Input field with current name pre-filled, auto-selected
- Two buttons: Cancel, Rename (primary)
- Validate: name not empty, name not same as current
- On Enter key: submit if valid
- Focus input on open

Create dialogs.css:
- .dialog-actions - flex row, gap, justify-end
- .dialog-button - base button style
- .dialog-button-primary - primary color
- .dialog-button-destructive - red/danger color
- .dialog-input - full width text input
- .dialog-message - body text styling
  </action>
  <verify>
TypeScript compiles: `pnpm exec tsc --noEmit`
Lint passes: `pnpm lint`
  </verify>
  <done>
ConfirmDialog shows delete warning with Cancel/Confirm.
RenameDialog shows input with current name selected.
Enter submits rename, Escape cancels.
Dialogs use Modal component for consistent styling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire up actions and drag-drop move in FileBrowser</name>
  <files>
    apps/web/src/components/file-browser/FileBrowser.tsx
    apps/web/src/components/file-browser/FileListItem.tsx
    apps/web/src/components/file-browser/FolderTreeNode.tsx
    apps/web/src/components/file-browser/index.ts
  </files>
  <action>
Update FileBrowser.tsx:
- Import and use useContextMenu hook
- Import useFolder for CRUD operations (renameItem, deleteItem, moveItem)
- Import useFileDownload for download action
- State for dialogs: confirmDialog, renameDialog (each has open, item fields)
- Context menu handlers:
  - handleDownload: get file metadata from item, call download(metadata)
  - handleRename: open RenameDialog with item
  - handleDelete: open ConfirmDialog with item
- Dialog confirm handlers:
  - onRenameConfirm(newName): call renameItem(item.id, item.type, newName, currentFolderId)
  - onDeleteConfirm: call deleteItem(item.id, item.type, currentFolderId)
- Pass context menu handlers to FileList
- Render ContextMenu when visible
- Render ConfirmDialog and RenameDialog with appropriate state
- Add UploadZone to empty state or toolbar area
- Add UploadModal (always rendered, self-manages visibility)

Update FileListItem.tsx:
- Add onContextMenu prop handler
- Add draggable="true"
- onDragStart: set dataTransfer with JSON { id, type, parentId: currentFolderId }
- set effectAllowed = 'move'

Update FolderTreeNode.tsx:
- Add onDrop prop handler
- onDragOver: preventDefault, set dropEffect = 'move'
- onDrop: parse dataTransfer JSON, call onDrop(id, type, sourceParentId, targetFolderId)
- Visual feedback: add class when dragging over valid drop target
- Prevent dropping folder onto itself or its descendants (check in handler)

Wire move operation in FileBrowser:
- handleMove(itemId, itemType, sourceId, destId): call moveItem from useFolder
- Pass handleMove to FolderTree as onDrop

Update index.ts exports.
  </action>
  <verify>
TypeScript compiles: `pnpm exec tsc --noEmit`
Lint passes: `pnpm lint`
Manual test: Right-click file, select Download - file downloads
Manual test: Right-click file, select Rename - dialog opens, rename works
Manual test: Right-click file, select Delete - confirmation shows, delete works
Manual test: Drag file to sidebar folder - file moves
  </verify>
  <done>
Right-click shows context menu with appropriate actions.
Download downloads the file.
Rename opens dialog and updates name.
Delete shows confirmation and removes item.
Drag-drop to sidebar moves file/folder to target folder.
Menu closes after action or outside click.
  </done>
</task>

</tasks>

<verification>
1. `pnpm install` succeeds
2. TypeScript compiles: `pnpm exec tsc --noEmit`
3. Lint passes: `pnpm lint`
4. Right-click file shows context menu with Download, Rename, Delete
5. Right-click folder shows context menu with Rename, Delete (no Download)
6. Rename dialog works with Enter/button submit
7. Delete shows confirmation modal
8. Drag file/folder to sidebar folder moves it
</verification>

<success_criteria>
- WEB-04: User can right-click for context menu with rename, delete, move options
- Download downloads file to user's device
- Rename updates item name in folder
- Delete removes item with confirmation
- Drag-drop moves items between folders
- Context menu closes on action or outside click
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-browser-ui/06-03-SUMMARY.md`
</output>
