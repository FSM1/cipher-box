---
phase: 06-file-browser-ui
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/src/components/file-browser/UploadZone.tsx
  - apps/web/src/components/file-browser/UploadModal.tsx
  - apps/web/src/components/file-browser/UploadItem.tsx
  - apps/web/src/components/ui/Modal.tsx
  - apps/web/src/components/ui/Portal.tsx
  - apps/web/src/components/ui/index.ts
  - apps/web/src/styles/upload.css
  - apps/web/src/styles/modal.css
autonomous: true

must_haves:
  truths:
    - "User can drag files onto drop zone to upload"
    - "User can click drop zone to open file picker"
    - "User sees modal with upload progress for each file"
    - "User can cancel individual file uploads"
    - "User sees error messages with retry button on failure"
  artifacts:
    - path: "apps/web/src/components/file-browser/UploadZone.tsx"
      provides: "Drag-drop upload area using react-dropzone"
      exports: ["UploadZone"]
    - path: "apps/web/src/components/file-browser/UploadModal.tsx"
      provides: "Upload progress modal with file queue"
      exports: ["UploadModal"]
    - path: "apps/web/src/components/ui/Modal.tsx"
      provides: "Reusable modal dialog component"
      exports: ["Modal"]
  key_links:
    - from: "apps/web/src/components/file-browser/UploadZone.tsx"
      to: "react-dropzone"
      via: "useDropzone hook"
      pattern: "useDropzone"
    - from: "apps/web/src/components/file-browser/UploadModal.tsx"
      to: "useUploadStore"
      via: "Zustand subscription"
      pattern: "useUploadStore"
    - from: "apps/web/src/components/file-browser/UploadZone.tsx"
      to: "useFileUpload hook"
      via: "hook import"
      pattern: "useFileUpload"
---

<objective>
Implement drag-drop file upload with progress modal showing upload queue.

Purpose: Enables users to add files to their vault (WEB-03). Per CONTEXT.md, uploads should have a modal dialog showing all queued files with individual progress bars, per-file cancel and retry.

Output: Working upload zone with drag-drop and click-to-upload, plus modal showing upload progress.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-browser-ui/06-CONTEXT.md
@.planning/phases/06-file-browser-ui/06-RESEARCH.md

# Existing upload infrastructure
@apps/web/src/hooks/useFileUpload.ts
@apps/web/src/stores/upload.store.ts
@apps/web/src/services/upload.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-dropzone and create base UI components</name>
  <files>
    apps/web/package.json
    apps/web/src/components/ui/Portal.tsx
    apps/web/src/components/ui/Modal.tsx
    apps/web/src/components/ui/index.ts
    apps/web/src/styles/modal.css
  </files>
  <action>
Install react-dropzone:
```bash
cd apps/web && pnpm add react-dropzone
```

Create Portal component:
- Simple wrapper using createPortal to document.body
- Props: children, container (optional, defaults to document.body)

Create Modal component:
- Props: open (boolean), onClose (optional callback), children, title (optional)
- Uses Portal to render outside component tree
- Backdrop with click-to-close (only if onClose provided)
- Centered dialog box with padding
- Close button (X) in top-right if onClose provided
- Escape key closes (if onClose provided)
- Focus trap: prevent tab from leaving modal
- aria-modal="true", role="dialog"

Create modal.css styles:
- .modal-backdrop - fixed full screen, semi-transparent black, z-index: 1000
- .modal-container - centered, max-width 500px, white/dark background
- .modal-header - title + close button
- .modal-body - content area with padding
- .modal-close - button styling

Create ui/index.ts barrel export.
  </action>
  <verify>
react-dropzone in package.json dependencies
TypeScript compiles: `pnpm exec tsc --noEmit`
Lint passes: `pnpm lint`
  </verify>
  <done>
react-dropzone installed.
Modal component renders in portal with backdrop.
Click backdrop or Escape closes modal (when onClose provided).
Focus stays within modal when open.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UploadZone component with react-dropzone</name>
  <files>
    apps/web/src/components/file-browser/UploadZone.tsx
    apps/web/src/styles/upload.css
  </files>
  <action>
Create UploadZone component:
- Props: folderId (current folder to upload into), onUploadComplete (optional callback)
- Uses useDropzone from react-dropzone with:
  - onDrop callback that handles file list
  - noClick: false (allow click to open file dialog)
  - multiple: true (allow multiple files)
  - maxSize: 100 * 1024 * 1024 (100MB per FILE-01)
- Uses useFileUpload hook for upload, canUpload, error state
- On drop:
  1. Calculate total size of dropped files
  2. Check canUpload(totalSize) - if false, show quota error
  3. Call upload(files) - this encrypts and uploads via upload.service.ts
  4. On success, call onUploadComplete if provided (to refresh folder)
- Visual states:
  - isDragActive: highlight border, show "Drop files here"
  - Normal: dashed border, show "Drag files here or click to upload"
  - Uploading: show "Uploading..." text (modal handles details)

Create upload.css styles:
- .upload-zone - bordered area, min-height 100px, dashed border
- .upload-zone-active - solid border, background highlight when dragging over
- .upload-zone-content - centered text and icon
- .upload-zone-icon - upload icon (use unicode or emoji temporarily)
- .upload-zone-text - instructional text

Note: The UploadZone can be rendered in EmptyState (full area) or as a toolbar button area.
The actual upload progress is shown in UploadModal (Task 3).
  </action>
  <verify>
TypeScript compiles: `pnpm exec tsc --noEmit`
Lint passes: `pnpm lint`
  </verify>
  <done>
UploadZone renders drop area with dashed border.
Dragging files over highlights the zone.
Dropping files triggers upload flow.
Clicking zone opens file picker.
Files over 100MB show error.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create UploadModal with progress tracking</name>
  <files>
    apps/web/src/components/file-browser/UploadModal.tsx
    apps/web/src/components/file-browser/UploadItem.tsx
    apps/web/src/components/file-browser/index.ts
    apps/web/src/styles/upload.css
  </files>
  <action>
Create UploadItem component:
- Props: filename, status ('pending' | 'encrypting' | 'uploading' | 'complete' | 'error'), progress (0-100), error (string | null), onCancel, onRetry
- Renders single file row in upload queue:
  - File icon + filename
  - Progress bar (0-100%)
  - Status text: "Encrypting...", "Uploading...", "Complete", or error message
  - Cancel button (X) - visible during encrypting/uploading
  - Retry button - visible on error
- Progress bar width based on progress percentage

Create UploadModal component:
- Uses useUploadStore to get: status, progress, currentFile, totalFiles, completedFiles, error, cancel, reset
- Modal opens when status is not 'idle' and not 'success' (show during upload/error)
- Title: "Uploading Files" or "Upload Complete" or "Upload Error"
- Content:
  - Overall progress: "{completedFiles} of {totalFiles} files"
  - Current file being processed with progress bar
  - Per CONTEXT.md: Show all queued files with individual progress
  - Note: Current upload store tracks batch progress, not individual files. Enhance store if needed, or show simplified view of current file only.
- Actions:
  - Cancel All button (calls cancel())
  - Close button (only shown on success/error, calls reset())
- Modal cannot be closed during active upload (no onClose while uploading)

For v1 simplification (per CONTEXT.md "keep v1 simple"):
- Show current file progress + overall batch progress
- Individual file tracking can be enhanced in future

Update upload.css with additional styles:
- .upload-modal-* - modal-specific layout
- .upload-item-* - individual file row
- .upload-progress-* - progress bar styling

Update file-browser/index.ts to export UploadZone and UploadModal.
  </action>
  <verify>
TypeScript compiles: `pnpm exec tsc --noEmit`
Lint passes: `pnpm lint`
  </verify>
  <done>
UploadModal appears during file upload.
Shows current file name and progress bar.
Shows overall progress (X of Y files).
Cancel button stops upload.
Close button available after completion/error.
Error state shows retry option.
  </done>
</task>

</tasks>

<verification>
1. `pnpm install` succeeds (react-dropzone installed)
2. TypeScript compiles: `pnpm exec tsc --noEmit`
3. Lint passes: `pnpm lint`
4. Manual test: Drop file on UploadZone, verify UploadModal appears with progress
5. Manual test: Click UploadZone, verify file picker opens
</verification>

<success_criteria>
- WEB-03: User can drag-drop files to upload
- Drop zone highlights on drag over
- File picker opens on click
- Upload modal shows progress
- Cancel stops in-progress upload
- Error shows with retry option
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-browser-ui/06-02-SUMMARY.md`
</output>
