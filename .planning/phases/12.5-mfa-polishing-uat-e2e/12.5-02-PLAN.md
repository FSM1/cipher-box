---
phase: 12.5-mfa-polishing-uat-e2e
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/e2e/package.json
  - tests/e2e/tests/wallet-login.spec.ts
  - tests/e2e/page-objects/login.page.ts
autonomous: true

must_haves:
  truths:
    - 'Wallet E2E test connects mock wallet and completes SIWE login flow'
    - 'Wallet E2E test verifies user rejection is handled gracefully'
    - 'Wallet E2E test verifies no-wallet state shows appropriate message'
    - "Mock wallet is discoverable via EIP-6963 by wagmi's injected() connector"
  artifacts:
    - path: 'tests/e2e/tests/wallet-login.spec.ts'
      provides: 'Wallet login E2E test suite covering TC09-TC12'
      min_lines: 80
    - path: 'tests/e2e/page-objects/login.page.ts'
      provides: 'Updated login page object with wallet-specific selectors'
      contains: 'walletLoginButton'
  key_links:
    - from: 'tests/e2e/tests/wallet-login.spec.ts'
      to: '@johanneskares/wallet-mock'
      via: 'installMockWallet in beforeEach'
      pattern: 'installMockWallet'
    - from: 'tests/e2e/tests/wallet-login.spec.ts'
      to: 'apps/web/src/components/auth/WalletLoginButton.tsx'
      via: 'data-testid selectors'
      pattern: 'wallet-login-button'
---

<objective>
Add wallet E2E tests using @johanneskares/wallet-mock for EIP-6963 mock provider

Purpose: Enable automated wallet login testing (TC09-TC12) without requiring a real browser wallet extension. The mock wallet announces via EIP-6963, which wagmi's injected() connector auto-discovers. The mock uses viem's privateKeyToAccount for real ECDSA signatures, so the backend's SIWE verifyMessage() does real crypto verification.

Output: New wallet-login.spec.ts test file with 4 test cases, updated LoginPage page object with wallet selectors, wallet-mock package installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/debug/corekit-auth-uat.md

Key implementation context:

- `apps/web/src/components/auth/WalletLoginButton.tsx` -- the component under test. Flow: click [WALLET] -> show connectors -> click connector -> connectAsync -> SIWE nonce -> sign -> verify -> onLogin
- `apps/web/src/lib/wagmi/config.ts` -- uses `injected()` connector which auto-discovers EIP-6963 providers
- `apps/api/src/auth/services/siwe.service.ts` -- backend verifies SIWE with viem's verifyMessage (real crypto)
- `tests/e2e/playwright.config.ts` -- existing Playwright config, webServer starts API + web + mock IPNS
- `tests/e2e/page-objects/login.page.ts` -- existing login page object (email + Google only, needs wallet selectors)
- `tests/e2e/utils/web3auth-helpers.ts` -- existing auth helpers

wallet-mock API:

```typescript
import { installMockWallet } from '@johanneskares/wallet-mock';
import { privateKeyToAccount } from 'viem/accounts';

await installMockWallet({
  page,
  account: privateKeyToAccount('0x...'),
  defaultChain: mainnet,
  transports: { [mainnet.id]: http() },
});
```

The mock wallet auto-announces via EIP-6963, appears as "Mock Wallet" in connector list. All actions pre-approved (no popup/approval UI).
</context>

<tasks>

<task type="auto">
<name>Task 1: Install wallet-mock and add wallet selectors to LoginPage</name>
<files>tests/e2e/package.json, tests/e2e/page-objects/login.page.ts</files>
<action>
Install `@johanneskares/wallet-mock` as devDependency in the e2e package:

```bash
cd tests/e2e && pnpm add -D @johanneskares/wallet-mock
```

Also ensure `viem` is available (peer dep of wallet-mock, already in monorepo but e2e package may need it explicitly):

```bash
cd tests/e2e && pnpm add -D viem
```

Add wallet-specific selectors to `tests/e2e/page-objects/login.page.ts`:

- `walletLoginButton`: `[data-testid="wallet-login-button"]`
- `walletConnectorList`: `.wallet-connector-list`
- `walletConnectorOption`: `.wallet-connector-option` (parametric by name)
- `walletConnectorCancel`: `.wallet-connector-cancel`
- `walletNoProviders`: `.wallet-no-providers`
- `walletLoginStatus`: `.wallet-login-status`

Add methods to LoginPage:

- `clickWalletLogin()` -- clicks the [WALLET] button
- `getWalletConnectors()` -- returns list of connector names visible in the connector list
- `selectWalletConnector(name: string)` -- clicks a specific connector button by matching text
- `cancelWalletLogin()` -- clicks the cancel button in connector list
- `getWalletError()` -- returns error text if visible, null otherwise
- `isWalletConnectorListVisible()` -- checks if connector list is shown
- `getWalletStatus()` -- returns status text (e.g., "connecting wallet...", "sign the message...")
  </action>
  <verify>

1. `grep "wallet-mock" tests/e2e/package.json` shows the dependency
2. `grep "walletLoginButton" tests/e2e/page-objects/login.page.ts` shows the selector
3. `cd tests/e2e && pnpm tsc --noEmit` passes
   </verify>
   <done>
   wallet-mock installed in e2e package. LoginPage has wallet-specific selectors and methods.
   </done>
   </task>

<task type="auto">
<name>Task 2: Create wallet-login.spec.ts with TC09-TC12 test cases</name>
<files>tests/e2e/tests/wallet-login.spec.ts</files>
<action>
Create `tests/e2e/tests/wallet-login.spec.ts` with the following test cases. Each test gets a fresh page context with `installMockWallet` injected before the page loads.

IMPORTANT: The wallet login flow requires both the wallet mock AND a running backend (for SIWE nonce + verify + Core Kit login). The full flow includes Core Kit loginWithJWT which needs Web3Auth devnet. If TEST_LOGIN_SECRET is set, wallet tests should note that test-login bypass does not support wallet auth and proceed to test the frontend UI flow only.

Test structure -- 4 describe blocks for TC09-TC12:

TC09 describe "Wallet login happy path (with mock wallet)": beforeEach installs `installMockWallet` with Hardhat account #0 private key (`0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80`), mainnet chain, http transport, then navigates to login page. Three tests: (1) "wallet button is visible and enabled" -- wait for Core Kit init, assert wallet button visible and enabled. (2) "clicking wallet shows mock wallet in connector list" -- click wallet button, assert `.wallet-connector-list` visible, assert "Mock Wallet" appears in connectors. (3) "selecting mock wallet initiates SIWE flow" -- click wallet, select Mock Wallet, wait for either redirect to /files (success) or error message; mock wallet auto-approves connectAsync and signMessage; if Core Kit fails (devnet unreachable), log it as the SIWE UI flow is still validated.

TC10 describe "Wallet login cancel": beforeEach installs mock wallet and navigates to login page. One test: "cancelling wallet connector list returns to initial state" -- click wallet, assert connector list visible, click cancel, assert connector list hidden, assert wallet button visible and enabled.

TC11 describe "Wallet login no wallet detected": beforeEach does NOT install mock wallet, just navigates to login page. One test: "no wallet message shown when no providers detected" -- click wallet, check for `.wallet-no-providers` message or zero connector options; wagmi may report phantom injected connectors so handle both cases; cancel should work.

TC12 describe "Wallet login error handling": beforeEach installs mock wallet and navigates to login page. One test: "error during SIWE flow shows error message and allows retry" -- intercept `**/auth/identity/wallet/nonce` with `page.route()` returning 500, click wallet, select Mock Wallet, assert `.login-error` becomes visible, unroute the interception, assert wallet button returns to idle and enabled state.

Key details:

- `installMockWallet` must be called BEFORE `page.goto()`
- Use Hardhat account #0 (well-known test key, no real funds)
- CipherBox only needs `eth_requestAccounts` and `personal_sign`
- wallet-mock auto-approves both (no popup)
- Backend SIWE verify does real ECDSA verification
  </action>
  <verify>

1. `ls tests/e2e/tests/wallet-login.spec.ts` exists
2. `grep "installMockWallet" tests/e2e/tests/wallet-login.spec.ts` shows mock wallet setup
3. `grep "TC09\|TC10\|TC11\|TC12" tests/e2e/tests/wallet-login.spec.ts` shows all 4 test case references
4. `cd tests/e2e && pnpm tsc --noEmit` passes
5. `cd /Users/michael/Code/cipher-box && pnpm --filter @cipherbox/e2e exec playwright test tests/wallet-login.spec.ts --list` lists all tests without errors
   </verify>
   <done>
   wallet-login.spec.ts exists with TC09-TC12 test cases. All tests use installMockWallet for EIP-6963 mock. TypeScript compiles. Tests are listable by Playwright.
   </done>
   </task>

</tasks>

<verification>

- `pnpm --filter @cipherbox/e2e exec playwright test tests/wallet-login.spec.ts --list` lists all wallet test cases
- `cd tests/e2e && pnpm tsc --noEmit` compiles without errors
- wallet-mock package is in tests/e2e/package.json devDependencies
- LoginPage has wallet-specific selectors and methods

</verification>

<success_criteria>

- @johanneskares/wallet-mock installed in E2E package
- wallet-login.spec.ts covers TC09 (happy path), TC10 (cancel), TC11 (no wallet), TC12 (reject/error)
- Mock wallet is discoverable by wagmi's injected() connector via EIP-6963
- Tests compile and are listable by Playwright
- LoginPage page object extended with wallet selectors and methods

</success_criteria>

<output>
After completion, create `.planning/phases/12.5-mfa-polishing-uat-e2e/12.5-02-SUMMARY.md`
</output>
