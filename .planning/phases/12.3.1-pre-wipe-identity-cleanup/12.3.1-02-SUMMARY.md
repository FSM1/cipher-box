---
phase: 12.3.1-pre-wipe-identity-cleanup
plan: 02
subsystem: auth
tags: [sha-256, identity-hash, auth-method, siwe, privacy]

# Dependency graph
requires:
  - phase: 12.3-siwe-unified-identity
    provides: SIWE wallet login, auth method entity with identifier_hash (wallet-only), cross-method email auto-linking
provides:
  - SHA-256 hashed identifiers for all auth method types (Google sub, email, wallet address)
  - Independent auth methods with no cross-method email auto-linking
  - Generic hashIdentifier utility in SiweService
  - Widened identifier_display column for email storage
  - Composite index on (type, identifier_hash) for efficient lookups
affects: [12.3.1-03, 12.3.1-04, 12.4-mfa]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'Hash-based identifier lookup: all auth methods use SHA-256(canonical_value) for identifier storage and lookup'
    - 'identifierDisplay for human-readable output: getLinkedMethods and refreshByToken return identifierDisplay, not hashed identifier'
    - 'Independent auth methods: no cross-method email matching; users link explicitly via Settings'

key-files:
  created: []
  modified:
    - apps/api/src/auth/services/siwe.service.ts
    - apps/api/src/auth/entities/auth-method.entity.ts
    - apps/api/src/migrations/1700000000000-FullSchema.ts
    - apps/api/src/auth/controllers/identity.controller.ts
    - apps/api/src/auth/auth.service.ts
    - apps/api/src/auth/services/siwe.service.spec.ts
    - apps/api/src/auth/controllers/identity.controller.spec.ts
    - apps/api/src/auth/auth.service.spec.ts
    - packages/api-client/openapi.json

key-decisions:
  - 'Google login hashes googlePayload.sub (immutable Google user ID), NOT email -- emails can change but sub never does'
  - 'Email login hashes normalized (lowercased+trimmed) email'
  - 'Cross-method email auto-linking removed entirely -- each auth method is independent'
  - 'identifier column stores the hash (same as identifierHash) for all types'
  - 'identifierDisplay holds the human-readable value for all types (email, truncated address)'

patterns-established:
  - 'findOrCreateUserByIdentifier: unified lookup by (type, identifierHash) for Google and email auth methods'
  - 'Hash-then-store: all new auth methods store identifier=hash, identifierHash=hash, identifierDisplay=readable'

# Metrics
duration: 10min
completed: 2026-02-14
---

# Phase 12.3.1 Plan 02: SHA-256 Hashed Identifiers Summary

SHA-256 hashed identifiers for all auth methods (Google sub, email, wallet) with cross-method auto-linking removed.

## Performance

- **Duration:** 10 min
- **Started:** 2026-02-14T16:51:24Z
- **Completed:** 2026-02-14T17:01:43Z
- **Tasks:** 3
- **Files modified:** 9

## Accomplishments

- All auth method identifiers now stored as SHA-256 hashes (no plaintext emails/subs in identifier column)
- Google login hashes the immutable `sub` claim, not the mutable email
- Cross-method email auto-linking block completely removed from identity controller
- `identifierDisplay` used for all human-readable output (getLinkedMethods, refreshByToken)
- Generic `hashIdentifier()` method added to SiweService for non-wallet identifiers
- `identifier_display` column widened from varchar(15) to varchar(255) for email storage
- Composite index on (type, identifier_hash) added for efficient auth method lookups
- All 460 tests pass across 24 suites

## Task Commits

Each task was committed atomically:

1. **Task 1: Schema, entity, migration, and SiweService hash utility** - `2716daddc` (feat)
2. **Task 2: Hash all auth identifiers and remove auto-linking** - `a7d31bf98` (feat)
3. **Task 3: Update tests and regenerate API client** - `dab238220` (test)

## Files Created/Modified

- `apps/api/src/auth/services/siwe.service.ts` - Added generic hashIdentifier(value) method
- `apps/api/src/auth/entities/auth-method.entity.ts` - Widened identifier_display to varchar(255), updated column comments
- `apps/api/src/migrations/1700000000000-FullSchema.ts` - Widened identifier_display, added composite (type, identifier_hash) index
- `apps/api/src/auth/controllers/identity.controller.ts` - Refactored to findOrCreateUserByIdentifier, hashes Google sub and email, removed cross-method linking
- `apps/api/src/auth/auth.service.ts` - Hash-based lookups in login/linkJwtMethod/testLogin/refreshByToken, identifierDisplay for output
- `apps/api/src/auth/services/siwe.service.spec.ts` - hashIdentifier tests (consistency, no normalization, different inputs)
- `apps/api/src/auth/controllers/identity.controller.spec.ts` - Updated for hash-based lookups, added no-auto-linking test
- `apps/api/src/auth/auth.service.spec.ts` - Updated all tests for identifierHash lookups and identifierDisplay output
- `packages/api-client/openapi.json` - Regenerated API client

## Decisions Made

- Google login hashes `googlePayload.sub` (immutable Google user ID), NOT email -- emails can change but sub never does
- Cross-method email auto-linking removed entirely -- each auth method type is fully independent
- `identifier` column now stores the hash for all types (same value as identifierHash)
- `identifierDisplay` holds the human-readable value for all types

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- Pre-commit hook requires `packages/api-client/openapi.json` to be staged when API source files change -- needed to regenerate and include it with each task commit that touched controller/entity files.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- All auth method lookups now use hash-based identifiers
- Ready for Plan 03 (frontend changes) and Plan 04 (vault export cleanup)
- No blockers

---

_Phase: 12.3.1-pre-wipe-identity-cleanup_
_Completed: 2026-02-14_
