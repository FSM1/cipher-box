---
phase: 12.3.1-pre-wipe-identity-cleanup
plan: 04
type: execute
wave: 2
depends_on: ['12.3.1-01']
files_modified:
  - apps/desktop/src-tauri/src/api/types.rs
  - apps/desktop/src-tauri/src/state.rs
  - apps/desktop/src-tauri/src/commands.rs
  - tests/e2e/utils/web3auth-helpers.ts
  - apps/api/src/vault/vault.controller.spec.ts
autonomous: true

must_haves:
  truths:
    - 'Desktop Rust types no longer reference root_ipns_public_key in API DTOs'
    - 'Desktop state no longer stores root_ipns_public_key (it is derivable)'
    - 'Desktop commands derive IPNS public key from private key instead of reading it from API response'
    - 'E2E web3auth helpers no longer pass rootIpnsPublicKey to EncryptedVaultKeys (updated type from Plan 01)'
    - 'E2E helpers still produce correct rootIpnsKeypair (public key derived from private key)'
    - 'vault.controller.spec.ts fixtures no longer include rootIpnsPublicKey'
  artifacts:
    - path: 'apps/desktop/src-tauri/src/api/types.rs'
      provides: 'InitVaultRequest and VaultResponse without root_ipns_public_key'
    - path: 'apps/desktop/src-tauri/src/state.rs'
      provides: 'AppState without root_ipns_public_key field'
    - path: 'tests/e2e/utils/web3auth-helpers.ts'
      provides: 'Updated helpers compatible with new EncryptedVaultKeys type'
    - path: 'apps/api/src/vault/vault.controller.spec.ts'
      provides: 'Controller tests without rootIpnsPublicKey in fixtures'
  key_links:
    - from: 'apps/desktop/src-tauri/src/commands.rs'
      to: 'apps/desktop/src-tauri/src/state.rs'
      via: 'State no longer writes root_ipns_public_key'
      pattern: 'root_ipns_public_key'
    - from: 'tests/e2e/utils/web3auth-helpers.ts'
      to: '@cipherbox/crypto'
      via: 'decryptVaultKeys and encryptVaultKeys without rootIpnsPublicKey'
      pattern: 'decryptVaultKeys|encryptVaultKeys'
---

<objective>
Remove all remaining rootIpnsPublicKey references from the desktop Rust app, E2E test helpers, and vault controller spec. These are the final consumers that were not covered by Plans 01-03.

Purpose: After Plans 01 and 03 remove rootIpnsPublicKey from the crypto types and API, these downstream consumers would fail to compile/run. This plan ensures all code across the monorepo is consistent with the new rootIpnsPublicKey-free design.

Output: Clean codebase with zero rootIpnsPublicKey references in source files.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Plan 01 summary (crypto type changes that drive these updates)

@.planning/phases/12.3.1-pre-wipe-identity-cleanup/12.3.1-01-SUMMARY.md

# Desktop Rust files to update

@apps/desktop/src-tauri/src/api/types.rs
@apps/desktop/src-tauri/src/state.rs
@apps/desktop/src-tauri/src/commands.rs

# E2E helpers to update

@tests/e2e/utils/web3auth-helpers.ts

# Controller spec to update

@apps/api/src/vault/vault.controller.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove rootIpnsPublicKey from desktop Rust app</name>
  <files>
    apps/desktop/src-tauri/src/api/types.rs
    apps/desktop/src-tauri/src/state.rs
    apps/desktop/src-tauri/src/commands.rs
  </files>
  <action>
**Update API types** in `apps/desktop/src-tauri/src/api/types.rs`:

- Remove `pub root_ipns_public_key: String` from `InitVaultRequest` struct (around line 57)
- Remove `pub root_ipns_public_key: String` from `VaultResponse` struct (around line 68)
- These structs map to the backend DTOs which no longer have this field (Plan 03 removes it)

**Update state** in `apps/desktop/src-tauri/src/state.rs`:

- Remove `pub root_ipns_public_key: RwLock<Option<Vec<u8>>>` field (line 51)
- Remove `root_ipns_public_key: RwLock::new(None)` from `AppState::new()` (line 81)
- Remove the zeroize block for `root_ipns_public_key` in the `clear()` method (lines 117-120)
- The desktop app never reads this value (confirmed by grep -- no `.read()` calls on it), so removing it has no functional impact beyond matching the updated API

**Update commands** in `apps/desktop/src-tauri/src/commands.rs`:

- In the vault init command (around line 412): Remove `root_ipns_public_key: hex::encode(&ipns_pub_array)` from the `InitVaultRequest` construction. The public key is derivable and no longer sent to the API.
- In the vault load/decrypt command (around lines 536-539): Remove the block that decodes `vault.root_ipns_public_key` and stores it in state:

  ```rust
  // DELETE these lines:
  let root_ipns_public_key = hex::decode(&vault.root_ipns_public_key)
      .map_err(|_| "Invalid rootIpnsPublicKey hex")?;
  *state.root_ipns_public_key.write().await = Some(root_ipns_public_key);
  ```

- The IPNS public key can be derived from the IPNS private key (which is still decrypted and stored in state) if ever needed. Currently it is never read from state.
  </action>
  <verify>
  Run `cd /Users/michael/Code/cipher-box && cd apps/desktop && cargo check 2>&1 | head -50` -- should compile without errors (may have warnings about unused vars, which is fine).
  Grep for `root_ipns_public_key` in apps/desktop/src-tauri/src/ -- should NOT appear.
  </verify>
  <done>
  Desktop Rust app no longer references root_ipns_public_key in types, state, or commands. Cargo check passes.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Update E2E helpers and vault controller spec</name>
  <files>
    tests/e2e/utils/web3auth-helpers.ts
    apps/api/src/vault/vault.controller.spec.ts
  </files>
  <action>
**Update web3auth-helpers.ts** in `tests/e2e/utils/web3auth-helpers.ts`:

The E2E helper initializes or loads the vault and passes keys to Playwright's browser context. It needs updates to match the new crypto types:

1. Remove `rootIpnsPublicKeyArr` from the `VaultData` type (line 37) -- no longer stored separately since it's derivable from the private key
2. Remove the `rootIpnsPublicKey` variable declaration (line 127)
3. In the existing vault branch (around line 139-141): Remove `rootIpnsPublicKey: hexToBytes(vault.rootIpnsPublicKey)` from the object passed to `decryptVaultKeys`. The updated `decryptVaultKeys` (Plan 01) only accepts `{ encryptedRootFolderKey, encryptedIpnsPrivateKey }` and derives the public key internally.
4. After decryption (line 147): `rootIpnsPublicKey` is no longer extracted from `decrypted.rootIpnsKeypair.publicKey` as a separate variable -- instead, use `decrypted.rootIpnsKeypair.publicKey` directly where needed
5. In the new vault branch (around line 159-161): Remove `rootIpnsPublicKey: bytesToHex(encrypted.rootIpnsPublicKey)` from the `initVault` API call -- the DTO no longer has this field
6. Update `initializeVault()` call to `initializeVault(privateKey)` (line ~156, the new vault branch)
7. In the new vault branch (line 174): `rootIpnsPublicKey` is set from `newVault.rootIpnsKeypair.publicKey` -- remove the separate variable
8. Remove `rootIpnsPublicKeyArr: Array.from(rootIpnsPublicKey)` from the return data (line 185)
9. In the `restoreVaultDataInBrowser` function (around line 253): Remove `publicKey: new Uint8Array(data.rootIpnsPublicKeyArr)` from the reconstructed keypair. Instead, since the public key is needed for the rootIpnsKeypair, derive it from the private key. Import `* as ed` from `@noble/ed25519` and use `const publicKey = await ed.getPublicKeyAsync(new Uint8Array(data.rootIpnsPrivateKeyArr))` to reconstruct the keypair.

**Update vault.controller.spec.ts** in `apps/api/src/vault/vault.controller.spec.ts`:

- Remove `rootIpnsPublicKey: 'd'.repeat(64)` from the mock vault response fixture (line 22)
- Remove `rootIpnsPublicKey: 'd'.repeat(64)` from the mock InitVaultDto fixture (line 63)
- Any assertions checking `rootIpnsPublicKey` in the response should also be removed
  </action>
  <verify>
  Run `cd /Users/michael/Code/cipher-box && pnpm --filter api test -- --testPathPattern vault.controller` -- controller spec passes.
  Grep for `rootIpnsPublicKey` in tests/e2e/utils/web3auth-helpers.ts -- should NOT appear.
  Grep for `rootIpnsPublicKey` in apps/api/src/vault/vault.controller.spec.ts -- should NOT appear.
  </verify>
  <done>
  E2E helpers updated: no rootIpnsPublicKey in VaultData type or API calls, public key derived from private key where needed. Controller spec updated: fixtures no longer include rootIpnsPublicKey. Tests pass.
  </done>
  </task>

</tasks>

<verification>
- `cargo check` passes for desktop app (no root_ipns_public_key references)
- `pnpm --filter api test -- --testPathPattern vault.controller` passes
- Grep for `rootIpnsPublicKey` across entire repo source files (excluding .planning/, .md, git history): should only appear in generated API client files (which get regenerated in Plan 03)
- E2E helpers derive IPNS public key from private key instead of storing separately
</verification>

<success_criteria>

- Zero rootIpnsPublicKey / root_ipns_public_key references in desktop Rust source
- Zero rootIpnsPublicKey references in E2E helpers
- Zero rootIpnsPublicKey references in vault.controller.spec.ts
- Desktop app compiles, controller spec passes
- After Plan 03 regenerates the API client, the entire codebase will have zero rootIpnsPublicKey references in source files
  </success_criteria>

<output>
After completion, create `.planning/phases/12.3.1-pre-wipe-identity-cleanup/12.3.1-04-SUMMARY.md`
</output>
