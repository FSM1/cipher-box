---
phase: 12.3.1-pre-wipe-identity-cleanup
plan: 01
subsystem: crypto
tags: [hkdf, ed25519, ipns, deterministic-derivation, vault]

# Dependency graph
requires:
  - phase: 12.2-encrypted-device-registry
    provides: deriveRegistryIpnsKeypair pattern, HKDF key derivation infrastructure
provides:
  - deriveVaultIpnsKeypair() function for deterministic vault IPNS derivation
  - Updated initializeVault(userPrivateKey) with deterministic IPNS keypair
  - Slimmed EncryptedVaultKeys type (no rootIpnsPublicKey)
  - decryptVaultKeys derives public key from private key
affects: [12.3.1-02, 12.3.1-03, vault-service, auth-store, vault-recovery]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'HKDF domain separation via info parameter for vault vs registry IPNS'
    - 'Ed25519 public key derivation from private key in decryptVaultKeys'

key-files:
  created:
    - packages/crypto/src/vault/derive-ipns.ts
    - packages/crypto/src/__tests__/vault-ipns.test.ts
  modified:
    - packages/crypto/src/vault/init.ts
    - packages/crypto/src/vault/types.ts
    - packages/crypto/src/vault/index.ts
    - packages/crypto/src/index.ts
    - packages/crypto/src/__tests__/vault.test.ts

key-decisions:
  - 'Vault IPNS uses same HKDF salt (CipherBox-v1) but different info (cipherbox-vault-ipns-v1) for domain separation'
  - 'rootIpnsPublicKey removed from EncryptedVaultKeys; derived from private key on decrypt'

patterns-established:
  - 'HKDF domain separation: same salt, different info strings for vault vs registry IPNS derivation'
  - 'Public key derivation from private key rather than redundant storage'

# Metrics
duration: 4min
completed: 2026-02-14
---

# Phase 12.3.1 Plan 01: Deterministic Vault IPNS Derivation Summary

HKDF-derived deterministic vault IPNS keypair replacing random keygen, with EncryptedVaultKeys slimmed to remove redundant rootIpnsPublicKey.

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-14T16:51:25Z
- **Completed:** 2026-02-14T16:55:37Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments

- Created `deriveVaultIpnsKeypair()` mirroring the registry IPNS derivation pattern with domain separation via HKDF info
- Updated `initializeVault()` to require `userPrivateKey` and derive IPNS keypair deterministically (breaking change from random keygen)
- Removed `rootIpnsPublicKey` from `EncryptedVaultKeys` type; `decryptVaultKeys` now derives public key from private key
- Added 8 new tests for vault IPNS derivation including domain separation from registry, and updated 14 existing vault tests

## Task Commits

Each task was committed atomically:

1. **Task 1: Create deriveVaultIpnsKeypair, update initializeVault, encryptVaultKeys, decryptVaultKeys, and EncryptedVaultKeys type** - `3424f8f57` (feat)
2. **Task 2: Unit tests for deterministic vault IPNS derivation and update existing vault.test.ts** - `b37fbff66` (test)

## Files Created/Modified

- `packages/crypto/src/vault/derive-ipns.ts` - New: deterministic vault IPNS keypair derivation via HKDF
- `packages/crypto/src/vault/init.ts` - Updated: initializeVault requires userPrivateKey, encryptVaultKeys omits rootIpnsPublicKey, decryptVaultKeys derives public key
- `packages/crypto/src/vault/types.ts` - Updated: EncryptedVaultKeys no longer has rootIpnsPublicKey field
- `packages/crypto/src/vault/index.ts` - Updated: barrel exports deriveVaultIpnsKeypair
- `packages/crypto/src/index.ts` - Updated: root barrel exports deriveVaultIpnsKeypair
- `packages/crypto/src/__tests__/vault-ipns.test.ts` - New: 8 tests for derivation determinism, domain separation, error handling
- `packages/crypto/src/__tests__/vault.test.ts` - Updated: all initializeVault calls pass privateKey, removed rootIpnsPublicKey assertions

## Decisions Made

- Vault IPNS uses same HKDF salt (`CipherBox-v1`) but different info (`cipherbox-vault-ipns-v1`) for domain separation from registry IPNS -- this is cryptographically sufficient since HKDF info is the primary domain separator
- Removed `rootIpnsPublicKey` from `EncryptedVaultKeys` since it is derivable from the private key; this reduces stored data and eliminates potential inconsistency

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- Pre-commit hook detected unstaged API files from prior branch work and blocked commits. Resolved by unstaging the non-task API files with `git restore --staged`.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- `deriveVaultIpnsKeypair` is ready for use by vault service and auth store (Plan 02/03 consumers)
- `initializeVault(userPrivateKey)` is a breaking change -- all callers must be updated (Plan 02 will handle backend callers, Plan 03 handles frontend)
- `EncryptedVaultKeys` type change will require backend DTO/entity updates (Plan 02)
- All 169 crypto tests pass including the 8 new vault IPNS tests

---

_Phase: 12.3.1-pre-wipe-identity-cleanup_
_Completed: 2026-02-14_
