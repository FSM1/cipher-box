---
phase: 12.3.1-pre-wipe-identity-cleanup
plan: 03
subsystem: api, auth, ui
tags: [vault, ipns, hkdf, deterministic-derivation, typeorm, dto, zero-knowledge]

requires:
  - phase: 12.3.1-01
    provides: 'deriveVaultIpnsKeypair(privateKey) and updated initializeVault/encryptVaultKeys/decryptVaultKeys'
  - phase: 12.3.1-02
    provides: 'SHA-256 hashed identifiers, identifier_hash/identifier_display columns'
provides:
  - 'rootIpnsPublicKey fully removed from vault entity, DTOs, API response, and frontend'
  - 'Frontend vault init uses deterministic IPNS derivation via initializeVault(privateKey)'
  - 'Self-sovereign recovery path complete: privateKey -> HKDF -> IPNS name -> resolve -> decrypt'
  - 'TEE republishing unaffected (confirmed by grep)'
affects:
  - '12.3.1-04 (downstream cleanup of desktop and e2e helpers)'
  - '12.4 (MFA + cross-device -- vault schema is now clean)'

tech-stack:
  added: []
  patterns:
    - 'Derivable fields not stored in DB (rootIpnsPublicKey removed, derived from privateKey via HKDF)'
    - 'decryptVaultKeys derives IPNS public key internally from decrypted private key'

key-files:
  created: []
  modified:
    - 'apps/api/src/vault/entities/vault.entity.ts'
    - 'apps/api/src/vault/dto/init-vault.dto.ts'
    - 'apps/api/src/vault/vault.service.ts'
    - 'apps/api/src/vault/vault.service.spec.ts'
    - 'apps/api/src/migrations/1700000000000-FullSchema.ts'
    - 'apps/web/src/hooks/useAuth.ts'
    - 'apps/web/src/lib/api/vault.ts'
    - 'apps/web/src/api/models/initVaultDto.ts'
    - 'apps/web/src/api/models/vaultResponseDto.ts'
    - 'packages/api-client/openapi.json'
    - 'apps/api/src/vault/vault.controller.spec.ts'
    - 'apps/desktop/src-tauri/src/api/types.rs'
    - 'apps/desktop/src-tauri/src/commands.rs'
    - 'apps/desktop/src-tauri/src/state.rs'
    - 'tests/e2e/utils/web3auth-helpers.ts'

key-decisions:
  - 'rootIpnsPublicKey fully removed from stored data (derivable from privateKey via HKDF)'
  - 'Self-sovereign recovery: privateKey -> deriveVaultIpnsKeypair -> IPNS name -> resolve IPNS -> decrypt'

patterns-established:
  - 'Derivable-not-stored: fields computable from privateKey are not persisted in DB'
  - 'decryptVaultKeys handles IPNS public key derivation internally'

duration: 18min
completed: 2026-02-14
---

# Phase 12.3.1 Plan 03: Vault IPNS Wiring Summary

Removed rootIpnsPublicKey from vault entity/DTOs/API and wired frontend vault init to deterministic IPNS derivation via HKDF.

## Performance

- **Duration:** 18 min
- **Started:** 2026-02-14T17:05:50Z
- **Completed:** 2026-02-14T17:24:18Z
- **Tasks:** 2
- **Files modified:** 15

## Accomplishments

- Removed `rootIpnsPublicKey` from Vault entity, InitVaultDto, VaultResponseDto, and FullSchema migration
- Updated frontend `initializeOrLoadVault` to pass `privateKey` to `initializeVault()` for deterministic IPNS derivation
- Updated `decryptVaultKeys` call to use only `{ encryptedRootFolderKey, encryptedIpnsPrivateKey }` (public key derived internally)
- Removed `rootIpnsPublicKey` from all downstream consumers: desktop Rust app, vault controller spec, E2E helpers
- Regenerated API client (openapi.json, orval models) to reflect updated DTOs
- Verified TEE republishing unaffected (grep confirms zero rootIpnsPublicKey references in ipns.service.ts)
- All 460 API tests pass, API build compiles, web build compiles

## Task Commits

Each task was committed atomically:

1. **Task 1: Update backend vault schema, service, and DTOs** - `07caf1be8` (feat) + `4980b977e` (fix -- API source files lost during lint-staged stash cycle)
2. **Task 2: Update frontend vault init, API client, and verify TEE compatibility** - `da2bc83ab` (feat)

## Files Created/Modified

- `apps/api/src/vault/entities/vault.entity.ts` - Removed rootIpnsPublicKey column
- `apps/api/src/vault/dto/init-vault.dto.ts` - Removed rootIpnsPublicKey from InitVaultDto and VaultResponseDto
- `apps/api/src/vault/vault.service.ts` - Removed rootIpnsPublicKey from create/response mappings
- `apps/api/src/vault/vault.service.spec.ts` - Updated test fixtures and assertions
- `apps/api/src/migrations/1700000000000-FullSchema.ts` - Removed root_ipns_public_key from vaults CREATE TABLE
- `apps/web/src/hooks/useAuth.ts` - initializeVault(privateKey), removed rootIpnsPublicKey from decrypt/init calls
- `apps/web/src/lib/api/vault.ts` - Removed rootIpnsPublicKey from VaultResponse and InitVaultDto types
- `apps/web/src/api/models/initVaultDto.ts` - Regenerated (rootIpnsPublicKey removed)
- `apps/web/src/api/models/vaultResponseDto.ts` - Regenerated (rootIpnsPublicKey removed)
- `packages/api-client/openapi.json` - Regenerated OpenAPI spec
- `apps/api/src/vault/vault.controller.spec.ts` - Removed rootIpnsPublicKey from test fixtures
- `apps/desktop/src-tauri/src/api/types.rs` - Removed rootIpnsPublicKey from Rust types
- `apps/desktop/src-tauri/src/commands.rs` - Removed rootIpnsPublicKey decode/store
- `apps/desktop/src-tauri/src/state.rs` - Removed rootIpnsPublicKey state field
- `tests/e2e/utils/web3auth-helpers.ts` - Updated for deterministic initializeVault and no rootIpnsPublicKey

## Decisions Made

- **rootIpnsPublicKey fully removed from stored data**: The Ed25519 public key is derivable from the IPNS private key after decryption, so storing it is redundant. This reduces the vault schema and eliminates a potential inconsistency source.
- **Self-sovereign recovery path**: privateKey -> deriveVaultIpnsKeypair (HKDF) -> IPNS name -> resolve IPNS -> decrypt. The rootIpnsName is still stored for convenience but is also derivable.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] lint-staged stash cycle lost API source file edits from Task 1 commit**

- **Found during:** Task 2 verification
- **Issue:** lint-staged backup/restore cycle during Task 1 commit caused API source files (entity, DTO, service, spec, migration) to be reverted to pre-edit state. The commit only included generated files and desktop changes.
- **Fix:** Re-applied all API edits and committed as a separate fix commit (4980b977e)
- **Files modified:** vault.entity.ts, init-vault.dto.ts, vault.service.ts, vault.service.spec.ts, FullSchema migration, openapi.json
- **Verification:** All 460 tests pass, grep confirms zero rootIpnsPublicKey in vault directory
- **Committed in:** 4980b977e

**2. [Rule 2 - Missing Critical] Desktop Rust and E2E helper updates included**

- **Found during:** Task 1 (desktop files already had changes) and Task 2 (e2e helpers needed updating)
- **Issue:** Plan only specified web and API files, but desktop Rust types/commands/state and E2E test helpers also reference rootIpnsPublicKey
- **Fix:** Included desktop changes in Task 1 commit and E2E/controller spec changes in Task 2 commit
- **Files modified:** types.rs, commands.rs, state.rs, web3auth-helpers.ts, vault.controller.spec.ts
- **Verification:** grep confirms zero rootIpnsPublicKey across all modified codebases

---

**Total deviations:** 2 auto-fixed (1 bug from lint-staged, 1 missing downstream cleanup)
**Impact on plan:** Both fixes necessary for correctness. The lint-staged issue was an infrastructure problem, not a code issue. Desktop/E2E cleanup was essential to prevent build failures.

## Issues Encountered

- **1Password SSH agent unavailable**: The commit signing agent became unavailable mid-execution, causing repeated commit failures. Earlier commits in the session succeeded when the agent was briefly available. Resolved by temporarily disabling signing for the fix commit (per project memory: "Unsigned commits from GSD agents are acceptable since PRs are squash-merged by GitHub with its own signature").
- **lint-staged stash interference**: When staged and unstaged changes coexist, lint-staged's backup stash cycle can lose staged changes that were edited before staging. Workaround: always `git checkout HEAD -- <files>` to clean working tree before staging fresh changes.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Vault schema is clean: no redundant rootIpnsPublicKey stored
- Frontend vault init uses deterministic IPNS derivation
- Self-sovereign recovery path is complete at the data layer
- TEE republishing confirmed unaffected
- Ready for Phase 12.3.1 Plan 04 (downstream cleanup) or Phase 12.4 (MFA + Cross-Device)

---

_Phase: 12.3.1-pre-wipe-identity-cleanup_
_Completed: 2026-02-14_
