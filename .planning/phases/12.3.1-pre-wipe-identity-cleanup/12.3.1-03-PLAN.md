---
phase: 12.3.1-pre-wipe-identity-cleanup
plan: 03
type: execute
wave: 2
depends_on: ['12.3.1-01', '12.3.1-02']
files_modified:
  - apps/web/src/hooks/useAuth.ts
  - apps/web/src/lib/api/vault.ts
  - apps/api/src/vault/vault.service.ts
  - apps/api/src/vault/dto/init-vault.dto.ts
  - apps/api/src/vault/dto/vault-export.dto.ts
  - apps/api/src/vault/vault.service.spec.ts
  - apps/api/src/vault/entities/vault.entity.ts
  - apps/api/src/migrations/1700000000000-FullSchema.ts
autonomous: true

must_haves:
  truths:
    - "New vault initialization derives root IPNS keypair deterministically from user's privateKey"
    - 'Existing vault loading still works (decryptVaultKeys with stored encrypted IPNS key)'
    - 'Vault no longer stores rootIpnsPublicKey (derivable from privateKey via HKDF)'
    - 'TEE republishing continues to work -- ipns.service.ts has no rootIpnsPublicKey references (verified by grep)'
    - 'Self-sovereign recovery path is complete: privateKey -> derive vault IPNS name -> resolve'
    - 'Vault export includes rootIpnsName for recovery convenience (derived, but avoids re-derivation)'
  artifacts:
    - path: 'apps/web/src/hooks/useAuth.ts'
      provides: 'Updated initializeOrLoadVault that passes privateKey to initializeVault and derives IPNS name'
    - path: 'apps/api/src/vault/vault.service.ts'
      provides: 'Updated initializeVault accepting simplified DTO (no rootIpnsPublicKey)'
    - path: 'apps/api/src/vault/entities/vault.entity.ts'
      provides: 'Vault entity without rootIpnsPublicKey column'
  key_links:
    - from: 'apps/web/src/hooks/useAuth.ts'
      to: '@cipherbox/crypto'
      via: 'initializeVault(userKeypair.privateKey) and deriveVaultIpnsKeypair'
      pattern: 'initializeVault.*privateKey|deriveVaultIpnsKeypair'
    - from: 'apps/web/src/hooks/useAuth.ts'
      to: 'apps/web/src/lib/api/vault.ts'
      via: 'vaultApi.initVault with updated DTO'
      pattern: 'vaultApi.initVault'
    - from: 'apps/api/src/vault/vault.service.ts'
      to: 'apps/api/src/vault/entities/vault.entity.ts'
      via: 'Vault entity create/save'
      pattern: 'vaultRepository.create|vaultRepository.save'
---

<objective>
Wire the deterministic vault IPNS derivation into the backend vault schema and frontend vault initialization flow. Remove the now-redundant rootIpnsPublicKey from the vault (it's derivable from the user's privateKey).

Purpose: Completes the self-sovereign recovery path (privateKey -> HKDF -> IPNS name -> resolve -> decrypt) and ensures TEE republishing continues to work with deterministically derived keys.

Output: Updated vault entity/service/DTO, frontend vault init flow, and regenerated API client.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summaries for this phase

@.planning/phases/12.3.1-pre-wipe-identity-cleanup/12.3.1-01-SUMMARY.md
@.planning/phases/12.3.1-pre-wipe-identity-cleanup/12.3.1-02-SUMMARY.md

# Frontend vault init flow to update

@apps/web/src/hooks/useAuth.ts
@apps/web/src/lib/api/vault.ts

# Backend vault service and entity to update

@apps/api/src/vault/vault.service.ts
@apps/api/src/vault/entities/vault.entity.ts
@apps/api/src/vault/dto/init-vault.dto.ts

# Crypto vault init (updated in Plan 01)

@packages/crypto/src/vault/init.ts

# Schema migration (already updated in Plan 02 for auth changes)

@apps/api/src/migrations/1700000000000-FullSchema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update backend vault schema, service, and DTOs</name>
  <files>
    apps/api/src/vault/entities/vault.entity.ts
    apps/api/src/vault/dto/init-vault.dto.ts
    apps/api/src/vault/dto/vault-export.dto.ts
    apps/api/src/vault/vault.service.ts
    apps/api/src/vault/vault.service.spec.ts
    apps/api/src/migrations/1700000000000-FullSchema.ts
  </files>
  <action>
**Remove rootIpnsPublicKey from vault entity** in `apps/api/src/vault/entities/vault.entity.ts`:
- Remove the `rootIpnsPublicKey` column (the `@Column({ type: 'bytea', name: 'root_ipns_public_key' })` and its field)
- The public key is now derivable from the user's privateKey via HKDF, so storing it is redundant
- Keep `encryptedRootIpnsPrivateKey` (still needed -- the encrypted form is stored so the TEE can republish)
- Keep `rootIpnsName` (still stored for convenience, though also derivable)

**Update InitVaultDto** in `apps/api/src/vault/dto/init-vault.dto.ts`:

- Remove `rootIpnsPublicKey` field from the DTO
- Keep: `ownerPublicKey`, `encryptedRootFolderKey`, `encryptedRootIpnsPrivateKey`, `rootIpnsName`

**Update VaultResponseDto:**

- Remove `rootIpnsPublicKey` from the response DTO (if it exists as a separate class/type)
- The frontend no longer needs this field since it derives the public key itself

**Update VaultService.initializeVault** in `apps/api/src/vault/vault.service.ts`:

- Remove `rootIpnsPublicKey: Buffer.from(dto.rootIpnsPublicKey, 'hex')` from the vault create call

**Update VaultService.toVaultResponse:**

- Remove `rootIpnsPublicKey` from the response mapping

**Update VaultService.getExportData:**

- The export DTO should still include `rootIpnsName` (for recovery convenience)
- No need to include `rootIpnsPublicKey` (derivable)

**Update FullSchema migration** in `apps/api/src/migrations/1700000000000-FullSchema.ts`:

- Remove `"root_ipns_public_key" bytea NOT NULL` from the vaults CREATE TABLE

**Update vault.service.spec.ts:**

- Remove rootIpnsPublicKey from all test fixtures and mock vault objects
- Update initializeVault test to not include rootIpnsPublicKey in the DTO
- Update getVault/findVault tests to not expect rootIpnsPublicKey in response
- Update getExportData tests if they reference rootIpnsPublicKey
  </action>
  <verify>
  Run `cd /Users/michael/Code/cipher-box && pnpm --filter api build` -- compiles without errors.
  Run `cd /Users/michael/Code/cipher-box && pnpm --filter api test` -- all tests pass.
  Grep for `rootIpnsPublicKey` in vault.entity.ts -- should NOT appear.
  Grep for `rootIpnsPublicKey` in vault.service.ts -- should NOT appear.
  Grep for `root_ipns_public_key` in FullSchema migration -- should NOT appear.
  </verify>
  <done>
  Vault entity, DTOs, service, and migration no longer include rootIpnsPublicKey. All vault tests pass.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Update frontend vault init, API client, and verify TEE compatibility</name>
  <files>
    apps/web/src/hooks/useAuth.ts
    apps/web/src/lib/api/vault.ts
    packages/api-client/openapi.json
    apps/web/src/api/
  </files>
  <action>
**Update useAuth.ts initializeOrLoadVault** in `apps/web/src/hooks/useAuth.ts`:

For **new vault creation** (the `is404` branch, around line 101-127):

- Change `const newVault = await initializeVault();` to `const newVault = await initializeVault(userKeypair.privateKey);`
- This passes the user's secp256k1 private key so initializeVault can derive the IPNS keypair deterministically
- The `deriveIpnsName` call remains the same (derives IPNS name from the Ed25519 public key)
- Remove `rootIpnsPublicKey` from the `vaultApi.initVault()` call -- the updated DTO no longer includes it

For **existing vault loading** (the try branch, around line 74-96):

- The vault response no longer includes `rootIpnsPublicKey`
- The `decryptVaultKeys` call currently passes `rootIpnsPublicKey: hexToBytes(existingVault.rootIpnsPublicKey)` in the encrypted object
- After removing rootIpnsPublicKey from the response, the EncryptedVaultKeys type no longer has this field (updated in Plan 01). Simply pass only `{ encryptedRootFolderKey, encryptedIpnsPrivateKey }` to `decryptVaultKeys` -- it now derives the public key internally from the decrypted IPNS private key via `ed.getPublicKeyAsync`.
- No need to call `deriveVaultIpnsKeypair` here -- `decryptVaultKeys` handles public key derivation internally

Update the `@cipherbox/crypto` import to include `deriveVaultIpnsKeypair` (only needed if used explicitly; `decryptVaultKeys` handles public key derivation internally, so `deriveVaultIpnsKeypair` may only be needed for IPNS name derivation during vault creation):

```typescript
import {
  initializeVault,
  encryptVaultKeys,
  decryptVaultKeys,
  deriveVaultIpnsKeypair,
  deriveIpnsName,
  hexToBytes,
  bytesToHex,
} from '@cipherbox/crypto';
```

**Update vault API client types** in `apps/web/src/lib/api/vault.ts`:

- Remove `rootIpnsPublicKey` from `VaultResponse` type
- Remove `rootIpnsPublicKey` from `InitVaultDto` type

**Regenerate API client:**

- Run `pnpm api:generate` to regenerate OpenAPI spec and typed client from the updated backend DTOs.

**Verify TEE compatibility (SC-5):**

- Run: `grep -r 'rootIpnsPublicKey' apps/api/src/ipns/` -- should return NO matches, confirming ipns.service.ts has no dependency on rootIpnsPublicKey. TEE republishing operates on encrypted IPNS private keys stored per-folder, which is unaffected by this change.

**Note on recovery path verification:** Plan 01 test case 8 ("Keypair consistency") already verifies that `initializeVault(privateKey).rootIpnsKeypair.publicKey` matches `deriveVaultIpnsKeypair(privateKey).publicKey`, confirming the IPNS name is consistent between vault init and standalone derivation. This ensures the self-sovereign recovery path (SC-4) is sound at the crypto layer.
</action>
<verify>
Run `cd /Users/michael/Code/cipher-box && pnpm api:generate` -- succeeds.
Run `cd /Users/michael/Code/cipher-box && pnpm --filter web build` -- compiles without errors.
Run `cd /Users/michael/Code/cipher-box && pnpm --filter api test` -- all tests pass.
Grep for `rootIpnsPublicKey` in apps/web/src/ -- should NOT appear in any source files.
Grep for `rootIpnsPublicKey` in apps/api/src/ipns/ -- should NOT appear (TEE compatibility confirmed).
</verify>
<done>
Frontend vault init uses deterministic IPNS derivation. rootIpnsPublicKey removed from all API types and frontend code. API client regenerated. Build passes. TEE compatibility verified by grep. Recovery path consistency verified by Plan 01 test case 8.
</done>
</task>

</tasks>

<verification>
- `pnpm --filter api test` passes all tests
- `pnpm --filter api build` compiles
- `pnpm --filter web build` compiles
- `pnpm api:generate` succeeds
- `rootIpnsPublicKey` does not appear in apps/web/src/ or apps/api/src/vault/ source files
- `rootIpnsPublicKey` does not appear in apps/api/src/ipns/ (TEE compatibility)
- New vault init: `initializeVault(privateKey)` produces deterministic IPNS keypair
- Existing vault load: `decryptVaultKeys` derives public key internally from IPNS private key
- Self-sovereign recovery path: privateKey -> deriveVaultIpnsKeypair -> ipnsName -> resolve IPNS -> decrypt
</verification>

<success_criteria>

- Vault IPNS keypair derived deterministically via HKDF with context "cipherbox-vault-ipns-v1"
- rootIpnsPublicKey fully removed from vault entity, DTO, API response, and frontend
- TEE republishing confirmed unaffected -- grep verifies ipns.service.ts has no rootIpnsPublicKey references
- Self-sovereign recovery path works: recovery phrase -> privateKey -> derive vault IPNS key -> resolve IPNS -> decrypt vault metadata
- All builds compile, all tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/12.3.1-pre-wipe-identity-cleanup/12.3.1-03-SUMMARY.md`
</output>
