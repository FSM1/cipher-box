---
phase: 12.3.1-pre-wipe-identity-cleanup
verified: 2026-02-14T17:29:09Z
status: passed
score: 5/5 must-haves verified
must_haves:
  truths:
    - 'Vault IPNS keypair is derived deterministically from privateKey via HKDF (context: cipherbox-vault-ipns-v1)'
    - 'All auth method identifiers are stored as SHA-256 hashes'
    - 'Each auth method is independent -- no cross-method email auto-linking'
    - 'Self-sovereign recovery path works: privateKey -> derive vault IPNS key -> resolve IPNS -> decrypt vault'
    - 'TEE republishing continues to work -- ipns.service.ts has no rootIpnsPublicKey dependency'
  artifacts:
    - path: 'packages/crypto/src/vault/derive-ipns.ts'
      provides: 'deriveVaultIpnsKeypair() with HKDF domain separation'
    - path: 'packages/crypto/src/vault/init.ts'
      provides: 'initializeVault(userPrivateKey) with deterministic IPNS, decryptVaultKeys derives pubkey'
    - path: 'packages/crypto/src/vault/types.ts'
      provides: 'EncryptedVaultKeys without rootIpnsPublicKey'
    - path: 'apps/api/src/auth/services/siwe.service.ts'
      provides: 'hashIdentifier() and hashWalletAddress() for SHA-256 hashing'
    - path: 'apps/api/src/auth/controllers/identity.controller.ts'
      provides: 'findOrCreateUserByIdentifier with hash-based lookup, no cross-method linking'
    - path: 'apps/api/src/vault/entities/vault.entity.ts'
      provides: 'Vault entity without rootIpnsPublicKey column'
    - path: 'apps/web/src/hooks/useAuth.ts'
      provides: 'Frontend vault init with deterministic IPNS derivation'
  key_links:
    - from: 'useAuth.ts'
      to: '@cipherbox/crypto'
      via: 'initializeVault(userKeypair.privateKey) and decryptVaultKeys'
    - from: 'identity.controller.ts'
      to: 'siwe.service.ts'
      via: 'hashIdentifier() for Google sub and email'
    - from: 'vault.entity.ts'
      to: 'vault.service.ts'
      via: 'No rootIpnsPublicKey in create/response'
---

# Phase 12.3.1: Pre-Wipe Identity Cleanup Verification Report

**Phase Goal:** Implement schema-level identity changes as clean breaks before database wipe: deterministic vault IPNS derivation, SHA-256 hashed identifiers for all auth methods, and removal of cross-method email auto-linking
**Verified:** 2026-02-14T17:29:09Z
**Status:** passed
**Re-verification:** No -- initial verification

## Goal Achievement

### Observable Truths

| #   | Truth                                                                                                      | Status   | Evidence                                                                                                                                                                                                                                                                                                                                                                                        |
| --- | ---------------------------------------------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Vault IPNS keypair derived deterministically from privateKey via HKDF (context: "cipherbox-vault-ipns-v1") | VERIFIED | `derive-ipns.ts:29` uses HKDF info "cipherbox-vault-ipns-v1"; `init.ts:44` calls `deriveVaultIpnsKeypair(userPrivateKey)` instead of random keygen; domain separation from registry confirmed via different HKDF info strings                                                                                                                                                                   |
| 2   | All auth method identifiers stored as SHA-256 hashes                                                       | VERIFIED | Google: `identity.controller.ts:97` hashes `googlePayload.sub`; Email: `identity.controller.ts:157` hashes `normalizedEmail`; Wallet: `identity.controller.ts:239` hashes via `hashWalletAddress`; All paths store `identifier=hash, identifierHash=hash, identifierDisplay=readable`                                                                                                           |
| 3   | Each auth method is independent -- no cross-method email auto-linking                                      | VERIFIED | `identity.controller.ts:260-299` uses `findOrCreateUserByIdentifier` which only searches by `(type, identifierHash)` -- no cross-method email matching. Explicit test at `identity.controller.spec.ts:252` confirms SEPARATE user created when email matches existing Google user. The only cross-account check is collision prevention in `auth.service.ts:294` during explicit method linking |
| 4   | Self-sovereign recovery path works: privateKey -> derive vault IPNS key -> resolve IPNS -> decrypt vault   | VERIFIED | `derive-ipns.ts:41-69` derives IPNS keypair from privateKey; `init.ts:108-131` decryptVaultKeys derives IPNS public key from decrypted private key at line 119; `useAuth.ts:105` calls `initializeVault(userKeypair.privateKey)` for new users; recovery path: privateKey -> HKDF -> IPNS name -> resolve IPNS -> decrypt encryptedIpnsPrivateKey + encryptedRootFolderKey                      |
| 5   | TEE republishing continues to work -- ipns.service.ts has no rootIpnsPublicKey dependency                  | VERIFIED | grep for `rootIpnsPublicKey` in `apps/api/src/ipns/` returns zero matches; ipns.service.ts is completely independent of rootIpnsPublicKey                                                                                                                                                                                                                                                       |

**Score:** 5/5 truths verified

### Required Artifacts

| Artifact                                               | Expected                                     | Status                                   | Details                                                                                                                                                    |
| ------------------------------------------------------ | -------------------------------------------- | ---------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `packages/crypto/src/vault/derive-ipns.ts`             | HKDF vault IPNS derivation                   | VERIFIED (70 lines, exported, imported)  | Substantive implementation with HKDF-SHA256, Ed25519 derivation, IPNS name generation, error handling                                                      |
| `packages/crypto/src/vault/init.ts`                    | initializeVault(userPrivateKey)              | VERIFIED (131 lines, exported, imported) | initializeVault takes privateKey, encryptVaultKeys omits rootIpnsPublicKey, decryptVaultKeys derives pubkey at line 119                                    |
| `packages/crypto/src/vault/types.ts`                   | EncryptedVaultKeys without rootIpnsPublicKey | VERIFIED (37 lines)                      | Only `encryptedRootFolderKey` and `encryptedIpnsPrivateKey` fields                                                                                         |
| `packages/crypto/src/__tests__/vault-ipns.test.ts`     | Tests for deterministic derivation           | VERIFIED (110 lines, 8 tests)            | Covers determinism, uniqueness, domain separation from registry, error handling, IPNS name format                                                          |
| `apps/api/src/auth/services/siwe.service.ts`           | hashIdentifier() method                      | VERIFIED (92 lines)                      | `hashIdentifier(value)` at line 79 and `hashWalletAddress(address)` at line 67, both SHA-256                                                               |
| `apps/api/src/auth/controllers/identity.controller.ts` | Hash-based identity, no auto-linking         | VERIFIED (347 lines)                     | `findOrCreateUserByIdentifier` at line 260 searches by `(type, identifierHash)` only; comment at line 253 explicitly states no cross-method email matching |
| `apps/api/src/auth/auth.service.ts`                    | Hash-based lookups in login/link/test-login  | VERIFIED (547 lines)                     | `createHash('sha256')` used at lines 84, 291, 475; `identifierDisplay` used for output at lines 227, 245                                                   |
| `apps/api/src/vault/entities/vault.entity.ts`          | No rootIpnsPublicKey column                  | VERIFIED (66 lines)                      | Columns: ownerId, ownerPublicKey, encryptedRootFolderKey, encryptedRootIpnsPrivateKey, rootIpnsName -- no rootIpnsPublicKey                                |
| `apps/api/src/vault/dto/init-vault.dto.ts`             | DTOs without rootIpnsPublicKey               | VERIFIED (104 lines)                     | InitVaultDto and VaultResponseDto have no rootIpnsPublicKey field                                                                                          |
| `apps/api/src/vault/vault.service.ts`                  | Service without rootIpnsPublicKey            | VERIFIED (220 lines)                     | `toVaultResponse` at line 208 maps without rootIpnsPublicKey; `initializeVault` at line 39 creates without it                                              |
| `apps/web/src/hooks/useAuth.ts`                        | Frontend with deterministic IPNS             | VERIFIED (401 lines)                     | `initializeVault(userKeypair.privateKey)` at line 105; `decryptVaultKeys` at line 83 uses only `encryptedRootFolderKey` + `encryptedIpnsPrivateKey`        |
| `apps/api/src/auth/entities/auth-method.entity.ts`     | identifierHash + identifierDisplay columns   | VERIFIED (44 lines)                      | `identifierHash` at line 28 (varchar 64), `identifierDisplay` at line 32 (varchar 255)                                                                     |
| `apps/desktop/src-tauri/src/api/types.rs`              | Rust types without root_ipns_public_key      | VERIFIED (68 lines)                      | InitVaultRequest and VaultResponse have no root_ipns_public_key field                                                                                      |
| `apps/desktop/src-tauri/src/state.rs`                  | AppState without root_ipns_public_key        | VERIFIED (121 lines)                     | No root_ipns_public_key field; clear_keys() does not reference it                                                                                          |
| `tests/e2e/utils/web3auth-helpers.ts`                  | E2E helpers derive pubkey from privkey       | VERIFIED (311 lines)                     | Line 175: `ed.getPublicKeyAsync(rootIpnsPrivateKey)` derives pubkey locally; does NOT fetch from API response                                              |

### Key Link Verification

| From                     | To                     | Via                                                | Status | Details                                                                                                |
| ------------------------ | ---------------------- | -------------------------------------------------- | ------ | ------------------------------------------------------------------------------------------------------ |
| `useAuth.ts`             | `@cipherbox/crypto`    | `initializeVault(userKeypair.privateKey)`          | WIRED  | Line 105: `initializeVault(userKeypair.privateKey)` -- private key passed for HKDF derivation          |
| `useAuth.ts`             | `@cipherbox/crypto`    | `decryptVaultKeys({...}, userKeypair.privateKey)`  | WIRED  | Lines 83-89: decrypts with only encryptedRootFolderKey + encryptedIpnsPrivateKey                       |
| `identity.controller.ts` | `siwe.service.ts`      | `hashIdentifier()` for Google and email            | WIRED  | Google: line 97 `hashIdentifier(googlePayload.sub)`; Email: line 157 `hashIdentifier(normalizedEmail)` |
| `identity.controller.ts` | `authMethodRepository` | `findOne({ type, identifierHash })`                | WIRED  | Lines 266-271: lookup by type + identifierHash only, no cross-method search                            |
| `vault.service.ts`       | `vault.entity.ts`      | `vaultRepository.create` without rootIpnsPublicKey | WIRED  | Lines 50-57: creates vault with only encryptedRootFolderKey, encryptedRootIpnsPrivateKey, rootIpnsName |
| `vault.entity.ts`        | `migration`            | Vault schema in FullSchema migration               | WIRED  | grep confirms zero rootIpnsPublicKey/root_ipns_public_key in migration file                            |

### Requirements Coverage

| Requirement                            | Status    | Notes                                                                   |
| -------------------------------------- | --------- | ----------------------------------------------------------------------- |
| Self-sovereign recovery infrastructure | SATISFIED | privateKey -> HKDF -> IPNS name -> resolve -> decrypt path is complete  |
| Privacy-preserving auth storage        | SATISFIED | All identifiers stored as SHA-256 hashes; identifierDisplay for UI only |

### Anti-Patterns Found

| File                     | Line | Pattern                                                                                 | Severity | Impact                                                                                                                                                                                                                                                                                                                          |
| ------------------------ | ---- | --------------------------------------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `identity.controller.ts` | 305  | Stale comment: "Same placeholder publicKey pattern as findOrCreateUserByEmail"          | Info     | Comment references old function name; the actual function is `findOrCreateUserByIdentifier`. No functional impact.                                                                                                                                                                                                              |
| `commands.rs`            | 392  | Desktop `initialize_vault` uses `generate_ed25519_keypair()` (random, not HKDF-derived) | Info     | Desktop vault init does NOT use deterministic IPNS derivation. This is NOT a blocker for Phase 12.3.1 scope -- the desktop client was only tasked with removing rootIpnsPublicKey references (Plan 04), not implementing HKDF derivation in Rust. Desktop HKDF derivation would be a Phase 11 (Cross-Platform Desktop) concern. |
| `web3auth-helpers.ts`    | 38   | Variable named `rootIpnsPublicKeyArr` in cached state                                   | Info     | The variable name contains "rootIpnsPublicKey" but the value is correctly derived from the private key (line 175: `ed.getPublicKeyAsync(rootIpnsPrivateKey)`), not fetched from the API. The naming is a holdover but the behavior is correct.                                                                                  |

### Human Verification Required

### 1. Full Login Flow with Vault Initialization

**Test:** Login via Google/email/wallet and verify vault is created with deterministic IPNS name
**Expected:** Same user with same privateKey always gets the same rootIpnsName
**Why human:** Requires Web3Auth Core Kit infrastructure to test end-to-end

### 2. Identity Independence Across Auth Methods

**Test:** Create account via Google, then separately create account via email with same email address
**Expected:** Two separate users created, not auto-linked
**Why human:** Requires multi-method login through the actual UI

### Gaps Summary

No gaps found. All five success criteria are verified at the code level:

1. **Deterministic IPNS derivation** is fully implemented in `@cipherbox/crypto` and wired into both frontend (`useAuth.ts`) and backend (`vault.service.ts`). HKDF with info "cipherbox-vault-ipns-v1" provides domain separation from registry IPNS.

2. **SHA-256 hashed identifiers** are used for all three auth method types. Google hashes the immutable `sub` (not email), email hashes normalized email, wallet hashes checksummed address. A composite `(type, identifier_hash)` index exists in the migration for efficient lookups.

3. **Independent auth methods** -- the old cross-method email auto-linking has been completely removed. The `findOrCreateUserByIdentifier` function only searches within the same auth method type. An explicit test verifies separate users are created even when the same email is used across Google and email auth methods.

4. **Self-sovereign recovery path** is structurally complete: privateKey -> HKDF (deriveVaultIpnsKeypair) -> IPNS name -> resolve IPNS -> decrypt vault. The rootIpnsPublicKey has been removed from the vault entity, DTOs, API client, desktop Rust types, and E2E helpers. It is now derived from the private key after decryption.

5. **TEE republishing compatibility** is confirmed by grep -- zero references to rootIpnsPublicKey exist in the ipns service directory.

**Note on desktop Rust:** The desktop client's `initialize_vault` still uses random Ed25519 keypair generation (not HKDF-derived). This was out of scope for Phase 12.3.1 (which only required removing rootIpnsPublicKey references from the desktop). Deterministic IPNS derivation in Rust would be a future desktop client concern.

---

_Verified: 2026-02-14T17:29:09Z_
_Verifier: Claude (gsd-verifier)_
