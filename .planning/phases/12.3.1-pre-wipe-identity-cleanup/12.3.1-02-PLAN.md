---
phase: 12.3.1-pre-wipe-identity-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/auth/controllers/identity.controller.ts
  - apps/api/src/auth/controllers/identity.controller.spec.ts
  - apps/api/src/auth/auth.service.ts
  - apps/api/src/auth/auth.service.spec.ts
  - apps/api/src/auth/services/siwe.service.ts
  - apps/api/src/auth/services/siwe.service.spec.ts
  - apps/api/src/auth/entities/auth-method.entity.ts
  - apps/api/src/auth/dto/identity.dto.ts
  - apps/api/src/migrations/1700000000000-FullSchema.ts
autonomous: true

must_haves:
  truths:
    - 'Google login stores SHA-256(google_sub) as identifier_hash and email as identifier_display'
    - 'Email login stores SHA-256(normalized_email) as identifier_hash and email as identifier_display'
    - 'Wallet login stores SHA-256(checksummed_address) as identifier_hash and truncated address as identifier_display (unchanged)'
    - 'Google login with same email as existing email method creates a NEW separate user -- no auto-linking'
    - 'Each auth method type is independent -- no cross-method email lookup'
    - 'getLinkedMethods returns identifier_display for all method types (not hashes)'
  artifacts:
    - path: 'apps/api/src/auth/controllers/identity.controller.ts'
      provides: 'Updated findOrCreateUserByIdentifier with hashed identifiers, no cross-method linking'
    - path: 'apps/api/src/auth/services/siwe.service.ts'
      provides: 'Generic hashIdentifier method alongside existing hashWalletAddress'
      exports: ['SiweService']
    - path: 'apps/api/src/migrations/1700000000000-FullSchema.ts'
      provides: 'identifier_hash and identifier_display columns used by all auth types'
  key_links:
    - from: 'apps/api/src/auth/controllers/identity.controller.ts'
      to: 'apps/api/src/auth/services/siwe.service.ts'
      via: 'hashIdentifier for Google sub and email'
      pattern: 'hashIdentifier|hashWalletAddress'
    - from: 'apps/api/src/auth/auth.service.ts'
      to: 'apps/api/src/auth/entities/auth-method.entity.ts'
      via: 'identifierHash for lookups in linkMethod and login'
      pattern: 'identifierHash'
---

<objective>
Hash all auth method identifiers with SHA-256 and remove cross-method email auto-linking. After this plan, Google uses SHA-256(google_sub) (the immutable Google user ID), email uses SHA-256(normalized_email), and wallet continues using SHA-256(checksummed_address). Each auth method is fully independent -- no cross-method email matching.

Purpose: Privacy-preserving auth storage (no plaintext emails/subs in identifier column for lookup) and independent auth methods (users link explicitly via Settings, not auto-linked by email match). Using google_sub (not email) for Google ensures the identifier is immutable -- emails can change but sub never does.

Output: Updated identity controller, auth service, SIWE service (with generic hashing), schema changes, and tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Current identity controller with cross-method auto-linking to remove

@apps/api/src/auth/controllers/identity.controller.ts

# Current auth service with plaintext email lookups to update

@apps/api/src/auth/auth.service.ts

# SIWE service with wallet-specific hashing to generalize

@apps/api/src/auth/services/siwe.service.ts

# Auth method entity with identifier_hash column (currently wallet-only)

@apps/api/src/auth/entities/auth-method.entity.ts

# Schema migration to update

@apps/api/src/migrations/1700000000000-FullSchema.ts

# Google OAuth service -- verifyGoogleToken returns { email, sub, name? }

@apps/api/src/auth/services/google-oauth.service.ts

# Phase 12.3 summaries for context on current state

@.planning/phases/12.3-siwe-unified-identity/12.3-01-SUMMARY.md
@.planning/phases/12.3-siwe-unified-identity/12.3-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema, entity, migration, and SiweService hash utility</name>
  <files>
    apps/api/src/auth/services/siwe.service.ts
    apps/api/src/auth/entities/auth-method.entity.ts
    apps/api/src/migrations/1700000000000-FullSchema.ts
  </files>
  <action>
**Extend SiweService with a generic hashIdentifier method** in `apps/api/src/auth/services/siwe.service.ts`:
- Add `hashIdentifier(value: string): string` method that does `createHash('sha256').update(value).digest('hex')` -- same as hashWalletAddress but without the `getAddress()` checksumming step (the caller normalizes).
- Keep `hashWalletAddress` as-is (it checksums before hashing). The new method is for non-wallet identifiers.

**Update auth-method entity for all method types** in `apps/api/src/auth/entities/auth-method.entity.ts`:

- Change `identifier_hash` column comment to: "SHA-256 hash of the canonical identifier for all auth method types"
- Change `identifier_display` column comment to: "Human-readable display value for all auth method types"
- Widen `identifier_display` from varchar(15) to varchar(255) -- emails can be longer than truncated wallet addresses. Update both the entity `@Column` decorator AND the FullSchema migration.
- The `identifier` column will now store the hash (same as identifier_hash) for all types. The `identifierDisplay` holds the human-readable value.

**Update FullSchema migration** in `apps/api/src/migrations/1700000000000-FullSchema.ts`:

- Change `identifier_display` from `varchar(15)` to `varchar(255)` in the auth_methods CREATE TABLE
- Add an index on `(type, identifier_hash)` for efficient lookups: `CREATE INDEX "IDX_auth_methods_type_hash" ON "auth_methods" ("type", "identifier_hash")`
  </action>
  <verify>
  Run `cd /Users/michael/Code/cipher-box && pnpm --filter api build` -- should compile without errors.
  Grep for `hashIdentifier` in siwe.service.ts -- should appear.
  Grep for `varchar(255)` in auth-method.entity.ts -- should appear for identifierDisplay column.
  </verify>
  <done>
  SiweService has generic hashIdentifier method. Auth method entity widens identifier_display to varchar(255). Migration updated with wider column and composite index.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Hash all auth identifiers and remove auto-linking</name>
  <files>
    apps/api/src/auth/controllers/identity.controller.ts
    apps/api/src/auth/auth.service.ts
    apps/api/src/auth/dto/identity.dto.ts
  </files>
  <action>
**Update findOrCreateUserByEmail in identity controller** in `apps/api/src/auth/controllers/identity.controller.ts`:

- For Google login (`googleLogin` method): after verifying Google token, hash `googlePayload.sub` (NOT email -- sub is the immutable Google user ID, email can change) to get `identifierHash`. Set `identifierDisplay = googlePayload.email`. Pass both to the refactored method.
- For email login (`verifyOtp` method): `normalizedEmail = dto.email.toLowerCase().trim()`, hash it for `identifierHash`, set `identifierDisplay = normalizedEmail`.
- **Refactor `findOrCreateUserByEmail` to `findOrCreateUserByIdentifier`** with params: `(identifierHash: string, identifierDisplay: string, authMethodType: 'google' | 'email')`
- Lookup by HASH: `authMethodRepository.findOne({ where: { type: authMethodType, identifierHash } })`
- **REMOVE the cross-method email auto-linking block entirely** (the `anyMethodWithEmail` block around lines 266-298). Each auth method is independent.
- On create: set `identifier = identifierHash`, `identifierHash = identifierHash`, `identifierDisplay = identifierDisplay`
- Keep `findOrCreateUserByWallet` unchanged -- it already uses identifierHash correctly

**Update auth.service.ts login method** in `apps/api/src/auth/auth.service.ts`:

- The `login` method looks up auth methods by `identifier` (plaintext email). After this change, identifier stores hashes.
- In the login method (around line 82-102), hash the identifier before lookup: `const identifierHash = createHash('sha256').update(identifier).digest('hex')`. Then look up by `{ userId: user.id, identifierHash }` instead of `{ userId: user.id, identifier }`. `createHash` is already imported.
- The safety-net create (around line 97) should also store hashed identifier: `identifier: identifierHash, identifierHash`.

**Update auth.service.ts linkJwtMethod:**

- In `linkJwtMethod` (around line 281), hash the identifier for collision/duplicate checks: `const identifierHash = createHash('sha256').update(identifier).digest('hex')`
- Cross-account check: `where: { type: authMethodType, identifierHash, userId: Not(userId) }`
- Duplicate check: `where: { userId, type: authMethodType, identifierHash }`
- Create: `{ userId, type: authMethodType, identifier: identifierHash, identifierHash, identifierDisplay: identifier, lastUsedAt: new Date() }`

**Update getLinkedMethods:**

- In `auth.service.ts` `getLinkedMethods` (around line 233), return `identifierDisplay` for ALL types: `identifier: method.identifierDisplay || method.identifier`

**Update refreshByToken email lookup:**

- In `auth.service.ts` `refreshByToken` (around line 213), return `emailMethod?.identifierDisplay` instead of `emailMethod?.identifier` (which is now a hash).

**Update testLogin:**

- In `auth.service.ts` `testLogin`, hash the email for lookup: `const identifierHash = createHash('sha256').update(normalizedEmail).digest('hex')`. Look up by `{ type: 'email', identifierHash }`.
- When creating, set `identifier: identifierHash, identifierHash, identifierDisplay: normalizedEmail`.
  </action>
  <verify>
  Run `cd /Users/michael/Code/cipher-box && pnpm --filter api build` -- should compile without errors.
  Grep for `anyMethodWithEmail` in identity.controller.ts -- should NOT appear (cross-method linking removed).
  Grep for `identifierHash` in identity.controller.ts -- should appear (hash-based lookups).
  Grep for `googlePayload.sub` in identity.controller.ts -- should appear (hashing sub, not email).
  Grep for `identifierDisplay` in auth.service.ts -- should appear in getLinkedMethods and refreshByToken.
  </verify>
  <done>
  Google login hashes googlePayload.sub (immutable Google user ID). Email login hashes normalized email. Cross-method email auto-linking removed. identifierDisplay used for human-readable output. All auth method lookups use identifierHash.
  </done>
  </task>

<task type="auto">
  <name>Task 3: Update tests and regenerate API client</name>
  <files>
    apps/api/src/auth/controllers/identity.controller.spec.ts
    apps/api/src/auth/auth.service.spec.ts
    apps/api/src/auth/services/siwe.service.spec.ts
    packages/api-client/openapi.json
    apps/web/src/api/
  </files>
  <action>
**Update siwe.service.spec.ts:**
- Add test for `hashIdentifier`: verify it returns consistent SHA-256 hex for a known input (e.g., `hashIdentifier('test@example.com')` returns the expected 64-char hex)
- Verify `hashIdentifier('Test@Example.com')` !== `hashIdentifier('test@example.com')` (no built-in normalization -- caller must normalize)

**Update identity.controller.spec.ts:**

- Update existing Google login tests: verify that the created auth method has `identifierHash` set to SHA-256 of `googlePayload.sub` (NOT email) and `identifierDisplay` set to the plaintext email
- Update existing email OTP tests: verify `identifierHash` is SHA-256 of the normalized email, `identifierDisplay` is the plaintext email
- **Add test: Google login with email matching existing email method creates SEPARATE user** (the old cross-method linking test should now verify they are NOT linked)
- Update wallet login tests if needed (should be minimal changes since wallet already used identifierHash)

**Update auth.service.spec.ts:**

- Update login tests: mock auth methods with `identifierHash` instead of plaintext `identifier`
- Update linkJwtMethod tests: verify hash-based collision detection and hash-based duplicate detection
- Update getLinkedMethods tests: verify `identifierDisplay` is returned for all types
- Update refreshByToken tests: verify `identifierDisplay` is returned as email
- Update testLogin tests: verify hash-based lookup and creation with identifierHash

**Regenerate API client:**

- Run `pnpm api:generate` to regenerate OpenAPI spec and typed client

**Run full test suite:**

- `pnpm --filter api test` -- all tests must pass with coverage thresholds met
  </action>
  <verify>
  Run `cd /Users/michael/Code/cipher-box && pnpm --filter api test` -- all tests pass.
  Run `cd /Users/michael/Code/cipher-box && pnpm api:generate` -- succeeds without errors.
  </verify>
  <done>
  All tests updated for hashed identifiers (Google uses sub, email uses normalized email) and independent auth methods. API client regenerated. Full test suite passes with coverage thresholds.
  </done>
  </task>

</tasks>

<verification>
- `pnpm --filter api test` passes all tests
- `pnpm api:generate` succeeds
- No plaintext email/sub stored as `identifier` for new auth methods (only hashes)
- Google login hashes `googlePayload.sub` (immutable), NOT `googlePayload.email`
- Google login + email login with same email create two separate users (no auto-linking)
- getLinkedMethods returns identifierDisplay (human-readable) for all method types
- Cross-method email lookup block is completely removed from identity controller
</verification>

<success_criteria>

- Google auth method identifier_hash = SHA-256(google_sub), identifier_display = email (sub is immutable; email can change)
- Email auth method identifier_hash = SHA-256(normalized_email), identifier_display = email
- Wallet auth method identifier_hash = SHA-256(checksummed_address), identifier_display = truncated address (unchanged)
- Cross-method email auto-linking completely removed (each auth method is independent)
- All tests pass with coverage thresholds met
- API client regenerated
  </success_criteria>

<output>
After completion, create `.planning/phases/12.3.1-pre-wipe-identity-cleanup/12.3.1-02-SUMMARY.md`
</output>
