---
phase: 12.2-encrypted-device-registry
plan: 01
subsystem: crypto
tags: [ecies, hkdf, ed25519, ipns, device-registry, sha256]

# Dependency graph
requires:
  - phase: 12-core-kit-identity-provider
    provides: secp256k1 keypair from Core Kit, ECIES wrapKey/unwrapKey, HKDF deriveKey, Ed25519 keygen, IPNS name derivation
provides:
  - DeviceRegistry/DeviceEntry types with auth status and platform enums
  - encryptRegistry/decryptRegistry for ECIES-encrypted registry blobs
  - deriveRegistryIpnsKeypair for deterministic IPNS discovery from privateKey
  - validateDeviceRegistry runtime schema validation
  - generateDeviceKeypair/deriveDeviceId for per-device Ed25519 identity
affects: [12.2-plan-02, 12.2-plan-03, 12.4-mfa-cross-device]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'Deterministic IPNS derivation via HKDF from user privateKey'
    - 'ECIES encryption for full JSON blob (not just 32-byte keys)'
    - 'SHA-256 device ID from Ed25519 public key'

key-files:
  created:
    - packages/crypto/src/registry/types.ts
    - packages/crypto/src/registry/schema.ts
    - packages/crypto/src/registry/encrypt.ts
    - packages/crypto/src/registry/derive-ipns.ts
    - packages/crypto/src/registry/index.ts
    - packages/crypto/src/device/types.ts
    - packages/crypto/src/device/keygen.ts
    - packages/crypto/src/device/index.ts
    - packages/crypto/src/__tests__/registry.test.ts
  modified:
    - packages/crypto/src/index.ts

key-decisions:
  - 'No new dependencies needed - all crypto primitives reused from existing codebase'
  - 'ECIES wrapKey used for arbitrary-length registry blob (not just 32-byte keys)'

patterns-established:
  - 'Deterministic IPNS derivation: HKDF(privateKey, salt, info) -> Ed25519 seed -> IPNS name'
  - "Runtime schema validation with CryptoError('DECRYPTION_FAILED') for generic errors"
  - 'Device identity: Ed25519 keypair + SHA-256(publicKey) = deviceId'

# Metrics
duration: 3min
completed: 2026-02-13
---

# Phase 12.2 Plan 01: Registry Crypto Primitives Summary

ECIES-encrypted device registry types, deterministic IPNS derivation via HKDF, device Ed25519 identity with SHA-256 IDs, and runtime schema validation -- all composed from existing @cipherbox/crypto primitives.

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-13T21:29:46Z
- **Completed:** 2026-02-13T21:32:47Z
- **Tasks:** 2
- **Files modified:** 10

## Accomplishments

- Created `registry/` module with types, ECIES encryption, HKDF-based IPNS derivation, and schema validation
- Created `device/` module with Ed25519 keypair generation and SHA-256 device ID derivation
- All functions exported from @cipherbox/crypto barrel
- 27 unit tests covering determinism, round-trip encryption, validation edge cases, and device identity uniqueness

## Task Commits

Each task was committed atomically:

1. **Task 1: Registry and device crypto modules** - `1101533c1` (feat)
2. **Task 2: Unit tests for registry crypto operations** - `75d580177` (test)

## Files Created/Modified

- `packages/crypto/src/registry/types.ts` - DeviceEntry, DeviceRegistry, DeviceAuthStatus, DevicePlatform types
- `packages/crypto/src/registry/schema.ts` - validateDeviceRegistry runtime validation
- `packages/crypto/src/registry/encrypt.ts` - encryptRegistry/decryptRegistry via ECIES
- `packages/crypto/src/registry/derive-ipns.ts` - deriveRegistryIpnsKeypair from HKDF
- `packages/crypto/src/registry/index.ts` - Module barrel exports
- `packages/crypto/src/device/types.ts` - DeviceKeypair type
- `packages/crypto/src/device/keygen.ts` - generateDeviceKeypair/deriveDeviceId
- `packages/crypto/src/device/index.ts` - Module barrel exports
- `packages/crypto/src/index.ts` - Added registry and device exports
- `packages/crypto/src/__tests__/registry.test.ts` - 27 unit tests

## Decisions Made

None - followed plan as specified. All crypto primitives (HKDF, ECIES, Ed25519, IPNS name derivation, SHA-256) already existed in the codebase and were composed as planned.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Registry crypto primitives are ready for Plan 02 (registry service layer with IPFS/IPNS publish)
- All types exported for consumption by web app services and stores
- deriveRegistryIpnsKeypair enables deterministic IPNS discovery from any device with the user's privateKey

---

_Phase: 12.2-encrypted-device-registry_
_Completed: 2026-02-13_
