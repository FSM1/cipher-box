---
phase: 12.2-encrypted-device-registry
verified: 2026-02-13T22:55:00Z
status: passed
score: 4/4 phase-level must-haves verified
must_haves:
  truths:
    - 'Authenticated devices are tracked in an encrypted registry pinned on IPFS'
    - "Device registry is encrypted with user's key and only readable by the user"
    - 'Device metadata includes public keys, device names, authorization status, and revocation capability'
    - 'Registry is discoverable and recoverable by any authenticated session'
  artifacts:
    - path: 'packages/crypto/src/registry/types.ts'
      provides: 'DeviceEntry, DeviceRegistry, DeviceAuthStatus, DevicePlatform types'
    - path: 'packages/crypto/src/registry/derive-ipns.ts'
      provides: 'Deterministic IPNS keypair derivation from user privateKey'
    - path: 'packages/crypto/src/registry/encrypt.ts'
      provides: 'ECIES encryption/decryption for registry blob'
    - path: 'packages/crypto/src/registry/schema.ts'
      provides: 'Runtime validation for DeviceRegistry JSON'
    - path: 'packages/crypto/src/device/keygen.ts'
      provides: 'Ed25519 device keypair generation and device ID derivation'
    - path: 'apps/web/src/lib/device/identity.ts'
      provides: 'IndexedDB persistence for device Ed25519 keypair'
    - path: 'apps/web/src/lib/device/info.ts'
      provides: 'Auto-detection of device name, platform, model'
    - path: 'apps/web/src/services/device-registry.service.ts'
      provides: 'Registry CRUD: create, load, register device, update lastSeen, publish'
    - path: 'apps/web/src/stores/device-registry.store.ts'
      provides: 'Zustand store for device registry state'
    - path: 'apps/web/src/hooks/useDeviceRegistrySync.ts'
      provides: 'Polling hook for registry changes'
    - path: 'apps/web/src/hooks/useAuth.ts'
      provides: 'Updated auth hook with non-blocking registry init and logout cleanup'
  key_links:
    - from: 'derive-ipns.ts'
      to: 'keys/derive.ts'
      via: 'deriveKey() for HKDF'
    - from: 'encrypt.ts'
      to: 'ecies/'
      via: 'wrapKey/unwrapKey for ECIES'
    - from: 'identity.ts'
      to: '@cipherbox/crypto'
      via: 'generateDeviceKeypair, deriveDeviceId'
    - from: 'device-registry.service.ts'
      to: '@cipherbox/crypto'
      via: 'deriveRegistryIpnsKeypair, encryptRegistry, decryptRegistry'
    - from: 'device-registry.service.ts'
      to: 'ipns.service.ts'
      via: 'createAndPublishIpnsRecord, resolveIpnsRecord'
    - from: 'device-registry.service.ts'
      to: 'lib/api/ipfs.ts'
      via: 'addToIpfs, fetchFromIpfs'
    - from: 'useAuth.ts'
      to: 'device-registry.service.ts'
      via: 'fire-and-forget initializeOrSyncRegistry after vault load'
    - from: 'useAuth.ts'
      to: 'device-registry.store.ts'
      via: 'clearRegistry on logout'
warnings:
  - truth: 'Registry polls for remote changes on ~60s interval'
    status: partial
    reason: 'useDeviceRegistrySync hook exists with correct implementation but is not mounted in any component'
    artifacts:
      - path: 'apps/web/src/hooks/useDeviceRegistrySync.ts'
        issue: 'Exported but never imported or called by any component'
    missing:
      - 'Add useDeviceRegistrySync() call in a layout component (e.g., FileBrowser or AuthenticatedLayout)'
    severity: warning
    note: 'Does not block phase goal -- polling is a convenience for detecting cross-device changes. Initial sync on login IS wired.'
---

# Phase 12.2: Encrypted Device Registry Verification Report

**Phase Goal:** Encrypted device metadata stored on IPFS alongside user's vault, providing durable infrastructure for cross-device approval and resilience against backend rebuilds
**Verified:** 2026-02-13T22:55:00Z
**Status:** passed
**Re-verification:** No -- initial verification

## Goal Achievement

### Phase-Level Success Criteria

| #   | Criterion                                                            | Status   | Evidence                                                                                                                                                                                                              |
| --- | -------------------------------------------------------------------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Authenticated devices tracked in encrypted registry pinned on IPFS   | VERIFIED | `initializeOrSyncRegistry` in `device-registry.service.ts` creates/updates registry, encrypts with ECIES via `encryptRegistry()`, pins via `addToIpfs()`, publishes via `createAndPublishIpnsRecord()`                |
| 2   | Registry encrypted with user's key and only readable by user         | VERIFIED | `encryptRegistry()` uses ECIES `wrapKey(plaintext, userPublicKey)`, `decryptRegistry()` uses `unwrapKey(encrypted, userPrivateKey)`. Round-trip tested in 6 unit tests. Wrong-key decryption throws.                  |
| 3   | Device metadata includes public keys, names, auth status, revocation | VERIFIED | `DeviceEntry` type has: `publicKey`, `name`, `platform`, `status` (pending/authorized/revoked), `revokedAt`, `revokedBy`. Validated by `validateDeviceRegistry()` runtime schema.                                     |
| 4   | Registry discoverable and recoverable by any authenticated session   | VERIFIED | `deriveRegistryIpnsKeypair()` deterministically derives IPNS name from user's secp256k1 privateKey via HKDF. Same key always produces same IPNS name (tested). Any session with the privateKey can resolve + decrypt. |

**Score:** 4/4 phase-level success criteria verified

### Plan-Level Observable Truths

#### Plan 01: Registry Crypto Primitives

| #   | Truth                                                                  | Status   | Evidence                                                                                                                                                      |
| --- | ---------------------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Registry IPNS keypair deterministically derived from user's privateKey | VERIFIED | `deriveRegistryIpnsKeypair()` uses HKDF with fixed salt/info. Determinism tested.                                                                             |
| 2   | Same privateKey always produces same IPNS name                         | VERIFIED | Unit test "produces the same IPNS name for the same privateKey (determinism)" passes                                                                          |
| 3   | Registry encrypted/decrypted with user's publicKey/privateKey          | VERIFIED | `encryptRegistry`/`decryptRegistry` round-trip tested with 6 unit tests                                                                                       |
| 4   | Device ID is SHA-256 of device's Ed25519 public key                    | VERIFIED | `deriveDeviceId()` computes `bytesToHex(sha256(publicKey))`, tested to produce 64-char hex                                                                    |
| 5   | Registry schema validation rejects malformed data                      | VERIFIED | 11 validation tests: wrong version, invalid status, invalid platform, non-array devices, missing fields, negative/non-integer sequenceNumber, non-object data |

#### Plan 02: Device Identity and Registry Service

| #   | Truth                                                      | Status   | Evidence                                                                                                                              |
| --- | ---------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Device keypair persisted in IndexedDB, survives refresh    | VERIFIED | `getOrCreateDeviceIdentity()` loads from IndexedDB first, generates+saves if not found. Array serialization for cross-browser compat. |
| 2   | Device info auto-detected from browser                     | VERIFIED | `detectDeviceInfo()` parses `navigator.userAgent` for platform, browser, OS. Returns name, platform, appVersion, deviceModel.         |
| 3   | Registry created for first device (auto-authorized)        | VERIFIED | `initializeOrSyncRegistry()` creates registry with `status: 'authorized'` when IPNS resolution returns null                           |
| 4   | Existing device login updates lastSeenAt                   | VERIFIED | `initializeOrSyncRegistry()` finds existing device by deviceId, updates `lastSeenAt`, `appVersion`, `deviceModel`                     |
| 5   | New devices registered as 'pending'                        | VERIFIED | `initializeOrSyncRegistry()` pushes `createEmptyDeviceEntry({...status:'pending'})` when device not found in existing registry        |
| 6   | Changes encrypted, pinned to IPFS, published via IPNS      | VERIFIED | Service calls `encryptRegistry()` -> `addToIpfs()` -> `createAndPublishIpnsRecord()` with TEE enrollment                              |
| 7   | Registry operations never block (errors caught and logged) | VERIFIED | Entire `initializeOrSyncRegistry()` body wrapped in try/catch returning null. Console.error logged.                                   |

#### Plan 03: Auth Flow Integration

| #   | Truth                                              | Status          | Evidence                                                                                                                                                 |
| --- | -------------------------------------------------- | --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Registry initialized non-blocking after vault load | VERIFIED        | `useAuth.ts` line 135-153: `void (async () => { ... })()` IIFE after vault try/catch. Never awaited.                                                     |
| 2   | Registry state in Zustand store for UI             | VERIFIED        | `useDeviceRegistryStore` has registry, currentDeviceId, ipnsName, lastSyncedAt, syncError, isInitialized                                                 |
| 3   | Registry polls for remote changes on ~60s interval | PARTIAL         | `useDeviceRegistrySync` hook fully implemented (60s interval, pauses on background/offline, guards concurrent runs) but **not mounted** in any component |
| 4   | Polling pauses when tab backgrounded or offline    | VERIFIED (code) | Hook uses `useVisibility()` and `useOnlineStatus()`, sets `pollDelay = null` when not visible or offline                                                 |
| 5   | Registry state cleared on logout                   | VERIFIED        | `useAuth.ts` calls `useDeviceRegistryStore.getState().clearRegistry()` in both success (line 295) and error (line 306) logout paths                      |
| 6   | Login never blocked by registry errors             | VERIFIED        | Fire-and-forget IIFE with independent try/catch. Vault load is awaited; registry init is void.                                                           |

**Plan-level score:** 18/19 truths verified, 1 partial (polling hook not mounted)

### Required Artifacts

| Artifact                                           | Status   | Lines | Stubs | Wired                                        |
| -------------------------------------------------- | -------- | ----- | ----- | -------------------------------------------- |
| `packages/crypto/src/registry/types.ts`            | VERIFIED | 61    | 0     | Exported from barrel, imported by 5+ files   |
| `packages/crypto/src/registry/schema.ts`           | VERIFIED | 108   | 0     | Used by encrypt.ts, tests                    |
| `packages/crypto/src/registry/encrypt.ts`          | VERIFIED | 56    | 0     | Used by service, tests                       |
| `packages/crypto/src/registry/derive-ipns.ts`      | VERIFIED | 66    | 0     | Used by service, tests                       |
| `packages/crypto/src/registry/index.ts`            | VERIFIED | 15    | 0     | Re-exports all registry modules              |
| `packages/crypto/src/device/types.ts`              | VERIFIED | 20    | 0     | Exported from barrel                         |
| `packages/crypto/src/device/keygen.ts`             | VERIFIED | 43    | 0     | Used by identity.ts, tests                   |
| `packages/crypto/src/device/index.ts`              | VERIFIED | 8     | 0     | Re-exports device modules                    |
| `packages/crypto/src/__tests__/registry.test.ts`   | VERIFIED | 312   | 0     | 27 tests, all pass                           |
| `apps/web/src/lib/device/identity.ts`              | VERIFIED | 133   | 0     | Used by useAuth.ts                           |
| `apps/web/src/lib/device/info.ts`                  | VERIFIED | 117   | 0     | Used by useAuth.ts                           |
| `apps/web/src/services/device-registry.service.ts` | VERIFIED | 247   | 0     | Used by useAuth.ts, useDeviceRegistrySync.ts |
| `apps/web/src/stores/device-registry.store.ts`     | VERIFIED | 78    | 0     | Used by useAuth.ts, useDeviceRegistrySync.ts |
| `apps/web/src/hooks/useDeviceRegistrySync.ts`      | ORPHANED | 69    | 0     | Exported but never imported by any component |
| `apps/web/src/hooks/useAuth.ts` (modified)         | VERIFIED | 372   | 0     | Core auth hook used throughout app           |

### Key Link Verification

| From                       | To                         | Via                                                               | Status    | Details                                                    |
| -------------------------- | -------------------------- | ----------------------------------------------------------------- | --------- | ---------------------------------------------------------- |
| derive-ipns.ts             | keys/derive.ts             | `deriveKey()`                                                     | WIRED     | Line 48: `deriveKey({inputKey, salt, info, outputLength})` |
| encrypt.ts                 | ecies/                     | `wrapKey`/`unwrapKey`                                             | WIRED     | Lines 34, 52                                               |
| index.ts (barrel)          | registry/                  | re-export                                                         | WIRED     | Lines 92-102, 104-105                                      |
| identity.ts                | @cipherbox/crypto          | `generateDeviceKeypair`, `deriveDeviceId`                         | WIRED     | Lines 13, 117, 126                                         |
| device-registry.service.ts | @cipherbox/crypto          | `deriveRegistryIpnsKeypair`, `encryptRegistry`, `decryptRegistry` | WIRED     | Lines 15-17, 59, 70, 138, 189, 197                         |
| device-registry.service.ts | ipns.service.ts            | `createAndPublishIpnsRecord`, `resolveIpnsRecord`                 | WIRED     | Lines 27, 65, 158, 190                                     |
| device-registry.service.ts | lib/api/ipfs.ts            | `addToIpfs`, `fetchFromIpfs`                                      | WIRED     | Lines 26, 69, 141, 196                                     |
| useAuth.ts                 | device-registry.service.ts | `initializeOrSyncRegistry` fire-and-forget                        | WIRED     | Lines 21, 139                                              |
| useDeviceRegistrySync.ts   | device-registry.service.ts | `loadRegistry` for polling                                        | WIRED     | Lines 7, 46                                                |
| useAuth.ts                 | device-registry.store.ts   | `clearRegistry` on logout                                         | WIRED     | Lines 10, 295, 306                                         |
| useDeviceRegistrySync.ts   | component tree             | hook call                                                         | NOT WIRED | Hook is never called                                       |

### Build & Test Verification

| Check                                                    | Status | Details                                         |
| -------------------------------------------------------- | ------ | ----------------------------------------------- |
| `pnpm --filter @cipherbox/crypto build`                  | PASS   | ESM + CJS + DTS built successfully              |
| `pnpm --filter @cipherbox/crypto test -- --run registry` | PASS   | 27/27 tests pass (274ms)                        |
| `pnpm --filter web build` (tsc -b + vite)                | PASS   | TypeScript compilation + Vite bundle successful |

### Anti-Patterns Found

| File                       | Pattern                                          | Severity | Impact                                   |
| -------------------------- | ------------------------------------------------ | -------- | ---------------------------------------- |
| (none)                     | No TODO/FIXME/PLACEHOLDER found in any new files | N/A      | Clean                                    |
| device-registry.service.ts | `return null` (3 occurrences)                    | Info     | By design -- non-blocking error handling |

### Human Verification Required

### 1. First Login Creates Registry on IPFS

**Test:** Log in to CipherBox from a fresh browser profile. Check browser console for `[DeviceRegistry]` log messages.
**Expected:** No errors. Console may show IPNS publish activity. `useDeviceRegistryStore` should show `isInitialized: true` with one authorized device.
**Why human:** Requires real Web3Auth login, IPFS pinning, and IPNS publish which can't be verified structurally.

### 2. Second Device Registers as Pending

**Test:** Log in from a different browser/incognito window with the same account.
**Expected:** New device appears in registry with `status: 'pending'`. First device remains `authorized`.
**Why human:** Requires two separate browser sessions and real IPNS resolution.

### 3. Registry Survives Page Refresh

**Test:** After logging in, refresh the page. Check that the same device ID is used (console logs or devtools Zustand state).
**Expected:** IndexedDB returns existing keypair; same deviceId as before refresh.
**Why human:** Requires browser interaction and IndexedDB persistence.

### Warnings Summary

One warning identified that does not block phase goal achievement:

**useDeviceRegistrySync hook is orphaned.** The polling hook (`apps/web/src/hooks/useDeviceRegistrySync.ts`) has a correct, complete implementation but is never mounted in any component. This means registry changes made by other devices will not be detected until the next login. The initial sync on login IS wired correctly. This should be addressed (a single `useDeviceRegistrySync()` call in a layout component) but does not block the core goal of "encrypted device metadata stored on IPFS."

---

_Verified: 2026-02-13T22:55:00Z_
_Verifier: Claude (gsd-verifier)_
