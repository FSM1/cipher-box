# Phase 12.2: Encrypted Device Registry - Context

**Gathered:** 2026-02-13
**Status:** Ready for planning

## Phase Boundary

Encrypted device metadata stored on IPFS alongside the user's vault, providing durable infrastructure for cross-device approval (Phase 12.4) and resilience against backend rebuilds. This phase builds the data structure and storage layer — the approval UX and key exchange are Phase 12.4.

## Implementation Decisions

### Registry Schema

- Device ID = SHA-256 hash of the device's public key (deterministic, dedup-safe, verifiable)
- Rich metadata per device: public key, device name, platform (macOS/Linux/Windows/Web), created timestamp, last seen timestamp, app version, device model/OS version, IP hash, authorization status
- Authorization status field with values: pending / authorized / revoked
- Revoked devices remain in registry with revocation timestamp and revokedBy field (audit trail)
- First device auto-authorized; subsequent devices registered as "pending"
- "Pending" is non-blocking in Phase 12.2 — full access still granted. Phase 12.4 turns pending status into a real approval gate

### Storage & Encryption

- Separate IPNS name for registry (independent from vault IPNS) — avoids contention with file operations on the vault IPNS
- Registry IPNS key derived deterministically from user's privateKey + fixed context string (e.g., HKDF with "cipherbox-device-registry-ipns-v1") — any session with privateKey can discover the registry without backend
- Registry encrypted with user's publicKey via ECIES — only the user can read their registry
- Single encrypted JSON blob (not per-device entries) — entire registry is < 10KB for 2-10 devices, always accessed as a whole

### Discovery & Recovery

- Deterministic IPNS derivation: any session with the user's privateKey can derive the registry IPNS name and signing key
- No backend dependency for registry discovery (backend may cache IPNS name for performance but is not the source of truth)
- Auto-create registry on first successful Core Kit login — first device becomes the inaugural entry (auto-authorized)
- Subsequent devices: authenticate → derive registry IPNS → resolve → decrypt → add self as "pending" → encrypt → publish

### Concurrency & Conflicts

- Last-write-wins with monotonic sequence counter — each registry update increments the sequence number
- Acceptable trade-off: concurrent updates are extremely rare (device registration happens every few months)
- Periodic polling for registry changes during session (similar to vault sync interval, e.g., every 60s)
- Polling detects: new device registrations, device revocations, status changes

### Claude's Discretion

- Exact HKDF context string and derivation parameters for registry IPNS key
- Polling interval for registry changes (suggested ~60s, but flexible)
- Registry JSON schema field naming conventions
- Error handling for IPNS resolution failures (fallback to cached CID, retry logic)
- How to handle IPNS resolution when registry doesn't exist yet (first device bootstrap vs. IPNS not found)

## Specific Ideas

- Registry should follow the same encryption pattern as folderKeys (ECIES with user's publicKey) for consistency
- The deterministic IPNS derivation pattern established here is intended to be the model for future vault IPNS migration (see deferred ideas)
- Rich metadata (IP hash, device model) supports "was this you?" security prompts in Phase 12.4's device approval UI

## Deferred Ideas

- **Migrate vault IPNS to deterministic derivation** — Currently vault IPNS keys are backend-generated and stored in DB. Migrating to deterministic derivation (like the registry) would enable true self-sovereign recovery: recovery phrase → privateKey → derive all IPNS keys → resolve → full vault recovery with no backend dependency. Logged as todo: `.planning/todos/pending/2026-02-13-deterministic-vault-ipns-derivation.md`
- **CRDT-style merge for concurrent updates** — Simple merge (union of device entries, newer timestamp wins per entry, ~50 lines) would preserve both operations in rare concurrent update scenarios. Deferred in favor of last-write-wins for simplicity, but could be added if concurrency issues arise in practice.
- **Device approval gate** — Phase 12.4 scope. Currently "pending" status is non-blocking. 12.4 will add the bulletin board API, ECIES key exchange, and approval UX to make "pending" a real gate.

---

_Phase: 12.2-encrypted-device-registry_
_Context gathered: 2026-02-13_
