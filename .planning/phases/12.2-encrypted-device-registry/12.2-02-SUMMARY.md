---
phase: 12.2-encrypted-device-registry
plan: 02
subsystem: crypto
tags: [indexeddb, device-identity, ipfs, ipns, ecies, device-registry, zustand]

# Dependency graph
requires:
  - phase: 12.2-encrypted-device-registry
    plan: 01
    provides: encryptRegistry/decryptRegistry, deriveRegistryIpnsKeypair, generateDeviceKeypair/deriveDeviceId, DeviceRegistry/DeviceEntry types
  - phase: 12-core-kit-identity-provider
    provides: secp256k1 keypair (userPrivateKey/userPublicKey), useAuthStore with teeKeys
provides:
  - getOrCreateDeviceIdentity for IndexedDB-persisted device keypairs
  - detectDeviceInfo for browser environment auto-detection
  - computeIpHash for privacy-preserving IP hashing
  - initializeOrSyncRegistry for full registry CRUD lifecycle
  - loadRegistry for read-only registry polling
  - createEmptyDeviceEntry helper for constructing device entries
affects: [12.2-plan-03, 12.4-mfa-cross-device]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'IndexedDB persistence with plain array serialization for Uint8Array compatibility'
    - 'Non-blocking registry operations with try/catch returning null on failure'
    - 'Heartbeat debounce to avoid unnecessary ECIES re-encryption and IPNS republish'

key-files:
  created:
    - apps/web/src/lib/device/identity.ts
    - apps/web/src/lib/device/info.ts
    - apps/web/src/services/device-registry.service.ts
  modified: []

key-decisions:
  - 'Used Web Crypto SHA-256 for computeIpHash instead of @noble/hashes (not a direct web app dependency)'
  - 'computeIpHash is async (Web Crypto) rather than sync (@noble/hashes) -- acceptable for this use case'
  - 'BlobPart cast for Uint8Array in Blob constructor to satisfy strict TypeScript typing'

patterns-established:
  - 'IndexedDB device keypair: store as Array.from() on write, new Uint8Array() on read'
  - 'Registry service: resolve IPNS -> fetch IPFS -> decrypt -> modify -> encrypt -> pin -> publish'
  - 'Heartbeat debounce (5 min) to avoid unnecessary IPNS publishes for lastSeenAt-only changes'

# Metrics
duration: 4min
completed: 2026-02-13
---

# Phase 12.2 Plan 02: Registry Service Layer Summary

IndexedDB device identity persistence, browser environment auto-detection, and complete registry CRUD service with IPFS/IPNS lifecycle following folder.service.ts patterns.

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-13T21:35:22Z
- **Completed:** 2026-02-13T21:39:52Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments

- Created device identity module with IndexedDB persistence for Ed25519 keypairs (survives page refresh)
- Created device info detection with platform, browser, and OS auto-detection from navigator.userAgent
- Built complete registry service: initializeOrSyncRegistry handles create-or-update, encrypt, pin, publish with TEE enrollment
- Heartbeat debounce prevents unnecessary IPNS publishes when only lastSeenAt changed within 5 minutes

## Task Commits

Each task was committed atomically:

1. **Task 1: Device identity persistence and info detection** - `28dea18d2` (feat)
2. **Task 2: Device registry service (CRUD + IPFS/IPNS)** - `46b3fe13d` (feat)

## Files Created/Modified

- `apps/web/src/lib/device/identity.ts` - IndexedDB persistence for device Ed25519 keypair with getOrCreateDeviceIdentity
- `apps/web/src/lib/device/info.ts` - Auto-detection of device name, platform, model, and IP hash computation
- `apps/web/src/services/device-registry.service.ts` - Registry CRUD lifecycle with IPFS/IPNS publish and TEE enrollment

## Decisions Made

- **Web Crypto for IP hashing:** Used `crypto.subtle.digest('SHA-256', ...)` instead of `sha256` from `@noble/hashes` because `@noble/hashes` is not a direct dependency of the web app (only of `@cipherbox/crypto`). Web Crypto is available in all modern browsers and avoids transitive dependency imports. This makes `computeIpHash` async rather than sync, which is acceptable for this use case.
- **BlobPart cast:** TypeScript strict mode requires casting `Uint8Array` to `BlobPart` for Blob constructor. This is a type-level assertion only -- the runtime behavior is correct (Blob accepts Uint8Array directly per CLAUDE.md guidelines).

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- **TypeScript Blob typing:** `new Blob([encryptedBytes])` produced a type error because TypeScript's strict mode sees `Uint8Array<ArrayBufferLike>` as incompatible with `BlobPart`. Resolved with `as BlobPart` cast, following the principle that the typed array should be passed directly (never `.buffer`).

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Device identity and registry service are ready for Plan 03 (Zustand store, auth flow integration, polling hook)
- All exports available: getOrCreateDeviceIdentity, detectDeviceInfo, computeIpHash, initializeOrSyncRegistry, loadRegistry, createEmptyDeviceEntry
- Registry operations are non-blocking -- safe to call during login flow without risk of blocking vault access

---

_Phase: 12.2-encrypted-device-registry_
_Completed: 2026-02-13_
