---
phase: 12.2-encrypted-device-registry
plan: 03
subsystem: crypto
tags: [zustand, polling, device-registry, auth-flow, ipns, ecies]

# Dependency graph
requires:
  - phase: 12.2-encrypted-device-registry
    plan: 01
    provides: DeviceRegistry/DeviceEntry types, encryptRegistry/decryptRegistry, deriveRegistryIpnsKeypair
  - phase: 12.2-encrypted-device-registry
    plan: 02
    provides: getOrCreateDeviceIdentity, detectDeviceInfo, initializeOrSyncRegistry, loadRegistry
  - phase: 12-core-kit-identity-provider
    provides: secp256k1 keypair (userPrivateKey/userPublicKey), useAuthStore with derivedKeypair
provides:
  - useDeviceRegistryStore Zustand store for device registry state management
  - useDeviceRegistrySync polling hook for remote registry changes (60s interval)
  - Non-blocking registry initialization wired into auth flow (login + session restore)
  - Registry cleanup on logout (both success and error paths)
affects: [12.4-mfa-cross-device]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'Fire-and-forget IIFE for non-blocking side effects after critical path'
    - 'Independent polling interval for registry (60s) separate from vault sync (30s)'
    - 'getState() inside async callbacks to avoid stale Zustand closures'

key-files:
  created:
    - apps/web/src/stores/device-registry.store.ts
    - apps/web/src/hooks/useDeviceRegistrySync.ts
  modified:
    - apps/web/src/hooks/useAuth.ts

key-decisions:
  - 'Registry init placed once after vault try/catch rather than duplicated in each branch'
  - 'ipHash set to empty string until backend IP endpoint exists'
  - 'Polling only starts after isInitialized is true (initial load via auth, not polling hook)'

patterns-established:
  - 'Non-blocking fire-and-forget IIFE pattern: void (async () => { try { ... } catch { console.error(...) } })()'
  - 'Separate polling intervals for different IPNS-backed state (registry 60s vs vault 30s)'

# Metrics
duration: 3min
completed: 2026-02-13
---

# Phase 12.2 Plan 03: Auth Flow Integration Summary

Zustand store for device registry with 60s polling, non-blocking auth flow wiring, and logout cleanup.

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-13T21:42:24Z
- **Completed:** 2026-02-13T21:44:58Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments

- Created Zustand store for device registry state with initialization tracking, sync error state, and clean teardown
- Created polling hook that checks for remote registry changes every 60s, pausing when tab is backgrounded or offline
- Wired non-blocking registry initialization into auth flow (fires after vault load, never blocks login)
- Added registry store cleanup to both success and error paths of logout

## Task Commits

Each task was committed atomically:

1. **Task 1: Zustand store and polling hook** - `25a329b18` (feat)
2. **Task 2: Wire registry into auth flow and logout** - `10a0f8f3a` (feat)

## Files Created/Modified

- `apps/web/src/stores/device-registry.store.ts` - Zustand store with registry, deviceId, ipnsName, sync status, and initialization tracking
- `apps/web/src/hooks/useDeviceRegistrySync.ts` - Polling hook using useInterval/useVisibility/useOnlineStatus, guards concurrent runs with ref
- `apps/web/src/hooks/useAuth.ts` - Added registry init after vault load (fire-and-forget IIFE), added clearRegistry to both logout paths

## Decisions Made

- **Single registry init location:** Placed the fire-and-forget IIFE once after the vault try/catch block rather than duplicating in both the existing-vault and new-vault branches. The `userKeypair` variable is available at that scope level, and this avoids code duplication.
- **Empty ipHash:** Set to `''` since the backend endpoint to return client IP does not exist yet. Noted in RESEARCH.md open questions.
- **Polling starts after init only:** The polling hook checks `isInitialized` from the store before syncing, so it naturally waits for the auth flow to complete the first registry load.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Phase 12.2 (Encrypted Device Registry) is now complete
- All three plans delivered: crypto primitives (01), service layer (02), auth flow integration (03)
- Device registry automatically initializes on login, polls for changes, and clears on logout
- Ready for Phase 12.3 (SIWE + Unified Identity) or Phase 12.4 (MFA + Cross-Device Approval)
- Phase 12.4 will use `useDeviceRegistryStore` to display device list in approval UI

---

_Phase: 12.2-encrypted-device-registry_
_Completed: 2026-02-13_
