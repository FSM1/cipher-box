---
phase: 04.2-local-ipfs-testing
plan: 01
subsystem: infrastructure
tags: [ipfs, kubo, docker, provider-pattern, nestjs, dependency-injection]

# Dependency graph
requires:
  - phase: 04-file-storage
    provides: IpfsService, IpfsController, IpfsModule implementations
provides:
  - Docker Compose Kubo IPFS service configuration
  - IpfsProvider interface for provider abstraction
  - PinataProvider implementation (extracted from IpfsService)
  - LocalProvider implementation for local IPFS node
  - Dynamic IpfsModule with forRootAsync() pattern
  - Controller updated to use provider injection
affects: [04.2-02, ci-pipeline, e2e-tests]

# Tech tracking
tech-stack:
  added:
    - 'ipfs/kubo:v0.34.0 (Docker image)'
  patterns:
    - 'Provider pattern for pluggable IPFS backends'
    - 'Dynamic NestJS module with forRootAsync()'
    - '@Inject(IPFS_PROVIDER) token injection'

key-files:
  created:
    - apps/api/src/ipfs/providers/ipfs-provider.interface.ts
    - apps/api/src/ipfs/providers/pinata.provider.ts
    - apps/api/src/ipfs/providers/local.provider.ts
    - apps/api/src/ipfs/providers/index.ts
    - apps/api/src/ipfs/providers/pinata.provider.spec.ts
  modified:
    - docker/docker-compose.yml
    - apps/api/src/ipfs/ipfs.module.ts
    - apps/api/src/ipfs/ipfs.controller.ts
    - apps/api/src/ipfs/ipfs.controller.spec.ts
    - apps/api/src/app.module.ts
    - apps/api/jest.config.js
  deleted:
    - apps/api/src/ipfs/ipfs.service.ts
    - apps/api/src/ipfs/ipfs.service.spec.ts

key-decisions:
  - 'Token injection with @Inject(IPFS_PROVIDER) for provider abstraction'
  - 'Kubo API uses POST for all operations (not REST conventions)'
  - 'Gateway URL kept as constructor param for future public read access'
  - 'IPFS_PROVIDER env var switches between local and pinata'

patterns-established:
  - 'Provider pattern: Interface + multiple implementations + factory injection'
  - 'Dynamic module pattern: forRootAsync() with ConfigService injection'
  - 'Kubo API pattern: All operations use POST method'

# Metrics
duration: 8min
completed: 2026-01-21
---

# Phase 4.2 Plan 01: Local IPFS Infrastructure Summary

**Added Kubo IPFS to Docker Compose and refactored IPFS service to provider pattern enabling pluggable backends**

## Performance

- **Duration:** 8 min
- **Started:** 2026-01-21
- **Completed:** 2026-01-21
- **Tasks:** 3
- **Files created:** 5
- **Files modified:** 6
- **Files deleted:** 2

## Accomplishments

- Docker Compose now includes Kubo IPFS service with health checks and resource limits
- IpfsProvider interface abstracts IPFS operations (pinFile, unpinFile, getFile)
- PinataProvider extracted from original IpfsService with added getFile method
- LocalProvider implements Kubo RPC API for local IPFS node
- IpfsModule converted to dynamic module with forRootAsync() pattern
- IpfsController updated to use @Inject(IPFS_PROVIDER) token injection
- All 144 tests pass with provider pattern

## Environment Variables

| Variable                 | Default                 | Description                              |
| ------------------------ | ----------------------- | ---------------------------------------- |
| `IPFS_PROVIDER`          | `pinata`                | Provider selection (`local` or `pinata`) |
| `IPFS_LOCAL_API_URL`     | `http://localhost:5001` | Kubo RPC API endpoint                    |
| `IPFS_LOCAL_GATEWAY_URL` | `http://localhost:8080` | Kubo gateway endpoint                    |
| `PINATA_JWT`             | (required for pinata)   | Pinata API JWT token                     |

## Files Created/Modified

### Created

- `apps/api/src/ipfs/providers/ipfs-provider.interface.ts` - Provider interface with IPFS_PROVIDER token
- `apps/api/src/ipfs/providers/pinata.provider.ts` - Pinata implementation (extracted from IpfsService)
- `apps/api/src/ipfs/providers/local.provider.ts` - Local Kubo implementation
- `apps/api/src/ipfs/providers/index.ts` - Barrel export
- `apps/api/src/ipfs/providers/pinata.provider.spec.ts` - PinataProvider tests (moved from ipfs.service.spec.ts)

### Modified

- `docker/docker-compose.yml` - Added Kubo IPFS service
- `apps/api/src/ipfs/ipfs.module.ts` - Converted to dynamic module
- `apps/api/src/ipfs/ipfs.controller.ts` - Changed to provider injection
- `apps/api/src/ipfs/ipfs.controller.spec.ts` - Updated to mock IPFS_PROVIDER
- `apps/api/src/app.module.ts` - Changed to IpfsModule.forRootAsync()
- `apps/api/jest.config.js` - Updated coverage thresholds for provider paths

### Deleted

- `apps/api/src/ipfs/ipfs.service.ts` - Logic moved to PinataProvider
- `apps/api/src/ipfs/ipfs.service.spec.ts` - Moved to pinata.provider.spec.ts

## Docker Compose Configuration

```yaml
ipfs:
  image: ipfs/kubo:v0.34.0
  container_name: cipherbox-ipfs
  restart: unless-stopped
  ports:
    - '4001:4001/tcp' # Swarm P2P
    - '4001:4001/udp'
    - '127.0.0.1:5001:5001' # API (localhost only)
    - '127.0.0.1:8080:8080' # Gateway (localhost only)
  healthcheck:
    test: ['CMD-SHELL', 'ipfs id || exit 1']
    start_period: 30s
  deploy:
    resources:
      limits:
        memory: 2G
        cpus: '1.0'
```

## Test Results

- **Total tests:** 144 passed
- **IPFS tests:** 23 passed (PinataProvider: 17, IpfsController: 6)
- **Build:** Successful

## Decisions Made

1. **Token injection over class injection:** Used `@Inject(IPFS_PROVIDER)` to avoid silent failures with class-based injection per research findings
2. **Kubo API POST methods:** All Kubo RPC operations use POST (not REST conventions), including cat and unpin
3. **Gateway URL param retained:** Kept in LocalProvider constructor for future public read access scenarios
4. **API port localhost-only:** Bound 5001 to 127.0.0.1 for security (admin-level access)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Non-blocking] Pre-existing TypeScript error in auth.service.spec.ts**

- **Found during:** Build verification
- **Issue:** Test file used `loginType: 'github'` but DTO type only allows `'external_wallet' | 'social'`
- **Fix:** Changed test to use `loginType: 'social'`
- **Files modified:** apps/api/src/auth/auth.service.spec.ts
- **Verification:** Build and tests pass
- **Note:** This was a pre-existing issue, not introduced by this plan

---

**Total deviations:** 1 auto-fixed (0 blocking related to plan scope)
**Impact on plan:** None - fix was for pre-existing issue

## Issues Encountered

None related to plan scope.

## User Setup Required

To use local IPFS for development:

```bash
# Start IPFS container
docker compose -f docker/docker-compose.yml up -d ipfs

# Wait for IPFS to be ready
until curl -s -X POST http://localhost:5001/api/v0/id > /dev/null; do sleep 1; done

# Start API with local provider
IPFS_PROVIDER=local pnpm -F api start:dev
```

## Next Phase Readiness

- Provider pattern established for IPFS backends
- Local IPFS infrastructure ready in Docker
- Ready for 04.2-02 (CI service container and integration tests)
- LocalProvider needs unit tests (planned in 04.2-02)

---

_Phase: 04.2-local-ipfs-testing_
_Completed: 2026-01-21_
