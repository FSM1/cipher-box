# Phase 4.2: Local IPFS Testing Infrastructure - Context

**Gathered:** 2026-01-21
**Status:** Ready for planning

<domain>
## Phase Boundary

Add local IPFS node (Kubo) to Docker Compose stack so integration and E2E tests can run without external Pinata dependencies. Backend IPFS service abstracted to work with both local node and Pinata based on configuration.

</domain>

<decisions>
## Implementation Decisions

### Environment Switching
- Single environment variable toggle: `IPFS_PROVIDER=local|pinata`
- Fail fast if `IPFS_PROVIDER=local` but local node isn't running - no silent fallback
- Separate URLs for API and gateway: `IPFS_LOCAL_API_URL` and `IPFS_LOCAL_GATEWAY_URL`
- Default to Kubo standard ports: API at `http://localhost:5001`, Gateway at `http://localhost:8080`

### Local Node Behavior
- Data persists in Docker named volume (faster repeated runs, avoids re-downloading blocks)
- Gateway exposed to host on port 8080 for debugging (can browse CIDs in browser)
- API exposed to host on port 5001
- Use standard Kubo defaults with swarm enabled (connects to IPFS network)
- Apply modest resource limits (memory/CPU caps) to avoid runaway usage

### Test Isolation
- Run `ipfs repo gc` after test suites complete to clean up
- Health check before tests - wait for IPFS node to be ready before starting
- Use GitHub Actions service container for IPFS in CI workflows

### Service Abstraction
- Interface + implementations pattern: `IpfsProvider` interface with `PinataProvider` and `LocalProvider` classes
- Unified error types - map provider-specific errors to common error types
- NestJS dynamic module: `IpfsModule.forRoot()` reads config and provides correct implementation
- Local provider implements test subset only: pin, unpin, get - skip Pinata-specific features

### Claude's Discretion
- Test parallelism strategy (sequential vs parallel with isolation)
- Exact memory/CPU limits for IPFS container
- Specific error type mappings between providers
- Health check implementation details (polling interval, timeout)

</decisions>

<specifics>
## Specific Ideas

- Hybrid local/Pinata architecture (local as hot cache for metadata, Pinata for durable storage) - captured as deferred idea for future phase

</specifics>

<deferred>
## Deferred Ideas

- **Hybrid IPFS architecture** â€” Local node as hot cache for metadata/IPNS while delegating user data pinning to external providers. Would require significant architecture changes beyond testing infrastructure scope.

</deferred>

---

*Phase: 04.2-local-ipfs-testing*
*Context gathered: 2026-01-21*
