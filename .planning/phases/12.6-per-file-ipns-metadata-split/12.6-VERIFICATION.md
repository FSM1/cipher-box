---
phase: 12.6-per-file-ipns-metadata-split
verified: 2026-02-17T02:15:00Z
status: gaps_found
score: 7/8 must-haves verified
must_haves:
  truths:
    - 'File metadata lives in its own IPNS record derived via HKDF from privateKey + fileId'
    - 'Folder metadata contains only FilePointer (name + fileMetaIpnsName) -- no embedded CIDs or file keys'
    - 'Content update publishes only the file IPNS record, not the parent folder'
    - 'File rename publishes only the folder IPNS record, not the file IPNS'
    - 'Batch operations publish all file IPNS records in a single API call'
    - 'TEE republisher handles per-file IPNS records with acceptable scalability'
    - 'Desktop FUSE client reads per-file IPNS metadata correctly'
    - 'Vault export includes per-file metadata in portable format'
  artifacts:
    - path: 'packages/crypto/src/file/derive-ipns.ts'
      provides: 'HKDF-based per-file IPNS keypair derivation'
    - path: 'packages/crypto/src/file/types.ts'
      provides: 'FileMetadata, FilePointer, EncryptedFileMetadata types'
    - path: 'packages/crypto/src/file/metadata.ts'
      provides: 'encryptFileMetadata / decryptFileMetadata'
    - path: 'packages/crypto/src/folder/types.ts'
      provides: 'FolderMetadataV2, FolderChildV2, AnyFolderMetadata types'
    - path: 'packages/crypto/src/folder/metadata.ts'
      provides: 'isV2Metadata type guard, updated validator for v1/v2'
    - path: 'apps/api/src/ipns/dto/publish.dto.ts'
      provides: 'BatchPublishIpnsDto, PublishIpnsEntryDto DTOs'
    - path: 'apps/api/src/ipns/ipns.controller.ts'
      provides: 'POST /ipns/publish-batch endpoint'
    - path: 'apps/api/src/ipns/ipns.service.ts'
      provides: 'publishBatch method with concurrency-limited processing'
    - path: 'apps/api/src/ipns/entities/folder-ipns.entity.ts'
      provides: 'recordType column distinguishing folder vs file'
    - path: 'apps/api/src/republish/republish.service.ts'
      provides: 'Scaled BATCH_SIZE=100, take=2000, unenrollIpns method'
    - path: 'apps/web/src/services/file-metadata.service.ts'
      provides: 'createFileMetadata, resolveFileMetadata, updateFileMetadata'
    - path: 'apps/web/src/services/folder.service.ts'
      provides: 'v2 folder operations with FilePointer, batch publish, replaceFileInFolder'
    - path: 'apps/web/src/services/download.service.ts'
      provides: 'downloadFileFromIpns for IPNS-based file download'
    - path: 'apps/web/src/services/ipns.service.ts'
      provides: 'batchPublishIpnsRecords wrapping publish-batch API'
    - path: 'apps/web/src/hooks/useFolder.ts'
      provides: 'v2 addFile, addFiles, updateFile operations'
    - path: 'apps/web/src/hooks/useFileDownload.ts'
      provides: 'downloadFromIpns function for v2 flow'
    - path: 'apps/web/src/hooks/useFilePreview.ts'
      provides: 'IPNS-based preview with folderKey param'
    - path: 'apps/web/src/stores/folder.store.ts'
      provides: 'FolderNode using FolderChildV2[]'
    - path: 'apps/web/public/recovery.html'
      provides: 'v2-aware recovery with IPNS resolution'
    - path: 'docs/VAULT_EXPORT_FORMAT.md'
      provides: 'v2 schema documentation'
  key_links:
    - from: 'file-metadata.service.ts'
      to: 'deriveFileIpnsKeypair'
      via: 'import from @cipherbox/crypto'
    - from: 'folder.service.ts'
      to: 'batchPublishIpnsRecords'
      via: 'import from ipns.service'
    - from: 'useFolder.ts'
      to: 'createFileMetadata'
      via: 'import from file-metadata.service'
    - from: 'FileBrowser.tsx'
      to: 'downloadFromIpns'
      via: 'useFileDownload hook'
    - from: 'replaceFileInFolder'
      to: 'batchPublishIpnsRecords'
      via: 'file IPNS only, no folder update'
    - from: 'recovery.html'
      to: 'IPNS resolve + decrypt'
      via: 'inline HKDF + base36 derivation'
gaps:
  - truth: 'Desktop FUSE client reads per-file IPNS metadata correctly'
    status: failed
    reason: 'Desktop FUSE client has zero v2/per-file IPNS awareness. No FilePointer, FileMetadata, or IPNS resolution for files exists in the Rust codebase.'
    artifacts:
      - path: 'apps/desktop/src-tauri/'
        issue: 'No v2 folder metadata parsing, no per-file IPNS resolution, no FilePointer type handling'
    missing:
      - 'v2 FolderMetadata deserialization in Rust FUSE client'
      - 'FilePointer struct with fileMetaIpnsName field'
      - 'Per-file IPNS resolution (resolve fileMetaIpnsName -> CID -> fetch metadata -> decrypt)'
      - 'FileMetadata struct and decryption logic'
      - 'Updated folder listing to show files from resolved FilePointer metadata'
---

# Phase 12.6: Per-File IPNS Metadata Split Verification Report

**Phase Goal:** Split file metadata into separate per-file IPNS-addressed objects so content updates don't require folder republishes, and per-file sharing becomes possible
**Verified:** 2026-02-17T02:15:00Z
**Status:** gaps_found
**Re-verification:** No -- initial verification

## Goal Achievement

### Observable Truths

| #   | Truth                                                                                                | Status   | Evidence                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| --- | ---------------------------------------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | File metadata lives in its own IPNS record derived via HKDF from privateKey + fileId                 | VERIFIED | `deriveFileIpnsKeypair` in `packages/crypto/src/file/derive-ipns.ts` (82 lines) uses HKDF-SHA256 with info `cipherbox-file-ipns-v1:{fileId}`. `encryptFileMetadata`/`decryptFileMetadata` in `metadata.ts` (159 lines) handles AES-256-GCM encryption with parent folderKey. `createFileMetadata` in `file-metadata.service.ts` (227 lines) wires derivation -> encryption -> IPFS upload -> IPNS record creation -> TEE enrollment. 376-line test file with 19 unit tests.                     |
| 2   | Folder metadata contains only FilePointer (name + fileMetaIpnsName) -- no embedded CIDs or file keys | VERIFIED | `FilePointer` type in `packages/crypto/src/file/types.ts` has only `type`, `id`, `name`, `fileMetaIpnsName`, `createdAt`, `modifiedAt` -- no `cid`, `fileKeyEncrypted`, `fileIv`. `FolderMetadataV2` in `folder/types.ts` uses `FolderChildV2 = FolderEntry \| FilePointer`. Validator in `folder/metadata.ts` accepts both v1 (cid) and v2 (fileMetaIpnsName). `addFileToFolder` in `folder.service.ts` creates FilePointer with only name + ipnsName.                                         |
| 3   | Content update publishes only the file IPNS record, not the parent folder                            | VERIFIED | `replaceFileInFolder` in `folder.service.ts` (lines 632-647) explicitly publishes ONLY the file IPNS record via `batchPublishIpnsRecords` -- code comment states "folder metadata untouched!" `handleUpdateFile` in `useFolder.ts` (lines 759-852) calls `updateFileMetadata` then `replaceFileInFolder`, never calls `updateFolderMetadata`.                                                                                                                                                   |
| 4   | File rename publishes only the folder IPNS record, not the file IPNS                                 | VERIFIED | `renameFile` in `folder.service.ts` (lines 851-880) only calls `updateFolderMetadata` with updated children array. No call to any file IPNS function. JSDoc comment: "File rename does NOT touch the file's own IPNS record -- only folder metadata."                                                                                                                                                                                                                                           |
| 5   | Batch operations publish all file IPNS records in a single API call                                  | VERIFIED | `addFilesToFolder` in `folder.service.ts` (lines 564-616) builds N file records + 1 folder record, calls `batchPublishIpnsRecords` once. `batchPublishIpnsRecords` in `ipns.service.ts` calls `ipnsControllerPublishBatch` (generated API client). Backend `publishBatch` in `ipns.service.ts` (lines 85-151) processes with `Promise.allSettled` in groups of 10. `BatchPublishIpnsDto` accepts up to 200 records with `@ArrayMaxSize(200)`.                                                   |
| 6   | TEE republisher handles per-file IPNS records with acceptable scalability                            | VERIFIED | `BATCH_SIZE` increased from 50 to 100 in `republish.service.ts` (line 11). `getDueEntries` take increased to 2000 (line 58). `unenrollIpns` method added (lines 305-314) for cleanup. `FolderIpns` entity has `recordType` column (line 74) with values 'folder' or 'file'. `upsertFolderIpns` accepts `recordType` parameter (line 244). File IPNS keys enrolled for TEE at upload time via `createFileMetadata`.                                                                              |
| 7   | Desktop FUSE client reads per-file IPNS metadata correctly                                           | FAILED   | Grep for `fileMetaIpnsName`, `FilePointer`, `per-file`, `v2` in `apps/desktop/` returns zero relevant hits. The Rust FUSE client has no awareness of v2 folder metadata, FilePointer types, or per-file IPNS resolution. CONTEXT.md explicitly states "Desktop FUSE client update deferred."                                                                                                                                                                                                    |
| 8   | Vault export includes per-file metadata in portable format                                           | VERIFIED | `recovery.html` (1231 lines) handles v2 FilePointer children (line 863): resolves `fileMetaIpnsName` via IPNS gateway, fetches encrypted metadata from IPFS, decrypts with parent folderKey, then downloads and decrypts file content. Inline HKDF + Ed25519 + base36 IPNS name derivation. Graceful IPNS failure tracking with per-file error reporting. `VAULT_EXPORT_FORMAT.md` (811 lines) documents v2 schema including FolderMetadataV2, FilePointer, FileMetadata, HKDF derivation spec. |

**Score:** 7/8 truths verified

### Required Artifacts

| Artifact                                           | Expected                                               | Status   | Details                                                                                    |
| -------------------------------------------------- | ------------------------------------------------------ | -------- | ------------------------------------------------------------------------------------------ |
| `packages/crypto/src/file/types.ts`                | FileMetadata, FilePointer, EncryptedFileMetadata types | VERIFIED | 63 lines, substantive types with full JSDoc, exported via barrel                           |
| `packages/crypto/src/file/derive-ipns.ts`          | HKDF file IPNS derivation                              | VERIFIED | 82 lines, real HKDF with domain separation, imported by file-metadata.service              |
| `packages/crypto/src/file/metadata.ts`             | encrypt/decrypt file metadata                          | VERIFIED | 159 lines, AES-256-GCM with runtime validator, no stubs                                    |
| `packages/crypto/src/file/index.ts`                | Barrel exports                                         | VERIFIED | 15 lines, exports all types and functions                                                  |
| `packages/crypto/src/folder/types.ts`              | v2 folder types                                        | VERIFIED | 105 lines, FolderMetadataV2, FolderChildV2, AnyFolderMetadata defined                      |
| `packages/crypto/src/folder/metadata.ts`           | v1/v2 validator, isV2Metadata                          | VERIFIED | 142 lines, validator accepts both v1 (cid) and v2 (fileMetaIpnsName)                       |
| `packages/crypto/src/index.ts`                     | Barrel exports for file module + v2 types              | VERIFIED | Lines 98-107 export file module, lines 86-96 export v2 folder types                        |
| `apps/api/src/ipns/dto/publish.dto.ts`             | Batch publish DTOs                                     | VERIFIED | 223 lines, PublishIpnsEntryDto with recordType, BatchPublishIpnsDto with ArrayMaxSize(200) |
| `apps/api/src/ipns/ipns.controller.ts`             | POST /ipns/publish-batch                               | VERIFIED | 163 lines, endpoint with rate limit 5/min, Swagger docs                                    |
| `apps/api/src/ipns/ipns.service.ts`                | publishBatch with concurrency                          | VERIFIED | 536 lines, Promise.allSettled in groups of 10, partial success pattern                     |
| `apps/api/src/ipns/entities/folder-ipns.entity.ts` | recordType column                                      | VERIFIED | 83 lines, recordType varchar(10) default 'folder'                                          |
| `apps/api/src/republish/republish.service.ts`      | Scaled capacity + unenrollIpns                         | VERIFIED | BATCH_SIZE=100, take=2000, unenrollIpns method with delete                                 |
| `apps/web/src/services/file-metadata.service.ts`   | create/resolve/update file metadata                    | VERIFIED | 227 lines, full implementation with TEE enrollment, no stubs                               |
| `apps/web/src/services/folder.service.ts`          | v2 folder operations                                   | VERIFIED | 910 lines, FilePointer-based operations, batch publish, replaceFileInFolder                |
| `apps/web/src/services/download.service.ts`        | downloadFileFromIpns                                   | VERIFIED | 124 lines, IPNS resolve -> fetch -> decrypt, no stubs                                      |
| `apps/web/src/services/ipns.service.ts`            | batchPublishIpnsRecords                                | VERIFIED | 179 lines, wraps generated API client ipnsControllerPublishBatch                           |
| `apps/web/src/hooks/useFolder.ts`                  | v2 addFile/addFiles/updateFile                         | VERIFIED | 881 lines, full v2 implementation with createFileMetadata, batch publish                   |
| `apps/web/src/hooks/useFileDownload.ts`            | downloadFromIpns                                       | VERIFIED | 117 lines, IPNS-based download with progress tracking                                      |
| `apps/web/src/hooks/useFilePreview.ts`             | IPNS-based preview                                     | VERIFIED | 108 lines, resolves fileMetaIpnsName, uses folderKey                                       |
| `apps/web/src/stores/folder.store.ts`              | FolderNode with FolderChildV2[]                        | VERIFIED | Line 2 imports FolderChildV2, line 18 uses it for children type                            |
| `apps/web/public/recovery.html`                    | v2-aware recovery                                      | VERIFIED | 1231 lines, inline HKDF/Ed25519/base36, graceful IPNS failure handling                     |
| `docs/VAULT_EXPORT_FORMAT.md`                      | v2 schema docs                                         | VERIFIED | 811 lines, documents FolderMetadataV2, FilePointer, FileMetadata, HKDF                     |
| `packages/crypto/src/__tests__/file-ipns.test.ts`  | Unit tests                                             | VERIFIED | 376 lines, 19 tests for derivation, encryption, v2 validation                              |
| `apps/web/src/api/ipns/ipns.ts`                    | Generated batch publish client                         | VERIFIED | ipnsControllerPublishBatch function present, typed DTO models generated                    |

### Key Link Verification

| From                     | To                       | Via                                                                | Status | Details                                                                       |
| ------------------------ | ------------------------ | ------------------------------------------------------------------ | ------ | ----------------------------------------------------------------------------- |
| file-metadata.service.ts | @cipherbox/crypto        | import deriveFileIpnsKeypair, encryptFileMetadata, etc.            | WIRED  | Line 10-20, all crypto functions imported and used                            |
| folder.service.ts        | ipns.service.ts          | import batchPublishIpnsRecords                                     | WIRED  | Line 31, used in addFileToFolder, addFilesToFolder, replaceFileInFolder       |
| folder.service.ts        | file-metadata.service.ts | import FileIpnsRecordPayload type                                  | WIRED  | Line 34, type used in addFileToFolder, replaceFileInFolder signatures         |
| useFolder.ts             | file-metadata.service.ts | import createFileMetadata, resolveFileMetadata, updateFileMetadata | WIRED  | Lines 9-12, used in handleAddFile, handleAddFiles, handleUpdateFile           |
| useFolder.ts             | folder.service.ts        | import addFileToFolder, addFilesToFolder, replaceFileInFolder      | WIRED  | Line 7, all v2 operations called                                              |
| FileBrowser.tsx          | useFileDownload          | downloadFromIpns                                                   | WIRED  | Line 237 destructures, lines 582-584 call with fileMetaIpnsName + folderKey   |
| useFilePreview.ts        | download.service.ts      | downloadFileFromIpns                                               | WIRED  | Line 4 imports, line 71 calls with fileMetaIpnsName + folderKey               |
| ImagePreviewDialog       | folderKey prop           | props -> useFilePreview                                            | WIRED  | Line 14 defines prop, line 83 passes to downloadFileFromIpns                  |
| replaceFileInFolder      | batchPublishIpnsRecords  | direct call, file only                                             | WIRED  | Line 646, publishes only file IPNS record, zero folder metadata calls         |
| recovery.html            | IPNS resolve + decrypt   | inline HKDF + base36                                               | WIRED  | Lines 545-594 derive IPNS name, lines 863-917 resolve + decrypt file metadata |
| ipns.service.ts (web)    | API client               | ipnsControllerPublishBatch                                         | WIRED  | Line 93 calls generated client function                                       |
| ipns.controller.ts       | ipns.service.ts          | publishBatch                                                       | WIRED  | Line 103 calls this.ipnsService.publishBatch                                  |

### Requirements Coverage

| Requirement                                 | Status    | Blocking Issue                                                      |
| ------------------------------------------- | --------- | ------------------------------------------------------------------- |
| Foundation for SHARE-01 (per-file sharing)  | SATISFIED | FilePointer with fileMetaIpnsName enables individual file sharing   |
| Foundation for VER-01 (version history)     | SATISFIED | FileMetadata schema is extensible for future versionHistory field   |
| Performance improvement for content updates | SATISFIED | replaceFileInFolder publishes only file IPNS, skips folder entirely |

### Anti-Patterns Found

| File              | Line | Pattern                                                | Severity | Impact                                                                    |
| ----------------- | ---- | ------------------------------------------------------ | -------- | ------------------------------------------------------------------------- |
| folder.service.ts | 436  | TODO: Phase 14 should add batch unenrollment           | Info     | Deferred cleanup, not a blocker -- TEE enrollments expire naturally (24h) |
| folder.service.ts | 484  | TODO: Phase 14 should expose unenrollIpns via REST API | Info     | Deferred cleanup, documented decision in CONTEXT.md                       |

### Human Verification Required

### 1. Full Upload-Download Round Trip (v2 flow)

**Test:** Upload a file via web app, verify it appears in folder listing, then download it.
**Expected:** File uploads successfully, folder shows file name, download returns identical content. Network tab should show batch publish call with both file and folder IPNS records.
**Why human:** Requires running app with IPFS/IPNS infrastructure, cannot verify end-to-end data flow via static analysis.

### 2. Content Update Skips Folder Publish

**Test:** Upload a file, then re-upload (replace content). Monitor network tab.
**Expected:** Re-upload publishes only 1 IPNS record (file), not 2 (file + folder). Folder sequence number should not change.
**Why human:** Requires runtime observation of actual API calls and IPNS publishing behavior.

### 3. File Rename Skips File IPNS

**Test:** Rename an uploaded file. Monitor network tab.
**Expected:** Rename publishes only folder IPNS record. File's IPNS record is untouched.
**Why human:** Requires runtime observation of actual API calls.

### Gaps Summary

One of eight success criteria is not met. The desktop FUSE client (Truth #7) has zero awareness of v2 per-file IPNS metadata. This was explicitly documented as deferred in CONTEXT.md: "Desktop FUSE client update deferred -- web app gets v2 first; desktop catches up in a later phase or quick task."

The remaining 7/8 criteria are fully verified with substantive, wired implementations across all layers (crypto primitives, API backend, frontend services, hooks, components, recovery tool, documentation). The implementation is thorough with 19 unit tests, generated API client types, folderKey threading through all preview dialogs, and inline HKDF/Ed25519/base36 in the standalone recovery tool.

The two TODO comments in folder.service.ts are intentionally deferred to Phase 14 (per-file sharing) and are not blockers -- orphaned TEE enrollments expire naturally via the 24-hour IPNS record lifetime.

---

_Verified: 2026-02-17T02:15:00Z_
_Verifier: Claude (gsd-verifier)_
