---
phase: 12.6-per-file-ipns-metadata-split
plan: 04
subsystem: ui
tags: [react, hooks, FilePointer, IPNS, download, preview, file-browser]

# Dependency graph
requires:
  - phase: 12.6-per-file-ipns-metadata-split (plan 03)
    provides: v2 service layer with FilePointer-based API signatures
provides:
  - All hooks and components updated for v2 FilePointer/FolderChildV2 types
  - IPNS-based file download/preview across all dialog components
  - Full web app compiles and builds clean with zero type errors
affects: [12.6-05 (final integration/cleanup)]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'folderKey prop threading: parent folder key passed through to preview/edit dialogs for metadata decryption'
    - 'downloadFromIpns pattern: IPNS name + folderKey replaces direct CID/key/IV access in all download flows'
    - "isFilePointer type guard: item.type === 'file' check replaces isFileEntry for v2 FolderChildV2 union"

key-files:
  created: []
  modified:
    - apps/web/src/hooks/useFolder.ts
    - apps/web/src/hooks/useFilePreview.ts
    - apps/web/src/hooks/useFileDownload.ts
    - apps/web/src/hooks/useDropUpload.ts
    - apps/web/src/hooks/useContextMenu.ts
    - apps/web/src/components/file-browser/FileBrowser.tsx
    - apps/web/src/components/file-browser/TextEditorDialog.tsx
    - apps/web/src/components/file-browser/ImagePreviewDialog.tsx
    - apps/web/src/components/file-browser/DetailsDialog.tsx
    - apps/web/src/components/file-browser/PdfPreviewDialog.tsx
    - apps/web/src/components/file-browser/AudioPlayerDialog.tsx
    - apps/web/src/components/file-browser/VideoPlayerDialog.tsx
    - apps/web/src/components/file-browser/FileList.tsx
    - apps/web/src/components/file-browser/MoveDialog.tsx
    - apps/web/src/components/file-browser/ContextMenu.tsx
    - apps/web/src/components/file-browser/FileListItem.tsx
    - apps/web/src/components/file-browser/SelectionActionBar.tsx

key-decisions:
  - 'DetailsDialog parentFolderId prop removed: no longer needed since IPNS resolution uses item.fileMetaIpnsName/ipnsName directly'
  - 'FileBrowser removes v1 download destructure: only downloadFromIpns used in v2 flow'

patterns-established:
  - 'folderKey threading: all preview/edit dialogs receive folderKey from FileBrowser via currentFolder.folderKey'
  - 'IPNS-based download: downloadFromIpns({ fileMetaIpnsName, folderKey, fileName }) replaces direct CID download'

# Metrics
duration: 3min
completed: 2026-02-17
---

# Phase 12.6 Plan 04: Hooks & Components Update Summary

All hooks and file browser components updated from v1 FileEntry to v2 FilePointer/IPNS-based operations with zero type errors.

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-17T00:38:25Z
- **Completed:** 2026-02-17T00:41:34Z
- **Tasks:** 2
- **Files modified:** 17

## Accomplishments

- useFolder hook creates per-file IPNS metadata before registering files, resolves file IPNS for updates, skips folder publish on content updates
- All preview dialogs (image, PDF, audio, video) and text editor receive folderKey prop and use IPNS-based download
- DetailsDialog shows fileMetaIpnsName for files instead of embedded CID/key/IV
- Fixed FolderChildV2V2 import typo in FileList, MoveDialog, and useContextMenu
- Full web app compiles and builds clean (zero type errors, zero build errors)

## Task Commits

Each task was committed atomically:

1. **Task 1: Update useFolder hook for v2 service API** - `b7f4d34` (feat)
2. **Task 2: Update preview hooks + file browser components for v2** - `318edb2` (feat)

## Files Created/Modified

- `apps/web/src/hooks/useFolder.ts` - v2 folder operations with FilePointer, createFileMetadata, resolveFileMetadata
- `apps/web/src/hooks/useFilePreview.ts` - IPNS-based preview with folderKey param
- `apps/web/src/hooks/useFileDownload.ts` - Added downloadFromIpns function for v2 flow
- `apps/web/src/hooks/useDropUpload.ts` - Passes mimeType for file metadata creation
- `apps/web/src/hooks/useContextMenu.ts` - Fixed FolderChildV2V2 -> FolderChildV2
- `apps/web/src/components/file-browser/FileBrowser.tsx` - FilePointer type guard, IPNS download, folderKey threading to dialogs
- `apps/web/src/components/file-browser/TextEditorDialog.tsx` - IPNS-based load, folderKey prop
- `apps/web/src/components/file-browser/ImagePreviewDialog.tsx` - IPNS-based download, folderKey prop
- `apps/web/src/components/file-browser/DetailsDialog.tsx` - Shows fileMetaIpnsName, removed parentFolderId prop
- `apps/web/src/components/file-browser/PdfPreviewDialog.tsx` - folderKey prop for useFilePreview
- `apps/web/src/components/file-browser/AudioPlayerDialog.tsx` - folderKey prop for useFilePreview
- `apps/web/src/components/file-browser/VideoPlayerDialog.tsx` - folderKey prop for useFilePreview
- `apps/web/src/components/file-browser/FileList.tsx` - Fixed FolderChildV2V2 -> FolderChildV2
- `apps/web/src/components/file-browser/MoveDialog.tsx` - Fixed FolderChildV2V2 -> FolderChildV2
- `apps/web/src/components/file-browser/ContextMenu.tsx` - FolderChildV2 type usage
- `apps/web/src/components/file-browser/FileListItem.tsx` - FolderChildV2 type usage
- `apps/web/src/components/file-browser/SelectionActionBar.tsx` - FolderChildV2 type usage

## Decisions Made

- DetailsDialog parentFolderId prop removed: IPNS resolution now uses item's own IPNS name directly (fileMetaIpnsName for files, ipnsName for folders), eliminating the need to look up the parent folder
- FileBrowser removes v1 `download` destructure from useFileDownload: only `downloadFromIpns` is used in v2 flow

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed FolderChildV2V2 import typo in 3 files**

- **Found during:** Task 2
- **Issue:** Plan 03 renamed FolderChild -> FolderChildV2 but introduced a FolderChildV2V2 typo in FileList.tsx, MoveDialog.tsx, and useContextMenu.ts (double V2 suffix)
- **Fix:** Changed import from `FolderChildV2V2` to `FolderChildV2` in all 3 files
- **Files modified:** FileList.tsx, MoveDialog.tsx, useContextMenu.ts
- **Verification:** `tsc --noEmit` passes
- **Committed in:** 318edb2 (Task 2 commit)

**2. [Rule 1 - Bug] Removed unused parentFolderId prop from DetailsDialog**

- **Found during:** Task 2
- **Issue:** After updating DetailsDialog to resolve IPNS directly from item (fileMetaIpnsName/ipnsName), the parentFolderId prop and parentFolder store lookup became unused, causing TS6133 error
- **Fix:** Removed parentFolderId from props type, function signature, and caller in FileBrowser.tsx
- **Files modified:** DetailsDialog.tsx, FileBrowser.tsx
- **Verification:** `tsc --noEmit` passes
- **Committed in:** 318edb2 (Task 2 commit)

---

**Total deviations:** 2 auto-fixed (2 bugs from Plan 03 residual)
**Impact on plan:** Both auto-fixes necessary for clean compilation. No scope creep.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- All hooks and components compile with v2 types
- Full web app builds clean
- Ready for Plan 05 (final integration testing / E2E verification)

---

_Phase: 12.6-per-file-ipns-metadata-split_
_Completed: 2026-02-17_
