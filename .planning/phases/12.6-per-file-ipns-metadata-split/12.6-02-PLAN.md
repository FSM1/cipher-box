---
phase: 12.6-per-file-ipns-metadata-split
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/ipns/entities/folder-ipns.entity.ts
  - apps/api/src/ipns/dto/publish.dto.ts
  - apps/api/src/ipns/dto/index.ts
  - apps/api/src/ipns/ipns.controller.ts
  - apps/api/src/ipns/ipns.service.ts
  - apps/api/src/ipns/ipns.module.ts
  - apps/api/src/republish/republish.service.ts
autonomous: true

must_haves:
  truths:
    - 'Batch publish endpoint accepts array of IPNS records (folder + file) in single request'
    - "FolderIpns entity has record_type column distinguishing 'folder' vs 'file'"
    - 'RepublishService enrolls file IPNS records for TEE republishing at publish time'
    - 'TEE republish handles file records alongside folder records with priority ordering'
  artifacts:
    - path: 'apps/api/src/ipns/dto/publish.dto.ts'
      provides: 'BatchPublishIpnsDto, PublishIpnsEntryDto DTOs'
      contains: 'BatchPublishIpnsDto'
    - path: 'apps/api/src/ipns/ipns.controller.ts'
      provides: 'POST /ipns/publish-batch endpoint'
      contains: 'publishBatch'
    - path: 'apps/api/src/ipns/ipns.service.ts'
      provides: 'publishBatch method for array of records'
      contains: 'publishBatch'
    - path: 'apps/api/src/ipns/entities/folder-ipns.entity.ts'
      provides: 'record_type column on FolderIpns entity'
      contains: 'record_type'
    - path: 'apps/api/src/republish/republish.service.ts'
      provides: 'unenrollIpns method + increased capacity limits'
      contains: 'unenrollIpns'
  key_links:
    - from: 'apps/api/src/ipns/ipns.controller.ts'
      to: 'apps/api/src/ipns/ipns.service.ts'
      via: 'publishBatch method call'
      pattern: "ipnsService\\.publishBatch"
    - from: 'apps/api/src/ipns/ipns.service.ts'
      to: 'apps/api/src/republish/republish.service.ts'
      via: 'enrollFolder call for each record with encryptedIpnsPrivateKey'
      pattern: "republishService\\.enrollFolder"
---

<objective>
Add backend support for batch IPNS publishing (multiple records in one API call), add record_type tracking to the FolderIpns entity, and update the republish service for per-file IPNS scalability.

Purpose: Backend infrastructure that the frontend will call for all file operations. The batch publish endpoint is the single API call that handles multi-file uploads atomically. The republish service changes ensure TEE can handle the increased IPNS record count.
Output: New batch publish endpoint, updated entity schema, updated republish service, regenerated API client.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.6-per-file-ipns-metadata-split/12.6-RESEARCH.md

# Key source files to reference

@apps/api/src/ipns/entities/folder-ipns.entity.ts
@apps/api/src/ipns/dto/publish.dto.ts
@apps/api/src/ipns/ipns.controller.ts
@apps/api/src/ipns/ipns.service.ts
@apps/api/src/ipns/ipns.module.ts
@apps/api/src/republish/republish.service.ts
@apps/api/src/republish/republish-schedule.entity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Entity update + batch publish DTO + controller endpoint</name>
  <files>
    apps/api/src/ipns/entities/folder-ipns.entity.ts
    apps/api/src/ipns/dto/publish.dto.ts
    apps/api/src/ipns/dto/index.ts
    apps/api/src/ipns/ipns.controller.ts
  </files>
  <action>
**folder-ipns.entity.ts** -- Add record_type column:
- Add column: `@Column({ type: 'varchar', length: 10, name: 'record_type', default: 'folder' }) recordType!: 'folder' | 'file';`
- Place it after the `isRoot` column. Default 'folder' ensures backward compatibility with existing rows.
- No migration needed (clean break, DB will be wiped per CONTEXT.md).

**publish.dto.ts** -- Add batch publish DTOs:

- Keep existing `PublishIpnsDto` and `PublishIpnsResponseDto` unchanged (the single-record endpoint still works).
- Add `PublishIpnsEntryDto` class with ALL the same fields as `PublishIpnsDto` PLUS:
  - `@IsString() @IsOptional() recordType?: 'folder' | 'file';` -- optional, defaults to 'folder' in service.
  - Use `@IsIn(['folder', 'file'])` validator for recordType.
- Add `BatchPublishIpnsDto` class:
  - `@IsArray() @ValidateNested({ each: true }) @Type(() => PublishIpnsEntryDto) @ArrayMaxSize(200) records!: PublishIpnsEntryDto[];`
  - Import `IsArray, ArrayMaxSize, ValidateNested` from class-validator, `Type` from class-transformer.
- Add `BatchPublishIpnsResponseDto` class:
  - `results: PublishIpnsResponseDto[]` -- per-record results
  - `totalSucceeded: number`
  - `totalFailed: number`
  - Add @ApiProperty decorators for Swagger.

**dto/index.ts** -- Add new DTO exports:

- Export `PublishIpnsEntryDto`, `BatchPublishIpnsDto`, `BatchPublishIpnsResponseDto`.

**ipns.controller.ts** -- Add batch publish endpoint:

- Add `POST /ipns/publish-batch` endpoint:
  - Rate limit: `@Throttle({ default: { limit: 5, ttl: 60000 } })` -- 5 batch publishes per minute (each batch can have up to 200 records).
  - Method: `async publishBatch(@Request() req: RequestWithUser, @Body() dto: BatchPublishIpnsDto): Promise<BatchPublishIpnsResponseDto>`
  - Calls `this.ipnsService.publishBatch(req.user.id, dto)`.
  - Add full Swagger decorators (@ApiOperation, @ApiResponse for 200, 400, 401, 502).
- Keep existing `POST /ipns/publish` endpoint unchanged for backward compatibility.
  </action>
  <verify>
  Run `cd /Users/michael/Code/cipher-box && pnpm --filter api build` -- must compile without errors.
  Verify new endpoint exists: `grep "publish-batch" apps/api/src/ipns/ipns.controller.ts`.
  Verify DTO: `grep "BatchPublishIpnsDto" apps/api/src/ipns/dto/publish.dto.ts`.
  Verify entity: `grep "record_type" apps/api/src/ipns/entities/folder-ipns.entity.ts`.
  </verify>
  <done>
  FolderIpns entity has record_type column (default 'folder'). BatchPublishIpnsDto validates array of up to 200 IPNS record entries. POST /ipns/publish-batch endpoint added with rate limiting. Single-record endpoint preserved for backward compatibility.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Batch publish service + republish scalability + API client regen</name>
  <files>
    apps/api/src/ipns/ipns.service.ts
    apps/api/src/republish/republish.service.ts
  </files>
  <action>
**ipns.service.ts** -- Add publishBatch method:
- Add `async publishBatch(userId: string, dto: BatchPublishIpnsDto): Promise<BatchPublishIpnsResponseDto>`:
  - Process records with concurrency limit of 10 (use Promise.allSettled in batches of 10).
  - For each record in the batch:
    1. Validate base64 record (same as existing publishRecord).
    2. Publish to delegated routing (reuse existing `publishToDelegatedRouting`).
    3. Upsert FolderIpns entry (reuse existing `upsertFolderIpns` but pass `recordType`).
    4. If encryptedIpnsPrivateKey provided, auto-enroll for TEE republishing.
  - Collect results: on success, add to results array. On failure, log warning and continue (partial success is OK per CONTEXT.md).
  - Return `{ results, totalSucceeded, totalFailed }`.
- Update `upsertFolderIpns` to accept optional `recordType: 'folder' | 'file'` parameter (default 'folder') and set it on the entity.
- The existing `publishRecord` method stays unchanged. It continues to use `upsertFolderIpns` with default 'folder' recordType.

**republish.service.ts** -- Scale for per-file IPNS:

- Increase `BATCH_SIZE` from 50 to 100 (file records are smaller payloads than folder records).
- Increase `getDueEntries` `take:` from 500 to 2000 to handle vaults with many file records.
- Add `async unenrollIpns(userId: string, ipnsName: string): Promise<void>`:
  - Delete the `IpnsRepublishSchedule` entry for this user + ipnsName.
  - Log the unenrollment.
  - Used when files are deleted to prevent orphaned TEE enrollments (Pitfall 5 from research).
- Update `syncFolderIpnsSequence` to work with the new `recordType` field -- no functional change needed since it just updates by userId + ipnsName, but rename internal method comment to reflect it handles both folder and file IPNS records.
- Add soft capacity warning: In `processRepublishBatch`, after fetching due entries, if `dueEntries.length > 1000`, log a warning: `'User vault has ${dueEntries.length} IPNS records - approaching capacity limits'`. (The warning is informational; no hard limit enforcement needed for v1.)

After both files are updated, run `pnpm api:generate` to regenerate the API client for the web app. This generates the typed client that the frontend will use to call the new batch publish endpoint. Commit the regenerated client files alongside the API changes.
</action>
<verify>
Run `cd /Users/michael/Code/cipher-box && pnpm --filter api build` -- must compile without errors.
Run `cd /Users/michael/Code/cipher-box && pnpm api:generate` -- generates without errors.
Verify batch method: `grep "publishBatch" apps/api/src/ipns/ipns.service.ts`.
Verify unenroll: `grep "unenrollIpns" apps/api/src/republish/republish.service.ts`.
Verify generated client has batch endpoint: `grep -r "publishBatch\|publish-batch" apps/web/src/api/`.
</verify>
<done>
IpnsService.publishBatch processes up to 200 IPNS records with concurrency=10, upserts each with recordType, auto-enrolls for TEE republishing. RepublishService scaled: BATCH_SIZE=100, getDueEntries take=2000, unenrollIpns method added. API client regenerated with batch publish endpoint types.
</done>
</task>

</tasks>

<verification>
- `pnpm --filter api build` succeeds
- `pnpm api:generate` succeeds and generates batch endpoint client
- `grep "publishBatch" apps/api/src/ipns/ipns.controller.ts` shows endpoint
- `grep "record_type" apps/api/src/ipns/entities/folder-ipns.entity.ts` shows column
- `grep "unenrollIpns" apps/api/src/republish/republish.service.ts` shows method
- `grep "BATCH_SIZE = 100" apps/api/src/republish/republish.service.ts` shows increased size
</verification>

<success_criteria>

- POST /ipns/publish-batch endpoint accepts BatchPublishIpnsDto with up to 200 records
- Each record is published to delegated routing with concurrency limit of 10
- FolderIpns entity tracks recordType ('folder' or 'file') for each IPNS entry
- RepublishService can unenroll file IPNS records on deletion
- TEE republish handles larger batches (100 per TEE request, 2000 max per cycle)
- API client regenerated with batch publish types available for frontend
  </success_criteria>

<output>
After completion, create `.planning/phases/12.6-per-file-ipns-metadata-split/12.6-02-SUMMARY.md`
</output>
