---
phase: 12.6-per-file-ipns-metadata-split
plan: 05
subsystem: crypto
tags: [recovery, ipns, hkdf, ed25519, base36, vault-export, documentation]

# Dependency graph
requires:
  - phase: 12.6-per-file-ipns-metadata-split (plan 01)
    provides: deriveFileIpnsKeypair, FilePointer/FileMetadata types
  - phase: 12.6-per-file-ipns-metadata-split (plan 04)
    provides: v2 hooks and components with FilePointer/IPNS-based operations
provides:
  - v2-aware standalone vault recovery tool with per-file IPNS resolution
  - Updated VAULT_EXPORT_FORMAT.md with v2 schema, FileMetadata, HKDF derivation docs
  - Full monorepo build/lint/test verification
affects: [Phase 12.1 (AES-CTR streaming)]

# Tech tracking
tech-stack:
  added:
    - '@noble/ed25519@2 (CDN import in recovery.html)'
  patterns:
    - 'Inline IPNS name derivation: protobuf Ed25519 key encoding + base36 CIDv1 without libp2p dependencies'
    - 'BigInt-based base36 encoding for multibase k-prefix IPNS names'
    - 'Graceful IPNS failure handling: warn and continue, report at end'

key-files:
  created: []
  modified:
    - apps/web/public/recovery.html
    - docs/VAULT_EXPORT_FORMAT.md

key-decisions:
  - 'Inline base36 + protobuf for IPNS name in recovery.html (no libp2p CDN dependency needed)'
  - 'IPNS resolution failures do not block recovery of other files (graceful degradation)'
  - 'v1 backward compatibility preserved in recovery tool at zero cost'

patterns-established:
  - 'Standalone IPNS name derivation: CIDv1(0x01) + libp2p-key(0x72) + identity-multihash(0x00,0x24) + protobuf(0x08,0x01,0x12,0x20) + 32-byte Ed25519 pubkey -> base36 with k prefix'
  - 'Per-file IPNS failure reporting: collect failures, summarize at end with IPNS names for manual recovery'

# Metrics
duration: 10min
completed: 2026-02-17
---

# Phase 12.6 Plan 05: Recovery Tool v2 + Docs + Build Verification Summary

Standalone recovery tool updated for v2 per-file IPNS metadata with inline HKDF/Ed25519/base36 derivation; VAULT_EXPORT_FORMAT.md expanded with v2 schema, FileMetadata, and HKDF specs; full monorepo build/lint/test clean.

## Performance

- **Duration:** 10 min
- **Started:** 2026-02-17T00:46:49Z
- **Completed:** 2026-02-17T00:56:18Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Recovery tool handles v2 folder metadata: detects FilePointer children, derives file IPNS keypair via Web Crypto HKDF + @noble/ed25519, resolves file IPNS to get metadata CID, decrypts file metadata with parent folderKey
- Inline IPNS name derivation (protobuf Ed25519 key encoding + BigInt base36 encoding) eliminates libp2p CDN dependency
- Graceful degradation on IPNS resolution failures: warns but continues recovery, reports all failures with IPNS names at completion
- VAULT_EXPORT_FORMAT.md fully documents v2 schema (FolderMetadataV2, FilePointer, FileMetadata, HKDF derivation, updated recovery procedure)
- Full monorepo builds (crypto, API, web), lints (0 errors), and tests (188 pass) clean

## Task Commits

Each task was committed atomically:

1. **Task 1: Update recovery tool for v2 folder metadata** - `2a13d68` (feat)
2. **Task 2: Update vault export docs + full build verification** - `291b433` (docs)

## Files Created/Modified

- `apps/web/public/recovery.html` - v2 FilePointer processing, HKDF file IPNS derivation, inline Ed25519-to-IPNS-name, base36 encoding, file metadata decryption, IPNS failure tracking
- `docs/VAULT_EXPORT_FORMAT.md` - v2 folder metadata schema, FilePointer type, FileMetadata schema, HKDF derivation spec, updated recovery pseudocode, v2 compatibility notes

## Decisions Made

- Inline base36 + protobuf encoding for IPNS name derivation in recovery.html -- avoids CDN dependency on libp2p packages, self-contained implementation using BigInt arithmetic
- IPNS resolution failures are non-blocking -- recovery continues for other files, failures collected and reported at the end with IPNS names for manual CID lookup
- v1 backward compatibility preserved in recovery tool -- both v1 (inline file data) and v2 (FilePointer) paths coexist, gated by `metadata.version`

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- Desktop DMG bundling fails in `pnpm build` (pre-existing Tauri bundling issue with `bundle_dmg.sh`), but the actual Rust binary compiles successfully. Verified crypto/API/web builds individually, all clean.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Phase 12.6 (Per-File IPNS Metadata Split) is fully complete across all 5 plans
- All crypto primitives, backend batch publish, frontend service layer, hooks/components, recovery tool, and documentation are done
- Ready for Phase 12.1 (AES-256-CTR Streaming Encryption) or next milestone phase
- DB wipe can proceed safely -- v2 schema is the only path, no migration needed

---

_Phase: 12.6-per-file-ipns-metadata-split_
_Completed: 2026-02-17_
