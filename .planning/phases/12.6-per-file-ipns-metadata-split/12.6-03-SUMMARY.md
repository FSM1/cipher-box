---
phase: 12.6-per-file-ipns-metadata-split
plan: 03
subsystem: ui
tags: [ipns, file-metadata, batch-publish, folder-v2, download, service-layer]

# Dependency graph
requires:
  - phase: 12.6-per-file-ipns-metadata-split-01
    provides: deriveFileIpnsKeypair, encryptFileMetadata, decryptFileMetadata, FilePointer, FolderMetadataV2, FolderChildV2 types
  - phase: 12.6-per-file-ipns-metadata-split-02
    provides: POST /ipns/publish-batch endpoint, generated API client with batch publish types
provides:
  - file-metadata.service.ts with create/resolve/update for per-file IPNS metadata
  - batchPublishIpnsRecords function wrapping publish-batch API endpoint
  - v2 folder.service.ts using FilePointer instead of FileEntry, batch IPNS publish
  - downloadFileFromIpns convenience function for IPNS-based file download
  - FolderNode store type using FolderChildV2
affects: [12.6-per-file-ipns-metadata-split-04, 12.6-per-file-ipns-metadata-split-05]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'Per-file IPNS content update: publish only file IPNS record, folder untouched'
    - 'Batch IPNS publish: N file records + 1 folder record in single API call'
    - 'Lazy file metadata resolution: resolve per-file IPNS on download/preview, not on folder load'

key-files:
  created:
    - apps/web/src/services/file-metadata.service.ts
  modified:
    - apps/web/src/services/folder.service.ts
    - apps/web/src/services/download.service.ts
    - apps/web/src/services/delete.service.ts
    - apps/web/src/services/ipns.service.ts
    - apps/web/src/services/index.ts
    - apps/web/src/stores/folder.store.ts

key-decisions:
  - 'Orphaned TEE enrollment on file delete: left to expire, Phase 14 adds explicit unenrollment'
  - 'deleteFolder returns fileMetaIpnsName list instead of CIDs for v2 cleanup'
  - 'deleteFileFromFolder returns fileMetaIpnsName for caller-driven CID resolution and unpinning'
  - 'replaceFileInFolder signature takes fileIpnsRecord payload, publishes only file IPNS (no folder update)'

patterns-established:
  - 'FileIpnsRecordPayload type for passing IPNS record data between services'
  - 'buildFolderIpnsRecord helper: creates folder IPNS record for batch publish without immediate publishing'
  - 'downloadFileFromIpns: two-step resolve-then-fetch pattern for v2 file download'

# Metrics
duration: 7min
completed: 2026-02-17
---

# Phase 12.6 Plan 03: Frontend Service Layer Integration Summary

<!-- markdownlint-disable MD036 -->

**Per-file IPNS service layer: file-metadata.service with create/resolve/update, v2 folder.service with FilePointer children and batch publish, downloadFileFromIpns for IPNS-based download**

<!-- markdownlint-enable MD036 -->

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-17T00:16:53Z
- **Completed:** 2026-02-17T00:23:32Z
- **Tasks:** 2
- **Files modified:** 7 (1 created, 6 modified)

## Accomplishments

- Created `file-metadata.service.ts` with createFileMetadata (IPNS keypair derivation + encryption + TEE enrollment), resolveFileMetadata (IPNS resolve + decrypt), and updateFileMetadata (merge + re-encrypt + re-publish)
- Fully rewrote `folder.service.ts` for v2 metadata: all file operations use FilePointer instead of FileEntry, batch IPNS publish for uploads, content update publishes only file IPNS (folder untouched)
- Added `batchPublishIpnsRecords` to ipns.service.ts wrapping the generated publish-batch API client
- Added `downloadFileFromIpns` convenience function that resolves per-file IPNS then downloads+decrypts
- Updated FolderNode store type to use FolderChildV2 throughout

## Task Commits

Each task was committed atomically:

1. **Task 1: File metadata service + batch IPNS publish + store types** - `353477d02` (feat)
2. **Task 2: Rewrite folder/download/delete services for v2** - `bc4bef7ca` (feat)

## Files Created/Modified

- `apps/web/src/services/file-metadata.service.ts` - New service: create/resolve/update per-file IPNS metadata records
- `apps/web/src/services/folder.service.ts` - Full v2 rewrite: FilePointer children, batch IPNS publish, content update skips folder
- `apps/web/src/services/download.service.ts` - Added downloadFileFromIpns for IPNS-based file download
- `apps/web/src/services/delete.service.ts` - Updated docs for v2 flow, added TODO for Phase 14 TEE unenrollment
- `apps/web/src/services/ipns.service.ts` - Added batchPublishIpnsRecords wrapping publish-batch endpoint
- `apps/web/src/services/index.ts` - Added file-metadata.service barrel export
- `apps/web/src/stores/folder.store.ts` - FolderNode children type changed from FolderChild[] to FolderChildV2[]

## Decisions Made

- Orphaned TEE enrollment on file delete: left to expire naturally (24h IPNS lifetime). Phase 14 should expose unenrollIpns via REST API for explicit cleanup.
- deleteFolder returns fileMetaIpnsName list (not CIDs) for v2 -- caller must resolve IPNS to get CIDs for unpinning.
- deleteFileFromFolder returns fileMetaIpnsName so caller can handle CID resolution and unpinning.
- replaceFileInFolder takes a pre-built fileIpnsRecord payload and publishes ONLY the file IPNS record (folder metadata completely untouched).

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Service layer complete for v2 metadata flow
- Hooks and components (Plan 04) will adapt to new service API signatures (20 type errors in useFolder.ts and FileBrowser.tsx expected)
- Key signature changes for Plan 04: addFileToFolder now takes fileId+fileIpnsRecord instead of cid/key/iv; addFilesToFolder takes fileId+name+fileIpnsRecord per file; replaceFileInFolder takes fileIpnsRecord and returns void; deleteFileFromFolder returns fileMetaIpnsName

---

_Phase: 12.6-per-file-ipns-metadata-split_
_Completed: 2026-02-17_
