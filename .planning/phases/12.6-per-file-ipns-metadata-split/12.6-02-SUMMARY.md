---
phase: 12.6-per-file-ipns-metadata-split
plan: 02
subsystem: api
tags: [ipns, batch-publish, tee-republish, nestjs, typeorm]

# Dependency graph
requires:
  - phase: 12.6-per-file-ipns-metadata-split-01
    provides: per-file IPNS types, derivation, encryption in crypto package
provides:
  - POST /ipns/publish-batch endpoint for batch IPNS record publishing
  - FolderIpns entity record_type column distinguishing folder vs file records
  - RepublishService.unenrollIpns for cleaning up deleted file IPNS records
  - Scaled TEE republish capacity (BATCH_SIZE=100, take=2000)
  - Regenerated API client with batch publish types
affects:
  [
    12.6-per-file-ipns-metadata-split-03,
    12.6-per-file-ipns-metadata-split-04,
    12.6-per-file-ipns-metadata-split-05,
  ]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'Concurrency-limited batch processing with Promise.allSettled in groups of 10'
    - 'Partial success pattern: individual record failures do not fail the batch'

key-files:
  created:
    - apps/web/src/api/models/batchPublishIpnsDto.ts
    - apps/web/src/api/models/batchPublishIpnsResponseDto.ts
    - apps/web/src/api/models/publishIpnsEntryDto.ts
    - apps/web/src/api/models/publishIpnsEntryDtoRecordType.ts
  modified:
    - apps/api/src/ipns/entities/folder-ipns.entity.ts
    - apps/api/src/ipns/dto/publish.dto.ts
    - apps/api/src/ipns/dto/index.ts
    - apps/api/src/ipns/ipns.controller.ts
    - apps/api/src/ipns/ipns.service.ts
    - apps/api/src/republish/republish.service.ts
    - apps/web/src/api/ipns/ipns.ts
    - apps/web/src/api/models/index.ts
    - packages/api-client/openapi.json

key-decisions:
  - 'Task 1 work already completed in Plan 01 commit (cfb98287e) -- entity, DTOs, controller endpoint'
  - 'Partial success for batch publish: failed records logged and counted, not re-thrown'
  - 'Concurrency limit of 10 for delegated routing calls within a batch'

patterns-established:
  - 'Batch endpoint pattern: array DTO with ArrayMaxSize, per-record results with totalSucceeded/totalFailed'
  - 'unenrollIpns pattern: delete-based cleanup to prevent orphaned TEE enrollments'

# Metrics
duration: 5min
completed: 2026-02-17
---

# Phase 12.6 Plan 02: Batch Publish Backend Summary

<!-- markdownlint-disable MD036 -->

**POST /ipns/publish-batch endpoint with concurrency-limited processing, FolderIpns record_type tracking, and RepublishService scalability for per-file IPNS**

<!-- markdownlint-enable MD036 -->

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-17T00:08:07Z
- **Completed:** 2026-02-17T00:12:49Z
- **Tasks:** 2
- **Files modified:** 13 (4 created, 9 modified)

## Accomplishments

- Batch publish endpoint accepts up to 200 IPNS records in single API call with concurrency=10
- FolderIpns entity distinguishes folder vs file records via record_type column
- RepublishService scaled: BATCH_SIZE 50->100, getDueEntries 500->2000, soft capacity warning at 1000+
- unenrollIpns method prevents orphaned TEE enrollments on file deletion
- API client regenerated with typed batch publish endpoint for frontend

## Task Commits

Each task was committed atomically:

1. **Task 1: Entity update + batch publish DTO + controller endpoint** - `cfb98287e` (feat) -- completed in Plan 01 execution
2. **Task 2: Batch publish service + republish scalability + API client regen** - `c4803f739` (feat)

## Files Created/Modified

- `apps/api/src/ipns/entities/folder-ipns.entity.ts` - Added record_type column (default 'folder')
- `apps/api/src/ipns/dto/publish.dto.ts` - Added PublishIpnsEntryDto, BatchPublishIpnsDto, BatchPublishIpnsResponseDto
- `apps/api/src/ipns/dto/index.ts` - Exported new batch DTOs
- `apps/api/src/ipns/ipns.controller.ts` - Added POST /ipns/publish-batch with rate limiting (5/min)
- `apps/api/src/ipns/ipns.service.ts` - Added publishBatch method, updated upsertFolderIpns with recordType parameter
- `apps/api/src/republish/republish.service.ts` - BATCH_SIZE=100, take=2000, unenrollIpns method, capacity warning
- `apps/web/src/api/ipns/ipns.ts` - Regenerated with batch publish endpoint
- `apps/web/src/api/models/batchPublishIpnsDto.ts` - Generated batch DTO type
- `apps/web/src/api/models/batchPublishIpnsResponseDto.ts` - Generated batch response type
- `apps/web/src/api/models/publishIpnsEntryDto.ts` - Generated entry DTO type
- `apps/web/src/api/models/publishIpnsEntryDtoRecordType.ts` - Generated record type enum
- `packages/api-client/openapi.json` - Updated OpenAPI spec with batch endpoint

## Decisions Made

- Task 1 entity/DTO/controller work was already committed in Plan 01 (cfb98287e) -- no duplicate commit needed
- Partial success pattern: batch publish returns per-record results, individual failures do not block the batch
- Concurrency limit of 10 for parallel delegated routing calls within a batch

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Task 1 already completed in Plan 01**

- **Found during:** Task 1 execution
- **Issue:** Plan 01 (cfb98287e) already committed the entity, DTO, index, and controller changes specified by Task 1
- **Fix:** Verified Task 1 criteria were met in existing commit, skipped duplicate commit
- **Files modified:** None (already committed)
- **Verification:** grep patterns confirmed record_type, BatchPublishIpnsDto, publish-batch all present
- **Committed in:** cfb98287e (Plan 01 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Task 1 work was already done -- no scope change, just skipped redundant commit.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Batch publish endpoint ready for frontend integration (Plan 03)
- API client types available for web app to call publish-batch
- RepublishService can handle per-file IPNS scale with unenrollIpns cleanup
- FolderMetadataV2 types from Plan 01 ready for folder metadata format changes

---

_Phase: 12.6-per-file-ipns-metadata-split_
_Completed: 2026-02-17_
