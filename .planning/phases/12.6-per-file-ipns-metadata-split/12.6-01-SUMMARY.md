---
phase: 12.6-per-file-ipns-metadata-split
plan: 01
subsystem: crypto
tags: [hkdf, ed25519, ipns, aes-gcm, file-metadata, folder-v2]

# Dependency graph
requires:
  - phase: 12.3.1-pre-wipe-identity-cleanup
    provides: vault IPNS derivation pattern (deriveVaultIpnsKeypair)
provides:
  - deriveFileIpnsKeypair function for per-file IPNS keypair derivation
  - FileMetadata, FilePointer, EncryptedFileMetadata types
  - encryptFileMetadata/decryptFileMetadata functions
  - FolderMetadataV2, FolderChildV2, AnyFolderMetadata types
  - isV2Metadata type guard
  - validateFolderMetadata accepts v1 and v2
affects: [12.6-02, 12.6-03, 12.6-04, 12.6-05]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'Per-file HKDF domain separation via fileId in info string'
    - 'v1/v2 folder metadata coexistence with union type validator'
    - 'FilePointer slim reference pattern for v2 folder children'

key-files:
  created:
    - packages/crypto/src/file/types.ts
    - packages/crypto/src/file/derive-ipns.ts
    - packages/crypto/src/file/metadata.ts
    - packages/crypto/src/file/index.ts
    - packages/crypto/src/__tests__/file-ipns.test.ts
  modified:
    - packages/crypto/src/folder/types.ts
    - packages/crypto/src/folder/metadata.ts
    - packages/crypto/src/folder/index.ts
    - packages/crypto/src/index.ts

key-decisions:
  - "File metadata encrypted with parent folderKey (not file's own key) for access control consistency"
  - 'encryptionMode optional with GCM default in validator for Phase 12.1 AES-CTR forward compatibility'
  - 'fileId minimum 10 chars validation to ensure UUID-length identifiers'

patterns-established:
  - 'Per-file HKDF info: cipherbox-file-ipns-v1:{fileId} for domain separation'
  - 'v2 folder metadata validator accepts both FileEntry (cid) and FilePointer (fileMetaIpnsName) children'

# Metrics
duration: 4min
completed: 2026-02-17
---

# Phase 12.6 Plan 01: Crypto Primitives Summary

HKDF-based per-file IPNS keypair derivation, file metadata encryption/decryption with parent folderKey, v2 folder metadata schema with FilePointer children.

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-17T00:08:17Z
- **Completed:** 2026-02-17T00:12:40Z
- **Tasks:** 2
- **Files modified:** 9

## Accomplishments

- Created `packages/crypto/src/file/` module with deterministic IPNS keypair derivation (HKDF-SHA256 with per-file domain separation via fileId)
- Added FileMetadata type with optional encryptionMode field ('GCM' default) for AES-CTR forward compatibility
- Updated folder metadata validator to accept both v1 (inline FileEntry) and v2 (slim FilePointer) schemas
- Added 19 unit tests covering determinism, domain separation, encryption round-trip, and v2 validation

## Task Commits

Each task was committed atomically:

1. **Task 1: Create file IPNS module (types, derivation, encryption)** - `cfb98287e` (feat)
2. **Task 2: Update folder types for v2 schema + barrel exports + tests** - `a5961bf89` (feat)

## Files Created/Modified

- `packages/crypto/src/file/types.ts` - FileMetadata, FilePointer, EncryptedFileMetadata types
- `packages/crypto/src/file/derive-ipns.ts` - deriveFileIpnsKeypair with HKDF domain separation
- `packages/crypto/src/file/metadata.ts` - encryptFileMetadata/decryptFileMetadata with AES-256-GCM
- `packages/crypto/src/file/index.ts` - Barrel exports for file module
- `packages/crypto/src/__tests__/file-ipns.test.ts` - 19 unit tests
- `packages/crypto/src/folder/types.ts` - Added FolderMetadataV2, FolderChildV2, AnyFolderMetadata
- `packages/crypto/src/folder/metadata.ts` - Updated validator for v1/v2, added isV2Metadata type guard
- `packages/crypto/src/folder/index.ts` - Added v2 type exports and isV2Metadata
- `packages/crypto/src/index.ts` - Added file module and v2 folder exports to barrel

## Decisions Made

- File metadata encrypted with parent folderKey (not file's own key) -- consistent with folder metadata access control pattern
- encryptionMode is optional with 'GCM' default in validator -- Phase 12.1 AES-CTR files will set 'CTR' explicitly
- fileId minimum 10 characters validation -- ensures UUID-length identifiers, prevents accidental short strings

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- All crypto primitives ready for Plan 02 (API batch publish endpoints)
- deriveFileIpnsKeypair available for frontend upload flow (Plan 03)
- v2 folder metadata types available for migration logic (Plan 04)
- Existing v1 tests still pass (188 total, 0 failures)

---

_Phase: 12.6-per-file-ipns-metadata-split_
_Completed: 2026-02-17_
