# Phase 12.6: Per-File IPNS Metadata Split - Context

**Gathered:** 2026-02-17
**Status:** Ready for planning

## Phase Boundary

Split file metadata into separate per-file IPNS-addressed objects so content updates don't require folder republishes, and per-file sharing becomes possible. This is a data model and infrastructure change — no UI changes. Desktop FUSE client update is deferred.

## Implementation Decisions

### TEE Republish Scaling

- Concurrency level for parallel IPNS publishes: Claude's discretion (research should benchmark)
- Conservative capacity limits acceptable — soft limit for warnings, conservative initial thresholds are fine
- Degradation strategy: **priority-based** ordering by staleness (recently-modified files first)
- Priority logic lives in the **backend orchestrator**, NOT in the TEE enclave — TEE stays a dumb signer
- TEE receives pre-sorted batches, signs, publishes, returns results
- **Enrollment model:** Enroll file IPNS keys at upload time (extend existing TEE enrollment pattern)
  - **Known risk — enrollment drift:** If file IPNS records are deleted or modified outside the enrollment flow, the TEE enrollment list can drift from the actual vault contents. Future mitigation: periodic full-vault scan reconciliation (TEE reads vault metadata to discover all file IPNS records and sync enrollment list). Not needed for v1 but should be considered if drift appears in production.

### Migration Approach

- **Clean break (v2-only)** — no backward compatibility with v1 embedded metadata
- Vault wipe window means no legacy data exists; only v2 schema implemented
- Vault export: v2-only format (no v1 export support)
- v1 import: not supported (clean break)
- **Desktop FUSE client update deferred** — web app gets v2 first; desktop catches up in a later phase or quick task. Desktop may not work with v2 vaults until updated.

### File Metadata Boundaries

- **Folder entry retains:** nameEncrypted, nameIv, fileMetaIpnsName (pointer), createdAt, modifiedAt (timestamps for fast listing/sorting)
- **Per-file IPNS record contains:** cid, fileKeyEncrypted, fileIv (content-derived data only)
- **size and mimeType:** file record only (not duplicated in folder) — folder listing resolves file records when size/type display is needed
- **Timestamps in both places:** Folder has timestamps for fast sorted listing. File record has its own timestamps for future version history.
- Content update = file record publish only (folder timestamps unchanged for content updates)
- File rename = folder publish only (file record untouched)
- **No versionHistory field** — keep schema clean. Phase 13 adds it with `?? []` fallback. IPNS schema evolution is just a default-value check in the deserializer, zero migration cost.

### Batch Publish API

- **Single API call** for batch uploads — all per-file IPNS records + folder IPNS published in one request (preserves Phase 7.1 atomicity pattern)
- **Backend retries internally** — if some file IPNS publishes fail, backend retries (3 attempts with backoff). Client sees atomic success/failure. Orphaned file records (from partial publish before rollback) are harmless.
- **TEE enrollment in same call** — batch publish also enrolls all file IPNS keys for TEE republishing. One round-trip, backend coordinates both.
- **Content update (re-upload) uses the same batch API** — batch of 1 file record + 0 folder records. No dedicated single-file endpoint for now.
- File IPNS keypair derivation: HKDF from user privateKey + fileId (same pattern as folder IPNS derivation)

### Claude's Discretion

- Exact parallelism level for TEE IPNS publishes (benchmark during research)
- Capacity limit thresholds (soft/hard limits)
- Backend retry strategy details (backoff timing, max attempts)
- File IPNS record encryption scheme (likely AES-256-GCM with file-specific key, same as folder metadata)
- HKDF info string for file IPNS derivation (e.g., "cipherbox-file-ipns-v1")

## Specific Ideas

- Priority-based TEE republishing: backend orchestrator sorts records by last-publish timestamp, feeds pre-sorted batches to TEE. TEE stays minimal — just signs and publishes.
- Enrollment drift mitigation: enroll at upload for v1, add periodic full-vault scan reconciliation in future if drift appears. Document this as a known future enhancement.
- Content update publishes file record only — this is THE primary benefit of the split. Folder metadata stays untouched when file content changes.
- File rename publishes folder only — file record stays untouched when the name changes.

## Deferred Ideas

- **Dedicated single-file publish endpoint** — When per-file sharing is implemented (Phase 14), a dedicated `/ipns/publish-file` endpoint would map cleanly to per-file permissions (recipient updates shared file content without folder access). Note for Phase 14 planning.
- **TEE enrollment drift reconciliation** — Periodic full-vault scan by TEE to sync enrollment list with actual vault contents. Add when/if drift becomes an issue in production.
- **Desktop FUSE client v2 metadata support** — Desktop client needs to resolve per-file IPNS records instead of reading embedded folder data. Deferred to a follow-up quick task or phase.

---

_Phase: 12.6-per-file-ipns-metadata-split_
_Context gathered: 2026-02-17_
