---
phase: 12.6-per-file-ipns-metadata-split
plan: 04
type: execute
wave: 2
depends_on: ['12.6-03']
files_modified:
  - apps/web/src/hooks/useFolder.ts
  - apps/web/src/hooks/useFilePreview.ts
  - apps/web/src/hooks/useFileDownload.ts
  - apps/web/src/hooks/useDropUpload.ts
  - apps/web/src/components/file-browser/FileBrowser.tsx
  - apps/web/src/components/file-browser/TextEditorDialog.tsx
  - apps/web/src/components/file-browser/ImagePreviewDialog.tsx
  - apps/web/src/components/file-browser/DetailsDialog.tsx
autonomous: true

must_haves:
  truths:
    - 'useFolder hook passes v2 params to service functions (fileId + ipnsRecord instead of cid/key/iv)'
    - 'useFilePreview resolves file IPNS before download instead of using embedded cid/key/iv'
    - 'useDropUpload creates per-file IPNS metadata before registering files in folder'
    - 'FileBrowser type guard uses FilePointer instead of FileEntry for file items'
    - 'TextEditorDialog save flow updates file IPNS record instead of folder metadata'
    - 'DetailsDialog shows fileMetaIpnsName for file items instead of content CID'
    - 'Full web app compiles and builds without type errors'
  artifacts:
    - path: 'apps/web/src/hooks/useFolder.ts'
      provides: 'v2 folder operations hook with FilePointer-based params'
      contains: 'FilePointer'
    - path: 'apps/web/src/hooks/useFilePreview.ts'
      provides: 'IPNS-based file preview with lazy metadata resolution'
      contains: 'downloadFileFromIpns'
    - path: 'apps/web/src/hooks/useDropUpload.ts'
      provides: 'Drop upload with per-file IPNS metadata creation'
      contains: 'createFileMetadata'
    - path: 'apps/web/src/components/file-browser/FileBrowser.tsx'
      provides: 'File browser using FolderChildV2/FilePointer types'
      contains: 'FilePointer'
    - path: 'apps/web/src/components/file-browser/TextEditorDialog.tsx'
      provides: 'Text editor with v2 save flow (file IPNS update)'
      contains: 'updateFileMetadata'
    - path: 'apps/web/src/components/file-browser/DetailsDialog.tsx'
      provides: 'Details dialog showing fileMetaIpnsName for file items'
      contains: 'fileMetaIpnsName'
  key_links:
    - from: 'apps/web/src/hooks/useFolder.ts'
      to: 'apps/web/src/services/folder.service.ts'
      via: 'v2 addFileToFolder/addFilesToFolder/replaceFileInFolder calls'
      pattern: 'folderService\.(addFileToFolder|addFilesToFolder|replaceFileInFolder)'
    - from: 'apps/web/src/hooks/useFilePreview.ts'
      to: 'apps/web/src/services/download.service.ts'
      via: 'downloadFileFromIpns call'
      pattern: 'downloadFileFromIpns'
    - from: 'apps/web/src/hooks/useDropUpload.ts'
      to: 'apps/web/src/services/file-metadata.service.ts'
      via: 'createFileMetadata call for each uploaded file'
      pattern: 'createFileMetadata'
    - from: 'apps/web/src/components/file-browser/TextEditorDialog.tsx'
      to: 'apps/web/src/services/file-metadata.service.ts'
      via: 'updateFileMetadata for save, resolveFileMetadata for load'
      pattern: 'updateFileMetadata|resolveFileMetadata'
---

<objective>
Update all hooks and components that consume the service layer to use v2 types and APIs. After Plan 03 rewrites service signatures to use FilePointer/v2, the hooks and components must be updated to match -- otherwise the app won't compile.

Purpose: Bridges the service layer (Plan 03) to the UI. Without these changes, the app has type errors at every call site that passes FileEntry properties (cid, fileKeyEncrypted, fileIv) to service functions now expecting FilePointer-based params.
Output: All hooks and components compile against the v2 service API. Full web app builds clean.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.6-per-file-ipns-metadata-split/12.6-RESEARCH.md

# Prior plan summaries (needed for service API changes)

@.planning/phases/12.6-per-file-ipns-metadata-split/12.6-01-SUMMARY.md
@.planning/phases/12.6-per-file-ipns-metadata-split/12.6-03-SUMMARY.md

# Key source files to reference (READ ALL before modifying)

@apps/web/src/hooks/useFolder.ts
@apps/web/src/hooks/useFilePreview.ts
@apps/web/src/hooks/useFileDownload.ts
@apps/web/src/hooks/useDropUpload.ts
@apps/web/src/components/file-browser/FileBrowser.tsx
@apps/web/src/components/file-browser/TextEditorDialog.tsx
@apps/web/src/components/file-browser/ImagePreviewDialog.tsx
@apps/web/src/components/file-browser/DetailsDialog.tsx

# Service files (after Plan 03 changes)

@apps/web/src/services/folder.service.ts
@apps/web/src/services/download.service.ts
@apps/web/src/services/file-metadata.service.ts
@apps/web/src/stores/folder.store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update useFolder hook for v2 service API</name>
  <files>
    apps/web/src/hooks/useFolder.ts
  </files>
  <action>
Read the full useFolder.ts first. This hook has multiple methods that pass v1 FileEntry params to folder service functions. All must be updated.

**Import changes:**

- Replace `import type { FolderEntry, FileEntry } from '@cipherbox/crypto'` with `import type { FolderEntry, FilePointer, FolderChildV2 } from '@cipherbox/crypto'`.
- Add import: `import { createFileMetadata, resolveFileMetadata, updateFileMetadata } from '../services/file-metadata.service'`.
- Add import: `import { useAuthStore } from '../stores/auth.store'` (if not already imported -- needed for userPrivateKey in file metadata operations).

**handleAddFile** -- Complete rewrite:

- Old signature took `{ cid, wrappedKey, iv, originalName, originalSize }`.
- New signature takes `{ cid, wrappedKey, iv, originalName, originalSize, mimeType?: string }` (same upload result but mimeType added for file metadata).
- Return type changes from `FileEntry` to `FilePointer`.
- New flow:
  1. Get `auth.vaultKeypair.privateKey` (userPrivateKey) from auth store (use `useAuthStore.getState()`).
  2. Generate fileId: `crypto.randomUUID()`.
  3. Call `createFileMetadata({ fileId, cid: fileData.cid, fileKeyEncrypted: fileData.wrappedKey, fileIv: fileData.iv, size: fileData.originalSize, mimeType: fileData.mimeType ?? 'application/octet-stream', folderKey: parentFolder.folderKey, userPrivateKey })`.
  4. Call `folderService.addFileToFolder({ parentFolderState: parentFolder, fileId, name: fileData.originalName, fileIpnsRecord: result.ipnsRecord })` -- note the new params.
  5. Update local state with `filePointer` (not `fileEntry`).
  6. Return `filePointer`.

**handleAddFiles** -- Complete rewrite:

- Old signature took `Array<{ cid, wrappedKey, iv, originalName, originalSize }>`.
- New signature takes same shape plus optional `mimeType`.
- Return type changes from `FileEntry[]` to `FilePointer[]`.
- New flow:
  1. Get `auth.vaultKeypair.privateKey`.
  2. For each file: generate fileId, call `createFileMetadata(...)`.
  3. Build the files array for `folderService.addFilesToFolder` with the new shape: `{ fileId, name, fileIpnsRecord }`.
  4. Call `folderService.addFilesToFolder({ parentFolderState: parentFolder, files })`.
  5. Update local state with `filePointers` (not `fileEntries`).
  6. Return `filePointers`.

**handleUpdateFile** -- Complete rewrite:

- Old signature took `{ fileId, newCid, newFileKeyEncrypted, newFileIv, newSize }`.
- New signature takes `{ fileId, newCid, newFileKeyEncrypted, newFileIv, newSize }` (same params from caller, but the flow changes).
- New flow:
  1. Get `auth.vaultKeypair.privateKey` and parent `folderKey`.
  2. Find the FilePointer in parent children by fileId.
  3. Call `resolveFileMetadata(filePointer.fileMetaIpnsName, parentFolder.folderKey)` to get current metadata.
  4. Call `updateFileMetadata({ fileId, folderKey: parentFolder.folderKey, userPrivateKey, currentMetadata, updates: { cid: newCid, fileKeyEncrypted: newFileKeyEncrypted, fileIv: newFileIv, size: newSize } })`.
  5. Call `folderService.replaceFileInFolder({ fileId, parentFolderState: parentFolder, fileIpnsRecord: result.ipnsRecord })`.
  6. Update local state: only update `modifiedAt` on the FilePointer (no cid/key/iv in the folder children anymore).
  7. Unpin old CID, refresh quota (same as before).

**handleDelete / handleDeleteItems** -- Minor updates:

- The `collectCidsAndFolders` helper in handleDeleteItems checks `'cid' in child` to collect CIDs. In v2, FilePointers don't have `cid`. Update to check for `'fileMetaIpnsName' in child` instead, and collect fileMetaIpnsNames for later IPNS resolution/cleanup (or skip CID collection since we can't resolve without folderKey in this context -- just remove the CID collection for file items; the file IPNS/TEE enrollment will expire naturally).
- The single-file `handleDelete` calls `folderService.deleteFileFromFolder`. Update local state code that filters children -- no change needed since filter is by `child.id` which exists on both FileEntry and FilePointer.

**handleRename / handleMove / handleMoveItems** -- Minimal type updates:

- Replace `FolderChild` type annotations with `FolderChildV2` where they appear in local variables.
- The service function signatures for rename/move don't change (they operate on folder metadata only), so the call sites stay the same.
- The local state update that spreads `{ ...child, name: newName }` works for both FileEntry and FilePointer.
  </action>
  <verify>
  Run `cd /Users/michael/Code/cipher-box && pnpm --filter web typecheck` -- useFolder.ts compiles without type errors.
  Verify FilePointer usage: `grep "FilePointer" apps/web/src/hooks/useFolder.ts`.
  Verify createFileMetadata call: `grep "createFileMetadata" apps/web/src/hooks/useFolder.ts`.
  Verify no FileEntry import: `grep "FileEntry" apps/web/src/hooks/useFolder.ts` returns nothing (or only in comments).
  </verify>
  <done>
  useFolder hook fully updated for v2. handleAddFile/handleAddFiles create per-file IPNS metadata before registering in folder. handleUpdateFile resolves file IPNS, updates metadata, publishes only file IPNS record. handleDelete/handleDeleteItems updated for FilePointer (no CID collection for files). All type annotations use FilePointer/FolderChildV2.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Update preview hooks + file browser components for v2</name>
  <files>
    apps/web/src/hooks/useFilePreview.ts
    apps/web/src/hooks/useFileDownload.ts
    apps/web/src/hooks/useDropUpload.ts
    apps/web/src/components/file-browser/FileBrowser.tsx
    apps/web/src/components/file-browser/TextEditorDialog.tsx
    apps/web/src/components/file-browser/ImagePreviewDialog.tsx
    apps/web/src/components/file-browser/DetailsDialog.tsx
  </files>
  <action>
Read ALL files fully before modifying. These changes adapt the UI layer to FilePointer types.

**useFilePreview.ts** -- Rewrite for IPNS-based preview:

- Change import from `FileEntry` to `FilePointer` from `@cipherbox/crypto`.
- Change `UseFilePreviewOptions.item` type from `FileEntry | null` to `FilePointer | null`.
- Add `folderKey: Uint8Array | null` to `UseFilePreviewOptions` (needed to decrypt file metadata).
- Import `downloadFileFromIpns` from `../services/download.service`.
- In the useEffect async block, replace the `downloadFile({ cid: item.cid, iv: item.fileIv, wrappedKey: item.fileKeyEncrypted, ... })` call with `downloadFileFromIpns({ fileMetaIpnsName: item.fileMetaIpnsName, folderKey: folderKey!, privateKey: auth.vaultKeypair.privateKey, fileName: item.name })`.
- The callers (ImagePreviewDialog, PdfPreviewDialog, AudioPlayerDialog, VideoPlayerDialog) will need to pass `folderKey` -- this is available from the parent folder's FolderNode in the folder store.

**useFileDownload.ts** -- Add IPNS-based download:

- The existing `download(metadata: FileMetadata)` function takes `{ cid, iv, wrappedKey, originalName }`. Keep this for backward compatibility.
- Add a new function: `downloadFromIpns(params: { fileMetaIpnsName: string, folderKey: Uint8Array, fileName: string })` that:
  1. Calls `downloadFileFromIpns(...)` from download.service.
  2. Triggers browser download of the result.
  3. Uses the same download store progress tracking.
- Export both `download` (legacy) and `downloadFromIpns` (v2) from the hook.

**useDropUpload.ts** -- Update for v2 addFiles:

- The current code calls `addFiles(folderId, filesData.map(f => ({ cid, wrappedKey, iv, ... })))`.
- Update to match the new `addFiles` signature from useFolder. The upload service still returns `{ cid, wrappedKey, iv, originalName, originalSize }` -- the useFolder hook's handleAddFiles now handles the createFileMetadata step internally.
- If `addFiles` signature changed (check Plan 03's useFolder update), adapt the mapping. The key difference: `addFiles` may now need `mimeType`. Detect mimeType from the File object: `file.type || 'application/octet-stream'`.
- Update the mapping to include `mimeType` for each file.

**FileBrowser.tsx** -- Update types and handlers:

- Replace `import type { FolderChild, FileEntry } from '@cipherbox/crypto'` with `import type { FolderChildV2, FilePointer, FolderEntry } from '@cipherbox/crypto'`.
- Update the `isFileEntry` type guard to `isFilePointer(item: FolderChildV2): item is FilePointer` checking `item.type === 'file'`.
- Update `DialogState.item` type from `FolderChild | null` to `FolderChildV2 | null`.
- **handleDownload**: Currently accesses `item.cid`, `item.fileIv`, `item.fileKeyEncrypted` directly. These don't exist on FilePointer. Change to use `downloadFromIpns` from useFileDownload: `downloadFromIpns({ fileMetaIpnsName: item.fileMetaIpnsName, folderKey: currentFolderKey, fileName: item.name })`. Get `currentFolderKey` from `currentFolder.folderKey`.
- **handleBatchDownload**: Same change -- iterate FilePointers and call `downloadFromIpns` for each.
- **handleSync**: `fetchAndDecryptMetadata` return type is now `FolderMetadata | FolderMetadataV2`. The `metadata.children` is already compatible since both are arrays of children. No change needed.
- **Dialog props**: Update all dialog component calls that pass `isFileEntry(item)` to use `isFilePointer(item)` instead. Specifically:
  - `TextEditorDialog item=` prop: change `isFileEntry(editorDialog.item)` to `isFilePointer(editorDialog.item)`
  - `ImagePreviewDialog item=` prop: same
  - `PdfPreviewDialog item=` prop: same
  - `AudioPlayerDialog item=` prop: same
  - `VideoPlayerDialog item=` prop: same
- **Context menu handlers**: `onDownload`, `onEdit`, `onPreview` guards use `isFileEntry(contextMenu.item)` -- change to `isFilePointer`.

**TextEditorDialog.tsx** -- Rewrite for v2 load/save:

- Change `item: FileEntry | null` prop to `item: FilePointer | null`.
- Add `folderKey: Uint8Array | null` prop (passed from FileBrowser via currentFolder.folderKey).
- **Load flow**: Replace `downloadFile({ cid: item.cid, iv: item.fileIv, ... })` with `downloadFileFromIpns({ fileMetaIpnsName: item.fileMetaIpnsName, folderKey: folderKey!, privateKey: auth.vaultKeypair.privateKey, fileName: item.name })`.
- **Save flow**: The current save calls `updateFile(parentFolderId, { fileId, newCid, newFileKeyEncrypted, newFileIv, newSize })`. This still works because the useFolder hook's `handleUpdateFile` internally handles the IPNS update. No change to the save call itself, just the load.

**ImagePreviewDialog.tsx** -- Update for v2:

- Change `item: FileEntry | null` prop to `item: FilePointer | null`.
- Add `folderKey: Uint8Array | null` prop.
- Replace the inline download/decrypt logic with `useFilePreview({ open, item, mimeType, folderKey })` hook (which was already updated above to use IPNS resolution). If this dialog already uses useFilePreview, just pass the new folderKey. If it has inline logic (check the file), refactor to use the hook.
- NOTE: Reading the actual file, ImagePreviewDialog has inline download logic (not useFilePreview). Change `downloadFile({ cid: item.cid, ... })` to `downloadFileFromIpns({ fileMetaIpnsName: item.fileMetaIpnsName, folderKey: folderKey!, ... })`. Import `downloadFileFromIpns` from download.service.

**DetailsDialog.tsx** -- Update for v2 file details:

- The `FileDetails` component currently shows `item.cid`, `item.encryptionMode`, `item.fileIv`, `item.fileKeyEncrypted`. These don't exist on FilePointer.
- Change `FileDetails` to accept `FilePointer` instead of `FileEntry`.
- For v2, show different fields:
  - **Name**: `item.name` (same)
  - **Type**: [FILE] badge (same)
  - **Size**: Not available in FilePointer (only in FileMetadata). Show "resolve IPNS for details" or omit. The size could be lazy-loaded but that adds complexity -- for v1 just omit it or show "--".
  - **IPNS section**: Add "File Metadata IPNS" row showing `item.fileMetaIpnsName` (copyable).
  - **Encryption section**: Remove Content CID, Encryption Mode, File IV, Wrapped File Key rows (not in FilePointer). These could be shown by resolving file IPNS, but that's a follow-up enhancement.
  - **Timestamps**: `item.createdAt`, `item.modifiedAt` (same)
- Update the `DetailsDialog` component: use `item.type === 'file'` with `FilePointer` type for file details.
- Update IPNS resolution logic: for files, resolve `item.fileMetaIpnsName` instead of parent folder IPNS.
- Import `FolderChildV2, FilePointer` instead of `FolderChild, FileEntry`.

**Callers that pass folderKey to updated components:**

In FileBrowser.tsx, where it renders the updated dialogs, pass the current folder's folderKey:

- `<TextEditorDialog ... folderKey={currentFolder?.folderKey ?? null} />`
- `<ImagePreviewDialog ... folderKey={currentFolder?.folderKey ?? null} />`
- `<PdfPreviewDialog ... folderKey={currentFolder?.folderKey ?? null} />` (if PdfPreviewDialog uses useFilePreview)
- `<AudioPlayerDialog ... folderKey={currentFolder?.folderKey ?? null} />` (if uses useFilePreview)
- `<VideoPlayerDialog ... folderKey={currentFolder?.folderKey ?? null} />` (if uses useFilePreview)

Check each preview dialog -- if they use the `useFilePreview` hook, they just need the `folderKey` prop threaded through. If they have inline download logic, update each one to use `downloadFileFromIpns`.
</action>
<verify>
Run `cd /Users/michael/Code/cipher-box && pnpm --filter web typecheck` -- full web app compiles without type errors.
Run `cd /Users/michael/Code/cipher-box && pnpm --filter web build` -- builds without errors.
Verify FilePointer in FileBrowser: `grep "FilePointer\|isFilePointer" apps/web/src/components/file-browser/FileBrowser.tsx`.
Verify IPNS download in preview: `grep "downloadFileFromIpns\|fileMetaIpnsName" apps/web/src/hooks/useFilePreview.ts`.
Verify no FileEntry references remain in modified files: `grep "FileEntry" apps/web/src/hooks/useFolder.ts apps/web/src/hooks/useFilePreview.ts apps/web/src/components/file-browser/FileBrowser.tsx apps/web/src/components/file-browser/TextEditorDialog.tsx apps/web/src/components/file-browser/ImagePreviewDialog.tsx apps/web/src/components/file-browser/DetailsDialog.tsx` should return nothing (or only comments/type imports for backward compat).
</verify>
<done>
All hooks and components updated for v2. useFilePreview resolves file IPNS lazily on open. useDropUpload passes mimeType for file metadata. FileBrowser uses FilePointer type guard, IPNS-based download for context menu and batch actions. TextEditorDialog loads via IPNS resolution, saves via file metadata update. ImagePreviewDialog uses IPNS-based download. DetailsDialog shows fileMetaIpnsName instead of embedded CID/key. Full web app compiles and builds clean.
</done>
</task>

</tasks>

<verification>
- `pnpm --filter web typecheck` succeeds -- zero type errors
- `pnpm --filter web build` succeeds -- builds clean
- No remaining references to `FileEntry` in modified hook/component files (only FilePointer/FolderChildV2)
- FileBrowser download handlers use `downloadFromIpns` (not direct cid/iv/wrappedKey access)
- TextEditorDialog load uses `downloadFileFromIpns` (not direct cid access)
- DetailsDialog file section shows `fileMetaIpnsName` (not content CID)
- Preview dialogs receive and use `folderKey` prop for metadata decryption
</verification>

<success_criteria>

- Full web app compiles with `pnpm --filter web typecheck` (zero errors)
- Full web app builds with `pnpm --filter web build` (zero errors)
- All hooks pass v2 params to service functions
- All components use FilePointer instead of FileEntry for file items
- Download/preview flows resolve file IPNS before fetching content
- Text editor save updates file IPNS record (not folder metadata)
- Drop upload creates per-file IPNS metadata for each uploaded file

</success_criteria>

<output>
After completion, create `.planning/phases/12.6-per-file-ipns-metadata-split/12.6-04-SUMMARY.md`
</output>
