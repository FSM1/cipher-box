---
phase: 12.6-per-file-ipns-metadata-split
plan: 04
type: execute
wave: 3
depends_on: ['12.6-03']
files_modified:
  - apps/web/public/recovery.html
  - docs/VAULT_EXPORT_FORMAT.md
autonomous: true

must_haves:
  truths:
    - 'Recovery tool traverses v2 folder metadata and resolves per-file IPNS records'
    - 'Recovery tool decrypts file metadata with parent folderKey to get CID and file key'
    - 'VAULT_EXPORT_FORMAT.md documents v2 folder metadata schema and file IPNS resolution'
    - 'Full monorepo builds and lints clean'
  artifacts:
    - path: 'apps/web/public/recovery.html'
      provides: 'v2-aware vault recovery with per-file IPNS resolution'
      contains: 'cipherbox-file-ipns-v1'
    - path: 'docs/VAULT_EXPORT_FORMAT.md'
      provides: 'Updated documentation with v2 schema description'
      contains: 'FilePointer'
  key_links:
    - from: 'apps/web/public/recovery.html'
      to: 'IPFS gateway'
      via: 'file IPNS resolution then IPFS fetch'
      pattern: 'fileMetaIpnsName'
---

<objective>
Update the standalone recovery tool to handle v2 folder metadata (resolving per-file IPNS records), and update vault export documentation to describe the new schema. Verify the full monorepo builds clean.

Purpose: Recovery is the safety net for users. If the recovery tool can't handle v2, users lose their data recovery path. Documentation must reflect the new architecture.
Output: Updated recovery.html with v2 support, updated VAULT_EXPORT_FORMAT.md, clean build.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.6-per-file-ipns-metadata-split/12.6-RESEARCH.md

# Prior plan summaries

@.planning/phases/12.6-per-file-ipns-metadata-split/12.6-01-SUMMARY.md
@.planning/phases/12.6-per-file-ipns-metadata-split/12.6-03-SUMMARY.md

# Key source files

@apps/web/public/recovery.html
@docs/VAULT_EXPORT_FORMAT.md
@packages/crypto/src/file/derive-ipns.ts
@packages/crypto/src/file/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update recovery tool for v2 folder metadata</name>
  <files>apps/web/public/recovery.html</files>
  <action>
The recovery.html is a standalone single-file tool (no build system, inline JS). It must be updated to handle v2 folder metadata.

Read the current recovery.html fully first to understand its structure and existing folder traversal logic.

Update the folder metadata processing logic:

1. **Detect v2 schema:** After decrypting folder metadata, check `metadata.version`. If `'v2'`, use v2 processing path.

2. **v2 child processing:** When iterating children:
   - For `type: 'folder'`: Same as before (recursive traversal with nested folderKey).
   - For `type: 'file'` with `fileMetaIpnsName` field (FilePointer):
     a. Derive file IPNS keypair: implement inline HKDF derivation using Web Crypto API with salt `'CipherBox-v1'` and info `'cipherbox-file-ipns-v1:' + child.id`.
     b. Derive Ed25519 public key from HKDF output (use the same Ed25519 implementation already in recovery.html).
     c. Derive IPNS name from Ed25519 public key (use the same IPNS name derivation already in recovery.html).
     d. Resolve file IPNS name via IPFS gateway to get file metadata CID.
     e. Fetch and decrypt file metadata with the parent's folderKey (AES-256-GCM, same as folder metadata decryption).
     f. From the decrypted FileMetadata, extract: `cid`, `fileKeyEncrypted`, `fileIv`, `size`, `mimeType`.
     g. Display the file in the recovery UI with download link using the resolved CID.

3. **File IPNS resolution in recovery context:** The recovery tool uses public IPFS gateways. For IPNS resolution:
   - Try `https://delegated-ipfs.dev/routing/v1/ipns/{ipnsName}` (same as app).
   - Fallback: If the user has their CipherBox API running, they could provide the API URL. But for standalone recovery, delegated routing is the only option.
   - If IPNS resolution fails for a file, show a warning "File metadata IPNS record may have expired. File content CID is not recoverable via IPNS." with the file name and fileMetaIpnsName for manual recovery attempts.

4. **Error handling:** File IPNS resolution failures should NOT block recovery of other files. Process all files, report failures at the end.

5. **v1 backward compatibility:** v1 metadata (with embedded `cid`, `fileKeyEncrypted`, etc.) must continue to work. Since CONTEXT.md says clean break (v2-only), v1 support is technically optional, but keeping it costs nothing and protects against edge cases. The existing v1 code path should remain as-is, just gated behind `version === 'v1'`.
   </action>
   <verify>
   Open `apps/web/public/recovery.html` in a browser -- the page should load without JS errors.
   Verify v2 handling: `grep "fileMetaIpnsName\|cipherbox-file-ipns-v1" apps/web/public/recovery.html` shows per-file IPNS logic.
   Verify v2 version check: `grep "version.*v2" apps/web/public/recovery.html` shows schema detection.
   </verify>
   <done>
   Recovery tool handles v2 folder metadata: detects FilePointer children, derives file IPNS keypair via HKDF, resolves file IPNS to get metadata CID, decrypts file metadata with parent folderKey. Graceful degradation on IPNS resolution failures.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Update vault export docs + full build verification</name>
  <files>docs/VAULT_EXPORT_FORMAT.md</files>
  <action>
**VAULT_EXPORT_FORMAT.md** -- Update to document v2:

Read the full document first. Then add a new section (after the existing "Encrypted Folder Metadata Format" section) documenting the v2 changes:

1. **v2 Folder Metadata Schema:**
   - Document the `FolderMetadataV2` structure: `{ version: 'v2', children: [...] }`.
   - Document `FilePointer`: `{ type: 'file', id, name, fileMetaIpnsName, createdAt, modifiedAt }`.
   - Note that `FolderEntry` is unchanged between v1 and v2.

2. **Per-File Metadata Schema:**
   - Document the `FileMetadata` structure: `{ version: 'v1', cid, fileKeyEncrypted, fileIv, size, mimeType, createdAt, modifiedAt }`.
   - Document the encryption: AES-256-GCM with the parent folder's `folderKey` (same key used for folder metadata).
   - Document the IPNS addressing: each file has its own IPNS record derived via HKDF from userPrivateKey + fileId.

3. **HKDF File IPNS Derivation:**
   - Salt: `CipherBox-v1` (UTF-8 encoded)
   - Info: `cipherbox-file-ipns-v1:<fileId>` (UTF-8 encoded, where fileId is the UUID from the FilePointer)
   - Output: 32-byte Ed25519 seed -> Ed25519 keypair -> IPNS name

4. **Updated Recovery Procedure:**
   - Add step between folder metadata decryption and file download: "For each FilePointer child, derive the file IPNS keypair from the user's privateKey and the fileId, resolve the IPNS name to get the file metadata CID, fetch and decrypt the file metadata with the parent's folderKey."
   - Note that file IPNS records have 24h TTL and are republished by TEE every 6h. If records have expired (e.g., TEE was down), the file content is still on IPFS but the CID is not discoverable via IPNS.

5. **Export format compatibility note:**
   - The vault export JSON structure itself does NOT change (still version "1.0").
   - The recovery procedure detects v2 vaults by checking `FolderMetadata.version === 'v2'` after decrypting.

After docs update, run full monorepo verification:

- `pnpm build` -- all packages and apps build clean.
- `pnpm lint` -- no lint errors.
- `pnpm --filter @cipherbox/crypto test` -- crypto tests pass.
- `pnpm --filter api build` -- API builds clean.
- `pnpm --filter web build` -- Web app builds clean.

Fix any build/lint issues discovered.
</action>
<verify>
Run `cd /Users/michael/Code/cipher-box && pnpm build` -- full monorepo builds clean.
Run `cd /Users/michael/Code/cipher-box && pnpm lint` -- no errors.
Run `cd /Users/michael/Code/cipher-box && pnpm --filter @cipherbox/crypto test` -- all tests pass.
Verify docs: `grep "FilePointer\|FileMetadata\|cipherbox-file-ipns-v1" docs/VAULT_EXPORT_FORMAT.md` shows v2 documentation.
</verify>
<done>
VAULT_EXPORT_FORMAT.md updated with v2 folder metadata schema, per-file metadata schema, HKDF derivation details, and updated recovery procedure. Full monorepo builds clean (all packages, API, web). All crypto tests pass. Lint clean.
</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds (full monorepo)
- `pnpm lint` passes
- `pnpm --filter @cipherbox/crypto test` passes
- Recovery tool loads in browser without JS errors
- VAULT_EXPORT_FORMAT.md has v2 documentation sections
- `grep "fileMetaIpnsName" apps/web/public/recovery.html` finds per-file IPNS handling
</verification>

<success_criteria>

- Recovery tool can process v2 folder metadata: detects FilePointer children, derives file IPNS keypairs, resolves file metadata, provides download links
- Recovery tool gracefully handles file IPNS resolution failures (warns but doesn't block other files)
- VAULT_EXPORT_FORMAT.md documents v2 schema, per-file metadata, HKDF derivation, updated recovery procedure
- Full monorepo builds, lints, and tests clean
  </success_criteria>

<output>
After completion, create `.planning/phases/12.6-per-file-ipns-metadata-split/12.6-04-SUMMARY.md`
</output>
