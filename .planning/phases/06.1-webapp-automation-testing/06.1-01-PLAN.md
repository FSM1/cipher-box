---
phase: 06.1-webapp-automation-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/e2e/package.json
  - tests/e2e/tsconfig.json
  - tests/e2e/playwright.config.ts
  - tests/e2e/fixtures/index.ts
  - tests/e2e/page-objects/base.page.ts
  - tests/e2e/page-objects/login.page.ts
  - tests/e2e/page-objects/dashboard.page.ts
  - tests/e2e/utils/api-helpers.ts
  - pnpm-workspace.yaml
  - package.json
autonomous: true

must_haves:
  truths:
    - 'Playwright tests can be run with pnpm --filter e2e test'
    - 'Tests launch Chromium browser in headless mode'
    - 'Video recording captures failures only'
    - 'Web server starts automatically when running tests'
  artifacts:
    - path: 'tests/e2e/package.json'
      provides: 'E2E test package definition'
      contains: '@playwright/test'
    - path: 'tests/e2e/playwright.config.ts'
      provides: 'Playwright configuration'
      contains: 'webServer'
    - path: 'tests/e2e/fixtures/index.ts'
      provides: 'Test fixtures for auth and cleanup'
      exports: ['test', 'expect']
    - path: 'tests/e2e/page-objects/base.page.ts'
      provides: 'Base page object class'
      exports: ['BasePage']
  key_links:
    - from: 'tests/e2e/playwright.config.ts'
      to: 'apps/web'
      via: 'webServer command starts web app'
      pattern: 'pnpm.*@cipherbox/web'
    - from: 'tests/e2e/fixtures/index.ts'
      to: 'tests/e2e/page-objects'
      via: 'fixtures instantiate page objects'
      pattern: 'new.*Page'
---

<objective>
Set up Playwright E2E testing infrastructure in the monorepo.

Purpose: Establish the foundation for E2E tests including Playwright installation, configuration, base page objects, and test fixtures. This enables all subsequent test plans to have consistent patterns and tooling.

Output:

- tests/e2e workspace package with Playwright configured
- Base page object class with common utilities
- Login and Dashboard page objects
- Test fixtures for authenticated sessions and vault cleanup
- API helpers for test data management
  </objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-webapp-automation-testing/06.1-CONTEXT.md
@.planning/phases/06.1-webapp-automation-testing/06.1-RESEARCH.md
@apps/web/package.json
@pnpm-workspace.yaml
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Playwright workspace package</name>
  <files>
    tests/e2e/package.json
    tests/e2e/tsconfig.json
    tests/e2e/playwright.config.ts
    pnpm-workspace.yaml
    package.json
  </files>
  <action>
    1. Update pnpm-workspace.yaml to include tests/* in packages array

    2. Create tests/e2e/package.json:
       - name: "@cipherbox/e2e"
       - type: "module"
       - scripts:
         - "test": "playwright test"
         - "test:headed": "playwright test --headed"
         - "test:debug": "playwright test --debug"
         - "test:report": "playwright show-report"
       - devDependencies:
         - "@playwright/test": "^1.48.0"
         - "@faker-js/faker": "^9.0.0"
         - "typescript": "^5.9.3"
         - "dotenv": "^16.4.0"

    3. Create tests/e2e/tsconfig.json extending root tsconfig with strict mode

    4. Create tests/e2e/playwright.config.ts per RESEARCH.md:
       - testDir: './tests'
       - fullyParallel: false (sequential initially per CONTEXT.md)
       - workers: 1
       - forbidOnly: !!process.env.CI
       - retries: 0 (per CONTEXT.md - no automatic retries)
       - reporter: process.env.CI ? [['html', { open: 'never' }]] : 'list'
       - use:
         - baseURL: 'http://localhost:5173'
         - screenshot: 'only-on-failure'
         - video: 'retain-on-failure'
         - trace: 'retain-on-failure'
       - projects: only 'chromium' (per CONTEXT.md)
       - webServer:
         - command: 'pnpm --filter @cipherbox/web dev'
         - url: 'http://localhost:5173'
         - reuseExistingServer: !process.env.CI
         - timeout: 120000

    5. Add to root package.json scripts:
       - "test:e2e": "pnpm --filter @cipherbox/e2e test"
       - "test:e2e:headed": "pnpm --filter @cipherbox/e2e test:headed"

    6. Run pnpm install to link the new workspace

  </action>
  <verify>
    cd tests/e2e && pnpm exec playwright --version
    pnpm --filter @cipherbox/e2e test -- --help
  </verify>
  <done>
    Playwright package installed and configured. Running "pnpm --filter @cipherbox/e2e test" invokes Playwright test runner.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create base page objects and fixtures</name>
  <files>
    tests/e2e/page-objects/base.page.ts
    tests/e2e/page-objects/login.page.ts
    tests/e2e/page-objects/dashboard.page.ts
    tests/e2e/fixtures/index.ts
    tests/e2e/utils/api-helpers.ts
  </files>
  <action>
    1. Create tests/e2e/page-objects/base.page.ts:
       - BasePage class with Page constructor parameter
       - Common methods: goto(path), waitForPageLoad(), getByTestId(id)
       - Export class for extension

    2. Create tests/e2e/page-objects/login.page.ts:
       - Extends BasePage
       - Locators: loginButton (getByRole button with Login text)
       - Methods:
         - goto(): navigate to /
         - clickLogin(): click login button to open Web3Auth modal
         - Note: Web3Auth modal interaction is complex with iframe - add TODO for auth fixture to handle programmatic auth via API

    3. Create tests/e2e/page-objects/dashboard.page.ts:
       - Extends BasePage
       - Locators:
         - sidebar (getByRole navigation)
         - fileList (getByTestId file-list)
         - folderTree (getByTestId folder-tree)
         - logoutButton (getByRole button with Logout text)
       - Methods:
         - goto(): navigate to /dashboard
         - isLoggedIn(): check if dashboard elements are visible

    4. Create tests/e2e/utils/api-helpers.ts:
       - Function getAuthToken(request: APIRequestContext, credentials: object): Promise<string>
         - POST to /api/auth/web3auth/verify (placeholder - actual auth flow TBD based on Web3Auth test account setup)
       - Function cleanVault(request: APIRequestContext, token: string): Promise<void>
         - TODO: Implement vault cleanup via API (depends on API endpoint availability)
       - Function seedTestFiles(request: APIRequestContext, token: string, files: Array<{name: string}>): Promise<void>
         - TODO: Implement file seeding (depends on API endpoint availability)
       - Note: These are stubs that will be fleshed out as we understand Web3Auth test account flow

    5. Create tests/e2e/fixtures/index.ts:
       - Import base test from @playwright/test
       - Export extended test with fixtures:
         - loginPage: LoginPage instance
         - dashboardPage: DashboardPage instance
       - Export expect from @playwright/test
       - TODO comment for authenticatedPage fixture (requires Web3Auth test account setup)

    6. Create tests/e2e/tests/.gitkeep to ensure directory exists

  </action>
  <verify>
    Check files exist and TypeScript compiles:
    cd tests/e2e && pnpm exec tsc --noEmit
  </verify>
  <done>
    Base page objects and fixtures created. TypeScript compiles without errors. Test framework is ready for specific test files.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add smoke test to verify setup</name>
  <files>
    tests/e2e/tests/smoke.spec.ts
  </files>
  <action>
    1. Create tests/e2e/tests/smoke.spec.ts:
       - Import test and expect from fixtures
       - Single test: "homepage loads and shows login button"
         - Navigate to /
         - Assert login button is visible (getByRole button with Login or Sign in text)
         - Assert page title contains CipherBox or expected text

    2. This smoke test validates:
       - Playwright can launch browser
       - Web server starts successfully
       - Basic page interaction works
       - Locator strategy is correct

    3. Run the smoke test to verify full setup works

  </action>
  <verify>
    pnpm --filter @cipherbox/e2e test tests/smoke.spec.ts
    # Should pass - homepage loads and login button is visible
  </verify>
  <done>
    Smoke test passes. Playwright can launch Chromium, start the web app, navigate to homepage, and interact with page elements.
  </done>
</task>

</tasks>

<verification>
1. pnpm --filter @cipherbox/e2e test -- --list shows available tests
2. pnpm --filter @cipherbox/e2e test tests/smoke.spec.ts passes
3. Running with --headed flag opens visible browser window
4. TypeScript compilation has no errors: cd tests/e2e && pnpm exec tsc --noEmit
</verification>

<success_criteria>

- Playwright installed and configured in tests/e2e workspace
- Base page object pattern established (BasePage, LoginPage, DashboardPage)
- Test fixtures export extended test with page object instances
- Smoke test verifies end-to-end setup works
- Video recording configured for failure cases only
- Chromium-only browser configuration
  </success_criteria>

<output>
After completion, create `.planning/phases/06.1-webapp-automation-testing/06.1-01-SUMMARY.md`
</output>
