---
phase: 06.1-webapp-automation-testing
plan: 07
type: execute
wave: 4
depends_on: ['06.1-06']
files_modified:
  - tools/mock-ipns-routing/package.json
  - tools/mock-ipns-routing/tsconfig.json
  - tools/mock-ipns-routing/src/index.ts
  - tools/mock-ipns-routing/Dockerfile
  - docker/docker-compose.yml
  - .github/workflows/e2e.yml
  - apps/api/.env.example
autonomous: true

must_haves:
  truths:
    - 'E2E tests can publish IPNS records without hitting public DHT'
    - 'Mock service runs in both local Docker and CI environments'
    - 'IPNS sequence number conflicts do not occur in repeated test runs'
    - 'Mock service resets state between test runs'
  artifacts:
    - path: 'tools/mock-ipns-routing/src/index.ts'
      provides: 'Mock delegated routing HTTP server'
      exports: []
    - path: 'tools/mock-ipns-routing/Dockerfile'
      provides: 'Docker image for mock service'
    - path: 'docker/docker-compose.yml'
      provides: 'Docker Compose service definition'
      contains: 'mock-ipns-routing'
  key_links:
    - from: '.github/workflows/e2e.yml'
      to: 'tools/mock-ipns-routing'
      via: 'CI builds and runs mock service before tests'
      pattern: 'mock-ipns-routing'
    - from: 'apps/api/src/ipns/ipns.service.ts'
      to: 'tools/mock-ipns-routing'
      via: 'DELEGATED_ROUTING_URL environment variable'
      pattern: 'DELEGATED_ROUTING_URL'
---

<objective>
Create a mock delegated routing service for E2E testing to resolve IPNS sequence number conflicts.

Purpose: E2E tests fail when run repeatedly because IPNS records are published to the public IPFS DHT at `delegated-ipfs.dev`. The DHT remembers previous sequence numbers, causing "can't replace a newer value with an older value" errors. This mock service provides an in-memory IPNS record store that resets between test runs.

Output:

- Mock delegated routing HTTP service (Fastify)
- Docker Compose integration for local development
- GitHub Actions integration for CI
- Configuration documentation
  </objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.1-webapp-automation-testing/06.1-CONTEXT.md
@.planning/phases/06.1-webapp-automation-testing/06.1-06-SUMMARY.md
@apps/api/src/ipns/ipns.service.ts
@docker/docker-compose.yml
@.github/workflows/e2e.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mock delegated routing service</name>
  <files>
    tools/mock-ipns-routing/package.json
    tools/mock-ipns-routing/tsconfig.json
    tools/mock-ipns-routing/src/index.ts
    tools/mock-ipns-routing/Dockerfile
  </files>
  <action>
    Create a minimal HTTP service that implements the delegated routing API for IPNS:

    1. Create tools/mock-ipns-routing/package.json:
       - Use Fastify for minimal HTTP server
       - TypeScript with ESM modules
       - Scripts: build, start, dev

    2. Create tools/mock-ipns-routing/src/index.ts:
       - GET /health - Health check endpoint
       - PUT /routing/v1/ipns/:name - Store IPNS record (accept binary body)
       - GET /routing/v1/ipns/:name - Retrieve IPNS record
       - POST /reset - Clear all records (for test isolation)
       - Store records in Map<string, Buffer> (in-memory, resets on restart)
       - Accept Content-Type: application/vnd.ipfs.ipns-record

    3. Create Dockerfile:
       - Node 22 Alpine base
       - Build TypeScript
       - Expose port 3001

    Key design decisions:
    - No sequence number validation (allows any publish to succeed)
    - In-memory storage (clean slate each test run)
    - /reset endpoint for explicit test isolation

  </action>
  <verify>
    cd tools/mock-ipns-routing && npm install && npm run build
    node dist/index.js &
    curl http://localhost:3001/health
  </verify>
  <done>
    Mock delegated routing service created with PUT/GET IPNS endpoints and health check.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add mock service to Docker Compose</name>
  <files>
    docker/docker-compose.yml
  </files>
  <action>
    Add mock-ipns-routing service to docker-compose.yml:

    1. Service definition:
       - Build from tools/mock-ipns-routing/Dockerfile
       - Container name: cipherbox-mock-ipns-routing
       - Port: 127.0.0.1:3001:3001 (localhost only)
       - Health check: wget to /health endpoint
       - Environment: HOST=0.0.0.0, PORT=3001, LOG_LEVEL=info

    2. No volume needed (stateless in-memory service)

    3. No dependencies on other services

  </action>
  <verify>
    docker compose -f docker/docker-compose.yml config
    docker compose -f docker/docker-compose.yml build mock-ipns-routing
  </verify>
  <done>
    Mock IPNS routing service added to Docker Compose for local development.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add mock service to CI workflow</name>
  <files>
    .github/workflows/e2e.yml
  </files>
  <action>
    Update GitHub Actions E2E workflow to run mock service:

    1. Add steps after Playwright browser install:
       - Install mock-ipns-routing dependencies (npm install)
       - Build mock service (npm run build)
       - Start mock service in background (node dist/index.js &)
       - Wait for service to be healthy (curl loop)

    2. Add DELEGATED_ROUTING_URL to .env file creation:
       - echo "DELEGATED_ROUTING_URL=http://localhost:3001" >> apps/api/.env

    3. Add DELEGATED_ROUTING_URL to test run environment:
       - DELEGATED_ROUTING_URL: http://localhost:3001

    Note: We build and run the service as a process rather than using
    GitHub Actions service containers because service containers require
    pre-built images from a registry.

  </action>
  <verify>
    cat .github/workflows/e2e.yml | grep -A5 mock-ipns-routing
    cat .github/workflows/e2e.yml | grep DELEGATED_ROUTING_URL
  </verify>
  <done>
    CI workflow updated to build and run mock IPNS routing service before E2E tests.
  </done>
</task>

<task type="auto">
  <name>Task 4: Update configuration documentation</name>
  <files>
    apps/api/.env.example
  </files>
  <action>
    Add DELEGATED_ROUTING_URL to .env.example with documentation:

    1. Add IPFS provider section (if not present):
       # IPFS Provider: 'pinata' (default) or 'local' (Kubo node)
       # IPFS_PROVIDER=local
       # IPFS_LOCAL_API_URL=http://localhost:5001
       # IPFS_LOCAL_GATEWAY_URL=http://localhost:8080

    2. Add delegated routing section:
       # IPNS Delegated Routing URL (defaults to https://delegated-ipfs.dev)
       # For local/E2E testing, use the mock service: http://localhost:3001
       # DELEGATED_ROUTING_URL=http://localhost:3001

  </action>
  <verify>
    cat apps/api/.env.example | grep DELEGATED_ROUTING_URL
  </verify>
  <done>
    Configuration documented in .env.example for both production and test modes.
  </done>
</task>

</tasks>

<verification>
1. Mock service builds and starts successfully
2. Mock service accepts PUT requests to /routing/v1/ipns/:name
3. Mock service returns stored records on GET requests
4. Docker Compose includes mock-ipns-routing service
5. CI workflow starts mock service before tests
6. DELEGATED_ROUTING_URL is configured in CI environment
7. .env.example documents the configuration option
</verification>

<success_criteria>

- Mock service runs on port 3001
- PUT /routing/v1/ipns/:name accepts binary IPNS records
- GET /routing/v1/ipns/:name returns stored records
- POST /reset clears all stored records
- Docker Compose builds and runs the service
- CI workflow starts service before E2E tests
- E2E tests can publish IPNS records without DHT conflicts
  </success_criteria>

<output>
After completion, create `.planning/phases/06.1-webapp-automation-testing/06.1-07-SUMMARY.md`
</output>
