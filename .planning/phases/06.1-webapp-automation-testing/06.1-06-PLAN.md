---
phase: 06.1-webapp-automation-testing
plan: 06
type: execute
wave: 3
depends_on: ['06.1-03', '06.1-04', '06.1-05']
files_modified:
  - .github/workflows/e2e.yml
  - tests/e2e/scripts/setup-auth.ts
  - tests/e2e/global-setup.ts
  - tests/e2e/playwright.config.ts
autonomous: true

must_haves:
  truths:
    - 'E2E tests run in CI on merge to main'
    - 'Test artifacts (video, screenshots) upload on failure'
    - 'CI has access to Postgres and IPFS service containers'
    - 'Auth state is set up before test run'
  artifacts:
    - path: '.github/workflows/e2e.yml'
      provides: 'GitHub Actions workflow for E2E tests'
      contains: 'playwright'
    - path: 'tests/e2e/global-setup.ts'
      provides: 'Playwright global setup for auth'
      exports: ['default']
  key_links:
    - from: '.github/workflows/e2e.yml'
      to: 'tests/e2e/playwright.config.ts'
      via: 'CI runs pnpm --filter @cipherbox/e2e test'
      pattern: 'pnpm.*e2e.*test'
    - from: 'tests/e2e/global-setup.ts'
      to: 'tests/e2e/.auth/user.json'
      via: 'setup creates auth storage state'
      pattern: "storageState.*user\\.json"
---

<objective>
Integrate E2E tests into CI pipeline.

Purpose: Configure GitHub Actions to run E2E tests on merge to main, with proper service containers (Postgres, IPFS Kubo), auth setup, and artifact collection on failure. This ensures regressions are caught before deployment.

Output:

- GitHub Actions workflow for E2E tests
- Global setup script for authentication
- CI-specific configuration updates
- Artifact upload for test reports and videos on failure
  </objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-webapp-automation-testing/06.1-CONTEXT.md
@.planning/phases/06.1-webapp-automation-testing/06.1-RESEARCH.md
@.planning/phases/06.1-webapp-automation-testing/06.1-03-SUMMARY.md
@.planning/phases/06.1-webapp-automation-testing/06.1-04-SUMMARY.md
@.planning/phases/06.1-webapp-automation-testing/06.1-05-SUMMARY.md
@.github/workflows/ci.yml
@tests/e2e/playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create global setup for authentication</name>
  <files>
    tests/e2e/global-setup.ts
    tests/e2e/scripts/setup-auth.ts
    tests/e2e/playwright.config.ts
  </files>
  <action>
    Per RESEARCH.md, Web3Auth testing in CI is complex. Strategy:
    1. Use a dedicated test user account created in Web3Auth Sapphire Devnet
    2. Global setup authenticates once and saves storage state
    3. All tests reuse the saved storage state

    For CI, we have two options:
    a) Use API-based auth if backend supports it (create test token endpoint)
    b) Use programmatic Web3Auth login (complex, requires email verification)
    c) Pre-generate storage state file and commit it (simpler but needs refresh)

    Start with option (a) - create a test-only auth endpoint that bypasses Web3Auth.

    1. Create tests/e2e/scripts/setup-auth.ts:
       - This script creates authenticated storage state
       - For now, implement placeholder that:
         - Checks if TEST_AUTH_BYPASS env var is set
         - If yes, calls a test-only endpoint to get auth token
         - Saves storage state to .auth/user.json
       - TODO: The actual auth setup depends on backend test support

    2. Create tests/e2e/global-setup.ts:
       - Import chromium from @playwright/test
       - Export default async function (globalSetup signature)
       - Launch browser
       - Navigate to app
       - If storage state doesn't exist or is expired:
         - Perform authentication (call setup-auth script logic)
         - Save storage state to tests/e2e/.auth/user.json
       - Close browser
       - Note: This runs once before all tests

    3. Update tests/e2e/playwright.config.ts:
       - Add globalSetup: './global-setup.ts'
       - Configure storageState in projects:
         - Default project uses: './tests/e2e/.auth/user.json'
         - Or use setup project pattern:
           - Project 'setup' runs global setup
           - Project 'chromium' depends on 'setup' and uses its storage state

    4. Ensure .auth directory is gitignored:
       - Add tests/e2e/.auth/ to tests/e2e/.gitignore

    Note: The actual implementation depends on having a test auth mechanism.
    For Phase 6.1, create the infrastructure. The specific auth flow can be
    refined when we understand Web3Auth test account behavior better.

  </action>
  <verify>
    cd tests/e2e && pnpm exec tsc --noEmit
    # Verify global setup compiles and is referenced in config
  </verify>
  <done>
    Global setup infrastructure created. Storage state pattern configured in playwright.config.ts. Auth setup script placeholder ready for test auth implementation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions E2E workflow</name>
  <files>
    .github/workflows/e2e.yml
  </files>
  <action>
    Per CONTEXT.md: Run E2E tests only on merge to main (not on every PR).

    1. Create .github/workflows/e2e.yml:

       name: E2E Tests

       on:
         push:
           branches: [main]
         # Allow manual trigger for testing
         workflow_dispatch:

       jobs:
         e2e:
           name: E2E Tests
           runs-on: ubuntu-latest
           timeout-minutes: 30

           services:
             postgres:
               image: postgres:16-alpine
               env:
                 POSTGRES_USER: postgres
                 POSTGRES_PASSWORD: postgres
                 POSTGRES_DB: cipherbox_test
               ports:
                 - 5432:5432
               options: >-
                 --health-cmd pg_isready
                 --health-interval 10s
                 --health-timeout 5s
                 --health-retries 5

             ipfs:
               image: ipfs/kubo:v0.34.0
               ports:
                 - 5001:5001
                 - 8080:8080
               options: >-
                 --health-cmd "ipfs id"
                 --health-interval 10s
                 --health-timeout 5s
                 --health-retries 10
                 --health-start-period 30s

           steps:
             - uses: actions/checkout@v4

             - uses: pnpm/action-setup@v4
               with:
                 version: 10

             - uses: actions/setup-node@v4
               with:
                 node-version: '22'
                 cache: 'pnpm'

             - name: Install dependencies
               run: pnpm install --frozen-lockfile

             - name: Install Playwright browsers
               run: pnpm --filter @cipherbox/e2e exec playwright install chromium --with-deps

             - name: Build web app
               run: pnpm --filter @cipherbox/web build

             - name: Start API server
               run: |
                 pnpm --filter @cipherbox/api dev &
                 # Wait for API to be ready
                 sleep 10
               env:
                 DB_HOST: localhost
                 DB_PORT: 5432
                 DB_USERNAME: postgres
                 DB_PASSWORD: postgres
                 DB_DATABASE: cipherbox_test
                 NODE_ENV: test
                 IPFS_PROVIDER: local
                 IPFS_LOCAL_API_URL: http://localhost:5001
                 IPFS_LOCAL_GATEWAY_URL: http://localhost:8080

             - name: Run E2E tests
               run: pnpm --filter @cipherbox/e2e test
               env:
                 CI: true
                 # Add any test-specific env vars here
                 # TEST_AUTH_BYPASS: true (if we implement test auth endpoint)

             - name: Upload test artifacts on failure
               if: failure()
               uses: actions/upload-artifact@v4
               with:
                 name: playwright-report
                 path: |
                   tests/e2e/playwright-report/
                   tests/e2e/test-results/
                 retention-days: 7

    Note: The webServer in playwright.config.ts will start the web app.
    The API needs to be started separately since it requires the database.

  </action>
  <verify>
    # Validate workflow syntax
    cat .github/workflows/e2e.yml
    # Check it references correct paths and commands
  </verify>
  <done>
    GitHub Actions E2E workflow created. Runs on merge to main only. Includes Postgres and IPFS service containers. Uploads artifacts on failure.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add test scripts and documentation</name>
  <files>
    tests/e2e/README.md
    package.json
  </files>
  <action>
    1. Update root package.json scripts (if not already done):
       - Ensure "test:e2e": "pnpm --filter @cipherbox/e2e test" exists
       - Add "test:e2e:ci": "pnpm --filter @cipherbox/e2e test" (same, but explicit)

    2. Create tests/e2e/README.md:

       # E2E Tests

       End-to-end tests using Playwright for CipherBox web application.

       ## Setup

       ```bash
       # Install dependencies
       pnpm install

       # Install Playwright browsers
       pnpm --filter @cipherbox/e2e exec playwright install chromium
       ```

       ## Running Tests

       ```bash
       # Run all tests (headless)
       pnpm test:e2e

       # Run with visible browser
       pnpm test:e2e:headed

       # Run specific test file
       pnpm --filter @cipherbox/e2e test tests/auth/login.spec.ts

       # Debug mode (step through tests)
       pnpm --filter @cipherbox/e2e test:debug

       # View last test report
       pnpm --filter @cipherbox/e2e test:report
       ```

       ## Test Structure

       ```
       tests/e2e/
       ├── fixtures/          # Test fixtures (auth, data)
       ├── page-objects/      # Page Object classes
       │   ├── file-browser/  # File browser components
       │   ├── dialogs/       # Dialog components
       │   └── *.page.ts      # Page classes
       ├── tests/             # Test specs
       │   ├── auth/          # Authentication tests
       │   ├── files/         # File operation tests
       │   └── folders/       # Folder operation tests
       ├── utils/             # Helper utilities
       └── playwright.config.ts
       ```

       ## CI Integration

       E2E tests run automatically on merge to main via GitHub Actions.
       See `.github/workflows/e2e.yml` for configuration.

       Test artifacts (screenshots, videos) are uploaded on failure.

       ## Authentication

       Tests use storage state for fast authenticated sessions.
       The global setup creates auth state before tests run.

       For local development, you may need to authenticate manually first
       or set up test credentials in environment variables.

       ## Configuration

       - Browser: Chromium only (per project requirements)
       - Headless: Yes by default, use --headed for debugging
       - Video: Recorded only on failure
       - Retries: None (fix flakiness immediately)

    3. Verify all test commands work:
       - pnpm test:e2e --help
       - pnpm test:e2e:headed --help

  </action>
  <verify>
    cat tests/e2e/README.md
    pnpm test:e2e -- --list
  </verify>
  <done>
    E2E test documentation created with setup instructions, test structure overview, and CI information. All test commands documented and working.
  </done>
</task>

</tasks>

<verification>
1. GitHub Actions workflow syntax is valid
2. CI workflow includes Postgres and IPFS service containers
3. Artifact upload configured for test reports and videos
4. Global setup compiles and is referenced in config
5. README documents how to run tests locally and in CI
6. Test commands work: pnpm test:e2e, pnpm test:e2e:headed
</verification>

<success_criteria>

- E2E workflow triggers on merge to main (not PRs)
- CI has Postgres and IPFS Kubo service containers
- Playwright browsers installed in CI
- API server started before E2E tests
- Test artifacts uploaded on failure
- Global setup infrastructure ready for auth
- Documentation covers local and CI usage
- Manual workflow trigger available for testing
  </success_criteria>

<output>
After completion, create `.planning/phases/06.1-webapp-automation-testing/06.1-06-SUMMARY.md`
</output>
