---
phase: 06.1-webapp-automation-testing
plan: 04
type: execute
wave: 2
depends_on: ['06.1-01', '06.1-02']
files_modified:
  - tests/e2e/tests/files/upload.spec.ts
  - tests/e2e/tests/files/download.spec.ts
  - tests/e2e/tests/files/rename.spec.ts
  - tests/e2e/tests/files/delete.spec.ts
  - tests/e2e/utils/test-files.ts
autonomous: true

must_haves:
  truths:
    - 'File upload test verifies file appears in list after upload'
    - 'File download test verifies file content can be retrieved'
    - 'File rename test verifies name changes in UI'
    - 'File delete test verifies file disappears with confirmation'
  artifacts:
    - path: 'tests/e2e/tests/files/upload.spec.ts'
      provides: 'File upload E2E tests'
      contains: 'test.*upload'
    - path: 'tests/e2e/tests/files/download.spec.ts'
      provides: 'File download E2E tests'
      contains: 'test.*download'
    - path: 'tests/e2e/tests/files/rename.spec.ts'
      provides: 'File rename E2E tests'
      contains: 'test.*rename'
    - path: 'tests/e2e/tests/files/delete.spec.ts'
      provides: 'File delete E2E tests'
      contains: 'test.*delete'
  key_links:
    - from: 'tests/e2e/tests/files/upload.spec.ts'
      to: 'tests/e2e/page-objects/file-browser/upload-zone.page.ts'
      via: 'uses UploadZonePage for file upload'
      pattern: 'uploadZone.*upload'
    - from: 'tests/e2e/tests/files/rename.spec.ts'
      to: 'tests/e2e/page-objects/file-browser/context-menu.page.ts'
      via: 'uses ContextMenuPage for rename action'
      pattern: 'contextMenu.*rename'
---

<objective>
Create E2E tests for file operations.

Purpose: Validate complete file lifecycle including upload with encryption, download with decryption, rename via context menu, and delete with confirmation. These tests ensure the core file operations work correctly through the UI.

Output:

- Upload test suite covering drag-drop and file input
- Download test suite verifying decrypted content
- Rename test suite via context menu
- Delete test suite with confirmation dialog
- Test file utilities for creating test content
  </objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-webapp-automation-testing/06.1-CONTEXT.md
@.planning/phases/06.1-webapp-automation-testing/06.1-RESEARCH.md
@.planning/phases/06.1-webapp-automation-testing/06.1-01-SUMMARY.md
@.planning/phases/06.1-webapp-automation-testing/06.1-02-SUMMARY.md
@apps/web/src/components/file-browser/UploadZone.tsx
@apps/web/src/components/file-browser/UploadModal.tsx
@apps/web/src/hooks/useFileUpload.ts
@apps/web/src/hooks/useFileDownload.ts
@apps/web/src/hooks/useFileDelete.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test file utilities and upload tests</name>
  <files>
    tests/e2e/utils/test-files.ts
    tests/e2e/tests/files/upload.spec.ts
  </files>
  <action>
    1. Create tests/e2e/utils/test-files.ts:
       - Import faker from @faker-js/faker
       - Import fs and path from node (for reading test fixtures)

       Functions:
       - createTestTextFile(name?: string): { name: string; content: string; path: string }
         - Generate random text content
         - Write to tests/e2e/fixtures/files/{name}.txt (temp file)
         - Return file info
       - createTestBinaryFile(sizeKb: number): { name: string; path: string }
         - Generate random binary data
         - Write to temp file
         - Return file info
       - cleanupTestFiles(): void
         - Remove all files in fixtures/files directory
       - getTestFilePath(name: string): string
         - Return absolute path to test file

       Also create tests/e2e/fixtures/files/.gitkeep

    2. Create tests/e2e/tests/files/upload.spec.ts:

       Import authenticatedTest from auth fixture
       Import page objects: FileListPage, UploadZonePage
       Import test file utilities

       test.describe('File Upload'):

       test.beforeEach:
       - Create a test file
       - Clean vault if possible (via API helper or fixture)

       test.afterEach:
       - Cleanup test files

       Tests:
       a) "can upload a text file via file input":
          - Use authenticatedPage fixture
          - Get FileListPage and UploadZonePage
          - Use uploadZone.uploadFile(testFilePath)
          - Wait for upload modal to appear
          - Wait for upload to complete (progress indicator disappears)
          - Assert file appears in file list

       b) "uploaded file shows correct name":
          - Upload a file with specific name
          - Assert file list shows that exact name

       c) "upload progress is shown":
          - Upload a larger file (e.g., 1MB)
          - Assert upload modal/progress indicator is visible during upload
          - Wait for completion

       d) "can cancel upload in progress" (if cancel is supported):
          - Start uploading a large file
          - Click cancel button
          - Assert upload is cancelled
          - Assert file does not appear in list

       e) "upload shows error for files over 100MB limit":
          - Create a test file over 100MB (or mock this if too slow)
          - Attempt to upload
          - Assert error message about size limit

       f) "can upload multiple files sequentially" (per CONTEXT.md - sequential uploads):
          - Create two test files
          - Upload first file, wait for completion
          - Upload second file, wait for completion
          - Assert both files appear in list

  </action>
  <verify>
    pnpm --filter @cipherbox/e2e test tests/files/upload.spec.ts
  </verify>
  <done>
    Test file utilities and upload tests created. Tests verify file input upload, progress display, and file appearance in list.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create download and rename tests</name>
  <files>
    tests/e2e/tests/files/download.spec.ts
    tests/e2e/tests/files/rename.spec.ts
  </files>
  <action>
    1. Create tests/e2e/tests/files/download.spec.ts:

       Import authenticatedTest and page objects
       Import test file utilities

       test.describe('File Download'):

       test.beforeEach:
       - Create and upload a test file
       - Or seed via API if fixture supports it

       Tests:
       a) "can download file via context menu":
          - Right-click on file in list
          - Assert context menu opens
          - Click download option
          - Wait for download to start
          - Use page.on('download') to capture download
          - Assert download filename matches

       b) "downloaded file has correct content":
          - Upload a file with known content
          - Download the file
          - Read downloaded file content
          - Assert content matches original (decryption works)

       c) "download progress is shown" (if progress indicator exists):
          - Start download of larger file
          - Assert progress indicator visible
          - Wait for completion

       d) "download can be triggered by double-click" (if supported):
          - Double-click on file item
          - Assert download starts OR file preview opens
          - (Depends on how the app handles double-click on files)

    2. Create tests/e2e/tests/files/rename.spec.ts:

       Import authenticatedTest and page objects
       Import test file utilities

       test.describe('File Rename'):

       test.beforeEach:
       - Upload a test file with known name

       Tests:
       a) "can rename file via context menu":
          - Right-click on file
          - Click rename option
          - Assert rename dialog opens
          - Enter new name
          - Click save
          - Assert dialog closes
          - Assert file appears with new name
          - Assert old name no longer in list

       b) "rename dialog shows current name":
          - Open rename dialog
          - Assert input contains current filename

       c) "can cancel rename":
          - Open rename dialog
          - Enter new name
          - Click cancel
          - Assert dialog closes
          - Assert file still has original name

       d) "rename validates empty name":
          - Open rename dialog
          - Clear input (empty name)
          - Assert save button disabled OR error shown
          - (Depends on validation implementation)

       e) "rename preserves file extension" (if extension handling exists):
          - Rename "test.txt" to "newname"
          - Assert file becomes "newname.txt" OR "newname"
          - (Depends on extension handling logic)

  </action>
  <verify>
    pnpm --filter @cipherbox/e2e test tests/files/download.spec.ts tests/files/rename.spec.ts
  </verify>
  <done>
    Download and rename tests created. Download tests verify decrypted content. Rename tests verify context menu flow and dialog interaction.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create delete tests</name>
  <files>
    tests/e2e/tests/files/delete.spec.ts
  </files>
  <action>
    1. Create tests/e2e/tests/files/delete.spec.ts:

       Import authenticatedTest and page objects
       Import test file utilities

       test.describe('File Delete'):

       test.beforeEach:
       - Upload a test file

       Tests:
       a) "can delete file via context menu":
          - Right-click on file
          - Click delete option
          - Assert confirmation dialog opens
          - Assert dialog mentions the file name
          - Click confirm
          - Assert dialog closes
          - Assert file no longer in list

       b) "delete confirmation shows file name":
          - Open delete confirmation for a file
          - Assert dialog message contains the filename
          - Cancel to close

       c) "can cancel delete":
          - Right-click and click delete
          - Assert dialog opens
          - Click cancel
          - Assert dialog closes
          - Assert file still in list

       d) "deleted file does not reappear on refresh":
          - Delete a file and confirm
          - Reload page
          - Assert file is still not in list
          - (Verifies IPFS unpin and metadata update)

       e) "can delete multiple files one by one":
          - Upload two test files
          - Delete first file
          - Assert first file gone, second still there
          - Delete second file
          - Assert both files gone

    2. Add test cleanup:
       - Ensure test files are created fresh each test
       - Handle case where vault might have leftover files from previous failed tests

  </action>
  <verify>
    pnpm --filter @cipherbox/e2e test tests/files/delete.spec.ts
  </verify>
  <done>
    Delete tests created covering confirmation dialog, cancel flow, and persistence verification. Tests ensure files are properly removed from both UI and storage.
  </done>
</task>

</tasks>

<verification>
1. pnpm --filter @cipherbox/e2e test tests/files/ runs all file operation tests
2. Upload tests verify file appears in list after upload
3. Download tests verify file content matches original (decryption works)
4. Rename tests verify name change via context menu and dialog
5. Delete tests verify file removal with confirmation
6. All tests use authenticated fixture for session
</verification>

<success_criteria>

- File upload works via file input (setInputFiles)
- Uploaded files appear in file list with correct name
- Downloaded files have decrypted content matching original
- File rename works via context menu and rename dialog
- File delete shows confirmation and removes file from list
- Deleted files stay deleted after page refresh
- Test file utilities create/cleanup temp files
  </success_criteria>

<output>
After completion, create `.planning/phases/06.1-webapp-automation-testing/06.1-04-SUMMARY.md`
</output>
