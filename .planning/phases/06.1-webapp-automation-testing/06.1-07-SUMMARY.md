---
phase: 06.1-webapp-automation-testing
plan: 07
status: complete
completed: 2026-01-22
commit: pending
---

# Plan 06.1-07 Summary: Mock Delegated Routing Service

## What Was Done

Created a mock delegated routing service to resolve IPNS sequence number conflicts in E2E tests. The service provides an in-memory IPNS record store that resets between test runs, eliminating conflicts with the public IPFS DHT.

## Files Created

| File                                    | Purpose                                       |
| --------------------------------------- | --------------------------------------------- |
| `tools/mock-ipns-routing/package.json`  | Package configuration with Fastify dependency |
| `tools/mock-ipns-routing/tsconfig.json` | TypeScript configuration for ESM              |
| `tools/mock-ipns-routing/src/index.ts`  | Mock HTTP server with IPNS endpoints          |
| `tools/mock-ipns-routing/Dockerfile`    | Docker image for containerized deployment     |

## Files Modified

| File                        | Change                                                                  |
| --------------------------- | ----------------------------------------------------------------------- |
| `docker/docker-compose.yml` | Added mock-ipns-routing service                                         |
| `.github/workflows/e2e.yml` | Added steps to build/run mock service, configured DELEGATED_ROUTING_URL |
| `apps/api/.env.example`     | Documented IPFS provider and delegated routing configuration            |

## Key Implementation Details

### Mock Service Endpoints

- `GET /health` - Health check (returns record count)
- `PUT /routing/v1/ipns/:name` - Store IPNS record (binary body)
- `GET /routing/v1/ipns/:name` - Retrieve IPNS record
- `POST /reset` - Clear all records (for test isolation)

### Design Decisions

1. **No sequence number validation** - Allows any publish to succeed, preventing conflicts
2. **In-memory storage** - Clean slate each test run (no persistence)
3. **Fastify framework** - Minimal, fast HTTP server
4. **Standalone tool** - Not part of pnpm workspace (uses npm directly in CI)

### Integration Points

- **Local development**: `docker compose up mock-ipns-routing`
- **CI**: Built and run as background process before E2E tests
- **API configuration**: `DELEGATED_ROUTING_URL=http://localhost:3001`

## Problem Solved

E2E tests previously failed with:

```
[IpnsService] Delegated routing returned 500: can't replace a newer value with an older value
```

This occurred because:

1. IPNS records were published to the public DHT at `delegated-ipfs.dev`
2. The test account's IPNS name is deterministic (derived from Web3Auth keypair)
3. Repeated test runs caused sequence number conflicts

The mock service stores records in-memory without sequence validation, allowing unlimited test runs.

## Verification

- [ ] `docker compose build mock-ipns-routing` succeeds
- [ ] `docker compose up mock-ipns-routing` starts service on port 3001
- [ ] `curl http://localhost:3001/health` returns `{"status":"ok"}`
- [ ] CI workflow syntax is valid
- [ ] E2E tests run without IPNS sequence conflicts

## Next Steps

1. Run E2E tests locally with mock service to verify fix
2. Merge to main and verify CI passes
3. Remove `temp/IPNS-SEQUENCE-ISSUE.md` (issue resolved)
