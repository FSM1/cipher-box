---
phase: 12.4-mfa-cross-device
plan: 04
subsystem: ui
tags: [react, mfa, cross-device, ecies, secp256k1, polling, bulletin-board, zustand]

# Dependency graph
requires:
  - phase: 12.4-mfa-cross-device-01
    provides: Bulletin board REST API (5 endpoints for device approval)
  - phase: 12.4-mfa-cross-device-02
    provides: useMfa hook, REQUIRED_SHARE login branching, completeRequiredShare(), temp auth

provides:
  - deviceApprovalApi service (5 API methods with auto-auth)
  - useDeviceApproval hook (requester + approver lifecycle)
  - DeviceWaitingScreen (new device waiting with countdown)
  - RecoveryInput (24-word mnemonic input form)
  - DeviceApprovalModal (existing device approve/deny modal)
  - MfaEnrollmentPrompt (dismissable post-login MFA banner)
  - Login.tsx REQUIRED_SHARE state handling

affects:
  - 12.4-05 (integration testing, API client generation)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Ephemeral secp256k1 keypair for ECIES cross-device key exchange
    - Visibility-based polling pause/resume for background tab efficiency
    - Zero-fill ephemeral private keys after use (security)
    - Cancel approval request on recovery (race condition prevention)
    - localStorage dismissal keyed by user email for cross-session persistence

key-files:
  created:
    - apps/web/src/services/device-approval.service.ts
    - apps/web/src/hooks/useDeviceApproval.ts
    - apps/web/src/components/mfa/DeviceWaitingScreen.tsx
    - apps/web/src/components/mfa/RecoveryInput.tsx
    - apps/web/src/components/mfa/DeviceApprovalModal.tsx
    - apps/web/src/components/mfa/MfaEnrollmentPrompt.tsx
  modified:
    - apps/web/src/routes/Login.tsx
    - apps/web/src/components/layout/AppShell.tsx
    - apps/web/src/App.css

key-decisions:
  - 'secp256k1.keygen() for ephemeral keypair generation (v3 API)'
  - 'MFA prompt dismissal persisted in localStorage by user email'
  - 'DeviceApprovalModal mounted in AppShell (visible on all auth pages)'
  - 'MfaEnrollmentPrompt mounted in AppShell between header and sidebar'
  - 'Login.tsx extracted LoginFooter component to avoid duplication'

patterns-established:
  - 'Cross-device ECIES flow: ephemeral keypair -> bulletin board -> wrapKey/unwrapKey'
  - 'Approval request lifecycle: create -> poll 3s -> approved/denied/expired'
  - 'Pending request polling: 5s interval, paused when tab hidden'
  - 'MFA enrollment prompt: check store + localStorage for dismissal'

# Metrics
duration: 9min
completed: 2026-02-15
---

# Phase 12.4 Plan 04: Cross-Device Approval Flow UI + Recovery Input + MFA Enrollment Prompt

Device approval API client, useDeviceApproval hook with ECIES ephemeral key exchange, DeviceWaitingScreen with countdown timer, RecoveryInput for 24-word mnemonic, DeviceApprovalModal with approve/deny on existing devices, MfaEnrollmentPrompt banner, Login.tsx REQUIRED_SHARE integration, and AppShell mounting.

## Performance

- **Duration:** 9 min
- **Started:** 2026-02-15T00:52:47Z
- **Completed:** 2026-02-15T01:02:04Z
- **Tasks:** 3
- **Files modified:** 9

## Accomplishments

- Complete cross-device approval flow: new device creates ephemeral keypair, posts to bulletin board, polls for approval; existing device sees modal with approve/deny buttons, ECIES-encrypts factor key
- Recovery phrase input as fallback: 24-word mnemonic textarea with validation, cancels pending approval on successful recovery (Pitfall 5 prevention)
- Login.tsx properly branches on REQUIRED_SHARE: shows DeviceWaitingScreen or RecoveryInput instead of login form
- DeviceApprovalModal and MfaEnrollmentPrompt mounted in AppShell for all authenticated pages
- All ephemeral private keys zero-filled after use (security)
- CSS for all 6 new component types added with terminal aesthetic (spinners, countdown timers, red warnings, green borders)

## Task Commits

Each task was committed atomically:

1. **Task 1: Device approval API client + useDeviceApproval hook** - `90d245ab9` (feat)
2. **Task 2a: DeviceWaitingScreen, RecoveryInput, Login.tsx integration** - `c62de450b` (feat)
3. **Task 2b: DeviceApprovalModal, MfaEnrollmentPrompt, AppShell mount** - `a5da647f7` (feat)

## Files Created/Modified

- `apps/web/src/services/device-approval.service.ts` - 5 API methods using apiClient with automatic auth headers
- `apps/web/src/hooks/useDeviceApproval.ts` - Full lifecycle for requester (create, poll, receive, cancel) and approver (poll pending, approve, deny) sides
- `apps/web/src/components/mfa/DeviceWaitingScreen.tsx` - Full-screen waiting with spinner, 5-minute countdown, recovery fallback, retry on deny/expire
- `apps/web/src/components/mfa/RecoveryInput.tsx` - 24-word mnemonic textarea with validation, cancels pending approval
- `apps/web/src/components/mfa/DeviceApprovalModal.tsx` - Modal overlay with device details, countdown, warning, --approve/--deny buttons
- `apps/web/src/components/mfa/MfaEnrollmentPrompt.tsx` - Dismissable banner with --setup-mfa linking to Settings, localStorage persistence
- `apps/web/src/routes/Login.tsx` - REQUIRED_SHARE state renders MFA challenge UI, extracted LoginFooter
- `apps/web/src/components/layout/AppShell.tsx` - Mounts DeviceApprovalModal and MfaEnrollmentPrompt
- `apps/web/src/App.css` - CSS for device-waiting, recovery-input, device-approval, mfa-prompt classes

## Decisions Made

- **secp256k1.keygen() for ephemeral keypair:** Noble secp256k1 v3 API uses keygen() returning { secretKey, publicKey } instead of v2's utils.randomPrivateKey()
- **MFA prompt dismissal by email:** localStorage key is `cipherbox_mfa_prompt_dismissed_{email}` for cross-session persistence, with fallback to 'default' for wallet users without email
- **AppShell mounting position:** MfaEnrollmentPrompt placed between AppHeader and AppSidebar (compact banner at top), DeviceApprovalModal placed after AppFooter (fixed overlay)
- **LoginFooter extraction:** Extracted shared footer component to avoid three copies of the same footer JSX in Login.tsx

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Plan 03 uncommitted files restored via lint-staged stash**

- **Found during:** Task 2a (build verification)
- **Issue:** Several Plan 03 files (SecurityTab, AuthorizedDevices, RecoveryPhraseSection, Settings.tsx, useMfa.ts additionalMetadata fix) were left uncommitted by the Plan 03 agent. They were restored from git stash during lint-staged's backup/restore cycle and automatically included in commits.
- **Fix:** Files verified correct and included in commits
- **Files affected:** AuthorizedDevices.tsx, RecoveryPhraseSection.tsx, SecurityTab.tsx, Settings.tsx, useMfa.ts
- **Impact:** Plan 03 files are now committed alongside Plan 04 work

**2. [Rule 1 - Bug] Removed invalid eslint-disable-next-line rule**

- **Found during:** Task 2a commit (pre-commit hook)
- **Issue:** `react-hooks/exhaustive-deps` rule does not exist in the project's eslint config (no react-hooks plugin), causing eslint to fail with "Definition for rule was not found"
- **Fix:** Removed the eslint-disable comment since the rule isn't configured
- **Files modified:** DeviceWaitingScreen.tsx
- **Committed in:** c62de450b (Task 2a commit)

---

**Total deviations:** 2 auto-fixed (1 blocking, 1 bug)
**Impact on plan:** Both fixes necessary for correct operation. Plan 03 file inclusion is cosmetic (commit attribution); eslint fix was essential for commit hook.

## Issues Encountered

- lint-staged stash/unstash mechanism during pre-commit hooks can pick up uncommitted changes from other plan executions. This is the same behavior noted in Plan 02 summary. The files were correct so no action was needed beyond verification.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Full cross-device approval flow UI is ready for end-to-end testing
- Plan 05 should run `pnpm api:generate` to replace manual apiClient calls with typed generated client
- Recovery input flow can be tested by clearing Core Kit localStorage on a device with MFA enabled
- DeviceApprovalModal polling is gated on isAuthenticated + isMfaEnabled, so it won't interfere with non-MFA users

---

_Phase: 12.4-mfa-cross-device_
_Completed: 2026-02-15_
