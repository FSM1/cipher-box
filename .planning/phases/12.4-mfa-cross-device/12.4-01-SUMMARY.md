---
phase: 12.4-mfa-cross-device
plan: 01
subsystem: api
tags: [nestjs, typeorm, rest, bulletin-board, device-approval, cross-device]

# Dependency graph
requires:
  - phase: 12-corekit-foundation
    provides: JWT auth guard, user entity, module registration patterns
  - phase: 12.2-device-registry
    provides: device identity (Ed25519 keys, device IDs)
provides:
  - DeviceApproval entity and TypeORM table
  - 5 bulletin board REST endpoints for cross-device factor transfer
  - OpenAPI spec with device-approval endpoints
affects:
  - 12.4-02 (MFA enrollment hook uses bulletin board for cross-device)
  - 12.4-03 (frontend device approval UI calls these endpoints)
  - 12.4-04 (settings security tab shows pending approvals)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Bulletin board polling pattern for cross-device communication
    - 5-minute TTL with auto-expiry on read
    - ParseUUIDPipe for route parameter validation

key-files:
  created:
    - apps/api/src/device-approval/device-approval.entity.ts
    - apps/api/src/device-approval/device-approval.service.ts
    - apps/api/src/device-approval/device-approval.controller.ts
    - apps/api/src/device-approval/device-approval.module.ts
    - apps/api/src/device-approval/dto/create-approval.dto.ts
    - apps/api/src/device-approval/dto/respond-approval.dto.ts
  modified:
    - apps/api/src/app.module.ts
    - apps/api/scripts/generate-openapi.ts
    - packages/api-client/openapi.json

key-decisions:
  - 'Auto-expire on read: pending requests past TTL are marked expired on getStatus rather than background cron'
  - 'ParseUUIDPipe on requestId params for input validation at route level'
  - 'cancel() uses repo.remove() (hard delete) rather than status change since cancelled requests have no value'

patterns-established:
  - 'Bulletin board pattern: create -> poll status -> list pending -> respond -> cancel'
  - '5-minute TTL enforcement on read rather than scheduled cleanup'

# Metrics
duration: 8min
completed: 2026-02-15
---

# Phase 12.4 Plan 01: Bulletin Board API Summary

Cross-device factor transfer bulletin board API with 5 REST endpoints, DeviceApproval entity, and 5-minute TTL auto-expiry.

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-15T00:28:58Z
- **Completed:** 2026-02-15T00:37:06Z
- **Tasks:** 2
- **Files modified:** 9

## Accomplishments

- DeviceApproval TypeORM entity with all columns (userId, deviceId, deviceName, ephemeralPublicKey, status, encryptedFactorKey, expiresAt, respondedBy)
- 5 JWT-protected REST endpoints: POST /request, GET /status, GET /pending, POST /respond, DELETE /cancel
- Auto-expiry of pending requests on read (no background cron needed)
- DTOs with class-validator constraints including hex validation for crypto keys
- OpenAPI spec updated with all device-approval endpoints

## Task Commits

Each task was committed atomically:

1. **Task 1: DeviceApproval entity + DTOs** - `a244afe4a` (feat)
2. **Task 2: DeviceApproval service, controller, and module** - `c4c8b671d` (feat)

**OpenAPI generator fix:** `614504ad5` (chore)

## Files Created/Modified

- `apps/api/src/device-approval/device-approval.entity.ts` - TypeORM entity for device_approvals table
- `apps/api/src/device-approval/device-approval.service.ts` - CRUD service with TTL enforcement
- `apps/api/src/device-approval/device-approval.controller.ts` - 5 REST endpoints with Swagger docs
- `apps/api/src/device-approval/device-approval.module.ts` - NestJS module wiring
- `apps/api/src/device-approval/dto/create-approval.dto.ts` - Input validation for approval requests
- `apps/api/src/device-approval/dto/respond-approval.dto.ts` - Input validation for approve/deny with conditional encryptedFactorKey
- `apps/api/src/app.module.ts` - Added DeviceApprovalModule import and DeviceApproval entity
- `apps/api/scripts/generate-openapi.ts` - Added DeviceApprovalController to OpenAPI generator
- `packages/api-client/openapi.json` - Regenerated with device-approval endpoints

## Decisions Made

- **Auto-expire on read:** Pending requests past TTL are marked expired when polled via getStatus, rather than using a background cron job. This is simpler and sufficient since the 5-minute TTL is short.
- **ParseUUIDPipe on route params:** Added UUID validation at the route level for requestId parameters to reject invalid IDs early.
- **Hard delete on cancel:** cancel() removes the row entirely rather than changing status, since cancelled requests have no audit value and the 5-minute TTL keeps the table small anyway.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] OpenAPI generator did not include device-approval endpoints**

- **Found during:** Task 2 verification
- **Issue:** The generate-openapi.ts script uses a minimal module with manually listed controllers. The new DeviceApprovalController was not registered, so openapi.json had no device-approval endpoints.
- **Fix:** Added DeviceApprovalController, DeviceApprovalService mock, and device-approval tag to generate-openapi.ts, then regenerated the spec.
- **Files modified:** apps/api/scripts/generate-openapi.ts, packages/api-client/openapi.json
- **Verification:** openapi.json now contains all 5 device-approval endpoint paths
- **Committed in:** 614504ad5

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Essential fix for API client generation. No scope creep.

## Issues Encountered

- lint-staged stash/unstash during pre-commit hook caused openapi.json to be dropped from staged files. Required a separate commit to include the OpenAPI generator update and regenerated spec. This is a known quirk of the pre-commit workflow when files change between staging and commit.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Bulletin board API is ready for frontend integration in Plans 03-04
- The orval client generator does not yet have a device-approval tag mapping -- the frontend will need to either add orval config or use the API client directly
- All 467 existing API tests continue to pass (no regressions)

---

_Phase: 12.4-mfa-cross-device_
_Completed: 2026-02-15_
