---
phase: 12.4-mfa-cross-device
plan: 03
type: execute
wave: 2
depends_on: ['12.4-01', '12.4-02']
files_modified:
  - apps/web/src/components/mfa/MfaEnrollmentWizard.tsx
  - apps/web/src/components/mfa/RecoveryPhraseGrid.tsx
  - apps/web/src/components/mfa/SecurityTab.tsx
  - apps/web/src/components/mfa/AuthorizedDevices.tsx
  - apps/web/src/components/mfa/RecoveryPhraseSection.tsx
  - apps/web/src/routes/Settings.tsx
autonomous: true

must_haves:
  truths:
    - 'User can enable MFA from Settings > Security tab via a step-by-step wizard'
    - 'Recovery phrase is displayed as a 4-column, 24-word numbered grid'
    - 'User must check a terminal-style [x] acknowledgment before proceeding'
    - 'Settings Security tab shows MFA status badge, authorized devices, and recovery phrase management'
    - 'User can revoke a device (not the current one) from the Security tab'
    - 'User can regenerate their recovery phrase from Settings'
  artifacts:
    - path: 'apps/web/src/components/mfa/MfaEnrollmentWizard.tsx'
      provides: 'Step-by-step MFA enrollment wizard (explain -> show phrase -> confirm)'
      min_lines: 80
    - path: 'apps/web/src/components/mfa/RecoveryPhraseGrid.tsx'
      provides: '4-column, 24-word numbered grid display'
      min_lines: 30
    - path: 'apps/web/src/components/mfa/SecurityTab.tsx'
      provides: 'Settings Security tab with MFA status, devices, recovery section'
      min_lines: 60
    - path: 'apps/web/src/components/mfa/AuthorizedDevices.tsx'
      provides: 'Device list with current/authorized tags and revoke action'
      min_lines: 40
    - path: 'apps/web/src/components/mfa/RecoveryPhraseSection.tsx'
      provides: 'Recovery phrase status and regenerate button'
      min_lines: 30
  key_links:
    - from: 'apps/web/src/components/mfa/MfaEnrollmentWizard.tsx'
      to: 'apps/web/src/hooks/useMfa.ts'
      via: 'enableMfa() call'
      pattern: 'enableMfa'
    - from: 'apps/web/src/components/mfa/SecurityTab.tsx'
      to: 'apps/web/src/hooks/useMfa.ts'
      via: 'checkMfaStatus(), getFactors()'
      pattern: 'useMfa'
    - from: 'apps/web/src/routes/Settings.tsx'
      to: 'apps/web/src/components/mfa/SecurityTab.tsx'
      via: 'tab rendering'
      pattern: 'SecurityTab'
---

<objective>
Build the MFA enrollment wizard and Settings Security tab UI.

Purpose: Users need a guided enrollment flow to enable MFA (showing recovery phrase, confirming acknowledgment) and a management interface to view/revoke devices and regenerate recovery phrases. This is the primary MFA user experience.

Output: MfaEnrollmentWizard, RecoveryPhraseGrid, SecurityTab, AuthorizedDevices, RecoveryPhraseSection components, plus Settings.tsx updated with tab navigation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.4-mfa-cross-device/12.4-CONTEXT.md (design direction, mockup references)
@.planning/phases/12.4-mfa-cross-device/12.4-02-SUMMARY.md (useMfa hook API, mfa.store.ts)
@apps/web/src/routes/Settings.tsx (current settings page with LinkedMethods)
@apps/web/src/components/auth/LinkedMethods.tsx (existing tab content pattern)
@apps/web/src/hooks/useMfa.ts (created in Plan 02)
@apps/web/src/stores/mfa.store.ts (created in Plan 02)
@designs/cipher-box-design.pen (Pencil design -- Drafts Phase 12.4 area, frames Yk5eA, wxqZA)
</context>

<tasks>

<task type="auto">
  <name>Task 1: RecoveryPhraseGrid + MfaEnrollmentWizard</name>
  <files>
    apps/web/src/components/mfa/RecoveryPhraseGrid.tsx
    apps/web/src/components/mfa/MfaEnrollmentWizard.tsx
  </files>
  <action>
**RecoveryPhraseGrid** (`RecoveryPhraseGrid.tsx`):
Props: `words: string[]` (24 words).
Renders a 4-column grid of numbered words. Each cell shows: number (dimmed green) + word (bright green).
- Use CSS grid: `grid-template-columns: repeat(4, 1fr)` with gap
- Each word cell: monospace font, numbered 1-24 left-padded
- Container has a border matching the terminal aesthetic (`border: 1px solid` with muted green)
- The grid is read-only, non-selectable (but allow copy-paste of words -- do NOT use `user-select: none`)
- Match the Pencil mockup (Frame Yk5eA): numbered grid with dark background

**MfaEnrollmentWizard** (`MfaEnrollmentWizard.tsx`):
Props: `onComplete: () => void`, `onCancel: () => void`.
Uses `useMfa()` hook.

Three steps:

1. **Step 1: Explain MFA** -- Brief explanation of what MFA does, that it's one-way (cannot be disabled), and what happens next. Show `--continue` button.

2. **Step 2: Recovery Phrase** -- Call `enableMfa()` on entering this step (show loading spinner during). Once returned:
   - Display the 24-word mnemonic using `RecoveryPhraseGrid`
   - Red warning box (`border: 1px solid #EF4444`, matching CONTEXT.md): "If you lose this phrase and all your devices, your account CANNOT be recovered"
   - Terminal-style checkbox: `[x]` / `[ ]` clickable element (NOT native HTML checkbox -- per CONTEXT.md). Text: "I have written down and safely stored my recovery phrase"
   - `--continue` button disabled until checkbox is checked
   - `--back` button (warning: going back does NOT undo MFA -- it's already enabled)

3. **Step 3: Success** -- Confirmation that MFA is enabled. Show factor count. `--done` button calls `onComplete()`.

Step indicator at top: "Step N of 3" with 3-segment progress bar (green `#00D084` for complete, dark for pending) -- matching Pencil mockup.

Navigation buttons use terminal aesthetic: `--back` / `--continue` / `--done` labels.

Error handling: If `enableMfa()` throws (e.g., MFA already enabled), show error message in step 2 and allow retry or cancel.

IMPORTANT: The `[ ]` / `[x]` checkbox must be a clickable div with role="checkbox", aria-checked, tabIndex={0}, and onKeyDown for Space/Enter (per web app CLAUDE.md accessibility rules). Style with monospace font, green color when checked.
</action>
<verify>
`cd /Users/michael/Code/cipher-box && pnpm --filter web build` compiles. Visually inspect by temporarily rendering `<MfaEnrollmentWizard onComplete={console.log} onCancel={console.log} />` in a test route.
</verify>
<done>MfaEnrollmentWizard renders 3 steps with proper navigation. RecoveryPhraseGrid shows 24 words in 4-column numbered layout. Terminal-style checkbox works with keyboard accessibility.</done>
</task>

<task type="auto">
  <name>Task 2: SecurityTab + AuthorizedDevices + RecoveryPhraseSection + Settings tabs</name>
  <files>
    apps/web/src/components/mfa/SecurityTab.tsx
    apps/web/src/components/mfa/AuthorizedDevices.tsx
    apps/web/src/components/mfa/RecoveryPhraseSection.tsx
    apps/web/src/routes/Settings.tsx
  </files>
  <action>
**AuthorizedDevices** (`AuthorizedDevices.tsx`):
Uses `useMfa()` hook for `getFactors()` and `deleteFactor()`.
Uses `useDeviceRegistryStore` for device metadata (device names, last active).

Display a table/list with columns: DEVICE, LAST ACTIVE, ACTION (matching Pencil mockup Frame wxqZA).

- Each row shows: device name (e.g., "Chrome on macOS"), last active timestamp, status tag
- Current device gets `[CURRENT]` tag in green
- Other authorized devices get `[AUTHORIZED]` tag
- `--revoke` button (red text, `#EF4444`) on non-current devices
- Revoke calls `deleteFactor(factorPubHex)` with confirmation dialog
- Show warning if trying to revoke would leave fewer than 2 factors (the SDK enforces this, but show UX warning proactively)
- If no factors loaded yet, show loading skeleton

**Factor-to-device matching algorithm:** Core Kit factors (from `getKeyDetails().shareDescriptions`) are keyed by factor public key hex. Each value is an array of JSON-encoded description strings. Parse each description to extract:

1. `module` field: identifies factor type ('deviceShare', 'seedPhrase', 'hashedShare', etc.)
2. `additionalMetadata` field: may contain `browserName`, `deviceName`, etc. (set during `createFactor()`)

To match factors to device registry entries:

- For each factor with `module === 'deviceShare'`, check `additionalMetadata` for a `deviceId` field (we set this in Plan 04 during `createFactor()`)
- If `additionalMetadata.deviceId` exists, match against `useDeviceRegistryStore` entries by deviceId to get the friendly name and last active time
- If no `deviceId` in metadata (factors created before this phase), show "Unknown device" with the factor's creation date
- For the CURRENT device: use `useMfa().getCurrentFactorKey()` to get the current factor's public key, compare against the factor list to tag one row as `[CURRENT]`
- For `module === 'seedPhrase'` factors: do NOT show in the device list (these are recovery phrases, shown in RecoveryPhraseSection)
- For `module === 'hashedShare'` factors: do NOT show (this is the cloud custodial key, which is deleted by enableMFA)

**RecoveryPhraseSection** (`RecoveryPhraseSection.tsx`):
Uses `useMfa()` hook for `regenerateRecoveryPhrase()` and `getFactors()`.

Shows:

- Recovery phrase status: "Active" with green dot (if recovery factor exists in factors list, detected by module='seedPhrase')
- `--regenerate` button
- When clicked: confirmation warning ("This will invalidate your current recovery phrase. Are you sure?")
- On confirm: calls `regenerateRecoveryPhrase()`, shows the new RecoveryPhraseGrid in a modal/inline expansion
- Same `[x]` checkbox confirmation required for the new phrase
- Red warning about invalidating old phrase

**SecurityTab** (`SecurityTab.tsx`):
Uses `useMfa()` hook for `checkMfaStatus()`.

Layout:

- MFA status badge at top: green dot + `[ENABLED]` or red dot + `[DISABLED]` (matching Pencil mockup)
- If MFA disabled: show "Enable MFA" section with description and `--enable-mfa` button that opens `MfaEnrollmentWizard`
- If MFA enabled: show factor count and threshold (e.g., "3 factors active, 2/3 threshold")
- `<AuthorizedDevices />` section
- `<RecoveryPhraseSection />` section
- Note at bottom: "MFA is available on web only. Desktop support coming soon." (per RESEARCH.md desktop impact)

Call `checkMfaStatus()` on mount (useEffect).

When enrollment wizard completes (`onComplete`), refresh status via `checkMfaStatus()`.

**Settings.tsx** -- Add tab navigation:
Currently shows only `<LinkedMethods />`. Add tab UI:

- Two tabs: "Linked Methods" | "Security"
- Active tab has bottom border in green (`#00D084`)
- Tab content switches between `<LinkedMethods />` and `<SecurityTab />`
- Default active tab: "Linked Methods" (preserves current behavior)
- Use local useState for active tab (no URL routing needed)
- Update the section heading: keep "// account & security" heading for both tabs

Match the terminal aesthetic of the existing Settings page. Tab labels in uppercase monospace.
</action>
<verify>
`cd /Users/michael/Code/cipher-box && pnpm --filter web build` compiles. Navigate to Settings page in browser, verify both tabs render. Security tab shows MFA status (disabled for non-MFA users). Enable MFA button opens wizard. After enrollment, status updates to enabled.
</verify>
<done>Settings page has Linked Methods and Security tabs. Security tab shows MFA status, authorized devices list, and recovery phrase management. Enrollment wizard is accessible from Security tab when MFA is disabled. Devices can be revoked. Recovery phrase can be regenerated.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter web build` succeeds
2. Settings page loads with two tabs (Linked Methods, Security)
3. Security tab shows correct MFA status
4. Enable MFA button triggers enrollment wizard
5. Recovery phrase grid displays 24 words correctly
6. Terminal-style [x] checkbox is accessible (keyboard + mouse)
7. Device list shows factors from Core Kit with proper factor-to-device matching
8. Revoke works for non-current devices
9. Regenerate recovery phrase shows new words
</verification>

<success_criteria>

- MFA enrollment wizard guides user through 3 steps
- Recovery phrase displayed in 4-column numbered grid
- Red warning boxes match CONTEXT.md specs (#EF4444)
- Terminal aesthetic buttons (--back, --continue, --done, --revoke, --regenerate)
- Accessibility: [x] checkbox has role="checkbox", aria-checked, keyboard handlers
- Settings tab navigation works between Linked Methods and Security
- AuthorizedDevices shows device list with [CURRENT]/[AUTHORIZED] tags
- Factor-to-device matching: deviceShare factors matched by additionalMetadata.deviceId, seedPhrase factors excluded, unknown devices labeled
  </success_criteria>

<output>
After completion, create `.planning/phases/12.4-mfa-cross-device/12.4-03-SUMMARY.md`
</output>
