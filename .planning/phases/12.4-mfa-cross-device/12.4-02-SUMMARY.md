---
phase: 12.4-mfa-cross-device
plan: 02
subsystem: auth
tags: [web3auth, mfa, core-kit, zustand, react-hooks, factor-management]

requires:
  - phase: 12.4-mfa-cross-device-01
    provides: Device approval entity, DTOs, and bulletin board API
  - phase: 12-foundation
    provides: Core Kit integration, loginWithJWT, CoreKitProvider

provides:
  - useMfa hook with 8 MFA operations (enableMfa, recoverWithMnemonic, inputFactorKey, getFactors, deleteFactor, getCurrentFactorKey, checkMfaStatus, regenerateRecoveryPhrase)
  - mfa.store.ts Zustand store for MFA UI state
  - REQUIRED_SHARE branching in login flow (no more throw)
  - Temporary backend auth with placeholder publicKey for bulletin board access
  - completeRequiredShare() for resuming login after factor input

affects:
  - 12.4-03 (MFA enrollment UI will use useMfa hook)
  - 12.4-04 (cross-device approval UI will use inputFactorKey and completeRequiredShare)

tech-stack:
  added:
    - '@tkey/common-types@^15.1.0 (Point class for factor deletion)'
    - 'bn.js@^5.2.1 (BN type for factor keys)'
    - '@types/bn.js@^5.1.6 (TypeScript types)'
  patterns:
    - 'useMfaStore.getState() for fresh state reads in async callbacks'
    - 'CoreKitLoginResult type union for login status branching'
    - 'Placeholder publicKey pattern for REQUIRED_SHARE temporary auth'

key-files:
  created:
    - apps/web/src/hooks/useMfa.ts
    - apps/web/src/stores/mfa.store.ts
  modified:
    - apps/web/src/lib/web3auth/hooks.ts
    - apps/web/src/hooks/useAuth.ts
    - apps/web/package.json

key-decisions:
  - "loginWithCoreKit returns 'logged_in' | 'required_share' union type instead of void"
  - "Temporary backend auth uses placeholder publicKey 'pending-core-kit-{userId}' for bulletin board API access"
  - 'Pending auth state (JWT + method) stored in React useState, not Zustand (component-scoped, cleared on unmount)'
  - 'useMfaStore.getState() pattern used in async callbacks to avoid stale closures'

patterns-established:
  - 'CoreKitLoginResult: typed return from loginWithCoreKit for status branching'
  - 'REQUIRED_SHARE flow: temp auth -> store pending JWT -> show recovery UI -> completeRequiredShare()'
  - "Factor key BN <-> hex: new BN(hex, 'hex') and bn.toString('hex').padStart(64, '0')"

duration: 20min
completed: 2026-02-15
---

# Phase 12.4 Plan 02: MFA Operations Hook + Login Flow REQUIRED_SHARE Handling Summary

useMfa hook wrapping 8 Core Kit MFA operations, mfa.store.ts for UI state, and REQUIRED_SHARE login branching with temporary backend auth for bulletin board access.

## Performance

- **Duration:** 20 min
- **Started:** 2026-02-15T00:28:43Z
- **Completed:** 2026-02-15T00:48:56Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments

- useMfa hook provides enableMfa, recoverWithMnemonic, inputFactorKey, getFactors, deleteFactor, getCurrentFactorKey, checkMfaStatus, regenerateRecoveryPhrase
- Login flow no longer throws on REQUIRED_SHARE -- branches to obtain temp backend token and stores pending JWT for post-factor completion
- completeRequiredShare() resumes full login (real publicKey, vault load, navigate) after factor input succeeds
- MFA store resets on logout alongside other stores

## Task Commits

Each task was committed atomically:

1. **Task 1: MFA store and useMfa hook** - `d8452cbec` (feat)
2. **Task 2: Login flow REQUIRED_SHARE branching + temporary backend auth** - `6b120b021` (feat)

## Files Created/Modified

- `apps/web/src/stores/mfa.store.ts` - Zustand store: isMfaEnabled, isEnrolling, factorCount, threshold, hasSeenPrompt
- `apps/web/src/hooks/useMfa.ts` - React hook wrapping 8 Core Kit MFA operations with proper BN conversion and commitChanges ordering
- `apps/web/src/lib/web3auth/hooks.ts` - loginWithCoreKit returns CoreKitLoginResult union; login functions return userId and status; isRequiredShare exposed
- `apps/web/src/hooks/useAuth.ts` - REQUIRED_SHARE branching in all 3 login methods, completeRequiredShare(), MFA store reset in logout
- `apps/web/package.json` - Added @tkey/common-types, bn.js, @types/bn.js dependencies

## Decisions Made

- loginWithCoreKit returns typed union instead of void -- callers branch on result rather than catching errors
- Temporary backend auth uses placeholder publicKey `pending-core-kit-{userId}` so new devices can call bulletin board API before TSS key is available
- Pending auth state stored in React useState (not Zustand) -- scoped to the auth component lifecycle, cleared on unmount or logout
- useMfaStore.getState() used in async callbacks to avoid stale Zustand closures (established pattern from previous phases)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added @tkey/common-types and bn.js as direct dependencies**

- **Found during:** Task 1 (useMfa hook implementation)
- **Issue:** `@tkey/common-types` (for Point.fromSEC1) and `bn.js` (for factor key BN type) are transitive deps of mpc-core-kit but not hoisted by pnpm strict mode -- imports failed at build time
- **Fix:** Added @tkey/common-types@^15.1.0, bn.js@^5.2.1, and @types/bn.js@^5.1.6 to web package.json
- **Files modified:** apps/web/package.json, pnpm-lock.yaml
- **Verification:** `pnpm --filter web build` succeeds with all imports resolved
- **Committed in:** d8452cbec (Task 1 commit)

**2. [Rule 3 - Blocking] Task 1 files committed by parallel Plan 01 metadata commit**

- **Found during:** Task 1 staging
- **Issue:** A parallel agent executing Plan 01 picked up the newly-created Task 1 files (useMfa.ts, mfa.store.ts, package.json changes) and included them in Plan 01's final metadata commit (d8452cbec)
- **Fix:** Verified committed content matches intended implementation; proceeded to Task 2 without re-committing
- **Impact:** Task 1 commit hash is shared with Plan 01 metadata commit rather than being a standalone commit

---

**Total deviations:** 2 auto-fixed (2 blocking)
**Impact on plan:** Both fixes necessary for correct operation. Parallel agent artifact is cosmetic (commit attribution).

## Issues Encountered

- 1Password SSH agent unreachable from GSD subprocess -- Task 2 committed with `-c commit.gpgsign=false` per established MEMORY.md policy (branch protection allows unsigned commits from GSD agents)

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- useMfa hook ready for enrollment wizard UI (Plan 03)
- REQUIRED_SHARE branching ready for recovery/approval UI (Plan 03/04)
- completeRequiredShare() ready for cross-device approval flow (Plan 04)
- Bulletin board API (Plan 01) + MFA hook (Plan 02) form the complete backend+frontend infrastructure for Plans 03/04

---

_Phase: 12.4-mfa-cross-device_
_Completed: 2026-02-15_
