# Phase 12.4: MFA + Cross-Device Approval - Context

**Gathered:** 2026-02-15
**Status:** Ready for planning

## Phase Boundary

Users can enroll in MFA with device shares and recovery phrases, approve new devices from existing authenticated devices, and manage factors from Settings. MFA is built on Web3Auth Core Kit's factor system (2/3 threshold). This phase does NOT include: billing-gated MFA tiers, biometric factors, or push notification transport.

## Implementation Decisions

### MFA Enrollment Flow

- Triggered both ways: dismissable prompt after first login + always available in Settings > Security
- Prompt shows once after first login, then only available in Settings (not persistent nagging)
- Enrollment is a step-by-step wizard (Claude's discretion on exact steps — likely: explain MFA → show recovery phrase → confirm → success)
- MFA is one-way — once enabled, cannot be disabled. Only factors can be managed (add/replace/revoke)
- Factors: Claude's discretion based on Core Kit capabilities (device share + recovery phrase at minimum)

### Recovery Phrase UX

- Shown on screen only — no downloadable backup file (avoids file-on-disk risk)
- Confirmation: checkbox acknowledgment using terminal-style `[x]` pattern ("I have written down and safely stored my recovery phrase")
- Recovery is inline during login — when login fails (no device share), a "Use recovery phrase" link appears on the login screen
- No dedicated `/recover` route

### Device Approval Flow

- Transport: bulletin board polling via CipherBox API (matches existing polling-based infra, extensible to QR/push later)
- Transport layer is thin and swappable — core crypto (ECIES ephemeral key exchange) is independent
- Existing device: modal dialog pops up immediately — shows device name, request age, countdown timer
- Timeout: 5-minute window for approval before request expires
- New device waiting state: full-screen waiting with spinner, countdown, and "Use recovery phrase instead" fallback link

### Known-Device Login Behavior

- Seamless login on known devices with existing device share — no extra 2FA step
- MFA challenge only triggers on new/unknown devices (no device share in storage)

### Factor Management in Settings

- Placement: Claude's discretion (dedicated "Security" tab alongside "Linked Methods", or integrated — see mockup for tab approach)
- MFA status badge shows: enabled/disabled, factor count, threshold (e.g., "3 factors active, 2/3 threshold")
- Per device shows: device name (e.g., "Chrome on Windows"), last active timestamp, status tag ([CURRENT], [AUTHORIZED])
- Can revoke devices with minimum factor rule (must always keep at least 2 factors active — current device + recovery phrase minimum)
- Cannot revoke the current device from itself
- Can regenerate recovery phrase from Settings (invalidates old phrase, requires current authentication)

### Claude's Discretion

- Exact wizard step count and content per step
- Factor types beyond device share + recovery phrase (e.g., optional password factor)
- Placement of Security section (dedicated tab vs sub-section)
- Loading/skeleton states during enrollment
- Error state handling for failed approvals or timeouts
- Exact bulletin board API design (endpoints, polling interval)
- ECIES ephemeral key exchange implementation details

## Specific Ideas

- Checkbox style must use terminal-style `[x]` / `[ ]` pattern (not native HTML checkboxes) — consistent with file browser selection
- Device approval modal uses `--approve` / `--deny` button labels (terminal command aesthetic)
- Recovery phrase warning box uses red border and `#EF4444` error color for high-severity warning
- Countdown timer for approval requests shows in red when < 3 minutes
- Wizard navigation uses `--back` / `--continue` button labels

## Approved Design Direction

**Mockup screens in Pencil file:** `designs/cipher-box-design.pen`
**Canvas location:** "Drafts - Phase 12.4" (bottom of canvas, y~3400)

### Screen 1: MFA Enrollment Wizard (Frame: `Yk5eA`)

- Settings > Security context with step indicator (Step 2 of 3)
- Progress bar (3 segments, green for complete, dark for pending)
- Recovery phrase displayed as 4-column, 24-word numbered grid
- Red warning box: "If you lose this phrase and all your devices, your account CANNOT be recovered"
- Terminal-style `[x]` checkbox confirmation
- `--back` / `--continue` navigation buttons

### Screen 2: Device Approval Modal (Frame: `Bxate`)

- File browser dimmed behind `#000000CC` backdrop overlay
- Modal with `#00D084` border showing device details (name, request time, expiry countdown)
- Red warning: "Only approve if YOU are trying to log in on another device"
- `--deny` (red outline) / `--approve` (green filled) buttons

### Screen 3: Settings Security Tab (Frame: `wxqZA`)

- Tab navigation: "Linked Methods" | **"Security"** (active)
- MFA status badge with green dot + "[ENABLED]" status
- Authorized Devices table with columns: DEVICE, LAST ACTIVE, ACTION
- Device rows with `[CURRENT]` / `[AUTHORIZED]` tags, `--revoke` action in red
- Recovery Phrase section with status and `--regenerate` button

## Deferred Ideas

- Push notifications for device approval (currently using polling — could add WebSocket/push in future phase)
- QR code scanning for device pairing (transport layer is swappable)
- Biometric factor support (fingerprint/face ID as additional factor)
- MFA tier gating behind billing plans (Phase 18: Billing Infrastructure)

---

_Phase: 12.4-mfa-cross-device_
_Context gathered: 2026-02-15_
