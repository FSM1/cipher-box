---
phase: 12.4-mfa-cross-device
plan: 05
subsystem: integration
tags: [orval, api-client, codegen, mfa, keypair-stability, device-approval]

# Dependency graph
requires:
  - phase: 12.4-mfa-cross-device-01
    provides: Bulletin board API endpoints and OpenAPI spec with device-approval tag
  - phase: 12.4-mfa-cross-device-04
    provides: Manual apiClient-based device-approval.service.ts and DeviceApprovalModal

provides:
  - Regenerated Orval API client with device-approval endpoints
  - Type-safe device-approval service using generated client
  - Programmatic tssPubKey stability check in enableMfa()
  - Phase 12.4 complete end-to-end integration

affects:
  - Any future plan touching device-approval endpoints (generated client is source of truth)
  - Future MFA-related changes (stability check guards keypair identity)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Generated Orval client wrapper pattern for backward-compatible API surface
    - Defensive tssPubKey comparison as permanent MFA enrollment guard

key-files:
  created:
    - apps/web/src/api/device-approval/device-approval.ts
    - apps/web/src/api/models/createApprovalDto.ts
    - apps/web/src/api/models/respondApprovalDto.ts
    - apps/web/src/api/models/respondApprovalDtoAction.ts
    - apps/web/src/api/models/deviceApprovalControllerCreateRequest201.ts
    - apps/web/src/api/models/deviceApprovalControllerGetPending200Item.ts
    - apps/web/src/api/models/deviceApprovalControllerGetStatus200.ts
    - apps/web/src/api/models/deviceApprovalControllerGetStatus200Status.ts
  modified:
    - apps/web/src/api/models/index.ts
    - apps/web/src/services/device-approval.service.ts
    - apps/web/src/components/mfa/DeviceApprovalModal.tsx
    - apps/web/src/hooks/useMfa.ts
    - apps/web/src/stores/device-registry.store.ts
    - apps/web/src/lib/device/info.ts
    - packages/api-client/openapi.json

key-decisions:
  - 'Wrapper pattern for generated client: deviceApprovalApi object wraps generated functions for backward-compatible API surface'
  - 'Non-null assertions (!) on generated optional fields in DeviceApprovalModal where values always present from DB'
  - 'tssPubKey check uses optional chaining (?.) for x/y since Core Kit types allow null'

patterns-established:
  - 'Generated Orval client wrapped in service layer to maintain stable import paths'
  - 'Permanent defensive checks in crypto-critical operations (log but do not throw)'

# Metrics
duration: 4min
completed: 2026-02-15
---

# Phase 12.4 Plan 05: API Client Regeneration + Integration Verification + Keypair Stability Check

Regenerated Orval API client with device-approval endpoints, replaced manual apiClient calls with type-safe generated functions, added permanent tssPubKey stability guard in enableMfa(), cleaned up Phase 12.4 TODO comments.

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-15T01:07:18Z
- **Completed:** 2026-02-15T01:10:57Z
- **Tasks:** 2
- **Files modified:** 14

## Accomplishments

- Regenerated Orval client with all 5 device-approval endpoints (createRequest, getStatus, getPending, respond, cancel) and 7 new model types
- Replaced manual `apiClient.post`/`get`/`delete` calls in device-approval.service.ts with generated typed functions while maintaining backward-compatible API surface
- Added permanent defensive tssPubKey comparison in enableMfa() (MFA-04 requirement) that logs CRITICAL if keypair changes after enrollment
- Cleaned up stale "Future Phase 12.4" and "Phase 12.4" comments in device-registry store and device info module
- All 467 API tests pass, both API and web builds succeed, lint clean

## Task Commits

Each task was committed atomically:

1. **Task 1: Regenerate API client + update device-approval service** - `c090125e8` (chore)
2. **Task 2: tssPubKey stability check + comment cleanup** - `f49383f0f` (feat)

## Files Created/Modified

- `apps/web/src/api/device-approval/device-approval.ts` - Generated Orval client with 5 device-approval endpoint functions + React Query hooks
- `apps/web/src/api/models/createApprovalDto.ts` - Generated CreateApprovalDto type
- `apps/web/src/api/models/respondApprovalDto.ts` - Generated RespondApprovalDto type
- `apps/web/src/api/models/respondApprovalDtoAction.ts` - Generated approve/deny enum
- `apps/web/src/api/models/deviceApprovalControllerCreateRequest201.ts` - Generated create response type
- `apps/web/src/api/models/deviceApprovalControllerGetPending200Item.ts` - Generated pending item type
- `apps/web/src/api/models/deviceApprovalControllerGetStatus200.ts` - Generated status response type
- `apps/web/src/api/models/deviceApprovalControllerGetStatus200Status.ts` - Generated status enum
- `apps/web/src/api/models/index.ts` - Updated barrel export with new device-approval models
- `apps/web/src/services/device-approval.service.ts` - Replaced manual apiClient calls with generated client functions
- `apps/web/src/components/mfa/DeviceApprovalModal.tsx` - Fixed optional field types from generated models
- `apps/web/src/hooks/useMfa.ts` - Added tssPubKey comparison before/after enableMFA()
- `apps/web/src/stores/device-registry.store.ts` - Updated stale Phase 12.4 comment
- `apps/web/src/lib/device/info.ts` - Updated stale Phase 12.4 comment
- `packages/api-client/openapi.json` - Regenerated spec (no changes, already had device-approval)

## Decisions Made

- **Wrapper pattern for generated client:** Instead of having consumers import generated functions directly, the `deviceApprovalApi` object wraps them to maintain the same import path and function signatures used by `useDeviceApproval.ts`. This avoids a large refactor across the hook.
- **Non-null assertions on generated optional fields:** The generated types mark all response fields as optional (e.g., `requestId?: string`) because OpenAPI doesn't have `required` on response schemas. In `DeviceApprovalModal`, we use `!` assertions since these fields always come from database columns.
- **tssPubKey null-safe check:** Core Kit's `tssPubKey.x` and `tssPubKey.y` are typed as nullable, so the comparison uses optional chaining (`?.x`, `?.y`) to guard against null before comparing hex strings.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed DeviceApprovalModal type errors from generated optional fields**

- **Found during:** Task 1 (build verification after API client regeneration)
- **Issue:** Generated types from Orval mark response fields as optional (`requestId?: string`, `expiresAt?: string`), but DeviceApprovalModal passes them to functions expecting `string` and `new Date()` constructor
- **Fix:** Added non-null assertions (`!`) on `requestId`, `ephemeralPublicKey`, `expiresAt`, `createdAt` where the guard `if (!currentRequest) return null` already ensures the object exists
- **Files modified:** apps/web/src/components/mfa/DeviceApprovalModal.tsx
- **Verification:** `pnpm --filter web build` succeeds
- **Committed in:** c090125e8 (Task 1 commit)

**2. [Rule 1 - Bug] Fixed tssPubKey null property access in stability check**

- **Found during:** Task 2 (build verification after adding stability check)
- **Issue:** Core Kit's `tssPubKey.x` and `tssPubKey.y` are typed as `BN | null`, but the initial implementation called `.toString('hex')` without null guards
- **Fix:** Changed outer check from `if (preMfaTssPub && postMfaTssPub)` to `if (preMfaTssPub?.x && preMfaTssPub?.y && postMfaTssPub?.x && postMfaTssPub?.y)` with extracted variables for cleaner comparison
- **Files modified:** apps/web/src/hooks/useMfa.ts
- **Verification:** `pnpm --filter web build` succeeds
- **Committed in:** f49383f0f (Task 2 commit)

---

**Total deviations:** 2 auto-fixed (2 bugs)
**Impact on plan:** Both fixes necessary for TypeScript compilation. No scope creep.

## Issues Encountered

None - plan executed smoothly.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Phase 12.4 (MFA + Cross-Device Approval) is fully complete
- All 5 plans delivered: bulletin board API, MFA hooks + login flow, enrollment wizard + security tab, cross-device approval UI + recovery input, API client regeneration + integration verification
- The following manual testing is recommended before merging:
  - Non-MFA login flow (verify no regressions)
  - MFA enrollment via Settings > Security (verify recovery phrase displayed)
  - Cross-device approval (verify factor transfer between browser profiles)
  - Recovery phrase restore (verify 24-word input restores access)
  - Verify no `[MFA] CRITICAL: TSS public key changed` in browser console after enrollment
- Next phase in the roadmap should be determined by the user

---

_Phase: 12.4-mfa-cross-device_
_Completed: 2026-02-15_
