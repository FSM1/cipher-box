---
phase: 12.3-siwe-unified-identity
plan: 03
type: execute
wave: 3
depends_on: ['12.3-02']
files_modified:
  - apps/web/src/lib/wagmi/config.ts
  - apps/web/src/lib/wagmi/provider.tsx
  - apps/web/src/main.tsx
  - apps/web/src/components/auth/WalletLoginButton.tsx
  - apps/web/src/components/auth/index.ts
  - apps/web/src/lib/web3auth/hooks.ts
  - apps/web/src/hooks/useAuth.ts
  - apps/web/src/routes/Login.tsx
  - apps/web/src/lib/api/auth.ts
  - apps/web/src/lib/crypto/signatureKeyDerivation.ts
  - apps/web/src/stores/auth.store.ts
  - apps/web/src/hooks/useFileDownload.ts
  - apps/web/src/hooks/useFilePreview.ts
  - apps/web/src/hooks/useFileUpload.ts
  - apps/web/src/hooks/useFolder.ts
  - apps/web/src/hooks/useFolderNavigation.ts
  - apps/web/src/hooks/useDeviceRegistrySync.ts
  - apps/web/src/components/file-browser/TextEditorDialog.tsx
  - apps/web/src/components/file-browser/ImagePreviewDialog.tsx
  - apps/web/src/components/auth/LinkedMethods.tsx
autonomous: true

must_haves:
  truths:
    - 'User can click a wallet button on the login page and connect any EIP-6963 compatible wallet'
    - 'After wallet connection, user signs a SIWE message and gets a CipherBox JWT back'
    - 'Wallet login produces the same Core Kit MPC key as Google/email for the same userId'
    - 'ADR-001 signatureKeyDerivation.ts is deleted and all references removed'
    - 'Auth store uses vaultKeypair (renamed from derivedKeypair) with no ADR-001 comments'
    - 'All 8+ hook/component files that use derivedKeypair are updated to use vaultKeypair'
    - 'PnP migration key (getMigrationKey/importTssKey) code is removed from hooks.ts'
  artifacts:
    - path: 'apps/web/src/lib/wagmi/config.ts'
      provides: 'wagmi createConfig with mainnet chain and injected() connector'
      min_lines: 10
    - path: 'apps/web/src/lib/wagmi/provider.tsx'
      provides: 'WagmiProvider React wrapper component'
      min_lines: 8
    - path: 'apps/web/src/components/auth/WalletLoginButton.tsx'
      provides: 'Wallet connection + SIWE signing + backend verification UI component'
      min_lines: 60
    - path: 'apps/web/src/lib/web3auth/hooks.ts'
      provides: 'loginWithWallet function alongside existing loginWithGoogle and loginWithEmailOtp'
      contains: 'loginWithWallet'
    - path: 'apps/web/src/routes/Login.tsx'
      provides: 'Login page with Google, Email, and Wallet login options'
      contains: 'WalletLoginButton'
    - path: 'apps/web/src/stores/auth.store.ts'
      provides: 'Auth store with vaultKeypair (not derivedKeypair), no isExternalWallet'
      contains: 'vaultKeypair'
  key_links:
    - from: 'apps/web/src/components/auth/WalletLoginButton.tsx'
      to: '/auth/identity/wallet/nonce'
      via: 'fetch nonce before SIWE signing'
      pattern: 'wallet/nonce'
    - from: 'apps/web/src/components/auth/WalletLoginButton.tsx'
      to: '/auth/identity/wallet'
      via: 'POST SIWE message + signature for verification'
      pattern: 'identity/wallet'
    - from: 'apps/web/src/lib/web3auth/hooks.ts'
      to: 'loginWithCoreKit'
      via: 'loginWithWallet calls loginWithCoreKit with CipherBox JWT'
      pattern: 'loginWithCoreKit'
    - from: 'apps/web/src/main.tsx'
      to: 'apps/web/src/lib/wagmi/provider.tsx'
      via: 'WagmiProvider wraps CoreKitProvider and QueryClientProvider'
      pattern: 'WagmiProvider'
---

<objective>
Add wallet login to the frontend (wagmi setup, WalletLoginButton, SIWE flow, Login page integration), rename derivedKeypair to vaultKeypair across all consumers, and remove all ADR-001 legacy code from the frontend.

Purpose: This plan delivers the user-facing wallet login flow, cleans out dead ADR-001 code, and renames the misleading "derivedKeypair" (which sounds ADR-001-specific but is actively used by Core Kit) to "vaultKeypair" across all consumer files. After this plan, users can log in via wallet (SIWE) alongside Google and email, and the codebase is clean of ADR-001 artifacts.

Output: Working wallet login on the login page, wagmi provider configured, ADR-001 code deleted, auth store and all consumers use vaultKeypair.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.3-siwe-unified-identity/12.3-CONTEXT.md
@.planning/phases/12.3-siwe-unified-identity/12.3-RESEARCH.md
@.planning/phases/12.3-siwe-unified-identity/12.3-01-SUMMARY.md
@.planning/phases/12.3-siwe-unified-identity/12.3-02-SUMMARY.md
@.learnings/2026-02-13-phase12-corekit-identity-provider.md

Key existing files to reference:
@apps/web/src/main.tsx
@apps/web/src/routes/Login.tsx
@apps/web/src/hooks/useAuth.ts
@apps/web/src/lib/web3auth/hooks.ts
@apps/web/src/lib/web3auth/core-kit-provider.tsx
@apps/web/src/stores/auth.store.ts
@apps/web/src/lib/api/auth.ts
@apps/web/src/components/auth/index.ts
@apps/web/src/components/auth/GoogleLoginButton.tsx
@apps/web/src/hooks/useFileDownload.ts
@apps/web/src/hooks/useFileUpload.ts
@apps/web/src/hooks/useFolder.ts
@apps/web/src/hooks/useFolderNavigation.ts
@apps/web/src/hooks/useFilePreview.ts
@apps/web/src/hooks/useDeviceRegistrySync.ts
@apps/web/src/components/file-browser/TextEditorDialog.tsx
@apps/web/src/components/file-browser/ImagePreviewDialog.tsx
@apps/web/src/components/auth/LinkedMethods.tsx
@apps/web/CLAUDE.md
</context>

<tasks>

<task type="auto">
<name>Task 1: wagmi setup, WalletLoginButton, Core Kit wallet hook, and Login page</name>
<files>
apps/web/src/lib/wagmi/config.ts
apps/web/src/lib/wagmi/provider.tsx
apps/web/src/main.tsx
apps/web/src/components/auth/WalletLoginButton.tsx
apps/web/src/components/auth/index.ts
apps/web/src/lib/web3auth/hooks.ts
apps/web/src/lib/api/auth.ts
apps/web/src/hooks/useAuth.ts
apps/web/src/routes/Login.tsx
</files>
<action>
Create `apps/web/src/lib/wagmi/config.ts`: wagmi createConfig with mainnet chain and `injected()` connector. CipherBox does NOT use Ethereum for transactions -- chain config is only for SIWE chainId field. See RESEARCH.md for exact code.

Create `apps/web/src/lib/wagmi/provider.tsx`: Export a `WagmiSetup` component that wraps children with wagmi's WagmiProvider, importing wagmiConfig from ./config.

Update `apps/web/src/main.tsx`: Import WagmiSetup from lib/wagmi/provider. Wrap the provider tree so WagmiSetup is OUTSIDE CoreKitProvider and QueryClientProvider. New tree: `<WagmiSetup><CoreKitProvider><QueryClientProvider>...<App />`. WagmiProvider must be outermost because wagmi v3 uses React Query internally and will discover the existing QueryClient from context.

Add wallet API methods to `apps/web/src/lib/api/auth.ts`: Add `identityWalletNonce(): Promise<{ nonce: string }>` (GET /auth/identity/wallet/nonce) and `identityWalletVerify(data: { message: string; signature: string }): Promise<{ idToken: string; userId: string; isNewUser: boolean }>` (POST /auth/identity/wallet). Follow the existing pattern used by `identityGoogle` and `identityEmailVerify`. Also check if the regenerated API client from Plan 02 already provides these methods via orval -- if so, use those instead. Also update the `AuthMethodResponse.type` union to use simplified types.

Update `apps/web/src/lib/web3auth/hooks.ts`: Add `loginWithWallet(cipherboxJwt, userId)` function that calls `loginWithCoreKit(cipherboxJwt, userId)` and returns `{ cipherboxJwt }`. Remove `getMigrationKey()` function entirely (PnP migration no longer needed). Remove the `migrationKey` parameter from `loginWithCoreKit()` and all migration key detection logic. Update `loginWithGoogle` and `loginWithEmailOtp` to not accept or pass migrationKey. Export `loginWithWallet` from the hook return.

Create `apps/web/src/components/auth/WalletLoginButton.tsx`: Use wagmi hooks (`useConnect`, `useAccount`, `useSignMessage`, `useDisconnect`). Use `createSiweMessage` from 'viem/siwe'. Component flow: show "Connect Wallet" button matching terminal aesthetic; on click show discovered wallet connectors from useConnect().connectors; user selects connector, wagmi connects, gets address; once connected, fetch nonce from backend, create SIWE message with address, chainId=1, domain=window.location.host, nonce, uri=window.location.origin, version='1', statement='Sign in to CipherBox encrypted storage'; prompt user to sign; send message+signature to backend; receive {idToken, userId}; disconnect wagmi; call onLogin callback. Handle errors (wallet not installed, user rejected, verification failed). Use `connectAsync()` for simpler async flow. Props: `onLogin: (idToken: string, userId: string) => Promise<void>`, `disabled?: boolean`. Include proper aria labels and keyboard handlers per apps/web/CLAUDE.md.

Export WalletLoginButton from `apps/web/src/components/auth/index.ts`.

Update `apps/web/src/hooks/useAuth.ts`: Import loginWithWallet from core-kit hooks. Add `loginWithWallet` function following the same pattern as loginWithGoogle/loginWithEmail. Change `completeBackendAuth('email_passwordless', ...)` to `completeBackendAuth('email', ...)` in loginWithEmail. Export `loginWithWallet` from the hook return.

Update `apps/web/src/routes/Login.tsx`: Import WalletLoginButton from components/auth. Add `loginWithWallet` to the destructured useAuth return. Create `handleWalletLogin` callback. Add WalletLoginButton to the login form near Google and Email options. Style should match the existing terminal aesthetic.

AVOID: Do NOT add WalletConnect connector. Only use `injected()` for EIP-6963 browser wallet discovery.
AVOID: Do NOT use the `siwe` npm package. Use viem's SIWE utilities.
IMPORTANT: `createSiweMessage` may be at `viem/siwe` not the main `viem` export.
</action>
<verify>
`pnpm --filter web build` compiles without errors (or only errors in files Task 2 will fix).
Grep for `getMigrationKey` in apps/web/src/ returns no results.
Grep for `importTssKey` in apps/web/src/ returns no results.
WalletLoginButton.tsx exists and exports the component.
wagmi config and provider files exist.
main.tsx includes WagmiSetup in the provider tree.
Login.tsx contains WalletLoginButton component.
useAuth hook exports loginWithWallet.
</verify>
<done>
wagmi configured with injected() connector and mainnet chain. WagmiProvider wraps the app. WalletLoginButton handles full SIWE flow. loginWithWallet available in core-kit hooks and useAuth. PnP migration code removed. Login page shows wallet option.
</done>
</task>

<task type="auto">
<name>Task 2: ADR-001 cleanup -- rename derivedKeypair to vaultKeypair across all consumers</name>
<files>
apps/web/src/lib/crypto/signatureKeyDerivation.ts
apps/web/src/stores/auth.store.ts
apps/web/src/hooks/useAuth.ts
apps/web/src/hooks/useFileDownload.ts
apps/web/src/hooks/useFilePreview.ts
apps/web/src/hooks/useFileUpload.ts
apps/web/src/hooks/useFolder.ts
apps/web/src/hooks/useFolderNavigation.ts
apps/web/src/hooks/useDeviceRegistrySync.ts
apps/web/src/components/file-browser/TextEditorDialog.tsx
apps/web/src/components/file-browser/ImagePreviewDialog.tsx
apps/web/src/components/auth/LinkedMethods.tsx
</files>
<action>
CRITICAL CONTEXT: The `derivedKeypair` in auth.store.ts is NOT just ADR-001 legacy code. It is actively used by ALL file operations (upload, download, preview, folder nav, device registry) to access the user's secp256k1 keypair from Core Kit. The ADR-001 comments and `DerivedKeypair` type name are misleading -- Core Kit's `getVaultKeypair()` returns the same shape and stores it via `setDerivedKeypair()`. The correct action is to RENAME (not remove) the keypair state, and remove only the truly ADR-001-specific artifacts.

DELETE `apps/web/src/lib/crypto/signatureKeyDerivation.ts` entirely. This is the 329-line ADR-001 module -- no longer used (confirmed: no imports found).

Update `apps/web/src/stores/auth.store.ts`: Rename `DerivedKeypair` type to `VaultKeypair` (same shape: `{ publicKey: Uint8Array; privateKey: Uint8Array }`). Remove the ADR-001 comment. Replace with: "User's secp256k1 vault keypair from Core Kit TSS export. Memory-only, never persisted." Rename state property `derivedKeypair` -> `vaultKeypair`. Rename action `setDerivedKeypair` -> `setVaultKeypair`. REMOVE `isExternalWallet` state property entirely. REMOVE `setIsExternalWallet` action entirely. REMOVE `clearDerivedKeypair` action entirely (redundant with logout). KEEP the zero-fill logic in `logout()` but update to reference `vaultKeypair`. Remove `isExternalWallet: false` from the logout set call. Remove all ADR-001 comments.

Update `apps/web/src/hooks/useAuth.ts`: Change `setDerivedKeypair` import to `setVaultKeypair`. Update `initializeOrLoadVault`: `setDerivedKeypair(userKeypair)` -> `setVaultKeypair(userKeypair)`. Remove any remaining `setIsExternalWallet` or `isExternalWallet` references.

Update ALL consumer files that reference `derivedKeypair` -- rename to `vaultKeypair`:

- `apps/web/src/hooks/useFileDownload.ts`: `const { derivedKeypair }` -> `const { vaultKeypair }`, update all references and dependency array
- `apps/web/src/hooks/useFileUpload.ts`: Same pattern
- `apps/web/src/hooks/useFilePreview.ts`: `auth.derivedKeypair` -> `auth.vaultKeypair`
- `apps/web/src/hooks/useFolder.ts`: `auth.derivedKeypair` -> `auth.vaultKeypair`
- `apps/web/src/hooks/useFolderNavigation.ts`: `useAuthStore.getState().derivedKeypair` -> `useAuthStore.getState().vaultKeypair`, update all references
- `apps/web/src/hooks/useDeviceRegistrySync.ts`: `useAuthStore.getState().derivedKeypair?.privateKey` -> `useAuthStore.getState().vaultKeypair?.privateKey`
- `apps/web/src/components/file-browser/TextEditorDialog.tsx`: `auth.derivedKeypair` -> `auth.vaultKeypair`
- `apps/web/src/components/file-browser/ImagePreviewDialog.tsx`: `auth.derivedKeypair` -> `auth.vaultKeypair`

Update `apps/web/src/components/auth/LinkedMethods.tsx`: Update METHOD_LABELS to use new types -- change `email_passwordless` key to `email`, remove `external_wallet` key if present, add `wallet: 'Wallet'`.

IMPORTANT: After all renames, run a comprehensive grep for `derivedKeypair` and `isExternalWallet` across the ENTIRE apps/web/src/ directory. There must be ZERO results.

IMPORTANT: The rename is a mechanical find-replace. Do NOT change any logic -- the keypair object shape stays identical. Only the name and comments change.

IMPORTANT: Also check `apps/web/src/lib/api/auth.ts` for any `type` field that still references old auth method types and update.
</action>
<verify>
`pnpm --filter web build` compiles without errors.
`signatureKeyDerivation.ts` does not exist (deleted).
Grep for `signatureKeyDerivation` in apps/web/src/ returns no results.
Grep for `derivedKeypair` in apps/web/src/ returns no results.
Grep for `isExternalWallet` in apps/web/src/ returns no results.
Grep for `clearDerivedKeypair` in apps/web/src/ returns no results.
Grep for `DerivedKeypair` in apps/web/src/ returns no results.
Grep for `getMigrationKey` in apps/web/src/ returns no results.
Grep for `email_passwordless` in apps/web/src/ returns no results (outside generated api/ directory).
Grep for `vaultKeypair` in apps/web/src/stores/auth.store.ts returns matches (confirming rename).
`pnpm --filter web lint` passes.
</verify>
<done>
ADR-001 code completely removed. signatureKeyDerivation.ts deleted. DerivedKeypair type renamed to VaultKeypair. isExternalWallet and clearDerivedKeypair removed. Migration key removed. All 8+ consumer files updated from derivedKeypair to vaultKeypair. Auth store is clean with clear naming. Frontend builds and lints without errors.
</done>
</task>

</tasks>

<verification>

1. `pnpm --filter web build` compiles without errors
2. `pnpm --filter web lint` passes (or only pre-existing warnings)
3. No ADR-001 references in apps/web/src/ (signatureKeyDerivation, derivedKeypair, isExternalWallet, DerivedKeypair, getMigrationKey, importTssKey, clearDerivedKeypair)
4. Login page renders with Google, Email, and Wallet login options
5. WalletLoginButton exists with SIWE flow implementation
6. wagmi provider is in the component tree
7. Core Kit hooks expose loginWithWallet
8. All consumer hooks/components use vaultKeypair (not derivedKeypair)
9. No email_passwordless or external_wallet references in non-generated frontend code

</verification>

<success_criteria>

- Wallet login button appears on the login page alongside Google and email
- Clicking wallet button discovers EIP-6963 wallets (MetaMask, etc.)
- After wallet connection, SIWE message is created and user is prompted to sign
- Signed message is verified by backend and produces a CipherBox JWT
- JWT is used for Core Kit loginWithJWT producing the same MPC key as other auth methods
- All ADR-001 code is deleted from the frontend
- Auth store uses vaultKeypair everywhere, all 8+ consumers updated
- Frontend builds and lints cleanly

</success_criteria>

<output>
After completion, create `.planning/phases/12.3-siwe-unified-identity/12.3-03-SUMMARY.md`
</output>
