---
phase: 12.3-siwe-unified-identity
plan: 03
type: execute
wave: 3
depends_on: ["12.3-02"]
files_modified:
  - apps/web/src/lib/wagmi/config.ts
  - apps/web/src/lib/wagmi/provider.tsx
  - apps/web/src/main.tsx
  - apps/web/src/components/auth/WalletLoginButton.tsx
  - apps/web/src/components/auth/index.ts
  - apps/web/src/lib/web3auth/hooks.ts
  - apps/web/src/hooks/useAuth.ts
  - apps/web/src/routes/Login.tsx
  - apps/web/src/lib/api/auth.ts
  - apps/web/src/lib/crypto/signatureKeyDerivation.ts
  - apps/web/src/stores/auth.store.ts
autonomous: true

must_haves:
  truths:
    - "User can click a wallet button on the login page and connect any EIP-6963 compatible wallet"
    - "After wallet connection, user signs a SIWE message and gets a CipherBox JWT back"
    - "Wallet login produces the same Core Kit MPC key as Google/email for the same userId"
    - "ADR-001 signatureKeyDerivation.ts is deleted and all references removed"
    - "Auth store has no derivedKeypair or isExternalWallet state"
    - "PnP migration key (getMigrationKey/importTssKey) code is removed"
  artifacts:
    - path: "apps/web/src/lib/wagmi/config.ts"
      provides: "wagmi createConfig with mainnet chain and injected() connector"
      min_lines: 10
    - path: "apps/web/src/lib/wagmi/provider.tsx"
      provides: "WagmiProvider React wrapper component"
      min_lines: 8
    - path: "apps/web/src/components/auth/WalletLoginButton.tsx"
      provides: "Wallet connection + SIWE signing + backend verification UI component"
      min_lines: 60
    - path: "apps/web/src/lib/web3auth/hooks.ts"
      provides: "loginWithWallet function alongside existing loginWithGoogle and loginWithEmailOtp"
      contains: "loginWithWallet"
    - path: "apps/web/src/routes/Login.tsx"
      provides: "Login page with Google, Email, and Wallet login options"
      contains: "WalletLoginButton"
  key_links:
    - from: "apps/web/src/components/auth/WalletLoginButton.tsx"
      to: "/auth/identity/wallet/nonce"
      via: "fetch nonce before SIWE signing"
      pattern: "wallet/nonce"
    - from: "apps/web/src/components/auth/WalletLoginButton.tsx"
      to: "/auth/identity/wallet"
      via: "POST SIWE message + signature for verification"
      pattern: "identity/wallet"
    - from: "apps/web/src/lib/web3auth/hooks.ts"
      to: "loginWithCoreKit"
      via: "loginWithWallet calls loginWithCoreKit with CipherBox JWT"
      pattern: "loginWithCoreKit"
    - from: "apps/web/src/main.tsx"
      to: "apps/web/src/lib/wagmi/provider.tsx"
      via: "WagmiProvider wraps CoreKitProvider and QueryClientProvider"
      pattern: "WagmiProvider"
---

<objective>
Add wallet login to the frontend (wagmi setup, WalletLoginButton, SIWE flow, Login page integration) and remove all ADR-001 legacy code from the frontend.

Purpose: This plan delivers the user-facing wallet login flow and cleans out dead ADR-001 code. After this plan, users can log in via wallet (SIWE) alongside Google and email. The frontend is clean of all legacy signature-derived key and PnP migration code.

Output: Working wallet login on the login page, wagmi provider configured, ADR-001 code deleted, auth store simplified.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.3-siwe-unified-identity/12.3-CONTEXT.md
@.planning/phases/12.3-siwe-unified-identity/12.3-RESEARCH.md
@.planning/phases/12.3-siwe-unified-identity/12.3-01-SUMMARY.md
@.planning/phases/12.3-siwe-unified-identity/12.3-02-SUMMARY.md
@.learnings/2026-02-13-phase12-corekit-identity-provider.md

Key existing files to reference:
@apps/web/src/main.tsx
@apps/web/src/routes/Login.tsx
@apps/web/src/hooks/useAuth.ts
@apps/web/src/lib/web3auth/hooks.ts
@apps/web/src/lib/web3auth/core-kit-provider.tsx
@apps/web/src/stores/auth.store.ts
@apps/web/src/lib/crypto/signatureKeyDerivation.ts
@apps/web/src/lib/api/auth.ts
@apps/web/src/components/auth/index.ts
@apps/web/src/components/auth/GoogleLoginButton.tsx
@apps/web/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: wagmi configuration, WalletLoginButton, and Core Kit wallet hook</name>
  <files>
    apps/web/src/lib/wagmi/config.ts
    apps/web/src/lib/wagmi/provider.tsx
    apps/web/src/main.tsx
    apps/web/src/components/auth/WalletLoginButton.tsx
    apps/web/src/components/auth/index.ts
    apps/web/src/lib/web3auth/hooks.ts
    apps/web/src/lib/api/auth.ts
  </files>
  <action>
    1. Create `apps/web/src/lib/wagmi/config.ts`:
       ```typescript
       import { createConfig, http } from 'wagmi';
       import { mainnet } from 'wagmi/chains';
       import { injected } from 'wagmi/connectors';

       export const wagmiConfig = createConfig({
         chains: [mainnet],
         connectors: [injected()],
         transports: { [mainnet.id]: http() },
       });
       ```
       CipherBox does NOT use Ethereum for transactions -- chain config is only for SIWE chainId field.

    2. Create `apps/web/src/lib/wagmi/provider.tsx`:
       - Export a `WagmiSetup` component that wraps children with wagmi's `WagmiProvider`
       - Import wagmiConfig from ./config
       - Simple wrapper: `<WagmiProvider config={wagmiConfig}>{children}</WagmiProvider>`

    3. Update `apps/web/src/main.tsx`:
       - Import WagmiSetup from lib/wagmi/provider
       - Wrap the provider tree: WagmiSetup should be OUTSIDE CoreKitProvider and QueryClientProvider
       - New tree: `<WagmiSetup><CoreKitProvider><QueryClientProvider>...<App />`
       - WagmiProvider must be outermost because wagmi v3 uses React Query internally and will discover the existing QueryClient from context

    4. Add wallet API methods to `apps/web/src/lib/api/auth.ts`:
       - Add `identityWalletNonce(): Promise<{ nonce: string }>` -- GET /auth/identity/wallet/nonce
       - Add `identityWalletVerify(data: { message: string; signature: string }): Promise<{ idToken: string; userId: string; isNewUser: boolean }>` -- POST /auth/identity/wallet
       - Follow the existing pattern used by `identityGoogle` and `identityEmailVerify`
       - Also check if the regenerated API client from Plan 02 already provides these methods via orval -- if so, use those instead of manual fetch wrappers

    5. Add `loginWithWallet` to `apps/web/src/lib/web3auth/hooks.ts`:
       ```typescript
       async function loginWithWallet(
         cipherboxJwt: string,
         userId: string
       ): Promise<{ cipherboxJwt: string }> {
         await loginWithCoreKit(cipherboxJwt, userId);
         return { cipherboxJwt };
       }
       ```
       - Remove `getMigrationKey()` function entirely (PnP migration no longer needed)
       - Remove the `importTssKey` parameter from `loginWithCoreKit()` -- the `migrationKey` parameter and all migration key detection logic should be removed
       - Update `loginWithGoogle` and `loginWithEmailOtp` to not pass migrationKey
       - Export `loginWithWallet` from the hook return

    6. Create `apps/web/src/components/auth/WalletLoginButton.tsx`:
       - Use wagmi hooks: `useConnect`, `useAccount`, `useSignMessage`, `useDisconnect`
       - Use `createSiweMessage` from 'viem/siwe' (check the correct import path)
       - Component flow:
         a. Show "Connect Wallet" button (terminal aesthetic, match GoogleLoginButton style)
         b. On click, show list of discovered wallet connectors from useConnect().connectors
         c. User selects connector -> wagmi connects -> gets address
         d. Once connected (useAccount has address):
            - Fetch nonce from backend (GET /auth/identity/wallet/nonce)
            - Create SIWE message with address, chainId=1, domain=window.location.host, nonce, uri=window.location.origin, version='1', statement='Sign in to CipherBox encrypted storage'
            - Prompt user to sign via useSignMessage()
            - Send message + signature to backend (POST /auth/identity/wallet)
            - Receive { idToken, userId }
            - Disconnect wagmi (we don't need persistent wallet connection)
            - Call onLogin callback with idToken, userId
         e. Handle errors: wallet not installed, user rejected connection, user rejected signing, backend verification failed
         f. Show loading states appropriately
       - Props: `onLogin: (idToken: string, userId: string) => Promise<void>`, `disabled?: boolean`
       - Style: Match the terminal/hacker aesthetic of existing login components. Use CSS classes consistent with GoogleLoginButton.
       - IMPORTANT: The wagmi `connect()` returns asynchronously -- use the `onSuccess` callback from `useConnect` mutation, or use `connectAsync()` for simpler async flow. `useAccount` reflects state after re-render, not immediately after `connect()`.
       - Accessibility: Include proper aria labels, keyboard handlers per apps/web/CLAUDE.md rules

    7. Export WalletLoginButton from `apps/web/src/components/auth/index.ts`

    AVOID: Do NOT add WalletConnect connector. Only use `injected()` for EIP-6963 browser wallet discovery.
    AVOID: Do NOT use the `siwe` npm package. Use viem's SIWE utilities.
    IMPORTANT: `createSiweMessage` may be at `viem/siwe` not the main `viem` export. Check viem v2.44 API.
  </action>
  <verify>
    `pnpm --filter web build` compiles without errors.
    Grep for `getMigrationKey` in apps/web/src/ returns no results.
    Grep for `importTssKey` in apps/web/src/ returns no results.
    WalletLoginButton.tsx exists and exports the component.
    wagmi config and provider files exist.
    main.tsx includes WagmiSetup in the provider tree.
  </verify>
  <done>
    wagmi configured with injected() connector and mainnet chain. WagmiProvider wraps the app. WalletLoginButton handles full SIWE flow (connect -> nonce -> sign -> verify -> Core Kit login). loginWithWallet available in core-kit hooks. PnP migration code removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: ADR-001 cleanup + Login page + useAuth integration</name>
  <files>
    apps/web/src/lib/crypto/signatureKeyDerivation.ts
    apps/web/src/stores/auth.store.ts
    apps/web/src/hooks/useAuth.ts
    apps/web/src/routes/Login.tsx
  </files>
  <action>
    1. DELETE `apps/web/src/lib/crypto/signatureKeyDerivation.ts` entirely
       - This is the 329-line ADR-001 module -- no longer needed

    2. Update `apps/web/src/stores/auth.store.ts`:
       - Remove `DerivedKeypair` type
       - Remove `derivedKeypair` state property
       - Remove `isExternalWallet` state property
       - Remove `setDerivedKeypair` action
       - Remove `setIsExternalWallet` action
       - Remove `clearDerivedKeypair` action (and the zero-fill logic)
       - In `logout()`: Remove the derived keypair zero-fill block -- simplify to just setting all state to null/false
       - Keep: accessToken, isAuthenticated, lastAuthMethod, userEmail, teeKeys, setAccessToken, setLastAuthMethod, setUserEmail, setTeeKeys, logout

    3. Update `apps/web/src/hooks/useAuth.ts`:
       - Remove any `setDerivedKeypair` imports/usage
       - Remove any `setIsExternalWallet` imports/usage
       - Remove any references to signatureKeyDerivation
       - Add `loginWithWallet` function:
         a. Import loginWithWallet from the core-kit hooks
         b. Create a `loginWithWallet(idToken: string, userId: string)` wrapper that:
            - Calls the core-kit `loginWithWallet(idToken, userId)`
            - Gets the public key via `getPublicKeyHex()`
            - Calls backend `POST /auth/login` with `{ idToken, publicKey, loginType: 'corekit' }`
            - Sets auth store state (accessToken, isAuthenticated)
            - Loads vault keys
         c. Follow the same pattern as existing `loginWithGoogle` and `loginWithEmail` in useAuth
       - Export `loginWithWallet` from the hook return

    4. Update `apps/web/src/routes/Login.tsx`:
       - Import WalletLoginButton from components/auth
       - Add `loginWithWallet` to the destructured useAuth return
       - Create `handleWalletLogin` callback:
         ```typescript
         const handleWalletLogin = useCallback(
           async (idToken: string, userId: string) => {
             setLoginError(null);
             try {
               await loginWithWallet(idToken, userId);
             } catch (err) {
               setLoginError(err instanceof Error ? err.message : 'Wallet login failed');
             }
           },
           [loginWithWallet]
         );
         ```
       - Add `<WalletLoginButton onLogin={handleWalletLogin} disabled={isApiDown} />`
         to the login form, positioned below Google and Email options (or between them -- use Claude's discretion for best layout)
       - Add a visual separator (like "or" divider) between the wallet option and social/email options
       - Style should match the existing terminal aesthetic

    IMPORTANT: After deleting signatureKeyDerivation.ts, grep the ENTIRE apps/web/src/ directory for any remaining imports of this file. Remove all references.
    IMPORTANT: Check if any other files import from auth.store.ts and reference derivedKeypair or isExternalWallet. Common locations: useAuth.ts, vault hooks, download hooks. Remove all references.
  </action>
  <verify>
    `pnpm --filter web build` compiles without errors.
    `signatureKeyDerivation.ts` does not exist.
    Grep for `signatureKeyDerivation` in apps/web/src/ returns no results.
    Grep for `derivedKeypair` in apps/web/src/ returns no results.
    Grep for `isExternalWallet` in apps/web/src/ returns no results.
    Grep for `getMigrationKey` in apps/web/src/ returns no results.
    Login.tsx contains WalletLoginButton component.
    useAuth hook exports loginWithWallet.
  </verify>
  <done>
    ADR-001 code completely removed (signatureKeyDerivation.ts deleted, auth store cleaned, migration key removed). Login page shows wallet login alongside Google and email. useAuth provides loginWithWallet function. Frontend builds without errors.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter web build` compiles without errors
2. `pnpm --filter web lint` passes (or only pre-existing warnings)
3. No ADR-001 references anywhere in apps/web/src/ (signatureKeyDerivation, derivedKeypair, isExternalWallet, getMigrationKey, importTssKey)
4. Login page renders with Google, Email, and Wallet login options
5. WalletLoginButton exists with SIWE flow implementation
6. wagmi provider is in the component tree
7. Core Kit hooks expose loginWithWallet
</verification>

<success_criteria>
- Wallet login button appears on the login page alongside Google and email
- Clicking wallet button discovers EIP-6963 wallets (MetaMask, etc.)
- After wallet connection, SIWE message is created and user is prompted to sign
- Signed message is verified by backend and produces a CipherBox JWT
- JWT is used for Core Kit loginWithJWT producing the same MPC key as other auth methods
- All ADR-001 code is deleted from the frontend (signatureKeyDerivation.ts, derived keypair, migration key)
- Frontend builds and lints cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/12.3-siwe-unified-identity/12.3-03-SUMMARY.md`
</output>
