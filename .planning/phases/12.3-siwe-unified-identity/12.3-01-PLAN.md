---
phase: 12.3-siwe-unified-identity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/package.json
  - apps/api/src/auth/services/siwe.service.ts
  - apps/api/src/auth/services/siwe.service.spec.ts
  - apps/api/src/auth/entities/user.entity.ts
  - apps/api/src/auth/entities/auth-method.entity.ts
  - apps/api/src/auth/controllers/identity.controller.ts
  - apps/api/src/auth/controllers/identity.controller.spec.ts
  - apps/api/src/auth/dto/identity.dto.ts
  - apps/api/src/auth/auth.module.ts
  - apps/api/src/migrations/1700000000000-FullSchema.ts
autonomous: true

must_haves:
  truths:
    - "Backend can generate cryptographically random SIWE nonces stored in Redis with 5min TTL"
    - "Backend can verify a SIWE message signature and return a CipherBox JWT with sub=userId"
    - "Wallet addresses are stored as SHA-256 hashes for lookup and AES-encrypted for display"
    - "Auth method types are simplified to google, email, wallet (no external_wallet or email_passwordless)"
    - "derivationVersion column is removed from users table"
  artifacts:
    - path: "apps/api/src/auth/services/siwe.service.ts"
      provides: "SIWE nonce generation, message verification, wallet address hash/encrypt/decrypt"
      min_lines: 80
    - path: "apps/api/src/auth/services/siwe.service.spec.ts"
      provides: "Unit tests for SiweService"
      min_lines: 50
    - path: "apps/api/src/auth/controllers/identity.controller.ts"
      provides: "Wallet nonce and verify endpoints alongside existing Google/email endpoints"
      exports: ["IdentityController"]
    - path: "apps/api/src/auth/dto/identity.dto.ts"
      provides: "WalletVerifyDto for SIWE message+signature input"
      contains: "WalletVerifyDto"
    - path: "apps/api/src/auth/entities/auth-method.entity.ts"
      provides: "Updated AuthMethodType with wallet, identifier_hash and encrypted_identifier columns"
      contains: "identifier_hash"
  key_links:
    - from: "apps/api/src/auth/controllers/identity.controller.ts"
      to: "apps/api/src/auth/services/siwe.service.ts"
      via: "NestJS DI injection"
      pattern: "SiweService"
    - from: "apps/api/src/auth/controllers/identity.controller.ts"
      to: "Redis"
      via: "siwe:nonce: key prefix with 5min TTL"
      pattern: "siwe:nonce:"
    - from: "apps/api/src/auth/services/siwe.service.ts"
      to: "viem"
      via: "parseSiweMessage, verifyMessage, getAddress imports"
      pattern: "from 'viem'"
---

<objective>
Create the backend SIWE verification service, wallet login endpoints, and database schema evolution for Phase 12.3.

Purpose: This is the backend foundation for wallet-based authentication. It provides the SIWE message verification, nonce management, wallet address storage (hashed + encrypted), and the identity controller endpoints that the frontend wallet login flow will call. It also evolves the schema by removing ADR-001 artifacts (derivationVersion) and simplifying auth method types.

Output: SiweService, wallet nonce/verify endpoints on identity controller, updated entity types, updated FullSchema migration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.3-siwe-unified-identity/12.3-CONTEXT.md
@.planning/phases/12.3-siwe-unified-identity/12.3-RESEARCH.md
@.learnings/2026-02-13-phase12-corekit-identity-provider.md

Key existing files to reference:
@apps/api/src/auth/controllers/identity.controller.ts
@apps/api/src/auth/services/jwt-issuer.service.ts
@apps/api/src/auth/entities/auth-method.entity.ts
@apps/api/src/auth/entities/user.entity.ts
@apps/api/src/auth/dto/identity.dto.ts
@apps/api/src/auth/auth.module.ts
@apps/api/src/migrations/1700000000000-FullSchema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SiweService and add viem to API</name>
  <files>
    apps/api/package.json
    apps/api/src/auth/services/siwe.service.ts
    apps/api/src/auth/services/siwe.service.spec.ts
    apps/api/src/auth/services/index.ts
  </files>
  <action>
    1. Add viem to apps/api dependencies: `pnpm --filter api add viem`

    2. Create `apps/api/src/auth/services/siwe.service.ts` with:
       - Injectable NestJS service, inject ConfigService
       - `generateNonce(): string` -- uses `crypto.randomBytes(16).toString('hex')` for 32 hex char nonce
       - `async verifySiweMessage(message: string, signature: \`0x${string}\`, expectedNonce: string, expectedDomain: string): Promise<string>` -- uses viem's `parseSiweMessage`, `validateSiweMessage`, `verifyMessage`, returns checksummed address via `getAddress`
       - `hashWalletAddress(address: string): string` -- normalizes with `getAddress()`, returns SHA-256 hex digest
       - `encryptWalletAddress(address: string): string` -- AES-256-GCM encrypt with WALLET_ADDRESS_ENCRYPTION_KEY env var, format: `iv:tag:ciphertext` (all hex)
       - `decryptWalletAddress(encryptedAddress: string): string` -- reverse of encrypt
       - Private `getEncryptionKey(): Buffer` -- reads WALLET_ADDRESS_ENCRYPTION_KEY from ConfigService, throws if missing
       - Import viem utilities: `parseSiweMessage` from 'viem', `verifyMessage` from 'viem', `getAddress` from 'viem'. Note: `validateSiweMessage` may need to be imported from 'viem/siwe' -- check the actual viem exports.
       - For `verifyMessage` on the backend, use viem's standalone utility (NOT the client action). Import path may be `import { verifyMessage } from 'viem'` or use the `recoverMessageAddress` utility and compare addresses.

    3. Create `apps/api/src/auth/services/siwe.service.spec.ts` with:
       - Test nonce generation (32 hex chars, unique)
       - Test hashWalletAddress produces consistent SHA-256 for same address regardless of case
       - Test encrypt/decrypt round-trip for wallet addresses
       - Test verifySiweMessage throws UnauthorizedException for invalid signatures
       - Mock ConfigService for encryption key (use a test 32-byte hex key)

    4. Export SiweService from `apps/api/src/auth/services/index.ts`

    IMPORTANT: viem's `verifyMessage` standalone utility works without an RPC client for EOA signatures. Do NOT create a publicClient. If the standalone import doesn't work, use `recoverMessageAddress` from viem and compare with `getAddress(parsed.address)`.

    IMPORTANT: `validateSiweMessage` is in `viem/siwe`, not the main `viem` export. Check actual viem v2 exports -- the SIWE utilities might be under `viem/siwe`.

    AVOID: Do NOT import the `siwe` npm package. Use only viem's native SIWE utilities.
  </action>
  <verify>
    `pnpm --filter api test -- --testPathPattern=siwe.service` passes all tests.
    `pnpm --filter api build` compiles without errors.
  </verify>
  <done>
    SiweService exists with nonce generation, SIWE verification, wallet address hash/encrypt/decrypt. All unit tests pass. viem is installed in apps/api.
  </done>
</task>

<task type="auto">
  <name>Task 2: Evolve database schema and entity types</name>
  <files>
    apps/api/src/auth/entities/user.entity.ts
    apps/api/src/auth/entities/auth-method.entity.ts
    apps/api/src/migrations/1700000000000-FullSchema.ts
  </files>
  <action>
    1. Update `apps/api/src/auth/entities/user.entity.ts`:
       - Remove the `derivationVersion` column entirely (the @Column decorator, the property, and the JSDoc comment)
       - Keep everything else (id, publicKey, createdAt, updatedAt, refreshTokens, authMethods)

    2. Update `apps/api/src/auth/entities/auth-method.entity.ts`:
       - Change AuthMethodType to: `'google' | 'apple' | 'github' | 'email' | 'wallet'`
         (rename `email_passwordless` -> `email`, rename `external_wallet` -> `wallet`, keep apple/github for future extensibility)
       - Add new column: `@Column({ type: 'varchar', length: 64, nullable: true }) identifierHash!: string | null;`
         Database column name: `identifier_hash` (TypeORM will auto-map camelCase to snake_case if synchronize is on, but since we use migrations, set `{ name: 'identifier_hash' }`)
       - Add new column: `@Column({ type: 'text', nullable: true }) encryptedIdentifier!: string | null;`
         Database column name: `encrypted_identifier`
       - The `identifier` column stays -- for Google/email it stores the email, for wallets it stores the address hash (same as identifierHash, for backward compat with existing lookups)

    3. Update `apps/api/src/migrations/1700000000000-FullSchema.ts`:
       - Since the DB will be wiped (per CONTEXT.md decision), update the FullSchema migration directly
       - Remove `"derivationVersion" integer` from CREATE TABLE users
       - In CREATE TABLE auth_methods:
         - Change type options to match new AuthMethodType ('google', 'apple', 'github', 'email', 'wallet')
         - Add `"identifier_hash" varchar(64)` (nullable)
         - Add `"encrypted_identifier" text` (nullable)
         - Add index: `CREATE INDEX "IDX_auth_methods_identifier_hash" ON "auth_methods" ("identifier_hash")`
       - Review the existing migration SQL carefully before editing -- preserve all other tables and constraints

    IMPORTANT: Use TypeORM @Column with explicit `name` property for snake_case DB columns:
    `@Column({ name: 'identifier_hash', type: 'varchar', length: 64, nullable: true })`
  </action>
  <verify>
    `pnpm --filter api build` compiles without errors.
    Grep for `derivationVersion` in entity files returns no results.
    Grep for `external_wallet` and `email_passwordless` in entity files returns no results.
  </verify>
  <done>
    User entity has no derivationVersion. AuthMethod entity has simplified types (google/apple/github/email/wallet) and new identifierHash + encryptedIdentifier columns. FullSchema migration updated for clean installs.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add wallet endpoints to identity controller</name>
  <files>
    apps/api/src/auth/controllers/identity.controller.ts
    apps/api/src/auth/controllers/identity.controller.spec.ts
    apps/api/src/auth/dto/identity.dto.ts
    apps/api/src/auth/auth.module.ts
  </files>
  <action>
    1. Add DTOs to `apps/api/src/auth/dto/identity.dto.ts`:
       - `WalletVerifyDto` with:
         - `message: string` (IsString, IsNotEmpty) -- the full SIWE message string
         - `signature: string` (IsString, IsNotEmpty, Matches /^0x[0-9a-fA-F]+$/) -- the wallet signature as hex
       - Keep all existing DTOs (GoogleLoginDto, SendOtpDto, VerifyOtpDto, IdentityTokenResponseDto, SendOtpResponseDto)

    2. Update `apps/api/src/auth/controllers/identity.controller.ts`:
       - Inject SiweService and Redis (CACHE_MANAGER or direct ioredis injection -- check how Redis is injected in other services like EmailOtpService)
       - Add `GET identity/wallet/nonce` endpoint:
         - Rate limited: 10 requests per 60s per IP
         - Generate nonce via siweService.generateNonce()
         - Store in Redis: key=`siwe:nonce:${nonce}`, value='1', TTL=300 (5min)
         - Return `{ nonce }`
       - Add `POST identity/wallet` endpoint:
         - Rate limited: 5 requests per 15min per IP
         - Accept WalletVerifyDto body
         - Parse message to extract nonce using viem's parseSiweMessage
         - Consume nonce from Redis (del key, check it existed)
         - Get expected domain from ConfigService (SIWE_DOMAIN env var, default to request host)
         - Call siweService.verifySiweMessage(message, signature, nonce, domain)
         - Hash wallet address and find/create user (new private method)
         - Issue CipherBox JWT via jwtIssuerService.signIdentityJwt(user.id)
         - Return IdentityTokenResponseDto (idToken, userId, isNewUser)
       - Add private `findOrCreateUserByWallet(addressHash: string, walletAddress: string)` method:
         - Look up auth_methods where identifierHash = addressHash
         - If found, update lastUsedAt, return existing user
         - If not found, create new user with placeholder publicKey (same pattern as findOrCreateUserByEmail)
         - Create auth_method with type='wallet', identifier=addressHash (or the address itself -- use hash for privacy), identifierHash=addressHash, encryptedIdentifier=siweService.encryptWalletAddress(walletAddress)
       - Update `findOrCreateUserByEmail` method: change `'email_passwordless'` references to `'email'`

    3. Register SiweService in `apps/api/src/auth/auth.module.ts`:
       - Import SiweService
       - Add to providers array
       - Also ensure Redis injection is available for the identity controller (check if CACHE_MANAGER is already registered or if ioredis is directly injected)

    4. Update `apps/api/src/auth/controllers/identity.controller.spec.ts`:
       - Add tests for wallet nonce endpoint (returns nonce, stores in Redis)
       - Add tests for wallet verify endpoint (valid SIWE -> returns JWT, invalid nonce -> 401, invalid signature -> 401)
       - Mock SiweService and Redis

    IMPORTANT: Check how Redis is injected in existing services (EmailOtpService uses it for OTP storage). Follow the same injection pattern.
    IMPORTANT: The `findOrCreateUserByWallet` should follow the same placeholder publicKey pattern as `findOrCreateUserByEmail` -- create user with `pending-core-kit-${userId}` publicKey.
    IMPORTANT: Add env vars to .env.example: WALLET_ADDRESS_ENCRYPTION_KEY (32-byte hex), SIWE_DOMAIN (optional, defaults to request host).
  </action>
  <verify>
    `pnpm --filter api test -- --testPathPattern=identity.controller` passes all tests.
    `pnpm --filter api build` compiles without errors.
    Grep for `identity/wallet` in identity.controller.ts returns matches for both nonce and verify endpoints.
  </verify>
  <done>
    Identity controller has GET /auth/identity/wallet/nonce and POST /auth/identity/wallet endpoints. WalletVerifyDto validates SIWE message + signature. SiweService is registered in auth module. Redis stores nonces with 5min TTL. Wallet users can be found or created by address hash. Unit tests cover happy path and error cases.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter api build` compiles without TypeScript errors
2. `pnpm --filter api test` passes all existing + new tests
3. No references to `derivationVersion` in entity files
4. No references to `external_wallet` or `email_passwordless` in entity files
5. SiweService is properly injectable (registered in auth.module.ts)
6. Wallet endpoints are accessible in the compiled output
</verification>

<success_criteria>
- Backend can generate SIWE nonces and verify SIWE signatures using viem
- Wallet addresses are hashed (SHA-256) for lookup and encrypted (AES-256-GCM) for display
- Auth method types simplified from 5 to 5 (google/apple/github/email/wallet) with renamed email and wallet types
- derivationVersion column removed from user entity
- All API unit tests pass including new SiweService and wallet endpoint tests
</success_criteria>

<output>
After completion, create `.planning/phases/12.3-siwe-unified-identity/12.3-01-SUMMARY.md`
</output>
