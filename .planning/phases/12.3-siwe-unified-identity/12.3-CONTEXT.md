# Phase 12.3: SIWE + Unified Identity - Context

**Gathered:** 2026-02-14
**Status:** Ready for planning

## Phase Boundary

Wallet users can log in via Sign-In With Ethereum (SIWE) and all auth methods (wallet, Google, email) resolve to the same CipherBox identity and Web3Auth Core Kit key. Includes a settings page for linking/unlinking auth methods. MFA enrollment is Phase 12.4.

## Implementation Decisions

### Wallet connection library

- Use EIP-6963 (multi-injected provider discovery) / EIP-1193 compatible multi-wallet solution
- Investigate ConnectKit or similar; also check what Web3Auth provides for wallet connection
- Must support multiple wallet providers (MetaMask, Coinbase Wallet, etc.), not just MetaMask
- Researcher should investigate library options and Web3Auth's built-in wallet connection capabilities

### SIWE message format

- Standard EIP-4361 SIWE message with custom CipherBox statement
- Include human-readable statement like "Sign in to CipherBox encrypted storage"
- Standard fields: domain, URI, nonce, chain ID

### Wallet login placement

- Claude's discretion on where the wallet button goes on the login screen
- Should fit naturally with existing Google and Email options

### New wallet user flow

- Claude's discretion on first-time wallet user experience
- Options: auto-create account silently, or prompt to also add email for recovery

### Auth method linking

- **Dedicated settings page** ("Account & Security" or similar) showing linked methods
- **Show all available methods** with checkmarks on linked ones and "Link" buttons on unlinked
- **Re-verify current method first** before linking a new one (prevents session hijack linking)
- **Block unlinking last method** — must always have at least one linked method. Button disabled/hidden.
- **Multiple wallets allowed** — user can link 2+ wallet addresses to one account
- **Block cross-account links** — if an auth method already belongs to another account, show error "This [email/wallet] is already linked to another account." User must unlink from the other account first.

### Wallet address storage

- **Hash + encrypted plaintext** — SHA-256 hash for fast lookup/matching, AES-encrypted plaintext for display in settings
- Hash enables finding user by wallet address at login without exposing addresses in DB
- Encrypted plaintext allows showing the user their linked wallet addresses

### Login type simplification

- Simplify to method-based types: 'google', 'email', 'wallet' (SIWE)
- Remove 'external_wallet' and 'corekit' distinctions — everything goes through Core Kit now

### ADR-001 removal (clean break)

- **No migration path needed** — DB will be wiped before next release, no real users to migrate
- **Remove ADR-001 code entirely** — delete signatureKeyDerivation.ts and all EIP-712 signature derivation flow
- **Remove importTssKey migration code** — PnP-to-Core Kit migration flow no longer needed
- **Remove derivationVersion column** and any other PnP/ADR-001 legacy DB columns
- **Full schema cleanup** — clean schema for Core Kit-only world

### Claude's Discretion

- Wallet login button placement on login screen
- First-time wallet user onboarding flow
- Settings page layout and component structure
- SIWE nonce generation and validation approach
- Wallet connection library final choice (after research)

## Specific Ideas

- User wants multi-wallet support through standards (EIP-6963/EIP-1193), not locked to MetaMask
- Re-verification before linking is a hard requirement — security over convenience
- Clean break philosophy: since there are no real users yet, prefer clean code over backward compatibility
- Settings should show a clear overview of all available auth methods at a glance

## Deferred Ideas

- Account merging when two separate accounts want to combine — too complex for this phase, could be future work
- Wallet-specific recovery options (social recovery, etc.) — belongs in MFA phase (12.4)

---

_Phase: 12.3-siwe-unified-identity_
_Context gathered: 2026-02-14_
