---
phase: 12.3-siwe-unified-identity
plan: 02
type: execute
wave: 2
depends_on: ["12.3-01"]
files_modified:
  - apps/api/src/auth/auth.service.ts
  - apps/api/src/auth/auth.service.spec.ts
  - apps/api/src/auth/dto/login.dto.ts
  - apps/api/src/auth/dto/link-method.dto.ts
  - apps/api/src/auth/services/web3auth-verifier.service.ts
  - apps/api/src/auth/services/web3auth-verifier.service.spec.ts
  - apps/web/src/api/
autonomous: true

must_haves:
  truths:
    - "LoginType is simplified to only 'corekit' -- no 'social' or 'external_wallet' paths"
    - "Auth service login() has no ADR-001 code paths (no derivationVersion, no external_wallet handling)"
    - "Web3Auth verifier service has no external_wallet JWKS endpoint or verification branch"
    - "API client is regenerated and frontend types reflect the simplified auth types"
    - "All existing auth.service tests pass with updated expectations"
  artifacts:
    - path: "apps/api/src/auth/dto/login.dto.ts"
      provides: "Simplified LoginDto with loginType only accepting 'corekit'"
      contains: "corekit"
    - path: "apps/api/src/auth/auth.service.ts"
      provides: "Clean auth service with no ADR-001 references"
    - path: "apps/api/src/auth/services/web3auth-verifier.service.ts"
      provides: "Verifier with no external_wallet branch"
    - path: "apps/web/src/api/"
      provides: "Regenerated API client with updated types"
  key_links:
    - from: "apps/api/src/auth/auth.service.ts"
      to: "apps/api/src/auth/dto/login.dto.ts"
      via: "LoginDto import with simplified LoginType"
      pattern: "LoginType"
    - from: "apps/api/src/auth/auth.service.ts"
      to: "apps/api/src/auth/entities/auth-method.entity.ts"
      via: "Uses updated AuthMethodType ('email' not 'email_passwordless')"
      pattern: "'email'"
---

<objective>
Clean up the backend auth service by removing all ADR-001 code paths, simplifying LoginType to 'corekit' only, and regenerating the API client for the frontend.

Purpose: With the identity provider pattern from Phase 12 and the new SIWE wallet flow from Plan 01, ALL auth methods now go through CipherBox JWT -> Core Kit loginWithJWT -> backend /auth/login with loginType='corekit'. The 'social' and 'external_wallet' login types are dead code. Removing them simplifies the auth service and eliminates confusion.

Output: Clean auth.service.ts with no ADR-001 references, simplified login DTO, updated verifier service, regenerated API client.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.3-siwe-unified-identity/12.3-CONTEXT.md
@.planning/phases/12.3-siwe-unified-identity/12.3-RESEARCH.md
@.planning/phases/12.3-siwe-unified-identity/12.3-01-SUMMARY.md
@.learnings/2026-02-13-phase12-corekit-identity-provider.md

Key existing files to reference:
@apps/api/src/auth/auth.service.ts
@apps/api/src/auth/auth.service.spec.ts
@apps/api/src/auth/dto/login.dto.ts
@apps/api/src/auth/dto/link-method.dto.ts
@apps/api/src/auth/services/web3auth-verifier.service.ts
@apps/api/src/auth/services/web3auth-verifier.service.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify LoginType and clean auth service</name>
  <files>
    apps/api/src/auth/dto/login.dto.ts
    apps/api/src/auth/dto/link-method.dto.ts
    apps/api/src/auth/auth.service.ts
    apps/api/src/auth/services/web3auth-verifier.service.ts
  </files>
  <action>
    1. Update `apps/api/src/auth/dto/login.dto.ts`:
       - Change `LoginType` to just `'corekit'` (remove 'social' and 'external_wallet')
       - Remove `@IsIn(['social', 'external_wallet', 'corekit'])` -- replace with `@IsIn(['corekit'])`
       - Remove `walletAddress` optional field entirely
       - Remove `derivationVersion` optional field entirely
       - Update the `publicKey` description to remove "signature-derived public key for external wallet (ADR-001)" -- just say "secp256k1 public key from Core Kit TSS export"
       - Update the `loginType` description to remove the enum listing of social/external_wallet

    2. Update `apps/api/src/auth/dto/link-method.dto.ts`:
       - Find any references to 'external_wallet' in the login type enum/validation and replace
       - The LinkMethodDto likely has a `type` field -- update its allowed values to match the new AuthMethodType ('google', 'email', 'wallet') and add support for wallet linking
       - Add optional `walletAddress` field to LinkMethodDto for wallet-type linking (the encrypted + hashed address)

    3. Update `apps/api/src/auth/auth.service.ts`:
       - In `login()`: Remove the `'social'` and `'external_wallet'` branches from the login type switch/if-else
       - Remove any `derivationVersion` logic (saving to user, reading from DTO)
       - Remove any `walletAddress` processing from the login flow
       - Remove the `'external_wallet'` case from `extractAuthMethodType()` or equivalent helper
       - Change any remaining references to `'email_passwordless'` to `'email'`
       - The `login()` method should now only handle `loginType === 'corekit'`: verify CipherBox JWT via web3AuthVerifier, find/update user, create session tokens
       - Keep the placeholder publicKey resolution logic (replacing `pending-core-kit-*` with real publicKey)
       - In `linkMethod()` / `unlinkMethod()`: Update any 'external_wallet' references to 'wallet'
       - In `refreshByToken()`: Remove any 'external_wallet' special handling
       - In `getMethods()`: If there's any type mapping or filtering, update for new types

    4. Update `apps/api/src/auth/services/web3auth-verifier.service.ts`:
       - Remove the `'external_wallet'` JWKS endpoint and verification branch
       - Remove the `external_wallet` case from `extractAuthMethodType()`
       - The verifier should now only handle tokens verified against the CipherBox JWKS endpoint
       - If there are separate JWKS URLs for different login types, simplify to just the CipherBox identity verifier

    IMPORTANT: Read the full auth.service.ts file before making changes -- it has complex logic around auth method deduplication (see Phase 12 learnings). Preserve the dedup logic, just remove ADR-001 branches.
    IMPORTANT: Run `pnpm --filter api build` after changes to catch TypeScript null safety issues (lesson from Phase 12).
  </action>
  <verify>
    `pnpm --filter api build` compiles without errors.
    Grep for `external_wallet` in apps/api/src/auth/ returns no results.
    Grep for `derivationVersion` in apps/api/src/auth/ returns no results (except possibly comments about removal).
    Grep for `email_passwordless` in apps/api/src/auth/ returns no results.
  </verify>
  <done>
    LoginType is 'corekit' only. Auth service has no ADR-001 code paths. Web3Auth verifier has no external_wallet branch. All auth type references use simplified types (google/email/wallet).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tests and regenerate API client</name>
  <files>
    apps/api/src/auth/auth.service.spec.ts
    apps/api/src/auth/services/web3auth-verifier.service.spec.ts
    apps/web/src/api/
  </files>
  <action>
    1. Update `apps/api/src/auth/auth.service.spec.ts`:
       - Remove all tests for `loginType: 'social'` and `loginType: 'external_wallet'`
       - Update remaining tests to use `loginType: 'corekit'` exclusively
       - Remove any test fixtures using `derivationVersion` or `walletAddress` in LoginDto
       - Update any test expectations that reference 'email_passwordless' to 'email'
       - Verify coverage thresholds still pass -- if removing tests drops coverage, add tests for the simplified corekit path to compensate
       - IMPORTANT: Run `pnpm --filter api test -- --coverage` to check per-file thresholds (auth.service.ts requires ~84% branch coverage per Phase 12 learnings)

    2. Update `apps/api/src/auth/services/web3auth-verifier.service.spec.ts`:
       - Remove tests for external_wallet verification path
       - Update any test data using 'external_wallet' type
       - Ensure remaining tests cover the corekit JWT verification path

    3. Regenerate API client:
       - Run `pnpm api:generate` to regenerate the OpenAPI spec and typed client
       - This updates files in `apps/web/src/api/` to reflect the simplified DTOs
       - Verify the generated client no longer has walletAddress or derivationVersion fields in the login types

    4. Verify everything builds:
       - `pnpm --filter api test` -- all tests pass
       - `pnpm --filter api build` -- no TypeScript errors
       - `pnpm --filter web build` -- frontend still compiles with regenerated API client (may have type errors if frontend still references old fields -- that's expected, Plan 03/04 will fix)

    IMPORTANT: The frontend build may fail after api:generate because old frontend code references removed types. This is expected -- Plans 03 and 04 clean up the frontend. Just verify the API build and tests pass.
  </action>
  <verify>
    `pnpm --filter api test` passes all tests.
    `pnpm --filter api test -- --coverage` shows auth.service.ts meets coverage threshold.
    `pnpm --filter api build` compiles.
    `pnpm api:generate` completes without errors.
    Generated API client in apps/web/src/api/ reflects simplified types (no walletAddress, no derivationVersion in login types).
  </verify>
  <done>
    All auth service tests updated and passing. Coverage thresholds met. API client regenerated with simplified types. Backend is fully clean of ADR-001 code.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter api test` passes all tests (0 failures)
2. `pnpm --filter api build` compiles without errors
3. No grep hits for 'external_wallet', 'derivationVersion', 'email_passwordless' in apps/api/src/auth/ (excluding comments about removal)
4. LoginDto only accepts loginType='corekit'
5. API client regenerated successfully
</verification>

<success_criteria>
- Auth service login() handles only loginType='corekit' -- all ADR-001 code removed
- Web3Auth verifier has no external_wallet verification path
- All API tests pass with updated expectations
- Coverage thresholds met (auth.service.ts ~84% branch coverage)
- API client regenerated with simplified types
</success_criteria>

<output>
After completion, create `.planning/phases/12.3-siwe-unified-identity/12.3-02-SUMMARY.md`
</output>
