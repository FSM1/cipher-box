---
phase: 12.3-siwe-unified-identity
plan: 02
type: execute
wave: 2
depends_on: ['12.3-01']
files_modified:
  - apps/api/src/auth/auth.service.ts
  - apps/api/src/auth/auth.service.spec.ts
  - apps/api/src/auth/dto/login.dto.ts
  - apps/api/src/auth/dto/link-method.dto.ts
  - apps/api/src/auth/services/web3auth-verifier.service.ts
  - apps/api/src/auth/services/web3auth-verifier.service.spec.ts
  - apps/api/src/vault/vault.service.ts
  - apps/api/src/vault/vault.service.spec.ts
  - apps/api/src/vault/dto/vault-export.dto.ts
  - apps/web/src/api/
autonomous: true

must_haves:
  truths:
    - "LoginType is simplified to only 'corekit' -- no 'social' or 'external_wallet' paths"
    - 'Auth service login() has no ADR-001 code paths (no derivationVersion, no external_wallet handling)'
    - 'Web3Auth verifier service has no external_wallet JWKS endpoint or verification branch'
    - 'Vault export service has no derivationVersion references -- derivationInfo simplified or removed'
    - 'API client is regenerated and frontend types reflect the simplified auth types'
    - 'All existing tests pass with updated expectations'
  artifacts:
    - path: 'apps/api/src/auth/dto/login.dto.ts'
      provides: "Simplified LoginDto with loginType only accepting 'corekit'"
      contains: 'corekit'
    - path: 'apps/api/src/auth/auth.service.ts'
      provides: 'Clean auth service with no ADR-001 references'
    - path: 'apps/api/src/auth/services/web3auth-verifier.service.ts'
      provides: 'Verifier with no external_wallet branch'
    - path: 'apps/api/src/vault/vault.service.ts'
      provides: 'Vault export with no derivationVersion references'
    - path: 'apps/web/src/api/'
      provides: 'Regenerated API client with updated types'
  key_links:
    - from: 'apps/api/src/auth/auth.service.ts'
      to: 'apps/api/src/auth/dto/login.dto.ts'
      via: 'LoginDto import with simplified LoginType'
      pattern: 'LoginType'
    - from: 'apps/api/src/auth/auth.service.ts'
      to: 'apps/api/src/auth/entities/auth-method.entity.ts'
      via: "Uses updated AuthMethodType ('email' not 'email_passwordless')"
      pattern: "'email'"
---

<objective>
Clean up the backend auth service, vault service, and verifier by removing all ADR-001 code paths, simplifying LoginType to 'corekit' only, and regenerating the API client for the frontend.

Purpose: With the identity provider pattern from Phase 12 and the new SIWE wallet flow from Plan 01, ALL auth methods now go through CipherBox JWT -> Core Kit loginWithJWT -> backend /auth/login with loginType='corekit'. The 'social' and 'external_wallet' login types are dead code. Removing them simplifies the auth service and eliminates confusion. The vault export also references derivationVersion which no longer exists.

Output: Clean auth.service.ts with no ADR-001 references, simplified login DTO, updated verifier service, clean vault export, regenerated API client.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.3-siwe-unified-identity/12.3-CONTEXT.md
@.planning/phases/12.3-siwe-unified-identity/12.3-RESEARCH.md
@.planning/phases/12.3-siwe-unified-identity/12.3-01-SUMMARY.md
@.learnings/2026-02-13-phase12-corekit-identity-provider.md

Key existing files to reference:
@apps/api/src/auth/auth.service.ts
@apps/api/src/auth/auth.service.spec.ts
@apps/api/src/auth/dto/login.dto.ts
@apps/api/src/auth/dto/link-method.dto.ts
@apps/api/src/auth/services/web3auth-verifier.service.ts
@apps/api/src/auth/services/web3auth-verifier.service.spec.ts
@apps/api/src/vault/vault.service.ts
@apps/api/src/vault/vault.service.spec.ts
@apps/api/src/vault/dto/vault-export.dto.ts
</context>

<tasks>

<task type="auto">
<name>Task 1: Simplify LoginType, clean auth service, and clean vault export</name>
<files>
apps/api/src/auth/dto/login.dto.ts
apps/api/src/auth/dto/link-method.dto.ts
apps/api/src/auth/auth.service.ts
apps/api/src/auth/services/web3auth-verifier.service.ts
apps/api/src/vault/vault.service.ts
apps/api/src/vault/dto/vault-export.dto.ts
</files>
<action>
Update `apps/api/src/auth/dto/login.dto.ts`: Change `LoginType` to just `'corekit'` (remove 'social' and 'external_wallet'). Remove `@IsIn` validator listing old types -- replace with `@IsIn(['corekit'])`. Remove `walletAddress` optional field entirely. Remove `derivationVersion` optional field entirely. Update descriptions to remove mentions of social/external_wallet.

Update `apps/api/src/auth/dto/link-method.dto.ts`: Find any references to 'external_wallet' in the login type enum/validation and replace. Update allowed type values to match new AuthMethodType ('google', 'email', 'wallet'). Add optional `walletAddress`, `siweMessage`, and `siweSignature` fields for wallet-type linking.

Update `apps/api/src/auth/auth.service.ts`: In `login()`, remove the 'social' and 'external_wallet' branches from the login type switch/if-else. Remove any `derivationVersion` logic (saving to user, reading from DTO). Remove any `walletAddress` processing from the login flow. Remove 'external_wallet' case from `extractAuthMethodType()` or equivalent helper. Change any remaining references to 'email_passwordless' to 'email'. The `login()` method should now only handle `loginType === 'corekit'`. Keep the placeholder publicKey resolution logic. In `linkMethod()` / `unlinkMethod()`, update any 'external_wallet' references to 'wallet'. In `refreshByToken()`, remove any 'external_wallet' special handling. In `getMethods()`, update any type mapping for new types.

Update `apps/api/src/auth/services/web3auth-verifier.service.ts`: Remove the 'external_wallet' JWKS endpoint and verification branch. Remove the `external_wallet` case from `extractAuthMethodType()`. The verifier should now only handle tokens verified against the CipherBox JWKS endpoint.

Update `apps/api/src/vault/vault.service.ts`: Find the vault export logic that reads `user.derivationVersion` to determine `derivationInfo`. Remove the `derivationVersion`-based branching. Set `derivationInfo` to always be `{ method: 'web3auth', derivationVersion: null }` or simply remove it. Since all users now use Core Kit, the method is always 'web3auth'.

Update `apps/api/src/vault/dto/vault-export.dto.ts`: Simplify or keep the `derivationVersion` field but it will always be null. Alternatively, remove it since there's only one derivation method now.

IMPORTANT: Read the full auth.service.ts before making changes -- it has complex logic around auth method deduplication (see Phase 12 learnings). Preserve the dedup logic, just remove ADR-001 branches.
IMPORTANT: Run `pnpm --filter api build` after changes to catch TypeScript null safety issues (lesson from Phase 12).
</action>
<verify>
`pnpm --filter api build` compiles without errors.
Grep for `external_wallet` in apps/api/src/auth/ returns no results.
Grep for `derivationVersion` in apps/api/src/ returns no results (entire api src tree).
Grep for `email_passwordless` in apps/api/src/auth/ returns no results.
</verify>
<done>
LoginType is 'corekit' only. Auth service has no ADR-001 code paths. Web3Auth verifier has no external_wallet branch. Vault export has no derivationVersion references. All auth type references use simplified types.
</done>
</task>

<task type="auto">
<name>Task 2: Update tests and regenerate API client</name>
<files>
apps/api/src/auth/auth.service.spec.ts
apps/api/src/auth/services/web3auth-verifier.service.spec.ts
apps/api/src/vault/vault.service.spec.ts
apps/web/src/api/
</files>
<action>
Update `apps/api/src/auth/auth.service.spec.ts`: Remove all tests for `loginType: 'social'` and `loginType: 'external_wallet'`. Update remaining tests to use `loginType: 'corekit'` exclusively. Remove any test fixtures using `derivationVersion` or `walletAddress` in LoginDto. Update expectations referencing 'email_passwordless' to 'email'. Check coverage thresholds -- auth.service.ts requires ~84% branch coverage per Phase 12 learnings. Run `pnpm --filter api test -- --coverage` to verify.

Update `apps/api/src/auth/services/web3auth-verifier.service.spec.ts`: Remove tests for external_wallet verification path. Update any test data using 'external_wallet' type. Ensure remaining tests cover the corekit JWT verification path.

Update `apps/api/src/vault/vault.service.spec.ts`: Remove or update test cases that mock `user.derivationVersion` values. Remove the test that sets `derivationVersion: 1` for external wallet. Update the web3auth derivation test to not set `derivationVersion: null` on the mock user. Update any mock user objects to not include `derivationVersion`.

Regenerate API client: Run `pnpm api:generate` to regenerate the OpenAPI spec and typed client. This updates files in `apps/web/src/api/` to reflect the simplified DTOs. Verify the generated client no longer has walletAddress, derivationVersion, `external_wallet`, or `email_passwordless` types.

Verify everything builds: `pnpm --filter api test` (all tests pass), `pnpm --filter api build` (no TypeScript errors). The frontend build may fail after api:generate because old frontend code references removed types -- that is expected and Plans 03/04 will fix it.
</action>
<verify>
`pnpm --filter api test` passes all tests.
`pnpm --filter api test -- --coverage` shows auth.service.ts meets coverage threshold.
`pnpm --filter api build` compiles.
`pnpm api:generate` completes without errors.
Grep for `external_wallet` in apps/web/src/api/ returns no results (regenerated client is clean).
Grep for `derivationVersion` in apps/api/src/ returns no results.
</verify>
<done>
All auth service tests updated and passing. Vault export tests updated. Coverage thresholds met. API client regenerated with simplified types. Backend is fully clean of ADR-001 code.
</done>
</task>

</tasks>

<verification>

1. `pnpm --filter api test` passes all tests (0 failures)
2. `pnpm --filter api build` compiles without errors
3. No grep hits for 'external_wallet', 'derivationVersion', 'email_passwordless' in apps/api/src/
4. LoginDto only accepts loginType='corekit'
5. API client regenerated successfully with clean types
6. Vault export has no derivationVersion branching

</verification>

<success_criteria>

- Auth service login() handles only loginType='corekit' -- all ADR-001 code removed
- Web3Auth verifier has no external_wallet verification path
- Vault export has no derivationVersion logic
- All API tests pass with updated expectations
- Coverage thresholds met (auth.service.ts ~84% branch coverage)
- API client regenerated with simplified types

</success_criteria>

<output>
After completion, create `.planning/phases/12.3-siwe-unified-identity/12.3-02-SUMMARY.md`
</output>
