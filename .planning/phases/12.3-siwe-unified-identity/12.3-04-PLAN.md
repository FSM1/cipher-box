---
phase: 12.3-siwe-unified-identity
plan: 04
type: execute
wave: 4
depends_on: ["12.3-03"]
files_modified:
  - apps/web/src/components/auth/LinkedMethods.tsx
  - apps/web/src/hooks/useLinkedMethods.ts
  - apps/web/src/routes/Settings.tsx
  - apps/api/src/auth/auth.service.ts
  - apps/api/src/auth/dto/link-method.dto.ts
autonomous: true

must_haves:
  truths:
    - "User can see all linked auth methods on the settings page with type labels and identifiers"
    - "User can link a new wallet address from settings (re-verify current session first)"
    - "User can link Google or email from settings (re-verify current session first)"
    - "User cannot unlink their last auth method (button disabled)"
    - "Linking a method already belonging to another account shows an error"
    - "Wallet addresses display as truncated checksummed addresses (0x1234...abcd)"
  artifacts:
    - path: "apps/web/src/components/auth/LinkedMethods.tsx"
      provides: "Full auth method management UI with all method types, link/unlink, re-verify flow"
      min_lines: 100
    - path: "apps/web/src/hooks/useLinkedMethods.ts"
      provides: "Hook for fetching, linking, and unlinking auth methods"
    - path: "apps/web/src/routes/Settings.tsx"
      provides: "Settings page with Account & Security section"
  key_links:
    - from: "apps/web/src/components/auth/LinkedMethods.tsx"
      to: "/auth/methods"
      via: "GET linked methods list, POST link, DELETE unlink"
      pattern: "authApi"
    - from: "apps/web/src/components/auth/LinkedMethods.tsx"
      to: "apps/web/src/components/auth/WalletLoginButton.tsx"
      via: "Reuses wallet connection flow for linking a wallet"
      pattern: "WalletLoginButton"
    - from: "apps/web/src/components/auth/LinkedMethods.tsx"
      to: "apps/web/src/components/auth/GoogleLoginButton.tsx"
      via: "Reuses Google OAuth flow for linking Google"
      pattern: "GoogleLoginButton"
---

<objective>
Build the auth method management UI on the settings page where users can view all linked methods, link new auth methods (Google, email, wallet), and unlink existing ones with proper security re-verification.

Purpose: This delivers success criterion #2 -- "User can link additional auth methods from settings." The LinkedMethods component was left as a stub in Phase 12 with a TODO for Phase 12.3. This plan implements the full linking flow with re-verification, cross-account collision detection, and wallet address display.

Output: Working settings page with auth method management (view, link, unlink) for all three auth types (Google, email, wallet).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.3-siwe-unified-identity/12.3-CONTEXT.md
@.planning/phases/12.3-siwe-unified-identity/12.3-RESEARCH.md
@.planning/phases/12.3-siwe-unified-identity/12.3-01-SUMMARY.md
@.planning/phases/12.3-siwe-unified-identity/12.3-02-SUMMARY.md
@.planning/phases/12.3-siwe-unified-identity/12.3-03-SUMMARY.md

Key existing files to reference:
@apps/web/src/components/auth/LinkedMethods.tsx
@apps/web/src/hooks/useLinkedMethods.ts
@apps/web/src/routes/Settings.tsx
@apps/web/src/components/auth/GoogleLoginButton.tsx
@apps/web/src/components/auth/EmailLoginForm.tsx
@apps/web/src/components/auth/WalletLoginButton.tsx
@apps/api/src/auth/auth.service.ts
@apps/api/src/auth/dto/link-method.dto.ts
@apps/web/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend link method support for wallet type</name>
  <files>
    apps/api/src/auth/auth.service.ts
    apps/api/src/auth/dto/link-method.dto.ts
  </files>
  <action>
    1. Update `apps/api/src/auth/dto/link-method.dto.ts`:
       - Ensure LinkMethodDto accepts type 'wallet' alongside 'google' and 'email'
       - Add optional fields for wallet linking:
         - `walletAddress?: string` -- the checksummed wallet address (will be hashed + encrypted)
         - `siweMessage?: string` -- the signed SIWE message (for verification)
         - `siweSignature?: string` -- the wallet signature
       - These are only required when type='wallet' -- add conditional validation or validate in the service layer

    2. Update `apps/api/src/auth/auth.service.ts` `linkMethod()`:
       - For wallet type: verify the SIWE message/signature first (inject SiweService if not already)
       - Hash the wallet address for lookup
       - Check for cross-account collision: query auth_methods for existing row with same identifierHash and different userId -> throw BadRequestException with "This wallet is already linked to another account"
       - Create the auth method with type='wallet', identifier=identifierHash, identifierHash=identifierHash, encryptedIdentifier=encrypted address
       - For Google/email types: the existing linking flow should still work but verify it uses the updated type names ('email' not 'email_passwordless')

    3. Update `getMethods()` in auth.service.ts:
       - When returning methods to the frontend, decrypt wallet addresses for display
       - For wallet type methods: replace the `identifier` field in the response with the decrypted wallet address (or a truncated version)
       - For Google/email: identifier is already the email, return as-is
       - Use SiweService.decryptWalletAddress() for wallet type methods

    4. Run `pnpm api:generate` after changes to update the API client

    IMPORTANT: Cross-account collision check is a hard requirement from CONTEXT.md -- "Block cross-account links -- if an auth method already belongs to another account, show error."
    IMPORTANT: Block unlinking last method is already handled in the frontend but should also be enforced backend-side -- check if there's a server-side guard. If not, add one: count auth methods for userId, reject unlink if count <= 1.
  </action>
  <verify>
    `pnpm --filter api build` compiles without errors.
    `pnpm --filter api test` passes.
    `pnpm api:generate` completes successfully.
    LinkMethodDto accepts wallet type with SIWE fields.
    getMethods returns decrypted wallet addresses for wallet-type methods.
  </verify>
  <done>
    Backend supports linking wallet auth methods with SIWE verification. Cross-account collision is detected and rejected. getMethods returns decrypted wallet addresses for display. Last-method unlink is blocked server-side. API client regenerated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rebuild LinkedMethods UI with full auth method management</name>
  <files>
    apps/web/src/components/auth/LinkedMethods.tsx
    apps/web/src/hooks/useLinkedMethods.ts
    apps/web/src/routes/Settings.tsx
  </files>
  <action>
    1. Update `apps/web/src/hooks/useLinkedMethods.ts`:
       - Keep the existing query/mutation pattern
       - Update the `linkMethod` mutation to handle the new DTO shape (wallet fields)
       - Add type safety for the linking payload (Google needs idToken, email needs email+OTP, wallet needs SIWE message+signature+address)

    2. Rebuild `apps/web/src/components/auth/LinkedMethods.tsx`:
       This is a full rewrite of the stub. Structure:

       a. **Method display section:**
          - Show a card/row for each linked method with:
            - Type icon/label (Google, Email, Wallet)
            - Identifier (email address for Google/email, truncated wallet address for wallet like `0x1234...abcd`)
            - "Linked" badge
            - Unlink button (disabled if it's the last method, with tooltip explaining why)
          - Update METHOD_LABELS to use new types: `{ google: 'Google', email: 'Email', wallet: 'Wallet' }` (remove apple, github, email_passwordless, external_wallet)

       b. **Available methods section:**
          - Show auth methods that are NOT yet linked
          - For each available type, show a "Link [Type]" button
          - Available types are derived by diffing all possible types against linked types
          - Multiple wallets are allowed (user can link 2+ wallet addresses) so wallet always shows as available

       c. **Link flow (re-verification required per CONTEXT.md):**
          The user's current session proves they own the account. To link a NEW method, they must prove they own that new method:

          - **Link Google:** Show GoogleLoginButton in "link mode" -- user clicks, completes Google OAuth, component gets Google idToken. Send idToken to backend link endpoint. Backend verifies Google token, creates auth method link.
          - **Link Email:** Show EmailLoginForm in "link mode" -- user enters email, receives OTP, submits OTP. Backend verifies OTP, creates auth method link.
          - **Link Wallet:** Show wallet connection flow (reuse WalletLoginButton logic or create a WalletLinkFlow sub-component) -- user connects wallet, signs SIWE message, component sends SIWE message+signature+address to backend link endpoint. Backend verifies SIWE, creates auth method link.

          Implementation approach: Use a modal or expandable section that appears when user clicks "Link [Type]". The section contains the appropriate login component in "link mode" (not navigating away from settings).

       d. **Error handling:**
          - Cross-account collision: Display "This [email/wallet] is already linked to another account" error from backend
          - Network errors: Display generic error with retry option
          - Linking errors: Show inline error near the link button

       e. **Styling:**
          - Match terminal/hacker aesthetic (dark theme, monospace fonts, green accents)
          - Cards/rows for each method
          - Consistent with rest of settings page

       IMPORTANT from CONTEXT.md: "Re-verify current method first before linking a new one" -- This is satisfied by the user already being authenticated (they had to log in to reach settings). The linking flow verifies ownership of the NEW method (Google token, email OTP, or SIWE signature). No need to re-prompt for the current method.

       Actually, re-read CONTEXT.md: "Re-verify current method first before linking a new one (prevents session hijack linking)". This means before linking, the user should re-prove they own their CURRENT auth method, not just be logged in. Implementation: Before showing the link form, prompt the user to re-authenticate with their current method (e.g., if logged in via Google, show Google re-auth; if via email, resend OTP). This prevents a session hijack scenario where an attacker with a stolen session token links their own method.

       Practical approach: Add a "Verify Identity" step before linking. Show a re-auth prompt using the user's primary (most recently used) auth method. After re-verification, allow the linking flow to proceed. This can be a simple modal: "To link a new method, please verify your identity first" with the appropriate login component.

       If this adds too much complexity, at minimum implement: user clicks "Link" -> user re-authenticates with ANY of their current methods -> link form appears. The simplest version: re-enter password/OTP for email users, re-sign SIWE for wallet users, re-Google-auth for Google users.

    3. Update `apps/web/src/routes/Settings.tsx`:
       - Rename the section heading from just "Settings" to include "Account & Security" section
       - Add brief description text explaining what auth method linking does
       - The LinkedMethods component handles all the actual linking UI
       - Ensure the layout works well with the expanded LinkedMethods component

    Accessibility requirements (per apps/web/CLAUDE.md):
    - All interactive elements need proper aria labels
    - Custom buttons need keyboard handlers (Enter + Space)
    - Focus-visible styles on all interactive elements
    - Use `role="alert"` for error messages
  </action>
  <verify>
    `pnpm --filter web build` compiles without errors.
    `pnpm --filter web lint` passes.
    LinkedMethods.tsx is more than 100 lines (not a stub).
    Settings page renders with Account & Security section.
    Grep for `email_passwordless` and `external_wallet` in LinkedMethods.tsx returns no results.
  </verify>
  <done>
    Settings page shows all linked auth methods with proper labels and identifiers. Users can link new Google, email, or wallet methods with re-verification. Users cannot unlink their last method. Cross-account collision errors are displayed. Wallet addresses show as truncated checksummed format.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter web build` compiles without errors
2. `pnpm --filter api build` compiles without errors
3. `pnpm --filter api test` passes all tests
4. Settings page renders LinkedMethods with all method types
5. Link flow requires re-verification before proceeding
6. Unlink is blocked for the last method (both UI and backend)
7. Cross-account collision shows error message
8. No references to old auth types (email_passwordless, external_wallet) in the modified files
</verification>

<success_criteria>
- User can see all linked methods on settings page with correct type labels
- User can link a new wallet address via SIWE signing
- User can link Google or email via their respective re-verification flows
- Unlinking the last method is blocked (disabled button + backend guard)
- Cross-account collision shows clear error message
- Wallet addresses display as truncated checksummed format (0x1234...abcd)
- All builds pass, no lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/12.3-siwe-unified-identity/12.3-04-SUMMARY.md`
</output>
