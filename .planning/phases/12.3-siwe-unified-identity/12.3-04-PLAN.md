---
phase: 12.3-siwe-unified-identity
plan: 04
type: execute
wave: 4
depends_on: ['12.3-03']
files_modified:
  - apps/web/src/components/auth/LinkedMethods.tsx
  - apps/web/src/hooks/useLinkedMethods.ts
  - apps/web/src/routes/Settings.tsx
  - apps/api/src/auth/auth.service.ts
  - apps/api/src/auth/dto/link-method.dto.ts
autonomous: true

must_haves:
  truths:
    - 'User can see all linked auth methods on the settings page with type labels and identifiers'
    - 'User can link a new wallet address from settings (re-verify ownership of new method)'
    - 'User can link Google or email from settings (re-verify ownership of new method)'
    - 'User cannot unlink their last auth method (button disabled + backend guard)'
    - 'Linking a method already belonging to another account shows an error'
    - 'Wallet addresses display as truncated checksummed addresses (0x1234...abcd)'
  artifacts:
    - path: 'apps/web/src/components/auth/LinkedMethods.tsx'
      provides: 'Full auth method management UI with all method types, link/unlink, verification flow'
      min_lines: 100
    - path: 'apps/web/src/hooks/useLinkedMethods.ts'
      provides: 'Hook for fetching, linking, and unlinking auth methods'
    - path: 'apps/web/src/routes/Settings.tsx'
      provides: 'Settings page with Account & Security section'
  key_links:
    - from: 'apps/web/src/components/auth/LinkedMethods.tsx'
      to: '/auth/methods'
      via: 'GET linked methods list, POST link, DELETE unlink'
      pattern: 'authApi'
    - from: 'apps/web/src/components/auth/LinkedMethods.tsx'
      to: 'apps/web/src/components/auth/WalletLoginButton.tsx'
      via: 'Reuses wallet connection flow for linking a wallet'
      pattern: 'WalletLoginButton'
    - from: 'apps/web/src/components/auth/LinkedMethods.tsx'
      to: 'apps/web/src/components/auth/GoogleLoginButton.tsx'
      via: 'Reuses Google OAuth flow for linking Google'
      pattern: 'GoogleLoginButton'
---

<objective>
Build the auth method management UI on the settings page where users can view all linked methods, link new auth methods (Google, email, wallet), and unlink existing ones with proper security verification.

Purpose: This delivers success criterion #2 -- "User can link additional auth methods from settings." The LinkedMethods component was left as a stub in Phase 12 with a TODO for Phase 12.3. This plan implements the full linking flow with ownership verification, cross-account collision detection, and wallet address display.

Output: Working settings page with auth method management (view, link, unlink) for all three auth types (Google, email, wallet).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.3-siwe-unified-identity/12.3-CONTEXT.md
@.planning/phases/12.3-siwe-unified-identity/12.3-RESEARCH.md
@.planning/phases/12.3-siwe-unified-identity/12.3-01-SUMMARY.md
@.planning/phases/12.3-siwe-unified-identity/12.3-02-SUMMARY.md
@.planning/phases/12.3-siwe-unified-identity/12.3-03-SUMMARY.md

Key existing files to reference:
@apps/web/src/components/auth/LinkedMethods.tsx
@apps/web/src/hooks/useLinkedMethods.ts
@apps/web/src/routes/Settings.tsx
@apps/web/src/components/auth/GoogleLoginButton.tsx
@apps/web/src/components/auth/EmailLoginForm.tsx
@apps/web/src/components/auth/WalletLoginButton.tsx
@apps/api/src/auth/auth.service.ts
@apps/api/src/auth/dto/link-method.dto.ts
@apps/web/CLAUDE.md
</context>

<tasks>

<task type="auto">
<name>Task 1: Backend link method support for wallet type</name>
<files>
apps/api/src/auth/auth.service.ts
apps/api/src/auth/dto/link-method.dto.ts
</files>
<action>
Update `apps/api/src/auth/dto/link-method.dto.ts`: Ensure LinkMethodDto accepts type 'wallet' alongside 'google' and 'email'. Add optional fields for wallet linking: `walletAddress?: string` (checksummed address), `siweMessage?: string`, `siweSignature?: string`. These are only required when type='wallet' -- validate in the service layer.

Update `apps/api/src/auth/auth.service.ts` `linkMethod()`: For wallet type, verify the SIWE message/signature first (inject SiweService if not already). Hash the wallet address for lookup. Check for cross-account collision: query auth_methods for existing row with same identifierHash and different userId, throw BadRequestException with "This wallet is already linked to another account". Create the auth method with type='wallet', identifier=addressHash, identifierHash=addressHash, identifierDisplay=truncated address (use SiweService.truncateWalletAddress()). For Google/email types, verify it uses the updated type names ('email' not 'email_passwordless').

Update `getMethods()` in auth.service.ts: When returning methods to the frontend, for wallet type methods use the `identifierDisplay` field (truncated address like "0xAbCd...1234") as the display value. For Google/email, identifier is already the email, return as-is. No decryption needed â€” display values are stored truncated in plaintext.

Add or verify last-method unlink guard: In `unlinkMethod()`, count auth methods for userId, reject unlink if count <= 1 with BadRequestException "Cannot unlink your last authentication method".

Run `pnpm api:generate` after changes to update the API client.

IMPORTANT: Cross-account collision check is a hard requirement from CONTEXT.md.
</action>
<verify>
`pnpm --filter api build` compiles without errors.
`pnpm --filter api test` passes.
`pnpm api:generate` completes successfully.
LinkMethodDto accepts wallet type with SIWE fields.
getMethods returns truncated wallet addresses for wallet-type methods.
</verify>
<done>
Backend supports linking wallet auth methods with SIWE verification. Cross-account collision is detected and rejected. getMethods returns truncated wallet display strings. Last-method unlink is blocked server-side. API client regenerated.
</done>
</task>

<task type="auto">
<name>Task 2: Rebuild LinkedMethods UI with full auth method management</name>
<files>
apps/web/src/components/auth/LinkedMethods.tsx
apps/web/src/hooks/useLinkedMethods.ts
apps/web/src/routes/Settings.tsx
</files>
<action>
Update `apps/web/src/hooks/useLinkedMethods.ts`: Keep the existing query/mutation pattern. Update the `linkMethod` mutation to handle the new DTO shape (wallet fields). Add type safety for the linking payload.

Rebuild `apps/web/src/components/auth/LinkedMethods.tsx` -- full rewrite of the stub:

**Method display section:** Show a card/row for each linked method with type icon/label (Google, Email, Wallet), identifier (email for Google/email, truncated wallet address for wallet like `0x1234...abcd`), "Linked" badge, and unlink button (disabled if it's the last method, with tooltip explaining why). Use METHOD_LABELS: `{ google: 'Google', email: 'Email', wallet: 'Wallet' }`.

**Available methods section:** Show auth methods that are NOT yet linked, with a "Link [Type]" button for each. Multiple wallets are allowed so wallet always shows as available.

**Link flow (ownership verification per CONTEXT.md):** The user's current session proves they own the account. To link a NEW method, they must prove they own that new method:

- Link Google: Show GoogleLoginButton in "link mode" -- user completes Google OAuth, gets idToken, sends to backend link endpoint.
- Link Email: Show EmailLoginForm in "link mode" -- user enters email, receives OTP, submits. Backend verifies OTP, creates link.
- Link Wallet: Show wallet connection flow -- user connects wallet, signs SIWE message, sends SIWE message+signature+address to backend link endpoint.

Implementation approach: Use a modal or expandable section that appears when user clicks "Link [Type]". The section contains the appropriate login component in "link mode" (not navigating away from settings).

**Re-verification before linking (CONTEXT.md requirement):** CONTEXT.md says: "Re-verify current method first before linking a new one." The user is already authenticated (session exists), and the linking endpoint requires a fresh verification of the NEW method being linked. The linking endpoint also verifies the user's current session via JWT auth guard. If a full re-authentication step adds too much complexity, document it as a TODO for hardening.

**Error handling:** Cross-account collision: Display "This [email/wallet] is already linked to another account" error from backend. Network errors: Display generic error with retry option. Linking errors: Show inline error near the link button.

**Styling:** Match terminal/hacker aesthetic (dark theme, monospace fonts, green accents). Cards/rows for each method. Consistent with rest of settings page.

Update `apps/web/src/routes/Settings.tsx`: Rename the section heading to include "Account & Security" section. Add brief description text. Ensure the layout works well with the expanded LinkedMethods component.

Accessibility requirements (per apps/web/CLAUDE.md): All interactive elements need proper aria labels. Custom buttons need keyboard handlers (Enter + Space). Focus-visible styles on all interactive elements. Use `role="alert"` for error messages.
</action>
<verify>
`pnpm --filter web build` compiles without errors.
`pnpm --filter web lint` passes.
LinkedMethods.tsx is more than 100 lines (not a stub).
Settings page renders with Account & Security section.
Grep for `email_passwordless` and `external_wallet` in LinkedMethods.tsx returns no results.
</verify>
<done>
Settings page shows all linked auth methods with proper labels and identifiers. Users can link new Google, email, or wallet methods with ownership verification. Users cannot unlink their last method. Cross-account collision errors are displayed. Wallet addresses show as truncated checksummed format.
</done>
</task>

</tasks>

<verification>

1. `pnpm --filter web build` compiles without errors
2. `pnpm --filter api build` compiles without errors
3. `pnpm --filter api test` passes all tests
4. Settings page renders LinkedMethods with all method types
5. Link flow verifies ownership of the new method before linking
6. Unlink is blocked for the last method (both UI and backend)
7. Cross-account collision shows error message
8. No references to old auth types (email_passwordless, external_wallet) in the modified files

</verification>

<success_criteria>

- User can see all linked methods on settings page with correct type labels
- User can link a new wallet address via SIWE signing
- User can link Google or email via their respective verification flows
- Unlinking the last method is blocked (disabled button + backend guard)
- Cross-account collision shows clear error message
- Wallet addresses display as truncated checksummed format (0x1234...abcd)
- All builds pass, no lint errors

</success_criteria>

<output>
After completion, create `.planning/phases/12.3-siwe-unified-identity/12.3-04-SUMMARY.md`
</output>
