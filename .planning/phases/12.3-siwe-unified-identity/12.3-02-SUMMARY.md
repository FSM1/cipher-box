---
phase: 12.3-siwe-unified-identity
plan: 02
subsystem: auth
tags: [jwt, corekit, web3auth, vault-export, cleanup, dto]

# Dependency graph
requires:
  - phase: 12.3-01
    provides: SIWE service, wallet endpoints, schema evolution (auth method types, identifier columns)
  - phase: 12
    provides: Core Kit identity provider pattern, CipherBox JWT verification
provides:
  - Simplified LoginType (corekit only, no social/external_wallet)
  - Clean auth.service with no ADR-001 code paths
  - Clean web3auth-verifier.service with no external_wallet branch
  - Simplified vault export (derivationMethod string instead of derivationInfo object)
  - Updated LinkMethodDto with auth method types (google/email/wallet)
  - Regenerated API client with simplified types
affects: [12.3-03, 12.3-04]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'All logins go through CipherBox JWT -> verifyCipherBoxJwt() (no PnP/external_wallet paths)'
    - 'LinkMethodDto uses auth method type directly (google/email/wallet) instead of loginType routing'

key-files:
  created: []
  modified:
    - apps/api/src/auth/dto/login.dto.ts
    - apps/api/src/auth/dto/link-method.dto.ts
    - apps/api/src/auth/auth.service.ts
    - apps/api/src/auth/services/web3auth-verifier.service.ts
    - apps/api/src/vault/vault.service.ts
    - apps/api/src/vault/dto/vault-export.dto.ts
    - apps/api/src/auth/auth.service.spec.ts
    - apps/api/src/auth/services/web3auth-verifier.service.spec.ts
    - apps/api/src/vault/vault.service.spec.ts
    - apps/api/src/auth/auth.controller.spec.ts
    - apps/web/src/api/ (regenerated client)
    - packages/api-client/openapi.json

key-decisions:
  - 'Web3AuthVerifierService decoupled from auth.service -- no longer injected or used in login/link flows'
  - 'LinkMethodDto type field uses auth method types (google/email/wallet) directly instead of routing through loginType'
  - "Vault export derivationInfo simplified to derivationMethod string -- always 'web3auth' for Core Kit users"

patterns-established:
  - 'Single login path: all auth -> verifyCipherBoxJwt -> find/create user -> find/create auth method'
  - 'LinkMethod uses CipherBox JWT verification, not Web3Auth verification'

# Metrics
duration: 9min
completed: 2026-02-14
---

# Phase 12.3 Plan 02: ADR-001 Cleanup Summary

Removed all ADR-001 code paths (social/external_wallet login types, derivationVersion) from auth service, vault service, verifier, and DTOs; simplified to corekit-only login with CipherBox JWT.

## Performance

- **Duration:** 9 min
- **Started:** 2026-02-14T07:10:13Z
- **Completed:** 2026-02-14T07:19:37Z
- **Tasks:** 2/2
- **Files modified:** 15

## Accomplishments

- Simplified LoginType from 3 values (social/external_wallet/corekit) to 1 (corekit)
- Removed entire PnP/external_wallet branch from auth.service.login() -- all logins now go through verifyCipherBoxJwt()
- Removed Web3AuthVerifierService dependency from auth.service (no longer injected)
- Cleaned web3auth-verifier.service: removed external_wallet JWKS endpoint and loginType parameter
- Simplified vault export: replaced DerivationInfoDto (method + derivationVersion) with simple derivationMethod string
- Updated LinkMethodDto to accept auth method types directly (google/email/wallet) with optional SIWE fields
- All 450 tests pass with coverage thresholds met

## Task Commits

Each task was committed atomically:

1. **Task 1: Simplify LoginType, clean auth service, and clean vault export** - `cc58723ef` (refactor)
2. **Task 2: Update tests and regenerate API client** - `e091a846f` (test)

## Files Created/Modified

- `apps/api/src/auth/dto/login.dto.ts` - LoginType simplified to 'corekit' only, removed walletAddress and derivationVersion fields
- `apps/api/src/auth/dto/link-method.dto.ts` - Changed loginType to google/email/wallet, added optional SIWE fields
- `apps/api/src/auth/auth.service.ts` - Removed PnP branch from login(), removed web3AuthVerifier dependency, simplified linkMethod to use CipherBox JWT
- `apps/api/src/auth/services/web3auth-verifier.service.ts` - Removed external_wallet JWKS endpoint, simplified verifyIdToken to 2-arg signature
- `apps/api/src/vault/vault.service.ts` - Removed derivationInfo object, replaced with derivationMethod string
- `apps/api/src/vault/dto/vault-export.dto.ts` - Replaced DerivationInfoDto with simple derivationMethod field
- `apps/api/src/auth/auth.service.spec.ts` - Removed social/external_wallet tests, updated all to corekit, added coverage for edge cases
- `apps/api/src/auth/services/web3auth-verifier.service.spec.ts` - Removed external_wallet tests, updated to simplified 2-arg API
- `apps/api/src/vault/vault.service.spec.ts` - Updated export tests for derivationMethod
- `apps/api/src/auth/auth.controller.spec.ts` - Updated loginType from 'social' to 'corekit'
- `apps/web/src/api/` - Regenerated API client (5 model files updated, 1 created)
- `packages/api-client/openapi.json` - Updated OpenAPI spec

## Decisions Made

- **Web3AuthVerifierService decoupled from auth.service:** The verifier service is still in the module but no longer injected into auth.service. It remains available for any future use but is not part of the main login flow.
- **LinkMethodDto uses auth method types directly:** Instead of routing through 'social'/'external_wallet' loginType, the DTO now accepts 'google'/'email'/'wallet' directly. This matches the new identity provider pattern where all auth goes through CipherBox JWT.
- **Vault export simplified:** DerivationInfoDto (with method + derivationVersion) was overkill since derivationVersion is always null. Replaced with a simple `derivationMethod: string | null` field.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Added additional test coverage for branch threshold**

- **Found during:** Task 2 (Update tests)
- **Issue:** After removing PnP branches, remaining branches represented a larger percentage of total. Branch coverage dropped to 76.36% vs 84% threshold.
- **Fix:** Added 6 new tests: production guard for testLogin, identifier fallback chains (sub-only, unknown), placeholder skip without verifierId, non-Error JWT exceptions, linkMethod JWT failure
- **Files modified:** apps/api/src/auth/auth.service.spec.ts
- **Verification:** Coverage threshold now met, 450 tests pass
- **Committed in:** e091a846f (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 missing critical)
**Impact on plan:** Additional tests ensure correct coverage after branch removal. No scope creep.

## Issues Encountered

- Pre-commit hook blocked Task 1 commit because API client wasn't regenerated. Resolved by running `pnpm api:generate` and including generated files in Task 1 commit (the plan had api:generate in Task 2, but the hook requires it with any DTO changes).

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Backend is fully clean of ADR-001 code paths
- API client regenerated with simplified types (frontend code will have type errors referencing removed types)
- Plans 03/04 (frontend wallet login + SIWE flow) can proceed with the clean API types
- Frontend will need updates in useAuth.ts and Login.tsx to match new LoginDto (loginType='corekit' only)

---

_Phase: 12.3-siwe-unified-identity_
_Completed: 2026-02-14_
