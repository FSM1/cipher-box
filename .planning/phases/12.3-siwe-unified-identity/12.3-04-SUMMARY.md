---
phase: 12.3-siwe-unified-identity
plan: 04
subsystem: auth, ui
tags: [siwe, wagmi, wallet, linked-methods, settings, react, nestjs]

# Dependency graph
requires:
  - phase: 12.3-01
    provides: SiweService with verify/hash/truncate, wallet identity endpoints
  - phase: 12.3-02
    provides: Simplified auth types (google/email/wallet), LinkMethodDto with wallet fields
  - phase: 12.3-03
    provides: WalletLoginButton with SIWE flow, wagmi config, vaultKeypair
provides:
  - Full auth method management UI on settings page (view/link/unlink)
  - Backend wallet linking via SIWE verification
  - Cross-account collision detection for all auth method types
  - Truncated wallet address display in methods list
  - Last-method unlink guard (both UI and backend)
affects: [12.4-mfa, settings-ui]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'Link mode for login components (GoogleLoginButton, EmailLoginForm reused in settings)'
    - 'Wallet linking via SIWE in settings (separate from login flow)'
    - 'Cross-account collision detection with TypeORM Not() operator'
    - 'identifierDisplay field for wallet methods in API response'

key-files:
  created: []
  modified:
    - apps/api/src/auth/auth.service.ts
    - apps/api/src/auth/auth.service.spec.ts
    - apps/web/src/components/auth/LinkedMethods.tsx
    - apps/web/src/hooks/useLinkedMethods.ts
    - apps/web/src/routes/Settings.tsx
    - apps/web/src/lib/api/auth.ts
    - apps/web/src/App.css
    - packages/api-client/openapi.json

key-decisions:
  - 'Reuse login components (GoogleLoginButton, EmailLoginForm) in link mode rather than building separate link-specific components'
  - 'Wallet always shows as available to link (multiple wallets allowed per CONTEXT.md)'
  - 'Cross-account collision uses TypeORM Not() operator for userId exclusion'
  - 'Dynamic import of parseSiweMessage in linkWalletMethod for lazy-loading viem/siwe on backend'
  - 'extractErrorMessage helper to surface backend error messages from Axios responses'

patterns-established:
  - 'Link mode: same login components work in both login and settings contexts via callback props'
  - 'Cross-account collision: check for same identifier with different userId before allowing link'

# Metrics
duration: 7min
completed: 2026-02-14
---

# Phase 12.3 Plan 04: Link/Unlink Methods + Settings UI Summary

Full auth method management with SIWE wallet linking, cross-account collision detection, and terminal-themed settings UI.

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-14T07:35:18Z
- **Completed:** 2026-02-14T12:14:12Z
- **Tasks:** 2
- **Files modified:** 8

## Accomplishments

- Backend wallet linking via SIWE verification with cross-account collision detection for all auth types
- Full LinkedMethods UI rewrite: view all linked methods, link new ones (Google/email/wallet), unlink with last-method guard
- Settings page updated with "Account & Security" section heading and description
- Wallet addresses display as truncated checksummed format (0xAbCd...1234) via identifierDisplay field
- 45 backend tests passing including new wallet link, cross-account, and missing SIWE field tests

## Task Commits

Each task was committed atomically:

1. **Task 1: Backend link method support for wallet type** - `6d2f221` (feat)
2. **Task 2: Rebuild LinkedMethods UI with full auth method management** - `3eb483a` (feat)

## Files Created/Modified

- `apps/api/src/auth/auth.service.ts` - Wallet link method with SIWE, cross-account collision, identifierDisplay in getMethods
- `apps/api/src/auth/auth.service.spec.ts` - Tests for wallet linking, cross-account, missing SIWE fields
- `apps/web/src/components/auth/LinkedMethods.tsx` - Full rewrite: view/link/unlink for all auth types
- `apps/web/src/hooks/useLinkedMethods.ts` - Updated with typed LinkPayload for wallet SIWE fields
- `apps/web/src/routes/Settings.tsx` - Account & Security section heading, ARIA landmark
- `apps/web/src/lib/api/auth.ts` - LinkMethodRequest type extended with wallet SIWE fields
- `apps/web/src/App.css` - LinkedMethods component styles (terminal aesthetic, focus-visible)
- `packages/api-client/openapi.json` - Regenerated API client spec

## Decisions Made

- **Reuse login components in link mode:** GoogleLoginButton and EmailLoginForm are used in both login page and settings linking flow via their callback props (`onLogin`). No need for separate components.
- **Multiple wallets allowed:** Wallet always shows in the "available to link" section even if user already has one linked, per CONTEXT.md requirement.
- **Cross-account collision detection:** Uses TypeORM `Not()` operator to find methods with same identifier but different userId. Separate implementations for JWT-based (Google/email) and SIWE-based (wallet) linking.
- **extractErrorMessage helper:** Surfaces backend error messages from Axios response data for user-friendly error display (e.g., "This wallet is already linked to another account").

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- SIWE message format in tests: Initial test used a plain string `'mock-siwe-message'` which `parseSiweMessage()` couldn't parse. Fixed by using a properly formatted EIP-4361 SIWE message with nonce field in the test data.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Phase 12.3 is now complete (all 4 plans executed)
- Backend: SIWE service, wallet identity endpoints, simplified auth types, full method management
- Frontend: wallet login, linked methods UI, settings page
- Ready for Phase 12.4 (MFA + Cross-Device Approval)

---

_Phase: 12.3-siwe-unified-identity_
_Completed: 2026-02-14_
