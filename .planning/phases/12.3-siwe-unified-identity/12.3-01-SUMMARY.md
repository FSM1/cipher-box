---
phase: 12.3-siwe-unified-identity
plan: 01
subsystem: auth
tags: [siwe, viem, wallet, ethereum, eip-4361, sha-256, redis, nonce]

# Dependency graph
requires:
  - phase: 12
    provides: Core Kit identity provider foundation (identity controller, JWT issuer, auth methods)
provides:
  - SiweService with SIWE nonce generation, message verification, wallet address hash/truncate
  - Wallet nonce and verify endpoints on identity controller
  - Simplified auth method types (email, wallet instead of email_passwordless, external_wallet)
  - identifier_hash and identifier_display columns for wallet auth methods
  - ADR-001 cleanup (derivationVersion removed)
affects: [12.3-02 (frontend wallet login), 12.3-03 (auth method linking), 12.4 (MFA)]

# Tech tracking
tech-stack:
  added: [viem (SIWE utilities)]
  patterns:
    [
      wallet address hashing for privacy-preserving lookup,
      truncated display storage,
      SIWE nonce via Redis TTL,
    ]

key-files:
  created:
    - apps/api/src/auth/services/siwe.service.ts
    - apps/api/src/auth/services/siwe.service.spec.ts
    - apps/web/src/api/models/walletVerifyDto.ts
    - apps/web/src/api/models/identityControllerGetWalletNonce200.ts
  modified:
    - apps/api/src/auth/controllers/identity.controller.ts
    - apps/api/src/auth/controllers/identity.controller.spec.ts
    - apps/api/src/auth/entities/user.entity.ts
    - apps/api/src/auth/entities/auth-method.entity.ts
    - apps/api/src/auth/dto/identity.dto.ts
    - apps/api/src/migrations/1700000000000-FullSchema.ts
    - apps/api/src/auth/auth.service.ts
    - apps/api/src/auth/services/web3auth-verifier.service.ts
    - apps/api/src/vault/vault.service.ts
    - apps/api/scripts/generate-openapi.ts
    - packages/api-client/openapi.json
    - apps/web/src/api/identity/identity.ts

key-decisions:
  - 'Wallet addresses stored as SHA-256 hash (lookup) + truncated display (0xAbCd...1234) -- no full plaintext or encryption needed'
  - 'Auth method types simplified: email_passwordless -> email, external_wallet -> wallet'
  - 'derivationVersion column removed from users entity (ADR-001 clean break)'
  - 'SIWE nonces stored in Redis with 5min TTL, single-use via atomic DEL'

patterns-established:
  - 'Wallet address privacy: hash for lookup, truncated display for UI, never store full plaintext'
  - 'SIWE nonce lifecycle: generate -> Redis SET with TTL -> DEL on use (atomic single-use)'
  - 'findOrCreateUserByWallet follows same placeholder publicKey pattern as findOrCreateUserByEmail'

# Metrics
duration: 16min
completed: 2026-02-14
---

# Phase 12.3 Plan 01: Backend SIWE Service and Wallet Endpoints Summary

SiweService with viem-based SIWE verification, wallet nonce/verify endpoints, schema evolution removing ADR-001 artifacts and simplifying auth method types.

## Performance

- **Duration:** 16 min
- **Started:** 2026-02-14T06:50:04Z
- **Completed:** 2026-02-14T07:06:08Z
- **Tasks:** 2
- **Files modified:** 22

## Accomplishments

- Created SiweService with nonce generation (crypto.randomBytes), SIWE message verification (viem/siwe), wallet address SHA-256 hashing, and truncated display formatting
- Added wallet nonce endpoint (GET identity/wallet/nonce) and wallet verify endpoint (POST identity/wallet) with rate limiting and Redis nonce management
- Removed derivationVersion column from users entity and FullSchema migration (ADR-001 cleanup)
- Simplified auth method types from email_passwordless/external_wallet to email/wallet across all services
- Added identifier_hash and identifier_display columns to auth_methods with database index

## Task Commits

Each task was committed atomically:

1. **Task 1: Create SiweService and add viem to API** - `331788c` (feat)
2. **Task 2: Evolve database schema, entity types, and wallet identity endpoints** - `9bfd3d0` (feat)

## Files Created/Modified

- `apps/api/src/auth/services/siwe.service.ts` - Injectable NestJS service: nonce generation, SIWE verification via viem, address hashing, truncation
- `apps/api/src/auth/services/siwe.service.spec.ts` - 9 unit tests for SiweService (nonce, hash, truncate, verify)
- `apps/api/src/auth/controllers/identity.controller.ts` - Added wallet nonce + verify endpoints, findOrCreateUserByWallet
- `apps/api/src/auth/controllers/identity.controller.spec.ts` - 12 tests covering all identity endpoints including wallet flow
- `apps/api/src/auth/entities/user.entity.ts` - Removed derivationVersion column
- `apps/api/src/auth/entities/auth-method.entity.ts` - Renamed types, added identifierHash + identifierDisplay columns
- `apps/api/src/auth/dto/identity.dto.ts` - Added WalletVerifyDto with message + signature validation
- `apps/api/src/migrations/1700000000000-FullSchema.ts` - Removed derivationVersion, added wallet columns + index
- `apps/api/src/auth/auth.service.ts` - Updated type references from email_passwordless to email
- `apps/api/src/auth/services/web3auth-verifier.service.ts` - Updated type references
- `apps/api/src/vault/vault.service.ts` - Updated type references
- `apps/api/scripts/generate-openapi.ts` - Added SiweService mock provider, fixed ConfigService token
- `packages/api-client/openapi.json` - Regenerated with wallet endpoint schemas
- `apps/web/src/api/identity/identity.ts` - Regenerated client with wallet endpoints
- `apps/web/src/api/models/walletVerifyDto.ts` - New generated model for wallet verify input
- `apps/web/src/api/models/identityControllerGetWalletNonce200.ts` - New generated model for nonce response

## Decisions Made

- Wallet addresses stored as SHA-256 hash (lookup) + truncated display (0xAbCd...1234) -- no full plaintext or encryption needed. Simpler than the original plan's hash+encrypted approach since the full address is not needed for display.
- Auth method types simplified to method-based names: 'google', 'apple', 'github', 'email', 'wallet'
- derivationVersion column removed entirely (clean break, DB will be wiped)
- SIWE nonces use Redis SET with 5min TTL and atomic DEL for single-use consumption

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed OpenAPI generator missing SiweService and ConfigService providers**

- **Found during:** Task 2
- **Issue:** The generate-openapi.ts script did not include SiweService as a provider, and ConfigService was provided as a string token ('ConfigService') instead of the class token. This caused the NestJS DI container to fail when resolving IdentityController dependencies during OpenAPI generation.
- **Fix:** Added SiweService import and mock provider. Changed ConfigService provider from string token to imported class token.
- **Files modified:** apps/api/scripts/generate-openapi.ts
- **Verification:** `pnpm api:generate` runs successfully, OpenAPI spec generated
- **Committed in:** 9bfd3d0 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Fix was necessary for the API client generation pre-commit hook. No scope creep.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Backend SIWE infrastructure complete, ready for frontend wallet login flow (Plan 02)
- Wallet nonce and verify endpoints available for the frontend to call
- Generated API client includes wallet endpoint types for type-safe frontend integration
- Auth method type renames will need corresponding frontend updates in Plan 02

---

_Phase: 12.3-siwe-unified-identity_
_Completed: 2026-02-14_
