---
phase: 12.3-siwe-unified-identity
verified: 2026-02-14T12:18:30Z
status: passed
score: 5/5 must-haves verified
human_verification:
  - test: "Wallet login end-to-end with MetaMask"
    expected: "Click [WALLET] on login page, select MetaMask, sign SIWE message, arrive at /files with vault loaded"
    why_human: "Requires a browser wallet extension installed and running dev servers"
  - test: "Link a second wallet from Settings page"
    expected: "Settings > Account & Security > [link wallet] > select MetaMask > sign > new wallet appears in linked methods"
    why_human: "Requires wallet interaction and running dev servers"
  - test: "Wallet login produces same vault as Google login for same userId"
    expected: "User links both Google and wallet, logs in via either method, sees same files"
    why_human: "Requires Core Kit MPC key derivation which cannot be tested structurally"
---

# Phase 12.3: SIWE + Unified Identity Verification Report

**Phase Goal:** Wallet users can log in via SIWE and all auth methods (wallet, Google, email) resolve to the same CipherBox identity and Web3Auth key
**Verified:** 2026-02-14T12:18:30Z
**Status:** passed
**Re-verification:** No -- initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Wallet user can sign SIWE message, CipherBox API verifies, issues JWT, Core Kit login succeeds | VERIFIED | SiweService (82 lines) verifies via viem; identity controller has GET wallet/nonce + POST wallet endpoints with Redis nonce TTL; WalletLoginButton (246 lines) executes full flow: connect -> nonce -> sign -> verify -> Core Kit loginWithJWT; loginWithWallet wired through useAuth -> coreKitLoginWallet -> loginWithCoreKit -> completeBackendAuth |
| 2 | User can link additional auth methods (second wallet, email) from settings | VERIFIED | LinkedMethods.tsx (385 lines) fully rebuilt with view/link/unlink for all 3 types; reuses GoogleLoginButton, EmailLoginForm, and wagmi wallet flow in link mode; useLinkedMethods hook with React Query; auth.service.ts linkMethod() handles google/email via JWT and wallet via SIWE |
| 3 | Any linked auth method produces JWT with same sub=userId, same Web3Auth key | VERIFIED | All identity endpoints (Google, email, wallet) call findOrCreateUser which returns userId; JwtIssuerService.signIdentityJwt(userId) sets sub=userId; Core Kit loginWithJWT uses verifierId=userId with single 'cipherbox-identity' verifier; all login paths go through loginWithCoreKit(cipherboxJwt, userId) |
| 4 | Wallet addresses stored as hashes in database (not plaintext) | VERIFIED | SiweService.hashWalletAddress() uses SHA-256 of checksummed address; identifierHash column (varchar 64) stores hash; identifierDisplay column (varchar 15) stores truncated "0xAbCd...1234"; identifier field for wallets also stores addressHash; full plaintext never persisted |
| 5 | ADR-001 legacy code fully removed (signatureKeyDerivation, derivationVersion, external_wallet) | VERIFIED | Zero grep hits for: derivationVersion in apps/api/src/, external_wallet in apps/api/src/, email_passwordless in apps/api/src/ and apps/web/src/, derivedKeypair in apps/web/src/, isExternalWallet in apps/web/src/, signatureKeyDerivation in apps/web/src/, getMigrationKey in apps/web/src/, importTssKey in apps/web/src/; signatureKeyDerivation.ts confirmed DELETED; LoginType simplified to 'corekit' only |

**Score:** 5/5 truths verified

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `apps/api/src/auth/services/siwe.service.ts` | SIWE nonce, verify, hash, truncate | VERIFIED | 82 lines, substantive, imported by identity.controller + auth.service, registered in auth.module |
| `apps/api/src/auth/services/siwe.service.spec.ts` | Unit tests for SiweService | VERIFIED | 156 lines, 9 test cases (nonce, hash, truncate, verify) |
| `apps/api/src/auth/controllers/identity.controller.ts` | Wallet nonce + verify endpoints | VERIFIED | 365 lines, GET wallet/nonce with rate limit 10/60s, POST wallet with rate limit 5/15min, findOrCreateUserByWallet with hash + truncated display |
| `apps/api/src/auth/controllers/identity.controller.spec.ts` | Identity endpoint tests | VERIFIED | 379 lines, covers wallet nonce + verify + Google + email flows |
| `apps/api/src/auth/entities/user.entity.ts` | No derivationVersion | VERIFIED | 32 lines, no derivationVersion column, only id/publicKey/createdAt/updatedAt/refreshTokens/authMethods |
| `apps/api/src/auth/entities/auth-method.entity.ts` | Simplified types, identifierHash + identifierDisplay | VERIFIED | 45 lines, AuthMethodType = 'google' | 'apple' | 'github' | 'email' | 'wallet'; identifierHash varchar(64) nullable; identifierDisplay varchar(15) nullable |
| `apps/api/src/auth/dto/login.dto.ts` | LoginType = 'corekit' only | VERIFIED | 60 lines, LoginType = 'corekit', no walletAddress/derivationVersion fields, @IsIn(['corekit']) |
| `apps/api/src/auth/dto/identity.dto.ts` | WalletVerifyDto | VERIFIED | 98 lines, WalletVerifyDto with message + signature (0x hex validated) |
| `apps/api/src/auth/dto/link-method.dto.ts` | LinkMethodDto with wallet SIWE fields | VERIFIED | 62 lines, loginType: google/email/wallet, optional walletAddress/siweMessage/siweSignature |
| `apps/api/src/auth/auth.service.ts` | No ADR-001 code paths, wallet linking, cross-account collision | VERIFIED | 539 lines, login() only handles corekit via verifyCipherBoxJwt, linkMethod handles wallet via SIWE + cross-account check, unlinkMethod guards against last method |
| `apps/api/src/auth/services/web3auth-verifier.service.ts` | No external_wallet branch | VERIFIED | 118 lines, single JWKS endpoint, extractAuthMethodType returns new types only |
| `apps/api/src/vault/vault.service.ts` | No derivationVersion references | VERIFIED | 223 lines, getExportData returns derivationMethod: 'web3auth' (simple string), no derivationVersion |
| `apps/api/src/vault/dto/vault-export.dto.ts` | Simplified derivation field | VERIFIED | 53 lines, derivationMethod: string | null (always 'web3auth'), no DerivationInfoDto or derivationVersion |
| `apps/api/src/migrations/1700000000000-FullSchema.ts` | Updated schema | VERIFIED | identifier_hash varchar(64), identifier_display varchar(15), IDX_auth_methods_identifier_hash index, no derivationVersion column |
| `apps/web/src/lib/wagmi/config.ts` | wagmi config with mainnet + injected | VERIFIED | 22 lines, createConfig with mainnet chain and injected() connector |
| `apps/web/src/lib/wagmi/provider.tsx` | WagmiProvider wrapper | VERIFIED | 14 lines, WagmiSetup wrapping children with WagmiProvider |
| `apps/web/src/main.tsx` | WagmiSetup in provider tree | VERIFIED | WagmiSetup wraps CoreKitProvider wraps QueryClientProvider |
| `apps/web/src/components/auth/WalletLoginButton.tsx` | Full SIWE wallet login flow | VERIFIED | 246 lines, uses useConnect/useSignMessage/useDisconnect from wagmi, createSiweMessage from viem/siwe, calls authApi.identityWalletNonce + identityWalletVerify, handles error states, proper ARIA labels |
| `apps/web/src/routes/Login.tsx` | Login page with all 3 methods | VERIFIED | 186 lines, renders GoogleLoginButton + EmailLoginForm + WalletLoginButton, loginWithWallet handler wired |
| `apps/web/src/hooks/useAuth.ts` | loginWithWallet exported | VERIFIED | 402 lines, loginWithWallet calls coreKitLoginWallet then completeBackendAuth('wallet', ...) |
| `apps/web/src/lib/web3auth/hooks.ts` | loginWithWallet, no PnP migration | VERIFIED | 148 lines, loginWithWallet calls loginWithCoreKit, no getMigrationKey or importTssKey |
| `apps/web/src/stores/auth.store.ts` | VaultKeypair, no isExternalWallet | VERIFIED | 78 lines, VaultKeypair type, vaultKeypair state + setVaultKeypair action, no isExternalWallet/clearDerivedKeypair/DerivedKeypair |
| `apps/web/src/lib/api/auth.ts` | Wallet API methods, updated types | VERIFIED | 142 lines, identityWalletNonce (GET), identityWalletVerify (POST), LinkMethodRequest with SIWE fields, loginType: 'corekit' |
| `apps/web/src/components/auth/LinkedMethods.tsx` | Full auth method management UI | VERIFIED | 385 lines, view/link/unlink all types, wallet SIWE linking, cross-account error display, last-method guard |
| `apps/web/src/hooks/useLinkedMethods.ts` | Query/mutation hook | VERIFIED | 51 lines, React Query with LinkPayload typed for wallet SIWE fields |
| `apps/web/src/routes/Settings.tsx` | Account & Security section | VERIFIED | 56 lines, renders LinkedMethods in "account & security" section with ARIA landmark |
| `apps/web/src/lib/crypto/signatureKeyDerivation.ts` | DELETED | VERIFIED | File confirmed not present on disk |

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| WalletLoginButton.tsx | /auth/identity/wallet/nonce | authApi.identityWalletNonce() | WIRED | GET call to backend, response nonce used in SIWE message |
| WalletLoginButton.tsx | /auth/identity/wallet | authApi.identityWalletVerify() | WIRED | POST with message+signature, response idToken+userId passed to onLogin |
| WalletLoginButton.tsx | loginWithCoreKit | via onLogin -> useAuth.loginWithWallet -> coreKitLoginWallet -> loginWithCoreKit | WIRED | Full chain from UI to Core Kit MPC login |
| main.tsx | WagmiProvider | WagmiSetup import | WIRED | WagmiSetup wraps component tree, imported from lib/wagmi/provider |
| Login.tsx | WalletLoginButton | import + JSX render | WIRED | Component imported, rendered with onLogin={handleWalletLogin} and disabled prop |
| Login.tsx | useAuth.loginWithWallet | destructured from hook | WIRED | loginWithWallet destructured and called in handleWalletLogin |
| hooks.ts (Core Kit) | loginWithCoreKit | loginWithWallet function body | WIRED | loginWithWallet calls loginWithCoreKit(cipherboxJwt, userId) |
| identity.controller.ts | SiweService | NestJS DI injection | WIRED | SiweService injected in constructor, registered in auth.module.ts providers |
| identity.controller.ts | Redis | siwe:nonce: key with 5min TTL | WIRED | Redis SET with EX 300, atomic DEL for nonce consumption |
| auth.service.ts | SiweService | NestJS DI injection | WIRED | SiweService injected for wallet linking (SIWE verify, hash, truncate) |
| LinkedMethods.tsx | authApi | getMethods, linkMethod, unlinkMethod | WIRED | useLinkedMethods hook uses React Query with authApi calls |
| LinkedMethods.tsx | wagmi | useConnect, useSignMessage, useDisconnect | WIRED | SIWE signing for wallet linking in handleLinkWallet |
| LinkedMethods.tsx | GoogleLoginButton / EmailLoginForm | Component reuse in link mode | WIRED | Both rendered conditionally when linkingType matches, with link-specific handlers |
| auth.store.ts vaultKeypair | 9 consumer files | import from auth.store | WIRED | useFileDownload, useFileUpload, useFilePreview, useFolder, useFolderNavigation, useDeviceRegistrySync, TextEditorDialog, ImagePreviewDialog + auth.store itself |

### Requirements Coverage

| Requirement | Status | Blocking Issue |
|-------------|--------|----------------|
| SC1: Wallet SIWE -> API verify -> JWT -> Core Kit login | SATISFIED | None |
| SC2: Link additional auth methods from settings | SATISFIED | None |
| SC3: Same sub=userId -> same Web3Auth key | SATISFIED | None |
| SC4: Wallet addresses stored as hashes | SATISFIED | None |
| SC5: ADR-001 legacy fully removed | SATISFIED | None |

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| identity.controller.ts | 303, 347 | `pending-core-kit-placeholder` | Info | Expected placeholder publicKey pattern for Core Kit identity provider flow -- replaced with real publicKey after Core Kit login. Not a stub. |

### Human Verification Required

### 1. End-to-end wallet login with MetaMask

**Test:** Open http://localhost:5173, click [WALLET], select MetaMask, sign the SIWE message, verify arrival at /files with vault loaded
**Expected:** Full login flow completes, user sees file browser with vault initialized
**Why human:** Requires MetaMask browser extension and running dev servers (API + frontend)

### 2. Link a second wallet from Settings

**Test:** After logging in (via any method), navigate to Settings > Account & Security > click [link wallet] > select wallet connector > sign SIWE message > verify new wallet appears in linked methods list
**Expected:** New wallet shows in linked methods with truncated address (0xAbCd...1234), original method still listed
**Why human:** Requires wallet interaction, running dev servers, and existing authenticated session

### 3. Same Web3Auth key across auth methods

**Test:** Create account via Google, link wallet, logout, login via wallet, verify same files are visible
**Expected:** Same vault data accessible regardless of which linked auth method is used for login
**Why human:** Requires Core Kit MPC key derivation which depends on Web3Auth infrastructure

### Gaps Summary

No gaps found. All 5 success criteria are verified through structural analysis of the codebase:

1. **SIWE wallet login:** Complete end-to-end flow from WalletLoginButton through backend SIWE verification to Core Kit MPC key derivation. All components, services, and wiring verified.

2. **Auth method linking:** LinkedMethods component fully rebuilt (385 lines) with Google, email, and wallet linking via ownership verification. Backend supports all three types with cross-account collision detection.

3. **Unified identity:** All auth paths converge through the same CipherBox identity provider pattern -- identity endpoints issue JWT with sub=userId, Core Kit uses single 'cipherbox-identity' verifier with verifierId=userId, guaranteeing same MPC key.

4. **Wallet address privacy:** SHA-256 hashing for lookup + truncated display (0xAbCd...1234) -- full plaintext address never stored in database.

5. **ADR-001 cleanup:** Zero grep hits across entire codebase for all legacy terms (derivationVersion, external_wallet, email_passwordless, derivedKeypair, isExternalWallet, signatureKeyDerivation, getMigrationKey, importTssKey). LoginType reduced to 'corekit' only. signatureKeyDerivation.ts confirmed deleted.

---

_Verified: 2026-02-14T12:18:30Z_
_Verifier: Claude (gsd-verifier)_
