---
phase: 12.3-siwe-unified-identity
plan: 03
subsystem: auth
tags: [wagmi, siwe, viem, wallet, eip-6963, react, zustand, cleanup]

# Dependency graph
requires:
  - phase: 12.3-01
    provides: Backend SIWE service, wallet/nonce and wallet/verify endpoints
  - phase: 12.3-02
    provides: ADR-001 backend cleanup, simplified auth types, regenerated API client
provides:
  - Wallet login button on frontend login page with EIP-6963 wallet discovery
  - Full SIWE flow (connect, nonce, sign, verify, Core Kit login)
  - loginWithWallet in Core Kit hooks and useAuth hook
  - wagmi provider in React component tree
  - vaultKeypair rename across all 10+ consumer files
  - ADR-001 frontend code fully removed (signatureKeyDerivation.ts deleted)
affects:
  - 12.3-04 (link/unlink wallet method in settings)
  - 12.4 (MFA - vault keypair naming is now clean)

# Tech tracking
tech-stack:
  added: [] # wagmi and viem were already installed
  patterns:
    - 'wagmi injected() connector for EIP-6963 browser wallet discovery'
    - 'viem/siwe createSiweMessage for SIWE message creation'
    - 'WagmiSetup wraps outside CoreKitProvider and QueryClientProvider'
    - 'connectAsync + immediate SIWE flow (no useEffect for address changes)'

key-files:
  created:
    - apps/web/src/lib/wagmi/config.ts
    - apps/web/src/lib/wagmi/provider.tsx
    - apps/web/src/components/auth/WalletLoginButton.tsx
  modified:
    - apps/web/src/main.tsx
    - apps/web/src/routes/Login.tsx
    - apps/web/src/hooks/useAuth.ts
    - apps/web/src/lib/web3auth/hooks.ts
    - apps/web/src/lib/api/auth.ts
    - apps/web/src/stores/auth.store.ts
    - apps/web/src/components/auth/index.ts
    - apps/web/src/components/auth/LinkedMethods.tsx
    - apps/web/src/hooks/useFileDownload.ts
    - apps/web/src/hooks/useFileUpload.ts
    - apps/web/src/hooks/useFilePreview.ts
    - apps/web/src/hooks/useFolder.ts
    - apps/web/src/hooks/useFolderNavigation.ts
    - apps/web/src/hooks/useDeviceRegistrySync.ts
    - apps/web/src/components/file-browser/TextEditorDialog.tsx
    - apps/web/src/components/file-browser/ImagePreviewDialog.tsx

key-decisions:
  - 'Use connectAsync for simpler async wallet flow instead of useEffect-based address watching'
  - 'Disconnect wagmi after SIWE verification -- no persistent wallet connection needed'
  - 'Use manual authApi methods for wallet nonce/verify (consistent with Google/email pattern)'
  - 'vaultKeypair chosen over keypair to clearly indicate purpose (vault crypto operations)'

patterns-established:
  - 'WalletLoginButton: connectAsync -> nonce -> createSiweMessage -> signMessageAsync -> verify -> disconnect -> Core Kit'
  - "Auth store uses vaultKeypair for the user's secp256k1 keypair from Core Kit TSS export"

# Metrics
duration: 7min
completed: 2026-02-14
---

# Phase 12.3 Plan 03: Frontend Wallet Login + ADR-001 Cleanup Summary

wagmi wallet login with SIWE on login page, derivedKeypair renamed to vaultKeypair across 10+ consumers, ADR-001 signatureKeyDerivation.ts deleted.

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-14T07:24:21Z
- **Completed:** 2026-02-14T07:31:40Z
- **Tasks:** 2
- **Files modified:** 18 (3 created, 14 modified, 1 deleted)

## Accomplishments

- Wallet login button on the login page discovers EIP-6963 wallets and executes full SIWE flow
- loginWithWallet available in Core Kit hooks and useAuth, following identical pattern to Google/email
- wagmi WagmiSetup provider wraps the React tree outside CoreKitProvider and QueryClientProvider
- PnP migration code (getMigrationKey, importTssKey) completely removed
- ADR-001 signatureKeyDerivation.ts (329 lines) deleted
- derivedKeypair renamed to vaultKeypair across auth store and all 10 consumer files
- isExternalWallet state and clearDerivedKeypair action removed from auth store
- All ADR-001 comments and old auth type references cleaned from frontend

## Task Commits

Each task was committed atomically:

1. **Task 1: wagmi setup, WalletLoginButton, Core Kit wallet hook, and Login page** - `b499f2d47` (feat)
2. **Task 2: ADR-001 cleanup -- rename derivedKeypair to vaultKeypair across all consumers** - `c0e3873ed` (refactor)

## Files Created/Modified

- `apps/web/src/lib/wagmi/config.ts` - wagmi createConfig with mainnet chain and injected() connector
- `apps/web/src/lib/wagmi/provider.tsx` - WagmiSetup React wrapper component
- `apps/web/src/components/auth/WalletLoginButton.tsx` - Wallet connection + SIWE signing + backend verification UI
- `apps/web/src/main.tsx` - WagmiSetup added to provider tree
- `apps/web/src/routes/Login.tsx` - WalletLoginButton added alongside Google and Email options
- `apps/web/src/hooks/useAuth.ts` - loginWithWallet added, setDerivedKeypair -> setVaultKeypair
- `apps/web/src/lib/web3auth/hooks.ts` - loginWithWallet added, getMigrationKey removed
- `apps/web/src/lib/api/auth.ts` - wallet nonce/verify methods added, ADR-001 fields removed
- `apps/web/src/stores/auth.store.ts` - DerivedKeypair -> VaultKeypair, removed isExternalWallet/clearDerivedKeypair
- `apps/web/src/components/auth/index.ts` - WalletLoginButton exported
- `apps/web/src/components/auth/LinkedMethods.tsx` - METHOD_LABELS updated to email/wallet
- `apps/web/src/hooks/useFileDownload.ts` - derivedKeypair -> vaultKeypair
- `apps/web/src/hooks/useFileUpload.ts` - derivedKeypair -> vaultKeypair
- `apps/web/src/hooks/useFilePreview.ts` - derivedKeypair -> vaultKeypair
- `apps/web/src/hooks/useFolder.ts` - derivedKeypair -> vaultKeypair
- `apps/web/src/hooks/useFolderNavigation.ts` - derivedKeypair -> vaultKeypair
- `apps/web/src/hooks/useDeviceRegistrySync.ts` - derivedKeypair -> vaultKeypair
- `apps/web/src/components/file-browser/TextEditorDialog.tsx` - derivedKeypair -> vaultKeypair
- `apps/web/src/components/file-browser/ImagePreviewDialog.tsx` - derivedKeypair -> vaultKeypair
- `apps/web/src/lib/crypto/signatureKeyDerivation.ts` - DELETED (329-line ADR-001 module)

## Decisions Made

- **connectAsync instead of useEffect-based flow**: WalletLoginButton uses `connectAsync()` which resolves with the address, then immediately starts the SIWE flow. This avoids the complexity of watching `useAccount()` for address changes via useEffect.
- **Disconnect wagmi after verification**: CipherBox doesn't need a persistent wallet connection. After SIWE verification produces a CipherBox JWT, wagmi is disconnected. The Core Kit session handles ongoing auth.
- **Manual authApi methods for consistency**: Added `identityWalletNonce()` and `identityWalletVerify()` to the existing `authApi` object rather than using orval-generated React Query hooks, maintaining consistency with the existing Google/email identity endpoints.
- **vaultKeypair naming**: Chosen over alternatives like `keypair` or `userKeypair` to clearly indicate this is the vault's crypto keypair from Core Kit TSS export.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- **ESLint react-hooks/exhaustive-deps rule not configured**: The `eslint-disable-next-line react-hooks/exhaustive-deps` comments in WalletLoginButton caused lint errors because the react-hooks eslint plugin is not configured in this project. Removed the disable comments to fix. The project uses a different lint configuration.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Frontend wallet login is complete and ready for testing
- Plan 04 (Link/Unlink Methods + Settings UI) can proceed -- the wallet login flow, auth store, and API types are all updated
- All ADR-001 artifacts are removed from the frontend codebase
- The auth store's vaultKeypair naming is clean for future MFA work (Phase 12.4)

---

_Phase: 12.3-siwe-unified-identity_
_Completed: 2026-02-14_
