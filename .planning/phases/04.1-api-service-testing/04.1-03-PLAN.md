---
phase: 04.1-api-service-testing
plan: 03
type: execute
wave: 2
depends_on:
  - 04.1-01
  - 04.1-02
files_modified:
  - apps/api/src/auth/auth.controller.spec.ts
  - apps/api/src/vault/vault.controller.spec.ts
  - apps/api/src/ipfs/ipfs.controller.spec.ts
  - apps/api/jest.config.js
autonomous: true

must_haves:
  truths:
    - 'AuthController endpoints call correct service methods'
    - 'AuthController.login sets refresh token cookie'
    - 'AuthController.logout clears refresh token cookie'
    - 'VaultController endpoints pass user.id to service'
    - 'IpfsController.add extracts file.buffer from multipart'
    - 'Jest coverage thresholds enforce per-directory requirements'
    - 'Overall backend coverage meets 85% line, 80% branch minimum'
  artifacts:
    - path: 'apps/api/src/auth/auth.controller.spec.ts'
      provides: 'AuthController unit tests'
      min_lines: 150
    - path: 'apps/api/src/vault/vault.controller.spec.ts'
      provides: 'VaultController unit tests'
      min_lines: 80
    - path: 'apps/api/src/ipfs/ipfs.controller.spec.ts'
      provides: 'IpfsController unit tests'
      min_lines: 60
    - path: 'apps/api/jest.config.js'
      provides: 'Coverage thresholds configuration'
      contains: 'coverageThreshold'
  key_links:
    - from: 'apps/api/jest.config.js'
      to: 'Jest coverage reporting'
      via: 'coverageThreshold configuration'
      pattern: 'coverageThreshold.*global'
---

<objective>
Create controller unit tests and configure Jest coverage thresholds to enforce TESTING.md requirements.

Purpose: Complete test coverage for API layer (controllers) and establish automated coverage enforcement to prevent regression.
Output: Three controller spec files and updated Jest config with per-directory coverage thresholds.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-api-service-testing/04.1-RESEARCH.md
@apps/api/src/ipfs/ipfs.service.spec.ts (existing test pattern)
@apps/api/src/auth/auth.controller.ts
@apps/api/src/vault/vault.controller.ts
@apps/api/src/ipfs/ipfs.controller.ts
@apps/api/jest.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AuthController unit tests</name>
  <files>apps/api/src/auth/auth.controller.spec.ts</files>
  <action>
Create unit tests for AuthController that mock the service layer and verify request/response handling.

**Setup:**

- Use `Test.createTestingModule` with mocked AuthService
- Override JwtAuthGuard to allow all requests: `.overrideGuard(JwtAuthGuard).useValue({ canActivate: () => true })`
- Mock Express Response object for cookie handling
- Create mock request objects with user attached

**Mock Response object:**

```typescript
const mockResponse = {
  cookie: jest.fn(),
  clearCookie: jest.fn(),
} as unknown as Response;
```

**Mock Request with cookies:**

```typescript
const mockRequest = {
  cookies: { refresh_token: 'mock-refresh-token' },
  user: { id: 'user-uuid', publicKey: 'key123' },
};
```

**Test cases for login():**

- Should call authService.login with loginDto
- Should set refresh_token cookie with correct options (httpOnly, secure, path)
- Should return accessToken and isNewUser (not refreshToken)

**Test cases for refresh():**

- Should extract refresh_token from cookies
- Should throw UnauthorizedException if no refresh token cookie
- Should call authService.refreshByToken
- Should set new refresh_token cookie
- Should return only accessToken

**Test cases for logout():**

- Should clear refresh_token cookie with path '/auth'
- Should call authService.logout with user.id
- Should return { success: true }

**Test cases for getMethods():**

- Should call authService.getLinkedMethods with user.id
- Should return array of auth methods

**Test cases for linkMethod():**

- Should call authService.linkMethod with user.id and linkDto
- Should return updated methods array

**Test cases for unlinkMethod():**

- Should call authService.unlinkMethod with user.id and methodId
- Should return { success: true }
  </action>
  <verify>Run `cd /Users/myankelev/Code/random/cipher-box/apps/api && npm test -- --testPathPattern=auth.controller.spec.ts` - all tests pass</verify>
  <done>AuthController has 12+ test cases covering all 6 endpoints</done>
  </task>

<task type="auto">
  <name>Task 2: Create VaultController and IpfsController unit tests</name>
  <files>
apps/api/src/vault/vault.controller.spec.ts
apps/api/src/ipfs/ipfs.controller.spec.ts
  </files>
  <action>
**VaultController tests (apps/api/src/vault/vault.controller.spec.ts):**

Setup:

- Mock VaultService
- Override JwtAuthGuard
- Create mock request with user.id

Test cases for initializeVault():

- Should call vaultService.initializeVault with user.id and dto
- Should return vault response

Test cases for getVault():

- Should call vaultService.findVault with user.id
- Should throw NotFoundException if vault is null
- Should return vault response if found

Test cases for getQuota():

- Should call vaultService.getQuota with user.id
- Should return quota response

**IpfsController tests (apps/api/src/ipfs/ipfs.controller.spec.ts):**

Setup:

- Mock IpfsService
- Override JwtAuthGuard

Test cases for add():

- Should call ipfsService.pinFile with file.buffer
- Should return { cid, size }

Test cases for unpin():

- Should call ipfsService.unpinFile with dto.cid
- Should return { success: true }

**Note:** Controller tests are lighter than service tests - they verify the wiring between HTTP layer and service layer, not business logic.
</action>
<verify>Run `cd /Users/myankelev/Code/random/cipher-box/apps/api && npm test -- --testPathPattern="vault.controller.spec|ipfs.controller.spec"` - all tests pass</verify>
<done>VaultController has 5+ tests, IpfsController has 3+ tests</done>
</task>

<task type="auto">
  <name>Task 3: Configure Jest coverage thresholds</name>
  <files>apps/api/jest.config.js</files>
  <action>
Update Jest configuration to enforce coverage thresholds per TESTING.md requirements.

**Update apps/api/jest.config.js:**

```javascript
/** @type {import('ts-jest').JestConfigWithTsJest} */
module.exports = {
  moduleFileExtensions: ['js', 'json', 'ts'],
  rootDir: 'src',
  testRegex: '.*\\.spec\\.ts$',
  transform: {
    '^.+\\.(t|j)s$': 'ts-jest',
  },
  collectCoverageFrom: [
    '**/*.(t|j)s',
    '!**/*.module.ts', // Exclude NestJS modules (config only)
    '!**/index.ts', // Exclude barrel exports
    '!**/dto/**', // Exclude DTOs (class definitions)
    '!**/entities/**', // Exclude TypeORM entities
    '!main.ts', // Exclude bootstrap
  ],
  coverageDirectory: '../coverage',
  testEnvironment: 'node',
  coverageThreshold: {
    global: {
      lines: 85,
      branches: 80,
      functions: 85,
      statements: 85,
    },
    './auth/auth.service.ts': {
      lines: 90,
      branches: 85,
    },
    './auth/services/*.ts': {
      lines: 90,
      branches: 85,
    },
    './auth/strategies/*.ts': {
      lines: 90,
      branches: 85,
    },
    './vault/vault.service.ts': {
      lines: 90,
      branches: 85,
    },
    './ipfs/ipfs.service.ts': {
      lines: 85,
      branches: 80,
    },
    './**/*.controller.ts': {
      lines: 80,
      branches: 75,
    },
  },
};
```

**Coverage exclusions rationale:**

- `*.module.ts` - NestJS configuration, no logic
- `index.ts` - Barrel exports, no logic
- `dto/**` - Class property declarations with decorators
- `entities/**` - TypeORM entity definitions
- `main.ts` - Application bootstrap

**Threshold rationale (per TESTING.md):**

- Auth/Vault services: 90% line, 85% branch (critical security logic)
- IPFS services: 85% line, 80% branch (external integration)
- Controllers: 80% line, 75% branch (thin layer)
- Global: 85% line, 80% branch (overall minimum)
  </action>
  <verify>Run `cd /Users/myankelev/Code/random/cipher-box/apps/api && npm test -- --coverage` - all tests pass and coverage thresholds met</verify>
  <done>Jest config updated with coverage thresholds, all thresholds pass</done>
  </task>

</tasks>

<verification>
1. All controller tests pass: `cd apps/api && npm test -- --testPathPattern="controller.spec"`
2. Full test suite with coverage: `cd apps/api && npm test -- --coverage`
3. Coverage thresholds enforced - build fails if any threshold not met
4. Coverage report shows:
   - Auth services: >= 90% lines, >= 85% branches
   - Vault service: >= 90% lines, >= 85% branches
   - IPFS service: >= 85% lines, >= 80% branches
   - Controllers: >= 80% lines, >= 75% branches
   - Overall: >= 85% lines, >= 80% branches
</verification>

<success_criteria>

- All 3 controller spec files created and passing
- Jest config updated with coverage thresholds
- Full test suite passes with `npm test -- --coverage`
- All coverage thresholds from TESTING.md are enforced
- CI will fail if coverage drops below thresholds
  </success_criteria>

<output>
After completion, create `.planning/phases/04.1-api-service-testing/04.1-03-SUMMARY.md`
</output>
