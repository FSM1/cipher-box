---
phase: 04.1-api-service-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/vault/vault.service.spec.ts
autonomous: true

must_haves:
  truths:
    - 'VaultService.initializeVault creates vault for new user'
    - 'VaultService.initializeVault throws ConflictException if vault exists'
    - 'VaultService.getVault returns vault or throws NotFoundException'
    - 'VaultService.findVault returns vault or null'
    - 'VaultService.getQuota calculates used/remaining bytes via SUM query'
    - 'VaultService.checkQuota returns true/false based on quota'
    - 'VaultService.recordPin inserts with ON CONFLICT DO NOTHING'
    - 'VaultService.recordUnpin deletes pin record'
    - 'VaultService.markInitialized updates initializedAt timestamp'
  artifacts:
    - path: 'apps/api/src/vault/vault.service.spec.ts'
      provides: 'VaultService unit tests with QueryBuilder mocks'
      min_lines: 200
  key_links:
    - from: 'apps/api/src/vault/vault.service.spec.ts'
      to: 'apps/api/src/vault/vault.service.ts'
      via: 'imports and tests all methods'
      pattern: "describe\\('VaultService'"
---

<objective>
Create comprehensive unit tests for VaultService to achieve 90% line coverage and 85% branch coverage.

Purpose: Test vault initialization, quota management, and pin tracking logic including QueryBuilder mocking for aggregate queries.
Output: Single spec file testing VaultService (8 methods) including complex QueryBuilder chain mocking.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-api-service-testing/04.1-RESEARCH.md
@apps/api/src/ipfs/ipfs.service.spec.ts (existing test pattern)
@apps/api/src/vault/vault.service.ts
@apps/api/src/vault/entities/vault.entity.ts
@apps/api/src/vault/entities/pinned-cid.entity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VaultService unit tests with repository mocks</name>
  <files>apps/api/src/vault/vault.service.spec.ts</files>
  <action>
Create comprehensive unit tests for VaultService following the pattern in ipfs.service.spec.ts.

**Setup:**

- Use `Test.createTestingModule` with mocked providers
- Mock Vault repository and PinnedCid repository using `getRepositoryToken()`
- Import `QUOTA_LIMIT_BYTES` from vault.service.ts for assertions
- Reset all mocks in `afterEach`

**Repository mock structure:**

```typescript
const mockVaultRepo = {
  findOne: jest.fn(),
  create: jest.fn(),
  save: jest.fn(),
  update: jest.fn(),
};

const mockPinnedCidRepo = {
  createQueryBuilder: jest.fn(),
  delete: jest.fn(),
};
```

**QueryBuilder mock pattern for getQuota/recordPin:**

```typescript
const mockQueryBuilder = {
  select: jest.fn().mockReturnThis(),
  where: jest.fn().mockReturnThis(),
  getRawOne: jest.fn().mockResolvedValue({ total: '104857600' }),
  insert: jest.fn().mockReturnThis(),
  into: jest.fn().mockReturnThis(),
  values: jest.fn().mockReturnThis(),
  orIgnore: jest.fn().mockReturnThis(),
  execute: jest.fn().mockResolvedValue({ affected: 1 }),
};
```

**Test cases for initializeVault():**

- Should create vault for new user
- Should decode hex strings to buffers correctly
- Should throw ConflictException if vault already exists

**Test cases for getVault():**

- Should return vault response DTO with hex-encoded fields
- Should throw NotFoundException if vault does not exist

**Test cases for findVault():**

- Should return vault response DTO if found
- Should return null if vault not found

**Test cases for getQuota():**

- Should calculate quota from SUM of pinned CIDs
- Should return full quota when no pins exist (total = '0')
- Should return 0 remaining when at limit
- Should handle null result from getRawOne

**Test cases for checkQuota():**

- Should return true if usage + additional <= limit
- Should return false if usage + additional > limit
- Should return true at exact limit boundary

**Test cases for recordPin():**

- Should insert pin record with upsert (orIgnore)
- Should convert sizeBytes to string for bigint column

**Test cases for recordUnpin():**

- Should delete pin by userId and cid
- Should not throw if pin not found (idempotent)

**Test cases for markInitialized():**

- Should update vault with initializedAt timestamp

**Test toVaultResponse() private method indirectly through getVault/findVault:**

- Verify hex encoding of ownerPublicKey, encryptedRootFolderKey, encryptedRootIpnsPrivateKey
  </action>
  <verify>Run `cd /Users/myankelev/Code/random/cipher-box/apps/api && npm test -- --testPathPattern=vault.service.spec.ts` - all tests pass</verify>
  <done>VaultService has 18+ test cases covering all 8 methods with QueryBuilder mocking</done>
  </task>

<task type="auto">
  <name>Task 2: Add edge case and boundary tests for quota logic</name>
  <files>apps/api/src/vault/vault.service.spec.ts</files>
  <action>
Extend the VaultService tests with additional edge cases for quota management.

**Additional test cases for getQuota():**

- Should handle very large byte values (approaching 500 MiB)
- Should handle getRawOne returning undefined (defensive)
- Should correctly calculate remainingBytes as max(0, limit - used)

**Additional test cases for checkQuota():**

- Should handle 0 additionalBytes (always true if under limit)
- Should handle negative remainingBytes scenario (full storage)

**Additional test cases for initializeVault():**

- Should handle valid hex strings of various lengths
- Should pass correct Buffer values to create()

**Test the QUOTA_LIMIT_BYTES constant:**

```typescript
it('should export QUOTA_LIMIT_BYTES as 500 MiB', () => {
  expect(QUOTA_LIMIT_BYTES).toBe(500 * 1024 * 1024);
});
```

**Verify mock interactions:**

- Assert createQueryBuilder called with 'pin' alias
- Assert where clause uses correct userId parameter
- Assert update/delete called with correct where conditions
  </action>
  <verify>Run `cd /Users/myankelev/Code/random/cipher-box/apps/api && npm test -- --coverage --testPathPattern=vault.service.spec.ts` - coverage shows >= 90% lines, >= 85% branches for vault.service.ts</verify>
  <done>VaultService tests achieve 90%+ line coverage with comprehensive edge cases</done>
  </task>

</tasks>

<verification>
1. All vault service tests pass: `cd apps/api && npm test -- --testPathPattern=vault.service.spec.ts`
2. Coverage check: `cd apps/api && npm test -- --coverage --testPathPattern=vault.service.spec.ts`
   - vault.service.ts: >= 90% lines, >= 85% branches
3. QueryBuilder mock chains work correctly (no "cannot read property" errors)
</verification>

<success_criteria>

- VaultService spec file created and passing
- Coverage meets 90% line, 85% branch thresholds
- QueryBuilder mocking pattern works for both SELECT (getQuota) and INSERT (recordPin)
- Edge cases for quota boundary conditions covered
  </success_criteria>

<output>
After completion, create `.planning/phases/04.1-api-service-testing/04.1-02-SUMMARY.md`
</output>
