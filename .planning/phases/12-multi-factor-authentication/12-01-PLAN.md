---
phase: 12-multi-factor-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/lib/web3auth/config.ts
  - apps/web/src/components/auth/MfaStatus.tsx
  - apps/web/src/components/auth/index.ts
  - apps/web/src/routes/SettingsPage.tsx
  - apps/web/src/App.css
autonomous: true

must_haves:
  truths:
    - "SDK is configured with mfaLevel 'mandatory' for local/staging/production environments"
    - "SDK is configured with mfaLevel 'none' for CI environment to preserve E2E test automation"
    - 'All six MFA factor types are enabled in mfaSettings with device and backup share as mandatory'
    - 'Settings page shows MFA status (active/inactive) with the current auth method'
    - 'User can trigger MFA enrollment from settings via enableMFA hook'
    - 'User can manage existing MFA factors from settings via manageMFA hook'
    - 'Error states are displayed when enableMFA or manageMFA calls fail'
  artifacts:
    - path: 'apps/web/src/lib/web3auth/config.ts'
      provides: 'Web3Auth MFA configuration with mfaLevel and mfaSettings'
      contains: 'mfaLevel'
    - path: 'apps/web/src/components/auth/MfaStatus.tsx'
      provides: 'MFA status display and management component'
      exports: ['MfaStatus']
    - path: 'apps/web/src/routes/SettingsPage.tsx'
      provides: 'Settings page with MFA section integrated'
      contains: 'MfaStatus'
    - path: 'apps/web/src/App.css'
      provides: 'MFA component styles matching terminal aesthetic'
      contains: 'mfa-status'
  key_links:
    - from: 'apps/web/src/lib/web3auth/config.ts'
      to: '@web3auth/modal'
      via: 'mfaSettings and mfaLevel on Web3AuthOptions'
      pattern: 'mfaLevel.*mandatory'
    - from: 'apps/web/src/components/auth/MfaStatus.tsx'
      to: '@web3auth/modal/react'
      via: 'useEnableMFA, useManageMFA, useWeb3AuthUser hooks'
      pattern: 'useEnableMFA|useManageMFA|useWeb3AuthUser'
    - from: 'apps/web/src/routes/SettingsPage.tsx'
      to: 'apps/web/src/components/auth/MfaStatus.tsx'
      via: 'component import and render'
      pattern: 'MfaStatus'
---

<objective>
Configure Web3Auth MFA and add MFA management UI to the settings page.

Purpose: Enable mandatory multi-factor authentication for CipherBox users, strengthening account security with device share + backup recovery phrase as required factors, plus optional additional factors (social backup, password, passkeys, authenticator). The SDK handles all enrollment flows, key splitting, and factor management -- CipherBox configures it and provides a settings UI to view/manage MFA status.

Output: Updated Web3Auth config with MFA settings, new MfaStatus component on the settings page showing current auth method and MFA status with enable/manage buttons.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-multi-factor-authentication/12-RESEARCH.md
@.planning/phases/12-multi-factor-authentication/12-CONTEXT.md
@apps/web/src/lib/web3auth/config.ts
@apps/web/src/lib/web3auth/hooks.ts
@apps/web/src/lib/web3auth/provider.tsx
@apps/web/src/components/auth/LinkedMethods.tsx
@apps/web/src/routes/SettingsPage.tsx
@apps/web/src/App.css
@apps/web/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MFA configuration to Web3Auth options</name>
  <files>apps/web/src/lib/web3auth/config.ts</files>
  <action>
Update `web3AuthOptions` in `config.ts` to include `mfaLevel` and `mfaSettings`:

1. Import `MFA_FACTOR` from `@web3auth/modal` (add to existing import statement).
2. Add a `getMfaLevel()` helper function that returns:
   - `'none'` when `environment === 'ci'` (preserves E2E test automation -- the test account must NEVER touch MFA)
   - `'mandatory'` for all other environments (local, staging, production)
3. Add `mfaLevel: getMfaLevel()` to the `web3AuthOptions` object.
4. Add `mfaSettings` to the `web3AuthOptions` object with all six factor types:
   - `DEVICE`: enable=true, priority=1, mandatory=true
   - `BACKUP_SHARE`: enable=true, priority=2, mandatory=true
   - `SOCIAL_BACKUP`: enable=true, priority=3, mandatory=false
   - `PASSWORD`: enable=true, priority=4, mandatory=false
   - `PASSKEYS`: enable=true, priority=5, mandatory=false
   - `AUTHENTICATOR`: enable=true, priority=6, mandatory=false

Use the `MFA_FACTOR` enum constants (not string literals) for type safety. See RESEARCH.md "Example 1: Environment-Aware MFA Configuration" for the exact pattern.

IMPORTANT: Do NOT change the existing `modalConfig` connector configuration. Only add `mfaLevel` and `mfaSettings` alongside the existing properties.

Type note: If TypeScript reports that `MfaLevelType` is not directly exportable, use the string union type `'default' | 'optional' | 'mandatory' | 'none'` as the return type of `getMfaLevel()`, or import the type if available.
</action>
<verify>
Run `pnpm --filter web typecheck` (or `pnpm --filter web build`) to confirm no TypeScript errors. Verify that `mfaLevel` and `mfaSettings` are present in the config output by visually inspecting the file.
</verify>
<done>
`config.ts` exports `web3AuthOptions` with `mfaLevel` set to 'mandatory' (non-CI) or 'none' (CI), and `mfaSettings` configuring all six factor types with device and backup share as mandatory. No changes to existing modal/connector config.
</done>
</task>

<task type="auto">
  <name>Task 2: Create MFA status component and integrate into Settings page</name>
  <files>
    apps/web/src/components/auth/MfaStatus.tsx
    apps/web/src/components/auth/index.ts
    apps/web/src/routes/SettingsPage.tsx
    apps/web/src/App.css
  </files>
  <action>
**Create `MfaStatus.tsx`:**

Create a new component at `apps/web/src/components/auth/MfaStatus.tsx` that:

1. Imports `useEnableMFA`, `useManageMFA`, `useWeb3AuthUser` from `@web3auth/modal/react`.
2. Displays the user's current auth method (from `userInfo.authConnection` or similar field) so the user sees their full auth picture (CONTEXT.md requirement).
3. Shows MFA status using `isMFAEnabled` from `useWeb3AuthUser()`:
   - If MFA is **active**: Shows `[ACTIVE]` status badge (green), description text "Your vault is protected with multi-factor authentication.", and a "Manage Factors" button that calls `manageMFA()`.
   - If MFA is **inactive**: Shows `[INACTIVE]` status badge (secondary color), description text explaining MFA protects the vault with additional factors, a **prominent warning** in bold: "MFA enrollment is permanent and cannot be undone. Your vault will be permanently inaccessible if you lose both your device and recovery phrase.", and an "Enable MFA" button that calls `enableMFA()`.
4. Shows loading states while `enabling` or `managing` is true (disable button, show "Setting up..." or "Loading..." text).
5. Shows error messages from `enableError` or `manageError` in a `role="alert"` div with a dismiss button.
6. Follow the terminal aesthetic of the existing codebase (monospace font, bracket-style labels like `[ACTIVE]`, green accent color).

**Update barrel export:**

Add `export { MfaStatus } from './MfaStatus';` to `apps/web/src/components/auth/index.ts`.

**Integrate into SettingsPage:**

In `apps/web/src/routes/SettingsPage.tsx`:

1. Import `MfaStatus` from `../components/auth/MfaStatus` (or from the barrel).
2. Add a new `<section className="settings-section">` containing `<MfaStatus />` BEFORE the existing LinkedMethods section. MFA is the most important security feature and should be first.
3. Use the same `style={{ marginTop: 'var(--spacing-md)' }}` pattern on subsequent sections for consistent spacing.

**Add CSS styles:**

Append to `apps/web/src/App.css` in the Settings Page Styles section:

```css
/* MFA Status Component */
.mfa-status h3 { ... }           /* Section heading */
.mfa-auth-method { ... }         /* Current auth method display */
.mfa-status-indicator { ... }    /* Status badge container */
.mfa-badge { ... }               /* Base badge style */
.mfa-badge--active { ... }       /* Green active badge */
.mfa-badge--inactive { ... }     /* Secondary color inactive badge */
.mfa-description { ... }         /* Description text */
.mfa-warning { ... }             /* Bold warning about permanence */
.mfa-actions { ... }             /* Button container */
.mfa-enable-button { ... }       /* Enable MFA button - prominent, green border */
.mfa-manage-button { ... }       /* Manage factors button */
.mfa-error { ... }               /* Error alert */
```

Style guidelines:

- Use CSS custom properties from the existing design system (--color-green-primary, --color-text-primary, --color-text-secondary, --color-border, --font-family-mono, --spacing-_, --font-size-_)
- Use modern color function notation: `rgb(0 208 132 / 20%)` not `rgba(0, 208, 132, 0.2)` (per CLAUDE.md)
- Add `:focus-visible` styles on all buttons (per CLAUDE.md accessibility rules)
- Match the visual style of existing settings sections (LinkedMethods, VaultExport)
  </action>
  <verify>
  Run `pnpm --filter web typecheck` to confirm no TypeScript errors. Run `pnpm --filter web build` to confirm the build succeeds. Visually inspect that the imports are correct and the component tree makes sense.
  </verify>
  <done>
  `MfaStatus.tsx` component exists, exported from barrel, integrated into SettingsPage as the first section. Shows current auth method, MFA status badge ([ACTIVE]/[INACTIVE]), enable/manage buttons with loading/error states, and prominent permanence warning. CSS styles follow terminal aesthetic. Build passes with no errors.
  </done>
  </task>

</tasks>

<verification>
1. `pnpm --filter web build` succeeds with zero errors
2. `pnpm --filter web typecheck` passes
3. `config.ts` contains `mfaLevel` and `mfaSettings` with all six factors
4. `MfaStatus.tsx` imports and uses `useEnableMFA`, `useManageMFA`, `useWeb3AuthUser` hooks
5. `SettingsPage.tsx` renders `MfaStatus` component as first settings section
6. CSS uses modern color notation and includes `:focus-visible` styles
7. No changes to existing E2E tests or test account behavior (CI uses `mfaLevel: 'none'`)
</verification>

<success_criteria>

- Web3Auth SDK is configured with mandatory MFA for non-CI environments
- Settings page displays MFA status section with current auth method
- Enable MFA and Manage Factors buttons trigger the correct SDK hooks
- Error and loading states are properly handled
- Build and type checks pass
- E2E test account is protected from MFA enrollment via environment-aware config
  </success_criteria>

<output>
After completion, create `.planning/phases/12-multi-factor-authentication/12-01-SUMMARY.md`
</output>
