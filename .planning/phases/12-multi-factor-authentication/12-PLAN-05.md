---
phase: 12-core-kit-identity-provider
plan: 05
type: execute
wave: 4
depends_on: ['12-04']
files_modified:
  - apps/web/src/hooks/useAuth.ts
  - apps/web/src/lib/web3auth/hooks.ts
  - apps/web/package.json
  - apps/web/src/lib/web3auth/config.ts
  - apps/web/src/lib/web3auth/provider.tsx
autonomous: false

must_haves:
  truths:
    - 'PnP user logging in for the first time on Core Kit has their existing key imported via importTssKey'
    - "After migration, user's derived publicKey is identical to their PnP-era publicKey"
    - 'Vault data (encrypted files, folder keys) remains accessible after migration'
    - '@web3auth/modal package is removed from dependencies'
    - 'Existing E2E tests are updated or documented for Core Kit auth'
  artifacts:
    - path: 'apps/web/src/lib/web3auth/hooks.ts'
      provides: 'Migration-aware loginWithJWT that detects PnP users and imports their key'
    - path: 'apps/web/package.json'
      provides: 'Clean dependencies with @web3auth/modal removed'
  key_links:
    - from: 'apps/web/src/lib/web3auth/hooks.ts'
      to: '@web3auth/mpc-core-kit'
      via: 'importTssKey parameter in loginWithJWT'
      pattern: 'importTssKey'
---

<objective>
Handle PnP-to-Core Kit key migration via `importTssKey`, remove the PnP SDK, and perform end-to-end verification of the complete auth flow.

Purpose: Success criteria #5 and #6 require that existing PnP users' keys are preserved. PnP and Core Kit generate DIFFERENT private keys for the same user -- migration via `importTssKey` is required. After migration, the user's vault must remain accessible (same publicKey = same ECIES decryption). This plan also cleans up the PnP SDK and dead code.

Output: Migration-aware login flow, clean PnP removal, verified end-to-end auth.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-multi-factor-authentication/12-CONTEXT.md
@.planning/phases/12-multi-factor-authentication/12-RESEARCH-corekit.md
@.planning/phases/12-multi-factor-authentication/12-03-SUMMARY.md
@.planning/phases/12-multi-factor-authentication/12-04-SUMMARY.md

Key research reference: 12-RESEARCH-corekit.md section "Migration Path: PnP Modal SDK to Core Kit"

- importTssKey parameter on loginWithJWT
- PnP and Core Kit generate DIFFERENT keys by default
- For devnet: Option C (fresh start) is recommended
- For production: Option A (importTssKey) is required
  </context>

<tasks>

<task type="auto">
  <name>Task 1: PnP Migration Support + importTssKey</name>
  <files>
    apps/web/src/lib/web3auth/hooks.ts
    apps/web/src/hooks/useAuth.ts
  </files>
  <action>
**Migration strategy (per research):**
- **Devnet/staging (current):** Fresh start (Option C). Existing test accounts re-initialize vaults. No importTssKey needed for dev.
- **Production (future):** importTssKey migration (Option A). The code should support both paths.

**Implement importTssKey support in `hooks.ts`:**

Add an optional `importTssKey` parameter to the `loginWithJWT` calls in `loginWithGoogle()` and `loginWithEmailOtp()`:

```typescript
async function loginWithGoogle(googleIdToken: string, migrationKey?: string): Promise<void> {
  // ... existing flow ...

  const loginParams: any = {
    verifier: 'cipherbox-identity',
    verifierId: userId,
    idToken: cipherboxJwt,
  };

  // If migrating from PnP, import existing key
  if (migrationKey) {
    loginParams.importTssKey = migrationKey;
  }

  await coreKit.loginWithJWT(loginParams);
  // ... rest of flow ...
}
```

Same pattern for `loginWithEmailOtp()`.

**Migration detection flow (for production, implemented now but not active on devnet):**

Add a `migrateFromPnP()` helper function:

```typescript
/**
 * PnP -> Core Kit migration helper.
 * Call this when a user who has an existing PnP-derived vault logs in on Core Kit for the first time.
 *
 * Flow:
 * 1. Before Core Kit migration, the user must have logged in with PnP to export their private key
 * 2. The private key is passed as importTssKey during the first Core Kit loginWithJWT call
 * 3. Core Kit splits this imported key into TSS shares
 * 4. Subsequent logins use Core Kit's native key derivation
 *
 * For devnet: We use fresh accounts (no migration needed)
 * For production: This function would be called with the user's PnP private key
 */
export function getMigrationKey(): string | undefined {
  // Check localStorage for a stored PnP migration key
  // This would be set by a transitional build that exports the PnP key before migration
  const key = localStorage.getItem('__pnp_migration_key__');
  if (key) {
    // Use it once, then delete
    localStorage.removeItem('__pnp_migration_key__');
    return key;
  }
  return undefined;
}
```

In the login functions, automatically check for migration key:

```typescript
const migrationKey = getMigrationKey();
// Pass to loginWithJWT if present
```

**Update `useAuth.ts`:**

After successful Core Kit login, verify the publicKey matches what the backend has for this user:

```typescript
// After login + keypair derivation:
const newPublicKey = await getPublicKeyHex();
// Log for debugging during migration period
console.log('[Auth] Core Kit publicKey:', newPublicKey);
// The backend will update the user's publicKey if it's a placeholder ('pending-core-kit-*')
```

Update the backend auth call to handle the case where the user's publicKey in the database is a placeholder from Plan 01's identity flow. When `authApi.login()` is called with the real Core Kit-derived publicKey, the backend should update it. This is already handled by the existing auth service (it creates/updates users by publicKey).

**IMPORTANT**: For devnet, document that existing test accounts will get new keys and need vault re-initialization. Add a console warning:

```typescript
if (isNewUser) {
  console.log(
    '[Auth] New user on Core Kit. If migrating from PnP, vault re-initialization may be needed.'
  );
}
```

  </action>
  <verify>
    - `pnpm --filter web build` compiles without errors
    - loginWithGoogle and loginWithEmailOtp accept optional migrationKey parameter
    - getMigrationKey() checks localStorage for PnP migration key
    - Console logging shows Core Kit publicKey after login
  </verify>
  <done>importTssKey migration path implemented and wired into login flow. Migration key is read from localStorage if present. For devnet, fresh accounts work without migration.</done>
</task>

<task type="auto">
  <name>Task 2: Remove PnP SDK + Dead Code Cleanup</name>
  <files>
    apps/web/package.json
    apps/web/src/lib/web3auth/config.ts
    apps/web/src/lib/web3auth/provider.tsx
    apps/web/src/main.tsx
  </files>
  <action>
1. **Remove PnP SDK package**:
```bash
pnpm --filter web remove @web3auth/modal
```

2. **Delete or archive PnP files** (they're replaced by core-kit.ts and core-kit-provider.tsx):
   - `apps/web/src/lib/web3auth/config.ts` -- Delete. The Core Kit config is inline in `core-kit.ts`. The old `web3AuthOptions`, `AUTH_CONNECTION_IDS`, `WALLET_CONNECTORS`, `AUTH_CONNECTION` exports are no longer needed.
   - `apps/web/src/lib/web3auth/provider.tsx` -- Delete. Replaced by `core-kit-provider.tsx`.

3. **Verify no remaining imports** of deleted files:
   - Search for `from './config'` or `from '../web3auth/config'` in web app
   - Search for `from './provider'` or `from '../web3auth/provider'` in web app
   - Fix any remaining references

4. **Clean up `main.tsx`** if there are any remaining PnP references:
   - Remove `WagmiProvider` import (already done in Plan 03, but verify)
   - Remove `Web3AuthProviderWrapper` import (already done in Plan 03, but verify)
   - Ensure only `CoreKitProvider` is used

5. **Verify build**:

```bash
pnpm --filter web build
```

The build should succeed with `@web3auth/modal` fully removed.

6. **Lock file update**:

```bash
pnpm install
```

Ensure the lockfile is updated to reflect the removed package.

7. **Verify the `ADR-001 signature derivation` code** in `apps/web/src/lib/crypto/signatureKeyDerivation.ts` -- this code is still needed for Phase 12.3 (SIWE wallet login). Do NOT delete it. Just ensure nothing imports the deleted PnP hooks/config.
   </action>
   <verify> - `pnpm --filter web build` succeeds with @web3auth/modal removed - `grep -r "@web3auth/modal" apps/web/src/` returns no results - `apps/web/src/lib/web3auth/config.ts` is deleted - `apps/web/src/lib/web3auth/provider.tsx` is deleted - `apps/web/src/lib/web3auth/core-kit.ts` exists - `apps/web/src/lib/web3auth/core-kit-provider.tsx` exists - `apps/web/src/lib/web3auth/hooks.ts` exists (rewritten) - `pnpm install` completes and lockfile is clean
   </verify>
   <done>@web3auth/modal removed from dependencies. PnP config and provider files deleted. No remaining PnP imports in codebase. Core Kit is the sole Web3Auth integration.</done>
   </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 12 implementation: CipherBox backend as identity provider, Core Kit SDK integration, custom login UI, PnP migration support, and PnP SDK removal. Full auth flow works end-to-end.</what-built>
  <how-to-verify>
1. Start API: `pnpm --filter api dev`
2. Start web: `pnpm --filter web dev`
3. Navigate to http://localhost:5173

**Test email login flow:** 4. Enter a test email address 5. Click [SEND OTP] 6. Check API console for DEV OTP code 7. Enter OTP code 8. Click [VERIFY] 9. Verify: redirected to /files page, vault loads, files accessible

**Test session persistence:** 10. Refresh the page (F5) 11. Verify: still logged in, vault still accessible

**Test logout:** 12. Click logout 13. Verify: redirected to login page 14. Verify: refreshing page stays on login (session cleared)

**Test Google OAuth (if VITE_GOOGLE_CLIENT_ID configured):** 15. Click Google button 16. Complete Google popup 17. Verify: redirected to /files, vault loads

**Verify vault integrity:** 18. After login, upload a small test file 19. Download the file 20. Verify the downloaded file matches the original (encryption/decryption works) 21. This confirms the Core Kit-derived key is being used correctly for ECIES operations

**Verify no PnP remnants:** 22. Open browser DevTools Network tab 23. Login again -- verify no requests to Web3Auth modal endpoints 24. No modal popup should appear at any point
</how-to-verify>
<resume-signal>Type "approved" or describe issues found during verification</resume-signal>
</task>

</tasks>

<verification>
1. PnP migration path implemented with importTssKey support
2. @web3auth/modal fully removed from dependencies
3. No PnP imports remain in source code
4. Complete login flow works: CipherBox UI -> backend identity -> Core Kit loginWithJWT -> vault access
5. Session persistence works across page refresh
6. Vault encryption/decryption works with Core Kit-derived keys
7. `pnpm --filter web build` succeeds
</verification>

<success_criteria>

- Existing PnP users' keys can be preserved via importTssKey (Success Criterion #5)
- User's derived keypair remains identical after migration -- vault data stays accessible (Success Criterion #6)
- @web3auth/modal completely removed, no PnP code active
- Full end-to-end auth flow verified: login, vault access, session persistence, logout
- No regressions in vault operations (upload/download encrypted files)
  </success_criteria>

<output>
After completion, create `.planning/phases/12-multi-factor-authentication/12-05-SUMMARY.md`
</output>
