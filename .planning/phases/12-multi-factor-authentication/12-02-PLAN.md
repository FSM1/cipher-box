---
phase: 12-multi-factor-authentication
plan: 02
type: execute
wave: 2
depends_on: ['12-01']
files_modified: []
autonomous: false

must_haves:
  truths:
    - 'User can enable MFA from the settings page and is guided through factor enrollment'
    - 'User can configure a device share as an additional MFA factor for login'
    - 'User can generate a backup recovery phrase and use it to regain vault access'
    - "User's derived keypair (publicKey) remains identical after MFA enrollment"
  artifacts: []
  key_links:
    - from: 'Settings page MFA section'
      to: 'Web3Auth SDK MFA enrollment flow'
      via: 'enableMFA() hook triggers SDK UI'
      pattern: 'enableMFA'
    - from: 'Web3Auth SDK MFA enrollment'
      to: 'Shamir Secret Sharing key split'
      via: 'SDK splits existing private key into 2-of-3 shares'
      pattern: 'isMFAEnabled.*true'
---

<objective>
Verify the complete MFA flow works end-to-end: enrollment, factor management, key identity preservation, and login with MFA active.

Purpose: Confirm all four success criteria for Phase 12 are met. The SDK handles the heavy lifting, but we need to verify the integration works correctly in a real browser with a real Web3Auth account. This is especially important because several behaviors (what enableMFA() UI looks like, whether manageMFA() supports backup phrase regeneration, login UX with MFA active) were documented as open questions in RESEARCH.md.

Output: Verified MFA flow with observations about SDK behavior documented in the summary.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-multi-factor-authentication/12-RESEARCH.md
@.planning/phases/12-multi-factor-authentication/12-CONTEXT.md
@.planning/phases/12-multi-factor-authentication/12-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start development servers and take baseline screenshots</name>
  <files></files>
  <action>
1. Start the API server: `pnpm --filter api dev` (if not already running on localhost:3000)
2. Start the web dev server: `pnpm --filter web dev` (if not already running on localhost:5173)
3. Use Playwright MCP (if available) to navigate to `http://localhost:5173/settings` and take a screenshot of the settings page showing the new MFA status section. If Playwright MCP is not available, note this for manual verification.
4. Verify visually that:
   - The MFA status section appears as the first section on the settings page
   - The current auth method is displayed
   - The MFA badge shows [INACTIVE] (for a fresh account)
   - The "Enable MFA" button is visible
   - The permanence warning is displayed prominently
   - The LinkedMethods and VaultExport sections still render below
  </action>
  <verify>Screenshot shows the settings page with MFA section properly rendered and styled.</verify>
  <done>Settings page renders correctly with MFA status section visible and properly styled.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete MFA integration: Web3Auth SDK configured with mandatory MFA (device share + backup phrase required), MFA status component on settings page with enable/manage buttons, environment-aware CI bypass.

This checkpoint verifies the FULL end-to-end MFA flow that only a human can test (requires real Web3Auth authentication with browser interaction).
</what-built>
<how-to-verify>
Prerequisites: Use a FRESH Web3Auth test account (NOT the E2E account `test_account_4718@example.com` -- MFA is irreversible and would break E2E tests permanently).

### Test 1 -- MFA Enrollment (MFA-01, MFA-02, MFA-03)

1. Open `http://localhost:5173` in browser
2. Log in with a fresh/test account (Google or email)
3. Observe: Does the SDK automatically show the MFA enrollment screen after initial auth? (Expected: yes, because `mfaLevel: 'mandatory'`)
4. Complete the MFA enrollment:
   - Device share should be created automatically
   - Backup recovery phrase should be shown -- save it somewhere safe
5. After enrollment, verify you land on the file browser normally

### Test 2 -- Settings Page MFA Status (MFA-01)

1. Navigate to `/settings`
2. Verify: MFA badge shows `[ACTIVE]`
3. Verify: Current auth method is displayed (e.g., "Google" or "Email")
4. Click "Manage Factors" button
5. Observe: What UI does the SDK show? (Document this)

### Test 3 -- Key Identity Preservation (MFA-04)

1. Before MFA enrollment, the vault should have been accessible
2. After MFA enrollment, navigate to `/files`
3. Verify: Existing vault files are still accessible (can browse folders, download files)
4. This confirms the publicKey/privateKey remained identical after MFA enrollment

### Test 4 -- Login with MFA Active

1. Log out
2. Log back in with the same account
3. Observe: Does the SDK prompt for a second factor? What does it look like?
4. Verify: Login succeeds and vault is accessible

### Test 5 -- Recovery Flow (MFA-03)

1. (Optional, if comfortable) Open an incognito window (no device share)
2. Try to log in with the same account
3. You should be prompted for the recovery phrase (or another second factor)
4. Enter the recovery phrase saved in Test 1
5. Verify: Login succeeds and vault is accessible

### Report observations

- What does the `enableMFA()` UI look like? (popup, redirect, inline?)
- What does `manageMFA()` show? Can you regenerate the backup phrase?
- What does the second-factor prompt look like during login?
- Any issues or unexpected behavior?

Type "approved" to proceed, or describe any issues found.
</how-to-verify>
<resume-signal>Type "approved" with observations, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Phase 12 success criteria (from ROADMAP.md):

1. User can enable MFA from the settings page and is guided through factor enrollment -- verified in Test 1
2. User can configure a device share as an additional MFA factor for login -- verified in Test 1 (automatic)
3. User can generate a backup recovery phrase and use it to regain vault access -- verified in Tests 1 and 5
4. User's derived keypair (publicKey) remains identical after MFA enrollment -- verified in Test 3

Requirements coverage:

- MFA-01: User can enable MFA via Web3Auth settings -- Tests 1-2
- MFA-02: User can configure device share as MFA factor -- Test 1
- MFA-03: User can generate and store backup recovery phrase -- Tests 1, 5
- MFA-04: MFA enrollment does not change derived keypair -- Test 3
  </verification>

<success_criteria>

- All five manual tests pass
- MFA enrollment flow works end-to-end via SDK
- Vault remains accessible after MFA enrollment (key identity preserved)
- Settings page correctly reflects MFA status
- Login with MFA active works
- Recovery phrase (if tested) restores access
  </success_criteria>

<output>
After completion, create `.planning/phases/12-multi-factor-authentication/12-02-SUMMARY.md`
</output>
