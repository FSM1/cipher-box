---
phase: 08-tee-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/tee/tee-key-state.entity.ts
  - apps/api/src/tee/tee-key-rotation-log.entity.ts
  - apps/api/src/tee/tee-key-state.service.ts
  - apps/api/src/tee/tee.service.ts
  - apps/api/src/tee/tee.module.ts
  - apps/api/src/tee/dto/tee-keys.dto.ts
  - apps/api/src/app.module.ts
  - apps/api/.env.example
  - apps/api/.env
autonomous: true

must_haves:
  truths:
    - 'Backend stores TEE key epoch state (current + previous) in database'
    - 'Backend can query TEE worker for its current epoch public key'
    - 'Backend returns TEE public keys to clients via vault API'
    - 'Key epoch rotation creates new epoch while preserving previous for grace period'
  artifacts:
    - path: 'apps/api/src/tee/tee-key-state.entity.ts'
      provides: 'TypeORM entity for tee_key_state table'
      contains: 'class TeeKeyState'
    - path: 'apps/api/src/tee/tee-key-rotation-log.entity.ts'
      provides: 'TypeORM entity for tee_key_rotation_log table'
      contains: 'class TeeKeyRotationLog'
    - path: 'apps/api/src/tee/tee-key-state.service.ts'
      provides: 'Epoch management service'
      exports: ['TeeKeyStateService']
    - path: 'apps/api/src/tee/tee.service.ts'
      provides: 'HTTP client for TEE worker'
      exports: ['TeeService']
    - path: 'apps/api/src/tee/tee.module.ts'
      provides: 'NestJS module wiring'
      exports: ['TeeModule']
  key_links:
    - from: 'apps/api/src/tee/tee-key-state.service.ts'
      to: 'apps/api/src/tee/tee-key-state.entity.ts'
      via: 'TypeORM repository injection'
      pattern: "@InjectRepository\\(TeeKeyState\\)"
    - from: 'apps/api/src/tee/tee.service.ts'
      to: 'TEE_WORKER_URL'
      via: 'HTTP fetch to TEE worker'
      pattern: 'fetch.*teeWorkerUrl'
    - from: 'apps/api/src/app.module.ts'
      to: 'apps/api/src/tee/tee.module.ts'
      via: 'Module import'
      pattern: 'TeeModule'
---

<objective>
Create the TEE key state database tables, epoch management service, and TEE worker HTTP client in the NestJS backend.

Purpose: This is the foundation for all TEE-related operations. The key state tables track which TEE epoch is current/previous, the TEE service provides the HTTP interface to the Phala Cloud CVM, and the epoch management service handles rotation logic.

Output: TeeModule with entities, services, DTOs, and app module integration. No scheduling yet (that is Plan 02).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-tee-integration/08-CONTEXT.md
@.planning/phases/08-tee-integration/08-RESEARCH.md
@apps/api/src/app.module.ts
@apps/api/src/ipns/entities/folder-ipns.entity.ts
@apps/api/src/ipns/ipns.service.ts
@apps/api/src/vault/vault.service.ts
@apps/api/src/vault/dto/init-vault.dto.ts
@apps/api/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: TEE key state entities and epoch management service</name>
  <files>
    apps/api/src/tee/tee-key-state.entity.ts
    apps/api/src/tee/tee-key-rotation-log.entity.ts
    apps/api/src/tee/tee-key-state.service.ts
    apps/api/src/tee/dto/tee-keys.dto.ts
  </files>
  <action>
Create the TEE module directory structure: `apps/api/src/tee/`

**tee-key-state.entity.ts** - TypeORM entity for `tee_key_state` table (singleton row pattern):

- `id` UUID primary key (PrimaryGeneratedColumn)
- `currentEpoch` int, not null (column: `current_epoch`)
- `currentPublicKey` bytea, not null (column: `current_public_key`) -- uncompressed secp256k1, 65 bytes
- `previousEpoch` int, nullable (column: `previous_epoch`)
- `previousPublicKey` bytea, nullable (column: `previous_public_key`)
- `gracePeriodEndsAt` timestamp, nullable (column: `grace_period_ends_at`) -- when previous epoch expires
- `createdAt` CreateDateColumn
- `updatedAt` UpdateDateColumn

**tee-key-rotation-log.entity.ts** - TypeORM entity for `tee_key_rotation_log` table:

- `id` UUID primary key
- `fromEpoch` int (column: `from_epoch`)
- `toEpoch` int (column: `to_epoch`)
- `fromPublicKey` bytea (column: `from_public_key`)
- `toPublicKey` bytea (column: `to_public_key`)
- `reason` varchar(255) -- e.g., 'scheduled', 'cvm_update', 'manual'
- `createdAt` CreateDateColumn

**tee-keys.dto.ts** - Response DTO for client:

- `TeeKeysDto` class with Swagger decorators:
  - `currentEpoch: number`
  - `currentPublicKey: string` (hex-encoded)
  - `previousEpoch: number | null`
  - `previousPublicKey: string | null` (hex-encoded or null)

**tee-key-state.service.ts** - Epoch management service:

- `@Injectable()` class `TeeKeyStateService`
- Constructor injects `Repository<TeeKeyState>` and `Repository<TeeKeyRotationLog>`
- Methods:
  - `getCurrentState(): Promise<TeeKeyState | null>` -- returns the singleton row
  - `getTeeKeysDto(): Promise<TeeKeysDto | null>` -- returns formatted DTO for clients (hex-encodes public keys)
  - `initializeEpoch(epoch: number, publicKey: Uint8Array): Promise<TeeKeyState>` -- creates initial state (used on first boot)
  - `rotateEpoch(newEpoch: number, newPublicKey: Uint8Array, reason: string): Promise<TeeKeyState>` -- shifts current to previous, sets new current, sets grace period to now + 4 weeks, logs rotation
  - `isGracePeriodActive(): Promise<boolean>` -- checks if previous epoch is still valid
  - `deprecatePreviousEpoch(): Promise<void>` -- clears previous epoch (called after grace period ends)

Follow existing codebase patterns: use snake_case column names, camelCase property names, Buffer for bytea columns. Use TypeORM transactions for rotateEpoch to ensure atomicity.
</action>
<verify>
Run `cd /Users/michael/Code/cipher-box && npx tsc --noEmit -p apps/api/tsconfig.build.json` to verify TypeScript compiles. Verify the entity files follow the same patterns as `apps/api/src/ipns/entities/folder-ipns.entity.ts`.
</verify>
<done>
TeeKeyState and TeeKeyRotationLog entities exist with correct columns. TeeKeyStateService exists with epoch CRUD and rotation methods. TeeKeysDto exists for API responses.
</done>
</task>

<task type="auto">
  <name>Task 2: TEE worker HTTP client service and module integration</name>
  <files>
    apps/api/src/tee/tee.service.ts
    apps/api/src/tee/tee.module.ts
    apps/api/src/app.module.ts
    apps/api/.env.example
    apps/api/.env
  </files>
  <action>
**tee.service.ts** - HTTP client for TEE worker CVM:
- `@Injectable()` class `TeeService`
- Constructor injects `ConfigService` and `TeeKeyStateService`
- Reads `TEE_WORKER_URL` from config (default: `http://localhost:3001` for local dev with simulator)
- Reads `TEE_WORKER_SECRET` from config (shared secret for authentication)
- Private `logger = new Logger(TeeService.name)`
- Methods:
  - `async getHealth(): Promise<{ healthy: boolean; epoch: number }>` -- GET `{TEE_WORKER_URL}/health`, returns parsed JSON. Used for connectivity checks.
  - `async getPublicKey(epoch: number): Promise<Uint8Array>` -- GET `{TEE_WORKER_URL}/public-key?epoch={epoch}`, returns 65-byte uncompressed secp256k1 key. The TEE worker derives and returns its deterministic key for the given epoch.
  - `async republish(entries: RepublishEntry[]): Promise<RepublishResult[]>` -- POST `{TEE_WORKER_URL}/republish` with JSON body `{ entries }`. Each entry: `{ encryptedIpnsKey: string (base64), keyEpoch: number, ipnsName: string, latestCid: string, sequenceNumber: string }`. Returns array of results: `{ ipnsName: string, success: boolean, signedRecord?: string (base64), newSequenceNumber?: string, upgradedEncryptedKey?: string (base64), upgradedKeyEpoch?: number, error?: string }`.
  - `async initializeFromTee(): Promise<void>` -- Called on module init. Queries TEE for current epoch public key and initializes tee_key_state if empty. If tee_key_state already has data, validates it still matches TEE.
- All HTTP calls include `Authorization: Bearer {TEE_WORKER_SECRET}` header
- All HTTP calls have 30-second timeout
- IMPORTANT: Never log key material. Log ipnsName, epoch numbers, success/failure only.

Define types for `RepublishEntry` and `RepublishResult` either at top of file or in a separate types file.

**tee.module.ts** - NestJS module:

- Imports: `TypeOrmModule.forFeature([TeeKeyState, TeeKeyRotationLog])`, `ConfigModule`
- Providers: `TeeService`, `TeeKeyStateService`
- Exports: `TeeService`, `TeeKeyStateService`
- Implements `OnModuleInit` -- calls `teeService.initializeFromTee()` wrapped in try/catch (log warning if TEE unavailable, don't crash startup)

**app.module.ts** updates:

- Import `TeeModule`
- Add `TeeKeyState` and `TeeKeyRotationLog` to the entities array in TypeOrmModule.forRootAsync
- Add `TeeModule` to imports array

**.env.example** updates -- add these lines:

```ini
# TEE Worker (Phala Cloud CVM)
# TEE_WORKER_URL=http://localhost:3001
# TEE_WORKER_SECRET=
```

**.env** updates -- add same TEE vars (without values, just the commented template).

AVOID: Do NOT attempt to actually connect to a TEE worker -- the TEE worker does not exist yet (Plan 04). The initializeFromTee method should gracefully handle connection failures.
</action>
<verify>
Run `cd /Users/michael/Code/cipher-box && npx tsc --noEmit -p apps/api/tsconfig.build.json` to verify compilation. Run `pnpm --filter api dev` briefly and check that the API starts without crashing (TEE init should log a warning about unavailable TEE worker, not crash).
</verify>
<done>
TeeModule registered in AppModule. TeeService provides HTTP client methods for TEE worker. App starts cleanly with TEE worker unavailable (graceful degradation). .env.example documents TEE_WORKER_URL and TEE_WORKER_SECRET.
</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p apps/api/tsconfig.build.json` passes
2. API starts without error: `pnpm --filter api dev` logs "TEE worker unavailable" warning but does not crash
3. All entity files follow existing patterns (snake_case columns, camelCase properties, Buffer for bytea)
4. No key material logged anywhere in the TEE module code
</verification>

<success_criteria>

- TeeKeyState entity creates `tee_key_state` table with current/previous epoch fields
- TeeKeyRotationLog entity creates `tee_key_rotation_log` audit table
- TeeKeyStateService provides epoch CRUD, rotation with grace period, and DTO formatting
- TeeService provides HTTP client for TEE worker with all 4 endpoints (health, public-key, republish, init)
- TeeModule exported and integrated into AppModule
- API starts cleanly in development mode
  </success_criteria>

<output>
After completion, create `.planning/phases/08-tee-integration/08-01-SUMMARY.md`
</output>
