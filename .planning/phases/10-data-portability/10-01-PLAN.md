---
phase: 10-data-portability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/vault/vault.controller.ts
  - apps/api/src/vault/dto/vault-export.dto.ts
  - apps/api/src/vault/vault.service.ts
  - apps/web/src/api/vault/vault.ts
  - apps/web/src/api/models/vaultExportDto.ts
  - apps/web/src/components/vault/VaultExport.tsx
  - apps/web/src/routes/SettingsPage.tsx
autonomous: true

must_haves:
  truths:
    - 'User can click Export Vault on the Settings page'
    - 'Confirmation dialog warns about secure storage before export'
    - 'Export downloads a JSON file named cipherbox-vault-export.json'
    - 'Export JSON contains format, version, exportedAt, rootIpnsName, encryptedRootFolderKey, encryptedRootIpnsPrivateKey'
  artifacts:
    - path: 'apps/api/src/vault/dto/vault-export.dto.ts'
      provides: 'Export response DTO with Swagger decorators'
      contains: 'VaultExportDto'
    - path: 'apps/api/src/vault/vault.controller.ts'
      provides: 'GET /vault/export endpoint'
      contains: 'exportVault'
    - path: 'apps/web/src/components/vault/VaultExport.tsx'
      provides: 'Export button with confirmation dialog'
      contains: 'VaultExport'
    - path: 'apps/web/src/routes/SettingsPage.tsx'
      provides: 'Settings page with VaultExport section'
      contains: 'VaultExport'
  key_links:
    - from: 'apps/web/src/components/vault/VaultExport.tsx'
      to: '/vault/export'
      via: 'generated API client function'
      pattern: 'vaultControllerExportVault'
    - from: 'apps/api/src/vault/vault.controller.ts'
      to: 'apps/api/src/vault/vault.service.ts'
      via: 'getExportData method'
      pattern: 'getExportData'
---

<objective>
Add vault export endpoint to the API and export button to the web app Settings page.

Purpose: Enables PORT-01 (user can export vault as JSON file) and PORT-02 (export includes encrypted keys and folder structure root). The API endpoint returns the minimal export data (rootIpnsName + encrypted root keys), and the web UI provides a download button with a security confirmation dialog.

Output: Working `GET /vault/export` API endpoint, regenerated API client, and VaultExport component on the Settings page that downloads the export JSON.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-data-portability/10-CONTEXT.md
@.planning/phases/10-data-portability/10-RESEARCH.md

@apps/api/src/vault/vault.controller.ts
@apps/api/src/vault/vault.service.ts
@apps/api/src/vault/dto/init-vault.dto.ts
@apps/api/src/vault/entities/vault.entity.ts
@apps/api/src/auth/entities/user.entity.ts
@apps/web/src/routes/SettingsPage.tsx
@apps/web/src/api/vault/vault.ts
@apps/web/src/api/custom-instance.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: API export endpoint and DTO</name>
  <files>
  apps/api/src/vault/dto/vault-export.dto.ts
  apps/api/src/vault/vault.controller.ts
  apps/api/src/vault/vault.service.ts
  </files>
  <action>
Create `apps/api/src/vault/dto/vault-export.dto.ts` with a `VaultExportDto` class containing: `format: string` (always `"cipherbox-vault-export"`), `version: string` (always `"1.0"`), `exportedAt: string` (ISO 8601 timestamp), `rootIpnsName: string`, `encryptedRootFolderKey: string` (hex-encoded), `encryptedRootIpnsPrivateKey: string` (hex-encoded), and an optional `derivationInfo` object with `{ method: "web3auth" | "external-wallet", derivationVersion: number | null }`. This hints how the user's private key was derived, helping recovery. To populate this, the service will need to join to the User entity to read `derivationVersion`. Add `@ApiProperty()` decorators on all fields with descriptions and examples.

Add a `getExportData(userId: string)` method to `VaultService`: Query the vault by `ownerId` (reuse existing pattern from `findVault`). Also query the User entity to get `derivationVersion` -- add `@InjectRepository(User)` to the constructor, importing from `'../../auth/entities/user.entity'`. Add User to the VaultModule imports if needed (check `vault.module.ts`). Throw `NotFoundException` if vault not found. Return a `VaultExportDto` with hex-encoded fields and derivationInfo populated.

Add `GET /vault/export` endpoint to `VaultController`: Use `@Get('export')` decorator. Apply existing `@UseGuards(JwtAuthGuard)` and `@ApiBearerAuth()` (already on the class). Add `@ApiOperation({ summary: 'Export vault for independent recovery' })`. Add `@ApiResponse({ status: 200, type: VaultExportDto })` and `@ApiResponse({ status: 404 })`. Call `this.vaultService.getExportData(req.user.id)` and return the result. Import the new DTO.

IMPORTANT: Place the `@Get('export')` route BEFORE the existing `@Get()` route in the controller to avoid route matching issues (NestJS matches routes top-to-bottom, and `@Get()` would catch `/export` if listed first).
</action>
<verify>
Run `cd /Users/michael/Code/cipher-box && pnpm --filter api build` to confirm TypeScript compilation succeeds.
Run `pnpm api:generate` to regenerate the API client with the new endpoint.
Verify the generated client contains a `vaultControllerExportVault` function in `apps/web/src/api/vault/vault.ts`.
</verify>
<done>
`GET /vault/export` endpoint exists, returns VaultExportDto with format/version/exportedAt/rootIpnsName/encryptedRootFolderKey/encryptedRootIpnsPrivateKey/derivationInfo fields. API client regenerated with typed function.
</done>
</task>

<task type="auto">
  <name>Task 2: Web app VaultExport component on Settings page</name>
  <files>
  apps/web/src/components/vault/VaultExport.tsx
  apps/web/src/routes/SettingsPage.tsx
  </files>
  <action>
Create `apps/web/src/components/vault/VaultExport.tsx`. Import the generated `vaultControllerExportVault` from `'../../api/vault/vault'`. Component renders a section with heading `[VAULT EXPORT]` (terminal aesthetic, matching existing `[SETTINGS]` style). Below heading: brief description text: "Download your vault data for independent recovery. The export contains encrypted keys that can reconstruct your entire file tree." An `--export vault` button (terminal aesthetic, matching existing button styles in the app). On click: set `showDialog` state to true.

Confirmation dialog (use the existing `ConfirmDialog` component if one exists, otherwise build inline): Title: "export vault". Warning message: "This export contains encrypted keys for your entire vault. Anyone with this file AND your private key can access all your files. Store it securely -- external drive, password manager, or printed paper backup." Two buttons: `[CANCEL]` and `[CONFIRM EXPORT]`. On confirm: call the generated API client function, then trigger browser download.

Download logic: `JSON.stringify(response, null, 2)` -> `Blob` with type `application/json` -> create object URL -> programmatic `<a>` click with `download="cipherbox-vault-export.json"` -> `URL.revokeObjectURL()`. Show a brief loading spinner or `[EXPORTING...]` text while the API call is in flight. Error handling: catch API errors and show a brief error message inline (e.g., "Export failed. Please try again.").

Integrate into `apps/web/src/routes/SettingsPage.tsx`: Import `VaultExport` from `'../components/vault/VaultExport'`. Add a new `<section className="settings-section">` below the existing `<LinkedMethods />` section. Render `<VaultExport />` inside it.

Style notes: Match the terminal/hacker aesthetic of the existing app (dark backgrounds, monospace text, bracket-wrapped labels). Check existing components like `LinkedMethods` or the confirmation dialogs used for file deletion (`apps/web/src/components/dialogs/`) for style patterns. Reuse the same dialog component if one exists; check `apps/web/src/components/dialogs/ConfirmDialog.tsx` or similar. The warning text should use a slightly different color (amber/yellow) to draw attention.
</action>
<verify>
Run `cd /Users/michael/Code/cipher-box && pnpm --filter web build` to confirm frontend compiles.
Verify the SettingsPage.tsx imports and renders VaultExport.
Check that no TypeScript errors exist.
</verify>
<done>
Settings page shows a "Vault Export" section below linked methods. Clicking the export button shows a confirmation dialog with security warning. Confirming triggers the API call and downloads `cipherbox-vault-export.json`. Cancel dismisses the dialog. Loading state shown during export.
</done>
</task>

</tasks>

<verification>

1. `pnpm --filter api build` succeeds
2. `pnpm --filter web build` succeeds
3. Generated API client in `apps/web/src/api/vault/vault.ts` contains `vaultControllerExportVault` function
4. VaultExport component is rendered on SettingsPage
5. Export DTO includes all required fields per CONTEXT.md

</verification>

<success_criteria>

- GET /vault/export returns JSON with format "cipherbox-vault-export", version "1.0", and all vault fields hex-encoded
- Settings page has export button that triggers confirmation dialog then browser download
- API client is regenerated and typed for the new endpoint
- No TypeScript compilation errors in api or web packages

</success_criteria>

<output>
After completion, create `.planning/phases/10-data-portability/10-01-SUMMARY.md`
</output>
