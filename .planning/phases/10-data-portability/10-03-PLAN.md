---
phase: 10-data-portability
plan: 03
type: execute
wave: 2
depends_on: ['10-01', '10-02']
files_modified:
  - docs/VAULT_EXPORT_FORMAT.md
  - scripts/generate-test-vectors.ts
autonomous: true

must_haves:
  truths:
    - 'A developer can reimplement vault recovery in any language using only the documentation'
    - 'Every field in the export JSON is documented with type, encoding, and purpose'
    - 'Crypto algorithms are specified with exact parameters (key sizes, IV sizes, nonce sizes, HKDF params)'
    - 'ECIES binary format is fully documented (byte offsets, field sizes)'
    - 'IPNS resolution steps are documented for infrastructure-independent recovery'
    - 'Test vectors are provided with sample data and expected outputs'
  artifacts:
    - path: 'docs/VAULT_EXPORT_FORMAT.md'
      provides: 'Complete technical specification of vault export format and recovery procedure'
      min_lines: 200
      contains: 'cipherbox-vault-export'
    - path: 'scripts/generate-test-vectors.ts'
      provides: 'Test vector generation script using @cipherbox/crypto'
      contains: 'wrapKey'
  key_links:
    - from: 'docs/VAULT_EXPORT_FORMAT.md'
      to: 'apps/web/public/recovery.html'
      via: 'documents the same algorithms implemented in recovery tool'
      pattern: 'ECIES|AES-256-GCM|HKDF'
    - from: 'docs/VAULT_EXPORT_FORMAT.md test vectors'
      to: 'packages/crypto/src'
      via: 'test vectors generated using the crypto module'
      pattern: 'test vector'
---

<objective>
Create the technical documentation for the vault export format, including cryptographic specifications and test vectors.

Purpose: Fulfills PORT-03 (export format is publicly documented). This document is the reference specification that enables independent reimplementation of vault recovery in any programming language. It also serves as the in-repo technical reference alongside the user-facing explanations in the recovery tool.

Output: `docs/VAULT_EXPORT_FORMAT.md` with complete format specification, algorithm details, recovery procedure, and test vectors.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-data-portability/10-CONTEXT.md
@.planning/phases/10-data-portability/10-RESEARCH.md
@.planning/phases/10-data-portability/10-01-SUMMARY.md
@.planning/phases/10-data-portability/10-02-SUMMARY.md

@packages/crypto/src/ecies/decrypt.ts
@packages/crypto/src/ecies/encrypt.ts
@packages/crypto/src/aes/encrypt.ts
@packages/crypto/src/aes/decrypt.ts
@packages/crypto/src/folder/metadata.ts
@packages/crypto/src/folder/types.ts
@packages/crypto/src/constants.ts
@packages/crypto/src/utils/encoding.ts
@apps/api/src/vault/dto/vault-export.dto.ts
@apps/web/public/recovery.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Technical specification document</name>
  <files>docs/VAULT_EXPORT_FORMAT.md</files>
  <action>
Create `docs/VAULT_EXPORT_FORMAT.md` with the following sections. This is a technical reference -- precise, complete, no ambiguity.

**Section 1 -- Overview:** CipherBox is a zero-knowledge encrypted storage system. The vault export enables users to recover all their files independently of CipherBox infrastructure. The export contains the minimum data needed: the root IPNS name and two ECIES-encrypted root keys. From these, the entire folder hierarchy and all files can be recovered using the user's secp256k1 private key and public IPFS gateways.

**Section 2 -- Export JSON Format:** Document every field with type, encoding, size, and purpose. Fields: `format` (string, always `"cipherbox-vault-export"`), `version` (string, always `"1.0"`), `exportedAt` (string, ISO 8601 UTC), `rootIpnsName` (string, base32 or base36 libp2p-key multihash), `encryptedRootFolderKey` (string, hex-encoded ECIES ciphertext), `encryptedRootIpnsPrivateKey` (string, hex-encoded ECIES ciphertext), `derivationInfo` (optional object with method and derivationVersion). Include example JSON.

**Section 3 -- Cryptographic Algorithms:** 3.1 ECIES (secp256k1) for key wrapping: library eciesjs v0.4.16, curve secp256k1, uncompressed keys (65 bytes, 0x04 prefix), inner cipher AES-256-GCM with 16-byte nonce (NOT 12-byte), HKDF-SHA256 with `ikm = concat(ephemeralPublicKey, sharedPoint)`, salt=undefined, info=undefined, length=32. 3.2 AES-256-GCM for folder metadata and file content: 256-bit key, 96-bit IV (12 bytes), 128-bit tag (16 bytes), tag appended to ciphertext. 3.3 Ed25519 for IPNS: 64-byte libp2p format (privateKeySeed(32) || publicKey(32)).

**Section 4 -- ECIES Ciphertext Binary Format:** Byte layout table showing offset 0 = ephemeral PK (65 bytes), offset 65 = nonce (16 bytes), offset 81 = tag (16 bytes), offset 97 = ciphertext (N bytes). Total = 97 + plaintext_length. For encryptedRootFolderKey: 32-byte plaintext = 129 bytes = 258 hex chars. For encryptedRootIpnsPrivateKey: 64-byte plaintext = 161 bytes = 322 hex chars.

**Section 5 -- Encrypted Folder Metadata Format:** Stored on IPFS as JSON `{ "iv": "hex 12-byte IV", "data": "base64 ciphertext" }`. After AES-256-GCM decryption, plaintext is JSON with `version`, `children` array. Document both folder child entries (type, id, name, ipnsName, ipnsPrivateKeyEncrypted, folderKeyEncrypted, createdAt, modifiedAt) and file child entries (type, id, name, cid, fileKeyEncrypted, fileIv, encryptionMode, size, createdAt, modifiedAt).

**Section 6 -- Recovery Procedure:** Step-by-step pseudocode: parse export, validate format/version, accept private key (32 bytes), ECIES-decrypt root keys, resolve rootIpnsName via IPNS, fetch metadata from IPFS, decrypt with rootFolderKey, for each folder child recurse, for each file child decrypt and download. Document IPNS resolution methods: delegated routing API, Kubo API, generic gateways.

**Section 7 -- Test Vectors:** Include vectors generated by the script (Task 2). ECIES test vector with private key, public key, plaintext, encrypted hex. AES-256-GCM test vector with folder key, IV, plaintext JSON, encrypted output. Sample export JSON with all fields populated.

**Section 8 -- Security Considerations:** Export alone is insufficient (needs private key). Private key never in export. Memory-only key handling in recovery tools. ECIES IND-CCA2 security. Safe to store export in untrusted locations if key separate.

**Section 9 -- Compatibility Notes:** Version "1.0" corresponds to eciesjs@0.4.16 format. ECIES binary format may change with library upgrades; version would increment. IPNS records use Ed25519 V1+V2 compatibility.

Format: Use markdown with fenced code blocks, tables, and clear section headers. Write for a developer audience -- someone reimplementing this in Python, Go, or Rust should be able to follow it exactly.
</action>
<verify>
Read the document and verify all byte offsets are correct (65 + 16 + 16 = 97 header, total for 32-byte key = 129 bytes = 258 hex chars). Cross-reference the ECIES format description with the RESEARCH.md findings to confirm consistency. Verify the recovery procedure matches the implementation in `recovery.html`.
</verify>
<done>
`docs/VAULT_EXPORT_FORMAT.md` exists with complete specification covering: export JSON schema, ECIES binary format with byte offsets, AES-256-GCM parameters, encrypted metadata format, step-by-step recovery procedure, IPNS resolution methods, test vectors, and security considerations. A developer can reimplement vault recovery in any language using only this document.
</done>
</task>

<task type="auto">
  <name>Task 2: Test vector generation script</name>
  <files>scripts/generate-test-vectors.ts</files>
  <action>
Create `scripts/generate-test-vectors.ts` that uses `@cipherbox/crypto` to generate verifiable test vectors for the documentation.

The script should: Import from `@cipherbox/crypto` the functions `wrapKey`, `unwrapKey`, `sealFolderMetadata`, `openFolderMetadata`, `generateKey`, `generateIv`, and encoding utilities `hexToBytes`, `bytesToHex`. Generate a deterministic test keypair (use a fixed seed for reproducibility, or generate and print the private key). Generate a test folder key (32 bytes) and encrypt it with ECIES. Generate test folder metadata and encrypt it with AES-256-GCM. Print all test vectors as hex/base64 strings in a format suitable for pasting into the documentation. Verify round-trip: decrypt the encrypted values and confirm they match originals.

Output format (printed to stdout): ECIES Test Vector section with Private Key (hex), Public Key (hex), Plaintext (hex), Encrypted (hex). AES-256-GCM Folder Metadata Test Vector section with Folder Key (hex), IV (hex), Plaintext JSON, Encrypted output. Sample Export JSON section.

Run with: `npx tsx scripts/generate-test-vectors.ts`

IMPORTANT: The script is for documentation support only. It is NOT a test suite. Keep it simple -- generate vectors, print them, verify round-trip.
</action>
<verify>
Run `cd /Users/michael/Code/cipher-box && npx tsx scripts/generate-test-vectors.ts` and confirm: No errors. Test vectors printed to stdout. Round-trip verification passes (decrypt matches original). Copy the output into the VAULT_EXPORT_FORMAT.md test vectors section.
</verify>
<done>
Test vector generation script exists and produces reproducible vectors. Documentation contains working test vectors that match the actual crypto implementation.
</done>
</task>

</tasks>

<verification>

1. `docs/VAULT_EXPORT_FORMAT.md` exists and is comprehensive (200+ lines)
2. All ECIES byte offsets documented correctly (65 + 16 + 16 + N)
3. AES-256-GCM parameters match @cipherbox/crypto (12-byte IV, 16-byte tag)
4. Recovery procedure matches recovery.html implementation
5. Test vectors are verified by round-trip script
6. HKDF parameters documented as undefined/undefined (no salt, no info) matching eciesjs

</verification>

<success_criteria>

- A developer reading only VAULT_EXPORT_FORMAT.md can reimplement vault recovery without looking at source code
- Test vectors in the document can be independently verified
- Every crypto parameter is specified with exact sizes and encodings
- ECIES 16-byte nonce (not 12) is explicitly documented and explained
- Document covers both export format and full recovery procedure

</success_criteria>

<output>
After completion, create `.planning/phases/10-data-portability/10-03-SUMMARY.md`
</output>
