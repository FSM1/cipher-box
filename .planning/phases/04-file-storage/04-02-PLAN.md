---
phase: 04-file-storage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/vault/vault.module.ts
  - apps/api/src/vault/vault.controller.ts
  - apps/api/src/vault/vault.service.ts
  - apps/api/src/vault/entities/vault.entity.ts
  - apps/api/src/vault/entities/pinned-cid.entity.ts
  - apps/api/src/vault/entities/index.ts
  - apps/api/src/vault/dto/init-vault.dto.ts
  - apps/api/src/vault/dto/quota.dto.ts
  - apps/api/src/vault/dto/index.ts
  - apps/api/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - 'User can initialize vault with encrypted keys on first login'
    - 'User can retrieve current storage quota usage'
    - 'Quota check rejects uploads that would exceed 500 MiB'
    - 'Pin/unpin operations update quota tracking in database'
  artifacts:
    - path: 'apps/api/src/vault/vault.module.ts'
      provides: 'VaultModule with controller and service'
      exports: ['VaultModule']
    - path: 'apps/api/src/vault/vault.service.ts'
      provides: 'Vault operations and quota management'
      exports: ['VaultService']
    - path: 'apps/api/src/vault/entities/vault.entity.ts'
      provides: 'Vault entity for TypeORM'
      contains: 'class Vault'
    - path: 'apps/api/src/vault/entities/pinned-cid.entity.ts'
      provides: 'PinnedCid entity for quota tracking'
      contains: 'class PinnedCid'
  key_links:
    - from: 'apps/api/src/vault/vault.service.ts'
      to: 'apps/api/src/vault/entities/pinned-cid.entity.ts'
      via: 'TypeORM repository'
      pattern: 'Repository.*PinnedCid'
    - from: 'apps/api/src/vault/vault.service.ts'
      to: 'apps/api/src/vault/entities/vault.entity.ts'
      via: 'TypeORM repository'
      pattern: 'Repository.*Vault'
    - from: 'apps/api/src/app.module.ts'
      to: 'apps/api/src/vault/vault.module.ts'
      via: 'imports array'
      pattern: 'VaultModule'
---

<objective>
Create backend vault management with storage quota tracking for the 500 MiB limit.

Purpose: Store encrypted vault keys (zero-knowledge), track pinned CIDs per user, and enforce storage quota limits.
Output: VaultModule with vault init endpoint, quota check, and pin tracking entities.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-file-storage/04-CONTEXT.md
@.planning/phases/04-file-storage/04-RESEARCH.md

# Prior phase context

@.planning/phases/03-core-encryption/03-03-SUMMARY.md

# Existing backend structure

@apps/api/src/app.module.ts
@apps/api/src/auth/entities/user.entity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vault and PinnedCid entities</name>
  <files>
    apps/api/src/vault/entities/vault.entity.ts
    apps/api/src/vault/entities/pinned-cid.entity.ts
    apps/api/src/vault/entities/index.ts
  </files>
  <action>
    1. Create Vault entity (apps/api/src/vault/entities/vault.entity.ts):
       - id: UUID primary key (gen_random_uuid)
       - ownerId: UUID, unique, FK to users(id) ON DELETE CASCADE
       - ownerPublicKey: Buffer (BYTEA) - user's secp256k1 public key
       - encryptedRootFolderKey: Buffer (BYTEA) - ECIES-wrapped root folder key
       - encryptedRootIpnsPrivateKey: Buffer (BYTEA) - ECIES-wrapped IPNS private key
       - rootIpnsName: string (VARCHAR 255) - IPNS name for root folder
       - createdAt: Date (default NOW)
       - initializedAt: Date (nullable - set when vault first used)
       - updatedAt: Date (auto-update)
       - Add @ManyToOne relation to User entity

    2. Create PinnedCid entity (apps/api/src/vault/entities/pinned-cid.entity.ts):
       - id: UUID primary key
       - userId: UUID, FK to users(id) ON DELETE CASCADE
       - cid: string (VARCHAR 255)
       - sizeBytes: bigint (BIGINT)
       - pinnedAt: Date (default NOW)
       - Add unique constraint on (userId, cid)
       - Add index on userId for quota queries

    3. Create barrel export (apps/api/src/vault/entities/index.ts)

  </action>
  <verify>
    `cd /Users/myankelev/Code/random/cipher-box && pnpm -F @cipherbox/api build` compiles without errors
  </verify>
  <done>
    Vault and PinnedCid entities exist with proper TypeORM decorators and relations
  </done>
</task>

<task type="auto">
  <name>Task 2: Create VaultService with quota management</name>
  <files>
    apps/api/src/vault/vault.service.ts
    apps/api/src/vault/dto/init-vault.dto.ts
    apps/api/src/vault/dto/quota.dto.ts
    apps/api/src/vault/dto/index.ts
  </files>
  <action>
    1. Create DTOs:
       - InitVaultDto: ownerPublicKey (hex string), encryptedRootFolderKey (hex), encryptedRootIpnsPrivateKey (hex), rootIpnsName (string)
       - VaultResponseDto: id, rootIpnsName, createdAt, initializedAt
       - QuotaResponseDto: usedBytes (number), limitBytes (number), remainingBytes (number)
       - All with class-validator decorators

    2. Create VaultService (apps/api/src/vault/vault.service.ts):
       - Inject Repository<Vault> and Repository<PinnedCid>

       - Method `initializeVault(userId: string, dto: InitVaultDto): Promise<Vault>`:
         - Check if vault already exists for user
         - If exists, throw ConflictException
         - Create new vault with hex-decoded byte fields
         - Save and return

       - Method `getVault(userId: string): Promise<Vault | null>`:
         - Find vault by ownerId
         - Return null if not found

       - Method `getQuota(userId: string): Promise<QuotaResponseDto>`:
         - Query SUM(sizeBytes) from pinned_cids WHERE userId
         - Return { usedBytes, limitBytes: 500 * 1024 * 1024, remainingBytes }

       - Method `checkQuota(userId: string, additionalBytes: number): Promise<boolean>`:
         - Get current usage
         - Return (usedBytes + additionalBytes) <= QUOTA_LIMIT

       - Method `recordPin(userId: string, cid: string, sizeBytes: number): Promise<void>`:
         - Insert into pinned_cids with upsert (in case of retry)
         - Use ON CONFLICT DO NOTHING for idempotency

       - Method `recordUnpin(userId: string, cid: string): Promise<void>`:
         - Delete from pinned_cids WHERE userId AND cid
         - Return void (no error if not found - idempotent)

    3. Define QUOTA_LIMIT = 500 * 1024 * 1024 as constant

  </action>
  <verify>
    `cd /Users/myankelev/Code/random/cipher-box && pnpm -F @cipherbox/api build` compiles without errors
  </verify>
  <done>
    VaultService provides vault init, quota check, and pin tracking methods
  </done>
</task>

<task type="auto">
  <name>Task 3: Create VaultController and VaultModule</name>
  <files>
    apps/api/src/vault/vault.controller.ts
    apps/api/src/vault/vault.module.ts
    apps/api/src/app.module.ts
  </files>
  <action>
    1. Create VaultController (apps/api/src/vault/vault.controller.ts):
       - Apply @ApiTags('Vault') decorator
       - Apply @UseGuards(JwtAuthGuard) at controller level

       - POST /vault/init endpoint:
         - Accept @Body() dto: InitVaultDto
         - Extract userId from @Request() req
         - Call vaultService.initializeVault(userId, dto)
         - Return VaultResponseDto
         - Return 409 Conflict if vault exists

       - GET /vault endpoint:
         - Extract userId from request
         - Call vaultService.getVault(userId)
         - Return vault or 404 if not found

       - GET /vault/quota endpoint:
         - Extract userId from request
         - Call vaultService.getQuota(userId)
         - Return QuotaResponseDto

    2. Create VaultModule (apps/api/src/vault/vault.module.ts):
       - Import TypeOrmModule.forFeature([Vault, PinnedCid])
       - Import ConfigModule
       - Provide VaultService
       - Export VaultService (for use in other modules)
       - Declare VaultController

    3. Update apps/api/src/app.module.ts:
       - Add VaultModule to imports array
       - Add Vault and PinnedCid to entities array in TypeOrmModule config

    4. Add OpenAPI decorators to all endpoints

  </action>
  <verify>
    `cd /Users/myankelev/Code/random/cipher-box && pnpm -F @cipherbox/api build` compiles without errors
    OpenAPI spec includes /vault, /vault/init, /vault/quota endpoints
  </verify>
  <done>
    VaultModule exposes vault init, get, and quota endpoints, all protected by JwtAuthGuard
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `pnpm -F @cipherbox/api build`
2. Database migrations: TypeORM synchronize creates vault and pinned_cids tables
3. OpenAPI spec updated: Check apps/api/openapi.json includes /vault endpoints
4. Quota limit: 500 * 1024 * 1024 bytes (500 MiB) enforced
</verification>

<success_criteria>

- VaultModule exists and is imported in AppModule
- Vault entity stores encrypted keys (ownerPublicKey, encryptedRootFolderKey, encryptedRootIpnsPrivateKey, rootIpnsName)
- PinnedCid entity tracks CIDs with sizes for quota
- POST /vault/init creates vault with encrypted keys
- GET /vault retrieves vault for authenticated user
- GET /vault/quota returns { usedBytes, limitBytes, remainingBytes }
- Quota limit is 500 MiB (524,288,000 bytes)
- All endpoints protected by JwtAuthGuard
  </success_criteria>

<output>
After completion, create `.planning/phases/04-file-storage/04-02-SUMMARY.md`
</output>
