---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - .github/workflows/ci.yml
  - docker/docker-compose.yml
  - eslint.config.js
  - prettier.config.js
  - .husky/pre-commit
  - package.json (update)
  - apps/api/package.json (update)
  - apps/web/package.json (update)
autonomous: true
user_setup:
  - service: pinata
    why: "IPFS storage for encrypted files"
    env_vars:
      - name: PINATA_JWT
        source: "Pinata Dashboard -> API Keys -> New Key -> Admin permissions -> Copy JWT"
      - name: PINATA_GATEWAY
        source: "Pinata Dashboard -> Gateways -> Copy dedicated gateway URL"
    dashboard_config:
      - task: "Create Pinata account"
        location: "https://app.pinata.cloud/register"
      - task: "Create API key with admin permissions"
        location: "Pinata Dashboard -> API Keys -> New Key"

must_haves:
  truths:
    - "CI workflow triggers on push to main and pull requests"
    - "Pre-commit hook runs linting before commits"
    - "Docker Compose starts PostgreSQL locally"
    - "Pinata environment variables are documented"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI workflow"
      contains: "pnpm"
    - path: "docker/docker-compose.yml"
      provides: "Local PostgreSQL configuration"
      contains: "postgres"
    - path: "eslint.config.js"
      provides: "ESLint flat configuration"
      contains: "export default"
    - path: ".husky/pre-commit"
      provides: "Pre-commit hook"
      contains: "lint-staged"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json"
      via: "pnpm commands"
      pattern: "pnpm (lint|test|build)"
    - from: ".husky/pre-commit"
      to: "package.json"
      via: "lint-staged config"
      pattern: "lint-staged"
---

<objective>
Set up CI/CD pipeline, Docker Compose for local PostgreSQL, and code quality tooling.

Purpose: Establish automated quality gates and local development infrastructure so all contributors have consistent environments.
Output: GitHub Actions runs lint/test/build on PRs, Docker Compose provides PostgreSQL, Husky enforces pre-commit checks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>
    .github/workflows/ci.yml
  </files>
  <action>
Create CI workflow at `.github/workflows/ci.yml`:

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm lint

  test:
    name: Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: cipherbox_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          DB_DATABASE: cipherbox_test
          NODE_ENV: test

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build
```

Key points:
- Uses pnpm 10 and Node 22 (matches local dev)
- PostgreSQL service container for tests
- Build job depends on lint and test passing
- Uses frozen-lockfile to ensure reproducible installs
  </action>
  <verify>
File exists with correct structure: `cat .github/workflows/ci.yml | head -20`
  </verify>
  <done>CI workflow file created with lint, test, and build jobs</done>
</task>

<task type="auto">
  <name>Task 2: Create Docker Compose and ESLint/Prettier configuration</name>
  <files>
    docker/docker-compose.yml
    eslint.config.js
    prettier.config.js
    package.json (update)
  </files>
  <action>
1. Create `docker/docker-compose.yml`:
```yaml
services:
  postgres:
    image: postgres:16-alpine
    container_name: cipherbox-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_DATABASE:-cipherbox}
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
```

2. Create `eslint.config.js` (ESLint 9.x flat config):
```javascript
import globals from 'globals';
import pluginJs from '@eslint/js';
import tseslint from 'typescript-eslint';
import pluginPrettier from 'eslint-plugin-prettier/recommended';

export default [
  { ignores: ['**/dist/**', '**/node_modules/**', '**/.planning/**'] },
  { files: ['**/*.{js,mjs,cjs,ts,tsx}'] },
  { languageOptions: { globals: { ...globals.browser, ...globals.node } } },
  pluginJs.configs.recommended,
  ...tseslint.configs.recommended,
  pluginPrettier,
  {
    rules: {
      '@typescript-eslint/no-unused-vars': ['error', { argsIgnorePattern: '^_' }],
      '@typescript-eslint/explicit-function-return-type': 'off',
      '@typescript-eslint/no-explicit-any': 'warn',
    },
  },
];
```

3. Create `prettier.config.js`:
```javascript
export default {
  semi: true,
  singleQuote: true,
  tabWidth: 2,
  trailingComma: 'es5',
  printWidth: 100,
};
```

4. Update root `package.json` to add ESLint/Prettier dependencies and lint-staged config:

Add to devDependencies:
```json
{
  "devDependencies": {
    "typescript": "^5.9.3",
    "eslint": "^9.39.2",
    "@eslint/js": "^9.39.2",
    "typescript-eslint": "^8.33.0",
    "eslint-plugin-prettier": "^5.4.0",
    "eslint-config-prettier": "^10.1.0",
    "prettier": "^3.8.0",
    "husky": "^9.1.7",
    "lint-staged": "^15.5.0",
    "globals": "^16.2.0"
  }
}
```

Add lint-staged config:
```json
{
  "lint-staged": {
    "*.{ts,tsx,js,jsx}": [
      "eslint --fix",
      "prettier --write"
    ],
    "*.{json,md,yml,yaml}": [
      "prettier --write"
    ]
  }
}
```

Add prepare script:
```json
{
  "scripts": {
    "prepare": "husky"
  }
}
```

5. Update `apps/api/package.json` to add ESLint devDependencies for NestJS:
```json
{
  "devDependencies": {
    "eslint": "^9.39.2"
  }
}
```

6. Update `apps/web/package.json` to add ESLint devDependencies for React:
```json
{
  "devDependencies": {
    "eslint": "^9.39.2",
    "eslint-plugin-react-hooks": "^5.2.0",
    "eslint-plugin-react-refresh": "^0.4.20"
  }
}
```
  </action>
  <verify>
Files exist: `ls docker/docker-compose.yml eslint.config.js prettier.config.js`
Docker compose syntax valid: `docker compose -f docker/docker-compose.yml config`
  </verify>
  <done>Docker Compose and code quality tools configured</done>
</task>

<task type="auto">
  <name>Task 3: Set up Husky pre-commit hooks</name>
  <files>
    .husky/pre-commit
  </files>
  <action>
Set up Husky for pre-commit hooks:

1. Run `pnpm install` to ensure all dependencies are installed

2. Run `pnpm husky` to initialize husky (this creates .husky directory if needed)

3. Create `.husky/pre-commit`:
```bash
pnpm lint-staged
```

Make the file executable: `chmod +x .husky/pre-commit`

4. Verify the hook works by staging a file and running `git commit` (it should run lint-staged)

Note: The `prepare` script in package.json ensures husky is set up when anyone runs `pnpm install` after cloning.
  </action>
  <verify>
Husky initialized: `ls -la .husky/pre-commit`
Hook executable: `test -x .husky/pre-commit && echo "executable"`
  </verify>
  <done>Pre-commit hook created and executable</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **CI workflow:**
   - `.github/workflows/ci.yml` exists with lint, test, build jobs
   - Push to a branch triggers workflow (verify in GitHub Actions tab)

2. **Docker Compose:**
   - `docker compose -f docker/docker-compose.yml up -d` starts PostgreSQL
   - `docker compose -f docker/docker-compose.yml ps` shows healthy container
   - Connect with: `psql -h localhost -U postgres -d cipherbox`

3. **Linting:**
   - `pnpm lint` runs ESLint on all packages
   - Create intentional lint error, verify it's caught

4. **Pre-commit:**
   - Stage a .ts file with lint errors
   - `git commit` should fail with ESLint errors
   - Fix errors, commit should succeed

5. **Full integration:**
   - `docker compose -f docker/docker-compose.yml up -d`
   - `cp .env.example .env`
   - `pnpm dev` (both frontend and backend start)
   - Backend health check: `curl http://localhost:3000/health`
   - Frontend: Open http://localhost:5173
</verification>

<success_criteria>
- [ ] CI workflow exists at .github/workflows/ci.yml
- [ ] CI has lint, test, and build jobs with PostgreSQL service
- [ ] Docker Compose file starts PostgreSQL 16 with volume persistence
- [ ] ESLint flat config exists with TypeScript and Prettier integration
- [ ] Prettier config exists with consistent style rules
- [ ] Husky pre-commit hook runs lint-staged
- [ ] `pnpm lint` passes on all packages
- [ ] `pnpm dev` starts both frontend and backend concurrently
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
