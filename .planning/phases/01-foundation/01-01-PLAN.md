---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-workspace.yaml
  - tsconfig.base.json
  - .env.example
  - apps/api/package.json
  - apps/api/tsconfig.json
  - apps/api/src/main.ts
  - apps/api/src/app.module.ts
  - apps/api/src/app.controller.ts
  - apps/api/src/app.service.ts
  - apps/api/src/health/health.module.ts
  - apps/api/src/health/health.controller.ts
  - apps/api/scripts/generate-openapi.ts
  - packages/crypto/package.json
  - packages/crypto/tsconfig.json
  - packages/crypto/src/index.ts
autonomous: true

must_haves:
  truths:
    - "pnpm install succeeds at root level"
    - "Backend dev server starts without errors"
    - "Health endpoint returns 200 status"
    - "OpenAPI spec is accessible at /api-docs"
    - "OpenAPI JSON can be exported to file"
  artifacts:
    - path: "package.json"
      provides: "Root workspace configuration"
      contains: "workspaces"
    - path: "pnpm-workspace.yaml"
      provides: "pnpm workspace definition"
      contains: "packages"
    - path: "apps/api/src/main.ts"
      provides: "NestJS bootstrap with Swagger"
      min_lines: 10
    - path: "apps/api/src/health/health.controller.ts"
      provides: "Health check endpoint with Swagger decorators"
      exports: ["HealthController"]
    - path: "apps/api/scripts/generate-openapi.ts"
      provides: "Script to export OpenAPI spec to JSON"
      contains: "SwaggerModule.createDocument"
    - path: "packages/crypto/src/index.ts"
      provides: "Crypto package entry point"
  key_links:
    - from: "apps/api/tsconfig.json"
      to: "tsconfig.base.json"
      via: "extends"
      pattern: "extends.*tsconfig\\.base"
    - from: "apps/api/src/app.module.ts"
      to: "health.module.ts"
      via: "imports array"
      pattern: "HealthModule"
    - from: "apps/api/src/main.ts"
      to: "@nestjs/swagger"
      via: "SwaggerModule setup"
      pattern: "SwaggerModule"
---

<objective>
Create pnpm monorepo workspace with NestJS backend scaffold, health check endpoint, and OpenAPI specification.

Purpose: Establish the foundational backend infrastructure that all subsequent phases will build upon. The health endpoint verifies database connectivity. OpenAPI spec enables typed client generation.
Output: Working NestJS API at localhost:3000 with /health endpoint, Swagger UI at /api-docs, and exportable OpenAPI JSON spec.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pnpm workspace root with shared TypeScript config</name>
  <files>
    package.json
    pnpm-workspace.yaml
    tsconfig.base.json
    .env.example
    .gitignore (update)
  </files>
  <action>
Create root workspace structure:

1. Create `pnpm-workspace.yaml`:
```yaml
packages:
  - 'apps/*'
  - 'packages/*'
```

2. Create root `package.json`:
```json
{
  "name": "cipher-box",
  "private": true,
  "scripts": {
    "dev": "pnpm --parallel -r run dev",
    "build": "pnpm --parallel -r run build",
    "lint": "pnpm --parallel -r run lint",
    "test": "pnpm --parallel -r run test"
  },
  "devDependencies": {
    "typescript": "^5.9.3"
  }
}
```

3. Create `tsconfig.base.json` with strict TypeScript settings:
- target: ES2022
- module: ESNext
- moduleResolution: bundler
- strict: true
- strictNullChecks: true
- esModuleInterop: true
- skipLibCheck: true
- forceConsistentCasingInFileNames: true

4. Create `.env.example` with database connection template:
```
# Database
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=postgres
DB_DATABASE=cipherbox

# Environment
NODE_ENV=development

# Pinata (IPFS)
PINATA_JWT=your_pinata_jwt_here
PINATA_GATEWAY=your_gateway_here
```

5. Update `.gitignore` to include:
- node_modules/
- dist/
- .env
- .env.local
- *.log

Do NOT create apps/ or packages/ directories yet - they will be created by subsequent tasks.
  </action>
  <verify>
Files exist: `ls package.json pnpm-workspace.yaml tsconfig.base.json .env.example`
  </verify>
  <done>Root workspace configuration files exist and contain correct content</done>
</task>

<task type="auto">
  <name>Task 2: Scaffold NestJS backend with TypeORM and health endpoint</name>
  <files>
    apps/api/package.json
    apps/api/tsconfig.json
    apps/api/nest-cli.json
    apps/api/src/main.ts
    apps/api/src/app.module.ts
    apps/api/src/app.controller.ts
    apps/api/src/app.service.ts
    apps/api/src/health/health.module.ts
    apps/api/src/health/health.controller.ts
  </files>
  <action>
Create NestJS backend in apps/api:

1. Create `apps/api` directory structure manually (do NOT use `nest new` - it creates unnecessary files and git init)

2. Create `apps/api/package.json`:
```json
{
  "name": "@cipherbox/api",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "dev": "nest start --watch",
    "build": "nest build",
    "start": "nest start",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\"",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "openapi:generate": "ts-node scripts/generate-openapi.ts"
  },
  "dependencies": {
    "@nestjs/common": "^11.0.0",
    "@nestjs/core": "^11.0.0",
    "@nestjs/platform-express": "^11.0.0",
    "@nestjs/config": "^4.0.0",
    "@nestjs/typeorm": "^11.0.0",
    "@nestjs/terminus": "^11.0.0",
    "@nestjs/swagger": "^11.0.0",
    "typeorm": "^0.3.28",
    "pg": "^8.14.1",
    "reflect-metadata": "^0.2.0",
    "rxjs": "^7.8.0"
  },
  "devDependencies": {
    "@nestjs/cli": "^11.0.0",
    "@nestjs/schematics": "^11.0.0",
    "@nestjs/testing": "^11.0.0",
    "@types/express": "^5.0.0",
    "@types/jest": "^29.5.0",
    "@types/node": "^22.0.0",
    "jest": "^29.7.0",
    "ts-jest": "^29.3.0",
    "ts-node": "^10.9.2",
    "typescript": "^5.9.3"
  }
}
```

3. Create `apps/api/tsconfig.json` that extends root:
```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "module": "CommonJS",
    "outDir": "./dist",
    "rootDir": "./src",
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "declaration": false,
    "sourceMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

4. Create `apps/api/nest-cli.json`:
```json
{
  "$schema": "https://json.schemastore.org/nest-cli",
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "deleteOutDir": true
  }
}
```

5. Create `apps/api/src/main.ts`:
- Bootstrap NestJS app on port 3000
- Enable CORS
- Configure SwaggerModule with DocumentBuilder:
  ```typescript
  import { NestFactory } from '@nestjs/core';
  import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
  import { AppModule } from './app.module';

  async function bootstrap() {
    const app = await NestFactory.create(AppModule);
    app.enableCors();

    const config = new DocumentBuilder()
      .setTitle('CipherBox API')
      .setDescription('Zero-knowledge encrypted cloud storage API')
      .setVersion('0.1.0')
      .addBearerAuth()
      .build();
    const document = SwaggerModule.createDocument(app, config);
    SwaggerModule.setup('api-docs', app, document, {
      jsonDocumentUrl: 'api-docs/json',
    });

    await app.listen(3000);
    console.log('CipherBox API running on http://localhost:3000');
    console.log('Swagger UI: http://localhost:3000/api-docs');
  }
  bootstrap();
  ```
- Log startup message with Swagger URL

6. Create `apps/api/src/app.module.ts`:
- Import ConfigModule.forRoot (global: true)
- Import TypeOrmModule.forRootAsync with ConfigService
- Import HealthModule
- Use environment variables for database config
- Set synchronize based on NODE_ENV (false in production)

7. Create `apps/api/src/app.controller.ts` and `apps/api/src/app.service.ts`:
- Simple root endpoint returning "CipherBox API v0.1"

8. Create `apps/api/src/health/health.module.ts`:
- Import TerminusModule
- Export HealthController

9. Create `apps/api/src/health/health.controller.ts`:
- GET /health endpoint using @nestjs/terminus
- TypeOrmHealthIndicator for database ping check
- Returns { status: 'ok', info: { database: { status: 'up' } } } on success
- Add Swagger decorators:
  ```typescript
  import { Controller, Get } from '@nestjs/common';
  import { ApiTags, ApiOperation, ApiResponse } from '@nestjs/swagger';
  import { HealthCheck, HealthCheckService, TypeOrmHealthIndicator } from '@nestjs/terminus';

  @ApiTags('Health')
  @Controller('health')
  export class HealthController {
    constructor(
      private health: HealthCheckService,
      private db: TypeOrmHealthIndicator,
    ) {}

    @Get()
    @HealthCheck()
    @ApiOperation({ summary: 'Check API and database health' })
    @ApiResponse({ status: 200, description: 'Health check passed' })
    @ApiResponse({ status: 503, description: 'Health check failed' })
    check() {
      return this.health.check([
        () => this.db.pingCheck('database'),
      ]);
    }
  }
  ```

IMPORTANT: Do NOT use enums for TypeORM type field - use string literal 'postgres' instead.
  </action>
  <verify>
Run from project root:
1. `pnpm install`
2. `cd apps/api && pnpm build` (should compile without errors)
3. Start the server and verify Swagger UI at http://localhost:3000/api-docs
  </verify>
  <done>NestJS API scaffold compiles successfully with health module and Swagger</done>
</task>

<task type="auto">
  <name>Task 3: Create OpenAPI spec generation script</name>
  <files>
    apps/api/scripts/generate-openapi.ts
  </files>
  <action>
Create a script to export the OpenAPI spec to a JSON file for client generation:

1. Create `apps/api/scripts/generate-openapi.ts`:
```typescript
import { NestFactory } from '@nestjs/core';
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
import { writeFileSync, mkdirSync } from 'fs';
import { join } from 'path';
import { AppModule } from '../src/app.module';

async function generateOpenApiSpec() {
  const app = await NestFactory.create(AppModule, { logger: false });

  const config = new DocumentBuilder()
    .setTitle('CipherBox API')
    .setDescription('Zero-knowledge encrypted cloud storage API')
    .setVersion('0.1.0')
    .addBearerAuth()
    .build();

  const document = SwaggerModule.createDocument(app, config);

  // Ensure output directory exists
  const outputDir = join(__dirname, '..', '..', '..', 'packages', 'api-client');
  mkdirSync(outputDir, { recursive: true });

  const outputPath = join(outputDir, 'openapi.json');
  writeFileSync(outputPath, JSON.stringify(document, null, 2));

  console.log(`OpenAPI spec written to: ${outputPath}`);

  await app.close();
}

generateOpenApiSpec();
```

This script:
- Bootstraps the NestJS app without starting the HTTP server
- Creates the OpenAPI document using the same config as main.ts
- Writes the JSON spec to packages/api-client/openapi.json
- This location allows the frontend (and future clients) to consume it

2. Add to root package.json scripts:
```json
{
  "scripts": {
    "openapi:generate": "pnpm --filter @cipherbox/api openapi:generate"
  }
}
```
  </action>
  <verify>
Run: `cd apps/api && pnpm openapi:generate`
Check: `cat packages/api-client/openapi.json | head -20` shows valid OpenAPI spec
  </verify>
  <done>OpenAPI generation script creates valid JSON spec at packages/api-client/openapi.json</done>
</task>

<task type="auto">
  <name>Task 4: Create shared crypto package stub</name>
  <files>
    packages/crypto/package.json
    packages/crypto/tsconfig.json
    packages/crypto/src/index.ts
  </files>
  <action>
Create crypto package structure (stub for future phases):

1. Create `packages/crypto/package.json`:
```json
{
  "name": "@cipherbox/crypto",
  "version": "0.0.1",
  "private": true,
  "main": "./dist/index.js",
  "module": "./dist/index.mjs",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.mjs",
      "require": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  },
  "scripts": {
    "dev": "tsup --watch",
    "build": "tsup",
    "lint": "eslint src/**/*.ts",
    "test": "jest"
  },
  "devDependencies": {
    "tsup": "^8.5.0",
    "typescript": "^5.9.3"
  }
}
```

2. Create `packages/crypto/tsconfig.json`:
```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

3. Create `packages/crypto/tsup.config.ts`:
```typescript
import { defineConfig } from 'tsup';

export default defineConfig({
  entry: ['src/index.ts'],
  format: ['cjs', 'esm'],
  dts: true,
  clean: true,
  sourcemap: true,
});
```

4. Create `packages/crypto/src/index.ts`:
```typescript
/**
 * @cipherbox/crypto
 *
 * Shared cryptographic utilities for CipherBox.
 * This package provides AES-256-GCM encryption and ECIES key wrapping.
 *
 * Implemented in Phase 3.
 */

export const CRYPTO_VERSION = '0.0.1';

// Placeholder exports - real implementation in Phase 3
export type CryptoKey = Uint8Array;
```

This is a stub that will be implemented in Phase 3 (Core Encryption).
  </action>
  <verify>
`ls packages/crypto/package.json packages/crypto/src/index.ts`
`pnpm install` at root succeeds with workspace packages linked
  </verify>
  <done>Crypto package stub exists and is recognized by workspace</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Workspace integrity:**
   - `pnpm install` succeeds at root
   - `pnpm ls -r` shows @cipherbox/api and @cipherbox/crypto

2. **Backend compilation:**
   - `cd apps/api && pnpm build` compiles without TypeScript errors

3. **Health endpoint (requires PostgreSQL running):**
   - Start PostgreSQL via Docker: `docker run -d -p 5432:5432 -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=cipherbox postgres:16-alpine`
   - Copy .env.example to .env
   - `cd apps/api && pnpm dev`
   - `curl http://localhost:3000/health` returns JSON with status "ok"

4. **OpenAPI/Swagger:**
   - Swagger UI accessible at http://localhost:3000/api-docs
   - OpenAPI JSON at http://localhost:3000/api-docs/json
   - `pnpm openapi:generate` creates packages/api-client/openapi.json
</verification>

<success_criteria>
- [ ] Root package.json exists with workspace scripts
- [ ] pnpm-workspace.yaml defines apps/* and packages/*
- [ ] tsconfig.base.json has strict TypeScript configuration
- [ ] NestJS API in apps/api compiles successfully
- [ ] Health endpoint controller exists with database ping check and Swagger decorators
- [ ] Swagger UI accessible at http://localhost:3000/api-docs
- [ ] OpenAPI JSON spec exportable via `pnpm openapi:generate`
- [ ] @cipherbox/crypto package stub exists with dual format exports
- [ ] `pnpm install` at root links all workspace packages
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
