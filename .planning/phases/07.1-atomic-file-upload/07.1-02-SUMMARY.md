---
phase: 07.1-atomic-file-upload
plan: 02
subsystem: ui
tags: [react, zustand, ipns, upload, batch]

# Dependency graph
requires:
  - phase: 07.1-atomic-file-upload
    provides: POST /ipfs/upload atomic endpoint (plan 01)
  - phase: 05-folder-system
    provides: folder.service addFileToFolder, updateFolderMetadata, IPNS publishing
provides:
  - Batch addFilesToFolder function (single IPNS publish for N files)
  - Frontend upload flow using atomic /ipfs/upload endpoint
  - Server-authoritative quota sync (fetchQuota replaces local addUsage)
  - Upload store registering status for metadata registration phase
affects: [08-tee-republishing, 09-desktop-app]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'Batch folder registration: addFilesToFolder publishes IPNS once for N files'
    - 'Server-authoritative quota: fetchQuota after upload replaces per-file addUsage'
    - 'Registering status: distinct upload phase between IPFS upload and folder metadata registration'

key-files:
  created: []
  modified:
    - apps/web/src/lib/api/ipfs.ts
    - apps/web/src/services/upload.service.ts
    - apps/web/src/services/folder.service.ts
    - apps/web/src/stores/upload.store.ts
    - apps/web/src/hooks/useFolder.ts
    - apps/web/src/hooks/useFileUpload.ts
    - apps/web/src/components/file-browser/UploadZone.tsx
    - apps/web/src/components/file-browser/EmptyState.tsx

key-decisions:
  - 'Batch addFiles coexists with single addFile (both exported from useFolder)'
  - 'Server-authoritative quota via fetchQuota after upload (not per-file addUsage)'
  - 'All-or-nothing batch registration (no partial failure handling per plan)'

patterns-established:
  - 'Batch folder operations: build all entries, publish IPNS once'
  - 'Upload status progression: encrypting -> uploading -> registering -> success'

# Metrics
duration: 3min
completed: 2026-02-07
---

# Phase 7.1 Plan 02: Client-Side Upload Refactor Summary

Batch upload flow with atomic endpoint, single IPNS publish per batch, and server-authoritative quota sync.

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-07T01:49:55Z
- **Completed:** 2026-02-07T01:53:02Z
- **Tasks:** 2
- **Files modified:** 8

## Accomplishments

- Switched addToIpfs to use POST /ipfs/upload atomic endpoint (pin + quota record in one call)
- Added addFilesToFolder batch function that publishes IPNS exactly once for N files
- Replaced per-file addUsage with server-authoritative fetchQuota after upload
- Added registering upload status for metadata registration phase
- Updated UploadZone and EmptyState to use batch addFiles instead of per-file addFile loop

## Task Commits

Each task was committed atomically:

1. **Task 1: Switch upload API to new endpoint, add batch folder registration, update quota flow** - `481c5f7` (feat)
2. **Task 2: Wire batch upload flow into hooks and components** - `5d6d803` (feat)

## Files Created/Modified

- `apps/web/src/lib/api/ipfs.ts` - addToIpfs now posts to /ipfs/upload
- `apps/web/src/services/upload.service.ts` - fetchQuota replaces per-file addUsage
- `apps/web/src/services/folder.service.ts` - addFilesToFolder batch function added
- `apps/web/src/stores/upload.store.ts` - registering status and setRegistering action
- `apps/web/src/hooks/useFolder.ts` - addFiles batch handler alongside existing addFile
- `apps/web/src/hooks/useFileUpload.ts` - isUploading includes registering status
- `apps/web/src/components/file-browser/UploadZone.tsx` - Batch addFiles replaces per-file loop
- `apps/web/src/components/file-browser/EmptyState.tsx` - Batch addFiles replaces per-file loop

## Decisions Made

- Batch addFiles coexists with single addFile -- both remain exported from useFolder for different code paths
- Server-authoritative quota via fetchQuota after upload replaces optimistic per-file addUsage
- All-or-nothing batch registration (no partial failure handling) -- simplifies error semantics

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Atomic file upload flow complete end-to-end (backend + frontend)
- Phase 7.1 fully complete -- ready for Phase 8 (TEE Republishing)
- Multi-file uploads now produce 1 IPNS publish instead of N (significant latency improvement)
- Single-file uploads still work correctly (batch of 1)

---

_Phase: 07.1-atomic-file-upload_
_Completed: 2026-02-07_
