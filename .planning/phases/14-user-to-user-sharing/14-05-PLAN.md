---
phase: 14-user-to-user-sharing
plan: 05
type: execute
wave: 4
depends_on: ['14-03', '14-04']
files_modified:
  - apps/web/src/components/file-browser/SharedFileBrowser.tsx
  - apps/web/src/hooks/useSharedNavigation.ts
  - apps/web/src/routes/index.tsx
  - apps/web/src/components/file-browser/Breadcrumbs.tsx
  - apps/web/src/components/file-browser/ContextMenu.tsx
  - apps/web/src/styles/shared-browser.css
autonomous: true

must_haves:
  truths:
    - 'User can navigate to ~/shared and see all shared items'
    - 'User can browse into a shared folder and see its decrypted contents'
    - 'Shared items display [RO] badge and SHARED BY column'
    - 'Upload, New Folder, Rename, Move, Delete buttons are hidden in shared context'
    - 'User can download shared files using re-wrapped keys'
    - 'User can hide a shared item from their view'
  artifacts:
    - path: 'apps/web/src/components/file-browser/SharedFileBrowser.tsx'
      provides: 'Read-only file browser for shared content'
      exports: ['SharedFileBrowser']
    - path: 'apps/web/src/hooks/useSharedNavigation.ts'
      provides: 'Navigation hook for shared folder browsing'
      exports: ['useSharedNavigation']
  key_links:
    - from: 'apps/web/src/hooks/useSharedNavigation.ts'
      to: 'apps/web/src/stores/share.store.ts'
      via: 'reads received shares from store'
      pattern: 'useShareStore'
    - from: 'apps/web/src/hooks/useSharedNavigation.ts'
      to: 'apps/web/src/services/share.service.ts'
      via: 'fetches share keys for decryption'
      pattern: 'fetchShareKeys'
    - from: 'apps/web/src/components/file-browser/SharedFileBrowser.tsx'
      to: 'apps/web/src/hooks/useSharedNavigation.ts'
      via: 'uses navigation hook'
      pattern: 'useSharedNavigation'
    - from: 'apps/web/src/routes/index.tsx'
      to: 'apps/web/src/components/file-browser/SharedFileBrowser.tsx'
      via: 'route registration'
      pattern: 'Route.*shared'
---

<objective>
Build the "Shared with me" browsing experience with read-only enforcement.

Purpose: This is the recipient's view -- they navigate to ~/shared to see items shared with them, browse shared folders, download shared files, and experience proper read-only constraints. This is the core sharing UX from the recipient's perspective.
Output: SharedFileBrowser component, shared navigation hook, route registration, read-only context menu, breadcrumb integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-user-to-user-sharing/14-CONTEXT.md
@.planning/phases/14-user-to-user-sharing/14-RESEARCH.md
@.planning/phases/14-user-to-user-sharing/14-03-SUMMARY.md
@.planning/phases/14-user-to-user-sharing/14-04-SUMMARY.md
@apps/web/src/components/file-browser/FileBrowser.tsx
@apps/web/src/hooks/useFolderNavigation.ts
@apps/web/src/services/folder.service.ts
@apps/web/src/services/download.service.ts
@apps/web/src/components/file-browser/Breadcrumbs.tsx
@apps/web/src/components/file-browser/FileList.tsx
@apps/web/src/components/file-browser/ContextMenu.tsx
@apps/web/src/routes/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSharedNavigation hook and SharedFileBrowser component</name>
  <files>
    apps/web/src/hooks/useSharedNavigation.ts
    apps/web/src/components/file-browser/SharedFileBrowser.tsx
    apps/web/src/styles/shared-browser.css
  </files>
  <action>
    **useSharedNavigation.ts** -- Hook for browsing shared content. Similar to useFolderNavigation but with different key source:

    **State:**
    - `currentView`: 'list' (top-level shared items) or 'folder' (inside a shared folder)
    - `currentShareId`: which share we're browsing into (null at top level)
    - `currentFolderKey`: decrypted folder key for current shared folder
    - `children`: FolderChild[] -- contents of current shared folder
    - `breadcrumbs`: array of { id, name } for navigation
    - `isLoading`: boolean

    **Top-level view (~/shared):**
    1. On mount, call fetchReceivedShares() and update share store
    2. For each received share, resolve IPNS to get the latest CID
    3. Decrypt folder/file metadata using the share's encryptedKey:
       - unwrapKey(hexToBytes(share.encryptedKey), userPrivateKey) -> folderKey/parentFolderKey
       - For folders: decrypt folder metadata with folderKey -> get children list
       - For files: just show the file with its metadata
    4. Display as a flat list with columns: NAME, TYPE, SHARED BY (truncated pubkey), DATE

    **Folder browsing (~/shared/:shareId/:path*):**
    1. When user clicks into a shared folder, navigate deeper
    2. For subfolders: fetch re-wrapped subfolder key from share_keys via fetchShareKeys
       - unwrapKey the subfolder's folderKeyEncrypted with user's privateKey
       - Resolve subfolder's IPNS, decrypt metadata with subfolderKey
    3. For files: same -- get re-wrapped fileKey from share_keys
    4. Update breadcrumbs: ~/shared > {sharedFolderName} > {subfolder} > ...

    **File download from shared context:**
    1. Get the file's re-wrapped fileKey from share_keys: fetchShareKeys(shareId) filtered by fileId
    2. unwrapKey with user's privateKey -> fileKey
    3. Fetch encrypted content from IPFS (use existing download service patterns)
    4. Decrypt with fileKey + fileIv from FileMetadata
    5. Trigger browser download

    Expose: `navigateToShare(shareId)`, `navigateToSubfolder(folderId)`, `navigateUp()`, `navigateToRoot()`, `downloadSharedFile(item)`, `hideShare(shareId)`.

    **SharedFileBrowser.tsx** -- Component that reuses existing FileList for rendering but with read-only constraints:

    1. Import useSharedNavigation hook
    2. At top level, show list of shared items with SHARED BY column
    3. Inside shared folder, show standard file list but without write actions
    4. Reuse FileList component with a `readOnly` prop or by simply not passing write-action callbacks
    5. Show `[RO]` badge on each item via a className or inline indicator
    6. Header shows "SHARED WITH ME" title in terminal style
    7. No UploadZone, no CreateFolderDialog, no upload button
    8. ContextMenu in read-only mode: only Download, Preview, Details, and "Hide" (for top-level items)
    9. EmptyState: "no shared items yet -- ask others to share their public key"

    **CSS for shared browser styling and [RO] badge:**
    ```css
    .shared-ro-badge {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      color: var(--color-text-dim);
      margin-left: var(--spacing-xs);
      opacity: 0.7;
    }

    .shared-by-cell {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--color-green-primary);
      opacity: 0.8;
    }
    ```

  </action>
  <verify>
    Run `pnpm --filter web build` succeeds.
    Verify SharedFileBrowser exports and renders.
    Verify useSharedNavigation exports navigateToShare, navigateUp, downloadSharedFile.
  </verify>
  <done>
    SharedFileBrowser renders received shares at top level and allows browsing into shared folders with read-only enforcement. File download uses re-wrapped keys from share_keys. [RO] badges visible. Write actions hidden.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register shared route, update Breadcrumbs, and read-only ContextMenu</name>
  <files>
    apps/web/src/routes/index.tsx
    apps/web/src/components/file-browser/Breadcrumbs.tsx
    apps/web/src/components/file-browser/ContextMenu.tsx
  </files>
  <action>
    **routes/index.tsx:**
    Add route for shared browsing. The SharedFileBrowser should be wrapped in AppShell (same as FilesPage):

    ```tsx
    import { SharedPage } from './SharedPage';
    // ...
    <Route path="/shared/:shareId?/*" element={<SharedPage />} />
    ```

    Create `apps/web/src/routes/SharedPage.tsx` -- minimal wrapper:
    ```tsx
    import { AppShell } from '../components/layout';
    import { SharedFileBrowser } from '../components/file-browser/SharedFileBrowser';

    export function SharedPage() {
      // Auth check same as FilesPage
      return (
        <AppShell>
          <SharedFileBrowser />
        </AppShell>
      );
    }
    ```

    **Breadcrumbs.tsx modifications:**
    Update to support the ~/shared path style:
    - When in shared context, first breadcrumb is "shared" (not "root" / "My Vault")
    - Breadcrumb path reads: `~/shared` > `{folderName}` > `{subfolder}` > ...
    - The "shared" breadcrumb links to /shared (top-level shared list)
    - Accept an optional `rootLabel` prop or detect shared context via route

    If Breadcrumbs is tightly coupled to folder.store, consider either:
    a. Making it accept generic breadcrumb data (preferred)
    b. Creating a separate SharedBreadcrumbs component within SharedFileBrowser

    **ContextMenu.tsx modifications:**
    Add a `readOnly?: boolean` prop. When readOnly is true:
    - Hide: Rename, Move, Delete, Edit
    - Show only: Download (files), Preview (media), Details
    - Add: "Hide" action (calls hideShare to remove from view) -- only at top-level shared items

    Add `onHide?: () => void` prop for the hide action:
    ```tsx
    {readOnly && onHide && (
      <button
        type="button"
        className="context-menu-item"
        onClick={handleHide}
        role="menuitem"
      >
        <span className="context-menu-item-icon">&#10005;</span>
        Hide
      </button>
    )}
    ```

    Also add navigation link from the main FileBrowser or AppShell to ~/shared. Consider adding a "Shared" link in the navigation (check how Settings navigation works -- likely in AppShell header/footer).

  </action>
  <verify>
    Run `pnpm --filter web build` succeeds.
    Navigate to /shared route -- SharedPage renders SharedFileBrowser.
    Verify ContextMenu readOnly prop hides write actions.
    Verify Breadcrumbs shows ~/shared path in shared context.
  </verify>
  <done>
    /shared route registered and renders SharedFileBrowser in AppShell. Breadcrumbs show ~/shared path. ContextMenu hides write actions in read-only mode. Navigation to ~/shared accessible.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter web build` passes
- /shared route exists and renders SharedFileBrowser
- Shared items display [RO] badge and SHARED BY column
- Context menu in shared context shows only Download, Preview, Details, Hide
- Write actions (upload, new folder, rename, move, delete) are hidden
- Breadcrumbs show ~/shared path correctly
- File download from shared context uses re-wrapped keys
</verification>

<success_criteria>

1. User navigates to ~/shared and sees received shares as a flat list
2. User clicks into a shared folder and browses its contents read-only
3. User downloads a shared file using re-wrapped key from share_keys
4. [RO] badge appears on all shared items
5. SHARED BY column shows truncated sharer pubkey (0x1a2b...9f0e)
6. No upload/new-folder/rename/move/delete UI in shared context
7. User can hide a shared item from their view
8. Breadcrumbs show ~/shared > folderName > subfolderName
   </success_criteria>

<output>
After completion, create `.planning/phases/14-user-to-user-sharing/14-05-SUMMARY.md`
</output>
