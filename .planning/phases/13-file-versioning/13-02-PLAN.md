---
phase: 13-file-versioning
plan: 02
type: execute
wave: 2
depends_on: ['13-01']
files_modified:
  - apps/web/src/services/file-metadata.service.ts
  - apps/web/src/hooks/useFolder.ts
autonomous: true

must_haves:
  truths:
    - 'When a file is updated via web re-upload, current metadata is pushed to versions array before overwriting'
    - 'Old CID is NOT unpinned on file content update (stays pinned as version)'
    - 'When versions exceed 10, the oldest version is pruned and its CID is unpinned'
    - 'Text editor saves use 15-minute cooldown -- intermediate saves overwrite current without creating a version'
    - 'Web re-upload always creates a version (no cooldown)'
  artifacts:
    - path: 'apps/web/src/services/file-metadata.service.ts'
      provides: 'updateFileMetadata with version push, prune, and cooldown logic'
      contains: 'versions'
    - path: 'apps/web/src/hooks/useFolder.ts'
      provides: 'handleUpdateFile stops unpinning old CID, passes createVersion flag'
      contains: 'createVersion'
  key_links:
    - from: 'apps/web/src/hooks/useFolder.ts'
      to: 'apps/web/src/services/file-metadata.service.ts'
      via: 'updateFileMetadata call with version params'
      pattern: 'updateFileMetadata'
    - from: 'apps/web/src/services/file-metadata.service.ts'
      to: 'packages/crypto/src/file/types.ts'
      via: 'VersionEntry import'
      pattern: 'VersionEntry'
---

<objective>
Implement the core versioning logic in the web service layer: push current metadata to versions array on content update, enforce max 10 versions with auto-pruning, add 15-minute cooldown for text editor saves, and stop unpinning old CIDs.

Purpose: This is the engine that makes versioning work. Every file content update flows through `updateFileMetadata` and `handleUpdateFile` -- modifying these two functions implements VER-01 (automatic retention), VER-04 (retention policy), and the cooldown behavior from CONTEXT.md.

Output: Updated file-metadata.service.ts with versioning logic, updated useFolder.ts handleUpdateFile that preserves old CIDs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-file-versioning/13-CONTEXT.md
@.planning/phases/13-file-versioning/13-01-SUMMARY.md
@apps/web/src/services/file-metadata.service.ts
@apps/web/src/hooks/useFolder.ts
@apps/web/src/services/delete.service.ts
@apps/web/src/components/file-browser/TextEditorDialog.tsx
@packages/crypto/src/file/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add versioning logic to updateFileMetadata service</name>
  <files>
    apps/web/src/services/file-metadata.service.ts
  </files>
  <action>
    In `apps/web/src/services/file-metadata.service.ts`:

    1. Import `VersionEntry` from `@cipherbox/crypto` alongside the existing imports.

    2. Add a constant at the top: `const MAX_VERSIONS_PER_FILE = 10;`

    3. Add a constant: `const VERSION_COOLDOWN_MS = 15 * 60 * 1000; // 15 minutes`

    4. Modify the `updateFileMetadata` function signature to accept additional parameters:
       - `createVersion: boolean` -- whether to push current into versions (true for web re-upload, conditional for text editor)
       - The function already receives `currentMetadata` which has the current state

    5. Inside `updateFileMetadata`, before merging updates:
       - If `createVersion` is true:
         a. Build a `VersionEntry` from `params.currentMetadata`:
            ```typescript
            const versionEntry: VersionEntry = {
              cid: params.currentMetadata.cid,
              fileKeyEncrypted: params.currentMetadata.fileKeyEncrypted,
              fileIv: params.currentMetadata.fileIv,
              size: params.currentMetadata.size,
              timestamp: Date.now(),
              encryptionMode: params.currentMetadata.encryptionMode ?? 'GCM',
            };
            ```
         b. Prepend to existing versions (newest first): `const versions = [versionEntry, ...(params.currentMetadata.versions ?? [])];`
         c. Prune if exceeds MAX_VERSIONS_PER_FILE: `const prunedVersions = versions.slice(0, MAX_VERSIONS_PER_FILE);`
         d. Collect CIDs of pruned versions for unpinning: `const prunedCids = versions.slice(MAX_VERSIONS_PER_FILE).map(v => v.cid);`
         e. Include `versions: prunedVersions` in the updated metadata
       - If `createVersion` is false:
         a. Preserve existing versions as-is: `versions: params.currentMetadata.versions`

    6. Update the return type to include `prunedCids: string[]` so the caller can unpin pruned versions.

    7. Add a helper function `shouldCreateVersion(currentMetadata: FileMetadata, forceVersion: boolean): boolean`:
       - If `forceVersion` is true, return true (web re-upload always versions)
       - Otherwise, check `currentMetadata.versions?.[0]?.timestamp` -- if the newest version is less than `VERSION_COOLDOWN_MS` old, return false (cooldown active)
       - If no versions exist, return true (first version always created)
       - If newest version is older than cooldown, return true
       - Export this function so the hook can use it

    The updated metadata object should include the versions field:
    ```typescript
    const updatedMetadata: FileMetadata = {
      ...params.currentMetadata,
      ...params.updates,
      versions: createVersion ? prunedVersions : (params.currentMetadata.versions ?? undefined),
      modifiedAt: Date.now(),
    };
    ```

    If versions is empty array or undefined, do NOT include it (keep backward compat -- only add versions field when there are actual versions).

  </action>
  <verify>
    Run `cd /Users/michael/Code/cipher-box && pnpm --filter web build` -- should compile without errors.
    Verify the function signature change doesn't break callers by checking that all call sites pass the new parameter.
  </verify>
  <done>
    updateFileMetadata pushes current to versions when createVersion=true, enforces max 10, returns prunedCids. shouldCreateVersion helper implements cooldown logic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update useFolder handleUpdateFile to stop unpinning and use versioning</name>
  <files>
    apps/web/src/hooks/useFolder.ts
    apps/web/src/components/file-browser/TextEditorDialog.tsx
  </files>
  <action>
    In `apps/web/src/hooks/useFolder.ts`:

    1. Import `shouldCreateVersion` from `../services/file-metadata.service`.

    2. Modify `handleUpdateFile` to accept a new optional parameter `forceVersion?: boolean` (defaults to false). Add it to the function parameter object:
       ```typescript
       fileData: {
         fileId: string;
         newCid: string;
         newFileKeyEncrypted: string;
         newFileIv: string;
         newSize: number;
         forceVersion?: boolean;  // true for web re-upload, false/undefined for text editor
       }
       ```

    3. After resolving current metadata (step 2), determine if we should create a version:
       ```typescript
       const createVersion = shouldCreateVersion(
         currentMetadata,
         fileData.forceVersion ?? false
       );
       ```

    4. Pass `createVersion` to `updateFileMetadata` call.

    5. **CRITICAL CHANGE**: Remove the old CID unpinning on line 843 (`unpinFromIpfs(oldCid).catch(() => {});`). This is the core VER-01 mechanism -- old CIDs stay pinned as version history.

    6. Instead, only unpin CIDs of PRUNED versions (excess beyond max 10):
       ```typescript
       const { ipnsRecord, prunedCids } = await updateFileMetadata({...});
       // Only unpin pruned versions (excess beyond max 10)
       for (const prunedCid of prunedCids) {
         unpinFromIpfs(prunedCid).catch(() => {});
       }
       ```

    7. Keep the quota refresh (`useQuotaStore.getState().fetchQuota()`) -- quota is server-side and includes all pinned content.

    In `apps/web/src/components/file-browser/TextEditorDialog.tsx`:

    8. Find the `updateFile` call (around line 136) and ensure it does NOT pass `forceVersion: true`. The text editor save should use the default (false), which triggers cooldown logic. The call should look like:
       ```typescript
       await updateFile(parentFolderId, {
         fileId: item.id,
         newCid: ...,
         newFileKeyEncrypted: ...,
         newFileIv: ...,
         newSize: ...,
         // forceVersion not set -- cooldown applies
       });
       ```
       This should already work since forceVersion defaults to false/undefined. Just verify the call site exists and doesn't need changes.

    For web re-upload via `useDropUpload`, the flow goes through `handleAddFile`/`handleAddFiles` for NEW files, not `handleUpdateFile`. The duplicate name check in `useDropUpload` currently rejects files with existing names. Re-upload (replacing existing file) is triggered from the FileBrowser UI which calls `handleUpdateFile` -- verify this is where `forceVersion: true` should be passed. If re-upload is triggered from a different code path, trace it and add `forceVersion: true` there.

    Check `useDropUpload.ts` -- it currently rejects duplicate names. The re-upload flow may be via a separate "replace" action in the context menu or FileBrowser. Search for where `handleUpdateFile` is called from components to find the web re-upload entry point and ensure it passes `forceVersion: true`.

  </action>
  <verify>
    Run `cd /Users/michael/Code/cipher-box && pnpm --filter web build` -- should compile without errors.
    Run `cd /Users/michael/Code/cipher-box && pnpm --filter web lint` -- no new lint errors.
    Grep for `unpinFromIpfs(oldCid)` in useFolder.ts -- should NOT exist (removed).
    Grep for `prunedCids` in useFolder.ts -- should exist (pruned version cleanup).
  </verify>
  <done>
    handleUpdateFile no longer unpins old CIDs (VER-01). Versioning logic creates version entries on content update. Cooldown applies to text editor saves. Pruned versions (>10) are unpinned. Web re-upload always creates version.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter web build` succeeds
- `pnpm --filter web lint` passes
- Old CID unpinning removed from handleUpdateFile
- updateFileMetadata accepts createVersion parameter
- shouldCreateVersion implements 15-minute cooldown
- Pruned version CIDs are unpinned
- Text editor save path does NOT force version (cooldown applies)
</verification>

<success_criteria>

- File content update preserves old CID (not unpinned) -- VER-01
- Current metadata pushed to versions array with full crypto context
- Max 10 versions enforced, oldest pruned automatically -- VER-04
- 15-minute cooldown for text editor saves (per CONTEXT.md)
- Web re-upload always creates version (per CONTEXT.md)
- Pruned version CIDs are unpinned to free storage
  </success_criteria>

<output>
After completion, create `.planning/phases/13-file-versioning/13-02-SUMMARY.md`
</output>
