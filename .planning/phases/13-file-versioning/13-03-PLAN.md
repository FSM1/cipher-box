---
phase: 13-file-versioning
plan: 03
type: execute
wave: 2
depends_on: ['13-01']
files_modified:
  - apps/desktop/src-tauri/src/fuse/operations.rs
  - apps/desktop/src-tauri/src/fuse/mod.rs
autonomous: true

must_haves:
  truths:
    - 'Desktop FUSE file update (release) does NOT unpin old file CID'
    - 'Desktop FUSE file update pushes current metadata to versions array in FileMetadata'
    - 'Desktop FUSE writes use 15-minute cooldown -- only creates new version if last version is older than 15 minutes'
    - 'Desktop FUSE enforces max 10 versions, pruning oldest and unpinning their CIDs'
  artifacts:
    - path: 'apps/desktop/src-tauri/src/fuse/operations.rs'
      provides: 'release() with version creation and cooldown logic'
      contains: 'VERSION_COOLDOWN'
    - path: 'apps/desktop/src-tauri/src/fuse/mod.rs'
      provides: 'drain_upload_completions stops unpinning old file CIDs (only prunes excess versions)'
      contains: 'pruned'
  key_links:
    - from: 'apps/desktop/src-tauri/src/fuse/operations.rs'
      to: 'apps/desktop/src-tauri/src/crypto/folder.rs'
      via: 'VersionEntry struct usage in release()'
      pattern: 'VersionEntry'
    - from: 'apps/desktop/src-tauri/src/fuse/mod.rs'
      to: 'apps/desktop/src-tauri/src/fuse/operations.rs'
      via: 'UploadComplete carries pruned CIDs'
      pattern: 'pruned_cids'
---

<objective>
Update the desktop FUSE file update path to create version entries and stop unpinning old CIDs, with a 15-minute cooldown for rapid saves.

Purpose: The desktop FUSE mount is a major content update path (users save files via native apps). Without this change, desktop file saves would overwrite current metadata without preserving versions, breaking VER-01 for the desktop workflow.

Output: Desktop release() creates versions with cooldown, drain_upload_completions preserves old CIDs, prunes excess versions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-file-versioning/13-CONTEXT.md
@.planning/phases/13-file-versioning/13-01-SUMMARY.md
@apps/desktop/src-tauri/src/fuse/operations.rs
@apps/desktop/src-tauri/src/fuse/mod.rs
@apps/desktop/src-tauri/src/crypto/folder.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add versioning to FUSE release() with 15-minute cooldown</name>
  <files>
    apps/desktop/src-tauri/src/fuse/operations.rs
    apps/desktop/src-tauri/src/fuse/mod.rs
  </files>
  <action>
    **Constants:**

    Add at the top of `operations.rs` (or in `mod.rs` if shared):
    ```rust
    const MAX_VERSIONS_PER_FILE: usize = 10;
    const VERSION_COOLDOWN_MS: u64 = 15 * 60 * 1000; // 15 minutes
    ```

    **In release() (operations.rs, around line 1539-1554):**

    Currently the code builds a `FileMetadata` with `versions: None` for every file update. This needs to change:

    1. Before building the new `FileMetadata`, the code needs to know the CURRENT file's metadata including existing versions. The current metadata is not available in release() because it's a FUSE callback (can't do network I/O).

    Since release() can't do async IPNS resolution, the versioning logic must happen in the background thread (the `std::thread::spawn` block that does the upload). Modify the approach:

    a. In the synchronous part of release(), capture the old file metadata needed for versioning: old CID, old encrypted key, old IV, old size, and old encryption_mode from the inode. Also capture the existing `versions` if available.

    b. The current inode `InodeKind::File` does NOT store versions or the full metadata. We need to add a way to carry version info. The simplest approach: add an optional `versions` field to `InodeKind::File`:
       ```rust
       InodeKind::File {
           cid: String,
           encrypted_file_key: String,
           iv: String,
           size: u64,
           encryption_mode: String,
           file_meta_ipns_name: Option<String>,
           file_meta_resolved: bool,
           file_ipns_private_key: Option<Zeroizing<Vec<u8>>>,
           versions: Option<Vec<crate::crypto::folder::VersionEntry>>,  // NEW
       }
       ```

    c. In the `populate_folder` function (inode.rs), when creating File inodes from resolved FileMetadata, populate the `versions` field from the metadata.

    d. In release(), extract the existing versions from the inode before updating:
       ```rust
       let (old_cid, old_key, old_iv, old_size, old_mode, existing_versions, ...) =
           self.inodes.get(ino).map(|inode| {
               match &inode.kind {
                   InodeKind::File { cid, encrypted_file_key, iv, size, encryption_mode, versions, .. } =>
                       (Some(cid.clone()), encrypted_file_key.clone(), iv.clone(), *size, encryption_mode.clone(), versions.clone()),
                   _ => (None, String::new(), String::new(), 0, "GCM".to_string(), None),
               }
           }).unwrap_or_default();
       ```

    e. Determine if we should create a version (cooldown check):
       ```rust
       let now_ms = SystemTime::now().duration_since(UNIX_EPOCH).unwrap_or_default().as_millis() as u64;
       let should_version = if let Some(ref versions) = existing_versions {
           if let Some(newest) = versions.first() {
               now_ms.saturating_sub(newest.timestamp) >= VERSION_COOLDOWN_MS
           } else {
               true // No versions yet, create first
           }
       } else {
           // Only version if old CID exists (not a brand new file)
           old_cid.as_ref().map(|c| !c.is_empty()).unwrap_or(false)
       };
       ```

    f. Build versions array:
       ```rust
       let new_versions = if should_version {
           if let Some(ref old_c) = old_cid {
               if !old_c.is_empty() {
                   let version_entry = crate::crypto::folder::VersionEntry {
                       cid: old_c.clone(),
                       file_key_encrypted: old_key.clone(),
                       file_iv: old_iv.clone(),
                       size: old_size,
                       timestamp: now_ms,
                       encryption_mode: old_mode.clone(),
                   };
                   let mut versions = vec![version_entry];
                   versions.extend(existing_versions.unwrap_or_default());
                   // Prune to MAX_VERSIONS_PER_FILE
                   let pruned_cids: Vec<String> = if versions.len() > MAX_VERSIONS_PER_FILE {
                       versions.split_off(MAX_VERSIONS_PER_FILE).into_iter().map(|v| v.cid).collect()
                   } else {
                       vec![]
                   };
                   Some((versions, pruned_cids))
               } else { None }
           } else { None }
       } else {
           // Cooldown active: keep existing versions, no new version
           Some((existing_versions.unwrap_or_default(), vec![]))
       };
       ```

    g. Include versions in the `FileMetadata` being built for IPNS publish:
       ```rust
       let file_meta = crate::crypto::folder::FileMetadata {
           version: "v1".to_string(),
           cid: String::new(), // placeholder
           file_key_encrypted: encrypted_file_key_hex.clone(),
           file_iv: iv_hex.clone(),
           size: file_size,
           mime_type,
           encryption_mode: "GCM".to_string(),
           created_at: now_ms,
           modified_at: now_ms,
           versions: new_versions.as_ref().map(|(v, _)| v.clone()).filter(|v| !v.is_empty()),
       };
       ```

    h. Update the inode's versions after the update:
       ```rust
       if let Some(inode) = self.inodes.get_mut(ino) {
           inode.kind = InodeKind::File {
               // ... existing fields ...
               versions: new_versions.as_ref().map(|(v, _)| v.clone()).filter(|v| !v.is_empty()),
           };
       }
       ```

    **In drain_upload_completions (mod.rs, around line 562):**

    2. Change the old CID handling: instead of unpinning `old_file_cid`, do NOTHING with it (the old CID is now a version). Remove or comment out the unpin block at lines 562-567.

    3. Add pruned CID unpinning: extend `UploadComplete` struct to include `pruned_cids: Vec<String>`. In drain_upload_completions, unpin pruned CIDs:
       ```rust
       for pruned_cid in &result.pruned_cids {
           let api = self.api.clone();
           let cid = pruned_cid.clone();
           self.rt.spawn(async move {
               let _ = crate::api::ipfs::unpin_content(&api, &cid).await;
           });
       }
       ```

    4. Update the `UploadComplete` struct in mod.rs to add `pruned_cids: Vec<String>`.

    5. Update the send site in release() to populate `pruned_cids` from the pruned versions.

    **In inode.rs (populate_folder):**

    6. When populating File inodes from resolved FileMetadata, pass through the `versions` field. Find where `InodeKind::File { ... }` is constructed in populate_folder and add `versions: file_metadata.versions.clone()`.

    NOTE: The `InodeKind::File` variant change (adding `versions`) will require updating ALL match arms that destructure `InodeKind::File` throughout operations.rs and other files. Use `..` rest patterns where versions isn't needed. Search for `InodeKind::File {` to find all locations.

  </action>
  <verify>
    Run `cd /Users/michael/Code/cipher-box/apps/desktop/src-tauri && cargo check --features fuse` -- should compile.
    Run `cd /Users/michael/Code/cipher-box/apps/desktop/src-tauri && cargo test` -- should pass.
    Grep for `unpin_content.*old_file_cid\|unpin_content.*old_cid` in mod.rs -- old CID unpin should be removed.
    Grep for `pruned_cids` in mod.rs -- should exist for pruned version cleanup.
  </verify>
  <done>
    Desktop FUSE release() creates version entries from current metadata before overwriting. 15-minute cooldown prevents rapid versioning. Old CIDs preserved as versions. Excess versions (>10) pruned and unpinned. All match arms updated for new InodeKind::File variant.
  </done>
</task>

</tasks>

<verification>
- `cargo check --features fuse` compiles
- `cargo test` passes
- File update no longer unpins old CID (preserved as version)
- Pruned versions (>10) are unpinned
- 15-minute cooldown prevents rapid version creation
- InodeKind::File includes versions field
- populate_folder carries versions from metadata to inode
</verification>

<success_criteria>

- Desktop file saves create version entries (VER-01 for desktop)
- 15-minute cooldown for FUSE writes (per CONTEXT.md)
- Max 10 versions enforced on desktop (VER-04)
- Old CIDs not unpinned on update (version retention)
- Pruned version CIDs are unpinned
- No compilation errors or test failures
  </success_criteria>

<output>
After completion, create `.planning/phases/13-file-versioning/13-03-SUMMARY.md`
</output>
