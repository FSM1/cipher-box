---
phase: 13-file-versioning
plan: 04
type: execute
wave: 3
depends_on: ['13-02']
files_modified:
  - apps/web/src/components/file-browser/DetailsDialog.tsx
  - apps/web/src/styles/details-dialog.css
  - apps/web/src/services/file-metadata.service.ts
  - apps/web/src/hooks/useFolder.ts
autonomous: true

must_haves:
  truths:
    - 'User can open version history for any file and see past versions with timestamps and sizes'
    - 'User can download a previous version of a file'
    - 'User can restore a previous version with confirmation dialog, which becomes the current version'
    - 'Restore is non-destructive: current becomes past version, restored becomes current'
    - 'User can manually delete a specific past version'
  artifacts:
    - path: 'apps/web/src/components/file-browser/DetailsDialog.tsx'
      provides: 'Version history section in file details with download/restore/delete actions'
      contains: 'VersionHistory'
    - path: 'apps/web/src/services/file-metadata.service.ts'
      provides: 'restoreVersion and deleteVersion functions'
      contains: 'restoreVersion'
    - path: 'apps/web/src/hooks/useFolder.ts'
      provides: 'handleRestoreVersion and handleDeleteVersion operations'
      contains: 'restoreVersion'
  key_links:
    - from: 'apps/web/src/components/file-browser/DetailsDialog.tsx'
      to: 'apps/web/src/hooks/useFolder.ts'
      via: 'restoreVersion and deleteVersion callbacks'
      pattern: 'restoreVersion|deleteVersion'
    - from: 'apps/web/src/hooks/useFolder.ts'
      to: 'apps/web/src/services/file-metadata.service.ts'
      via: 'service function calls for restore/delete'
      pattern: 'restoreVersion|deleteVersion'
    - from: 'apps/web/src/services/file-metadata.service.ts'
      to: 'apps/web/src/services/download.service.ts'
      via: 'downloadFile for version downloads'
      pattern: 'downloadFile'
---

<objective>
Build the version history UI in the file details dialog with download, restore, and delete actions for past versions.

Purpose: Users need to see and interact with their version history (VER-02, VER-03). The DetailsDialog already shows file metadata and is the natural home for version history. Restore creates a new version (non-destructive), and manual delete allows cleanup of unwanted versions.

Output: Version history section in DetailsDialog, restore and delete version service functions, corresponding useFolder operations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-file-versioning/13-CONTEXT.md
@.planning/phases/13-file-versioning/13-02-SUMMARY.md
@apps/web/src/components/file-browser/DetailsDialog.tsx
@apps/web/src/styles/details-dialog.css
@apps/web/src/services/file-metadata.service.ts
@apps/web/src/services/download.service.ts
@apps/web/src/hooks/useFolder.ts
@packages/crypto/src/file/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add restoreVersion and deleteVersion to service layer and useFolder</name>
  <files>
    apps/web/src/services/file-metadata.service.ts
    apps/web/src/hooks/useFolder.ts
  </files>
  <action>
    **In `apps/web/src/services/file-metadata.service.ts`:**

    1. Add a `restoreVersion` function:
       ```typescript
       /**
        * Restore a previous version of a file.
        * The current content becomes a new version entry, and the restored version's
        * data becomes the current content. Non-destructive: version chain grows.
        *
        * @param params.fileId - File identifier (for IPNS keypair derivation)
        * @param params.folderKey - Parent folder's decrypted AES-256 key
        * @param params.userPrivateKey - User's secp256k1 private key
        * @param params.currentMetadata - Current file metadata
        * @param params.versionIndex - Index of version to restore (0 = newest past version)
        * @returns Updated IPNS record payload and any pruned CIDs
        */
       export async function restoreVersion(params: {
         fileId: string;
         folderKey: Uint8Array;
         userPrivateKey: Uint8Array;
         currentMetadata: FileMetadata;
         versionIndex: number;
       }): Promise<{ ipnsRecord: FileIpnsRecordPayload; prunedCids: string[] }>
       ```

       Implementation:
       a. Get the version to restore: `const versionToRestore = params.currentMetadata.versions![params.versionIndex];`
       b. Build a version entry from CURRENT metadata (it becomes a past version):
          ```typescript
          const currentAsVersion: VersionEntry = {
            cid: params.currentMetadata.cid,
            fileKeyEncrypted: params.currentMetadata.fileKeyEncrypted,
            fileIv: params.currentMetadata.fileIv,
            size: params.currentMetadata.size,
            timestamp: Date.now(),
            encryptionMode: params.currentMetadata.encryptionMode ?? 'GCM',
          };
          ```
       c. Build new versions array: remove the restored version from array, prepend currentAsVersion:
          ```typescript
          const remainingVersions = (params.currentMetadata.versions ?? []).filter((_, i) => i !== params.versionIndex);
          const newVersions = [currentAsVersion, ...remainingVersions];
          ```
       d. Prune if exceeds max: `const prunedVersions = newVersions.slice(0, MAX_VERSIONS_PER_FILE);`
       e. Collect pruned CIDs
       f. Build updated metadata with the restored version's data as current:
          ```typescript
          const updatedMetadata: FileMetadata = {
            ...params.currentMetadata,
            cid: versionToRestore.cid,
            fileKeyEncrypted: versionToRestore.fileKeyEncrypted,
            fileIv: versionToRestore.fileIv,
            size: versionToRestore.size,
            encryptionMode: versionToRestore.encryptionMode,
            versions: prunedVersions.length > 0 ? prunedVersions : undefined,
            modifiedAt: Date.now(),
          };
          ```
       g. Re-derive IPNS keypair, resolve current sequence number, encrypt, upload, create new IPNS record (same pattern as updateFileMetadata)
       h. Return the IPNS record and pruned CIDs

    2. Add a `deleteVersion` function:
       ```typescript
       /**
        * Delete a specific past version from a file's version history.
        * Unpins the version's CID and updates the file's IPNS metadata.
        *
        * @param params.fileId - File identifier
        * @param params.folderKey - Parent folder's decrypted AES-256 key
        * @param params.userPrivateKey - User's secp256k1 private key
        * @param params.currentMetadata - Current file metadata
        * @param params.versionIndex - Index of version to delete
        * @returns Updated IPNS record and CID to unpin
        */
       export async function deleteVersion(params: {
         fileId: string;
         folderKey: Uint8Array;
         userPrivateKey: Uint8Array;
         currentMetadata: FileMetadata;
         versionIndex: number;
       }): Promise<{ ipnsRecord: FileIpnsRecordPayload; deletedCid: string }>
       ```

       Implementation:
       a. Get the version CID to delete: `const deletedCid = params.currentMetadata.versions![params.versionIndex].cid;`
       b. Remove the version from array: `const newVersions = params.currentMetadata.versions!.filter((_, i) => i !== params.versionIndex);`
       c. Build updated metadata with filtered versions: `versions: newVersions.length > 0 ? newVersions : undefined`
       d. Encrypt, upload, create IPNS record (same pattern)
       e. Return IPNS record and deletedCid

    **In `apps/web/src/hooks/useFolder.ts`:**

    3. Import `restoreVersion` and `deleteVersion` from `../services/file-metadata.service`.

    4. Add `handleRestoreVersion` operation:
       ```typescript
       const handleRestoreVersion = useCallback(
         async (parentId: string, fileId: string, versionIndex: number): Promise<void> => {
       ```
       - Get parent folder state, find FilePointer, resolve current metadata
       - Call `restoreVersion` service function
       - Publish the IPNS record via `folderService.replaceFileInFolder`
       - Unpin pruned CIDs
       - Update local folder state (modifiedAt on FilePointer)
       - Refresh quota

    5. Add `handleDeleteVersion` operation:
       ```typescript
       const handleDeleteVersion = useCallback(
         async (parentId: string, fileId: string, versionIndex: number): Promise<void> => {
       ```
       - Get parent folder state, find FilePointer, resolve current metadata
       - Call `deleteVersion` service function
       - Publish the IPNS record via `folderService.replaceFileInFolder`
       - Unpin deleted version CID
       - Refresh quota

    6. Add both to the return object of useFolder:
       ```typescript
       return {
         // ... existing operations
         restoreVersion: handleRestoreVersion,
         deleteVersion: handleDeleteVersion,
       };
       ```

  </action>
  <verify>
    Run `cd /Users/michael/Code/cipher-box && pnpm --filter web build` -- should compile without errors.
  </verify>
  <done>
    restoreVersion service function creates new version from current, promotes restored version to current. deleteVersion removes a version and returns CID for unpinning. Both exposed via useFolder hook.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build version history UI in DetailsDialog</name>
  <files>
    apps/web/src/components/file-browser/DetailsDialog.tsx
    apps/web/src/styles/details-dialog.css
  </files>
  <action>
    **In `apps/web/src/components/file-browser/DetailsDialog.tsx`:**

    1. Import additional types and hooks:
       - `VersionEntry` from `@cipherbox/crypto`
       - `useFolder` hook
       - `useAuthStore`
       - `downloadFile` and `triggerBrowserDownload` from download.service
       - `useFolderStore` (already imported)

    2. The DetailsDialog needs to receive additional props for version operations. Update `DetailsDialogProps`:
       ```typescript
       type DetailsDialogProps = {
         open: boolean;
         onClose: () => void;
         item: FolderChild | null;
         folderKey: Uint8Array | null;
         parentFolderId: string;  // NEW: needed for version operations
       };
       ```
       Find where DetailsDialog is rendered in FileBrowser.tsx and pass parentFolderId.

    3. Create a `VersionHistory` component inside the file:
       ```typescript
       function VersionHistory({
         versions,
         fileName,
         folderKey,
         parentFolderId,
         fileId,
         onRestored,
       }: {
         versions: VersionEntry[];
         fileName: string;
         folderKey: Uint8Array;
         parentFolderId: string;
         fileId: string;
         onRestored: () => void;
       })
       ```

       The component renders:
       a. A section header: `{'// version history'}`
       b. A list of version entries, each showing:
          - Version number (counting backward from versions.length: "v1", "v2", etc. -- v1 is oldest)
          - Timestamp formatted with `formatDate(version.timestamp)`
          - Size formatted as human-readable (e.g., "1.2 MB")
          - Encryption mode badge (GCM/CTR)
       c. Each entry has action buttons:
          - **Download** button: Downloads and decrypts this specific version
          - **Restore** button: Opens confirm dialog, then restores this version
          - **Delete** button: Opens confirm dialog, then deletes this version

    4. For the **download** action:
       - Use `downloadFile` from download.service with the version's cid, fileIv, fileKeyEncrypted
       - Get privateKey from `useAuthStore.getState().vaultKeypair?.privateKey`
       - Call `triggerBrowserDownload(decryptedContent, fileName)` -- use same filename (user knows it's a past version from the UI context)

    5. For the **restore** action:
       - Show a confirmation dialog (inline confirm pattern matching the app's terminal aesthetic):
         ```
         "Restore version from [date]? Current version will be saved as a past version."
         [confirm] [cancel]
         ```
       - Use inline state (`confirmingRestore: number | null`) to show confirm/cancel for a specific version index
       - On confirm, call `restoreVersion(parentFolderId, fileId, versionIndex)` from useFolder
       - On success, call `onRestored()` to refresh the metadata and close/re-open the panel
       - Show a brief loading state during restore

    6. For the **delete** action:
       - Similar inline confirm: "Delete this version? This cannot be undone."
       - On confirm, call `deleteVersion(parentFolderId, fileId, versionIndex)` from useFolder
       - On success, refresh the metadata

    7. Add `VersionHistory` to the `FileDetails` component:
       - After the existing sections (timestamps), add a version history section
       - Only render if `fileMeta?.versions` exists and has length > 0
       - Pass the required props

    8. Pass `parentFolderId` prop through DetailsDialog -> FileDetails -> VersionHistory.

    **In `apps/web/src/styles/details-dialog.css`:**

    9. Add styles for the version history section:
       - `.details-version-list` -- container for version entries
       - `.details-version-entry` -- individual version row with terminal aesthetic (dark border, monospace)
       - `.details-version-info` -- version metadata (number, date, size)
       - `.details-version-actions` -- action buttons container (flex, gap)
       - `.details-version-btn` -- small action button matching existing `.details-copy-btn` style
       - `.details-version-btn--restore` -- green accent for restore
       - `.details-version-btn--delete` -- red/dim accent for delete
       - `.details-version-confirm` -- inline confirmation message
       - `.details-version-confirm-btn` -- confirm/cancel buttons
       - Use the existing app color scheme (green terminal aesthetic from other CSS)
       - Keep the list scrollable if many versions (max-height with overflow-y)

    **In FileBrowser.tsx:**

    10. Find where `DetailsDialog` is rendered and add the `parentFolderId` prop. The parent folder ID is the current folder being viewed.

    **Accessibility:**

    11. All interactive elements (download, restore, delete buttons) must have:
        - Appropriate `aria-label` attributes
        - `type="button"` attribute
        - Keyboard support (buttons are natively keyboard-accessible)
    12. The confirmation dialogs should use `role="alert"` or similar for screen readers

  </action>
  <verify>
    Run `cd /Users/michael/Code/cipher-box && pnpm --filter web build` -- should compile without errors.
    Run `cd /Users/michael/Code/cipher-box && pnpm --filter web lint` -- no new lint errors.
    Verify DetailsDialog renders without errors when item has no versions (backward compat).
    Verify DetailsDialog shows version history section when item has versions.
  </verify>
  <done>
    Version history section visible in file details for files with versions. Each version shows date, size, mode. Download downloads and decrypts the specific version. Restore creates new version from current with confirmation. Delete removes version with confirmation. All actions accessible via keyboard.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter web build` succeeds
- `pnpm --filter web lint` passes
- DetailsDialog renders correctly for files without versions (backward compat)
- Version history section appears for files with versions
- Download, restore, and delete buttons are present and accessible
- Confirmation dialogs appear for restore and delete
- Restore creates new version from current (non-destructive)
- FileBrowser passes parentFolderId to DetailsDialog
</verification>

<success_criteria>

- User can see version history for any file (VER-02)
- User can download a previous version
- User can restore a previous version with confirmation (VER-03)
- Restore is non-destructive: current becomes past, restored becomes current
- User can manually delete a specific version (CONTEXT.md decision)
- Version history section only shows for files that have versions
- Accessible: keyboard navigable, proper ARIA attributes
  </success_criteria>

<output>
After completion, create `.planning/phases/13-file-versioning/13-04-SUMMARY.md`
</output>
