---
phase: 13-file-versioning
plan: 05
type: execute
wave: 3
depends_on: ['13-01']
files_modified:
  - apps/web/public/recovery.html
autonomous: true

must_haves:
  truths:
    - 'Recovery tool handles FileMetadata with versions array'
    - 'Recovery tool lists and allows download of past versions'
    - 'Recovery tool does not crash on metadata without versions (backward compat)'
  artifacts:
    - path: 'apps/web/public/recovery.html'
      provides: 'Version-aware file recovery with past version access'
      contains: 'versions'
  key_links:
    - from: 'apps/web/public/recovery.html'
      to: 'packages/crypto/src/file/types.ts'
      via: 'FileMetadata schema with versions field'
      pattern: 'versions'
---

<objective>
Update the recovery tool (recovery.html) to handle FileMetadata with version history, and run a full cross-platform build verification.

Purpose: The recovery tool is a standalone HTML file for emergency vault recovery. It must understand versioned FileMetadata to allow users to recover not just the current version but also past versions of their files. Build verification ensures all changes across the phase compile correctly together.

Output: Updated recovery.html with version support, all builds passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-file-versioning/13-CONTEXT.md
@.planning/phases/13-file-versioning/13-01-SUMMARY.md
@apps/web/public/recovery.html
@packages/crypto/src/file/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update recovery tool to handle versioned FileMetadata</name>
  <files>
    apps/web/public/recovery.html
  </files>
  <action>
    Read `apps/web/public/recovery.html` to understand its current structure for handling FileMetadata.

    The recovery tool already resolves per-file IPNS records and decrypts FileMetadata. It needs to:

    1. **Parse versions**: When decrypting a FileMetadata object, check for the optional `versions` array. The existing parsing code handles the known fields (cid, fileKeyEncrypted, fileIv, size, mimeType, etc.) -- add versions handling.

    2. **Display versions in the UI**: After displaying the current file entry, if `metadata.versions` exists and has entries, show an expandable section or sub-list:
       - Label: "Past Versions (N)"
       - Each version entry shows: date (formatted from timestamp), size, encryption mode
       - Each version has a download button

    3. **Download past versions**: Reuse the existing download+decrypt logic but with the version's cid, fileKeyEncrypted, fileIv, and encryptionMode. The download button for each version should:
       - Fetch the version's CID from IPFS
       - Unwrap the version's fileKeyEncrypted with the user's private key
       - Decrypt using the version's fileIv and the determined encryption mode (GCM or CTR)
       - Trigger browser download with the file name (same name, the version context is clear from the UI)

    4. **Backward compatibility**: If `metadata.versions` is undefined/null/empty, just skip the versions section (no error). This handles pre-Phase 13 metadata gracefully.

    5. **Error handling**: If a specific version download fails, show an error for that version without affecting other versions or the current file. Use the existing error display pattern in the recovery tool.

    6. Keep the recovery tool fully self-contained (no external JS dependencies) -- inline all version-related logic.

  </action>
  <verify>
    Open `apps/web/public/recovery.html` in browser -- should load without JS errors.
    Verify the HTML is valid and self-contained.
  </verify>
  <done>
    Recovery tool displays version history for files that have versions. Each version is downloadable. Pre-Phase 13 metadata (no versions) renders without error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Full cross-platform build verification</name>
  <files></files>
  <action>
    Run the complete build verification suite to confirm all Phase 13 changes compile and test correctly across all platforms:

    1. TypeScript crypto package:
       ```bash
       cd /Users/michael/Code/cipher-box
       pnpm --filter @cipherbox/crypto build
       pnpm --filter @cipherbox/crypto test
       ```

    2. Web app:
       ```bash
       pnpm --filter web build
       pnpm --filter web lint
       ```

    3. Desktop (Rust):
       ```bash
       cd apps/desktop/src-tauri
       cargo check --features fuse
       cargo test
       ```

    4. Full monorepo typecheck:
       ```bash
       cd /Users/michael/Code/cipher-box
       pnpm typecheck
       ```
       (If this command exists. Otherwise run tsc in each relevant workspace.)

    5. Run the full test suite:
       ```bash
       pnpm test
       ```

    If any step fails, fix the issue before marking complete.

  </action>
  <verify>
    All 5 verification steps pass without errors.
  </verify>
  <done>
    All builds pass: crypto build+test, web build+lint, desktop check+test. No regressions introduced by Phase 13 changes.
  </done>
</task>

</tasks>

<verification>
- Recovery tool loads without errors
- Recovery tool handles metadata with and without versions
- Past versions are downloadable from recovery tool
- pnpm --filter @cipherbox/crypto build + test passes
- pnpm --filter web build + lint passes
- cargo check --features fuse + cargo test passes
- Full test suite passes
</verification>

<success_criteria>

- Recovery tool updated for versioned metadata (recovery path for versioned files)
- All cross-platform builds pass
- No regressions from Phase 13 changes
- Recovery tool backward-compatible with pre-Phase 13 metadata
  </success_criteria>

<output>
After completion, create `.planning/phases/13-file-versioning/13-05-SUMMARY.md`
</output>
