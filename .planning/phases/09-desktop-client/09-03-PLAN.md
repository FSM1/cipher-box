---
phase: 09-desktop-client
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/auth/auth.controller.ts
  - apps/api/src/auth/dto/login.dto.ts
  - apps/api/src/auth/dto/token.dto.ts
  - apps/api/src/auth/auth.controller.spec.ts
autonomous: true

must_haves:
  truths:
    - "Desktop clients can authenticate using body-based refresh tokens instead of cookies"
    - "Existing web app cookie-based auth flow continues to work unchanged"
    - "Desktop refresh endpoint accepts refreshToken in request body when X-Client-Type: desktop header is present"
    - "Login endpoint returns refreshToken in response body when X-Client-Type: desktop header is present"
  artifacts:
    - path: "apps/api/src/auth/auth.controller.ts"
      provides: "Modified login and refresh endpoints supporting desktop client header"
      contains: "X-Client-Type"
    - path: "apps/api/src/auth/dto/token.dto.ts"
      provides: "DesktopRefreshDto with refreshToken body field"
  key_links:
    - from: "apps/api/src/auth/auth.controller.ts"
      to: "apps/api/src/auth/auth.service.ts"
      via: "refreshByToken called for both cookie and body-based tokens"
      pattern: "refreshByToken"
---

<objective>
Modify the backend auth endpoints to support desktop clients that cannot use HTTP-only cookies. When a `X-Client-Type: desktop` header is present, the login and refresh endpoints return/accept the refresh token in the response/request body instead of cookies.

Purpose: Tauri apps run on `tauri://localhost` which doesn't reliably support HTTP-only cookies. The desktop app stores the refresh token in macOS Keychain and sends it in the request body. This is a small, surgical API change that does not affect the existing web app flow.

Output: Modified auth controller and DTOs. Existing tests updated.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-desktop-client/09-RESEARCH.md
@apps/api/src/auth/auth.controller.ts
@apps/api/src/auth/auth.service.ts
@apps/api/src/auth/dto/login.dto.ts
@apps/api/src/auth/dto/token.dto.ts
@apps/api/src/auth/auth.controller.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add desktop client support to auth endpoints</name>
  <files>
    apps/api/src/auth/auth.controller.ts
    apps/api/src/auth/dto/login.dto.ts
    apps/api/src/auth/dto/token.dto.ts
  </files>
  <action>
    Modify the auth controller to detect the `X-Client-Type: desktop` header and adjust token delivery accordingly. The underlying AuthService.login() and AuthService.refreshByToken() already return the refresh token -- we just need to change WHERE it goes (cookie vs body).

    **auth.controller.ts changes:**

    1. In the `login()` method:
       - Read header: `const isDesktop = req.headers['x-client-type'] === 'desktop';`
       - If desktop: Return `{ accessToken, refreshToken, isNewUser }` in response body (include refreshToken). Do NOT set cookie.
       - If web (default): Set cookie as before, return `{ accessToken, isNewUser }` without refreshToken.
       - Add `@Req() req: ExpressRequest` parameter (already has `@Res()` for cookie setting).

    2. In the `refresh()` method:
       - Read header: `const isDesktop = req.headers['x-client-type'] === 'desktop';`
       - If desktop: Read refreshToken from request body (`req.body.refreshToken`). Return new tokens as `{ accessToken, refreshToken }` in body. Do NOT set cookie.
       - If web (default): Read refreshToken from cookie as before. Set new cookie. Return `{ accessToken }` without refreshToken.
       - Accept optional `@Body() body: DesktopRefreshDto` parameter.

    3. In the `logout()` method:
       - If desktop: Do not attempt to clear cookie (no-op since cookie was never set).
       - If web: Clear cookie as before.

    **dto/token.dto.ts changes:**
    - Create `DesktopRefreshDto` class with optional `refreshToken: string` field (validated with `@IsOptional()`, `@IsString()`).
    - Update `LoginResponseDto` to include optional `refreshToken?: string` field with `@ApiPropertyOptional()`.
    - Update `TokenResponseDto` to include optional `refreshToken?: string` field with `@ApiPropertyOptional()`.

    **dto/login.dto.ts changes:**
    - No changes needed -- LoginDto already has the idToken field.

    IMPORTANT: Do NOT change the AuthService. The service already returns refreshToken -- we're only changing the controller's token delivery mechanism. Do NOT change the refresh token rotation logic.

    After modifying the API, regenerate the API client: `pnpm api:generate` from the monorepo root. This ensures the web app's typed client stays in sync. Commit the regenerated client files.
  </action>
  <verify>
    Run `pnpm --filter @cipherbox/api test` -- existing auth tests still pass.
    Run `pnpm api:generate` -- OpenAPI spec regenerates without errors.
    Manually verify the logic:
    - Without X-Client-Type header: login returns { accessToken, isNewUser } + Set-Cookie (unchanged behavior)
    - With X-Client-Type: desktop header: login returns { accessToken, refreshToken, isNewUser } without Set-Cookie
    - Without header: refresh reads cookie (unchanged)
    - With desktop header: refresh reads body.refreshToken, returns { accessToken, refreshToken }
  </verify>
  <done>
    Auth controller supports both cookie-based (web) and body-based (desktop) token delivery. Existing tests pass. API client regenerated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update auth controller tests for desktop client flow</name>
  <files>
    apps/api/src/auth/auth.controller.spec.ts
  </files>
  <action>
    Add test cases for the desktop client auth flow. The existing test file already has tests for web-based cookie auth. Add parallel tests for desktop:

    1. **Login with desktop header**: Mock request with `X-Client-Type: desktop` header. Assert response body includes `refreshToken`. Assert `res.cookie` was NOT called.

    2. **Login without desktop header (regression)**: Verify existing behavior unchanged -- response body does NOT include `refreshToken`, `res.cookie` WAS called with refresh_token.

    3. **Refresh with desktop header**: Mock request with `X-Client-Type: desktop` header and `{ refreshToken: "..." }` in body. Assert response includes new `refreshToken` in body. Assert cookie NOT set.

    4. **Refresh without desktop header (regression)**: Verify existing cookie-based refresh still works.

    5. **Logout with desktop header**: Verify `clearCookie` is NOT called.

    Follow the existing test patterns and mocking approach in the spec file. Use `jest.fn()` for res.cookie and res.clearCookie mocks.
  </action>
  <verify>
    Run `pnpm --filter @cipherbox/api test -- --testPathPattern=auth.controller` -- all tests pass including new desktop tests.
  </verify>
  <done>
    Auth controller has test coverage for both web cookie flow and desktop body-based token flow. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @cipherbox/api test` passes all tests
- API client regenerated (`pnpm api:generate` succeeds)
- Desktop header detection works for login, refresh, and logout
- Web app flow unchanged (no regression)
</verification>

<success_criteria>
Auth endpoints support X-Client-Type: desktop header for body-based refresh tokens. All existing tests pass. New desktop-specific tests added. API client regenerated.
</success_criteria>

<output>
After completion, create `.planning/phases/09-desktop-client/09-03-SUMMARY.md`
</output>
