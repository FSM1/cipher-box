# Security Review Report

**Date:** 2026-02-13
**Scope:** PR #123 - Phase 12: Core Kit Identity Provider Foundation
**Reviewer:** Claude (security:review command, 3 parallel agents)
**PR:** Replace PnP Modal SDK with MPC Core Kit, CipherBox as identity provider

## Executive Summary

PR #123 introduces a major authentication overhaul: CipherBox becomes its own identity provider with Google OAuth and email OTP, replacing the Web3Auth PnP Modal SDK with MPC Core Kit. The architecture is fundamentally sound, but the review identified **critical credential exposure** (committed `.env` files with real secrets), **missing audience validation** on Google OAuth, and several defense-in-depth gaps around the test-login endpoint.

**Risk Level:** CRITICAL (due to committed secrets)

## Files Reviewed

| File | Crypto Operations | Risk Level |
|------|-------------------|------------|
| `apps/api/src/auth/services/jwt-issuer.service.ts` | RS256 JWT signing, JWKS | MEDIUM |
| `apps/api/src/auth/services/google-oauth.service.ts` | Google JWKS verification | CRITICAL |
| `apps/api/src/auth/services/email-otp.service.ts` | OTP generation, Argon2 hashing | MEDIUM |
| `apps/api/src/auth/controllers/identity.controller.ts` | Token issuance orchestration | HIGH |
| `apps/api/src/auth/auth.service.ts` | Test-login keypair derivation | HIGH |
| `apps/api/src/auth/auth.controller.ts` | Token endpoint, test-login | HIGH |
| `apps/api/.env` | Contains real secrets | CRITICAL |
| `apps/web/src/lib/web3auth/core-kit.ts` | Core Kit initialization | LOW |
| `apps/web/src/lib/web3auth/hooks.ts` | TSS key export, migration | HIGH |
| `apps/web/src/hooks/useAuth.ts` | Key derivation, auth flow | MEDIUM |
| `apps/web/src/stores/auth.store.ts` | Token storage (memory-only) | LOW |
| `tests/e2e/.env` | Contains test secrets | CRITICAL |
| `tests/e2e/utils/web3auth-helpers.ts` | Test auth bypass | MEDIUM |
| `cipherbox-test.txt` | Stray test artifact | LOW |

## Findings

### Critical Issues

#### C-01: `.env` Files with Real Secrets Committed to Git
- **Severity:** CRITICAL
- **Location:** `apps/api/.env` and `tests/e2e/.env` (tracked in git)
- **Description:** Both `.env` files are committed to the repository. The root `.gitignore` only matches `.env` at root level, not `**/.env` recursively. The API `.env` contains:
  - `JWT_SECRET` (Base64 256-bit key) -- can forge any access/refresh token
  - `PINATA_JWT` -- real Pinata API key tied to `myankelev@gmail.com` with scoped key secret `dc0fe4...17b8`
  - `TEST_LOGIN_SECRET=e2e-test-secret-do-not-use-in-production`
  - Database credentials
- **Impact:** Anyone with repo read access can forge JWTs, manipulate IPFS pinning, and authenticate as any user via test-login. Secrets persist in git history permanently.
- **Recommendation:**
  1. `git rm --cached apps/api/.env tests/e2e/.env`
  2. Change `.gitignore`: replace `.env` with `**/.env`
  3. **Rotate immediately:** JWT_SECRET, PINATA_JWT (regenerate in Pinata dashboard)
  4. Run `gitleaks` or `truffleHog` to audit git history for other secrets
  5. Use GitHub Secrets for CI/CD

#### C-02: Google OAuth Audience Validation Conditionally Skipped
- **Severity:** CRITICAL
- **Location:** `apps/api/src/auth/services/google-oauth.service.ts:46-48`
- **Description:** When `GOOGLE_CLIENT_ID` is not set (defaults to empty string), the `audience` claim is NOT validated on Google JWTs. The `.env.example` does not include `GOOGLE_CLIENT_ID`, so this will be unset by default in all environments.
- **Impact:** Any valid Google ID token from ANY application can authenticate as that email in CipherBox. Complete authentication bypass for Google OAuth flow.
- **Recommendation:** Add production guard that throws if `GOOGLE_CLIENT_ID` is unset, add it to `.env.example`.

### High Priority

#### H-01: Test-Login Secret Not Timing-Safe
- **Severity:** HIGH
- **Location:** `apps/api/src/auth/auth.service.ts:376`
- **Description:** `if (secret !== expectedSecret)` uses JavaScript `!==` which is vulnerable to timing side-channel attacks. Combined with no rate limiting on this endpoint, the secret can be extracted character-by-character.
- **Recommendation:** Use `crypto.timingSafeEqual()` with Buffer comparison.

#### H-02: Test-Login Endpoint Has No NODE_ENV Guard
- **Severity:** HIGH
- **Location:** `apps/api/src/auth/auth.service.ts:371-378`
- **Description:** The endpoint is gated only by `TEST_LOGIN_SECRET` env var presence. No `NODE_ENV !== 'production'` check. If an operator accidentally sets this in production, it becomes a full auth bypass that also returns private keys.
- **Recommendation:** Add explicit `NODE_ENV === 'production'` rejection as defense-in-depth.

#### H-03: Test-Login Endpoint Has No Rate Limiting
- **Severity:** HIGH
- **Location:** `apps/api/src/auth/auth.controller.ts:210-238`
- **Description:** Unlike the identity endpoints which have `@Throttle` and `@UseGuards(ThrottlerGuard)`, the test-login endpoint has neither. Unlimited brute-force attempts possible.
- **Recommendation:** Add `@UseGuards(ThrottlerGuard)` and `@Throttle({ default: { limit: 3, ttl: 900000 } })`.

#### H-04: Migration Key in localStorage Vulnerable to XSS
- **Severity:** HIGH
- **Location:** `apps/web/src/lib/web3auth/hooks.ts:23-36`
- **Description:** The PnP migration private key sits in `localStorage` under the well-known key `__pnp_migration_key__` between the transitional build and next login. Any XSS during this window can read it. The window could be hours or days.
- **Impact:** Complete vault compromise via any XSS during migration window.
- **Recommendation:** Use `sessionStorage` (same-tab lifetime) or add a TTL check. At minimum, this is an accepted risk for a one-time migration, but document the XSS window.

### Medium Priority

#### M-01: Public Keys and Migration Events Logged to Console
- **Severity:** MEDIUM
- **Location:** `apps/web/src/hooks/useAuth.ts:147`, `apps/web/src/lib/web3auth/hooks.ts:29,72,79,121,127`
- **Description:** Public keys are logged on every successful login. Migration events are logged when migration key is found. No `import.meta.env.DEV` guard.
- **Impact:** User cryptographic identity exposed in browser console; migration timing revealed.
- **Recommendation:** Wrap in `if (import.meta.env.DEV)` or remove entirely.

#### M-02: Email OTP Logged in Non-Production
- **Severity:** MEDIUM
- **Location:** `apps/api/src/auth/services/email-otp.service.ts:78`
- **Description:** `if (process.env.NODE_ENV !== 'production')` logs the OTP to console for development convenience. Staging is not production, so OTPs are logged in staging.
- **Recommendation:** Narrow to `NODE_ENV === 'development'` only, or use a dedicated debug flag.

#### M-03: OTP Rate Limiting Has Gaps
- **Severity:** MEDIUM
- **Location:** `apps/api/src/auth/controllers/identity.controller.ts` and `apps/api/src/auth/services/email-otp.service.ts`
- **Description:** IP-based throttling (5/15min) can be bypassed with IP rotation. Email-based rate limiting covers verification attempts but OTP send endpoint's email-level limit is via Redis which could be reset. 6-digit numeric OTP with 5 attempts and 5-min TTL is acceptable but tight.
- **Recommendation:** Consider adding per-email send rate limiting (e.g., max 3 OTPs per email per 15 min) in addition to IP throttling.

#### M-04: `cipherbox-test.txt` Committed as Stray Test Artifact
- **Severity:** MEDIUM
- **Location:** `cipherbox-test.txt` (repo root)
- **Description:** Test artifact committed to the repository. Not a security vulnerability but indicates sloppy hygiene.
- **Recommendation:** Delete from repo, add to `.gitignore`.

### Low Priority / Recommendations

#### L-01: `_UNSAFE_exportTssKey` Returns Immutable String
- **Severity:** LOW (inherent limitation)
- **Location:** `apps/web/src/lib/web3auth/hooks.ts:148`
- **Description:** The TSS key export returns a hex string which cannot be zeroed in JavaScript (strings are immutable). The `Uint8Array` conversion at line 150 can be zeroed, but the intermediate hex strings persist until GC.
- **Recommendation:** This is an inherent Web3Auth SDK limitation. Ensure the `Uint8Array` is zeroed after use (e.g., `privateKey.fill(0)` on logout). Consider filing upstream to Web3Auth for a Uint8Array-returning API.

#### L-02: `__ZUSTAND_STORES` Exposed on Window in Dev
- **Severity:** LOW
- **Location:** `apps/web/src/main.tsx:16`
- **Description:** Zustand stores (including auth store with access token) exposed on `window.__ZUSTAND_STORES` behind `import.meta.env.DEV` guard.
- **Recommendation:** The DEV guard is correct. No action needed, but be aware this includes the auth store.

## Compliance Checklist

Based on project security rules from CLAUDE.md:

- [x] No privateKey in localStorage/sessionStorage (except migration key -- temporary, documented risk)
- [ ] **No sensitive keys logged** -- VIOLATION: public keys logged on every login, migration events logged
- [x] No unencrypted keys sent to server (except test-login endpoint returns private key -- gated behind secret)
- [x] ECIES used for key wrapping (not modified in this PR)
- [x] AES-256-GCM used for content encryption (not modified in this PR)
- [x] Server has zero knowledge of plaintext (not modified in this PR)
- [x] IPNS keys encrypted with TEE public key (not modified in this PR)

## Positive Observations

1. **JWT Issuer service** has proper production guard -- throws if `IDENTITY_JWT_PRIVATE_KEY` not set in production, generates ephemeral keypair only in dev/staging
2. **Auth store** is memory-only -- no Zustand persist middleware, security comments are explicit
3. **Vault and folder stores** also memory-only with clear security documentation
4. **Email OTP** uses Argon2 hashing for stored OTPs -- proper key stretching
5. **Refresh tokens** stored as httpOnly, sameSite, secure (in production) cookies -- good practice
6. **Token refresh deduplication** uses shared Promise pattern correctly
7. **Logout clears all stores** including crypto keys (vault, folder, sync, auth)
8. **Global ValidationPipe** with whitelist and forbidNonWhitelisted -- proper DTO validation

## Recommendations Summary

| Priority | Recommendation | Effort |
|----------|----------------|--------|
| P0 | Remove `.env` files from git, rotate JWT_SECRET and Pinata JWT | LOW |
| P0 | Fix Google OAuth audience validation -- require `GOOGLE_CLIENT_ID` in production | LOW |
| P0 | Add `timingSafeEqual` for test-login secret comparison | LOW |
| P1 | Add `NODE_ENV` guard + `@Throttle` to test-login endpoint | LOW |
| P1 | Remove/guard console.log of public keys and migration events | LOW |
| P1 | Change `.gitignore` to use `**/.env` recursive pattern | LOW |
| P2 | Delete `cipherbox-test.txt` from repo | LOW |
| P2 | Narrow OTP logging to `NODE_ENV === 'development'` only | LOW |
| P2 | Add per-email send rate limiting for OTP | MEDIUM |
| P3 | Document migration key XSS window as accepted risk | LOW |
| P3 | Zero private key Uint8Array on logout | LOW |

## Next Steps

1. **Immediate:** Rotate all committed secrets (JWT_SECRET, PINATA_JWT), remove `.env` files from git tracking
2. **Before merge:** Fix C-02 (Google OAuth audience), H-01 (timing-safe), H-02 (NODE_ENV guard), H-03 (rate limiting), M-01 (console logging)
3. **Follow-up:** Run `gitleaks` on full git history, consider BFG Repo Cleaner for history scrubbing

---
*Generated by security:review command*
*This review is automated guidance, not a substitute for professional security audit*
