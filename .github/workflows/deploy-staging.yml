name: Deploy Staging

on:
  push:
    tags:
      - 'v*-staging*'

env:
  REGISTRY: ghcr.io

jobs:
  build-api:
    name: Build & Push API Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set lowercase image name
        run: echo "API_IMAGE=ghcr.io/${GITHUB_REPOSITORY_OWNER,,}/cipherbox-api" >> "$GITHUB_ENV"

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/api/Dockerfile
          push: true
          tags: |
            ${{ env.API_IMAGE }}:${{ github.ref_name }}
            ${{ env.API_IMAGE }}:latest

  build-tee:
    name: Build & Push TEE Worker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set lowercase image name
        run: echo "TEE_IMAGE=ghcr.io/${GITHUB_REPOSITORY_OWNER,,}/cipherbox-tee-worker" >> "$GITHUB_ENV"

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/build-push-action@v5
        with:
          context: ./tee-worker
          file: tee-worker/Dockerfile
          push: true
          tags: |
            ${{ env.TEE_IMAGE }}:${{ github.ref_name }}
            ${{ env.TEE_IMAGE }}:latest

  deploy-web:
    name: Build & Deploy Web App to IPFS
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build crypto package
        run: pnpm --filter @cipherbox/crypto build

      - name: Build web app with staging env vars
        run: pnpm --filter @cipherbox/web build
        env:
          VITE_WEB3AUTH_CLIENT_ID: ${{ secrets.VITE_WEB3AUTH_CLIENT_ID }}
          VITE_API_URL: ${{ vars.STAGING_API_URL }}
          VITE_PINATA_GATEWAY_URL: ${{ vars.STAGING_PINATA_GATEWAY_URL }}
          VITE_ENVIRONMENT: staging

      - name: Upload web app to Pinata
        id: pinata
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}
        run: |
          UPLOAD_DIR="apps/web/dist"
          CURL_ARGS=()

          # Build -F args for each file with shared directory prefix
          # Pinata requires a common folder prefix for directory uploads
          while IFS= read -r -d '' filepath; do
            relpath="${filepath#$UPLOAD_DIR/}"
            CURL_ARGS+=(-F "file=@${filepath};filename=site/${relpath}")
          done < <(find "$UPLOAD_DIR" -type f -print0)

          RESPONSE=$(curl -s -X POST "https://api.pinata.cloud/pinning/pinFileToIPFS" \
            -H "Authorization: Bearer ${PINATA_JWT}" \
            "${CURL_ARGS[@]}" \
            -F "pinataMetadata={\"name\":\"cipherbox-web-${{ github.ref_name }}\"}")

          CID=$(echo "$RESPONSE" | jq -r '.IpfsHash')
          if [ -z "$CID" ] || [ "$CID" = "null" ]; then
            echo "Failed to upload to Pinata. Response: $RESPONSE"
            exit 1
          fi

          echo "Uploaded web app to IPFS: $CID"
          echo "cid=$CID" >> "$GITHUB_OUTPUT"

      - name: Update Cloudflare DNSLink
        run: |
          CID="${{ steps.pinata.outputs.cid }}"
          echo "Updating DNSLink to /ipfs/${CID}"

          RESPONSE=$(curl -s -X PUT \
            "https://api.cloudflare.com/client/v4/zones/${{ vars.CLOUDFLARE_ZONE_ID }}/dns_records/${{ vars.CLOUDFLARE_DNSLINK_RECORD_ID }}" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"type":"TXT","name":"_dnslink.app.staging","content":"dnslink=/ipfs/'"${CID}"'","ttl":1}')

          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "Failed to update DNSLink. Response: $RESPONSE"
            exit 1
          fi

          echo "DNSLink updated successfully"

  deploy-vps:
    name: Deploy to Staging VPS
    needs: [build-api, build-tee]
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Generate .env.staging
        run: |
          cat > .env.staging << 'ENVEOF'
          NODE_ENV=production
          CIPHERBOX_ENVIRONMENT=staging
          PORT=3000
          DB_HOST=postgres
          DB_PORT=5432
          DB_USERNAME=${{ vars.STAGING_DB_USERNAME }}
          DB_PASSWORD=${{ secrets.STAGING_DB_PASSWORD }}
          DB_DATABASE=cipherbox_staging
          JWT_SECRET=${{ secrets.STAGING_JWT_SECRET }}
          WEB_APP_URL=${{ vars.STAGING_WEB_APP_URL }}
          IPFS_PROVIDER=local
          IPFS_LOCAL_API_URL=http://ipfs:5001
          IPFS_LOCAL_GATEWAY_URL=http://ipfs:8080
          DELEGATED_ROUTING_URL=https://delegated-ipfs.dev
          REDIS_HOST=redis
          REDIS_PORT=6379
          TEE_WORKER_URL=http://tee-worker:3001
          TEE_WORKER_SECRET=${{ secrets.STAGING_TEE_WORKER_SECRET }}
          GRAFANA_LOKI_URL=${{ vars.GRAFANA_LOKI_URL }}
          GRAFANA_LOKI_USERNAME=${{ vars.GRAFANA_LOKI_USERNAME }}
          GRAFANA_LOKI_API_KEY=${{ secrets.GRAFANA_LOKI_API_KEY }}
          ENVEOF

      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ vars.STAGING_HOST }}
          username: ${{ vars.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          source: '.env.staging,docker/docker-compose.staging.yml,docker/Caddyfile'
          target: /opt/cipherbox
          strip_components: 0

      - name: Arrange files on VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ vars.STAGING_HOST }}
          username: ${{ vars.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            # Move files to correct locations
            mv /opt/cipherbox/.env.staging /opt/cipherbox/docker/.env.staging 2>/dev/null || true
            cd /opt/cipherbox/docker

            # Rename .env for docker compose
            cp .env.staging .env.staging.bak

      - name: Deploy services
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ vars.STAGING_HOST }}
          username: ${{ vars.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/cipherbox/docker

            # Login to GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Set image tag from git tag (GHCR requires lowercase owner)
            export TAG="${{ github.ref_name }}"
            OWNER="${{ github.repository_owner }}"
            export GITHUB_REPOSITORY_OWNER="${OWNER,,}"

            # Pull new images
            docker compose -f docker-compose.staging.yml pull

            # Run database migrations before starting services
            docker compose -f docker-compose.staging.yml run --rm \
              --env-file .env.staging \
              api node dist/run-migrations.js

            # Start/restart services
            docker compose -f docker-compose.staging.yml up -d

            # Cleanup old images
            docker image prune -f
