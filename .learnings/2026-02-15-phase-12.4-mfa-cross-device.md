# Phase 12.4 MFA + Cross-Device Approval - Learnings

**Date:** 2026-02-15

## Original Prompt

> Users can enroll in MFA with device shares and recovery phrases, and approve new devices from existing authenticated devices

## What I Learned

- Core Kit `enableMFA()` returns a BN (big number) not a string — need `@tkey/common-types` and `bn.js` as direct deps in pnpm strict mode since transitive deps aren't hoisted
- `loginWithCoreKit` returning a typed union ('logged_in' | 'required_share') is cleaner than try/catch for flow branching — callers can branch without error handling
- Placeholder publicKey pattern for temporary backend auth in REQUIRED_SHARE state works well — `pending-core-kit-{userId}` allows API access before TSS key is available
- Noble secp256k1 v3 API uses `keygen()` returning `{ secretKey, publicKey }` instead of v2's `utils.randomPrivateKey()` — API surface changed between major versions
- Auto-expire on read (filtering out expired requests during getStatus/getPending) is simpler and more reliable than background cron for short TTL (5 minutes)
- Parallel agents committing to the same branch can cause lint-staged stash conflicts — files from one agent's stash get pulled into another agent's commit. Non-harmful but messy.

## What Would Have Helped

- Knowing Core Kit's `getKeyDetails()` return shape upfront (threshold, totalFactors, shareDescriptions map)
- Clear documentation on how `shareDescriptions` stores device metadata (JSON stringified in a Map keyed by factor public key)
- Understanding that `keyType` in factor info is a Core Kit internal, not directly useful for device vs recovery distinction

## Key Files

- `apps/web/src/hooks/useMfa.ts` — Central MFA operations hook (276 lines)
- `apps/web/src/hooks/useDeviceApproval.ts` — Full approval lifecycle with ECIES key exchange (380 lines)
- `apps/web/src/lib/web3auth/hooks.ts` — Core Kit login with REQUIRED_SHARE handling
- `apps/api/src/device-approval/` — Bulletin board REST API (entity, service, controller, module, DTOs)
- `apps/web/src/components/mfa/` — All MFA UI components (wizard, security tab, devices, approval modal, waiting screen, recovery)
