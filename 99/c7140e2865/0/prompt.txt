Implement the following plan:

# Plan: `design:sync` Skill

## Context

After fixing the multi-select action bar button visibility, we had to manually check whether the Pencil design file matched the implementation — and found multiple discrepancies (wrong position, missing specificity override for delete button). This manual process should be automated as a skill that can run standalone or as a post-task hook after UI work.

**Important:** This skill lives outside the `gsd/` directory to survive GSD updates (similar to `security:review`).

## What We're Building

A new skill `/design:sync` that detects drift between `designs/cipher-box-design.pen` and the CSS/TSX implementation, reports discrepancies, and offers to fix them. It also hooks into existing UI workflows as an optional post-task check.

## Files to Create

### 1. `.claude/commands/design/sync.md` (NEW)

The main skill file. Located in `.claude/commands/design/` (not `gsd/`) so it persists across GSD updates.

```yaml
---
name: design:sync
description: Synchronize Pencil design file with app implementation. Detects UI drift and offers to update design or code.
argument-hint: "[check|PR#]"
allowed-tools: [Read, Write, Edit, Bash, Glob, Grep, Task, AskUserQuestion, mcp__pencil__*, mcp__playwright__*]
---
```

**Process (10 steps):**

1. **Pre-flight** — Check `designs/*.pen` exists, load `designs/DESIGN.md` for token reference
2. **Identify changed UI files** — Based on mode:
   - No args: `git diff --name-only main...HEAD -- '*.css' '*.tsx'`
   - `check`: same but report-only (no modifications)
   - `PR#`: `gh pr diff $N --name-only` filtered to CSS/TSX
3. **Build CSS-to-design-frame mapping** — Three-tier resolution:
   - Tier 1: Parse `designs/DESIGN.md` component hierarchy for frame IDs
   - Tier 2: `mcp__pencil__batch_get` with name patterns (match CSS file names to frame names)
   - Tier 3: Trace TSX imports to find component → frame relationship
4. **Extract implementation values** — Read changed CSS files, resolve `var()` references against `index.css`
5. **Extract design values** — `mcp__pencil__batch_get` on mapped frames (readDepth: 2)
6. **Compare with normalization** — Color (hex/rgb), spacing (shorthand expansion), layout (flex→vertical/horizontal), border (directional vs all-sides)
7. **Generate discrepancy report** — Table of mismatches with file:line references, plus unmapped components
8. **Ask resolution direction** — "Update design to match code" / "Update code to match design" / "Review individually" / "Skip"
9. **Apply changes** — `batch_design` for design updates, `Edit` for CSS updates. Take screenshots to verify design changes.
10. **Summary** — Report what changed, remind user to save Pencil file

**Edge cases handled:**
- Missing design frame → offer to create it
- Deleted component → flag stale design frame
- CSS variable chains → resolve full chain before comparison
- Pencil MCP unavailable → exit gracefully
- No `.pen` file → exit immediately

## Files to Modify

### 2. `.claude/commands/gsd/quick.md` — Add Step 6c

Insert after Step 6b (UI verification), before Step 7 (STATE.md update):

**Step 6c: Design sync check (UI tasks only)**
- Only runs if `IS_UI_TASK=true` and `designs/*.pen` exists
- Gets changed CSS/TSX files from `git diff main...HEAD`
- Asks: "UI files changed. Check if design needs updating?" → Yes / Skip
- If yes: runs lightweight sync (only changed files, defaults to "update design to match code")
- Non-blocking — task completion continues regardless

### 3. `.claude/get-shit-done/workflows/execute-phase.md` — Add sync step

Insert between `verify_phase_goal` and `update_roadmap`:

- Detect UI phase (same keyword heuristic)
- If UI phase + `.pen` file exists: ask "Sync design to match implementation?" → Yes / Skip
- Non-blocking

### 4. `.claude/commands/gsd/execute-phase.md` — Add step 7.5

Mirror the workflow change — add design sync check between steps 7 and 8.

### 5. `.claude/commands/gsd/verify-work.md` — Add informational suggestion

After test completion on UI phases, append to output:
```
Design sync available: /design:sync check
```
Informational only — no prompt, no blocking.

### 6. `.claude/get-shit-done/workflows/verify-work.md` — Same suggestion

Add the informational line in the `complete_session` step for UI phases.

### 7. MEMORY.md — Update UI keyword sync note

Change "3 files" to "4 files" and add `design/sync.md` line reference.

## Key Design Decisions

- **Direction defaults**: Post-task hooks default to "update design to match code" (code was just written). Standalone mode asks.
- **Lightweight vs full**: Post-task hooks only check files changed in current branch. Standalone scans broader.
- **Non-blocking**: Design sync never blocks task/phase completion — always optional.
- **UI keyword heuristic**: Reuses the same 85-keyword regex (becomes 4th location to keep in sync).
- **Pencil save reminder**: Always displayed after design modifications.

## Verification

1. Create the skill, then test standalone: `/design:sync check` on current branch
2. Verify it detects the selection action bar we just added
3. Test the quick.md hook by running a mock UI quick task
4. Confirm non-UI tasks skip the hook entirely


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/michael/.REDACTED.jsonl