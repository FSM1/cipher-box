Implement the following plan:

# Plan: Wire Up Desktop Test-Mode for Automated E2E Testing

## Context

The desktop app's `--dev-key` headless auth mode is broken due to three bugs in `handleDevKeyAuth`. The staging API also blocks test-login because `NODE_ENV=production`. Fixing the outstanding Phase 11.1 bugs will be much easier once automated test-mode works, so we need to unblock this first.

**Bugs in `apps/desktop/src/main.ts:533-561`:**
1. References `data.idToken` — but `POST /auth/test-login` returns `accessToken`, not `idToken`
2. Passes CLI `devKeyHex` as private key — but test-login created the user with its own deterministic keypair (mismatch = vault ECIES failure)
3. Calls `handle_auth_complete` which POSTs to `/auth/login` expecting a CipherBox identity JWT — but test-login returns a plain API access token

## Two-Track Approach

### Track A: Staging infra (separate PR off `main` — merge + deploy first)

One small PR that enables test-login on the staging API.

**File:** `.github/workflows/deploy-staging.yml` (line 138)
- Change `NODE_ENV=production` → `NODE_ENV=staging`
- Add `TEST_LOGIN_SECRET=${{ secrets.STAGING_TEST_LOGIN_SECRET }}`

**Manual step:** Add `STAGING_TEST_LOGIN_SECRET` secret to GitHub staging environment.

### Track B: Desktop test-mode fixes (on current `feat/phase-11.1-01` branch)

All desktop-side changes to make `--dev-key` mode actually work.

#### B1. Extract shared post-auth helper in Rust

**File:** `apps/desktop/src-tauri/src/commands.rs`

Extract lines 76-228 of `handle_auth_complete` into a shared helper:

```rust
async fn complete_auth_setup(
    app: &tauri::AppHandle,
    state: &AppState,
    access_token: String,
    refresh_token: String,
    private_key_bytes: Vec<u8>,
    public_key_bytes: Vec<u8>,
    is_new_user: bool,
) -> Result<(), String>
```

Refactor `handle_auth_complete` to call it after its `/auth/login` POST.

#### B2. Add `handle_test_login_complete` Rust command

**File:** `apps/desktop/src-tauri/src/commands.rs`

New command gated by `#[cfg(debug_assertions)]`:
- Accepts `{ access_token, refresh_token, private_key_hex, is_new_user }`
- Derives public key, calls `complete_auth_setup()` directly — **skips** `/auth/login`

#### B3. Register new command in Tauri builder

**File:** `apps/desktop/src-tauri/src/main.rs`

cfg-gated handler lists (since `generate_handler!` doesn't support inline `#[cfg]`):

```rust
#[cfg(debug_assertions)]
let handler = tauri::generate_handler![/* ...existing + handle_test_login_complete */];
#[cfg(not(debug_assertions))]
let handler = tauri::generate_handler![/* ...existing only */];
```

#### B4. Fix `handleDevKeyAuth` in TypeScript

**File:** `apps/desktop/src/main.ts` (lines 533-561)

- Use `data.accessToken` (not `data.idToken`)
- Use `data.privateKeyHex` from test-login response (matches the user record)
- Call `invoke('handle_test_login_complete', ...)` instead of `handle_auth_complete`
- Throw clear error when `VITE_TEST_LOGIN_SECRET` is missing

#### B5. Add test-login secret to desktop `.env`

**File:** `apps/desktop/.env`

Add: `VITE_TEST_LOGIN_SECRET=e2e-test-secret-do-not-use-in-production`

#### B6. Update desktop CLAUDE.md docs

**File:** `apps/desktop/CLAUDE.md` — update dev-key mode section to reflect fixed behavior.

## Execution Order

1. **Track A first** — create branch, make the one-file change, open PR, merge
2. User adds `STAGING_TEST_LOGIN_SECRET` GitHub secret and triggers staging deploy
3. **Track B** — implement all desktop fixes on `feat/phase-11.1-01`
4. Verify locally against local API, then against staging

## Verification

1. `cargo build` (debug) succeeds with new command
2. `cargo build --release` does NOT include `handle_test_login_complete`
3. Local test: `VITE_API_URL=http://localhost:3000 pnpm --filter desktop dev -- -- --dev-key test` — authenticates headlessly, vault initializes, FUSE mounts
4. Staging test: same with default `.env` pointing at staging API (after Track A deployed)


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/michael/.claude/projects/-Users-michael-Code-cipher-box/ae47e084-23a3-4040-b237-97481e61c9b4.jsonl